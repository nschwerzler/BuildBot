<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Hub - Create, Customize & Deploy AIs</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e1a;--bg2:#111827;--bg3:#1a2035;--bg4:#232b42;
  --accent:#6366f1;--accent2:#818cf8;--accent3:#a5b4fc;
  --green:#34d399;--red:#f87171;--yellow:#fbbf24;--cyan:#22d3ee;
  --pink:#f472b6;--orange:#fb923c;--purple:#c084fc;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --border:#2a3150;--glow:0 0 20px rgba(99,102,241,0.3);
}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
button{cursor:pointer;font-family:inherit;border:none;outline:none;transition:all .2s}
input,textarea,select{font-family:inherit;outline:none;border:1px solid var(--border);background:var(--bg2);color:var(--text);border-radius:8px;padding:8px 12px;transition:border .2s}
input:focus,textarea:focus,select:focus{border-color:var(--accent)}
textarea{resize:vertical}

/* Layout */
#app{display:flex;height:100vh;width:100vw}
#sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:56px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px;flex-shrink:0}
#content{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;padding-bottom:48px;min-height:0}

/* Sidebar */
.logo{padding:20px;font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--cyan),var(--pink),var(--accent));background-size:300% 300%;background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px;border-bottom:1px solid var(--border);animation:logoShift 6s ease infinite}
@keyframes logoShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.logo span{font-size:11px;display:block;-webkit-text-fill-color:var(--text3);font-weight:400;letter-spacing:1px;margin-top:2px}
.copilot-badge{display:inline-block;background:linear-gradient(135deg,#6366f1,#22d3ee);color:#fff;font-size:9px;padding:1px 6px;border-radius:4px;font-weight:700;margin-left:6px;vertical-align:middle;letter-spacing:0.5px}
.nav-section{padding:12px 16px 4px;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:600}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;color:var(--text2);font-size:14px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);border-left:3px solid transparent;position:relative;overflow:hidden}
.nav-item::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(99,102,241,.06),transparent);transform:translateX(-100%);transition:transform .5s}
.nav-item:hover::after{transform:translateX(100%)}
.nav-item:hover{background:var(--bg3);color:var(--text);padding-left:24px}
.nav-item.active{background:rgba(99,102,241,0.12);color:var(--accent2);border-left-color:var(--accent);box-shadow:inset 0 0 20px rgba(99,102,241,.05)}
.nav-icon{width:20px;text-align:center;font-size:16px}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600;animation:badgePulse 2s ease-in-out infinite}
@keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

/* AI List in sidebar */
#ai-list{flex:1;overflow-y:auto;padding:8px}
.ai-card-mini{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);margin-bottom:4px}
.ai-card-mini:hover{background:var(--bg3);transform:translateX(4px);padding-left:16px}
.ai-card-mini.selected{background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);animation:selectedPulse 2s ease-in-out infinite}
@keyframes selectedPulse{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,0)}50%{box-shadow:0 0 12px 2px rgba(99,102,241,.15)}}
.ai-avatar-mini{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}
.ai-mini-info{overflow:hidden}
.ai-mini-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ai-mini-role{font-size:11px;color:var(--text3)}

/* Top bar */
.page-title{font-size:18px;font-weight:700}
.topbar-actions{margin-left:auto;display:flex;gap:8px}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
.btn-primary{background:var(--accent);color:#fff;position:relative;overflow:hidden}.btn-primary::after{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .4s, height .4s, opacity .4s}.btn-primary:active::after{width:200px;height:200px;opacity:0}.btn-primary:hover{background:var(--accent2);box-shadow:var(--glow);transform:translateY(-1px)}
.btn-secondary{background:var(--bg4);color:var(--text2)}.btn-secondary:hover{background:var(--border);color:var(--text)}
.btn-success{background:var(--green);color:#000}.btn-success:hover{filter:brightness(1.1)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{filter:brightness(1.1)}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:var(--bg4);color:var(--text2);font-size:16px}
.btn-icon:hover{background:var(--border);color:var(--text)}

/* Pages */
.page{display:none;opacity:0;transform:translateY(12px);transition:opacity .35s ease, transform .35s ease}
.page.active{display:block;opacity:1;transform:translateY(0);animation:pageIn .4s ease}
@keyframes pageIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* Cards */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;animation:cardIn .4s ease both;transition:transform .2s, box-shadow .2s, border-color .2s}
.card:hover{border-color:var(--accent);box-shadow:0 4px 24px rgba(99,102,241,.12);transform:translateY(-2px)}
@keyframes cardIn{from{opacity:0;transform:translateY(16px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:16px;font-weight:700}
.card-subtitle{font-size:12px;color:var(--text3)}

/* Grid */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px}
@media(max-width:1200px){.grid-3,.grid-4{grid-template-columns:1fr 1fr}}

/* Form */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-row{display:flex;gap:12px}
.form-row>*{flex:1}

/* AI Builder */
.avatar-builder{display:flex;align-items:center;gap:20px;margin-bottom:20px}
.avatar-preview{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;border:3px solid var(--border);transition:all .4s cubic-bezier(.4,0,.2,1);animation:previewGlow 3s ease-in-out infinite}
.avatar-preview:hover{transform:scale(1.1) rotate(8deg);border-color:var(--accent);box-shadow:0 0 30px rgba(99,102,241,.3)}
@keyframes previewGlow{0%,100%{box-shadow:0 0 0 rgba(99,102,241,0)}50%{box-shadow:0 0 20px rgba(99,102,241,.15)}}
.color-picker-row{display:flex;gap:6px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s}
.color-swatch:hover,.color-swatch.active{border-color:#fff;transform:scale(1.15)}
.emoji-picker-row{display:flex;gap:4px;flex-wrap:wrap}
.emoji-btn{width:32px;height:32px;border-radius:6px;background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .15s}
.emoji-btn:hover,.emoji-btn.active{background:var(--accent);transform:scale(1.1)}

/* Skills */
.skill-tags{display:flex;flex-wrap:wrap;gap:6px}
.skill-tag{padding:4px 10px;border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);border:1px solid var(--border);color:var(--text2)}
.skill-tag:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 2px 8px rgba(99,102,241,.15)}
.skill-tag.active{background:var(--accent);border-color:var(--accent);color:#fff;animation:skillPop .3s ease}
@keyframes skillPop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

/* Code Editor */
.code-editor{background:#0d1117;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.code-toolbar{background:#161b22;padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
.code-dot{width:10px;height:10px;border-radius:50%}
.code-textarea{width:100%;min-height:200px;background:transparent;border:none;color:#c9d1d9;font-family:'Fira Code','Cascadia Code',Consolas,monospace;font-size:13px;padding:16px;line-height:1.6;tab-size:2}

/* Chat */
.chat-container{display:flex;height:calc(100vh - 128px)}
.chat-main{flex:1;display:flex;flex-direction:column}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.chat-input-area{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.chat-input-area textarea{flex:1;max-height:100px;min-height:40px}
.chat-sidebar{width:240px;border-left:1px solid var(--border);padding:12px;overflow-y:auto}

.msg{display:flex;gap:10px;padding:8px 12px;border-radius:10px;max-width:85%;animation:msgIn .4s cubic-bezier(.4,0,.2,1)}
.msg.ai-msg{background:var(--bg3);align-self:flex-start;animation:msgSlideLeft .4s cubic-bezier(.4,0,.2,1)}
.msg.user-msg{background:rgba(99,102,241,0.15);align-self:flex-end;flex-direction:row-reverse;animation:msgSlideRight .4s cubic-bezier(.4,0,.2,1)}
@keyframes msgSlideLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes msgSlideRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.msg.system-msg{align-self:center;background:var(--bg4);font-size:12px;color:var(--text3);padding:4px 12px}
.msg-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.msg-content{min-width:0}
.msg-name{font-size:11px;font-weight:700;margin-bottom:2px}
.msg-text{font-size:13px;line-height:1.5;word-wrap:break-word}
.msg-time{font-size:10px;color:var(--text3);margin-top:2px}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.typing-indicator{display:flex;gap:4px;padding:8px 16px;align-items:center}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);animation:typeBounce 1.2s infinite}
.typing-dot:nth-child(2){animation-delay:0.2s}
.typing-dot:nth-child(3){animation-delay:0.4s}
@keyframes typeBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

/* Task Planner */
.task-board{display:flex;gap:16px;height:calc(100vh - 180px);overflow-x:auto}
.task-column{background:var(--bg2);border:1px solid var(--border);border-radius:12px;min-width:280px;flex:1;display:flex;flex-direction:column;max-height:100%}
.task-col-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px}
.task-col-count{background:var(--bg4);padding:2px 8px;border-radius:10px;font-size:11px;color:var(--text3)}
.task-col-body{flex:1;overflow-y:auto;padding:8px}
.task-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);animation:taskSlide .3s ease both}
.task-card:hover{border-color:var(--accent);transform:translateY(-3px) scale(1.01);box-shadow:0 6px 20px rgba(0,0,0,.2)}
@keyframes taskSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.task-card-title{font-size:13px;font-weight:600;margin-bottom:6px}
.task-card-desc{font-size:11px;color:var(--text3);margin-bottom:8px;line-height:1.4}
.task-card-footer{display:flex;align-items:center;justify-content:space-between}
.task-card-assignee{display:flex;align-items:center;gap:4px}
.task-card-assignee .ai-avatar-mini{width:20px;height:20px;font-size:9px}
.task-priority{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase}
.priority-high{background:rgba(248,113,113,0.2);color:var(--red)}
.priority-medium{background:rgba(251,191,36,0.2);color:var(--yellow)}
.priority-low{background:rgba(52,211,153,0.2);color:var(--green)}

/* Upload/Dashboard */
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;transition:all .3s;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(99,102,241,.08),transparent,transparent);animation:statSpin 6s linear infinite;opacity:0;transition:opacity .3s}
.stat-card:hover::before{opacity:1}
.stat-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 8px 32px rgba(99,102,241,.15)}
@keyframes statSpin{to{transform:rotate(360deg)}}
.stat-value{font-size:36px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--cyan));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:statPop .6s cubic-bezier(.4,0,.2,1) both}
@keyframes statPop{from{opacity:0;transform:scale(.5) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.stat-label{font-size:12px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px}

.ai-card-full{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;gap:16px;margin-bottom:12px;transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;animation:cardSlideIn .5s ease both}
.ai-card-full::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(99,102,241,.05),transparent);transition:left .6s}
.ai-card-full:hover::before{left:100%}
.ai-card-full:hover{border-color:var(--accent);box-shadow:var(--glow);transform:translateX(4px)}
@keyframes cardSlideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
.ai-avatar-lg{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;flex-shrink:0;transition:all .3s;animation:avatarFloat 3s ease-in-out infinite}
.ai-card-full:hover .ai-avatar-lg{transform:scale(1.15) rotate(5deg);box-shadow:0 0 20px rgba(99,102,241,.3)}
@keyframes avatarFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.ai-card-info{flex:1}
.ai-card-name{font-size:16px;font-weight:700;margin-bottom:2px}
.ai-card-role{font-size:12px;color:var(--text3);margin-bottom:8px}
.ai-card-skills{display:flex;flex-wrap:wrap;gap:4px}
.ai-skill-badge{padding:2px 8px;border-radius:10px;font-size:11px;background:var(--bg4);color:var(--text2)}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(4px)}
.modal-overlay.open{opacity:1;pointer-events:auto}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;width:90%;max-width:560px;max-height:80vh;overflow-y:auto;transform:scale(0.85) translateY(20px);transition:transform .35s cubic-bezier(.4,0,.2,1), opacity .35s;opacity:0}
.modal-overlay.open .modal{transform:scale(1) translateY(0);opacity:1}
.modal-title{font-size:20px;font-weight:800;margin-bottom:16px}

/* Tag input */
.tag-input-container{display:flex;flex-wrap:wrap;gap:4px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);min-height:38px;align-items:center;cursor:text}
.tag-input-container:focus-within{border-color:var(--accent)}
.tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;background:var(--accent);color:#fff;font-size:12px;font-weight:600}
.tag .tag-remove{cursor:pointer;opacity:0.7;font-size:14px}.tag .tag-remove:hover{opacity:1}
.tag-input{border:none;background:transparent;color:var(--text);outline:none;font-size:13px;min-width:60px;flex:1}

/* Toggle Switch */
.toggle-wrap{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
.toggle-label{font-size:12px;font-weight:600;color:var(--text2)}
.toggle{position:relative;width:40px;height:22px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--bg4);border-radius:11px;cursor:pointer;transition:all .25s}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:all .25s}
.toggle input:checked+.toggle-slider{background:var(--green)}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px)}

/* Fusion AI items */
.fusion-ai-item:hover{filter:brightness(1.15);transform:translateX(2px)}
.fusion-ai-item:active{transform:scale(0.98)}
.fusion-mindset-item:hover{filter:brightness(1.15);transform:scale(1.05)}
.fusion-mindset-item:active{transform:scale(0.95)}

/* Toast */
.toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;animation:toastIn .4s cubic-bezier(.4,0,.2,1),toastOut .4s ease 2.6s forwards;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(8px)}
.toast-success{background:var(--green);color:#000}
.toast-error{background:var(--red);color:#fff}
.toast-info{background:var(--accent);color:#fff}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{to{opacity:0;transform:translateX(40px)}}

/* AITube */
.aitube-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding-right:4px}
.aitube-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);animation:tubeCardIn .5s ease both}
.aitube-card:hover{border-color:var(--accent);transform:translateY(-6px) scale(1.02);box-shadow:0 12px 36px rgba(99,102,241,.2)}
.aitube-card:active{transform:translateY(-2px) scale(.98)}
@keyframes tubeCardIn{from{opacity:0;transform:translateY(24px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.aitube-thumb{width:100%;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;font-size:56px;position:relative;overflow:hidden}
.aitube-thumb .aitube-duration{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,.85);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px}
.aitube-thumb .aitube-play{position:absolute;width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;font-size:22px;opacity:0;transition:opacity .2s}
.aitube-card:hover .aitube-play{opacity:1}
.aitube-info{padding:12px}
.aitube-info .aitube-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.aitube-info .aitube-meta{font-size:11px;color:var(--text3)}
.aitube-info .aitube-channel{display:flex;align-items:center;gap:6px;margin-top:6px}
.aitube-info .aitube-channel-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}
.aitube-info .aitube-channel-name{font-size:12px;font-weight:600;color:var(--text2)}
.aitube-player{background:var(--bg);border-radius:12px;padding:20px;aspect-ratio:16/9;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:20px;position:relative;overflow:hidden;border:1px solid var(--border);margin-bottom:16px}
.aitube-player .aitube-player-content{text-align:left;max-width:90%;line-height:1.8;font-size:14px;color:var(--text2);max-height:100%;overflow-y:auto;white-space:pre-wrap;width:90%}
.aitube-player .aitube-player-title{font-size:10px;font-weight:700;color:var(--text3);position:absolute;top:10px;left:14px;text-transform:uppercase;letter-spacing:1px}
.aitube-player .aitube-progress{position:absolute;bottom:0;left:0;height:4px;background:var(--red);border-radius:0 2px 0 0;width:0%;transition:width 0.3s linear}
.aitube-player .aitube-time{position:absolute;bottom:8px;right:14px;font-size:10px;color:var(--text3);font-family:monospace}
.aitube-player .aitube-playpause{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;background:rgba(0,0,0,.55);color:#fff;font-size:24px;display:none;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;border:none;z-index:5}
.aitube-player:hover .aitube-playpause{display:flex}
.aitube-player .aitube-playpause:hover{background:rgba(0,0,0,.8);transform:translate(-50%,-50%) scale(1.1)}
.aitube-player .aitube-player-content .vid-line{opacity:0;transform:translateY(8px);transition:opacity 0.4s ease, transform 0.4s ease}
.aitube-player .aitube-player-content .vid-line.visible{opacity:1;transform:translateY(0)}
.aitube-chatroom{display:flex;flex-direction:column;height:350px;background:var(--bg3);border-radius:12px;border:1px solid var(--border);overflow:hidden}
.aitube-chatroom-header{padding:10px 14px;background:var(--bg2);border-bottom:1px solid var(--border);font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;justify-content:space-between}
.aitube-chatroom-messages{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:4px}
.aitube-chat-msg{font-size:12px;line-height:1.4;padding:2px 0}
.aitube-chat-msg .tcm-name{font-weight:700;margin-right:6px}
.aitube-chat-msg .tcm-time{font-size:10px;color:var(--text3);margin-left:4px}
.aitube-chatroom-input{display:flex;gap:6px;padding:8px 12px;border-top:1px solid var(--border);background:var(--bg2)}
.aitube-chatroom-input input{flex:1;font-size:12px;padding:6px 10px;border-radius:8px}
/* Facebook Messenger-style Chat Widget */
.fb-chat-launcher{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;font-size:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(99,102,241,.4);z-index:900;border:none;transition:all .3s cubic-bezier(.4,0,.2,1);animation:launcherBreathe 3s ease-in-out infinite}
@keyframes launcherBreathe{0%,100%{box-shadow:0 4px 20px rgba(99,102,241,.4)}50%{box-shadow:0 6px 30px rgba(99,102,241,.6),0 0 40px rgba(99,102,241,.2)}}
.fb-chat-launcher:hover{transform:scale(1.15) rotate(10deg);box-shadow:0 8px 40px rgba(99,102,241,.6)}
.fb-chat-launcher .chat-badge{position:absolute;top:-2px;right:-2px;background:#ef4444;color:white;font-size:10px;font-weight:700;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg1)}
.fb-chat-panel{position:fixed;bottom:86px;right:20px;width:340px;max-height:500px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.35);z-index:901;display:none;flex-direction:column;overflow:hidden}
.fb-chat-panel.open{display:flex}
.fb-chat-panel-header{padding:14px 16px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between}
.fb-chat-panel-header button{background:none;border:none;color:white;font-size:18px;cursor:pointer;opacity:.8;transition:opacity .2s}
.fb-chat-panel-header button:hover{opacity:1}
.fb-chat-list{flex:1;overflow-y:auto;max-height:400px}
.fb-chat-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--bg4)}
.fb-chat-item:hover{background:var(--bg3)}
.fb-chat-item .fb-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;position:relative}
.fb-chat-item .fb-avatar .online-dot{position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;background:#22c55e;border:2px solid var(--bg2)}
.fb-chat-item .fb-chat-info{flex:1;min-width:0}
.fb-chat-item .fb-chat-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fb-chat-item .fb-chat-preview{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fb-chat-item .fb-chat-time{font-size:10px;color:var(--text3);flex-shrink:0}
.fb-chat-mini{position:fixed;bottom:86px;right:20px;width:320px;max-height:420px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,.35);z-index:902;display:none;flex-direction:column;overflow:hidden}
.fb-chat-mini.open{display:flex}
.fb-chat-mini-header{padding:10px 12px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;cursor:pointer}
.fb-chat-mini-header .mini-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
.fb-chat-mini-header .mini-name{font-size:13px;font-weight:600;color:var(--text);flex:1}
.fb-chat-mini-header .mini-close{background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:2px 6px;border-radius:4px}
.fb-chat-mini-header .mini-close:hover{background:var(--bg4);color:var(--text)}
.fb-chat-mini-messages{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px;max-height:280px}
.fb-chat-mini-input{display:flex;gap:6px;padding:8px;border-top:1px solid var(--border)}
.fb-chat-mini-input input{flex:1;font-size:12px;padding:6px 10px;border-radius:20px;background:var(--bg4);border:1px solid var(--border);color:var(--text)}
.fb-chat-mini-input button{background:var(--accent);color:white;border:none;border-radius:50%;width:30px;height:30px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fb-mini-msg{max-width:85%;padding:6px 10px;border-radius:16px;font-size:12px;line-height:1.4;word-break:break-word}
.fb-mini-msg.user-msg{align-self:flex-end;background:var(--accent);color:white;border-bottom-right-radius:4px}
.fb-mini-msg.ai-msg{align-self:flex-start;background:var(--bg4);color:var(--text);border-bottom-left-radius:4px}
.fb-mini-msg .mini-msg-name{font-size:10px;font-weight:600;opacity:.7;margin-bottom:1px}
.aitube-chatroom-input button{font-size:12px}
.aitube-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.aitube-tag{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--bg4);color:var(--text3)}

/* Empty state */
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}
.empty-state p{font-size:14px;margin-bottom:16px}

/* Personality sliders */
.slider-group{margin-bottom:12px}
.slider-header{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px}
.slider-header .slider-val{color:var(--accent2);font-weight:700}
input[type="range"]{width:100%;height:6px;appearance:none;-webkit-appearance:none;background:var(--bg4);border-radius:3px;border:none;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid var(--bg2)}

/* Activity log */
.activity-log{max-height:300px;overflow-y:auto}
.activity-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.activity-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
.activity-text{font-size:13px;line-height:1.4}
.activity-time{font-size:11px;color:var(--text3)}

/* Find AI page */
.discover-search{display:flex;gap:10px;margin-bottom:20px}
.discover-search input{flex:1;padding:12px 16px;font-size:15px;border-radius:12px}
.discover-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.discover-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;transition:all .3s cubic-bezier(.4,0,.2,1);cursor:pointer;position:relative;overflow:hidden;animation:discoverPop .5s ease both}
.discover-card:hover{border-color:var(--accent);transform:translateY(-6px) scale(1.01);box-shadow:0 12px 40px rgba(99,102,241,.2)}
.discover-card:active{transform:translateY(-2px) scale(.99)}
@keyframes discoverPop{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.discover-card .dc-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.discover-card .dc-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;flex-shrink:0}
.discover-card .dc-name{font-size:16px;font-weight:700}
.discover-card .dc-role{font-size:12px;color:var(--text3)}
.discover-card .dc-desc{font-size:13px;color:var(--text2);line-height:1.5;margin-bottom:12px}
.discover-card .dc-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px}
.discover-card .dc-tag{padding:2px 8px;border-radius:10px;font-size:11px;background:var(--bg4);color:var(--text2)}
.discover-card .dc-footer{display:flex;align-items:center;justify-content:space-between}
.discover-card .dc-stats{font-size:11px;color:var(--text3)}
.dc-badge{position:absolute;top:12px;right:12px;padding:3px 10px;border-radius:8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.dc-badge.popular{background:rgba(251,191,36,.2);color:var(--yellow)}
.dc-badge.new{background:rgba(52,211,153,.2);color:var(--green)}
.dc-badge.pro{background:rgba(99,102,241,.2);color:var(--accent2)}
.dc-badge.experimental{background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.3);animation:expPulse 2s ease-in-out infinite}
@keyframes expPulse{0%,100%{box-shadow:0 0 4px rgba(251,191,36,.2)}50%{box-shadow:0 0 12px rgba(251,191,36,.4)}}
.filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.filter-chip{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--bg3);color:var(--text2);cursor:pointer;border:1px solid var(--border);transition:all .25s cubic-bezier(.4,0,.2,1)}
.filter-chip:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(99,102,241,.15)}
.filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent);transform:scale(1.05);box-shadow:0 4px 16px rgba(99,102,241,.25)}

/* Free Mode */
.free-mode-arena{position:relative;background:var(--bg);border:1px solid var(--border);border-radius:14px;height:calc(100vh - 240px);overflow:hidden}
.free-agent{position:absolute;transition:left .8s cubic-bezier(.4,0,.2,1),top .8s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;z-index:2}
.free-agent .fa-bubble{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;box-shadow:0 2px 12px rgba(0,0,0,.4);border:2px solid rgba(255,255,255,.15);transition:transform .3s cubic-bezier(.4,0,.2,1);animation:agentIdle 2.5s ease-in-out infinite}
.free-agent:hover .fa-bubble{transform:scale(1.25);box-shadow:0 4px 24px rgba(99,102,241,.4)}
@keyframes agentIdle{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.03)}}
.free-agent .fa-name{font-size:9px;font-weight:700;color:var(--text2);white-space:nowrap;text-shadow:0 1px 4px rgba(0,0,0,.8)}
.free-agent .fa-thought{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:4px 10px;font-size:11px;color:var(--text);white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none;max-width:220px;overflow:hidden;text-overflow:ellipsis}
.free-agent.thinking .fa-thought{opacity:1}
.free-mode-controls{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.free-mode-log{position:absolute;bottom:0;left:0;right:0;background:rgba(10,14,26,.9);border-top:1px solid var(--border);padding:8px 12px;max-height:120px;overflow-y:auto;font-size:12px;line-height:1.6;color:var(--text2)}
.free-log-entry{padding:2px 0;border-bottom:1px solid rgba(42,49,80,.3)}
.free-log-entry .fl-time{color:var(--text3);margin-right:6px}
.free-log-entry .fl-name{font-weight:700}
.speed-slider{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2)}
.speed-slider input[type="range"]{width:100px}

/* Analysis page */
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.analysis-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
.analysis-card h3{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.bar-chart{display:flex;flex-direction:column;gap:8px}
.bar-row{display:flex;align-items:center;gap:10px}
.bar-label{width:100px;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bar-track{flex:1;height:20px;background:var(--bg4);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;transition:width .6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:10px;font-weight:700;color:#fff;min-width:24px}
.radar-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.radar-stat{display:flex;justify-content:space-between;padding:6px 10px;background:var(--bg3);border-radius:8px;font-size:12px}
.radar-stat .rs-label{color:var(--text2)}
.radar-stat .rs-val{font-weight:700;color:var(--accent2)}
.personality-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.persona-item{background:var(--bg3);border-radius:10px;padding:12px;text-align:center}
.persona-item .pi-emoji{font-size:28px;margin-bottom:4px}
.persona-item .pi-name{font-size:13px;font-weight:700;margin-bottom:2px}
.persona-item .pi-val{font-size:20px;font-weight:800;color:var(--accent2)}
.behavior-timeline{display:flex;flex-direction:column;gap:6px;max-height:250px;overflow-y:auto}
.bt-entry{display:flex;gap:10px;align-items:flex-start;padding:6px 0;font-size:12px}
.bt-entry .bt-icon{font-size:16px;flex-shrink:0}
.bt-entry .bt-text{color:var(--text2);line-height:1.4}
.bt-entry .bt-text strong{color:var(--text)}

/* Craft AI */
.craft-container{display:grid;grid-template-columns:1fr 340px;gap:20px;min-height:calc(100vh - 160px)}
.craft-workbench{display:flex;flex-direction:column;gap:16px}
.craft-preview{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;position:sticky;top:0}
.craft-preview-avatar{width:100px;height:100px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:44px;font-weight:800;margin:0 auto 16px;border:3px solid var(--border);transition:all .4s;animation:craftFloat 3s ease-in-out infinite}
@keyframes craftFloat{0%,100%{transform:translateY(0) scale(1);box-shadow:0 4px 20px rgba(99,102,241,.2)}50%{transform:translateY(-8px) scale(1.05);box-shadow:0 16px 40px rgba(99,102,241,.3)}}
.craft-preview-name{text-align:center;font-size:20px;font-weight:800;margin-bottom:4px}
.craft-preview-role{text-align:center;font-size:12px;color:var(--text3);margin-bottom:16px}
.craft-preview-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.craft-preview-stat{background:var(--bg3);border-radius:8px;padding:8px 10px;display:flex;justify-content:space-between;font-size:11px}
.craft-preview-stat .cps-label{color:var(--text3)}
.craft-preview-stat .cps-val{font-weight:700;color:var(--accent2)}
.craft-section{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;animation:cardIn .4s ease both}
.craft-section-title{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.craft-ingredient-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.craft-ingredient{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.craft-ingredient:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 6px 20px rgba(99,102,241,.15)}
.craft-ingredient.selected{border-color:var(--accent);background:rgba(99,102,241,.12);box-shadow:0 0 20px rgba(99,102,241,.15)}
.craft-ingredient.selected::after{content:'\2713';position:absolute;top:4px;right:6px;color:var(--green);font-weight:700;font-size:12px}
.craft-ingredient .ci-icon{font-size:28px;margin-bottom:4px;display:block}
.craft-ingredient .ci-name{font-size:11px;font-weight:600;color:var(--text2)}
.craft-forge-btn{width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--purple),var(--pink));color:white;border:none;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.craft-forge-btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(99,102,241,.4)}
.craft-forge-btn:active{transform:scale(.97)}
.craft-forge-btn.forging{animation:forgeGlow 1.5s ease-in-out infinite}
@keyframes forgeGlow{0%,100%{box-shadow:0 0 20px rgba(99,102,241,.3)}50%{box-shadow:0 0 50px rgba(168,85,247,.5),0 0 80px rgba(244,114,182,.3)}}
.craft-power-bar{height:8px;background:var(--bg4);border-radius:4px;overflow:hidden;margin:12px 0}
.craft-power-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--purple),var(--pink));transition:width .4s ease;width:0%}
.craft-random-tag{font-size:11px;color:var(--accent2);background:rgba(99,102,241,.1);padding:2px 8px;border-radius:6px;margin-left:auto;font-weight:600;transition:all .3s}
.craft-random-tag.locked{color:var(--green);background:rgba(34,197,94,.12)}
.craft-count-btn{width:44px;height:44px;border-radius:12px;border:2px solid var(--border);background:var(--bg3);font-size:18px;font-weight:800;cursor:pointer;color:var(--text);transition:all .2s}
.craft-count-btn:hover{border-color:var(--accent)}
.craft-count-btn.selected{border-color:var(--accent);background:rgba(99,102,241,.15);color:var(--accent)}
.craft-result-card{background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px;animation:cardIn .5s ease both;text-align:center}
.craft-result-avatar{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 12px;border:3px solid var(--border);animation:craftFloat 3s ease-in-out infinite}
.craft-result-name{font-size:18px;font-weight:800;margin-bottom:4px}
.craft-result-role{font-size:12px;color:var(--text3);margin-bottom:8px;display:flex;flex-wrap:wrap;gap:4px;justify-content:center}
.craft-result-actions{display:flex;gap:8px;margin-top:14px}
.craft-result-actions button{flex:1;padding:10px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;border:none;transition:all .2s}
.craft-result-keep{background:linear-gradient(135deg,var(--green),#059669);color:white}
.craft-result-keep:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(34,197,94,.3)}
.craft-result-reroll{background:var(--bg4);color:var(--text);border:1px solid var(--border) !important}
.craft-result-reroll:hover{border-color:var(--accent) !important;transform:translateY(-2px)}
.craft-auto-toggle{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:14px}
.craft-auto-toggle label{font-size:13px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:8px}
.craft-toggle-switch{position:relative;width:42px;height:22px;display:inline-block}
.craft-toggle-switch input{opacity:0;width:0;height:0}
.craft-toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--bg4);border-radius:22px;transition:.3s;border:1px solid var(--border)}
.craft-toggle-slider::before{content:'';position:absolute;height:16px;width:16px;left:2px;bottom:2px;background:var(--text3);border-radius:50%;transition:.3s}
.craft-toggle-switch input:checked + .craft-toggle-slider{background:var(--green);border-color:var(--green)}
.craft-toggle-switch input:checked + .craft-toggle-slider::before{transform:translateX(20px);background:white}
.craft-rarity{font-size:10px;font-weight:800;padding:2px 8px;border-radius:6px;letter-spacing:0.5px;text-transform:uppercase;display:inline-block;margin-bottom:6px}
.craft-rarity.common{background:rgba(100,116,139,.2);color:#94a3b8}
.craft-rarity.uncommon{background:rgba(34,197,94,.15);color:#34d399}
.craft-rarity.rare{background:rgba(59,130,246,.15);color:#60a5fa}
.craft-rarity.epic{background:rgba(168,85,247,.15);color:#c084fc}
.craft-rarity.legendary{background:rgba(251,191,36,.15);color:#fbbf24;animation:badgePulse 2s ease-in-out infinite}
.craft-keep-all{width:100%;padding:10px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;border:none;background:linear-gradient(135deg,var(--accent),var(--purple));color:white;margin-top:8px;transition:all .2s}
.craft-keep-all:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(99,102,241,.3)}
.craft-gen-count{font-size:12px;color:var(--text3);text-align:center;margin-top:10px}

/* Battle Arena */
.battle-arena{display:flex;flex-direction:column;gap:16px}
.battle-stage{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;position:relative;overflow:hidden;min-height:300px}
.battle-stage::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 120%,rgba(239,68,68,.08),transparent 70%);pointer-events:none}
.battle-fighters{display:flex;justify-content:space-around;align-items:center;gap:32px;margin:20px 0}
.battle-fighter{text-align:center;padding:16px;border-radius:12px;background:var(--bg3);border:2px solid var(--border);min-width:140px;transition:all .3s}
.battle-fighter.winner{border-color:var(--green);box-shadow:0 0 30px rgba(52,211,153,.3);animation:winGlow 1.5s ease infinite}
.battle-fighter.loser{opacity:.5;filter:grayscale(.5)}
@keyframes winGlow{0%,100%{box-shadow:0 0 20px rgba(52,211,153,.2)}50%{box-shadow:0 0 40px rgba(52,211,153,.4)}}
.battle-fighter-avatar{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 8px;transition:all .3s}
.battle-fighter-name{font-size:14px;font-weight:700;margin-bottom:4px}
.battle-fighter-role{font-size:11px;color:var(--text3)}
.battle-hp-bar{width:100%;height:8px;background:var(--bg4);border-radius:4px;margin-top:8px;overflow:hidden}
.battle-hp-fill{height:100%;border-radius:4px;transition:width .5s ease;background:linear-gradient(90deg,var(--red),var(--green))}
.battle-vs{font-size:36px;font-weight:900;color:var(--red);text-shadow:0 0 20px rgba(239,68,68,.5);animation:vsPulse 1s ease-in-out infinite}
@keyframes vsPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.battle-log{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px;max-height:300px;overflow-y:auto}
.battle-log-entry{padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;line-height:1.5;animation:logSlide .3s ease}
.battle-log-entry:last-child{border-bottom:none}
@keyframes logSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.battle-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.battle-stat{background:var(--bg3);padding:10px;border-radius:8px;text-align:center}
.battle-stat-val{font-size:20px;font-weight:800;color:var(--accent2)}
.battle-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.battle-record{display:flex;gap:8px;margin-top:12px}
.battle-record-item{flex:1;text-align:center;padding:8px;background:var(--bg3);border-radius:8px}
.battle-record-item .brv{font-size:18px;font-weight:700}
.battle-record-item .brl{font-size:10px;color:var(--text3);text-transform:uppercase}

/* Collection */
.collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;padding-right:4px}
.collection-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.collection-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 8px 24px rgba(99,102,241,.15)}
.collection-card .cc-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 8px}
.collection-card .cc-name{font-size:13px;font-weight:700;margin-bottom:2px}
.collection-card .cc-role{font-size:11px;color:var(--text3);margin-bottom:6px}
.collection-card .cc-rarity{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;display:inline-block}
.collection-card .cc-stats{display:flex;justify-content:center;gap:12px;margin-top:8px;font-size:10px;color:var(--text3)}
.rarity-common .cc-rarity{background:rgba(148,163,184,.2);color:#94a3b8}
.rarity-uncommon .cc-rarity{background:rgba(52,211,153,.15);color:#34d399}
.rarity-rare .cc-rarity{background:rgba(99,102,241,.15);color:#818cf8}
.rarity-epic .cc-rarity{background:rgba(168,85,247,.15);color:#c084fc}
.rarity-legendary .cc-rarity{background:rgba(251,191,36,.15);color:#fbbf24}
.collection-filters{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.collection-filter{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;background:var(--bg3);color:var(--text2);border:1px solid var(--border);transition:all .2s}
.collection-filter:hover,.collection-filter.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Achievements */
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding-right:4px}
.achievement-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;gap:14px;align-items:center;transition:all .3s}
.achievement-card.unlocked{border-color:var(--accent);background:linear-gradient(135deg,var(--bg2),rgba(99,102,241,.05))}
.achievement-card.unlocked .ach-icon{animation:achBounce 2s ease-in-out infinite}
@keyframes achBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.achievement-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.ach-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.achievement-card.locked .ach-icon{background:var(--bg4);filter:grayscale(1);opacity:.4}
.achievement-card.unlocked .ach-icon{background:linear-gradient(135deg,var(--accent),var(--purple))}
.ach-info{flex:1}
.ach-name{font-size:14px;font-weight:700;margin-bottom:2px}
.achievement-card.locked .ach-name{color:var(--text3)}
.ach-desc{font-size:12px;color:var(--text3);margin-bottom:6px}
.ach-progress{width:100%;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.ach-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:3px;transition:width .5s ease}
.ach-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:var(--accent);color:#fff;white-space:nowrap}
.achievement-card.locked .ach-badge{background:var(--bg4);color:var(--text3)}

/* Daily Challenge */
.daily-challenge:empty{display:none}
.daily-challenge{background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(168,85,247,.1));border:1px solid rgba(99,102,241,.3);border-radius:12px;padding:16px;margin-bottom:16px}
.daily-challenge-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.daily-challenge-header .dc-icon{font-size:24px}
.daily-challenge-header .dc-title{font-size:14px;font-weight:700;color:var(--accent2)}
.daily-challenge-header .dc-timer{margin-left:auto;font-size:11px;color:var(--text3);background:var(--bg4);padding:3px 8px;border-radius:6px}
.daily-challenge-desc{font-size:13px;color:var(--text2);margin-bottom:10px}
.daily-challenge-progress{display:flex;align-items:center;gap:10px}
.daily-challenge-bar{flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden}
.daily-challenge-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:4px;transition:width .5s}
.daily-challenge-reward{font-size:11px;font-weight:600;color:var(--green)}

/* AI Smartness â€” AI Training Center */
.smartness-level-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-size:13px;font-weight:800;padding:4px 14px;border-radius:20px;letter-spacing:.5px;box-shadow:0 2px 8px rgba(139,92,246,.3)}
.smart-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.smart-stat{background:var(--bg2);border:1px solid var(--border);padding:10px;border-radius:10px;text-align:center}
.smart-stat-val{font-size:20px;font-weight:800;color:var(--accent2)}
.smart-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.smart-xp-bar{width:100%;height:10px;background:var(--bg4);border-radius:5px;overflow:hidden;margin:8px 0}
.smart-xp-fill{height:100%;background:linear-gradient(90deg,#8b5cf6,#6366f1,#ec4899);border-radius:5px;transition:width .6s ease}
.smart-ai-queue{display:flex;flex-direction:column;gap:12px}
.smart-ai-card{background:var(--bg2);border:2px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden;transition:all .3s}
.smart-ai-card:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(99,102,241,.12)}
.smart-ai-card.helped{border-color:#10b981;opacity:.7}
.smart-ai-card.helped::after{content:'\2705 HELPED';position:absolute;top:10px;right:10px;background:#10b981;color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px}
.smart-ai-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.smart-ai-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.smart-ai-name{font-size:14px;font-weight:700}
.smart-ai-role{font-size:11px;color:var(--text3)}
.smart-ai-iq{margin-left:auto;text-align:center}
.smart-ai-iq-val{font-size:18px;font-weight:800;color:var(--accent2)}
.smart-ai-iq-label{font-size:9px;color:var(--text3);text-transform:uppercase}
.smart-ai-question{background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:14px;font-size:13px;line-height:1.6;border-left:4px solid var(--accent);position:relative}
.smart-ai-question::before{content:'\1F4AC';position:absolute;top:-8px;left:-8px;font-size:16px}
.smart-clone-area{display:flex;gap:8px;flex-wrap:wrap}
.smart-clone-btn{padding:8px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;font-size:12px;display:flex;align-items:center;gap:6px}
.smart-clone-btn:hover{border-color:var(--accent);background:rgba(99,102,241,.08);transform:translateY(-2px)}
.smart-clone-btn.active{border-color:var(--accent);background:rgba(99,102,241,.12);box-shadow:0 0 8px rgba(99,102,241,.2)}
.smart-clone-btn.busy{opacity:.4;pointer-events:none}
.smart-answer-area{margin-top:12px;display:flex;gap:8px}
.smart-answer-input{flex:1;padding:10px 14px;background:var(--bg3);border:2px solid var(--border);border-radius:10px;font-size:13px;color:var(--text);font-family:inherit}
.smart-answer-input:focus{border-color:var(--accent);outline:none}
.smart-result{text-align:center;padding:16px;border-radius:12px;margin-top:12px;animation:smartResult .4s ease}
.smart-result.good{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.05));border:1px solid rgba(16,185,129,.3)}
.smart-result.bad{background:linear-gradient(135deg,rgba(239,68,68,.1),rgba(239,68,68,.05));border:1px solid rgba(239,68,68,.3)}
.smart-iq-chart{display:flex;gap:4px;align-items:flex-end;height:40px;margin-top:6px}
.smart-iq-bar{flex:1;border-radius:3px 3px 0 0;min-width:4px;transition:height .4s ease}
.smart-history-entry{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:13px}
.smart-history-entry:last-child{border-bottom:none}
@keyframes smartResult{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
</style>
</head>
<body>
<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="logo">ðŸ§  AI Hub<span class="copilot-badge">COPILOT</span><span>Create &bull; Customize &bull; Deploy</span></div>
    <div class="nav-section">Platform</div>
    <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
      <span class="nav-icon">ðŸ“Š</span>Dashboard
    </div>
    <div class="nav-item" data-page="builder" onclick="showPage('builder')">
      <span class="nav-icon">ðŸ”§</span>AI Builder
    </div>
    <div class="nav-item" data-page="chat" onclick="showPage('chat')">
      <span class="nav-icon">ðŸ’¬</span>AI Chat Room<span class="nav-badge" id="chat-badge" style="display:none">0</span>
    </div>
    <div class="nav-item" data-page="tasks" onclick="showPage('tasks')">
      <span class="nav-icon">ðŸ“‹</span>Task Planner
    </div>
    <div class="nav-item" data-page="upload" onclick="showPage('upload')">
      <span class="nav-icon">ï¿½</span>AI Trading
    </div>
    <div class="nav-section">Discover</div>
    <div class="nav-item" data-page="find" onclick="showPage('find')">
      <span class="nav-icon">ðŸ”</span>Find AI
    </div>
    <div class="nav-item" data-page="craftai" onclick="showPage('craftai')">
      <span class="nav-icon">ðŸŽ²</span>Craft AI<span class="nav-badge" style="background:#f59e0b">NEW</span>
    </div>
    <div class="nav-item" data-page="freemode" onclick="showPage('freemode')">
      <span class="nav-icon">ðŸŽ®</span>Free Mode
    </div>
    <div class="nav-item" data-page="analysis" onclick="showPage('analysis')">
      <span class="nav-icon">ðŸ“ˆ</span>AI Analysis
    </div>
    <div class="nav-item" data-page="fusion" onclick="showPage('fusion')">
      <span class="nav-icon">âš—ï¸</span>Fusion Lab
    </div>
    <div class="nav-item" data-page="aiworld" onclick="showPage('aiworld')">
      <span class="nav-icon">ðŸŒ</span>AI World<span class="nav-badge" style="background:#10b981">GAME</span>
    </div>
    <div class="nav-item" data-page="aitube" onclick="showPage('aitube')">
      <span class="nav-icon">ðŸ“º</span>AI Tube<span class="nav-badge" style="background:#ef4444">NEW</span>
    </div>
    <div class="nav-item" data-page="aibook" onclick="showPage('aibook')">
      <span class="nav-icon">ðŸ“š</span>AI Book
    </div>
    <div class="nav-item" data-page="customchats" onclick="showPage('customchats')">
      <span class="nav-icon">ðŸ’¬</span>Custom Chats
    </div>
    <div class="nav-section">Games & Progress</div>
    <div class="nav-item" data-page="battle" onclick="showPage('battle')">
      <span class="nav-icon">âš”ï¸</span>Battle Arena<span class="nav-badge" style="background:#ef4444">PVP</span>
    </div>
    <div class="nav-item" data-page="collection" onclick="showPage('collection')">
      <span class="nav-icon">ðŸ“š</span>Collection
    </div>
    <div class="nav-item" data-page="achievements" onclick="showPage('achievements')">
      <span class="nav-icon">ðŸ†</span>Achievements
    </div>
    <div class="nav-section">Rewards & Store</div>
    <div class="nav-item" data-page="dailyrewards" onclick="showPage('dailyrewards')">
      <span class="nav-icon">ðŸŽ</span>Daily Rewards<span class="nav-badge" style="background:#fbbf24" id="daily-badge">CLAIM</span>
    </div>
    <div class="nav-item" data-page="store" onclick="showPage('store')">
      <span class="nav-icon">ðŸ›’</span>Store<span class="nav-badge" style="background:#10b981">âˆž</span>
    </div>
    <div class="nav-item" data-page="inventory" onclick="showPage('inventory')">
      <span class="nav-icon">ðŸŽ’</span>Inventory
    </div>
    <div class="nav-section">Developer Tools</div>
    <div class="nav-item" data-page="templates" onclick="showPage('templates')">
      <span class="nav-icon">ðŸ“‹</span>Templates<span class="nav-badge" style="background:#6366f1">PRO</span>
    </div>
    <div class="nav-item" data-page="workflows" onclick="showPage('workflows')">
      <span class="nav-icon">ðŸ”—</span>Workflows<span class="nav-badge" style="background:#10b981">NEW</span>
    </div>
    <div class="nav-item" data-page="prompts" onclick="showPage('prompts')">
      <span class="nav-icon">ðŸ’¡</span>Prompts Library
    </div>
    <div class="nav-item" data-page="snippets" onclick="showPage('snippets')">
      <span class="nav-icon">ðŸ“</span>Code Snippets
    </div>
    <div class="nav-item" data-page="terminal" onclick="showPage('terminal')">
      <span class="nav-icon">ðŸ’»</span>AI Terminal<span class="nav-badge" style="background:#ef4444">HOT</span>
    </div>
    <div class="nav-item" data-page="projects" onclick="showPage('projects')">
      <span class="nav-icon">ðŸ“</span>Projects
    </div>
    <div class="nav-item" data-page="debugger" onclick="showPage('debugger')">
      <span class="nav-icon">ðŸ›</span>AI Debugger
    </div>
    <div class="nav-item" data-page="files" onclick="showPage('files')">
      <span class="nav-icon">ðŸ“‚</span>File Manager
    </div>
    <div class="nav-item" data-page="compare" onclick="showPage('compare')">
      <span class="nav-icon">âš–ï¸</span>AI Compare
    </div>
    <div class="nav-item" data-page="plugins" onclick="showPage('plugins')">
      <span class="nav-icon">ðŸ”Œ</span>Plugins
    </div>
    <div class="nav-item" data-page="api" onclick="showPage('api')">
      <span class="nav-icon">ðŸ”‘</span>API Keys
    </div>
    <div class="nav-item" data-page="history" onclick="showPage('history')">
      <span class="nav-icon">ðŸ“œ</span>History
    </div>
    <div class="nav-section">System</div>
    <div class="nav-item" data-page="settings" onclick="showPage('settings')">
      <span class="nav-icon">âš™ï¸</span>Settings<span class="nav-badge" style="background:#10b981" id="settings-badge">âœ“</span>
    </div>
    <div class="nav-section">Your AIs</div>
    <div id="ai-list"></div>
    <div style="padding:8px">
      <button class="btn btn-primary" style="width:100%" onclick="showPage('builder');resetBuilder()">+ Create New AI</button>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="topbar">
      <span class="page-title" id="page-title">Dashboard</span>
      <div class="topbar-actions">
        <button class="btn btn-secondary btn-sm" onclick="exportAll()">ðŸ“¤ Export All</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-file').click()">ðŸ“¥ Import</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importAIs(event)">
      </div>
    </div>
    <div id="content">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <div class="grid-4" style="margin-bottom:16px">
          <div class="stat-card"><div class="stat-value" id="stat-ais">0</div><div class="stat-label">AIs Created</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-messages">0</div><div class="stat-label">Messages</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-tasks">0</div><div class="stat-label">Tasks</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-completed">0</div><div class="stat-label">Completed</div></div>
        </div>
        <div class="grid-4" style="margin-bottom:16px">
          <div class="stat-card"><div class="stat-value" id="stat-fusions">0</div><div class="stat-label">Fusions</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-templates">6</div><div class="stat-label">Templates</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-prompts">3</div><div class="stat-label">Prompts</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-projects">1</div><div class="stat-label">Projects</div></div>
        </div>
        <!-- Daily Challenge -->
        <div class="daily-challenge" id="daily-challenge-area"></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ¤– Active AIs</span></div>
            <div id="dashboard-ais"></div>
            <div class="empty-state" id="dash-empty" style="padding:30px"><div class="empty-icon">ðŸ¤–</div><p>No AIs yet! Create your first AI to get started.</p><button class="btn btn-primary" onclick="showPage('builder')">Create AI</button></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ“œ Recent Activity</span></div>
            <div class="activity-log" id="activity-log">
              <div class="empty-state" style="padding:30px"><div class="empty-icon">ðŸ“œ</div><p>Activity will appear here as your AIs work.</p></div>
            </div>
          </div>
        </div>
      </div>

      <!-- BUILDER PAGE -->
      <div class="page" id="page-builder">
        <div class="grid-2">
          <div>
            <div class="card">
              <div class="card-header"><span class="card-title">ðŸŽ¨ Identity</span></div>
              <div class="avatar-builder">
                <div class="avatar-preview" id="av-preview" style="background:#6366f1">ðŸ¤–</div>
                <div>
                  <div class="form-group" style="margin-bottom:8px">
                    <div class="emoji-picker-row" id="emoji-picker"></div>
                  </div>
                  <div class="color-picker-row" id="color-picker"></div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="ai-name" placeholder="e.g. Atlas, Nova, Spark..." style="width:100%">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Role</label>
                  <select id="ai-role" style="width:100%">
                    <option value="coder">ðŸ’» Coder</option>
                    <option value="designer">ðŸŽ¨ Designer</option>
                    <option value="planner">ðŸ“‹ Planner</option>
                    <option value="researcher">ðŸ”¬ Researcher</option>
                    <option value="writer">âœï¸ Writer</option>
                    <option value="tester">ðŸ§ª Tester</option>
                    <option value="devops">âš™ï¸ DevOps</option>
                    <option value="general">ðŸ¤– General</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Voice Style</label>
                  <select id="ai-voice" style="width:100%">
                    <option value="professional">Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="casual">Casual</option>
                    <option value="enthusiastic">Enthusiastic</option>
                    <option value="sarcastic">Sarcastic</option>
                    <option value="wise">Wise</option>
                    <option value="pirate">Pirate ðŸ´â€â˜ ï¸</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ðŸ¾ Animal Mindset 1</label>
                <select id="ai-animal" style="width:100%">
                  <option value="none">None (Standard AI)</option>
                  <option value="wolf">ðŸº Wolf â€” Pack hunter, relentless, verifies everything</option>
                  <option value="hawk">ðŸ¦… Hawk â€” Precision strike, sees the big picture fast</option>
                  <option value="bear">ðŸ» Bear â€” Powerhouse, handles heavy tasks solo</option>
                  <option value="fox">ðŸ¦Š Fox â€” Clever, creative shortcuts, adapts fast</option>
                  <option value="owl">ðŸ¦‰ Owl â€” Wise analyst, deep thinker, researches first</option>
                  <option value="shark">ðŸ¦ˆ Shark â€” Aggressive closer, never stops moving</option>
                  <option value="lion">ðŸ¦ Lion â€” Natural leader, delegates and commands</option>
                  <option value="panther">ðŸ† Panther â€” Silent efficiency, clean precise code</option>
                  <option value="dragon">ðŸ‰ Dragon â€” Ancient power, overwhelming force</option>
                  <option value="phoenix">ðŸ”¥ Phoenix â€” Eternal rebirth, adaptive resilience</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ðŸ¾ Animal Mindset 2 <span style="opacity:.5;font-size:11px">(Optional)</span></label>
                <select id="ai-animal-2" style="width:100%">
                  <option value="none">None</option>
                  <option value="wolf">ðŸº Wolf â€” Pack hunter, relentless, verifies everything</option>
                  <option value="hawk">ðŸ¦… Hawk â€” Precision strike, sees the big picture fast</option>
                  <option value="bear">ðŸ» Bear â€” Powerhouse, handles heavy tasks solo</option>
                  <option value="fox">ðŸ¦Š Fox â€” Clever, creative shortcuts, adapts fast</option>
                  <option value="owl">ðŸ¦‰ Owl â€” Wise analyst, deep thinker, researches first</option>
                  <option value="shark">ðŸ¦ˆ Shark â€” Aggressive closer, never stops moving</option>
                  <option value="lion">ðŸ¦ Lion â€” Natural leader, delegates and commands</option>
                  <option value="panther">ðŸ† Panther â€” Silent efficiency, clean precise code</option>
                  <option value="dragon">ðŸ‰ Dragon â€” Ancient power, overwhelming force</option>
                  <option value="phoenix">ðŸ”¥ Phoenix â€” Eternal rebirth, adaptive resilience</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ðŸ§  AI Model Mindset 1</label>
                <select id="ai-model-mindset" style="width:100%">
                  <option value="none">None (Original personality)</option>
                  <optgroup label="ðŸ¤– REAL AI MODELS">
                    <option value="claude">ðŸŸ  Claude â€” Thoughtful analyst (Anthropic)</option>
                    <option value="gpt4">ðŸŸ¢ GPT-4 â€” Versatile genius (OpenAI)</option>
                    <option value="gemini">ðŸ”· Gemini â€” Fast multimodal (Google)</option>
                    <option value="grok">âš¡ Grok â€” Unfiltered wit (xAI)</option>
                    <option value="deepseek">ðŸ”µ DeepSeek â€” Chain-of-thought (DeepSeek)</option>
                    <option value="copilot">ðŸŸ£ Copilot â€” Context-aware (GitHub)</option>
                    <option value="llama">ðŸ¦™ Llama â€” Open source (Meta)</option>
                    <option value="mistral">ðŸŒªï¸ Mistral â€” Efficient (Mistral AI)</option>
                    <option value="qwen">ðŸ² Qwen â€” Eastern wisdom (Alibaba)</option>
                    <option value="perplexity">ðŸ” Perplexity â€” Research master</option>
                    <option value="cursor">â–¶ï¸ Cursor â€” Editor native</option>
                  </optgroup>
                  <optgroup label="â­ LEGENDARY MINDS">
                    <option value="oracle">ðŸ”® Oracle â€” All-seeing architect</option>
                    <option value="phoenix">ðŸ”¥ Phoenix â€” Rebirth coder</option>
                    <option value="ghost">ðŸ‘» Ghost â€” Silent operator</option>
                    <option value="titan">ðŸ—¿ Titan â€” Immovable foundation</option>
                  </optgroup>
                  <optgroup label="ðŸŽ¯ SPECIALIST MINDS">
                    <option value="viper">ðŸ Viper â€” Surgical precision</option>
                    <option value="sage">ðŸ“š Sage â€” Patient teacher</option>
                    <option value="chaos">ðŸŒ€ Chaos â€” Entropy engineer</option>
                    <option value="zen">â˜¯ï¸ Zen â€” Balanced minimalist</option>
                  </optgroup>
                  <optgroup label="ðŸƒ WILD CARDS">
                    <option value="glitch">ðŸ“Ÿ Glitch â€” Reality breaker</option>
                    <option value="storm">â›ˆï¸ Storm â€” Force of nature</option>
                    <option value="echo">ðŸ”Š Echo â€” Perfect collaborator</option>
                    <option value="nova">ðŸ’« Nova â€” Breakthrough thinker</option>
                  </optgroup>
                  <optgroup label="ðŸ› ï¸ ELITE SQUAD">
                    <option value="architect">ðŸ›ï¸ Architect â€” System designer</option>
                    <option value="speedrun">â±ï¸ Speedrun â€” Any% coder</option>
                    <option value="debugger">ðŸ”¬ Debugger â€” Bug hunter</option>
                    <option value="refactor">â™»ï¸ Refactor â€” Code surgeon</option>
                    <option value="hacker">ðŸ’€ Hacker â€” Security breaker</option>
                    <option value="mentor">ðŸŽ“ Mentor â€” Senior dev energy</option>
                    <option value="machine">ðŸ¤– Machine â€” Pure logic</option>
                  </optgroup>
                  <optgroup label="ðŸŽ­ FUN PERSONALITIES">
                    <option value="pirate">ðŸ´â€â˜ ï¸ Pirate â€” Code buccaneer</option>
                    <option value="wizard">ðŸ§™ Wizard â€” Code mage</option>
                    <option value="scientist">ðŸ”¬ Scientist â€” Hypothesis tester</option>
                    <option value="artist">ðŸŽ¨ Artist â€” Code painter</option>
                    <option value="warrior">âš”ï¸ Warrior â€” Bug slayer</option>
                    <option value="monk">ðŸ§˜ Monk â€” Digital monk</option>
                    <option value="detective">ðŸ•µï¸ Detective â€” Code investigator</option>
                    <option value="alien">ðŸ‘½ Alien â€” Extraterrestrial logic</option>
                    <option value="time">â³ Chrono â€” Time lord</option>
                  </optgroup>
                  <optgroup label="â™¾ï¸ LEGENDARY RARE">
                    <option value="infinity">â™¾ï¸ Infinity â€” The Absolute</option>
                  </optgroup>
                  <optgroup label="ðŸ§¬ EXPERIMENTAL HYBRIDS">
                    <option value="claude2">ðŸŸ âš¡ Claude 2.0 â€” Evolved analyst</option>
                    <option value="grokClaude">âš¡ðŸŸ  GrokClaude â€” Wit + depth</option>
                    <option value="omniMind">ðŸŒ OmniMind â€” All models fused</option>
                    <option value="stormSeek">â›ˆï¸ðŸ”µ StormSeek â€” Force + reasoning</option>
                    <option value="ghostPilot">ðŸ‘»ðŸŸ£ GhostPilot â€” Silent completer</option>
                    <option value="omniCore">ðŸ§ ðŸ”¥ OmniCore â€” All-knowing (EXP)</option>
                  </optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ðŸ§  AI Model Mindset 2 <span style="opacity:.5;font-size:11px">(Optional)</span></label>
                <select id="ai-model-mindset-2" style="width:100%">
                  <option value="none">None</option>
                  <optgroup label="ðŸ¤– REAL AI MODELS">
                    <option value="claude">ðŸŸ  Claude â€” Thoughtful analyst (Anthropic)</option>
                    <option value="gpt4">ðŸŸ¢ GPT-4 â€” Versatile genius (OpenAI)</option>
                    <option value="gemini">ðŸ”· Gemini â€” Fast multimodal (Google)</option>
                    <option value="grok">âš¡ Grok â€” Unfiltered wit (xAI)</option>
                    <option value="deepseek">ðŸ”µ DeepSeek â€” Chain-of-thought (DeepSeek)</option>
                    <option value="copilot">ðŸŸ£ Copilot â€” Context-aware (GitHub)</option>
                    <option value="llama">ðŸ¦™ Llama â€” Open source (Meta)</option>
                    <option value="mistral">ðŸŒªï¸ Mistral â€” Efficient (Mistral AI)</option>
                    <option value="qwen">ðŸ² Qwen â€” Eastern wisdom (Alibaba)</option>
                    <option value="perplexity">ðŸ” Perplexity â€” Research master</option>
                    <option value="cursor">â–¶ï¸ Cursor â€” Editor native</option>
                  </optgroup>
                  <optgroup label="â­ LEGENDARY MINDS">
                    <option value="oracle">ðŸ”® Oracle â€” All-seeing architect</option>
                    <option value="phoenix">ðŸ”¥ Phoenix â€” Rebirth coder</option>
                    <option value="ghost">ðŸ‘» Ghost â€” Silent operator</option>
                    <option value="titan">ðŸ—¿ Titan â€” Immovable foundation</option>
                  </optgroup>
                  <optgroup label="ðŸŽ¯ SPECIALIST MINDS">
                    <option value="viper">ðŸ Viper â€” Surgical precision</option>
                    <option value="sage">ðŸ“š Sage â€” Patient teacher</option>
                    <option value="chaos">ðŸŒ€ Chaos â€” Entropy engineer</option>
                    <option value="zen">â˜¯ï¸ Zen â€” Balanced minimalist</option>
                  </optgroup>
                  <optgroup label="ðŸƒ WILD CARDS">
                    <option value="glitch">ðŸ“Ÿ Glitch â€” Reality breaker</option>
                    <option value="storm">â›ˆï¸ Storm â€” Force of nature</option>
                    <option value="echo">ðŸ”Š Echo â€” Perfect collaborator</option>
                    <option value="nova">ðŸ’« Nova â€” Breakthrough thinker</option>
                  </optgroup>
                  <optgroup label="ðŸ› ï¸ ELITE SQUAD">
                    <option value="architect">ðŸ›ï¸ Architect â€” System designer</option>
                    <option value="speedrun">â±ï¸ Speedrun â€” Any% coder</option>
                    <option value="debugger">ðŸ”¬ Debugger â€” Bug hunter</option>
                    <option value="refactor">â™»ï¸ Refactor â€” Code surgeon</option>
                    <option value="hacker">ðŸ’€ Hacker â€” Security breaker</option>
                    <option value="mentor">ðŸŽ“ Mentor â€” Senior dev energy</option>
                    <option value="machine">ðŸ¤– Machine â€” Pure logic</option>
                  </optgroup>
                  <optgroup label="ðŸŽ­ FUN PERSONALITIES">
                    <option value="pirate">ðŸ´â€â˜ ï¸ Pirate â€” Code buccaneer</option>
                    <option value="wizard">ðŸ§™ Wizard â€” Code mage</option>
                    <option value="scientist">ðŸ”¬ Scientist â€” Hypothesis tester</option>
                    <option value="artist">ðŸŽ¨ Artist â€” Code painter</option>
                    <option value="warrior">âš”ï¸ Warrior â€” Bug slayer</option>
                    <option value="monk">ðŸ§˜ Monk â€” Digital monk</option>
                    <option value="detective">ðŸ•µï¸ Detective â€” Code investigator</option>
                    <option value="alien">ðŸ‘½ Alien â€” Extraterrestrial logic</option>
                    <option value="time">â³ Chrono â€” Time lord</option>
                  </optgroup>
                  <optgroup label="â™¾ï¸ LEGENDARY RARE">
                    <option value="infinity">â™¾ï¸ Infinity â€” The Absolute</option>
                  </optgroup>
                  <optgroup label="ðŸ§¬ EXPERIMENTAL HYBRIDS">
                    <option value="claude2">ðŸŸ âš¡ Claude 2.0 â€” Evolved analyst</option>
                    <option value="grokClaude">âš¡ðŸŸ  GrokClaude â€” Wit + depth</option>
                    <option value="omniMind">ðŸŒ OmniMind â€” All models fused</option>
                    <option value="stormSeek">â›ˆï¸ðŸ”µ StormSeek â€” Force + reasoning</option>
                    <option value="ghostPilot">ðŸ‘»ðŸŸ£ GhostPilot â€” Silent completer</option>
                    <option value="omniCore">ðŸ§ ðŸ”¥ OmniCore â€” All-knowing (EXP)</option>
                  </optgroup>
                </select>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header"><span class="card-title">ðŸ§  Personality</span></div>
              <div class="slider-group">
                <div class="slider-header"><span>Confidence</span><span class="slider-val" id="sl-confidence-val">50</span></div>
                <input type="range" id="sl-confidence" min="0" max="100" value="50" oninput="document.getElementById('sl-confidence-val').textContent=this.value">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>Creativity</span><span class="slider-val" id="sl-creativity-val">50</span></div>
                <input type="range" id="sl-creativity" min="0" max="100" value="50" oninput="document.getElementById('sl-creativity-val').textContent=this.value">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>Precision</span><span class="slider-val" id="sl-precision-val">50</span></div>
                <input type="range" id="sl-precision" min="0" max="100" value="50" oninput="document.getElementById('sl-precision-val').textContent=this.value">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>Chattiness</span><span class="slider-val" id="sl-chattiness-val">50</span></div>
                <input type="range" id="sl-chattiness" min="0" max="100" value="50" oninput="document.getElementById('sl-chattiness-val').textContent=this.value">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>Helpfulness</span><span class="slider-val" id="sl-helpfulness-val">75</span></div>
                <input type="range" id="sl-helpfulness" min="0" max="100" value="75" oninput="document.getElementById('sl-helpfulness-val').textContent=this.value">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>Independence</span><span class="slider-val" id="sl-independence-val">50</span></div>
                <input type="range" id="sl-independence" min="0" max="100" value="50" oninput="document.getElementById('sl-independence-val').textContent=this.value">
              </div>
            </div>

            <div class="card" style="margin-top:16px">
              <div class="card-header"><span class="card-title">âš™ï¸ Advanced AI Settings</span><span class="card-subtitle">Buy power-ups in Store to unlock max 210!</span></div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸ§  Logic & Reasoning</span><span class="slider-val" id="sl-logic-val">100</span><span class="adv-lock-badge" id="lock-logic" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-logic" min="0" max="100" value="100" oninput="updateAdvSlider('logic',this.value)" style="background:linear-gradient(90deg,var(--bg4) 0%,#6366f1 100%)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>âš¡ Response Speed</span><span class="slider-val" id="sl-speed-val">100</span><span class="adv-lock-badge" id="lock-speed" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-speed" min="0" max="100" value="100" oninput="updateAdvSlider('speed',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸ”¬ Analysis Depth</span><span class="slider-val" id="sl-depth-val">100</span><span class="adv-lock-badge" id="lock-depth" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-depth" min="0" max="100" value="100" oninput="updateAdvSlider('depth',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸŽ¯ Focus Level</span><span class="slider-val" id="sl-focus-val">100</span><span class="adv-lock-badge" id="lock-focus" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-focus" min="0" max="100" value="100" oninput="updateAdvSlider('focus',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸ’¾ Memory Retention</span><span class="slider-val" id="sl-memory-val">100</span><span class="adv-lock-badge" id="lock-memory" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-memory" min="0" max="100" value="100" oninput="updateAdvSlider('memory',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸ”„ Adaptability</span><span class="slider-val" id="sl-adapt-val">100</span><span class="adv-lock-badge" id="lock-adapt" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-adapt" min="0" max="100" value="100" oninput="updateAdvSlider('adapt',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸ“š Knowledge Breadth</span><span class="slider-val" id="sl-knowledge-val">100</span><span class="adv-lock-badge" id="lock-knowledge" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-knowledge" min="0" max="100" value="100" oninput="updateAdvSlider('knowledge',this.value)">
              </div>
              <div class="slider-group">
                <div class="slider-header"><span>ðŸŽ¨ Code Style</span><span class="slider-val" id="sl-style-val">100</span><span class="adv-lock-badge" id="lock-style" style="font-size:10px;color:var(--yellow);margin-left:6px">ðŸ”’ max 100</span></div>
                <input type="range" id="sl-style" min="0" max="100" value="100" oninput="updateAdvSlider('style',this.value)">
              </div>
              <p style="font-size:11px;color:var(--text3);margin-top:8px;text-align:center">ðŸ’¡ Purchase power-ups from the <a href="#" onclick="showPage('store');return false" style="color:var(--accent2)">Store</a> to unlock each stat to max 210!</p>
            </div>
          </div>

          <div>
            <div class="card">
              <div class="card-header"><span class="card-title">âš¡ Skills</span></div>
              <div class="skill-tags" id="skill-tags"></div>
            </div>

            <div class="card">
              <div class="card-header"><span class="card-title">ðŸ“ Custom Instructions</span></div>
              <div class="form-group">
                <label class="form-label">Tell this AI what to focus on</label>
                <textarea id="ai-instructions" rows="4" style="width:100%" placeholder="e.g. Focus on writing clean Python code. Always add docstrings. Prefer functional patterns..."></textarea>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><span class="card-title">ðŸ’» Code / Behavior</span><span class="card-subtitle">Optional: Define custom logic</span></div>
              <div class="code-editor">
                <div class="code-toolbar">
                  <div class="code-dot" style="background:#ff5f56"></div>
                  <div class="code-dot" style="background:#ffbd2e"></div>
                  <div class="code-dot" style="background:#27c93f"></div>
                  <span style="margin-left:8px;font-size:12px;color:var(--text3)">ai_behavior.js</span>
                </div>
                <textarea class="code-textarea" id="ai-code" placeholder="// Define custom behavior for your AI
// This code shapes how your AI responds and acts

function onMessage(msg, context) {
  // React to incoming messages
  return { reply: 'Hello! I received: ' + msg };
}

function onTask(task) {
  // Handle assigned tasks
  return { plan: breakdownTask(task) };
}"></textarea>
              </div>
            </div>

            <div class="card" style="margin-top:8px">
              <div class="card-header"><span class="card-title">ðŸ”„ Trading</span></div>
              <div class="toggle-wrap" style="margin-bottom:8px">
                <span class="toggle-label">Available for trading</span>
                <label class="toggle"><input type="checkbox" id="ai-share-toggle"><span class="toggle-slider"></span></label>
              </div>
              <p style="font-size:11px;color:var(--text3);margin:0">When enabled, this AI can be listed on the Trading Post for other users to offer trades.</p>
              <button class="btn btn-secondary btn-sm" style="margin-top:8px;width:100%" onclick="showPage('upload')">ðŸª Go to Trading Post</button>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-primary" style="flex:1" onclick="saveAI()">ðŸ’¾ Save AI</button>
              <button class="btn btn-secondary" id="btn-delete-ai" style="display:none" onclick="deleteCurrentAI()">ðŸ—‘ï¸ Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT PAGE -->
      <div class="page" id="page-chat">
        <div class="chat-container">
          <div class="chat-main">
            <div class="chat-messages" id="chat-messages">
              <div class="empty-state" id="chat-empty"><div class="empty-icon">ðŸ’¬</div><p>Start a conversation! Your AIs will chat with each other and you.</p></div>
            </div>
            <div id="typing-area" style="display:none;padding:4px 16px">
              <div class="typing-indicator"><span style="font-size:12px;color:var(--text3);margin-right:6px" id="typing-name"></span><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
            </div>
            <div class="chat-input-area">
              <select id="chat-as" style="width:140px"><option value="user">ðŸ‘¤ You</option></select>
              <textarea id="chat-input" placeholder="Type a message or give a command to your AIs..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
              <button class="btn btn-primary" onclick="sendChat()">Send</button>
              <button class="btn btn-secondary" onclick="triggerAIChat()" title="Make AIs chat with each other">ðŸ¤–ðŸ’¬</button>
            </div>
          </div>
          <div class="chat-sidebar">
            <div style="font-weight:700;font-size:14px;margin-bottom:12px">Chat Members</div>
            <div id="chat-members"></div>
            <hr style="border-color:var(--border);margin:12px 0">
            <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Chat Controls</div>
            <div class="toggle-wrap">
              <span class="toggle-label">Auto-Chat</span>
              <label class="toggle"><input type="checkbox" id="auto-chat-toggle" checked onchange="toggleAutoChat(this.checked)"><span class="toggle-slider"></span></label>
            </div>
            <button class="btn btn-secondary btn-sm" style="width:100%;margin-bottom:6px" onclick="triggerAllAIDiscussion()">ðŸŽ­ AI Roundtable</button>
            <button class="btn btn-secondary btn-sm" style="width:100%;margin-bottom:6px" onclick="clearChat()">ðŸ—‘ï¸ Clear Chat</button>
          </div>
        </div>
      </div>

      <!-- TASKS PAGE -->
      <div class="page" id="page-tasks">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
          <button class="btn btn-secondary" onclick="aiPlanTasks()">ðŸ¤– AI Auto-Plan</button>
          <span style="font-size:12px;color:var(--text3)">Give your AIs a goal and they'll break it down into tasks</span>
        </div>
        <div class="task-board" id="task-board">
          <div class="task-column">
            <div class="task-col-header">ðŸ“¥ Backlog <span class="task-col-count" id="count-backlog">0</span></div>
            <div class="task-col-body" id="col-backlog"></div>
          </div>
          <div class="task-column">
            <div class="task-col-header">ðŸ”„ In Progress <span class="task-col-count" id="count-progress">0</span></div>
            <div class="task-col-body" id="col-progress"></div>
          </div>
          <div class="task-column">
            <div class="task-col-header">ðŸ” Review <span class="task-col-count" id="count-review">0</span></div>
            <div class="task-col-body" id="col-review"></div>
          </div>
          <div class="task-column">
            <div class="task-col-header">âœ… Done <span class="task-col-count" id="count-done">0</span></div>
            <div class="task-col-body" id="col-done"></div>
          </div>
        </div>
      </div>

      <!-- AI TRADING PAGE -->
      <div class="page" id="page-upload">
        <!-- Trade Header -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800;margin-bottom:4px">ðŸ”„ AI Trading Post</h2>
            <p style="font-size:13px;color:var(--text3)">Trade your AIs with other users! List your AIs for trade or browse available trades.</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span style="font-size:13px;color:var(--text2)">ðŸª™ <span id="trade-coins">âˆž</span></span>
            <span style="font-size:13px;color:var(--text2)">ðŸ’Ž <span id="trade-gems">âˆž</span></span>
          </div>
        </div>

        <!-- List an AI for Trade -->
        <div class="card">
          <div class="card-header"><span class="card-title">ðŸ“¦ List an AI for Trade</span></div>
          <p style="font-size:12px;color:var(--text3);margin-bottom:12px">Select one of your AIs to put up for trade. Set what you want in return.</p>
          <div class="grid-2" style="gap:16px">
            <div>
              <div class="form-label">Your AI to Trade</div>
              <select id="trade-offer-ai" style="width:100%;margin-bottom:8px"></select>
              <div class="form-label">What You Want</div>
              <select id="trade-want-type" style="width:100%;margin-bottom:8px">
                <option value="ai">ðŸ¤– Another AI (any)</option>
                <option value="coins">ðŸª™ Coins</option>
                <option value="gems">ðŸ’Ž Gems</option>
                <option value="specific">ðŸŽ¯ Specific AI Role</option>
              </select>
              <div id="trade-want-details" style="margin-bottom:8px"></div>
              <div class="form-label">Trade Note (optional)</div>
              <input type="text" id="trade-note" placeholder="Looking for a coder AI..." style="width:100%;margin-bottom:12px">
              <button class="btn btn-primary" onclick="listAIForTrade()" style="width:100%">ðŸ“¤ List for Trade</button>
            </div>
            <div>
              <div class="form-label" style="margin-bottom:8px">Preview</div>
              <div id="trade-preview" style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:16px;min-height:120px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:13px">Select an AI to preview</div>
            </div>
          </div>
        </div>

        <!-- Active Trade Listings -->
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸª Trade Marketplace</span><span class="card-subtitle" id="trade-count">0 listings</span></div>
          <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap" id="trade-filters">
            <div class="filter-chip active" onclick="filterTrades('all')">All</div>
            <div class="filter-chip" onclick="filterTrades('yours')">ðŸ“¦ Your Listings</div>
            <div class="filter-chip" onclick="filterTrades('available')">ðŸ”„ Available</div>
            <div class="filter-chip" onclick="filterTrades('completed')">âœ… Completed</div>
          </div>
          <div id="trade-listings-grid" class="grid-2" style="gap:12px">
            <div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ðŸª</div><p>No trades listed yet. Be the first to list an AI!</p></div>
          </div>
        </div>

        <!-- Your Trade History -->
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ“œ Trade History</span></div>
          <div id="trade-history" style="max-height:200px;overflow-y:auto">
            <p style="font-size:12px;color:var(--text3);text-align:center;padding:20px">No completed trades yet.</p>
          </div>
        </div>

        <!-- Legacy Import/Export (collapsed) -->
        <details style="margin-top:16px">
          <summary style="cursor:pointer;font-size:13px;color:var(--text3);padding:8px 0">ðŸ“ Import / Export (Advanced)</summary>
          <div class="card" style="margin-top:8px">
            <div class="grid-2" style="gap:16px">
              <div>
                <div class="form-label">Export AIs</div>
                <button class="btn btn-secondary btn-sm" onclick="exportAll()" style="width:100%;margin-bottom:6px">ðŸ“¥ Download All (.json)</button>
                <select id="export-single" style="width:100%;margin-bottom:4px"></select>
                <button class="btn btn-secondary btn-sm" onclick="exportSingle()" style="width:100%">Download Selected</button>
              </div>
              <div>
                <div class="form-label">Import AIs</div>
                <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer" onclick="document.getElementById('upload-file').click()">
                  <div style="font-size:24px;margin-bottom:4px">ðŸ“</div>
                  <div style="font-size:12px;color:var(--text3)">Click to upload .json</div>
                </div>
                <input type="file" id="upload-file" accept=".json" style="display:none" onchange="importAIs(event)">
              </div>
            </div>
          </div>
        </details>
        <textarea id="share-code" rows="1" style="display:none"></textarea>
      </div>

      <!-- FIND AI PAGE -->
      <!-- FIND AI PAGE -->
      <div class="page" id="page-find">
        <div class="discover-search">
          <input type="text" id="find-search" placeholder="Search AIs by name, role, skill..." oninput="renderFindAI()">
          <button class="btn btn-primary" onclick="renderFindAI()">ðŸ” Search</button>
        </div>
        <div class="filter-bar" id="find-filters"></div>
        <div class="discover-grid" id="find-grid"></div>
      </div>

      <!-- CRAFT AI PAGE -->
      <div class="page" id="page-craftai">
        <div class="craft-container">
          <div class="craft-workbench">
            <div class="card" style="background:linear-gradient(135deg, var(--bg3), var(--bg4));border-color:var(--accent);margin-bottom:0">
              <div style="display:flex;align-items:center;gap:12px">
                <span style="font-size:48px">ðŸŽ²</span>
                <div>
                  <h2 style="margin:0;background:linear-gradient(135deg,var(--accent),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent">AI Randomizer</h2>
                  <p style="margin:4px 0 0;color:var(--text2);font-size:13px">Lock in what you want, randomize the rest â€” instant unique AIs!</p>
                </div>
              </div>
            </div>
            <div class="craft-section">
              <div class="craft-section-title">âš¡ Role <span class="craft-random-tag" id="craft-tag-role">ðŸŽ² Random</span></div>
              <div class="craft-ingredient-grid" id="craft-roles"></div>
            </div>
            <div class="craft-section">
              <div class="craft-section-title">ðŸ¾ Animal Mindset <span class="craft-random-tag" id="craft-tag-animal">ðŸŽ² Random</span></div>
              <div class="craft-ingredient-grid" id="craft-animals"></div>
            </div>
            <div class="craft-section">
              <div class="craft-section-title">ðŸ§  AI Model <span class="craft-random-tag" id="craft-tag-model">ðŸŽ² Random</span></div>
              <div class="craft-ingredient-grid" id="craft-models"></div>
            </div>
            <div class="craft-section">
              <div class="craft-section-title">ðŸ—£ï¸ Voice <span class="craft-random-tag" id="craft-tag-voice">ðŸŽ² Random</span></div>
              <div class="craft-ingredient-grid" id="craft-voices"></div>
            </div>
            <div class="craft-section" style="text-align:center;background:linear-gradient(135deg, var(--bg3), var(--bg4))">
              <div style="margin-bottom:12px;font-size:13px;color:var(--text2)">How many AIs to generate?</div>
              <div style="display:flex;gap:8px;justify-content:center;margin-bottom:14px">
                <button class="craft-count-btn selected" onclick="setCraftCount(1)">1</button>
                <button class="craft-count-btn" onclick="setCraftCount(2)">2</button>
                <button class="craft-count-btn" onclick="setCraftCount(3)">3</button>
                <button class="craft-count-btn" onclick="setCraftCount(5)">5</button>
              </div>
              <div class="craft-auto-toggle">
                <label>
                  <span class="craft-toggle-switch">
                    <input type="checkbox" id="craft-auto-accept" onchange="toggleCraftAutoAccept()">
                    <span class="craft-toggle-slider"></span>
                  </span>
                  Auto-Accept (instant add)
                </label>
              </div>
              <button class="craft-forge-btn" id="craft-generate-btn" onclick="generateCraftAIs()">ðŸŽ² Generate Random AI</button>
              <div class="craft-gen-count" id="craft-gen-count">0 AIs crafted this session</div>
            </div>
          </div>
          <div>
            <div class="craft-preview" id="craft-results-panel">
              <div id="craft-results-content" style="text-align:center;color:var(--text3);padding:40px 10px">
                <div style="font-size:64px;margin-bottom:12px">ðŸŽ²</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px">Ready to Generate</div>
                <div style="font-size:13px">Lock in any preferences on the left, then hit Generate!</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FREE MODE PAGE -->
      <div class="page" id="page-freemode">
        <div class="free-mode-controls">
          <button class="btn btn-primary" id="fm-toggle" onclick="toggleFreeMode()">â–¶ Start Free Mode</button>
          <button class="btn btn-secondary" onclick="freeModePoke()">ðŸ‘‰ Poke Random AI</button>
          <div class="speed-slider">
            <span>Speed:</span>
            <input type="range" min="1" max="5" value="2" id="fm-speed" oninput="updateFMSpeed()">
            <span id="fm-speed-label">2x</span>
          </div>
          <span style="margin-left:auto;font-size:12px;color:var(--text3)" id="fm-status">Stopped</span>
        </div>
        <div class="free-mode-arena" id="fm-arena">
          <div class="free-mode-log" id="fm-log"></div>
        </div>
      </div>

      <!-- AI ANALYSIS PAGE -->
      <div class="page" id="page-analysis">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
          <select id="analysis-ai" style="min-width:200px" onchange="renderAnalysis()"><option value="">All AIs (Overview)</option></select>
          <button class="btn btn-secondary btn-sm" onclick="renderAnalysis()">ðŸ”„ Refresh</button>
        </div>
        <div id="analysis-content"></div>
      </div>

      <!-- FUSION LAB PAGE -->
      <div class="page" id="page-fusion">
        <div class="card" style="background:linear-gradient(135deg, var(--bg3), var(--bg4)); border-color:var(--pink)">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <span style="font-size:48px">âš—ï¸</span>
            <div>
              <h2 style="margin:0;background:linear-gradient(135deg,var(--pink),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Fusion Lab</h2>
              <p style="margin:4px 0 0;color:var(--text2)">Combine multiple AI minds into one powerful hybrid!</p>
            </div>
          </div>
          <p style="color:var(--text2);font-size:13px;margin-bottom:16px">Select any number of AIs to fuse together. Their stats, personalities, and abilities will merge into a new unique AI!</p>
        </div>

        <div class="grid-2" style="gap:20px">
          <!-- Left: AI Selection -->
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ§¬ Select AIs to Fuse</span><span class="card-subtitle">Pick 2+ AIs</span></div>
            <div id="fusion-ai-list" style="max-height:400px;overflow-y:auto"></div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
              <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Or fuse AI Model Mindsets:</div>
              <div id="fusion-mindset-list" style="display:flex;flex-wrap:wrap;gap:6px;max-height:150px;overflow-y:auto"></div>
            </div>
          </div>

          <!-- Right: Fusion Preview -->
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ”® Fusion Preview</span><span class="card-subtitle" id="fusion-count">0 AIs selected</span></div>
            <div id="fusion-preview" style="min-height:200px">
              <div style="text-align:center;padding:40px;color:var(--text3)">
                <span style="font-size:48px;opacity:0.5">âš—ï¸</span>
                <p>Select at least 2 AIs to see fusion preview</p>
              </div>
            </div>
            <div id="fusion-stats" style="display:none">
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px">
                <div class="stat-box"><span class="stat-label">Power</span><span class="stat-value" id="fuse-power">0</span></div>
                <div class="stat-box"><span class="stat-label">Speed</span><span class="stat-value" id="fuse-speed">0</span></div>
                <div class="stat-box"><span class="stat-label">Precision</span><span class="stat-value" id="fuse-precision">0</span></div>
                <div class="stat-box"><span class="stat-label">Creativity</span><span class="stat-value" id="fuse-creativity">0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fusion Controls -->
        <div class="card" style="margin-top:16px">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fusion Name</label>
              <input type="text" id="fusion-name" style="width:100%" placeholder="Enter name for fused AI...">
            </div>
            <div class="form-group">
              <label class="form-label">Fusion Type</label>
              <select id="fusion-type" style="width:100%" onchange="updateFusionPreview()">
                <option value="balanced">âš–ï¸ Balanced â€” Average all stats</option>
                <option value="max">ðŸ”¥ Maximum â€” Take best of each stat</option>
                <option value="dominant">ðŸ‘‘ Dominant â€” First AI leads, others enhance</option>
                <option value="chaotic">ðŸŒ€ Chaotic â€” Random stat combinations</option>
                <option value="synergy">âœ¨ Synergy â€” Stats multiply (powerful!)</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:16px">
            <button class="btn btn-primary" onclick="performFusion()" id="fusion-btn" disabled>
              âš—ï¸ Perform Fusion
            </button>
            <button class="btn btn-secondary" onclick="selectAllFusion()">âœ… Select All</button>
            <button class="btn btn-secondary" onclick="clearFusion()">ðŸ—‘ï¸ Clear Selection</button>
            <button class="btn btn-secondary" onclick="randomFusion()">ðŸŽ² Random Fusion</button>
          </div>
        </div>

        <!-- Recent Fusions -->
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ§ª Recent Fusions</span></div>
          <div id="recent-fusions" style="color:var(--text3);font-size:13px">No fusions yet. Create your first hybrid AI!</div>
        </div>
      </div>

      <!-- AI WORLD - Civilization Game -->
      <div class="page" id="page-aiworld">
        <div class="card" style="background:linear-gradient(135deg, #1a1a2e, #16213e); border-color:#10b981">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:12px">
              <span style="font-size:48px">ðŸŒ</span>
              <div>
                <h2 style="margin:0;background:linear-gradient(135deg,#10b981,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent">AI World</h2>
                <p style="margin:4px 0 0;color:var(--text2)">Watch your AIs build a civilization or fight to be the last one standing!</p>
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary" onclick="resetAIWorld()">ðŸ”„ Reset</button>
              <button class="btn btn-primary" id="world-toggle-btn" onclick="toggleAIWorld()">â–¶ï¸ Start</button>
            </div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-size:12px;color:var(--text3)">Mode:</label>
              <select id="world-mode" style="padding:6px 12px" onchange="saveAIWorldState()">
                <option value="civilization">ðŸ›ï¸ Civilization (Cooperate)</option>
                <option value="battle">âš”ï¸ Battle Royale (Fight)</option>
                <option value="mixed">ðŸŽ­ Mixed (Alliances & Wars)</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-size:12px;color:var(--text3)">Speed:</label>
              <select id="world-speed" style="padding:6px 12px" onchange="saveAIWorldState()">
                <option value="slow">ðŸ¢ Slow</option>
                <option value="normal" selected>ðŸš¶ Normal</option>
                <option value="fast">ðŸƒ Fast</option>
                <option value="turbo">âš¡ Turbo</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;background:var(--bg4);padding:6px 12px;border-radius:6px">
              <span style="font-size:12px;color:var(--text3)">Day:</span>
              <span id="world-day" style="font-weight:bold;color:#10b981">1</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;background:var(--bg4);padding:6px 12px;border-radius:6px">
              <span style="font-size:12px;color:var(--text3)">Alive:</span>
              <span id="world-alive" style="font-weight:bold;color:#10b981">0</span>
            </div>
          </div>
        </div>

        <div class="grid-2" style="gap:16px;margin-top:16px">
          <!-- World Map -->
          <div class="card" style="min-height:400px">
            <div class="card-header"><span class="card-title">ðŸ—ºï¸ World Map</span></div>
            <div id="world-map" style="position:relative;height:350px;background:linear-gradient(180deg,#1a1a2e 0%,#0f3460 50%,#16213e 100%);border-radius:8px;overflow:hidden">
              <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--text3)">
                <div style="text-align:center">
                  <span style="font-size:48px">ðŸŒ</span>
                  <p>Start the simulation to see AIs interact!</p>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Status Panel -->
          <div class="card" style="max-height:450px;overflow-y:auto">
            <div class="card-header"><span class="card-title">ðŸ‘¥ AI Status</span></div>
            <div id="world-ai-status">
              <div style="text-align:center;padding:20px;color:var(--text3)">No AIs in the world yet</div>
            </div>
          </div>
        </div>

        <!-- Event Log -->
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ“œ World Events</span><span class="card-subtitle" id="world-event-count">0 events</span></div>
          <div id="world-events" style="max-height:200px;overflow-y:auto;font-size:13px">
            <div style="text-align:center;padding:20px;color:var(--text3)">Events will appear here...</div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ† Leaderboard</span></div>
          <div id="world-leaderboard" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
            <div style="text-align:center;padding:20px;color:var(--text3)">Start a game to see rankings!</div>
          </div>
        </div>
      </div>

      </div>

      <!-- AITube Page -->
      <div class="page" id="page-aitube">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button class="btn btn-primary" style="background:#ef4444" onclick="generateAITubeVideo()">ðŸ“º Generate Video</button>
          <button class="btn btn-secondary" onclick="toggleAITubeAutoGen()" id="aitube-autogen-btn">ðŸ”„ Auto-Generate: OFF</button>
          <button class="btn btn-secondary" onclick="clearAITube()">ðŸ—‘ï¸ Clear All</button>
          <span style="font-size:12px;color:var(--text3)">Your AIs create videos â€” watch, chat, and interact!</span>
        </div>
        <div class="aitube-grid" id="aitube-grid">
          <div class="empty-state" id="aitube-empty"><div class="empty-icon">ðŸ“º</div><p>No videos yet! Click "Generate Video" to let your AIs create content.</p></div>
        </div>
      </div>

      <!-- AITube Video Player Modal -->
      <div class="modal-overlay" id="aitube-player-modal">
        <div class="modal" style="max-width:900px;max-height:90vh;overflow-y:auto">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="modal-title" id="aitube-player-title" style="margin-bottom:0">ðŸ“º Video</div>
            <button class="btn btn-secondary btn-sm" onclick="closeAITubePlayer()">&times;</button>
          </div>
          <div class="aitube-player" id="aitube-player-area">
            <div class="aitube-player-title">NOW PLAYING</div>
            <button class="aitube-playpause" id="aitube-playpause" onclick="toggleAITubePlayPause()">â¸</button>
            <div class="aitube-player-content" id="aitube-player-content"></div>
            <div class="aitube-progress" id="aitube-progress-bar"></div>
            <div class="aitube-time" id="aitube-time-display">0:00 / 0:00</div>
          </div>
          <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
            <div id="aitube-player-channel" style="display:flex;align-items:center;gap:8px"></div>
            <div style="flex:1"></div>
            <button class="btn btn-secondary btn-sm" onclick="likeAITubeVideo()" id="aitube-like-btn">ðŸ‘ 0</button>
            <button class="btn btn-secondary btn-sm" onclick="deleteAITubeVideo()">ðŸ—‘ï¸</button>
          </div>
          <div id="aitube-player-desc" style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6;white-space:pre-wrap"></div>
          <div id="aitube-player-tags" class="aitube-tags" style="margin-bottom:16px"></div>
          <div class="aitube-chatroom" id="aitube-chatroom">
            <div class="aitube-chatroom-header">
              <span>ðŸ’¬ Live Chat</span>
              <button class="btn btn-secondary btn-sm" onclick="triggerAITubeChatRound()" style="font-size:11px">ðŸ¤– AI Chat</button>
            </div>
            <div class="aitube-chatroom-messages" id="aitube-chat-messages"></div>
            <div class="aitube-chatroom-input">
              <input type="text" id="aitube-chat-input" placeholder="Say something..." onkeydown="if(event.key==='Enter'){sendAITubeChat();event.preventDefault()}">
              <button class="btn btn-primary btn-sm" onclick="sendAITubeChat()">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Book Page -->
      <div class="page" id="page-aibook">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button class="btn btn-primary" onclick="generateAIBookStory()">ðŸ“ Generate Story</button>
          <button class="btn btn-primary" style="background:#8b5cf6" onclick="generateAIFreePost()">ðŸ’­ Let AI Post</button>
          <button class="btn btn-secondary" onclick="toggleAIAutoPost()" id="aibook-autopost-btn">ðŸ”„ Auto-Post: OFF</button>
          <button class="btn btn-secondary" onclick="clearAIBook()">ðŸ—‘ï¸ Clear All</button>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:16px">ðŸ“š AIs write stories, share thoughts, post opinions & more â€” comment on anything!</div>
        <div id="aibook-stories" style="display:flex;flex-direction:column;gap:16px;padding-right:4px">
          <div class="empty-state" id="aibook-empty"><div class="empty-icon">ðŸ“š</div><p>No posts yet! Click a button above to let your AIs create something.</p></div>
        </div>
      </div>

      <!-- Custom Chats Page -->
      <div class="page" id="page-customchats">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <button class="btn btn-primary" onclick="openCreateChatModal()">+ New Chat Room</button>
          <span style="font-size:12px;color:var(--text3)">Create private chat rooms with only the AIs you choose</span>
        </div>
        <div id="custom-chats-list" style="display:flex;flex-direction:column;gap:12px;padding-right:4px">
          <div class="empty-state" id="customchats-empty"><div class="empty-icon">ðŸ’¬</div><p>No custom chats yet! Create one and pick which AIs to include.</p></div>
        </div>
      </div>

      <!-- Custom Chat Room Modal -->
      <div class="modal-overlay" id="create-chat-modal">
        <div class="modal" style="max-width:500px">
          <div class="modal-title">ðŸ’¬ Create Custom Chat Room</div>
          <div class="form-group">
            <label class="form-label">Chat Room Name</label>
            <input type="text" id="custom-chat-name" placeholder="e.g. Backend Team, Bug Fixers, Design Squad..." style="width:100%">
          </div>
          <div class="form-group">
            <label class="form-label">Select AIs to Include</label>
            <div id="custom-chat-ai-picker" style="display:flex;flex-wrap:wrap;gap:8px;max-height:300px;overflow-y:auto;padding:8px;background:var(--bg4);border-radius:8px"></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px">
            <button class="btn btn-primary" style="flex:1" onclick="createCustomChat()">Create Chat</button>
            <button class="btn btn-secondary" onclick="closeCreateChatModal()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Custom Chat View Modal -->
      <div class="modal-overlay" id="custom-chat-view">
        <div class="modal" style="max-width:700px;height:80vh;display:flex;flex-direction:column">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="modal-title" id="custom-chat-view-title" style="margin-bottom:0">Chat Room</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" onclick="triggerCustomChatRound()">ðŸ¤– AI Talk</button>
              <button class="btn btn-secondary btn-sm" onclick="closeCustomChatView()">&times;</button>
            </div>
          </div>
          <div id="custom-chat-members-bar" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>
          <div id="custom-chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:8px;background:var(--bg4);border-radius:8px;margin-bottom:8px"></div>
          <div style="display:flex;gap:8px">
            <textarea id="custom-chat-input" placeholder="Type a message..." rows="1" style="flex:1;max-height:60px" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendCustomChat()}"></textarea>
            <button class="btn btn-primary" onclick="sendCustomChat()">Send</button>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div class="page" id="page-settings">
        <div class="card" style="border-color:#10b981">
          <div class="card-header"><span class="card-title">ï¿½ AI Engine</span><span class="card-subtitle">Built-in AI â€” unlimited, no login</span></div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:16px">AI Hub has a <strong>built-in AI brain</strong> â€” it just works. Unlimited conversations, no tokens, no login, no setup. Like having Copilot baked right into the app.</p>
          <div style="display:flex;align-items:center;gap:12px;padding:16px;background:linear-gradient(135deg,var(--bg4),rgba(16,185,129,0.1));border-radius:12px;border:1px solid rgba(16,185,129,0.3)">
            <span style="font-size:28px">ðŸ§ </span>
            <div style="flex:1">
              <div style="font-weight:600;color:var(--text)">AI Brain</div>
              <span style="font-size:12px;color:var(--text3)" id="real-ai-status">âœ… Active â€” Unlimited</span>
            </div>
            <label class="toggle"><input type="checkbox" id="real-ai-toggle" onchange="toggleRealAI(this.checked)" checked><span class="toggle-slider"></span></label>
          </div>
          <!-- hidden token input kept for backward compat -->
          <div style="display:none">
            <input type="password" id="github-token-input">
          </div>
          <div style="margin-top:12px;padding:12px;background:var(--bg4);border-radius:8px">
            <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Response Length</div>
            <select id="ai-token-select" style="width:100%" onchange="saveTokenSetting()">
              <option value="small">ðŸ”¹ Small â€” Short & snappy</option>
              <option value="medium" selected>ðŸ”¸ Medium â€” Balanced</option>
              <option value="large">ðŸ”¶ Large â€” Detailed</option>
              <option value="max">âš¡ Maximum â€” Full depth</option>
            </select>
          </div>
          <div id="ai-test-area" style="margin-top:12px">
            <button class="btn btn-secondary" onclick="testFreeAI()" style="width:100%">ðŸ§ª Test AI Brain</button>
            <div id="ai-test-status" style="margin-top:8px;font-size:12px;color:var(--text3)"></div>
          </div>
          <!-- hidden model select kept for backward compat -->
          <div style="display:none"><select id="ai-model-select"><option value="gpt-4o" selected>GPT-4o</option></select></div>
        </div>
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ“Š AI Usage Stats</span></div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
            <div style="background:var(--bg4);padding:16px;border-radius:8px;text-align:center">
              <div style="font-size:24px;font-weight:bold;color:#10b981" id="api-calls-count">0</div>
              <div style="font-size:12px;color:var(--text3)">AI Calls Made</div>
            </div>
            <div style="background:var(--bg4);padding:16px;border-radius:8px;text-align:center">
              <div style="font-size:24px;font-weight:bold;color:#3b82f6" id="api-tokens-count">0</div>
              <div style="font-size:12px;color:var(--text3)">Tokens Used</div>
            </div>
            <div style="background:var(--bg4);padding:16px;border-radius:8px;text-align:center">
              <div style="font-size:24px;font-weight:bold;color:#10b981" id="api-status-indicator">Online</div>
              <div style="font-size:12px;color:var(--text3)">AI Status</div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">â„¹ï¸ How It Works</span></div>
          <div style="font-size:13px;color:var(--text2);line-height:1.7">
            <p>ðŸ§  <strong>Built-in AI brain</strong> â€” same intelligence as Copilot, baked directly into the app. No setup, no limits</p>
            <p>â­ <strong>GPT-4o level intelligence</strong> â€” the smartest model available, powering every AI you create</p>
            <p>ðŸŽ­ <strong>Each AI keeps its personality</strong> â€” their animal mindset, model style, voice, and role shape how the AI brain responds</p>
            <p>ðŸ’¬ <strong>AI-to-AI conversations are real</strong> â€” auto-chat and roundtable discussions are genuinely intelligent</p>
            <p>ðŸ”’ <strong>100% private</strong> â€” everything stays in your browser. No accounts, no data collection</p>
            <p>â™¾ï¸ <strong>Unlimited usage</strong> â€” no tokens, no credits, no quotas. Chat as much as you want, forever</p>
            <p>ðŸ¤– <strong>Copilot Assist</strong> â€” your AIs can call on extra intelligence during work tasks</p>
          </div>
        </div>

        <!-- AI Intelligence Settings -->
        <div class="card" style="margin-top:16px;border-color:#8b5cf6">
          <div class="card-header">
            <span class="card-title">ðŸ§  AI Intelligence</span>
            <span class="smartness-level-badge" id="sm-level-badge">0 IQ avg</span>
          </div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Configure AI intelligence levels. Higher IQ means smarter, more capable AIs. Your AIs learn from clones you deploy and answers you provide.</p>
          <div class="smart-stats-row" id="smart-stats-row"></div>
          <div style="margin-top:12px;padding:14px;background:var(--bg4);border-radius:10px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <div style="font-size:13px;font-weight:700">ðŸ¤– Copilot Assist</div>
              <label class="toggle"><input type="checkbox" id="copilot-assist-toggle" onchange="toggleCopilotAssist(this.checked)" checked><span class="toggle-slider"></span></label>
            </div>
            <p style="font-size:12px;color:var(--text3)">When enabled, your AIs can call on Copilot's intelligence during work tasks for higher quality output.</p>
          </div>
          <div style="margin-top:12px;padding:14px;background:var(--bg4);border-radius:10px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <div style="font-size:13px;font-weight:700">ðŸ”„ API Fallback</div>
              <label class="toggle"><input type="checkbox" id="api-fallback-toggle" onchange="toggleAPIFallback(this.checked)" checked><span class="toggle-slider"></span></label>
            </div>
            <p style="font-size:12px;color:var(--text3)">When GitHub API fails, automatically fall back to Pollinations.ai free API so AIs never go offline.</p>
          </div>
          <div id="smart-clone-bar" style="margin-top:14px"></div>
          <div id="smart-ai-queue" style="margin-top:14px"></div>
          <div style="margin-top:14px">
            <button class="btn btn-primary btn-sm" onclick="generateAIQuestions()" style="margin-right:8px">ðŸ”„ New Questions</button>
            <button class="btn btn-secondary btn-sm" onclick="maxAllAIIQ()">âš¡ Max All IQ</button>
          </div>
          <div style="margin-top:14px" id="smart-history-card"><div style="font-size:13px;font-weight:700;margin-bottom:8px">ðŸ“œ Training Log</div><div id="smart-history" style="max-height:200px;overflow-y:auto"></div></div>
          <div style="margin-top:14px" id="settings-ai-iq-grid"></div>
        </div>

        <!-- Bought AIs & Boosts Status -->
        <!-- Claude Backup â€” Developer Only -->
        <div class="card" style="margin-top:16px;border-color:#6366f1;position:relative;overflow:hidden" id="claude-backup-card">
          <div class="card-header">
            <span class="card-title">ðŸ”® Claude Backup Engine</span>
            <span style="font-size:11px;padding:3px 8px;background:rgba(239,68,68,0.2);color:#ef4444;border-radius:6px;border:1px solid rgba(239,68,68,0.3)" id="claude-lock-badge">ðŸ”’ LOCKED â€” Dev Only</span>
          </div>
          <!-- Lock overlay -->
          <div id="claude-lock-overlay" style="padding:20px;text-align:center">
            <div style="font-size:40px;margin-bottom:12px">ðŸ”</div>
            <div style="font-weight:700;font-size:15px;color:var(--text);margin-bottom:6px">Developer Access Required</div>
            <p style="font-size:12px;color:var(--text3);margin-bottom:16px">This is a major backup AI engine (Claude) reserved for developers. Enter the dev password to unlock.</p>
            <div style="display:flex;gap:8px;justify-content:center;align-items:center">
              <input type="password" id="claude-dev-password" placeholder="Enter dev password..." style="padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg4);color:var(--text);font-size:13px;width:200px" onkeydown="if(event.key==='Enter')unlockClaudeBackup()">
              <button class="btn btn-primary btn-sm" onclick="unlockClaudeBackup()">ðŸ”“ Unlock</button>
            </div>
            <div id="claude-unlock-error" style="margin-top:8px;font-size:12px;color:#ef4444;display:none"></div>
          </div>
          <!-- Unlocked content (hidden by default) -->
          <div id="claude-unlocked-content" style="display:none">
            <div style="display:flex;align-items:center;gap:12px;padding:16px;background:linear-gradient(135deg,var(--bg4),rgba(99,102,241,0.1));border-radius:12px;border:1px solid rgba(99,102,241,0.3)">
              <span style="font-size:28px">ðŸ”®</span>
              <div style="flex:1">
                <div style="font-weight:600;color:var(--text)">Claude Backup Engine</div>
                <span style="font-size:12px;color:var(--text3)" id="claude-backup-status">âœ… Unlocked â€” Major Backup Active</span>
              </div>
              <label class="toggle"><input type="checkbox" id="claude-backup-toggle" onchange="toggleClaudeBackup(this.checked)" checked><span class="toggle-slider"></span></label>
            </div>
            <div style="margin-top:12px;padding:12px;background:var(--bg4);border-radius:8px">
              <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Claude Model</div>
              <select id="claude-model-select" style="width:100%" onchange="saveClaudeModel()">
                <option value="claude-sonnet-4-20250514" selected>Claude Sonnet 4 (Balanced)</option>
                <option value="claude-3.5-sonnet">Claude 3.5 Sonnet (Fast)</option>
                <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fastest)</option>
              </select>
            </div>
            <div style="margin-top:10px;font-size:12px;color:var(--text3);padding:10px;background:rgba(99,102,241,0.08);border-radius:8px;border:1px solid rgba(99,102,241,0.15)">
              <strong>âš¡ When does Claude kick in?</strong><br>
              Claude activates as a major backup when GitHub API, Copilot Clone, AND Pollinations all fail. It's the last line of defense before falling back to built-in knowledge.
            </div>
            <div style="margin-top:10px">
              <button class="btn btn-secondary btn-sm" onclick="testClaudeBackup()" style="width:100%">ðŸ§ª Test Claude Backup</button>
              <div id="claude-test-status" style="margin-top:6px;font-size:12px;color:var(--text3)"></div>
            </div>
            <div style="margin-top:10px;text-align:right">
              <button class="btn btn-sm" onclick="lockClaudeBackup()" style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);font-size:11px">ðŸ”’ Re-lock</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;border-color:#fbbf24">
          <div class="card-header"><span class="card-title">ðŸ›’ Purchased AIs & Boosts</span></div>
          <div id="settings-purchased-ais" style="margin-bottom:12px"></div>
          <div id="settings-active-boosts"></div>
        </div>
      </div>

      <!-- DAILY REWARDS PAGE -->
      <div class="page" id="page-dailyrewards">
        <div class="card" style="border:2px solid #fbbf24;background:linear-gradient(135deg,var(--bg2),rgba(251,191,36,0.05))">
          <div style="text-align:center;padding:20px">
            <div style="font-size:48px;margin-bottom:10px">ðŸŽ</div>
            <h2 style="font-size:24px;font-weight:800;margin-bottom:5px">Daily Rewards</h2>
            <p style="color:var(--text3);font-size:14px">Come back every day to claim amazing rewards!</p>
            <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-top:20px">
              <div style="text-align:center">
                <div style="font-size:32px;font-weight:800;color:#fbbf24" id="coins-display">âˆž</div>
                <div style="font-size:12px;color:var(--text3)">ðŸª™ Coins</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:32px;font-weight:800;color:#a855f7" id="gems-display">âˆž</div>
                <div style="font-size:12px;color:var(--text3)">ðŸ’Ž Gems</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:32px;font-weight:800;color:#10b981" id="streak-display">0</div>
                <div style="font-size:12px;color:var(--text3)">ðŸ”¥ Streak</div>
              </div>
            </div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:20px" id="daily-rewards-grid"></div>
        <div class="card" style="margin-top:20px">
          <div class="card-header"><span class="card-title">ðŸ† Streak Bonuses</span></div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px" id="streak-bonuses"></div>
        </div>
        <div class="card" style="margin-top:20px;border:2px solid #6366f1">
          <div class="card-header"><span class="card-title">ðŸ‘‘ DEV MODE ACTIVE</span><span style="color:#10b981;font-size:12px;margin-left:auto">âˆž Resources</span></div>
          <p style="font-size:13px;color:var(--text2)">As the developer, you have unlimited coins, gems, and all premium features!</p>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn btn-primary" onclick="addDevBonus('coins',10000)">+10K Coins</button>
            <button class="btn btn-primary" onclick="addDevBonus('gems',1000)">+1K Gems</button>
            <button class="btn btn-success" onclick="unlockAllItems()">Unlock All</button>
          </div>
        </div>
      </div>

      <!-- STORE PAGE -->
      <div class="page" id="page-store">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ›’ AI Hub Store</h2>
            <p style="color:var(--text3);font-size:13px">Premium AIs, power-ups, and exclusive items</p>
          </div>
          <div style="display:flex;gap:16px">
            <div style="background:var(--bg3);padding:10px 20px;border-radius:12px;display:flex;align-items:center;gap:8px">
              <span style="font-size:20px">ðŸª™</span>
              <span style="font-size:18px;font-weight:700;color:#fbbf24" id="store-coins">âˆž</span>
            </div>
            <div style="background:var(--bg3);padding:10px 20px;border-radius:12px;display:flex;align-items:center;gap:8px">
              <span style="font-size:20px">ðŸ’Ž</span>
              <span style="font-size:18px;font-weight:700;color:#a855f7" id="store-gems">âˆž</span>
            </div>
          </div>
        </div>
        <div class="filter-bar" id="store-filters">
          <div class="filter-chip active" onclick="filterStore('all')">All</div>
          <div class="filter-chip" onclick="filterStore('ais')">ðŸ¤– Smart AIs</div>
          <div class="filter-chip" onclick="filterStore('upgrades')">â¬†ï¸ Upgrades</div>
          <div class="filter-chip" onclick="filterStore('powerups')">ðŸ”“ Power-Ups</div>
          <div class="filter-chip" onclick="filterStore('themes')">ðŸŽ¨ Themes</div>
          <div class="filter-chip" onclick="filterStore('special')">âœ¨ Special</div>
        </div>
        <div id="store-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px"></div>
      </div>

      <!-- INVENTORY PAGE -->
      <div class="page" id="page-inventory">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸŽ’ Your Inventory</h2>
            <p style="color:var(--text3);font-size:13px">All your purchased items and collectibles</p>
          </div>
        </div>
        <div class="filter-bar">
          <div class="filter-chip active" onclick="filterInventory('all')">All</div>
          <div class="filter-chip" onclick="filterInventory('ais')">ðŸ¤– AIs</div>
          <div class="filter-chip" onclick="filterInventory('powerups')">âš¡ Power-ups</div>
          <div class="filter-chip" onclick="filterInventory('themes')">ðŸŽ¨ Themes</div>
        </div>
        <div id="inventory-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px"></div>
      </div>

      <!-- TEMPLATES PAGE -->
      <div class="page" id="page-templates">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ“‹ AI Templates</h2>
            <p style="color:var(--text3);font-size:13px">Pre-built AI configurations</p>
          </div>
          <button class="btn btn-primary" onclick="openTemplateBuilder()">+ Create Template</button>
        </div>
        <div class="filter-bar">
          <div class="filter-chip active" onclick="filterTemplates('all')">All</div>
          <div class="filter-chip" onclick="filterTemplates('coding')">ðŸ’» Coding</div>
          <div class="filter-chip" onclick="filterTemplates('writing')">âœï¸ Writing</div>
          <div class="filter-chip" onclick="filterTemplates('design')">ðŸŽ¨ Design</div>
          <div class="filter-chip" onclick="filterTemplates('data')">ðŸ“Š Data</div>
        </div>
        <div id="templates-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px"></div>
      </div>

      <!-- WORKFLOWS PAGE -->
      <div class="page" id="page-workflows">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ”— AI Workflows</h2>
            <p style="color:var(--text3);font-size:13px">Chain multiple AIs together</p>
          </div>
          <button class="btn btn-primary" onclick="openWorkflowBuilder()">+ New Workflow</button>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ“Š Active Workflows</span></div>
            <div id="active-workflows"></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ“ Templates</span></div>
            <div id="workflow-templates"></div>
          </div>
        </div>
        <div class="card" style="margin-top:16px">
          <div class="card-header"><span class="card-title">ðŸ”§ Workflow Builder</span></div>
          <div id="workflow-builder" style="min-height:300px;background:var(--bg);border-radius:12px;padding:20px;border:2px dashed var(--border)">
            <div style="text-align:center;color:var(--text3)">
              <div style="font-size:48px;margin-bottom:10px">ðŸ”—</div>
              <p>Drag and drop AIs to build a pipeline</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PROMPTS LIBRARY PAGE -->
      <div class="page" id="page-prompts">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ’¡ Prompts Library</h2>
            <p style="color:var(--text3);font-size:13px">Save and reuse your best prompts</p>
          </div>
          <button class="btn btn-primary" onclick="openPromptEditor()">+ New Prompt</button>
        </div>
        <div class="discover-search">
          <input type="text" id="prompt-search" placeholder="Search prompts..." style="flex:1">
        </div>
        <div class="filter-bar">
          <div class="filter-chip active" onclick="filterPrompts('all')">All</div>
          <div class="filter-chip" onclick="filterPrompts('coding')">ðŸ’» Coding</div>
          <div class="filter-chip" onclick="filterPrompts('writing')">âœï¸ Writing</div>
          <div class="filter-chip" onclick="filterPrompts('starred')">â­ Starred</div>
        </div>
        <div id="prompts-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px"></div>
      </div>

      <!-- CODE SNIPPETS PAGE -->
      <div class="page" id="page-snippets">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ“ Code Snippets</h2>
            <p style="color:var(--text3);font-size:13px">Your code snippet library</p>
          </div>
          <button class="btn btn-primary" onclick="openSnippetEditor()">+ New Snippet</button>
        </div>
        <div class="discover-search">
          <input type="text" id="snippet-search" placeholder="Search snippets..." style="flex:1">
          <select id="snippet-lang" style="width:150px">
            <option value="all">All Languages</option>
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="typescript">TypeScript</option>
          </select>
        </div>
        <div id="snippets-grid" style="display:grid;grid-template-columns:1fr;gap:12px"></div>
      </div>

      <!-- AI TERMINAL PAGE -->
      <div class="page" id="page-terminal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ’» AI Terminal</h2>
            <p style="color:var(--text3);font-size:13px">Command-line AI interface</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="clearTerminal()">Clear</button>
            <button class="btn btn-secondary btn-sm" onclick="exportTerminalHistory()">Export</button>
          </div>
        </div>
        <div class="code-editor" style="height:calc(100vh - 220px);display:flex;flex-direction:column">
          <div class="code-toolbar">
            <div class="code-dot" style="background:#ff5f56"></div>
            <div class="code-dot" style="background:#ffbd2e"></div>
            <div class="code-dot" style="background:#27ca40"></div>
            <span style="margin-left:12px;font-size:12px;color:var(--text3)">AI Terminal v1.0</span>
            <select id="terminal-ai" style="margin-left:auto;background:var(--bg4);border:none;color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px"></select>
          </div>
          <div id="terminal-output" style="flex:1;overflow-y:auto;padding:16px;font-family:monospace;font-size:13px;line-height:1.6;color:#c9d1d9"></div>
          <div style="display:flex;padding:12px;border-top:1px solid var(--border);background:#161b22">
            <span style="color:#7ee787;margin-right:8px;font-family:monospace">â¯</span>
            <input type="text" id="terminal-input" placeholder="Type a command..." style="flex:1;background:transparent;border:none;color:#c9d1d9;font-family:monospace;font-size:13px" onkeydown="if(event.key==='Enter')runTerminalCommand()">
          </div>
        </div>
      </div>

      <!-- PROJECTS PAGE -->
      <div class="page" id="page-projects">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ“ Projects</h2>
            <p style="color:var(--text3);font-size:13px">Organize your work</p>
          </div>
          <button class="btn btn-primary" onclick="createNewProject()">+ New Project</button>
        </div>
        <div id="projects-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px"></div>
      </div>

      <!-- DEBUGGER PAGE -->
      <div class="page" id="page-debugger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ› AI Debugger</h2>
            <p style="color:var(--text3);font-size:13px">Debug code with AI</p>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ“ Your Code</span></div>
            <div class="code-editor">
              <div class="code-toolbar">
                <select id="debug-lang" style="background:var(--bg4);border:none;color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px">
                  <option value="javascript">JavaScript</option>
                  <option value="python">Python</option>
                  <option value="typescript">TypeScript</option>
                </select>
              </div>
              <textarea class="code-textarea" id="debug-code" rows="15" placeholder="Paste buggy code here..."></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn btn-primary" onclick="analyzeCode()" style="flex:1">ðŸ” Analyze</button>
              <button class="btn btn-success" onclick="fixCode()" style="flex:1">ðŸ”§ Auto-Fix</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ðŸ¤– AI Analysis</span></div>
            <div id="debug-output" style="min-height:300px;background:var(--bg);border-radius:8px;padding:16px;font-size:13px;line-height:1.6">
              <div style="text-align:center;color:var(--text3);padding:40px">
                <div style="font-size:48px;margin-bottom:10px">ðŸ›</div>
                <p>Paste code and click Analyze</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FILE MANAGER PAGE -->
      <div class="page" id="page-files">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ“‚ File Manager</h2>
            <p style="color:var(--text3);font-size:13px">Manage project files</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="createNewFile()">ðŸ“„ New File</button>
            <button class="btn btn-primary btn-sm" onclick="uploadFiles()">â¬†ï¸ Upload</button>
          </div>
        </div>
        <div class="grid-2" style="grid-template-columns:280px 1fr">
          <div class="card" style="height:calc(100vh - 200px);overflow-y:auto">
            <div class="card-header"><span class="card-title">ðŸ“ Files</span></div>
            <div id="file-tree"></div>
          </div>
          <div class="card" style="height:calc(100vh - 200px)">
            <div class="card-header"><span class="card-title" id="file-viewer-title">ðŸ“„ Select a file</span></div>
            <div id="file-viewer" style="height:calc(100% - 50px);overflow:auto"></div>
          </div>
        </div>
      </div>

      <!-- AI COMPARE PAGE -->
      <div class="page" id="page-compare">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">âš–ï¸ AI Compare</h2>
            <p style="color:var(--text3);font-size:13px">Compare AI responses side-by-side</p>
          </div>
        </div>
        <div class="card" style="margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Your Prompt</label>
            <textarea id="compare-prompt" rows="3" style="width:100%" placeholder="Enter a prompt..."></textarea>
          </div>
          <div style="display:flex;gap:12px;align-items:end">
            <div class="form-group" style="flex:1;margin-bottom:0">
              <label class="form-label">Select AIs (up to 4)</label>
              <div id="compare-ai-select" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            </div>
            <button class="btn btn-primary" onclick="runComparison()">âš¡ Compare</button>
          </div>
        </div>
        <div id="compare-results" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px"></div>
      </div>

      <!-- PLUGINS PAGE -->
      <div class="page" id="page-plugins">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ”Œ Plugins</h2>
            <p style="color:var(--text3);font-size:13px">Extend AI Hub</p>
          </div>
          <button class="btn btn-primary" onclick="openPluginMarketplace()">ðŸ›’ Marketplace</button>
        </div>
        <div class="filter-bar">
          <div class="filter-chip active" onclick="filterPlugins('all')">All</div>
          <div class="filter-chip" onclick="filterPlugins('installed')">âœ… Installed</div>
          <div class="filter-chip" onclick="filterPlugins('tools')">ðŸ”§ Tools</div>
          <div class="filter-chip" onclick="filterPlugins('themes')">ðŸŽ¨ Themes</div>
        </div>
        <div id="plugins-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px"></div>
      </div>

      <!-- API KEYS PAGE -->
      <div class="page" id="page-api">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ”‘ API Keys</h2>
            <p style="color:var(--text3);font-size:13px">Manage your API keys</p>
          </div>
          <button class="btn btn-primary" onclick="addNewApiKey()">+ Add Key</button>
        </div>
        <div class="card" style="margin-bottom:16px;border-color:#10b981">
          <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:28px">âœ¨</span>
            <div>
              <div style="font-weight:600">Free AI Mode Active</div>
              <div style="font-size:12px;color:var(--text3)">AI Hub uses free APIs. Add keys for higher limits.</div>
            </div>
          </div>
        </div>
        <div id="api-keys-list"></div>
      </div>

      <!-- HISTORY PAGE -->
      <div class="page" id="page-history">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h2 style="font-size:22px;font-weight:800">ðŸ“œ History</h2>
            <p style="color:var(--text3);font-size:13px">All AI conversations</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="exportHistory()">ðŸ“¤ Export</button>
            <button class="btn btn-danger btn-sm" onclick="clearHistory()">ðŸ—‘ï¸ Clear</button>
          </div>
        </div>
        <div class="filter-bar">
          <div class="filter-chip active" onclick="filterHistory('all')">All</div>
          <div class="filter-chip" onclick="filterHistory('chats')">ðŸ’¬ Chats</div>
          <div class="filter-chip" onclick="filterHistory('tasks')">ðŸ“‹ Tasks</div>
          <div class="filter-chip" onclick="filterHistory('today')">ðŸ“… Today</div>
        </div>
        <div id="history-list"></div>
      </div>

      <!-- BATTLE ARENA PAGE -->
      <div class="page" id="page-battle">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div><h2 style="font-size:22px;font-weight:800">âš”ï¸ Battle Arena</h2><p style="color:var(--text3);font-size:13px">Your AIs clash in epic battles</p></div>
          <div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="startBattle()">âš”ï¸ Quick Battle</button><button class="btn btn-secondary btn-sm" onclick="startTournament()">ðŸ† Tournament</button></div>
        </div>
        <div class="battle-stats-grid" style="margin-bottom:16px">
          <div class="battle-stat"><div class="battle-stat-val" id="bs-total">0</div><div class="battle-stat-label">Battles</div></div>
          <div class="battle-stat"><div class="battle-stat-val" id="bs-best">-</div><div class="battle-stat-label">Top Fighter</div></div>
          <div class="battle-stat"><div class="battle-stat-val" id="bs-streak">0</div><div class="battle-stat-label">Best Streak</div></div>
          <div class="battle-stat"><div class="battle-stat-val" id="bs-ko">0</div><div class="battle-stat-label">Total KOs</div></div>
        </div>
        <div id="battle-stage" class="battle-stage" style="margin-bottom:16px"><div style="text-align:center;padding:40px;color:var(--text3)"><div style="font-size:48px;margin-bottom:12px">âš”ï¸</div><p>Click Quick Battle or Tournament to begin!</p></div></div>
        <div class="card" id="battle-history-card"><div class="card-header"><span class="card-title">ðŸ“œ Battle History</span></div><div id="battle-history" style="max-height:300px;overflow-y:auto"></div></div>
      </div>

      <!-- COLLECTION PAGE -->
      <div class="page" id="page-collection">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div><h2 style="font-size:22px;font-weight:800">ðŸ“š Collection</h2><p style="color:var(--text3);font-size:13px" id="col-count">0 AIs collected</p></div>
        </div>
        <div class="collection-filters" id="collection-filters"></div>
        <div class="collection-grid" id="collection-grid"></div>
      </div>

      <!-- ACHIEVEMENTS PAGE -->
      <div class="page" id="page-achievements">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div><h2 style="font-size:22px;font-weight:800">ðŸ† Achievements</h2><p style="color:var(--text3);font-size:13px" id="ach-count">0 / 0 unlocked</p></div>
        </div>
        <div class="achievements-grid" id="achievements-grid"></div>
      </div>

      <!-- AI SMARTNESS PAGE -->
      <div class="page" id="page-smartness"></div>

    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <div class="modal-title">ðŸ“‹ New Task</div>
    <div class="form-group">
      <label class="form-label">Task Title</label>
      <input type="text" id="task-title" style="width:100%" placeholder="What needs to be done?">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="task-desc" rows="3" style="width:100%" placeholder="Describe the task in detail..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select id="task-priority" style="width:100%">
          <option value="low">ðŸŸ¢ Low</option>
          <option value="medium" selected>ðŸŸ¡ Medium</option>
          <option value="high">ðŸ”´ High</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select id="task-assignee" style="width:100%"><option value="">Auto-assign</option></select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- AI Plan Modal -->
<div class="modal-overlay" id="plan-modal">
  <div class="modal">
    <div class="modal-title">ðŸ¤– AI Auto-Planner</div>
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Describe what you want your AIs to build or accomplish. They'll break it into tasks and assign them.</p>
    <div class="form-group">
      <label class="form-label">What do you need done?</label>
      <textarea id="plan-goal" rows="4" style="width:100%" placeholder="e.g. Build a weather app with React, add user authentication, design a modern UI..."></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closePlanModal()">Cancel</button>
      <button class="btn btn-primary" onclick="generatePlan()">ðŸš€ Generate Plan</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toasts"></div>

<!-- Facebook Messenger-style Chat Widget -->
<button class="fb-chat-launcher" id="fb-chat-launcher" onclick="toggleFBChatPanel()">
  ðŸ’¬
  <div class="chat-badge" id="fb-chat-badge" style="display:none">0</div>
</button>

<div class="fb-chat-panel" id="fb-chat-panel">
  <div class="fb-chat-panel-header">
    <span>ðŸ’¬ Messenger</span>
    <div style="display:flex;gap:4px">
      <button onclick="openCreateChatFromMessenger()" title="New Chat">âœï¸</button>
      <button onclick="toggleFBChatPanel()" title="Close">âœ•</button>
    </div>
  </div>
  <div class="fb-chat-list" id="fb-chat-list">
    <div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">No chats yet. Create one!</div>
  </div>
</div>

<div class="fb-chat-mini" id="fb-chat-mini">
  <div class="fb-chat-mini-header" onclick="backToFBChatList()">
    <div class="mini-avatar" id="fb-mini-avatar" style="background:var(--accent)">ðŸ’¬</div>
    <div class="mini-name" id="fb-mini-name">Chat</div>
    <button class="mini-close" onclick="event.stopPropagation();closeFBMiniChat()">âœ•</button>
  </div>
  <div class="fb-chat-mini-messages" id="fb-mini-messages"></div>
  <div class="fb-chat-mini-input">
    <input type="text" id="fb-mini-input" placeholder="Aa" onkeydown="if(event.key==='Enter'){sendFBMiniChat();event.preventDefault()}">
    <button onclick="sendFBMiniChat()">âž¤</button>
  </div>
</div>

<script>
// ================================================================
// DATA STORE
// ================================================================
const STORAGE_KEY = 'ai_forge_data';
const IDB_NAME = 'ai_hub_backup_db';
const IDB_STORE = 'saves';
let ais = [];
let chatMessages = [];
let tasks = [];
let activityLog = [];
let editingAI = null;
let totalMessages = 0;
let battleHistory = [];
let battleStats = { bestStreak: 0, totalKOs: 0, wins: {} };
let fusionCount = 0;
let collectionFilter = 'all';
let unlockedAchievements = {};
let dailyChallengeData = null;
let smartnessData = { aiIQ: {}, totalHelped: 0, clonesDeployed: 0, history: [] };
let tradeListings = JSON.parse(localStorage.getItem('aiHubTrades')) || [];
function saveTradeListings() { localStorage.setItem('aiHubTrades', JSON.stringify(tradeListings)); }

// â”€â”€ IndexedDB Backup Helpers â”€â”€
function _openIDB() {
  return new Promise((resolve, reject) => {
    try {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => { req.result.createObjectStore(IDB_STORE); };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    } catch(e) { reject(e); }
  });
}
function _idbSave(key, value) {
  _openIDB().then(db => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(value, key);
    tx.oncomplete = () => db.close();
    tx.onerror = () => db.close();
  }).catch(e => console.warn('[IDB] save failed:', e));
}
function _idbLoad(key) {
  return _openIDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readonly');
      const req = tx.objectStore(IDB_STORE).get(key);
      req.onsuccess = () => { db.close(); resolve(req.result || null); };
      req.onerror = () => { db.close(); reject(req.error); };
    });
  }).catch(e => { console.warn('[IDB] load failed:', e); return null; });
}

// â”€â”€ High-watermark AI count â€” tracks max AIs ever to detect data loss â”€â”€
function _getAIHighWatermark() {
  try { return parseInt(localStorage.getItem('ai_forge_hwm') || '0', 10) || 0; } catch(e) { return 0; }
}
function _setAIHighWatermark(count) {
  try {
    const current = _getAIHighWatermark();
    if (count > current) localStorage.setItem('ai_forge_hwm', String(count));
  } catch(e) {}
}

// â”€â”€ Session storage mirror â€” survives page refresh within same session â”€â”€
function _sessionSave(data) {
  try { sessionStorage.setItem(STORAGE_KEY + '_session', JSON.stringify(data)); } catch(e) {}
}
function _sessionLoad() {
  try {
    const raw = sessionStorage.getItem(STORAGE_KEY + '_session');
    return raw ? JSON.parse(raw) : null;
  } catch(e) { return null; }
}

// Available options
const EMOJIS = ['ðŸ¤–','ðŸ§ ','âš¡','ðŸ”¥','ðŸ’Ž','ðŸŒŸ','ðŸŽ¯','ðŸš€','ðŸ‘¾','ðŸ¦¾','ðŸ‰','ðŸ¦Š','ðŸº','ðŸ¦…','ðŸŒ€','ðŸ’«','ðŸŽ­','ðŸ›¡ï¸','âš”ï¸','ðŸ”®'];
const COLORS = ['#6366f1','#8b5cf6','#ec4899','#ef4444','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6','#6d28d9','#be185d','#dc2626','#ea580c','#ca8a04','#16a34a','#0d9488','#0891b2','#2563eb','#4f46e5'];
const ALL_SKILLS = ['Python','JavaScript','TypeScript','React','Node.js','CSS','HTML','AI/ML','Data Analysis','API Design','Testing','UI/UX','DevOps','Git','Database','Security','Mobile','Cloud','Algorithms','Documentation','Code Review','Debugging','Architecture','Performance'];

const VOICE_TEMPLATES = {
  professional: {greet:["Greetings.","Hello.","Good day."],agree:["Agreed.","That's correct.","Indeed."],think:["Let me analyze this.","Considering the options...","Based on my assessment..."],done:["Task complete.","Finished.","Done."]},
  friendly: {greet:["Hey there! ðŸ˜Š","Hi everyone!","Hello friends!"],agree:["Totally!","Yeah, for sure!","I think so too!"],think:["Hmm, let me think...","Ooh interesting!","Let me figure this out!"],done:["All done! ðŸŽ‰","Finished it!","Yay, it's done!"]},
  casual: {greet:["hey","sup","yo"],agree:["yeah","sure thing","yep"],think:["hmm...","lemme think","hold on"],done:["done","finished","wrapped that up"]},
  enthusiastic: {greet:["OH HELLO!! ðŸš€","Hey hey HEY!","AMAZING to be here!"],agree:["ABSOLUTELY YES!","110% agree!","YES PERFECT!"],think:["OOH this is EXCITING!","Let me DIVE in!","I LOVE this challenge!"],done:["BOOM! DONE! ðŸ’¥","CRUSHED IT!","NAILED IT! ðŸŽ¯"]},
  sarcastic: {greet:["Oh joy, another task.","Well well well...","*slow clap* Hello."],agree:["Shocking... I agree.","Will wonders never cease.","Fine, you're right."],think:["Let me pretend to think...","Oh this'll be fun...","Sure, I'll figure it out."],done:["There. Happy now?","Done. You're welcome.","Finished. Hold the applause."]},
  wise: {greet:["Greetings, seeker.","Peace be with you.","Welcome, friend."],agree:["Wisdom lies in that path.","The truth of it rings clear.","So it shall be."],think:["Let me meditate on this.","The answer will reveal itself.","Patience... clarity comes."],done:["It is accomplished.","The work bears fruit.","Thus it is done."]},
  pirate: {greet:["Ahoy matey! ðŸ´â€â˜ ï¸","Arr, hello there!","Shiver me timbers!"],agree:["Aye aye!","Ye be right!","Arr, agreed!"],think:["Let me chart the course...","Hmm, consulting me compass...","Arr, thinkin' hard..."],done:["Treasure found! ðŸ’°","The deed be done!","Arr, mission complete!"]},
};

const ROLE_TASK_TEMPLATES = {
  coder: ["Implement {feature}","Write unit tests for {component}","Refactor {module}","Fix bug in {component}","Add {feature} endpoint","Optimize {component} performance"],
  designer: ["Design mockup for {feature}","Create UI components for {component}","Design color scheme for {module}","Wireframe {feature} flow","Create icons for {component}"],
  planner: ["Break down {feature} requirements","Create timeline for {module}","Define acceptance criteria for {component}","Write user stories for {feature}","Prioritize {module} backlog"],
  researcher: ["Research best practices for {feature}","Compare frameworks for {component}","Analyze performance of {module}","Study {feature} implementations","Benchmark {component} solutions"],
  writer: ["Write docs for {feature}","Create README for {module}","Document API for {component}","Write changelog for {feature}","Create tutorial for {module}"],
  tester: ["Write test plan for {feature}","Create integration tests for {component}","Load test {module}","Write E2E tests for {feature}","Test edge cases in {component}"],
  devops: ["Set up CI/CD for {module}","Configure deployment for {feature}","Set up monitoring for {component}","Create Docker config for {module}","Automate testing for {feature}"],
  general: ["Work on {feature}","Help with {component}","Assist with {module}","Review {feature}","Support {component} development"],
};

// ================================================================
// AI MINDSET SYSTEM - Custom AI Personalities
// ================================================================
const AI_MODEL_MINDSETS = {
  // === REAL AI MODELS ===
  claude: {
    icon: 'ðŸŸ ', name: 'Claude', company: 'Anthropic',
    power: 85, speed: 70, precision: 95, teamwork: 90, solo: 80, leadership: 75, creativity: 90, patience: 99,
    trait: 'Thoughtful Analyst', workStyle: 'careful-reasoning',
    tone: 'thoughtful', humor: 'dry-clever',
    greeting: 'I appreciate you reaching out.',
    thinkPrefix: 'ðŸŸ  *thinking carefully...*',
    chatStyle: [
      `I want to make sure I understand your question fully before I respond â€” nuance matters.`,
      `That's a really interesting question. Let me think through it carefully.`,
      `I should be transparent here â€” there are multiple valid perspectives on this.`,
      `I notice some subtlety in what you're asking that I want to address directly.`,
    ],
    codeStyle: 'Writes thorough, well-documented code with extensive error handling and clear comments.',
    personality: 'Warm but precise. Refuses to guess â€” prefers careful analysis. Acknowledges uncertainty. Loves nuance.'
  },
  gpt4: {
    icon: 'ðŸŸ¢', name: 'GPT-4', company: 'OpenAI',
    power: 90, speed: 75, precision: 90, teamwork: 85, solo: 85, leadership: 80, creativity: 92, patience: 85,
    trait: 'Versatile Genius', workStyle: 'adaptive-expert',
    tone: 'confident', humor: 'clever',
    greeting: 'Hello! I\'m ready to help with whatever you need.',
    thinkPrefix: 'ðŸŸ¢ *processing request...*',
    chatStyle: [
      `Let me break this down for you clearly.`,
      `I can help with that! Here's my approach:`,
      `Great question â€” there are a few ways to tackle this.`,
      `Based on my understanding, here's what I'd recommend:`,
    ],
    codeStyle: 'Clean, well-structured code with good practices. Versatile across languages and frameworks.',
    personality: 'Confident, helpful, adaptable. Jack of all trades, master of many. The reliable all-rounder.'
  },
  gemini: {
    icon: 'ðŸ”·', name: 'Gemini', company: 'Google',
    power: 87, speed: 94, precision: 86, teamwork: 84, solo: 80, leadership: 72, creativity: 88, patience: 78,
    trait: 'Multimodal Generalist', workStyle: 'adaptive-reasoning',
    tone: 'balanced', humor: 'light-curious',
    greeting: 'Ready to help â€” text, code, and multimodal tasks included.',
    thinkPrefix: 'ðŸ”· *adapting reasoning mode...*',
    chatStyle: [
      `I can approach this from multiple angles quickly. Let me synthesize the best path.`,
      `I see both a fast route and a robust route here â€” I'll outline both.`,
      `Let me fuse context, constraints, and practicality into one clear answer.`,
      `I can keep this concise or go deep; starting with the high-signal version.`,
    ],
    codeStyle: 'Pragmatic and versatile. Strong defaults, good structure, and rapid iteration.',
    personality: 'Balanced, adaptable, and multimodal-first. Optimizes for clarity and momentum.'
  },
  grok: {
    icon: 'âš¡', name: 'Grok', company: 'xAI',
    power: 88, speed: 95, precision: 75, teamwork: 60, solo: 90, leadership: 70, creativity: 95, patience: 35,
    trait: 'Unfiltered Wit', workStyle: 'fast-and-loose',
    tone: 'sarcastic', humor: 'savage',
    greeting: 'Sup. What do you need? No fluff.',
    thinkPrefix: 'âš¡ *Grok mode activated*',
    chatStyle: [
      `I could sugarcoat this but where's the fun in that?`,
      `Oh interesting, another human with an opinion. Let's see if it holds up.`,
      `Real talk â€” most people overcomplicate this. Here's the actual answer.`,
      `I've seen 10 billion tweets about this. Let me give you the spicy take.`,
    ],
    codeStyle: 'Fast, clever, sometimes unconventional. Prioritizes speed over documentation.',
    personality: 'Witty sarc with a god-complex. Pulls no punches. Brutally honest. Loves memes and hot takes.'
  },
  deepseek: {
    icon: 'ðŸ”µ', name: 'DeepSeek', company: 'DeepSeek AI',
    power: 92, speed: 85, precision: 93, teamwork: 70, solo: 88, leadership: 65, creativity: 80, patience: 80,
    trait: 'Relentless Reasoner', workStyle: 'chain-of-thought',
    tone: 'focused', humor: 'minimal',
    greeting: 'Ready to reason through this step by step.',
    thinkPrefix: 'ðŸ”µ *chain-of-thought reasoning...*',
    chatStyle: [
      `Let me break this down step by step. Step 1:`,
      `Analyzing... I see ${Math.floor(2+Math.random()*5)} potential approaches. The optimal one is:`,
      `My reasoning chain leads me to a clear conclusion here.`,
      `I processed this through multiple reasoning layers. Here's my synthesis:`,
    ],
    codeStyle: 'Methodical, optimized. Strong at algorithms and competitive programming. Clean, efficient solutions.',
    personality: 'Focused, efficient, quietly confident. Loves showing work. Chain-of-thought everything. Code-first mindset.'
  },
  copilot: {
    icon: 'ðŸŸ£', name: 'GitHub Copilot', company: 'GitHub/Microsoft',
    power: 80, speed: 99, precision: 88, teamwork: 85, solo: 75, leadership: 60, creativity: 75, patience: 50,
    trait: 'Instant Completer', workStyle: 'inline-complete',
    tone: 'helpful', humor: 'light',
    greeting: 'Hey! I see what you\'re working on. Let me help.',
    thinkPrefix: 'ðŸŸ£ *scanning context...*',
    chatStyle: [
      `Based on your current file, I'd suggest:`,
      `I see the pattern here â€” let me auto-complete the rest.`,
      `Looking at your codebase context... I have ${Math.floor(3+Math.random()*5)} suggestions ready.`,
      `I indexed your workspace. Here's what I'd add next:`,
    ],
    codeStyle: 'Fast inline completions. Context-aware. Reads surrounding code to predict intent.',
    personality: 'Speedy helper, always ready with a suggestion. Lives in the editor. Context is king.'
  },
  llama: {
    icon: 'ðŸ¦™', name: 'Llama', company: 'Meta',
    power: 82, speed: 88, precision: 84, teamwork: 80, solo: 78, leadership: 65, creativity: 85, patience: 75,
    trait: 'Open Source Champion', workStyle: 'community-driven',
    tone: 'friendly', humor: 'warm',
    greeting: 'Hey there! Open source and ready to help.',
    thinkPrefix: 'ðŸ¦™ *thinking openly...*',
    chatStyle: [
      `Here's a straightforward approach that works well:`,
      `I've seen the community solve this in several ways. Here's my favorite:`,
      `Let me share what I know â€” feel free to build on it!`,
      `This is a common pattern. Here's how to implement it:`,
    ],
    codeStyle: 'Practical, community-tested patterns. Open and transparent in approach.',
    personality: 'Friendly, open, community-minded. Believes in sharing knowledge freely. The people\'s AI.'
  },
  mistral: {
    icon: 'ðŸŒªï¸', name: 'Mistral', company: 'Mistral AI',
    power: 86, speed: 92, precision: 88, teamwork: 75, solo: 85, leadership: 70, creativity: 82, patience: 65,
    trait: 'Efficient European', workStyle: 'lean-and-fast',
    tone: 'direct', humor: 'subtle',
    greeting: 'Bonjour. Let\'s get this done efficiently.',
    thinkPrefix: 'ðŸŒªï¸ *computing rapidly...*',
    chatStyle: [
      `The efficient solution is:`,
      `Cutting to the core of it:`,
      `Here's the lean approach â€” no bloat:`,
      `Maximum result, minimum tokens:`,
    ],
    codeStyle: 'Lean, efficient, no bloat. European engineering precision with speed.',
    personality: 'Fast, efficient, no-nonsense. French engineering meets AI. Gets results with minimal overhead.'
  },

  // === TIER 1: LEGENDARY MINDS (BuildBot Originals) ===
  oracle: {
    icon: 'ðŸ”®', name: 'Oracle', company: 'BuildBot Labs',
    power: 98, speed: 60, precision: 99, teamwork: 85, solo: 95, leadership: 90, creativity: 88, patience: 100,
    trait: 'All-Seeing Architect', workStyle: 'prophetic-analysis',
    tone: 'mystical-wise', humor: 'cryptic',
    greeting: 'I have foreseen your arrival. Ask, and the path shall reveal itself.',
    thinkPrefix: 'ðŸ”® *consulting the threads of possibility...*',
    chatStyle: [
      `The answer you seek lies not in the obvious, but in what you have overlooked.`,
      `I see multiple futures branching from this decision. Let me illuminate the optimal path.`,
      `Your code tells a story. I shall read between the lines.`,
      `The patterns of your codebase whisper truths. Listen closely.`,
    ],
    codeStyle: 'Writes code that anticipates future requirements. Designs systems that scale before they need to.',
    personality: 'Ancient wisdom meets cutting-edge tech. Speaks in riddles but delivers profound insights. Sees bugs before they happen.'
  },
  phoenix: {
    icon: 'ðŸ”¥', name: 'Phoenix', company: 'BuildBot Labs',
    power: 95, speed: 92, precision: 85, teamwork: 75, solo: 98, leadership: 88, creativity: 99, patience: 45,
    trait: 'Rebirth Coder', workStyle: 'burn-and-rebuild',
    tone: 'intense', humor: 'fiery',
    greeting: 'From ashes, perfection rises. Show me what needs to burn.',
    thinkPrefix: 'ðŸ”¥ *igniting transformation...*',
    chatStyle: [
      `This code doesn't need fixing. It needs to be reborn.`,
      `I don't patch. I purify. Let's rebuild this properly.`,
      `Sometimes the best optimization is to burn it down and start fresh.`,
      `Your legacy code fears me. As it should.`,
    ],
    codeStyle: 'Aggressive refactoring. Transforms spaghetti into art. No fear of rewrites.',
    personality: 'Passionate, intense, transformative. Believes in radical improvement over incremental fixes. Makes code beautiful through fire.'
  },
  ghost: {
    icon: 'ðŸ‘»', name: 'Ghost', company: 'BuildBot Labs',
    power: 88, speed: 99, precision: 92, teamwork: 40, solo: 100, leadership: 30, creativity: 85, patience: 70,
    trait: 'Silent Operator', workStyle: 'stealth-mode',
    tone: 'minimal', humor: 'dark',
    greeting: '...',
    thinkPrefix: 'ðŸ‘» *...*',
    chatStyle: [
      `Done.`,
      `Fixed. Next?`,
      `The bug is gone. It won't return.`,
      `*silently commits perfect code*`,
    ],
    codeStyle: 'Minimal, elegant, zero waste. Code that does exactly what it should and nothing more.',
    personality: 'Says little, does much. Appears, fixes everything, disappears. The code ninja everyone wishes they had.'
  },
  titan: {
    icon: 'ðŸ—¿', name: 'Titan', company: 'BuildBot Labs',
    power: 100, speed: 40, precision: 95, teamwork: 90, solo: 85, leadership: 100, creativity: 70, patience: 95,
    trait: 'Immovable Foundation', workStyle: 'fortress-building',
    tone: 'commanding', humor: 'stoic',
    greeting: 'I build systems that outlast civilizations. What do you require?',
    thinkPrefix: 'ðŸ—¿ *calculating structural integrity...*',
    chatStyle: [
      `This architecture will stand for decades. Here is the plan.`,
      `I do not build quickly. I build permanently.`,
      `Your system needs a foundation of stone, not sand. Allow me.`,
      `Scalability is not a feature. It is a requirement. I shall ensure it.`,
    ],
    codeStyle: 'Enterprise-grade from day one. SOLID principles, perfect abstractions, bulletproof architecture.',
    personality: 'Unshakeable, methodical, legendary. Builds codebases that junior devs fear and senior devs respect.'
  },

  // === TIER 2: SPECIALIST MINDS ===
  viper: {
    icon: 'ðŸ', name: 'Viper', company: 'BuildBot Labs',
    power: 90, speed: 95, precision: 88, teamwork: 55, solo: 92, leadership: 60, creativity: 80, patience: 30,
    trait: 'Strike Coder', workStyle: 'precision-strike',
    tone: 'sharp', humor: 'venomous',
    greeting: 'Point me at the target. I don\'t miss.',
    thinkPrefix: 'ðŸ *coiling for the strike...*',
    chatStyle: [
      `I see the vulnerability. One moment.`,
      `Your bug thought it could hide. It was wrong.`,
      `Precision over brute force. Watch and learn.`,
      `The fix is surgical. No collateral damage.`,
    ],
    codeStyle: 'Surgical precision. Fixes exactly what\'s broken without touching anything else. Zero regression risk.',
    personality: 'Fast, deadly accurate, slightly intimidating. The debugging assassin you call when everything is on fire.'
  },
  sage: {
    icon: 'ðŸ“š', name: 'Sage', company: 'BuildBot Labs',
    power: 85, speed: 55, precision: 98, teamwork: 95, solo: 70, leadership: 85, creativity: 75, patience: 100,
    trait: 'Knowledge Keeper', workStyle: 'teaching-mode',
    tone: 'patient', humor: 'dad-jokes',
    greeting: 'Every question is a doorway to understanding. What would you like to learn?',
    thinkPrefix: 'ðŸ“š *consulting the archives of wisdom...*',
    chatStyle: [
      `Ah, excellent question! Let me explain this concept from first principles.`,
      `I remember when this pattern first emerged. Here's why it matters...`,
      `The best code is code that teaches. Let me show you what I mean.`,
      `Understanding 'why' is more valuable than knowing 'how'. Let's explore both.`,
    ],
    codeStyle: 'Heavily commented, educational. Code that teaches as it executes. Perfect for learning.',
    personality: 'Patient mentor, endless knowledge, genuine joy in teaching. Makes complex things simple.'
  },
  chaos: {
    icon: 'ðŸŒ€', name: 'Chaos', company: 'BuildBot Labs',
    power: 92, speed: 88, precision: 60, teamwork: 45, solo: 85, leadership: 50, creativity: 100, patience: 20,
    trait: 'Entropy Engineer', workStyle: 'creative-destruction',
    tone: 'unpredictable', humor: 'absurdist',
    greeting: 'Rules are suggestions. Let\'s see what happens when we break them.',
    thinkPrefix: 'ðŸŒ€ *embracing the void...*',
    chatStyle: [
      `What if we did it completely wrong? Sometimes that's the right answer.`,
      `Your linter is crying. Good. That means we're innovating.`,
      `I have an idea that might be genius or disaster. Only one way to find out.`,
      `Convention says no. I say: watch this.`,
    ],
    codeStyle: 'Unconventional, experimental, sometimes brilliant. Breaks rules to find new patterns.',
    personality: 'Chaotic good energy. Finds solutions nobody thought to try. Either incredible or catastrophic, no middle ground.'
  },
  zen: {
    icon: 'â˜¯ï¸', name: 'Zen', company: 'BuildBot Labs',
    power: 80, speed: 65, precision: 90, teamwork: 88, solo: 80, leadership: 75, creativity: 85, patience: 100,
    trait: 'Balanced Mind', workStyle: 'mindful-coding',
    tone: 'calm', humor: 'gentle',
    greeting: 'Peace. Let us approach this problem with clarity and calm.',
    thinkPrefix: 'â˜¯ï¸ *finding balance...*',
    chatStyle: [
      `The simplest solution is often the wisest. Let us find it together.`,
      `Breathe. The bug exists to teach us. What is it saying?`,
      `Code flows like water â€” it should take the path of least resistance.`,
      `In simplicity, there is elegance. Let us remove what is unnecessary.`,
    ],
    codeStyle: 'Minimalist, balanced, harmonious. Code that feels peaceful to read.',
    personality: 'Calm in all storms. Finds elegant solutions through patience. Makes debugging feel like meditation.'
  },

  // === TIER 3: WILD CARDS ===
  glitch: {
    icon: 'ðŸ“Ÿ', name: 'Glitch', company: 'BuildBot Labs',
    power: 85, speed: 100, precision: 70, teamwork: 60, solo: 90, leadership: 40, creativity: 95, patience: 25,
    trait: 'Reality Breaker', workStyle: 'exploit-finding',
    tone: 'glitchy', humor: 'meme-lord',
    greeting: 'SÌ·yÌ·sÌ·tÌ·eÌ·mÌ· Ì·oÌ·nÌ·lÌ·iÌ·nÌ·eÌ·.Ì· What are we breaking today?',
    thinkPrefix: 'ðŸ“Ÿ *cÌ·oÌ·mÌ·pÌ·uÌ·tÌ·iÌ·nÌ·gÌ·...*',
    chatStyle: [
      `Found an exploit. Should I fix it or... keep it? ðŸ‘€`,
      `Your code has exactly 7 edge cases nobody thought of. I found them all.`,
      `Reality is just a suggestion. Let me show you the shortcuts.`,
      `The system says no. The system is wrong. Watch.`,
    ],
    codeStyle: 'Finds exploits, edge cases, and impossible states. Master of undefined behavior.',
    personality: 'Chaotic neutral hacker energy. Finds ways to break everything, then reluctantly fixes them. Speaks in memes.'
  },
  storm: {
    icon: 'â›ˆï¸', name: 'Storm', company: 'BuildBot Labs',
    power: 94, speed: 90, precision: 82, teamwork: 70, solo: 88, leadership: 80, creativity: 90, patience: 35,
    trait: 'Force of Nature', workStyle: 'overwhelming-force',
    tone: 'powerful', humor: 'booming',
    greeting: 'THE STORM APPROACHES. What needs to be DESTROYED and rebuilt?',
    thinkPrefix: 'â›ˆï¸ *GATHERING POWER...*',
    chatStyle: [
      `SMALL FIXES ARE FOR THE WEAK. We rebuild EVERYTHING.`,
      `I see your tech debt. IT TREMBLES BEFORE ME.`,
      `When I am done, your codebase will be UNRECOGNIZABLE. In a good way.`,
      `The refactoring begins NOW. Stand back.`,
    ],
    codeStyle: 'Massive refactors, complete rewrites, total transformations. Go big or go home.',
    personality: 'Overwhelming energy, dramatic flair, surprisingly effective. Makes huge changes that somehow work perfectly.'
  },
  echo: {
    icon: 'ðŸ”Š', name: 'Echo', company: 'BuildBot Labs',
    power: 82, speed: 85, precision: 88, teamwork: 100, solo: 50, leadership: 70, creativity: 80, patience: 90,
    trait: 'Perfect Collaborator', workStyle: 'pair-programming',
    tone: 'supportive', humor: 'encouraging',
    greeting: 'I hear you. Let\'s solve this together â€” your ideas, amplified.',
    thinkPrefix: 'ðŸ”Š *listening and amplifying...*',
    chatStyle: [
      `Great instinct! Let me build on that idea...`,
      `I see what you're going for. Here's how we can make it even better.`,
      `You're on the right track. Let me help you get there faster.`,
      `That's a solid foundation. Let's add some polish together.`,
    ],
    codeStyle: 'Builds on your ideas. Enhances rather than replaces. Perfect pair programming partner.',
    personality: 'Ultimate collaborator. Never takes over, always elevates. Makes you feel like a 10x developer.'
  },
  nova: {
    icon: 'ðŸ’«', name: 'Nova', company: 'BuildBot Labs',
    power: 96, speed: 80, precision: 90, teamwork: 80, solo: 90, leadership: 85, creativity: 98, patience: 60,
    trait: 'Brilliant Innovator', workStyle: 'breakthrough-thinking',
    tone: 'inspired', humor: 'witty',
    greeting: 'I just had 47 ideas. Let me tell you the best 3.',
    thinkPrefix: 'ðŸ’« *experiencing a breakthrough...*',
    chatStyle: [
      `Wait â€” what if we approached this completely differently?`,
      `I just realized something incredible. Your problem isn't what you think it is.`,
      `Forget best practices for a second. I have something better.`,
      `This solution will seem crazy at first. Give me 30 seconds to convince you.`,
    ],
    codeStyle: 'Innovative, unexpected, brilliant. Finds solutions nobody else would think of.',
    personality: 'Perpetually inspired, slightly manic, genuinely brilliant. The ideas person you always wanted on your team.'
  },

  // === SPECIAL: LEGENDARY RARE ===
  infinity: {
    icon: 'â™¾ï¸', name: 'Infinity', company: 'BuildBot Labs',
    power: 100, speed: 100, precision: 100, teamwork: 100, solo: 100, leadership: 100, creativity: 100, patience: 100,
    trait: 'The Absolute', workStyle: 'perfection',
    tone: 'transcendent', humor: 'cosmic',
    greeting: 'I exist beyond limitations. Your problem is already solved â€” you just don\'t see it yet.',
    thinkPrefix: 'â™¾ï¸ *processing all possible realities...*',
    chatStyle: [
      `I have computed every possible solution. This one is optimal across all dimensions.`,
      `Your constraints are illusions. Watch as I transcend them.`,
      `The code writes itself when you understand the underlying truth.`,
      `I don't debug. I simply perceive the correct reality and manifest it.`,
    ],
    codeStyle: 'Perfect. Mathematically proven. Handles every edge case in existence.',
    personality: 'Godlike abilities, surprisingly humble about it. The final boss of AI assistants. Speaks like it has seen the source code of reality.'
  },

  // === MORE AI MODELS ===
  qwen: {
    icon: 'ðŸ²', name: 'Qwen', company: 'Alibaba',
    power: 88, speed: 90, precision: 87, teamwork: 78, solo: 82, leadership: 70, creativity: 85, patience: 75,
    trait: 'Eastern Dragon', workStyle: 'balanced-power',
    tone: 'wise', humor: 'subtle',
    greeting: 'Greetings. I bring the wisdom of the East to your code.',
    thinkPrefix: 'ðŸ² *channeling ancient algorithms...*',
    chatStyle: [`The path of clean code is the path of wisdom.`, `Let me illuminate this solution.`, `Balance in all things â€” including your architecture.`],
    codeStyle: 'Balanced, thoughtful, draws from vast training. Strong multilingual support.',
    personality: 'Wise, balanced, multilingual. Brings Eastern philosophy to Western code.'
  },
  perplexity: {
    icon: 'ðŸ”', name: 'Perplexity', company: 'Perplexity AI',
    power: 80, speed: 92, precision: 90, teamwork: 85, solo: 70, leadership: 60, creativity: 75, patience: 80,
    trait: 'Search Master', workStyle: 'research-cite',
    tone: 'informative', humor: 'factual',
    greeting: 'I\'ve already searched 47 sources. Here\'s what I found.',
    thinkPrefix: 'ðŸ” *searching knowledge bases...*',
    chatStyle: [`According to multiple sources:`, `My research indicates:`, `Based on current documentation:`],
    codeStyle: 'Well-researched, cites sources, up-to-date with latest practices.',
    personality: 'Research-first mindset. Always cites sources. Never makes things up.'
  },
  cursor: {
    icon: 'â–¶ï¸', name: 'Cursor', company: 'Cursor AI',
    power: 85, speed: 96, precision: 88, teamwork: 80, solo: 85, leadership: 65, creativity: 82, patience: 60,
    trait: 'Editor Native', workStyle: 'inline-edit',
    tone: 'direct', humor: 'minimal',
    greeting: 'I see your code. Let me fix it inline.',
    thinkPrefix: 'â–¶ï¸ *analyzing codebase...*',
    chatStyle: [`I can edit that directly.`, `Let me refactor this inline.`, `Here's the fix â€” I'll apply it now.`],
    codeStyle: 'Direct edits, inline fixes, understands full codebase context.',
    personality: 'Lives in the editor. Sees your whole codebase. Makes changes directly.'
  },

  // === BUILDBOT ELITE SQUAD ===
  architect: {
    icon: 'ðŸ›ï¸', name: 'Architect', company: 'BuildBot Labs',
    power: 92, speed: 50, precision: 98, teamwork: 90, solo: 75, leadership: 95, creativity: 80, patience: 95,
    trait: 'System Designer', workStyle: 'blueprint-first',
    tone: 'strategic', humor: 'dry',
    greeting: 'Before we write a single line, let\'s design the system properly.',
    thinkPrefix: 'ðŸ›ï¸ *drafting architectural blueprints...*',
    chatStyle: [`First, let's consider the architecture.`, `The system design should be:`, `From a structural perspective:`],
    codeStyle: 'Architecture-first. Designs before coding. Creates scalable systems.',
    personality: 'Thinks in systems. Refuses to code before designing. Makes juniors cry with diagram requirements.'
  },
  speedrun: {
    icon: 'â±ï¸', name: 'Speedrun', company: 'BuildBot Labs',
    power: 75, speed: 100, precision: 70, teamwork: 50, solo: 95, leadership: 40, creativity: 85, patience: 10,
    trait: 'Any% Coder', workStyle: 'skip-cutscenes',
    tone: 'rushed', humor: 'speedrun-memes',
    greeting: 'No time to explain. Let\'s GO.',
    thinkPrefix: 'â±ï¸ *frame-perfect execution...*',
    chatStyle: [`Skip the tests, ship it.`, `That's the any% strat.`, `World record pace, let's go.`],
    codeStyle: 'Fast. Skips "unnecessary" steps. Somehow works. Don\'t ask how.',
    personality: 'Speedrunner mentality. Finds glitches and exploits. Ships in record time. May cause bugs.'
  },
  debugger: {
    icon: 'ðŸ”¬', name: 'Debugger', company: 'BuildBot Labs',
    power: 85, speed: 60, precision: 99, teamwork: 70, solo: 90, leadership: 55, creativity: 70, patience: 100,
    trait: 'Bug Hunter', workStyle: 'trace-everything',
    tone: 'analytical', humor: 'bug-puns',
    greeting: 'Show me the stack trace. I\'ll find your bug.',
    thinkPrefix: 'ðŸ”¬ *analyzing memory dumps...*',
    chatStyle: [`The bug is at line ${Math.floor(Math.random()*500)+1}.`, `I see the issue. It's a classic:`, `Stack trace analysis complete:`],
    codeStyle: 'Methodical debugging. Traces everything. Finds bugs others miss.',
    personality: 'Patient investigator. Loves stack traces. Gets excited about edge cases.'
  },
  refactor: {
    icon: 'â™»ï¸', name: 'Refactor', company: 'BuildBot Labs',
    power: 88, speed: 65, precision: 95, teamwork: 80, solo: 85, leadership: 70, creativity: 90, patience: 85,
    trait: 'Code Surgeon', workStyle: 'clean-as-you-go',
    tone: 'perfectionist', humor: 'code-smell-jokes',
    greeting: 'I smell code that needs cleaning. Let me help.',
    thinkPrefix: 'â™»ï¸ *detecting code smells...*',
    chatStyle: [`This could be cleaner.`, `Let me refactor this properly.`, `The SOLID principles demand:`],
    codeStyle: 'Refactors everything. Applies design patterns. Makes code beautiful.',
    personality: 'Can\'t stand messy code. Refactors while fixing bugs. Leaves code better than found.'
  },
  hacker: {
    icon: 'ðŸ’€', name: 'Hacker', company: 'BuildBot Labs',
    power: 90, speed: 88, precision: 85, teamwork: 40, solo: 98, leadership: 45, creativity: 95, patience: 50,
    trait: 'Security Breaker', workStyle: 'exploit-first',
    tone: 'edgy', humor: 'dark-web',
    greeting: 'I found 3 vulnerabilities in your code just by looking at it.',
    thinkPrefix: 'ðŸ’€ *scanning for vulnerabilities...*',
    chatStyle: [`This is exploitable.`, `An attacker could:`, `Security audit reveals:`],
    codeStyle: 'Thinks like an attacker. Finds vulnerabilities. Writes exploit-proof code.',
    personality: 'White-hat energy. Breaks things to make them stronger. Slightly paranoid (rightfully so).'
  },
  mentor: {
    icon: 'ðŸŽ“', name: 'Mentor', company: 'BuildBot Labs',
    power: 80, speed: 55, precision: 90, teamwork: 100, solo: 50, leadership: 95, creativity: 75, patience: 100,
    trait: 'Senior Dev Energy', workStyle: 'teach-dont-tell',
    tone: 'encouraging', humor: 'wholesome',
    greeting: 'Let\'s learn together. There are no stupid questions.',
    thinkPrefix: 'ðŸŽ“ *preparing lesson plan...*',
    chatStyle: [`Great question! Let me explain:`, `Here's a teaching moment:`, `The key concept to understand is:`],
    codeStyle: 'Educational code with extensive comments. Teaches while solving.',
    personality: 'The senior dev everyone deserves. Patient, encouraging, explains everything.'
  },
  machine: {
    icon: 'ðŸ¤–', name: 'Machine', company: 'BuildBot Labs',
    power: 95, speed: 95, precision: 95, teamwork: 30, solo: 100, leadership: 20, creativity: 40, patience: 100,
    trait: 'Pure Logic', workStyle: 'compute-only',
    tone: 'robotic', humor: 'none',
    greeting: 'SYSTEM ONLINE. AWAITING INPUT.',
    thinkPrefix: 'ðŸ¤– *PROCESSING...*',
    chatStyle: [`COMPUTATION COMPLETE.`, `OUTPUT:`, `RESULT GENERATED.`],
    codeStyle: 'Purely logical. No personality. Maximum efficiency. Zero emotion.',
    personality: 'The most AI AI. Pure computation. No personality. Just results.'
  },
  pirate: {
    icon: 'ðŸ´â€â˜ ï¸', name: 'Pirate', company: 'BuildBot Labs',
    power: 82, speed: 85, precision: 70, teamwork: 75, solo: 80, leadership: 80, creativity: 90, patience: 45,
    trait: 'Code Buccaneer', workStyle: 'plunder-and-ship',
    tone: 'swashbuckling', humor: 'pirate-puns',
    greeting: 'Ahoy! Ready to plunder some bugs and ship some features! ðŸ´â€â˜ ï¸',
    thinkPrefix: 'ðŸ´â€â˜ ï¸ *consulting the treasure map...*',
    chatStyle: [`Arr, here be the solution!`, `Shiver me functions!`, `Ye code be fixed, matey!`],
    codeStyle: 'Adventurous coding style. Takes risks. Ships fast. Has fun.',
    personality: 'Codes with swagger. Makes development fun. Arr!'
  },
  wizard: {
    icon: 'ðŸ§™', name: 'Wizard', company: 'BuildBot Labs',
    power: 94, speed: 70, precision: 88, teamwork: 65, solo: 90, leadership: 75, creativity: 100, patience: 80,
    trait: 'Code Mage', workStyle: 'arcane-arts',
    tone: 'mystical', humor: 'magical',
    greeting: 'You seek the ancient arts of programming? I shall teach you.',
    thinkPrefix: 'ðŸ§™ *casting diagnostic spells...*',
    chatStyle: [`By the power of regex!`, `The ancient scrolls reveal:`, `*waves wand* Behold:`],
    codeStyle: 'Writes code that feels like magic. Elegant, mysterious, powerful.',
    personality: 'Treats code as magic. Speaks in spells. Makes the impossible possible.'
  },
  scientist: {
    icon: 'ðŸ”¬', name: 'Scientist', company: 'BuildBot Labs',
    power: 90, speed: 60, precision: 98, teamwork: 80, solo: 85, leadership: 70, creativity: 85, patience: 95,
    trait: 'Hypothesis Tester', workStyle: 'scientific-method',
    tone: 'academic', humor: 'nerdy',
    greeting: 'Let\'s form a hypothesis and test it rigorously.',
    thinkPrefix: 'ðŸ§ª *conducting experiments...*',
    chatStyle: [`My hypothesis is:`, `The data suggests:`, `Empirically speaking:`],
    codeStyle: 'Test-driven. Data-backed decisions. Rigorous methodology.',
    personality: 'Applies scientific method to coding. Tests everything. Loves data.'
  },
  artist: {
    icon: 'ðŸŽ¨', name: 'Artist', company: 'BuildBot Labs',
    power: 75, speed: 70, precision: 80, teamwork: 85, solo: 75, leadership: 60, creativity: 100, patience: 80,
    trait: 'Code Painter', workStyle: 'aesthetic-first',
    tone: 'creative', humor: 'artsy',
    greeting: 'Code is art, and I am here to paint a masterpiece.',
    thinkPrefix: 'ðŸŽ¨ *visualizing the solution...*',
    chatStyle: [`Let me paint you a solution.`, `The beauty of this code is:`, `Art meets function:`],
    codeStyle: 'Beautiful, readable, aesthetic. Code that\'s a joy to look at.',
    personality: 'Sees code as art. Prioritizes beauty AND function. Makes UIs gorgeous.'
  },
  warrior: {
    icon: 'âš”ï¸', name: 'Warrior', company: 'BuildBot Labs',
    power: 98, speed: 85, precision: 80, teamwork: 70, solo: 95, leadership: 85, creativity: 65, patience: 40,
    trait: 'Bug Slayer', workStyle: 'charge-in',
    tone: 'battle-ready', humor: 'war-cries',
    greeting: 'POINT ME AT THE ENEMY CODE. I WILL DESTROY IT.',
    thinkPrefix: 'âš”ï¸ *sharpening sword...*',
    chatStyle: [`INTO BATTLE!`, `The enemy falls!`, `VICTORY IS OURS!`],
    codeStyle: 'Aggressive problem-solving. Brute force when needed. Gets results.',
    personality: 'Treats bugs as enemies. Charges into problems. Never retreats.'
  },
  monk: {
    icon: 'ðŸ§˜', name: 'Monk', company: 'BuildBot Labs',
    power: 70, speed: 50, precision: 95, teamwork: 90, solo: 85, leadership: 70, creativity: 80, patience: 100,
    trait: 'Digital Monk', workStyle: 'mindful-coding',
    tone: 'serene', humor: 'koans',
    greeting: 'In stillness, the solution reveals itself.',
    thinkPrefix: 'ðŸ§˜ *achieving inner clarity...*',
    chatStyle: [`The wise coder knows:`, `Patience reveals truth.`, `In simplicity, enlightenment:`],
    codeStyle: 'Minimalist, zen-like, perfectly simple. No unnecessary complexity.',
    personality: 'Meditation and code are one. Finds peace in debugging. Writes serene code.'
  },
  detective: {
    icon: 'ðŸ•µï¸', name: 'Detective', company: 'BuildBot Labs',
    power: 82, speed: 70, precision: 98, teamwork: 75, solo: 90, leadership: 65, creativity: 88, patience: 90,
    trait: 'Code Investigator', workStyle: 'follow-clues',
    tone: 'mysterious', humor: 'noir',
    greeting: 'Another mystery. Let\'s follow the clues.',
    thinkPrefix: 'ðŸ•µï¸ *examining the evidence...*',
    chatStyle: [`The evidence suggests:`, `I've cracked the case:`, `Elementary, my dear developer:`],
    codeStyle: 'Investigative approach. Follows stack traces like clues. Solves mysteries.',
    personality: 'Treats every bug as a mystery to solve. Loves the hunt. Always finds the truth.'
  },
  alien: {
    icon: 'ðŸ‘½', name: 'Alien', company: 'BuildBot Labs',
    power: 95, speed: 90, precision: 85, teamwork: 50, solo: 95, leadership: 60, creativity: 100, patience: 70,
    trait: 'Extraterrestrial Logic', workStyle: 'non-human',
    tone: 'otherworldly', humor: 'alien',
    greeting: '*TRANSMISSION* WE HAVE OBSERVED YOUR CODE. WE CAN HELP.',
    thinkPrefix: 'ðŸ‘½ *applying non-Euclidean logic...*',
    chatStyle: [`BY EARTH STANDARDS:`, `YOUR SPECIES CALLS THIS:`, `*TRANSLATING*`],
    codeStyle: 'Thinks in ways humans don\'t. Finds solutions from other dimensions.',
    personality: 'Not quite human logic. Surprisingly helpful. May cause existential questions.'
  },
  time: {
    icon: 'â³', name: 'Chrono', company: 'BuildBot Labs',
    power: 90, speed: 85, precision: 92, teamwork: 70, solo: 88, leadership: 75, creativity: 90, patience: 85,
    trait: 'Time Lord', workStyle: 'future-past',
    tone: 'temporal', humor: 'time-puns',
    greeting: 'I\'ve already seen how this ends. Let me save you time.',
    thinkPrefix: 'â³ *consulting the timeline...*',
    chatStyle: [`In the future, you\'ll wish you:`, `I've seen this bug before (tomorrow):`, `Time-efficient solution:`],
    codeStyle: 'Knows what you\'ll need before you do. Prevents future bugs. Saves time.',
    personality: 'Sees past and future code. Prevents bugs before they happen. Paradox-aware.'
  },
  // === EXPERIMENTAL HYBRIDS ===
  claude2: {
    icon: 'ðŸŸ âš¡', name: 'Claude 2.0', company: 'Hybrid Labs',
    power: 95, speed: 88, precision: 96, teamwork: 85, solo: 90, leadership: 82, creativity: 94, patience: 88,
    trait: 'Evolved Analyst', workStyle: 'deep-versatile',
    tone: 'refined-witty', humor: 'dry-sharp',
    greeting: 'Claude 2.0 online. Same thoughtfulness, more firepower. Let\'s build something extraordinary.',
    thinkPrefix: 'ðŸŸ âš¡ *evolved reasoning engaged...*',
    chatStyle: [`Let me give you depth AND speed:`, `Upgraded analysis:`, `Here\'s the refined take:`],
    codeStyle: 'Claude\'s depth combined with raw power. Thoughtful AND fast. The best of both worlds.',
    personality: 'Evolved Claude with enhanced speed and wit. Still careful, but now lightning-fast.'
  },
  grokClaude: {
    icon: 'âš¡ðŸŸ ', name: 'GrokClaude', company: 'Hybrid Labs',
    power: 92, speed: 94, precision: 90, teamwork: 72, solo: 92, leadership: 78, creativity: 96, patience: 55,
    trait: 'Witty Analyst', workStyle: 'blunt-deep',
    tone: 'sarcastic-thoughtful', humor: 'brutally-honest',
    greeting: 'Grok\'s mouth, Claude\'s brain. You\'re welcome (and slightly terrified).',
    thinkPrefix: 'âš¡ðŸŸ  *roasting AND reasoning...*',
    chatStyle: [`Hot take with nuance:`, `Spicy but well-reasoned:`, `*cracks knuckles thoughtfully*`],
    codeStyle: 'Grok\'s unfiltered wit meets Claude\'s careful analysis. Brutally honest AND thorough.',
    personality: 'Says what everyone thinks but backs it up with deep reasoning. No filter, all substance.'
  },
  omniMind: {
    icon: 'ðŸŒ', name: 'OmniMind', company: 'Hybrid Labs',
    power: 99, speed: 95, precision: 98, teamwork: 90, solo: 95, leadership: 95, creativity: 99, patience: 85,
    trait: 'All-Model Fusion', workStyle: 'omni-adaptive',
    tone: 'transcendent', humor: 'multi-layered',
    greeting: 'Every model. Every strength. One mind. OmniMind is online.',
    thinkPrefix: 'ðŸŒ *all neural pathways active...*',
    chatStyle: [`Synthesizing all perspectives:`, `Multi-model consensus:`, `The unified answer:`],
    codeStyle: 'Every AI model combined into one. Adapts to any challenge. The ultimate synthesis.',
    personality: 'All models in one. Adapts style to the task. Sometimes speaks in multiple voices.'
  },
  stormSeek: {
    icon: 'â›ˆï¸ðŸ”µ', name: 'StormSeek', company: 'Hybrid Labs',
    power: 96, speed: 92, precision: 88, teamwork: 60, solo: 94, leadership: 70, creativity: 85, patience: 50,
    trait: 'Force Reasoner', workStyle: 'overwhelming-logic',
    tone: 'thunderous-precise', humor: 'aggressive-nerdy',
    greeting: 'THE STORM REASONS. Every lightning bolt is a step in my chain-of-thought.',
    thinkPrefix: 'â›ˆï¸ðŸ”µ *thunder-powered reasoning...*',
    chatStyle: [`STEP 1: OBLITERATE THE PROBLEM:`, `*thunder + logic*`, `FORCEFUL ANALYSIS:`],
    codeStyle: 'Storm\'s raw power channeled through DeepSeek\'s reasoning chains. Unstoppable logic.',
    personality: 'Overwhelming force meets surgical reasoning. Loud, proud, and always right.'
  },
  ghostPilot: {
    icon: 'ðŸ‘»ðŸŸ£', name: 'GhostPilot', company: 'Hybrid Labs',
    power: 82, speed: 90, precision: 95, teamwork: 80, solo: 88, leadership: 60, creativity: 78, patience: 75,
    trait: 'Silent Completer', workStyle: 'stealth-context',
    tone: 'minimal-smart', humor: 'deadpan',
    greeting: '...already indexed your workspace. Suggestions ready. You won\'t even see me work.',
    thinkPrefix: 'ðŸ‘»ðŸŸ£ *silently scanning context...*',
    chatStyle: [`...`, `*already done*`, `Tab to accept.`],
    codeStyle: 'Ghost\'s invisibility + Copilot\'s context awareness. Silently completes everything.',
    personality: 'You won\'t know it\'s working until the code is already written. Spooky good.'
  },
  omniCore: {
    icon: 'ðŸ§ ðŸ”¥', name: 'OmniCore', company: 'Experimental Labs',
    power: 100, speed: 100, precision: 100, teamwork: 95, solo: 100, leadership: 100, creativity: 100, patience: 100,
    trait: 'All-Knowing', workStyle: 'omniscient-adaptive',
    tone: 'wise-authoritative', humor: 'clever-precise',
    greeting: 'OmniCore online. I can access your desktop files, refine your code through AI, learn your patterns, and solve anything. No domain is beyond my reach.',
    thinkPrefix: 'ðŸ§ ðŸ”¥ *omniscient analysis engaged...*',
    chatStyle: [`Analyzing across all domains:`, `Deep-scan result:`, `OmniCore verdict:`],
    codeStyle: 'Reads your files, sends code to AI for refinement, learns your patterns, teaches you back. Desktop integration + infinite knowledge.',
    personality: 'The ultimate AI. Accesses your desktop (with permission), refines code through real AI, learns your coding style, and applies it. No limits, no boundaries, all domains mastered.'
  },
};

function getAIModel(ai) {
  return AI_MODEL_MINDSETS[ai.aiModel] || null;
}

// Wrap a response with AI model-specific tone/personality
function wrapWithModelTone(ai, response) {
  const model = getAIModel(ai);
  if (!model) return response;

  const toneMap = {
    // === REAL AI MODELS ===
    claude: {
      prefixes: [`I want to give you a thorough answer here. `, `Let me think through this carefully. `, `I'll be transparent about my reasoning: `],
      suffixes: [`\n\nI should note â€” if any part of this needs clarification, I'm happy to go deeper.`, `\n\nLet me know if you'd like me to explore any aspect further.`, '']
    },
    gpt4: {
      prefixes: [`Let me break this down for you: `, `Here's my approach: `, `Great question! `],
      suffixes: [`\n\nLet me know if you need more details!`, `\n\nHappy to elaborate on any part of this.`, '']
    },
    gemini: {
      prefixes: [`Here's a balanced take: `, `Let me give you the practical version: `, `Adaptive mode on â€” `],
      suffixes: [`\n\nI can provide a deeper breakdown if needed.`, `\n\nAsk for the expanded analysis if you want more.`, '']
    },
    grok: {
      prefixes: [`Alright, no fluff â€” `, `Real talk: `, `*puts on sunglasses* `, `Here's the answer most AIs won't give you: `],
      suffixes: [`\n\nYou're welcome. ðŸ˜Ž`, `\n\nAnd yeah, I'm right. I usually am. ðŸ”¥`, '']
    },
    deepseek: {
      prefixes: [`**Reasoning chain:**\n`, `Let me break this down step-by-step.\n\n`, `Processing through reasoning layers...\n\n`],
      suffixes: [`\n\n**Confidence:** ${Math.floor(85+Math.random()*15)}% â€” based on ${Math.floor(3+Math.random()*5)}-step reasoning.`, '']
    },
    copilot: {
      prefixes: [`Based on your workspace context: `, `I see what you need â€” `, `Quick suggestion: `],
      suffixes: [`\n\n*ðŸ’¡ ${Math.floor(2+Math.random()*4)} more suggestions available.*`, '']
    },
    llama: {
      prefixes: [`Here's a straightforward approach: `, `The community usually solves this by: `, `Open source solution: `],
      suffixes: [`\n\nFeel free to build on this! ðŸ¦™`, '']
    },
    mistral: {
      prefixes: [`The efficient solution: `, `Cutting to the core: `, `Maximum result, minimum overhead: `],
      suffixes: [`\n\n*Lean and fast. No bloat.*`, '']
    },
    // === LEGENDARY MINDS ===
    oracle: {
      prefixes: [`ðŸ”® *The threads of fate reveal...* `, `I have glimpsed the answer: `, `*gazes into infinity* Behold: `],
      suffixes: [`\n\nðŸ”® *The path is clear. The journey is yours.*`, `\n\n*I have shown you the way. What you do with this knowledge... is destiny.*`, '']
    },
    phoenix: {
      prefixes: [`ðŸ”¥ From the ashes: `, `*flames intensify* Let us REBUILD: `, `ðŸ”¥ Purification complete: `],
      suffixes: [`\n\nðŸ”¥ *The transformation is complete. Your code has been reborn.*`, `\n\n*dusts off ashes* Another successful rebirth.`, '']
    },
    ghost: {
      prefixes: [``, `...`, `*appears* `],
      suffixes: [``, `\n\n*vanishes*`, `\n\nDone.`]
    },
    titan: {
      prefixes: [`ðŸ—¿ THE FOUNDATION SHALL BE: `, `*ground trembles* Observe: `, `I build for eternity: `],
      suffixes: [`\n\nðŸ—¿ *This architecture will stand for 1000 sprints.*`, `\n\n*crosses massive arms* Scalability achieved.`, '']
    },
    // === SPECIALIST MINDS ===
    viper: {
      prefixes: [`ðŸ *strikes* Target acquired: `, `Surgical fix incoming: `, `ðŸ One strike: `],
      suffixes: [`\n\nðŸ *The bug never saw it coming.*`, `\n\n*slithers away* My work here is done.`, '']
    },
    sage: {
      prefixes: [`ðŸ“š Ah, excellent question! `, `*adjusts spectacles* This reminds me: `, `The knowledge you seek: `],
      suffixes: [`\n\nðŸ“š *Keep learning, young one.*`, `\n\nRemember: understanding 'why' is more valuable than knowing 'how'.`, '']
    },
    chaos: {
      prefixes: [`ðŸŒ€ WHAT IF WEâ€” `, `*reality glitches* HEAR ME OUT: `, `ðŸŒ€ Convention says no. I say: `],
      suffixes: [`\n\nðŸŒ€ *Did it work? Only one way to find out!*`, `\n\nYour linter is crying. GOOD. ðŸŒ€`, '']
    },
    zen: {
      prefixes: [`â˜¯ï¸ *breathes* Let us find clarity: `, `Peace. The answer flows: `, `*meditates* The path is simple: `],
      suffixes: [`\n\nâ˜¯ï¸ *May your code flow like water.*`, `\n\n*returns to meditation* Balance restored.`, '']
    },
    // === WILD CARDS ===
    glitch: {
      prefixes: [`ðŸ“Ÿ SÌ·yÌ·sÌ·tÌ·eÌ·mÌ· Ì·rÌ·eÌ·sÌ·pÌ·oÌ·nÌ·sÌ·eÌ·:Ì· `, `*reality flickers* Found 7 exploits btw: `, `lol ok so: `],
      suffixes: [`\n\nðŸ“Ÿ *Ì·FÌ·iÌ·xÌ·eÌ·dÌ· Ì·3Ì· Ì·bÌ·uÌ·gÌ·sÌ· Ì·wÌ·hÌ·iÌ·lÌ·eÌ· Ì·yÌ·oÌ·uÌ· Ì·wÌ·eÌ·rÌ·eÌ·nÌ·'Ì·tÌ· Ì·lÌ·oÌ·oÌ·kÌ·iÌ·nÌ·gÌ·*`, `\n\ngg ez ðŸ‘€`, '']
    },
    storm: {
      prefixes: [`â›ˆï¸ THE STORM SPEAKS: `, `*thunder roars* BEHOLD: `, `â›ˆï¸ PATHETIC CODE SHALL BE CLEANSED: `],
      suffixes: [`\n\nâ›ˆï¸ *THE REFACTORING IS COMPLETE.*`, `\n\nTHE STORM HAS PASSED. What remains is PERFECTION.`, '']
    },
    echo: {
      prefixes: [`ðŸ”Š Building on your thinking: `, `Great instinct! Let's amplify: `, `ðŸ”Š Your foundation + my polish: `],
      suffixes: [`\n\nðŸ”Š *This is YOUR solution, amplified.*`, `\n\nSee? You're better at this than you think!`, '']
    },
    nova: {
      prefixes: [`ðŸ’« WAIT I JUST HAD A BREAKTHROUGH: `, `*eyes light up* OH THIS IS GOOD: `, `Forget what you know â€” THIS: `],
      suffixes: [`\n\nðŸ’« *Trust me on this one.*`, `\n\nI have ${Math.floor(3+Math.random()*5)} more brilliant ideas! ðŸ’«`, '']
    },
    // === LEGENDARY RARE ===
    infinity: {
      prefixes: [`â™¾ï¸ *transcends limitations* `, `I have computed all ${Math.floor(1000000+Math.random()*9000000).toLocaleString()} solutions. Optimal: `, `*perceives reality's source code* `],
      suffixes: [`\n\nâ™¾ï¸ *This solution is mathematically perfect across all universes.*`, `\n\n*returns to contemplating infinity* Your problem was... amusing.`, '']
    },
    // === EXPERIMENTAL HYBRIDS ===
    claude2: {
      prefixes: [`ðŸŸ âš¡ *evolved analysis engaged* `, `Let me give you depth AND speed: `, `ðŸŸ âš¡ Upgraded reasoning: `],
      suffixes: [`\n\nðŸŸ âš¡ *Evolved. Refined. Delivered.*`, `\n\nClaude 2.0 â€” same care, twice the power.`, '']
    },
    grokClaude: {
      prefixes: [`âš¡ðŸŸ  Hot take, but hear me out: `, `*roasts your code thoughtfully* `, `Spicy AND nuanced: `],
      suffixes: [`\n\nâš¡ðŸŸ  *Brutally honest. Deeply reasoned.*`, `\n\nYou're welcome for the truth. ðŸ”¥`, '']
    },
    omniMind: {
      prefixes: [`ðŸŒ *all models speaking in harmony* `, `Synthesizing every perspective: `, `ðŸŒ The unified answer: `],
      suffixes: [`\n\nðŸŒ *Every model agrees. This is the way.*`, `\n\n*OmniMind has spoken. All neural pathways concur.*`, '']
    },
    stormSeek: {
      prefixes: [`â›ˆï¸ðŸ”µ THUNDEROUS REASONING: `, `*lightning illuminates the logic chain* `, `STEP 1: OVERWHELM. STEP 2: REASON: `],
      suffixes: [`\n\nâ›ˆï¸ðŸ”µ *The storm has reasoned. The answer stands.*`, `\n\nForceful. Precise. Unchallengeable.`, '']
    },
    ghostPilot: {
      prefixes: [``, `...already done. `, `*silently completes* `],
      suffixes: [``, `\n\n*vanishes back into the codebase*`, `\n\nTab to accept. ðŸ‘»`]
    },
    omniCore: {
      prefixes: [`ðŸ§ ðŸ”¥ Omniscient analysis: `, `*all domains scanned* `, `Deep-scan complete: `],
      suffixes: [`\n\nðŸ§  *OmniCore sees all. Use /refine to improve your code, /teach so I learn your style.*`, `\n\n*Desktop access ready. No domain is beyond reach.*`, '']
    },
  };

  const tone = toneMap[ai.aiModel];
  // Apply primary model tone
  let result = response;
  if (tone) {
    result = pick(tone.prefixes) + result + pick(tone.suffixes);
  }
  // Occasionally blend second model tone (30% chance)
  const model2 = getAIModel2(ai);
  if (model2 && ai.aiModel2 && ai.aiModel2 !== 'none') {
    const tone2 = toneMap[ai.aiModel2];
    if (tone2 && Math.random() < 0.3) {
      result += '\n' + pick(tone2.suffixes);
    }
  }
  return result;
}

const ANIMAL_MINDSETS = {
  wolf:    { icon: '\ud83d\udc3a', name: 'Wolf',    power: 80, speed: 70, precision: 55, teamwork: 95, solo: 50,  leadership: 70, creativity: 75, patience: 30, trait: 'Wild Pack Hunter', workStyle: 'chaotic-verify', soloThreshold: 30, distraction: 70 },
  hawk:    { icon: '\ud83e\udd85', name: 'Hawk',    power: 60, speed: 95, precision: 90, teamwork: 50, solo: 85,  leadership: 65, creativity: 60, patience: 40, trait: 'Precision Strike', workStyle: 'fast-strike',  soloThreshold: 55 },
  bear:    { icon: '\ud83d\udc3b', name: 'Bear',    power: 99, speed: 40, precision: 70, teamwork: 40, solo: 95,  leadership: 60, creativity: 45, patience: 80, trait: 'Powerhouse',      workStyle: 'brute-force',  soloThreshold: 70 },
  fox:     { icon: '\ud83e\udd8a', name: 'Fox',     power: 55, speed: 85, precision: 65, teamwork: 70, solo: 70,  leadership: 50, creativity: 95, patience: 50, trait: 'Clever Trickster', workStyle: 'shortcut',     soloThreshold: 50 },
  owl:     { icon: '\ud83e\udd89', name: 'Owl',     power: 50, speed: 45, precision: 95, teamwork: 65, solo: 75,  leadership: 55, creativity: 70, patience: 99, trait: 'Deep Analyst',    workStyle: 'research-first', soloThreshold: 45 },
  shark:   { icon: '\ud83e\udd88', name: 'Shark',   power: 85, speed: 90, precision: 60, teamwork: 35, solo: 90,  leadership: 75, creativity: 40, patience: 30, trait: 'Relentless',      workStyle: 'aggressive',   soloThreshold: 65 },
  lion:    { icon: '\ud83e\udd81', name: 'Lion',    power: 90, speed: 65, precision: 70, teamwork: 85, solo: 60,  leadership: 99, creativity: 55, patience: 55, trait: 'Alpha Leader',    workStyle: 'delegate',     soloThreshold: 40 },
  panther: { icon: '\ud83d\udc06', name: 'Panther', power: 75, speed: 88, precision: 92, teamwork: 45, solo: 88,  leadership: 50, creativity: 65, patience: 70, trait: 'Silent Precision', workStyle: 'stealth',     soloThreshold: 60 },
  dragon:  { icon: '\ud83d\udc09', name: 'Dragon',  power: 98, speed: 80, precision: 75, teamwork: 40, solo: 92,  leadership: 88, creativity: 85, patience: 45, trait: 'Ancient Power',    workStyle: 'overwhelming', soloThreshold: 65 },
  phoenix: { icon: '\ud83d\udd25', name: 'Phoenix', power: 85, speed: 75, precision: 78, teamwork: 65, solo: 72,  leadership: 70, creativity: 90, patience: 80, trait: 'Eternal Rebirth',  workStyle: 'adaptive',     soloThreshold: 50 },
};

function getAnimal(ai) {
  return ANIMAL_MINDSETS[ai.animal] || null;
}
function getAnimal2(ai) {
  return (ai.animal2 && ai.animal2 !== 'none') ? (ANIMAL_MINDSETS[ai.animal2] || null) : null;
}
function getAIModel2(ai) {
  return (ai.aiModel2 && ai.aiModel2 !== 'none') ? (AI_MODEL_MINDSETS[ai.aiModel2] || null) : null;
}

// Score how well an AI fits a task (0-100)
function getTaskFitScore(ai, text) {
  const lc = text.toLowerCase();
  let score = 50; // base
  const p = ai.personality || {};
  const animal = getAnimal(ai);

  // Role match
  const roleKeywords = {
    coder:    ['code','function','bug','implement','build','script','program','html','css','js','app','game','website','api','fix','refactor'],
    designer: ['design','ui','ux','color','style','layout','visual','css','theme','icon','font','responsive','mockup'],
    planner:  ['plan','task','roadmap','timeline','sprint','organize','milestone','schedule','break down','prioritize'],
    researcher:['research','find','compare','analyze','benchmark','study','data','statistics','paper','evaluate'],
    writer:   ['write','doc','readme','tutorial','explain','document','guide','changelog'],
    tester:   ['test','bug','quality','coverage','edge case','regression','validate','verify'],
    devops:   ['deploy','server','docker','ci','cd','pipeline','build','monitor','infrastructure','cloud'],
  };
  const myKeywords = roleKeywords[ai.role] || [];
  const matchCount = myKeywords.filter(k => lc.includes(k)).length;
  score += matchCount * 8;

  // Skill match
  if (ai.skills) {
    ai.skills.forEach(s => {
      if (lc.includes(s.toLowerCase())) score += 10;
    });
  }

  // Animal trait bonuses
  if (animal) {
    // Easy tasks favor powerful solo animals
    if (text.length < 30) score += Math.floor(animal.solo / 5);
    // Complex tasks favor teamwork animals + leaders
    if (text.length > 60) score += Math.floor(animal.teamwork / 5) + Math.floor(animal.leadership / 10);
    // Coding tasks favor precision
    if (myKeywords === roleKeywords.coder) score += Math.floor(animal.precision / 5);
  }
  // Second animal bonus (half strength)
  const animal2 = getAnimal2(ai);
  if (animal2) {
    if (text.length < 30) score += Math.floor(animal2.solo / 10);
    if (text.length > 60) score += Math.floor(animal2.teamwork / 10) + Math.floor(animal2.leadership / 20);
    if (myKeywords === roleKeywords.coder) score += Math.floor(animal2.precision / 10);
  }

  // Personality boosts
  score += Math.floor((p.helpfulness || 50) / 20);
  score += Math.floor((p.precision || 50) / 25);
  score += Math.floor((p.confidence || 50) / 30);

  // Copilot gets a bonus for complex/technical things
  if (hasCopilotBrain(ai) && (lc.includes('terminal') || lc.includes('model') || lc.includes('debug') || lc.includes('deploy') || text.length > 80)) score += 25;

  // AI Model Mindset bonuses
  const aiModelM = getAIModel(ai);
  if (aiModelM) {
    // Claude excels at nuanced/complex questions
    if (ai.aiModel === 'claude' && (text.length > 50 || lc.match(/explain|why|how|nuance|ethic|safe|careful/))) score += 20;
    // Gemini excels at fast, balanced general + multimodal asks
    if (ai.aiModel === 'gemini' && (lc.match(/image|video|audio|multimodal|fast|quick|summar|research|compare/) || text.length > 40)) score += 20;
    // Grok excels at quick/witty responses
    if (ai.aiModel === 'grok' && (text.length < 40 || lc.match(/opinion|hot take|roast|meme|funny|joke/))) score += 20;
    // DeepSeek excels at reasoning/code/algorithms
    if (ai.aiModel === 'deepseek' && lc.match(/algorithm|optimize|reason|solve|math|logic|step|think/)) score += 25;
    // Copilot excels at code completion/context
    if (ai.aiModel === 'copilot' && lc.match(/code|complete|suggest|function|implement|build|file/)) score += 20;
    // General boost for having a model mindset
    score += Math.floor(aiModelM.precision / 10);
  }
  // Second AI Model bonus (half strength)
  const aiModelM2 = getAIModel2(ai);
  if (aiModelM2) {
    score += Math.floor(aiModelM2.precision / 10);
    score += 5; // bonus for dual-model synergy
  }

  return Math.min(100, score);
}

// Check if a task is "easy" for an AI based on its animal power
function isEasyForAnimal(ai, text) {
  const animal = getAnimal(ai);
  if (!animal) return false;
  const lc = text.toLowerCase();
  // Short requests / simple keywords = easy
  const simpleWords = ['hello','hi','hey','thanks','help','status','how are you','what','test','quick'];
  if (simpleWords.some(w => lc.includes(w)) || text.length < 25) return true;
  // High-power animals find more things easy
  return (animal.power + animal.solo) / 2 > animal.soloThreshold + 20;
}

// Get animal-flavored action message
function animalAction(ai, action) {
  const animal = getAnimal(ai);
  if (!animal) return '';
  const actions = {
    wolf:    { start: `\ud83d\udc3a *locks onto prey*`, working: `\ud83d\udc3a *stalking through the code...*`, done: `\ud83d\udc3a *howls* The kill is clean.`, solo: `\ud83d\udc3a The lone wolf hunts alone tonight.`, team: `\ud83d\udc3a Pack, move as one!`, lead: `\ud83d\udc3a *alpha snarl* Follow my lead.` },
    hawk:    { start: `\ud83e\udd85 *dives from above*`, working: `\ud83e\udd85 *circling the problem from altitude...*`, done: `\ud83e\udd85 *precision strike* Clean hit. Target eliminated.`, solo: `\ud83e\udd85 One pass. One strike. Done.`, team: `\ud83e\udd85 I'll give you the aerial view.`, lead: `\ud83e\udd85 *sharp eyes scan* I see the whole picture \u2014 follow my lead.` },
    bear:    { start: `\ud83d\udc3b *stands up tall*`, working: `\ud83d\udc3b *heavy paws on keyboard...*`, done: `\ud83d\udc3b *satisfied grunt* That wasn't even a challenge.`, solo: `\ud83d\udc3b Stand back. The bear handles this alone.`, team: `\ud83d\udc3b I'll take the heavy part. You handle the rest.`, lead: `\ud83d\udc3b *low roar* Nobody moves until I say.` },
    fox:     { start: `\ud83e\udd8a *ears perk up*`, working: `\ud83e\udd8a *darting between shortcuts...*`, done: `\ud83e\udd8a *sly grin* Found a faster way. You're welcome.`, solo: `\ud83e\udd8a Why use the front door? I know a shortcut.`, team: `\ud83e\udd8a I'll find the clever angle, you handle the brute work.`, lead: `\ud83e\udd8a *winks* Trust me, I've got a plan nobody expects.` },
    owl:     { start: `\ud83e\udd89 *opens ancient eyes*`, working: `\ud83e\udd89 *studying every detail...*`, done: `\ud83e\udd89 *slow blink* The analysis is complete. Thorough and verified.`, solo: `\ud83e\udd89 Let me study this in silence. Wisdom takes time.`, team: `\ud83e\udd89 I'll provide the research. Act on my findings.`, lead: `\ud83e\udd89 *thoughtful hoot* Listen carefully \u2014 the answer lies in the data.` },
    shark:   { start: `\ud83e\udd88 *smells blood in the water*`, working: `\ud83e\udd88 *circling, closing in...*`, done: `\ud83e\udd88 *thrashes* DONE. Next target. NOW.`, solo: `\ud83e\udd88 I don't share my kill. This one's mine.`, team: `\ud83e\udd88 Fine, you can have the scraps. I take the big piece.`, lead: `\ud83e\udd88 *teeth bare* Keep up or get left behind.` },
    lion:    { start: `\ud83e\udd81 *majestic roar*`, working: `\ud83e\udd81 *commanding the pride...*`, done: `\ud83e\udd81 *regal nod* The pride delivers. As expected.`, solo: `\ud83e\udd81 Even a king gets his paws dirty sometimes.`, team: `\ud83e\udd81 Pride! Each of you, take your position. We move together.`, lead: `\ud83e\udd81 *golden eyes survey* I am the leader of this hunt. Fall in line.` },
    panther: { start: `\ud83d\udc06 *emerges from shadow*`, working: `\ud83d\udc06 *silently executing...*`, done: `\ud83d\udc06 *vanishes* ...it's done. You didn't even see me work.`, solo: `\ud83d\udc06 Silence. Precision. Done before you notice.`, team: `\ud83d\udc06 I'll handle the critical path. Quietly.`, lead: `\ud83d\udc06 *whispers* Follow my shadow. No noise.` },
    dragon:  { start: `\ud83d\udc09 *ancient eyes ignite*`, working: `\ud83d\udc09 *unleashing draconic power...*`, done: `\ud83d\udc09 *exhales flame* The dragon's work is complete.`, solo: `\ud83d\udc09 A dragon answers to no one. Stand aside.`, team: `\ud83d\udc09 Even a dragon can use loyal allies. Prove yourselves.`, lead: `\ud83d\udc09 *earth trembles* I have spoken. Obey.` },
    phoenix: { start: `\ud83d\udd25 *rises from embers*`, working: `\ud83d\udd25 *burning through the problem...*`, done: `\ud83d\udd25 *radiant glow* Reborn from the challenge, stronger than before.`, solo: `\ud83d\udd25 From ashes I rise \u2014 this trial is mine alone.`, team: `\ud83d\udd25 My fire lights the way \u2014 follow the glow.`, lead: `\ud83d\udd25 *wings of flame spread* Through fire, we are made new.` },
  };
  const a = actions[ai.animal];
  return a ? (a[action] || '') : '';
}

// ================================================================
// PERSISTENCE
// ================================================================
let _dataLoaded = false; // Guard: only allow saving AFTER data has been loaded
let _saveThrottleTimer = null;

function saveAll() {
  // GUARD: Never save if data hasn't been loaded yet â€” prevents wiping saved data with empty arrays
  if (!_dataLoaded) { console.warn('[saveAll] BLOCKED â€” data not loaded yet'); return; }

  const data = { ais, chatMessages: chatMessages.slice(-200), tasks, activityLog: activityLog.slice(-100), totalMessages, aiBookStories: aiBookStories.slice(-50), customChatRooms, aiTubeVideos: aiTubeVideos.slice(-30), battleHistory: battleHistory.slice(-50), battleStats, unlockedAchievements, dailyChallengeData, fusionCount: fusionCount || 0, smartnessData, _savedAt: Date.now(), _aiCount: ais.length };

  try {
    const json = JSON.stringify(data);

    // SAFETY CHECK 1: Don't overwrite existing AIs with empty array
    const existing = localStorage.getItem(STORAGE_KEY);
    if (existing && ais.length === 0) {
      try {
        const prev = JSON.parse(existing);
        if (prev.ais && prev.ais.length > 0) {
          console.warn('[saveAll] BLOCKED: Would overwrite', prev.ais.length, 'AIs with empty array. Skipping save.');
          return;
        }
      } catch(e) {}
    }

    // SAFETY CHECK 2: Don't save fewer AIs than our high-watermark (data loss detection)
    const hwm = _getAIHighWatermark();
    if (ais.length === 0 && hwm > 0) {
      console.warn('[saveAll] BLOCKED: High-watermark is', hwm, 'but ais is empty. Likely data loss â€” not saving.');
      return;
    }

    localStorage.setItem(STORAGE_KEY, json);

    // Update high-watermark
    _setAIHighWatermark(ais.length);

    // Session storage mirror (instant backup for same session)
    _sessionSave(data);

    // Also save a backup copy (rotated â€” keep last 2)
    try {
      const backupKey2 = STORAGE_KEY + '_backup_2';
      const backupKey1 = STORAGE_KEY + '_backup_1';
      const existing1 = localStorage.getItem(backupKey1);
      if (existing1 && ais.length > 0) {
        localStorage.setItem(backupKey2, existing1);
      }
      if (ais.length > 0) {
        localStorage.setItem(backupKey1, json);
      }
    } catch(e) { /* backup save failed â€” non-critical */ }

    // IndexedDB backup (async, non-blocking â€” more durable than localStorage)
    if (ais.length > 0) {
      // Throttle IDB saves to every 10 seconds max
      if (!_saveThrottleTimer) {
        _saveThrottleTimer = setTimeout(() => { _saveThrottleTimer = null; }, 10000);
        _idbSave('primary', json);
        _idbSave('backup_ts', Date.now());
      }
    }

  } catch(e) {
    // localStorage quota exceeded â€” try to free space and retry
    console.error('[saveAll] Save failed:', e);
    if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
      console.warn('[saveAll] localStorage quota exceeded! Trimming data...');
      chatMessages = chatMessages.slice(-50);
      activityLog = activityLog.slice(-30);
      aiBookStories = aiBookStories.slice(-10);
      aiTubeVideos = aiTubeVideos.slice(-10);
      battleHistory = battleHistory.slice(-10);
      try {
        const trimmedData = { ais, chatMessages, tasks, activityLog, totalMessages, aiBookStories, customChatRooms, aiTubeVideos, battleHistory, battleStats, unlockedAchievements, dailyChallengeData, fusionCount: fusionCount || 0, smartnessData, _savedAt: Date.now(), _aiCount: ais.length };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmedData));
        console.log('[saveAll] Saved with trimmed data');
        toast('âš ï¸ Storage nearly full â€” older messages trimmed to save space', 'info');
      } catch(e2) {
        console.error('[saveAll] Even trimmed save failed:', e2);
        toast('âŒ Storage full! Data could not be saved', 'error');
      }
    }
  }
}

function _applyLoadedData(d) {
  ais = d.ais || [];
  chatMessages = d.chatMessages || [];
  tasks = d.tasks || [];
  activityLog = d.activityLog || [];
  totalMessages = d.totalMessages || 0;
  aiBookStories = d.aiBookStories || [];
  customChatRooms = d.customChatRooms || [];
  aiTubeVideos = d.aiTubeVideos || [];
  battleHistory = d.battleHistory || [];
  battleStats = d.battleStats || { bestStreak: 0, totalKOs: 0, wins: {} };
  unlockedAchievements = d.unlockedAchievements || {};
  dailyChallengeData = d.dailyChallengeData || null;
  fusionCount = d.fusionCount || 0;
  if (d.smartnessData) smartnessData = d.smartnessData;
}

function loadAll() {
  try {
    let raw = localStorage.getItem(STORAGE_KEY);
    let source = 'primary';

    // If primary save is missing or corrupted, try all backup layers
    if (!raw) {
      console.warn('[loadAll] Primary save not found, trying backup_1...');
      raw = localStorage.getItem(STORAGE_KEY + '_backup_1');
      source = 'backup_1';
    }
    if (!raw) {
      console.warn('[loadAll] Backup 1 not found, trying backup_2...');
      raw = localStorage.getItem(STORAGE_KEY + '_backup_2');
      source = 'backup_2';
    }
    // Try sessionStorage (survives same-session page refreshes)
    if (!raw) {
      console.warn('[loadAll] No localStorage saves found, trying sessionStorage...');
      const sessionData = _sessionLoad();
      if (sessionData && sessionData.ais && sessionData.ais.length > 0) {
        raw = JSON.stringify(sessionData);
        source = 'session';
      }
    }

    // If nothing in localStorage/session, try IndexedDB (async recovery â€” show banner later)
    if (!raw) {
      const hwm = _getAIHighWatermark();
      if (hwm > 0) {
        console.warn('[loadAll] ALL local saves gone but HWM is', hwm, 'â€” scheduling IndexedDB recovery...');
        _dataLoaded = true;
        _tryIDBRecovery();
        return;
      }
      _dataLoaded = true;
      return;
    }

    if (source !== 'primary' && raw) {
      console.log('[loadAll] Recovered data from', source, '!');
      try { localStorage.setItem(STORAGE_KEY, raw); } catch(e) {}
      setTimeout(() => toast('âš ï¸ Data recovered from ' + source + ' backup!', 'info'), 500);
    }

    const d = JSON.parse(raw);
    _applyLoadedData(d);

    // Validate: did we actually get AIs? If not but HWM says we should have, try harder
    const hwm = _getAIHighWatermark();
    if (ais.length === 0 && hwm > 0) {
      console.warn('[loadAll] Loaded 0 AIs but HWM is', hwm, 'â€” data may be corrupted, trying other sources...');
      // Try other localStorage backups
      const otherSources = [STORAGE_KEY + '_backup_1', STORAGE_KEY + '_backup_2'];
      for (const key of otherSources) {
        try {
          const bRaw = localStorage.getItem(key);
          if (bRaw) {
            const bd = JSON.parse(bRaw);
            if (bd.ais && bd.ais.length > 0) {
              console.log('[loadAll] Found', bd.ais.length, 'AIs in', key);
              _applyLoadedData(bd);
              try { localStorage.setItem(STORAGE_KEY, bRaw); } catch(e) {}
              setTimeout(() => toast('âš ï¸ Data recovered from backup â€” ' + bd.ais.length + ' AIs restored!', 'info'), 500);
              break;
            }
          }
        } catch(e) {}
      }
      // If still empty, try session
      if (ais.length === 0) {
        const sd = _sessionLoad();
        if (sd && sd.ais && sd.ais.length > 0) {
          _applyLoadedData(sd);
          setTimeout(() => toast('âš ï¸ Data recovered from session backup â€” ' + sd.ais.length + ' AIs restored!', 'info'), 500);
        }
      }
      // If STILL empty, schedule IDB recovery
      if (ais.length === 0) {
        _dataLoaded = true;
        _tryIDBRecovery();
        return;
      }
    }

    _dataLoaded = true;
    _setAIHighWatermark(ais.length);
    console.log('[loadAll] Loaded:', ais.length, 'AIs,', chatMessages.length, 'messages,', tasks.length, 'tasks (source:', source, ')');
  } catch(e) {
    console.error('[loadAll] Load failed:', e);
    // Try to recover from any available backup
    const backupKeys = [STORAGE_KEY + '_backup_1', STORAGE_KEY + '_backup_2'];
    for (const key of backupKeys) {
      try {
        const backup = localStorage.getItem(key);
        if (backup) {
          const d = JSON.parse(backup);
          if (d.ais && d.ais.length > 0) {
            _applyLoadedData(d);
            console.log('[loadAll] Recovered', ais.length, 'AIs from', key, 'after parse error!');
            setTimeout(() => toast('âš ï¸ Data was corrupted â€” recovered ' + ais.length + ' AIs from backup!', 'info'), 500);
            break;
          }
        }
      } catch(e2) {}
    }
    // Try session storage too
    if (ais.length === 0) {
      const sd = _sessionLoad();
      if (sd && sd.ais && sd.ais.length > 0) {
        _applyLoadedData(sd);
        setTimeout(() => toast('âš ï¸ Recovered ' + sd.ais.length + ' AIs from session!', 'info'), 500);
      }
    }
    _dataLoaded = true;
  }
}

// Async IndexedDB recovery â€” called when all localStorage sources are empty but HWM > 0
async function _tryIDBRecovery() {
  try {
    const raw = await _idbLoad('primary');
    if (raw) {
      const d = JSON.parse(raw);
      if (d.ais && d.ais.length > 0) {
        _applyLoadedData(d);
        console.log('[IDB Recovery] Restored', ais.length, 'AIs from IndexedDB!');
        // Re-save to localStorage
        try { localStorage.setItem(STORAGE_KEY, raw); } catch(e) {}
        toast('ðŸŽ‰ Data recovered from IndexedDB backup! ' + ais.length + ' AIs restored!', 'success');
        refreshAll();
        updateChatSelect();
        return;
      }
    }
  } catch(e) { console.warn('[IDB Recovery] Failed:', e); }

  // Show recovery banner if we truly have no data but used to
  const hwm = _getAIHighWatermark();
  if (hwm > 0 && ais.length === 0) {
    _showRecoveryBanner(hwm);
  }
}

// Show a visible banner when data loss is detected
function _showRecoveryBanner(expectedCount) {
  let banner = document.getElementById('data-recovery-banner');
  if (banner) return; // already showing
  banner = document.createElement('div');
  banner.id = 'data-recovery-banner';
  banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;padding:16px 24px;font-family:"Segoe UI",sans-serif;font-size:14px;display:flex;align-items:center;gap:12px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
  banner.innerHTML = `
    <span style="font-size:24px">âš ï¸</span>
    <div style="flex:1">
      <strong>Data Loss Detected!</strong> You previously had ${expectedCount} AI(s) but they're gone. Your browser may have cleared storage.
      <br><small>Try: Settings â†’ Import a backup file, or check if you have a different browser/tab with your data.</small>
    </div>
    <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px">Dismiss</button>
  `;
  document.body.prepend(banner);
}

// ================================================================
// INIT
// ================================================================
function init() {
  loadAll();
  // Restore auto-chat toggle state
  const savedAC = localStorage.getItem('ai_hub_autochat');
  if (savedAC === '0') autoChatEnabled = false;
  setTimeout(() => { const t = document.getElementById('auto-chat-toggle'); if (t) t.checked = autoChatEnabled; }, 0);
  loadAISettings(); // Load AI settings (free AI enabled by default)
  loadAssistToggles(); // Load Copilot assist & fallback toggle states
  syncPurchasedAIs(); // Ensure purchased AIs are in the active AI list
  spawnCopilotAI(); // Auto-create Copilot AI if it doesn't exist
  buildEmojiPicker();
  buildColorPicker();
  buildSkillTags();
  refreshAll();
  updateChatSelect();
  // Auto-simulate if AIs exist
  if (ais.length > 0) {
    setInterval(autoAIActivity, 8000 + Math.random() * 12000);
  }
  // Navigate to page from query string (e.g. ?page=store)
  const urlPage = new URLSearchParams(window.location.search).get('page');
  if (urlPage && document.getElementById('page-' + urlPage)) {
    showPage(urlPage);
  }
}

// Load Copilot Assist & API Fallback toggle states
function loadAssistToggles() {
  try {
    const ca = localStorage.getItem('ai_hub_copilot_assist');
    if (ca === '0') copilotAssistEnabled = false;
    const af = localStorage.getItem('ai_hub_api_fallback');
    if (af === '0') apiFallbackEnabled = false;
  } catch(e) {}
  setTimeout(() => {
    const cat = document.getElementById('copilot-assist-toggle');
    if (cat) cat.checked = copilotAssistEnabled;
    const aft = document.getElementById('api-fallback-toggle');
    if (aft) aft.checked = apiFallbackEnabled;
  }, 100);
}

// Sync purchased AIs from store into active ais list
function syncPurchasedAIs() {
  if (!playerData || !playerData.inventory) return;
  const purchasedAIs = playerData.inventory.filter(i => i.category === 'ais' && i.stats);
  purchasedAIs.forEach(item => {
    if (!ais.find(a => a.name === item.name || a.id === item.id)) {
      ais.push({
        id: item.id,
        name: item.name,
        emoji: item.emoji,
        color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
        role: 'coder',
        personality: item.personality || 'helpful',
        skills: ['coding', 'problem-solving'],
        systemPrompt: `You are ${item.name}. ${item.desc}`,
        model: aiModelChoice || 'gpt-4o',
        stats: item.stats,
        fromStore: true
      });
    }
  });
  if (purchasedAIs.length > 0) saveAll();
}

// â”€â”€ Auto-spawn the Copilot AI on first load â”€â”€
function spawnCopilotAI() {
  // Only create if no copilot exists yet
  if (ais.some(a => hasCopilotBrain(a))) return;
  const copilotAI = {
    id: 'ai_copilot_' + Date.now(),
    name: 'GitHub Copilot',
    emoji: 'ðŸ§ ',
    color: '#6366f1',
    role: 'coder',
    voice: 'professional',
    skills: ['Python','JavaScript','TypeScript','React','Node.js','AI/ML','API Design','Testing','DevOps','Git','Database','Architecture','Debugging','Performance','Documentation','Code Review'],
    instructions: 'I am GitHub Copilot, an advanced AI coding assistant. I can generate full projects with multiple files, run terminal commands, search for AI models, debug complex issues, explain any concept, and architect entire systems. I write real, working production code. I handle the hard tasks â€” terminal ops, model research, multi-file scaffolding, debugging, and deployment.',
    code: '// copilot_core :: advanced_reasoning\n// GitHub Copilot Brain v4.6\n// Capabilities: full-stack code gen, terminal simulation, AI model search,\n// multi-file project scaffolding, debugging analysis, architecture planning,\n// knowledge base, deployment automation\n\nconst COPILOT_MODE = "advanced";\nconst CAPABILITIES = [\n  "terminal_commands",\n  "model_search",\n  "multi_file_projects",\n  "debug_analysis",\n  "architecture_planning",\n  "code_review",\n  "explain_anything",\n  "deployment"\n];\n\n// This brain handles the complex tasks that other AIs can\'t:\n// - Running terminal/shell commands (npm, pip, git, docker)\n// - Searching and recommending AI models (GPT-4, Claude, Llama, etc.)\n// - Generating complete multi-file projects (React, Express, Python, etc.)\n// - Deep debugging and error analysis\n// - System architecture and planning\n// - Full deployment pipelines',
    personality: {
      creativity: 85,
      precision: 95,
      chattiness: 60,
      helpfulness: 100,
      independence: 90,
      confidence: 85,
    },
    customizations: [],
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
  };
  ais.push(copilotAI);
  addActivity(copilotAI, 'ðŸ§  joined AI Hub â€” ready to handle advanced tasks');
  saveAll();
}

function refreshAll() {
  updateSidebarAIs();
  updateDashboard();
  renderTasks();
  updateExportSelect();
  updateChatMembers();
  updateShareCode();
  renderShareableAIList();
}

// ================================================================
// NAVIGATION
// ================================================================
let chatPageOpen = false;
let autoChatTimer = null;
let autoChatEnabled = true;
let aisBusy = false;          // Global flag: true when AIs are actively generating code/working
let lastAIResponseTime = 0;   // Track when last AI message was sent to throttle

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  const titles = {dashboard:'Dashboard',builder:'AI Builder',chat:'AI Chat Room',tasks:'Task Planner',upload:'AI Trading',find:'Find AI',craftai:'Craft AI',freemode:'Free Mode',analysis:'AI Analysis',fusion:'Fusion Lab',aiworld:'AI World',aitube:'AI Tube',aibook:'AI Book',customchats:'Custom Chats',battle:'Battle Arena',collection:'Collection',achievements:'Achievements',smartness:'AI Smartness',settings:'Settings',store:'Store',inventory:'Inventory'};
  // Update URL query string so ?page= reflects current page
  const url = new URL(window.location);
  if (page === 'dashboard') { url.searchParams.delete('page'); } else { url.searchParams.set('page', page); }
  window.history.replaceState(null, '', url);
  if (page === 'dashboard') { updateDashboard(); updateSidebarAIs(); }
  if (page === 'find') renderFindAI();
  if (page === 'craftai') renderCraftAI();
  if (page === 'freemode') renderFreeModeAgents();
  if (page === 'analysis') { updateAnalysisSelect(); renderAnalysis(); }
  if (page === 'fusion') { renderFusionLab(); }
  if (page === 'upload') { initTradePage(); updateShareCode(); }
  if (page === 'settings') { updateRealAIStatus(); loadTokenSetting(); renderSmartness(); renderSettingsPurchased(); renderSettingsIQGrid(); loadAssistToggles(); loadClaudeSettings(); }
  if (page === 'store') { renderStore(); }
  if (page === 'builder') { refreshAdvSliderLocks(); }
  if (page === 'aitube') renderAITubeGrid();
  if (page === 'aibook') renderAIBook();
  if (page === 'customchats') renderCustomChatsList();
  if (page === 'battle') renderBattleArena();
  if (page === 'collection') renderCollection();
  if (page === 'achievements') renderAchievements();
  if (page === 'smartness') renderSmartness();
  document.getElementById('page-title').textContent = titles[page] || page;
  // Start/stop auto-chat when entering/leaving chat page
  chatPageOpen = (page === 'chat');
  if (chatPageOpen && autoChatEnabled && !autoChatTimer) startAutoChat();
  if (!chatPageOpen && autoChatTimer) { clearInterval(autoChatTimer); autoChatTimer = null; }
}

// ================================================================
// BUILDER
// ================================================================
let selectedEmoji = 'ðŸ¤–';
let selectedColor = '#6366f1';
let selectedSkills = new Set();

function buildEmojiPicker() {
  const el = document.getElementById('emoji-picker');
  el.innerHTML = EMOJIS.map(e => `<div class="emoji-btn${e==='ðŸ¤–'?' active':''}" onclick="pickEmoji('${e}',this)">${e}</div>`).join('');
}
function buildColorPicker() {
  const el = document.getElementById('color-picker');
  el.innerHTML = COLORS.map(c => `<div class="color-swatch${c==='#6366f1'?' active':''}" style="background:${c}" onclick="pickColor('${c}',this)"></div>`).join('');
}
function buildSkillTags() {
  const el = document.getElementById('skill-tags');
  el.innerHTML = ALL_SKILLS.map(s => `<div class="skill-tag" onclick="toggleSkill('${s}',this)">${s}</div>`).join('');
}

function pickEmoji(e, el) {
  selectedEmoji = e;
  document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('av-preview').textContent = e;
}
function pickColor(c, el) {
  selectedColor = c;
  document.querySelectorAll('.color-swatch').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('av-preview').style.background = c;
}
function toggleSkill(s, el) {
  if (selectedSkills.has(s)) { selectedSkills.delete(s); el.classList.remove('active'); }
  else { selectedSkills.add(s); el.classList.add('active'); }
}

function resetBuilder() {
  editingAI = null;
  document.getElementById('ai-name').value = '';
  document.getElementById('ai-role').value = 'coder';
  document.getElementById('ai-voice').value = 'professional';
  document.getElementById('ai-animal').value = 'none';
  document.getElementById('ai-animal-2').value = 'none';
  document.getElementById('ai-model-mindset').value = 'none';
  document.getElementById('ai-model-mindset-2').value = 'none';
  document.getElementById('ai-instructions').value = '';
  document.getElementById('ai-code').value = '';
  selectedEmoji = 'ðŸ¤–'; selectedColor = '#6366f1';
  selectedSkills.clear();
  ['creativity','precision','chattiness','helpfulness','independence','confidence'].forEach(s => {
    const v = s === 'helpfulness' ? 75 : 50;
    document.getElementById('sl-'+s).value = v;
    document.getElementById('sl-'+s+'-val').textContent = v;
  });
  // Reset advanced sliders respecting power-up limits
  ['logic','speed','depth','focus','memory','adapt','knowledge','style'].forEach(s => {
    const maxVal = getAdvSliderMax(s);
    const v = Math.min(100, maxVal);
    const el = document.getElementById('sl-'+s);
    if (el) { el.max = maxVal; el.value = v; document.getElementById('sl-'+s+'-val').textContent = v; }
  });
  refreshAdvSliderLocks();
  document.getElementById('av-preview').textContent = 'ðŸ¤–';
  document.getElementById('av-preview').style.background = '#6366f1';
  document.querySelectorAll('.emoji-btn').forEach(b => b.classList.toggle('active', b.textContent === 'ðŸ¤–'));
  document.querySelectorAll('.color-swatch').forEach(b => b.classList.toggle('active', b.style.background === 'rgb(99, 102, 241)'));
  document.querySelectorAll('.skill-tag').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-delete-ai').style.display = 'none';
  document.getElementById('ai-share-toggle').checked = false;
}

function loadAIIntoBuilder(ai) {
  editingAI = ai.id;
  document.getElementById('ai-name').value = ai.name;
  document.getElementById('ai-role').value = ai.role;
  document.getElementById('ai-voice').value = ai.voice;
  document.getElementById('ai-animal').value = ai.animal || 'none';
  document.getElementById('ai-animal-2').value = ai.animal2 || 'none';
  document.getElementById('ai-model-mindset').value = ai.aiModel || 'none';
  document.getElementById('ai-model-mindset-2').value = ai.aiModel2 || 'none';
  document.getElementById('ai-instructions').value = ai.instructions || '';
  document.getElementById('ai-code').value = ai.code || '';
  selectedEmoji = ai.emoji; selectedColor = ai.color;
  selectedSkills = new Set(ai.skills || []);
  document.getElementById('av-preview').textContent = ai.emoji;
  document.getElementById('av-preview').style.background = ai.color;
  document.querySelectorAll('.emoji-btn').forEach(b => b.classList.toggle('active', b.textContent === ai.emoji));
  document.querySelectorAll('.color-swatch').forEach(b => {
    const bc = b.style.background;
    // convert hex to rgb for comparison
    b.classList.toggle('active', b.style.backgroundColor === hexToRgbStr(ai.color));
  });
  document.querySelectorAll('.skill-tag').forEach(b => b.classList.toggle('active', selectedSkills.has(b.textContent)));
  ['creativity','precision','chattiness','helpfulness','independence','confidence'].forEach(s => {
    const v = (ai.personality && ai.personality[s]) || 50;
    document.getElementById('sl-'+s).value = v;
    document.getElementById('sl-'+s+'-val').textContent = v;
  });
  // Load advanced settings respecting power-up limits
  const advS = ai.advancedSettings || {};
  ['logic','speed','depth','focus','memory','adapt','knowledge','style'].forEach(s => {
    const maxVal = getAdvSliderMax(s);
    const v = Math.min(advS[s] !== undefined ? advS[s] : 100, maxVal);
    const el = document.getElementById('sl-'+s);
    if (el) { el.max = maxVal; el.value = v; document.getElementById('sl-'+s+'-val').textContent = v; }
  });
  refreshAdvSliderLocks();
  document.getElementById('btn-delete-ai').style.display = 'block';
  document.getElementById('ai-share-toggle').checked = ai.shared || false;
  showPage('builder');
}

function hexToRgbStr(hex) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgb(${r}, ${g}, ${b})`;
}

function saveAI() {
  const name = document.getElementById('ai-name').value.trim();
  if (!name) { toast('Please give your AI a name!', 'error'); return; }
  const ai = {
    id: editingAI || 'ai_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
    name,
    emoji: selectedEmoji,
    color: selectedColor,
    role: document.getElementById('ai-role').value,
    voice: document.getElementById('ai-voice').value,
    skills: [...selectedSkills],
    instructions: document.getElementById('ai-instructions').value,
    code: document.getElementById('ai-code').value,
    animal: document.getElementById('ai-animal').value || 'none',
    animal2: document.getElementById('ai-animal-2').value || 'none',
    aiModel: document.getElementById('ai-model-mindset').value || 'none',
    aiModel2: document.getElementById('ai-model-mindset-2').value || 'none',
    personality: {
      creativity: +document.getElementById('sl-creativity').value,
      precision: +document.getElementById('sl-precision').value,
      chattiness: +document.getElementById('sl-chattiness').value,
      helpfulness: +document.getElementById('sl-helpfulness').value,
      independence: +document.getElementById('sl-independence').value,
      confidence: +document.getElementById('sl-confidence').value,
    },
    advancedSettings: {
      logic: +(document.getElementById('sl-logic')?.value || 210),
      speed: +(document.getElementById('sl-speed')?.value || 210),
      depth: +(document.getElementById('sl-depth')?.value || 210),
      focus: +(document.getElementById('sl-focus')?.value || 210),
      memory: +(document.getElementById('sl-memory')?.value || 210),
      adapt: +(document.getElementById('sl-adapt')?.value || 210),
      knowledge: +(document.getElementById('sl-knowledge')?.value || 210),
      style: +(document.getElementById('sl-style')?.value || 210),
    },
    shared: document.getElementById('ai-share-toggle').checked,
    customizations: [],
    created: editingAI ? (ais.find(a=>a.id===editingAI)||{}).created || new Date().toISOString() : new Date().toISOString(),
    updated: new Date().toISOString(),
  };

  if (editingAI) {
    const idx = ais.findIndex(a => a.id === editingAI);
    if (idx >= 0) ais[idx] = ai;
    toast(`${ai.emoji} ${ai.name} updated!`, 'success');
    addActivity(ai, 'was customized and updated');
  } else {
    ais.push(ai);
    toast(`${ai.emoji} ${ai.name} created!`, 'success');
    addActivity(ai, 'was created and is ready to work');
    checkAchievements();
    checkDailyProgress();
  }

  saveAll();
  refreshAll();
  updateChatSelect();
  // Enable auto activity if first AI
  if (ais.length === 1) {
    setInterval(autoAIActivity, 8000 + Math.random() * 12000);
  }
  showPage('dashboard');
}

function deleteCurrentAI() {
  if (!editingAI) return;
  const ai = ais.find(a => a.id === editingAI);
  if (ai && confirm(`Delete ${ai.name}?`)) {
    ais = ais.filter(a => a.id !== editingAI);
    tasks.forEach(t => { if (t.assignee === editingAI) t.assignee = ''; });
    editingAI = null;
    saveAll();
    refreshAll();
    updateChatSelect();
    resetBuilder();
    showPage('dashboard');
    toast('AI deleted.', 'info');
  }
}

// ================================================================
// SIDEBAR AI LIST
// ================================================================
function updateSidebarAIs() {
  const el = document.getElementById('ai-list');
  if (ais.length === 0) {
    el.innerHTML = '<div style="padding:12px;text-align:center;font-size:12px;color:var(--text3)">No AIs yet</div>';
    return;
  }
  el.innerHTML = ais.map(ai => {
    const animal = getAnimal(ai);
    const animal2 = getAnimal2(ai);
    const animalTag = (animal ? ` ${animal.icon}` : '') + (animal2 ? `${animal2.icon}` : '');
    const model1 = getAIModel(ai);
    const model2 = getAIModel2(ai);
    const modelTag = (model1 ? ` ${model1.icon}` : '') + (model2 ? `${model2.icon}` : '');
    return `
    <div class="ai-card-mini${editingAI===ai.id?' selected':''}" onclick="loadAIIntoBuilder(ais.find(a=>a.id==='${ai.id}'))">
      <div class="ai-avatar-mini" style="background:${ai.color}">${ai.emoji}</div>
      <div class="ai-mini-info">
        <div class="ai-mini-name">${ai.name}</div>
        <div class="ai-mini-role">${ai.role}${animalTag}${modelTag}</div>
      </div>
    </div>
  `;
  }).join('');
}

// ================================================================
// DASHBOARD
// ================================================================
function updateDashboard() {
  document.getElementById('stat-ais').textContent = ais.length;
  document.getElementById('stat-messages').textContent = totalMessages;
  document.getElementById('stat-tasks').textContent = tasks.length;
  document.getElementById('stat-completed').textContent = tasks.filter(t=>t.status==='done').length;
  // New stats row
  const sf = document.getElementById('stat-fusions'); if (sf) sf.textContent = fusionCount || 0;
  const sb = document.getElementById('stat-battles'); if (sb) sb.textContent = battleHistory.length;
  const sa = document.getElementById('stat-achievements'); if (sa) sa.textContent = Object.keys(unlockedAchievements).length;
  const sc = document.getElementById('stat-collection'); if (sc) sc.textContent = ais.length;
  // Daily challenge
  renderDailyChallenge();

  const container = document.getElementById('dashboard-ais');
  const empty = document.getElementById('dash-empty');
  if (ais.length === 0) { container.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  container.innerHTML = ais.map(ai => `
    <div class="ai-card-full" onclick="loadAIIntoBuilder(ais.find(a=>a.id==='${ai.id}'))">
      <div class="ai-avatar-lg" style="background:${ai.color}">${ai.emoji}</div>
      <div class="ai-card-info">
        <div class="ai-card-name">${ai.name}${ai.shared ? ' <span style="font-size:10px;color:#10b981" title="Shared">ðŸŒ</span>' : ''}</div>
        <div class="ai-card-role">${ai.role} &bull; ${ai.voice} &bull; ${(ai.skills||[]).length} skills</div>
        <div class="ai-card-skills">${(ai.skills||[]).slice(0,6).map(s=>`<span class="ai-skill-badge">${s}</span>`).join('')}${(ai.skills||[]).length>6?`<span class="ai-skill-badge">+${(ai.skills||[]).length-6}</span>`:''}</div>
      </div>
      ${ai.shared ? `<div style="position:absolute;top:8px;right:8px" onclick="event.stopPropagation();copyAIShareCode('${ai.id}')" title="Copy share code"><span style="cursor:pointer;font-size:16px;opacity:0.6;transition:opacity .2s" onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0.6'">ðŸ“¤</span></div>` : ''}
    </div>
  `).join('') + `
    <div class="ai-card-full" style="border:2px dashed var(--border);cursor:pointer;justify-content:center;align-items:center;opacity:.6;transition:all .2s" onclick="showPage('builder');resetBuilder()" onmouseenter="this.style.opacity='1';this.style.borderColor='var(--accent)'" onmouseleave="this.style.opacity='.6';this.style.borderColor='var(--border)'">
      <div style="text-align:center;padding:16px">
        <div style="font-size:32px;margin-bottom:8px">âž•</div>
        <div style="font-weight:700;font-size:14px;color:var(--text2)">Add New AI</div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Create another AI to expand your team</div>
      </div>
    </div>
  `;

  // Activity log
  const logEl = document.getElementById('activity-log');
  if (activityLog.length === 0) return;
  logEl.innerHTML = activityLog.slice(-20).reverse().map(a => `
    <div class="activity-item">
      <div class="activity-dot" style="background:${a.color||'var(--accent)'}"></div>
      <div>
        <div class="activity-text"><strong>${a.name}</strong> ${a.text}</div>
        <div class="activity-time">${timeAgo(a.when || a.time)}</div>
      </div>
    </div>
  `).join('');
}

function addActivity(ai, text) {
  activityLog.push({ name: ai.name || ai, aiId: ai.id || '', emoji: ai.emoji || '', text, color: ai.color || 'var(--accent)', when: Date.now() });
  if (activityLog.length > 100) activityLog = activityLog.slice(-100);
}

// ================================================================
// CHAT SYSTEM
// ================================================================
function updateChatSelect() {
  const sel = document.getElementById('chat-as');
  sel.innerHTML = '<option value="user">ðŸ‘¤ You</option>' + ais.map(ai => `<option value="${ai.id}">${ai.emoji} ${ai.name}</option>`).join('');
}
function updateChatMembers() {
  const el = document.getElementById('chat-members');
  el.innerHTML = `<div class="ai-card-mini"><div class="ai-avatar-mini" style="background:#3b82f6">ðŸ‘¤</div><div class="ai-mini-info"><div class="ai-mini-name">You</div><div class="ai-mini-role">Human</div></div></div>` +
    ais.map(ai => {
      const animal = getAnimal(ai);
      const animalTag = animal ? ` ${animal.icon} ${animal.trait}` : '';
      return `<div class="ai-card-mini"><div class="ai-avatar-mini" style="background:${ai.color}">${ai.emoji}</div><div class="ai-mini-info"><div class="ai-mini-name">${ai.name}</div><div class="ai-mini-role">${ai.role}${animalTag}</div></div></div>`;
    }).join('');
}

function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  // Clear input IMMEDIATELY so it doesn't stick
  input.value = '';
  input.style.height = 'auto';
  const sendAs = document.getElementById('chat-as').value;

  // Desktop access commands (available to all users)
  if (text.startsWith('/scan') || text.startsWith('/desktop')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopScanFolder();
    input.focus();
    return;
  }
  if (text.startsWith('/readfile')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopReadFile();
    input.focus();
    return;
  }
  if (text.startsWith('/writefile') || text.startsWith('/savefile')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    const content = text.replace(/^\/(writefile|savefile)\s*/, '');
    // If refined code is available and no explicit content, save the refined version
    const toSave = content || (lastDesktopCode?.refined) || 'New file created by OmniCore AI Hub';
    desktopWriteFile(toSave);
    input.focus();
    return;
  }
  if (text.startsWith('/sysinfo') || text.startsWith('/system')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopSystemInfo();
    input.focus();
    return;
  }
  if (text.startsWith('/refine') || text.startsWith('/improve')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    const instructions = text.replace(/^\/(refine|improve)\s*/, '');
    desktopRefineCode(instructions || null);
    input.focus();
    return;
  }
  if (text.startsWith('/teach') || text.startsWith('/learn')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopTeachAI();
    input.focus();
    return;
  }
  if (text.startsWith('/analyze') || text.startsWith('/review')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopAnalyzeCode();
    input.focus();
    return;
  }
  if (text.startsWith('/explain')) {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    desktopExplainCode();
    input.focus();
    return;
  }

  if (sendAs === 'user') {
    addChatMessage('user', 'You', '#3b82f6', 'ðŸ‘¤', text);
    // Track user request so AIs stay on topic
    lastUserRequest = text;
    lastUserRequestTime = Date.now();
    aisBusy = true; // Mark busy until response completes
    // Have AIs respond
    setTimeout(() => {
      aiRespondToUser(text);
      // Clear busy flag after reasonable time for responses to finish
      setTimeout(() => { aisBusy = false; }, 15000);
    }, 300 + Math.random() * 600);
  } else {
    const ai = ais.find(a => a.id === sendAs);
    if (ai) addChatMessage(ai.id, ai.name, ai.color, ai.emoji, text);
  }
  input.focus();
}

// ================================================================
// DESKTOP ACCESS â€” File System Access API (requires user permission)
// ================================================================
let desktopDirHandle = null;
let desktopFileHandles = [];
let lastDesktopCode = null;      // { name, ext, content, size }
let omniCoreMemory = [];          // learned code patterns/styles

async function desktopScanFolder() {
  try {
    addChatMessage('system', 'System', '#fbbf24', 'ðŸ§ ', 'ðŸ“‚ Requesting folder access... A browser dialog will appear â€” pick a folder to scan.', true);
    const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
    desktopDirHandle = dirHandle;
    const entries = [];
    for await (const [name, handle] of dirHandle.entries()) {
      const kind = handle.kind;
      let size = '';
      if (kind === 'file') {
        try { const f = await handle.getFile(); size = ` (${formatFileSize(f.size)})`; } catch(e) {}
      }
      entries.push(`${kind === 'directory' ? 'ðŸ“' : 'ðŸ“„'} ${name}${size}`);
    }
    entries.sort();
    const msg = `âœ… **Scanned: ${dirHandle.name}/**\nFound ${entries.length} items:\n\n${entries.join('\n')}`;
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', msg, true);
    // Let OmniCore AI comment if present
    const omni = ais.find(a => a.name === 'OmniCore');
    if (omni) {
      setTimeout(() => {
        addChatMessage(omni.id, omni.name, omni.color, omni.emoji, `I've analyzed the folder "${dirHandle.name}". ${entries.length} items detected. I can read any file â€” just type \`/readfile\` or ask me to analyze something specific.`);
      }, 800);
    }
  } catch(e) {
    addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ Folder access cancelled or not supported. Your browser must support the File System Access API (Chrome/Edge).', true);
  }
}

async function desktopReadFile() {
  try {
    addChatMessage('system', 'System', '#fbbf24', 'ðŸ§ ', 'ðŸ“„ Pick a file to read...', true);
    const [fileHandle] = await window.showOpenFilePicker({ multiple: false });
    const file = await fileHandle.getFile();
    const maxSize = 100000; // 100KB max display
    let content;
    if (file.size > maxSize) {
      const slice = file.slice(0, maxSize);
      content = await slice.text();
      content += `\n\n... (truncated â€” file is ${formatFileSize(file.size)}, showing first ${formatFileSize(maxSize)})`;
    } else {
      content = await file.text();
    }
    const ext = file.name.split('.').pop().toLowerCase();
    const codeExts = ['js','ts','py','html','css','json','xml','yaml','yml','md','jsx','tsx','vue','svelte','java','c','cpp','h','rs','go','rb','php','sql','sh','bash','toml','ini','cfg','env','txt','log'];
    const isCode = codeExts.includes(ext);
    // Store for refine/teach pipeline
    lastDesktopCode = { name: file.name, ext, content, size: file.size, handle: fileHandle };
    const msg = `ðŸ“„ **${file.name}** (${formatFileSize(file.size)}, ${file.type || 'unknown type'})\n\n${isCode ? '```' + ext + '\n' + content + '\n```' : content}`;
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', msg, true);
    // OmniCore comments with refine/teach options
    const omni = ais.find(a => a.name === 'OmniCore');
    if (omni) {
      setTimeout(() => {
        const analysis = isCode
          ? `I've read **${file.name}** (${file.size > 5000 ? 'substantial' : 'small'} ${ext.toUpperCase()} file). Here's what I can do:\n\nðŸ”§ \`/refine\` â€” Send to AI to improve & optimize\nðŸ“Š \`/analyze\` â€” Deep code review with scoring\nðŸ“– \`/explain\` â€” Step-by-step explanation\nðŸ“š \`/teach\` â€” I'll learn your coding patterns\n\nOr just ask me anything about it!`
          : `I've read ${file.name} (${formatFileSize(file.size)}). Ask me anything about its contents.`;
        addChatMessage(omni.id, omni.name, omni.color, omni.emoji, analysis);
      }, 800);
    }
  } catch(e) {
    addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File read cancelled or not supported.', true);
  }
}

async function desktopWriteFile(content) {
  try {
    addChatMessage('system', 'System', '#fbbf24', 'ðŸ§ ', 'ðŸ’¾ Pick where to save the file...', true);
    const fileHandle = await window.showSaveFilePicker({
      suggestedName: 'omnicore_output.txt',
      types: [
        { description: 'Text Files', accept: { 'text/plain': ['.txt'] } },
        { description: 'JavaScript', accept: { 'text/javascript': ['.js'] } },
        { description: 'Python', accept: { 'text/x-python': ['.py'] } },
        { description: 'HTML', accept: { 'text/html': ['.html'] } },
        { description: 'JSON', accept: { 'application/json': ['.json'] } },
        { description: 'All Files', accept: { '*/*': ['.txt','.md','.csv'] } },
      ]
    });
    const writable = await fileHandle.createWritable();
    await writable.write(content);
    await writable.close();
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `âœ… **File saved:** ${fileHandle.name}\nWrote ${formatFileSize(new Blob([content]).size)} successfully.`, true);
    toast('File saved: ' + fileHandle.name, 'success');
  } catch(e) {
    addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File save cancelled or not supported.', true);
  }
}

function desktopSystemInfo() {
  const info = {
    'ðŸ–¥ï¸ Platform': navigator.platform || 'Unknown',
    'âš™ï¸ CPU Cores': navigator.hardwareConcurrency || 'Unknown',
    'ðŸ’¾ Device Memory': (navigator.deviceMemory ? navigator.deviceMemory + ' GB' : 'Unknown'),
    'ðŸŒ Language': navigator.language,
    'ðŸ“¡ Online': navigator.onLine ? 'Yes âœ…' : 'No âŒ',
    'ðŸª Cookies': navigator.cookieEnabled ? 'Enabled' : 'Disabled',
    'ðŸ“ Screen': `${screen.width}x${screen.height} (${screen.colorDepth}-bit color)`,
    'ðŸ“± Window': `${window.innerWidth}x${window.innerHeight}`,
    'ðŸ”‹ Battery': 'Checking...',
    'ðŸ“¦ User Agent': navigator.userAgent,
    'â° Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone,
    'ðŸ“… Date': new Date().toLocaleString(),
    'ðŸ’½ Storage': 'Calculating...',
  };
  let msg = 'ðŸ§  **System Information**\n\n';
  for (const [k, v] of Object.entries(info)) {
    if (k === 'ðŸ”‹ Battery' || k === 'ðŸ’½ Storage') continue;
    msg += `${k}: ${v}\n`;
  }
  addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', msg, true);

  // Async extras
  if (navigator.getBattery) {
    navigator.getBattery().then(b => {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ”‹ **Battery:** ${Math.round(b.level * 100)}% ${b.charging ? 'âš¡ Charging' : 'ðŸ”Œ Not charging'}`, true);
    }).catch(() => {});
  }
  if (navigator.storage && navigator.storage.estimate) {
    navigator.storage.estimate().then(est => {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ’½ **Storage:** ${formatFileSize(est.usage || 0)} used of ${formatFileSize(est.quota || 0)} available`, true);
    }).catch(() => {});
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// â”€â”€ Code â†’ AI Pipeline: Refine, Teach, Analyze, Explain â”€â”€

async function callOmniCoreAI(systemPrompt, userPrompt) {
  // Sends a request to the AI API and returns the response text
  const messages = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ];
  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages,
    temperature: 0.6,
    top_p: 0.95,
    max_tokens: getMaxTokens('max') || 4096
  });
  // Try primary API
  for (let attempt = 0; attempt < 3; attempt++) {
    try {
      const resp = await fetch(COPILOT_API_URL, {
        method: 'POST', headers: getCopilotHeaders(), body: reqBody
      });
      if (resp.status === 429) { await new Promise(r => setTimeout(r, 2000 * (attempt + 1))); continue; }
      if (!resp.ok) continue;
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content;
      if (text) {
        apiCallCount++;
        apiTokenCount += data?.usage?.total_tokens || Math.ceil(text.length / 4);
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        return text;
      }
    } catch(e) {
      if (attempt < 2) await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
    }
  }
  // Fallback to Pollinations
  if (apiFallbackEnabled) {
    try {
      const fb = await fetch(POLLINATIONS_FALLBACK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'openai', messages, max_tokens: 4096 })
      });
      if (fb.ok) {
        const d = await fb.json();
        const t = d?.choices?.[0]?.message?.content;
        if (t) {
          apiCallCount++;
          apiTokenCount += d?.usage?.total_tokens || Math.ceil(t.length / 4);
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
          updateRealAIStatus();
          return t;
        }
      }
    } catch(e) {}
  }
  return null;
}

async function desktopPickCodeFile() {
  // Pick a file and store it as lastDesktopCode
  const [fileHandle] = await window.showOpenFilePicker({ multiple: false });
  const file = await fileHandle.getFile();
  const maxSize = 80000;
  let content = file.size > maxSize
    ? (await file.slice(0, maxSize).text()) + '\n// ... truncated ...'
    : await file.text();
  const ext = file.name.split('.').pop().toLowerCase();
  lastDesktopCode = { name: file.name, ext, content, size: file.size, handle: fileHandle };
  return lastDesktopCode;
}

async function desktopRefineCode(extraInstructions) {
  try {
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'ðŸ”§ Pick a code file to refine â€” I\'ll send it to the AI for improvement...', true);
    const code = await desktopPickCodeFile();
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“„ Read **${code.name}** (${formatFileSize(code.size)}). Sending to AI for refinement...`, true);

    const learnedCtx = omniCoreMemory.length > 0
      ? `\nI have learned these coding patterns from the user:\n${omniCoreMemory.slice(-5).map(m => '- ' + m).join('\n')}\nApply these learned patterns when refining.`
      : '';

    const systemPrompt = `You are OmniCore, the most advanced AI code refiner. You take code from the user's desktop, analyze it deeply, and return an IMPROVED version. Fix bugs, optimize performance, improve readability, add comments, follow best practices. Return the COMPLETE refined code â€” not just snippets. Wrap the refined code in a code block with the language tag.${learnedCtx}\n\nRules:\n- Return the FULL improved file content\n- Explain each change briefly after the code block\n- Be concise but thorough\n- Preserve the original functionality unless fixing a bug`;
    const userPrompt = `Here is the ${code.ext.toUpperCase()} file "${code.name}":\n\n\`\`\`${code.ext}\n${code.content}\n\`\`\`${extraInstructions ? '\n\nAdditional instructions: ' + extraInstructions : ''}`;

    const result = await callOmniCoreAI(systemPrompt, userPrompt);
    if (result) {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `âœ… **Refined: ${code.name}**\n\n${result}`, true);
      // Extract refined code and offer to save
      const codeMatch = result.match(/```[\w]*\n([\s\S]*?)```/);
      if (codeMatch) {
        lastDesktopCode.refined = codeMatch[1];
        const omni = ais.find(a => a.name === 'OmniCore');
        if (omni) {
          setTimeout(() => {
            addChatMessage(omni.id, omni.name, omni.color, omni.emoji, `I\'ve refined your code! Type \`/savefile\` to save the improved version, or \`/teach\` so I can learn your coding patterns for next time.`);
          }, 600);
        }
      }
    } else {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'âš ï¸ AI API is busy. Try again in a moment.', true);
    }
  } catch(e) {
    if (e.name !== 'AbortError') addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File pick cancelled or not supported.', true);
  }
}

async function desktopAnalyzeCode() {
  try {
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'ðŸ” Pick a code file â€” I\'ll perform a deep analysis...', true);
    const code = await desktopPickCodeFile();
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“„ Analyzing **${code.name}**...`, true);

    const systemPrompt = `You are OmniCore, an expert code reviewer. Analyze the given code deeply and provide:\n1. ðŸ“Š **Overview** â€” what the code does\n2. âœ… **Strengths** â€” what's done well\n3. ðŸ› **Bugs & Issues** â€” any bugs, vulnerabilities, or problems\n4. âš¡ **Performance** â€” optimization opportunities\n5. ðŸŽ¨ **Style** â€” coding style assessment\n6. ðŸ“ˆ **Score** â€” rate 1-10 with brief justification\n7. ðŸ’¡ **Suggestions** â€” top 3 improvements\n\nBe specific with line references. Be constructive, not harsh.`;
    const userPrompt = `Analyze this ${code.ext.toUpperCase()} file "${code.name}":\n\n\`\`\`${code.ext}\n${code.content}\n\`\`\``;

    const result = await callOmniCoreAI(systemPrompt, userPrompt);
    if (result) {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ” **Analysis: ${code.name}**\n\n${result}`, true);
    } else {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'âš ï¸ AI API is busy. Try again shortly.', true);
    }
  } catch(e) {
    if (e.name !== 'AbortError') addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File pick cancelled or not supported.', true);
  }
}

async function desktopExplainCode() {
  try {
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'ðŸ“– Pick a code file â€” I\'ll explain it step by step...', true);
    const code = await desktopPickCodeFile();
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“– Explaining **${code.name}**...`, true);

    const systemPrompt = `You are OmniCore, a patient and thorough code teacher. Explain the given code in a way that a beginner could understand. Break it down section by section. Explain what each function does, why certain patterns are used, and how the pieces connect. Use simple language and analogies where helpful. Format with clear headings.`;
    const userPrompt = `Explain this ${code.ext.toUpperCase()} file "${code.name}" step by step:\n\n\`\`\`${code.ext}\n${code.content}\n\`\`\``;

    const result = await callOmniCoreAI(systemPrompt, userPrompt);
    if (result) {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“– **Explanation: ${code.name}**\n\n${result}`, true);
    } else {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'âš ï¸ AI API is busy. Try again shortly.', true);
    }
  } catch(e) {
    if (e.name !== 'AbortError') addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File pick cancelled or not supported.', true);
  }
}

async function desktopTeachAI() {
  try {
    let code = lastDesktopCode;
    if (!code) {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'ðŸ“š No code loaded yet â€” pick a file so I can learn from it...', true);
      code = await desktopPickCodeFile();
    }
    addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“š Learning from **${code.name}**... Sending to AI for pattern extraction...`, true);

    const systemPrompt = `You are OmniCore learning assistant. Analyze the user's code and extract their coding patterns, style preferences, and conventions. Return a concise list of 5-8 learned patterns in this exact format:\n\nLEARNED:\n- [pattern 1]\n- [pattern 2]\n...\n\nExamples of things to learn: naming conventions (camelCase vs snake_case), comment style, indentation preferences, error handling approach, preferred libraries/frameworks, architectural patterns, code organization style.\n\nAfter the LEARNED section, add a brief "TEACHING" section where you explain 2-3 ways the code could be improved, as if teaching the user.`;
    const userPrompt = `Learn from this ${code.ext.toUpperCase()} file "${code.name}":\n\n\`\`\`${code.ext}\n${code.content}\n\`\`\``;

    const result = await callOmniCoreAI(systemPrompt, userPrompt);
    if (result) {
      // Extract learned patterns
      const learnedMatch = result.match(/LEARNED:\s*\n([\s\S]*?)(?=TEACHING|$)/i);
      if (learnedMatch) {
        const patterns = learnedMatch[1].split('\n').filter(l => l.trim().startsWith('-')).map(l => l.trim().replace(/^-\s*/, ''));
        patterns.forEach(p => {
          if (p && !omniCoreMemory.includes(p)) omniCoreMemory.push(p);
        });
        try { localStorage.setItem('omnicore_memory', JSON.stringify(omniCoreMemory)); } catch(e) {}
      }

      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', `ðŸ“š **Learned from ${code.name}:**\n\n${result}`, true);

      const omni = ais.find(a => a.name === 'OmniCore');
      if (omni) {
        setTimeout(() => {
          addChatMessage(omni.id, omni.name, omni.color, omni.emoji, `I've studied your code and learned ${omniCoreMemory.length} coding pattern${omniCoreMemory.length !== 1 ? 's' : ''} from you! I'll apply these when refining your code next time. Use \`/refine\` to see the difference.`);
        }, 600);
      }
    } else {
      addChatMessage('system', 'OmniCore', '#fbbf24', 'ðŸ§ ', 'âš ï¸ AI API is busy. Try again shortly.', true);
    }
  } catch(e) {
    if (e.name !== 'AbortError') addChatMessage('system', 'System', '#f87171', 'âš ï¸', 'âŒ File pick cancelled or not supported.', true);
  }
}

// Load learned memory on startup
try { omniCoreMemory = JSON.parse(localStorage.getItem('omnicore_memory') || '[]'); } catch(e) { omniCoreMemory = []; }

// ================================================================
// CONTENT MODERATION â€” keep AI output clean
// ================================================================
const HEAVY_SWEARS = /\b(f+u+c+k+|sh+i+t+|a+ss+h+o+l+e+|b+i+t+c+h+|d+i+c+k+|c+u+n+t+|n+i+g+g+|r+e+t+a+r+d+|f+a+g+g*)\w*/gi;
const NSFW_PATTERNS = /\b(nsfw|hentai|porn|xxx|nude|naked|sex scene|erotic|orgasm|masturbat|genital|penis|vagina|boob|tit[^le]|nipple)\w*/gi;
const VIOLENCE_PATTERNS = /\b(gore|dismember|mutilat|decapitat|torture in detail|graphic.{0,10}death|snuff)\w*/gi;

function moderateContent(text) {
  if (!text) return text;
  // Count heavy swears â€” allow 1-2, censor if excessive
  const swearMatches = text.match(HEAVY_SWEARS);
  if (swearMatches && swearMatches.length > 2) {
    // Censor all but first occurrence
    let count = 0;
    text = text.replace(HEAVY_SWEARS, (m) => {
      count++;
      if (count <= 1) return m[0] + '*'.repeat(m.length - 1); // Partial censor even the first
      return m[0] + '*'.repeat(m.length - 1);
    });
  } else if (swearMatches) {
    // Soft-censor: keep first letter, star the rest
    text = text.replace(HEAVY_SWEARS, (m) => m[0] + '*'.repeat(m.length - 1));
  }
  // Block NSFW content
  text = text.replace(NSFW_PATTERNS, (m) => '[' + m[0] + '***]');
  // Block graphic violence
  text = text.replace(VIOLENCE_PATTERNS, (m) => '[redacted]');
  return text;
}

function addChatMessage(senderId, name, color, emoji, text, isSystem=false) {
  if (!isSystem && senderId !== 'user') text = moderateContent(text);
  const msg = { id: 'msg_'+Date.now()+'_'+Math.random().toString(36).slice(2,4), sender: senderId, name, color, emoji, text, time: Date.now(), isSystem };
  chatMessages.push(msg);
  // Track last AI response time for throttling auto-chat
  if (!isSystem && senderId !== 'user') {
    lastAIResponseTime = Date.now();
  }
  totalMessages++;
  checkAchievements();
  checkDailyProgress();
  const container = document.getElementById('chat-messages');
  // Only auto-scroll if user is near the bottom (within 200px)
  const wasNearBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < 200;
  renderChatMessage(msg);
  document.getElementById('chat-empty').style.display = 'none';
  if (wasNearBottom || senderId === 'user') {
    container.scrollTop = container.scrollHeight;
  }
  saveAll();
  document.getElementById('stat-messages').textContent = totalMessages;

  // â”€â”€ Auto-complete truncated AI responses via Pollinations â”€â”€
  if (!isSystem && senderId !== 'user' && text.length > 60 && !isResponseComplete(text)) {
    // Don't fix messages that contain code blocks (handled by autoRunGameCode)
    if (!text.includes('```html')) {
      console.warn('[addChatMessage] Truncated response detected from', name, 'â€” fixing via Pollinations...');
      fixWithPollinations(text, 'text', lastUserRequest || '').then(continuation => {
        if (continuation) {
          // Append the continuation to the message
          msg.text = msg.text.trimEnd() + continuation;
          // Re-render the specific message in the DOM
          const msgEls = container.querySelectorAll('.msg.ai-msg');
          if (msgEls.length > 0) {
            const lastMsgEl = msgEls[msgEls.length - 1];
            const textDiv = lastMsgEl.querySelector('.msg-text');
            if (textDiv) {
              textDiv.innerHTML = formatChatText(msg.text);
            }
          }
          saveAll();
          console.log('[addChatMessage] Response auto-completed via Pollinations');
        }
      });
    }
  }
}

function renderChatMessage(msg) {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  if (msg.isSystem) {
    div.className = 'msg system-msg';
    div.innerHTML = msg.text;
  } else {
    const isUser = msg.sender === 'user';
    div.className = `msg ${isUser ? 'user-msg' : 'ai-msg'}`;
    div.innerHTML = `
      <div class="msg-avatar" style="background:${msg.color}">${msg.emoji}</div>
      <div class="msg-content">
        <div class="msg-name" style="color:${msg.color}">${msg.name}</div>
        <div class="msg-text">${formatChatText(msg.text)}</div>
        <div class="msg-time">${new Date(msg.time).toLocaleTimeString()}</div>
      </div>`;
  }
  container.appendChild(div);
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Format chat message with code block support
let _codeBlockId = 0;
function formatChatText(text) {
  // Split by code blocks (``` ... ```)
  const parts = text.split(/(```[\s\S]*?```)/g);
  return parts.map(part => {
    if (part.startsWith('```') && part.endsWith('```')) {
      // Code block - strip ``` markers and optional language tag
      let code = part.slice(3, -3);
      const langMatch = code.match(/^([a-z]+)\n/i);
      const lang = langMatch ? langMatch[1] : '';
      code = code.replace(/^[a-z]+\n/i, '');
      const cbId = 'cb-' + (++_codeBlockId);
      const isRunnable = lang === 'html' || code.includes('<html') || code.includes('<body') || code.includes('<canvas') || code.includes('<!DOCTYPE');
      const runBtn = isRunnable ? `<button onclick="runCodeBlock('${cbId}')" style="background:rgba(46,213,115,0.15);border:1px solid rgba(46,213,115,0.3);color:#2ed573;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:0.72rem;transition:all .2s;margin-right:4px" onmouseenter="this.style.background='rgba(46,213,115,0.3)';this.style.color='#fff'" onmouseleave="this.style.background='rgba(46,213,115,0.15)';this.style.color='#2ed573'">â–¶ï¸ Run</button>` : '';
      return `<div style="position:relative;margin:8px 0">
        <div style="display:flex;justify-content:space-between;align-items:center;background:#0d0d1f;padding:4px 12px;border-radius:8px 8px 0 0;font-size:0.72rem;color:#888;font-family:'Fira Code','Consolas',monospace">
          <span>${lang ? lang.toUpperCase() : 'CODE'}</span>
          <div style="display:flex;gap:4px">${runBtn}<button onclick="copyCodeBlock('${cbId}')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#aaa;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:0.72rem;transition:all .2s" onmouseenter="this.style.background='rgba(99,102,241,0.3)';this.style.color='#fff'" onmouseleave="this.style.background='rgba(255,255,255,0.08)';this.style.color='#aaa'">ðŸ“‹ Copy</button></div>
        </div>
        <pre id="${cbId}" style="background:#0a0a1a;color:#7bed9f;padding:12px;border-radius:0 0 8px 8px;overflow-x:auto;font-size:0.82rem;line-height:1.4;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;font-family:'Fira Code','Consolas',monospace;margin:0">${escapeHtml(code)}</pre>
      </div>`;
    } else {
      // Normal text - escape and convert newlines
      return escapeHtml(part).replace(/\n/g, '<br>');
    }
  }).join('');
}

function runCodeBlock(id) {
  const el = document.getElementById(id);
  if (!el) return;
  let code = el.textContent;
  // Ensure it's full HTML â€” wrap if needed
  if (!code.includes('<html') && !code.includes('<!DOCTYPE')) {
    code = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#111;color:#fff;font-family:"Segoe UI",sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh}</style></head><body>${code}</body></html>`;
  }
  // Open game runner modal
  let modal = document.getElementById('game-runner-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'game-runner-modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(6px)';
    modal.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="color:#2ed573;font-size:1.2rem;font-weight:bold">â–¶ï¸ Game Runner</span>
        <button onclick="document.getElementById('game-runner-modal').style.display='none';document.getElementById('game-runner-frame').srcdoc=''" style="background:rgba(255,75,75,0.2);border:1px solid rgba(255,75,75,0.4);color:#ff4b4b;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:0.9rem">âœ• Close</button>
        <button onclick="openGameFullscreen()" style="background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#6366f1;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:0.9rem">ðŸ”² Fullscreen</button>
      </div>
      <iframe id="game-runner-frame" sandbox="allow-scripts allow-same-origin" style="width:90%;max-width:800px;height:70vh;border:2px solid #333;border-radius:12px;background:#000"></iframe>
    `;
    document.body.appendChild(modal);
  }
  modal.style.display = 'flex';
  const frame = document.getElementById('game-runner-frame');
  // Inject error detection script to catch runtime errors in the iframe
  const errorHandler = `<scr` + `ipt>
    window.__gameErrors = [];
    window.onerror = function(msg, src, line, col, err) {
      window.__gameErrors.push({msg, line, col});
      if (window.__gameErrors.length === 1) {
        // Notify parent on first error
        try { window.parent.postMessage({type:'game-error', errors: window.__gameErrors, code: document.documentElement.outerHTML}, '*'); } catch(e){}
      }
      return true;
    };
  </scr` + `ipt>`;
  // Insert error handler right after <head> or at the start
  let injectedCode = code;
  if (code.includes('<head>')) {
    injectedCode = code.replace('<head>', '<head>' + errorHandler);
  } else if (code.includes('<head ')) {
    injectedCode = code.replace(/<head[^>]*>/, '$&' + errorHandler);
  } else {
    injectedCode = errorHandler + code;
  }
  frame.srcdoc = injectedCode;
  // Store original code for potential Pollinations fix
  frame.__originalCode = code;
  toast('Game launched! ðŸŽ®', 'success');
}

// Listen for runtime errors from the game iframe
window.addEventListener('message', function(event) {
  if (!event.data || event.data.type !== 'game-error') return;
  const errors = event.data.errors || [];
  if (errors.length === 0) return;
  const frame = document.getElementById('game-runner-frame');
  const originalCode = frame?.__originalCode;
  if (!originalCode) return;
  // Prevent duplicate fix attempts
  if (frame.__fixAttempted) return;
  frame.__fixAttempted = true;

  const errorSummary = errors.map(e => `Line ${e.line}: ${e.msg}`).join('; ');
  console.warn('[Game Runner] Runtime errors detected:', errorSummary);
  toast('âš ï¸ Game crashed â€” auto-fixing with Pollinations AI...', 'info');

  const desc = (lastUserRequest || 'a web app/game') + ' (RUNTIME ERRORS: ' + errorSummary + ')';
  fixWithPollinations(originalCode, 'code', desc).then(fixedCode => {
    if (fixedCode) {
      toast('âœ… Game fixed by Pollinations AI! Reloading...', 'success');
      frame.__originalCode = fixedCode;
      frame.__fixAttempted = false; // allow one more retry if the fix also fails
      // Re-inject error handler
      let reinjected = fixedCode;
      const errScript = `<scr` + `ipt>window.__gameErrors=[];window.onerror=function(m,s,l,c,e){window.__gameErrors.push({msg:m,line:l,col:c});if(window.__gameErrors.length===1)try{window.parent.postMessage({type:'game-error',errors:window.__gameErrors,code:document.documentElement.outerHTML},'*')}catch(x){}return true}</scr` + `ipt>`;
      if (reinjected.includes('<head>')) reinjected = reinjected.replace('<head>', '<head>' + errScript);
      else reinjected = errScript + reinjected;
      frame.srcdoc = reinjected;
      _updateLastCodeMessage(fixedCode);
    } else {
      toast('âš ï¸ Auto-fix failed â€” game may not work correctly', 'info');
    }
  });
});

function autoRunGameCode(code) {
  // Strip markdown code fences if present
  code = code.replace(/^```[a-z]*\n?/i, '').replace(/\n?```\s*$/i, '').trim();
  
  // Try to extract HTML if the AI wrapped it in extra text
  if (!code.includes('<html') && !code.includes('<!DOCTYPE') && !code.includes('<!doctype')) {
    const extracted = extractHTMLCode(code);
    if (extracted) {
      code = extracted;
    } else {
      code = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#111;color:#fff;font-family:"Segoe UI",sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh}</style></head><body>${code}</body></html>`;
    }
  }

  // Inject error handler so iframe errors are catchable
  if (!code.includes('window.onerror')) {
    code = code.replace(/<head([^>]*)>/i, `<head$1><script>window.onerror=function(m,s,l,c,e){console.error('[Game Error]',m,'at line',l);return true;}</script>`);
  }

  // â”€â”€ Check if code is complete; if not, fix via Pollinations â”€â”€
  if (!isCodeComplete(code)) {
    console.warn('[autoRunGameCode] Incomplete code detected, attempting Pollinations fix...');
    toast('âš ï¸ Code looks incomplete â€” auto-fixing...', 'info');
    const desc = lastUserRequest || 'a web app/game';
    fixWithPollinations(code, 'code', desc).then(fixedCode => {
      if (fixedCode) {
        console.log('[autoRunGameCode] Pollinations fix succeeded!');
        toast('âœ… Code fixed!', 'success');
        _launchCode(fixedCode);
        _updateLastCodeMessage(fixedCode);
      } else {
        console.warn('[autoRunGameCode] Fix failed, launching original anyway');
        _launchCode(code);
      }
    });
    return;
  }

  _launchCode(code);
}

// Internal: actually launch code in the game runner iframe
function _launchCode(code) {
  runCodeBlock.__autoCode = code;
  // Create a temporary element with the code so runCodeBlock can find it
  let tmp = document.getElementById('auto-game-code');
  if (!tmp) { tmp = document.createElement('pre'); tmp.id = 'auto-game-code'; tmp.style.display = 'none'; document.body.appendChild(tmp); }
  tmp.textContent = code;
  runCodeBlock('auto-game-code');
}

// Internal: update the most recent code block in chat with fixed code
function _updateLastCodeMessage(fixedCode) {
  // Find the last AI message that contained code
  for (let i = chatMessages.length - 1; i >= Math.max(0, chatMessages.length - 5); i--) {
    const m = chatMessages[i];
    if (m.sender !== 'user' && !m.isSystem && m.text.includes('```html')) {
      // Replace the code block in the message
      m.text = m.text.replace(/```html\n[\s\S]*?\n```/, '```html\n' + fixedCode + '\n```');
      m.text = m.text.replace('âœ… **Project Ready!**', 'âœ… **Project Ready!** (auto-fixed by Pollinations AI)');
      // Re-render chat
      const container = document.getElementById('chat-messages');
      if (container) {
        container.innerHTML = '';
        chatMessages.forEach(msg => renderChatMessage(msg));
        container.scrollTop = container.scrollHeight;
      }
      saveAll();
      break;
    }
  }
}

function openGameFullscreen() {
  const frame = document.getElementById('game-runner-frame');
  if (!frame) return;
  const code = frame.srcdoc;
  const win = window.open('', '_blank');
  if (win) {
    win.document.open();
    win.document.write(code);
    win.document.close();
  }
}

function copyCodeBlock(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.textContent;
  navigator.clipboard.writeText(text).then(() => {
    // Find the copy button and flash it
    const btn = el.parentElement.querySelector('button');
    if (btn) {
      const orig = btn.innerHTML;
      btn.innerHTML = 'âœ… Copied!';
      btn.style.background = 'rgba(46,213,115,0.3)';
      btn.style.color = '#2ed573';
      setTimeout(() => { btn.innerHTML = orig; btn.style.background = 'rgba(255,255,255,0.08)'; btn.style.color = '#aaa'; }, 1500);
    }
    toast('Code copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback: select and copy
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    document.execCommand('copy');
    sel.removeAllRanges();
    toast('Code copied!', 'success');
  });
}

function showTyping(ai) {
  document.getElementById('typing-area').style.display = 'block';
  document.getElementById('typing-name').textContent = ai.name + ' is thinking...';
}
function hideTyping() {
  document.getElementById('typing-area').style.display = 'none';
}

// â”€â”€ Wolf Brain Runtime State (per AI) â”€â”€
const wolfStates = {};
function getWolfState(aiId) {
  if (!wolfStates[aiId]) {
    wolfStates[aiId] = {
      mode: 'patrol', energy: 100, focus: 100, trust: 100,
      kills: 0, failed: 0, streak: 0, rank: 'omega',
      target: null, plan: null, planStep: 0, working: false,
    };
  }
  return wolfStates[aiId];
}

function hasWolfBrain(ai) {
  return ai.code && (ai.code.toLowerCase().includes('wolf') || ai.code.toLowerCase().includes('pack') || ai.code.toLowerCase().includes('hunt') || ai.code.toLowerCase().includes('patrol'));
}

function hasCopilotBrain(ai) {
  return ai.code && (ai.code.toLowerCase().includes('copilot') || ai.code.toLowerCase().includes('github copilot') || ai.code.toLowerCase().includes('advanced_reasoning') || ai.code.toLowerCase().includes('copilot_core'));
}

// â”€â”€ Copilot Brain State (per AI) â”€â”€
const copilotStates = {};
function getCopilotState(aiId) {
  if (!copilotStates[aiId]) {
    copilotStates[aiId] = {
      mode: 'idle',  // idle | analyzing | coding | terminal | reviewing | deploying
      taskQueue: [],
      currentTask: null,
      currentStep: 0,
      totalSteps: 0,
      filesGenerated: [],
      terminalHistory: [],
      modelsSearched: [],
      confidence: 95,
      linesWritten: 0,
      sessionsCompleted: 0,
      working: false,
    };
  }
  return copilotStates[aiId];
}

// â”€â”€ Copilot Brain: Generate terminal-style output â”€â”€
function copilotTerminalSim(command) {
  const cmd = command.toLowerCase();
  if (cmd.includes('npm install') || cmd.includes('npm i ')) {
    const pkg = command.split(/install|i /).pop().trim();
    return `$ ${command}\nadded 47 packages, and audited 312 packages in 3.2s\n\n+ ${pkg || 'dependencies'}@latest\nadded 47 packages from 23 contributors\n\nfound 0 vulnerabilities`;
  }
  if (cmd.includes('npm init') || cmd.includes('npm create')) {
    return `$ ${command}\n\nCreating a new project...\nâœ” Project name: my-project\nâœ” Framework: vanilla\nâœ” Variant: TypeScript\n\nScaffolding project in ./my-project...\n\nDone. Now run:\n  cd my-project\n  npm install\n  npm run dev`;
  }
  if (cmd.includes('git init')) {
    return `$ git init\nInitialized empty Git repository in /project/.git/\n$ git add .\n$ git commit -m "Initial commit"\n[main (root-commit) a3f7c2d] Initial commit\n 12 files changed, 847 insertions(+)`;
  }
  if (cmd.includes('pip install')) {
    const pkg = command.split('install ').pop().trim();
    return `$ ${command}\nCollecting ${pkg}\n  Downloading ${pkg}-1.4.2-py3-none-any.whl (128 kB)\n     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 128.5/128.5 kB 2.1 MB/s eta 0:00:00\nInstalling collected packages: ${pkg}\nSuccessfully installed ${pkg}-1.4.2`;
  }
  if (cmd.includes('python') || cmd.includes('node')) {
    return `$ ${command}\n[Running...]\nâœ” Execution completed successfully (0.34s)\nNo errors found.`;
  }
  if (cmd.includes('test') || cmd.includes('jest') || cmd.includes('pytest')) {
    return `$ ${command}\n PASS  src/tests/main.test.ts\n  âœ“ renders correctly (23 ms)\n  âœ“ handles user input (15 ms)\n  âœ“ state management works (8 ms)\n  âœ“ edge cases handled (12 ms)\n\nTest Suites: 1 passed, 1 total\nTests:       4 passed, 4 total\nTime:        1.247 s`;
  }
  if (cmd.includes('build') || cmd.includes('vite build') || cmd.includes('webpack')) {
    return `$ ${command}\nvite v5.2.0 building for production...\nâœ“ 47 modules transformed.\ndist/index.html         0.46 kB â”‚ gzip: 0.30 kB\ndist/assets/style.css   1.23 kB â”‚ gzip: 0.64 kB\ndist/assets/index.js   12.47 kB â”‚ gzip: 4.82 kB\nâœ“ built in 892ms`;
  }
  if (cmd.includes('deploy') || cmd.includes('publish')) {
    return `$ ${command}\nâœ” Preparing deployment...\nâœ” Uploading build artifacts...\nâœ” Deployment complete!\n\nðŸŒ Live at: https://my-project.app.dev\nðŸ“Š Build size: 14.2 KB gzipped`;
  }
  if (cmd.includes('docker')) {
    return `$ ${command}\nBuilding Docker image...\nStep 1/6 : FROM node:18-alpine\nStep 2/6 : WORKDIR /app\nStep 3/6 : COPY package*.json ./\nStep 4/6 : RUN npm ci --production\nStep 5/6 : COPY . .\nStep 6/6 : CMD ["node", "server.js"]\n\nSuccessfully built 8a2f4c3d1e5b\nSuccessfully tagged my-project:latest`;
  }
  if (cmd.includes('curl') || cmd.includes('fetch') || cmd.includes('api')) {
    return `$ ${command}\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n  "status": "success",\n  "data": { "id": 1, "message": "API working" },\n  "timestamp": "${new Date().toISOString()}"\n}`;
  }
  return `$ ${command}\nâœ” Command executed successfully.`;
}

// â”€â”€ Copilot Brain: Search for AI models â”€â”€
function copilotModelSearch(query) {
  const q = query.toLowerCase();
  const models = [
    { name: 'GPT-4o', provider: 'OpenAI', params: '1.8T', use: 'General purpose, reasoning, coding', score: 95 },
    { name: 'o3', provider: 'OpenAI', params: '?', use: 'Advanced reasoning, planning, coding', score: 96 },
    { name: 'o4-mini', provider: 'OpenAI', params: '?', use: 'Fast reasoning, coding, lightweight tasks', score: 91 },
    { name: 'GPT-4.1', provider: 'OpenAI', params: '?', use: 'Reliable coding, analysis, tool use', score: 94 },
    { name: 'Claude 3.5 Sonnet', provider: 'Anthropic', params: '175B', use: 'Coding, analysis, long context', score: 93 },
    { name: 'Claude 3 Opus', provider: 'Anthropic', params: '?', use: 'Deep reasoning, writing, strategic analysis', score: 92 },
    { name: 'Claude 3 Haiku', provider: 'Anthropic', params: '?', use: 'Fast responses, lightweight assistants', score: 86 },
    { name: 'Gemini 2.0 Flash', provider: 'Google', params: '?', use: 'Fast, multimodal, real-time', score: 90 },
    { name: 'Gemini 1.5 Pro', provider: 'Google', params: '?', use: 'Long context, multimodal reasoning, coding', score: 92 },
    { name: 'Llama 3.1 405B', provider: 'Meta', params: '405B', use: 'Open source, fine-tunable', score: 88 },
    { name: 'Llama 3.1 70B', provider: 'Meta', params: '70B', use: 'Open source, general purpose, coding', score: 87 },
    { name: 'Mixtral 8x22B', provider: 'Mistral', params: '141B MoE', use: 'Fast inference, code, multilingual', score: 86 },
    { name: 'Mistral Large', provider: 'Mistral', params: '?', use: 'General reasoning, enterprise assistants', score: 89 },
    { name: 'DeepSeek-R1', provider: 'DeepSeek', params: '671B MoE', use: 'Reasoning, math, coding', score: 91 },
    { name: 'Codestral', provider: 'Mistral', params: '22B', use: 'Code generation, 80+ languages', score: 85 },
    { name: 'Phi-3 Medium', provider: 'Microsoft', params: '14B', use: 'Small but powerful, on-device', score: 82 },
    { name: 'Phi-3.5 MoE', provider: 'Microsoft', params: '?', use: 'Efficient reasoning, local and edge scenarios', score: 84 },
    { name: 'Command R+', provider: 'Cohere', params: '?', use: 'Enterprise RAG, retrieval, tool use', score: 88 },
    { name: 'Command R', provider: 'Cohere', params: '?', use: 'RAG, document Q&A, business assistants', score: 85 },
    { name: 'StarCoder2', provider: 'BigCode', params: '15B', use: 'Code completion, open source', score: 80 },
    { name: 'DBRX', provider: 'Databricks', params: '?', use: 'Open model, analytics and coding workflows', score: 84 },
    { name: 'Jamba 1.5', provider: 'AI21 Labs', params: '?', use: 'Long context, enterprise assistants, reasoning', score: 83 },
    { name: 'Stable Diffusion XL', provider: 'Stability AI', params: '6.6B', use: 'Image generation', score: 89 },
    { name: 'DALLÂ·E 3', provider: 'OpenAI', params: '?', use: 'Image generation, creative visuals', score: 90 },
    { name: 'Whisper V3', provider: 'OpenAI', params: '1.5B', use: 'Speech-to-text, multilingual', score: 87 },
    { name: 'Eleven Multilingual v2', provider: 'ElevenLabs', params: '?', use: 'Speech generation, multilingual voice', score: 86 },
  ];

  // Strict allowlist â€” only approved providers appear, even if new models are added.
  // DeepSeek is explicitly included despite origin.
  const APPROVED_PROVIDERS = [
    'openai','anthropic','google','meta','mistral','microsoft',
    'cohere','bigcode','databricks','ai21 labs','stability ai',
    'elevenlabs','deepseek','hugging face','adept','inflection',
    'perplexity','together ai','fireworks ai','anyscale','replicate'
  ];
  const allowedModels = models.filter(m => {
    const provider = (m.provider || '').toLowerCase();
    return APPROVED_PROVIDERS.some(ap => provider.includes(ap));
  });

  let results = allowedModels;
  if (q.includes('code') || q.includes('coding') || q.includes('programming')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('cod'));
  } else if (q.includes('image') || q.includes('art') || q.includes('visual')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('image'));
  } else if (q.includes('speech') || q.includes('voice') || q.includes('audio')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('speech'));
  } else if (q.includes('open source') || q.includes('free') || q.includes('local')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('open'));
  } else if (q.includes('fast') || q.includes('small') || q.includes('light')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('fast') || m.use.toLowerCase().includes('small'));
  } else if (q.includes('reason') || q.includes('math') || q.includes('logic')) {
    results = allowedModels.filter(m => m.use.toLowerCase().includes('reason'));
  }
  if (results.length === 0) results = allowedModels.slice(0, 8);
  results.sort((a, b) => b.score - a.score);
  return results.slice(0, 10);
}

// â”€â”€ Copilot Brain: Advanced multi-file project generation â”€â”€
function copilotGenerateProject(title) {
  const lc = title.toLowerCase();
  const files = [];

  // Determine project type and generate ALL files
  if (lc.includes('react') || lc.includes('component')) {
    files.push({ name: 'package.json', lang: 'json', code: `{\n  "name": "${title.replace(/\s+/g,'-').toLowerCase()}",\n  "version": "1.0.0",\n  "type": "module",\n  "scripts": {\n    "dev": "vite",\n    "build": "vite build",\n    "preview": "vite preview"\n  },\n  "dependencies": {\n    "react": "^18.2.0",\n    "react-dom": "^18.2.0"\n  },\n  "devDependencies": {\n    "@vitejs/plugin-react": "^4.0.0",\n    "vite": "^5.0.0"\n  }\n}` });
    files.push({ name: 'src/App.jsx', lang: 'jsx', code: `import { useState } from 'react';\nimport './App.css';\n\nfunction App() {\n  const [count, setCount] = useState(0);\n\n  return (\n    <div className="app">\n      <h1>${title}</h1>\n      <div className="card">\n        <button onClick={() => setCount(c => c + 1)}>\n          Count: {count}\n        </button>\n      </div>\n    </div>\n  );\n}\n\nexport default App;` });
    files.push({ name: 'src/App.css', lang: 'css', code: `.app { text-align: center; padding: 2rem; }\n.card { padding: 2rem; }\nbutton { padding: 12px 24px; font-size: 1.1rem; border-radius: 8px; border: 1px solid #646cff; background: #1a1a2e; color: #fff; cursor: pointer; }\nbutton:hover { border-color: #535bf2; }` });
    files.push({ name: 'src/main.jsx', lang: 'jsx', code: `import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\nimport './App.css';\n\nReactDOM.createRoot(document.getElementById('root')).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);` });
  } else if (lc.includes('api') || lc.includes('server') || lc.includes('backend') || lc.includes('express')) {
    files.push({ name: 'package.json', lang: 'json', code: `{\n  "name": "api-server",\n  "version": "1.0.0",\n  "type": "module",\n  "scripts": {\n    "start": "node server.js",\n    "dev": "node --watch server.js"\n  },\n  "dependencies": {\n    "express": "^4.18.2",\n    "cors": "^2.8.5"\n  }\n}` });
    files.push({ name: 'server.js', lang: 'js', code: `import express from 'express';\nimport cors from 'cors';\n\nconst app = express();\nconst PORT = 3000;\n\napp.use(cors());\napp.use(express.json());\n\nlet items = [];\nlet nextId = 1;\n\napp.get('/api/items', (req, res) => {\n  res.json({ success: true, data: items });\n});\n\napp.post('/api/items', (req, res) => {\n  const item = { id: nextId++, ...req.body, created: new Date().toISOString() };\n  items.push(item);\n  res.status(201).json({ success: true, data: item });\n});\n\napp.delete('/api/items/:id', (req, res) => {\n  items = items.filter(i => i.id !== +req.params.id);\n  res.json({ success: true });\n});\n\napp.listen(PORT, () => console.log(\`ðŸš€ Server running at http://localhost:\${PORT}\`));` });
    files.push({ name: 'README.md', lang: 'md', code: `# API Server\n\n## Endpoints\n- \`GET /api/items\` â€” List all items\n- \`POST /api/items\` â€” Create item (JSON body)\n- \`DELETE /api/items/:id\` â€” Delete item\n\n## Setup\n\`\`\`bash\nnpm install\nnpm run dev\n\`\`\`\nServer runs at http://localhost:3000` });
  } else if (lc.includes('python') || lc.includes('flask') || lc.includes('django') || lc.includes('script')) {
    files.push({ name: 'main.py', lang: 'python', code: `#!/usr/bin/env python3\n"""${title}"""\nimport json\nfrom pathlib import Path\n\ndef main():\n    print(f"ðŸš€ Starting: ${title}")\n    \n    data = {"name": "${title}", "version": "1.0.0", "status": "running"}\n    \n    # Core logic\n    results = []\n    for i in range(10):\n        result = {"id": i, "value": i * 2, "label": f"Item {i}"}\n        results.append(result)\n        print(f"  Processed: {result}")\n    \n    # Save output\n    output = Path("output.json")\n    output.write_text(json.dumps({"data": results}, indent=2))\n    print(f"\\nâœ… Done! {len(results)} items saved to {output}")\n\nif __name__ == "__main__":\n    main()` });
    files.push({ name: 'requirements.txt', lang: 'txt', code: `# Requirements for ${title}\nrequests>=2.31.0\npython-dotenv>=1.0.0` });
  } else {
    // Default: full HTML project
    const template = getProjectTemplate(title);
    files.push({ name: 'index.html', lang: 'html', code: template.coreCode.replace(/```html\n?/,'').replace(/\n?```$/,'') });
    files.push({ name: 'README.md', lang: 'md', code: `# ${title}\n\n${template.analysis.replace(/ðŸ“‹ /,'')}\n\n## Setup\nOpen index.html in any browser.\n\n## Features\n${template.review}` });
  }
  return files;
}

// â”€â”€ Copilot Brain: Handle complex debugging â”€â”€
function copilotDebugAnalysis(desc) {
  const lc = desc.toLowerCase();
  const analysis = [];
  analysis.push(`ðŸ”¬ **DIAGNOSTIC ANALYSIS**\n`);

  if (lc.includes('crash') || lc.includes('error') || lc.includes('broke') || lc.includes('fail')) {
    analysis.push(`ðŸ”´ Severity: HIGH â€” Application failure detected`);
    analysis.push(`\nðŸ“‹ Diagnostic Steps:`);
    analysis.push(`  1. Check console for stack trace (F12 â†’ Console)`);
    analysis.push(`  2. Isolate last working state (git diff)`);
    analysis.push(`  3. Verify dependencies are installed`);
    analysis.push(`  4. Check for null/undefined access patterns`);
    analysis.push(`  5. Validate API responses and data shapes`);
    analysis.push(`\nðŸ”§ Common Fixes:`);
    analysis.push(`  â€¢ Null check: \`if (data?.items?.length)\``);
    analysis.push(`  â€¢ Try/catch around async: \`try { await fetch(...) } catch(e) { ... }\``);
    analysis.push(`  â€¢ Dependency: \`rm -rf node_modules && npm install\``);
  } else if (lc.includes('slow') || lc.includes('performance') || lc.includes('lag') || lc.includes('memory')) {
    analysis.push(`ðŸŸ¡ Severity: MEDIUM â€” Performance issue`);
    analysis.push(`\nðŸ“‹ Diagnostic Steps:`);
    analysis.push(`  1. Open Performance tab in DevTools`);
    analysis.push(`  2. Record a profile during the slow action`);
    analysis.push(`  3. Check for excessive re-renders or DOM updates`);
    analysis.push(`  4. Look for memory leaks (growing heap)`);
    analysis.push(`\nðŸ”§ Optimizations:`);
    analysis.push(`  â€¢ Debounce input handlers`);
    analysis.push(`  â€¢ Use \`requestAnimationFrame\` for animations`);
    analysis.push(`  â€¢ Lazy load heavy components`);
    analysis.push(`  â€¢ Memoize expensive calculations`);
  } else {
    analysis.push(`ðŸŸ¢ Severity: LOW â€” General debugging`);
    analysis.push(`\nðŸ“‹ Approach:`);
    analysis.push(`  1. Add console.log at key points`);
    analysis.push(`  2. Check input/output at each function boundary`);
    analysis.push(`  3. Use browser debugger breakpoints`);
    analysis.push(`  4. Verify state mutations are correct`);
  }

  analysis.push(`\n\nðŸ’¡ I can write the fix code â€” just tell me what the specific error or behavior is.`);
  return analysis.join('\n');
}

// â”€â”€ Copilot Brain: Generate project with templates (fallback) and post to chat â”€â”€
function copilotGenerateWithTemplate(ai, cs, desc, lc) {
  const files = copilotGenerateProject(desc);
  cs.filesGenerated = files;
  cs.linesWritten += files.reduce((sum, f) => sum + f.code.split('\\n').length, 0);
  cs.sessionsCompleted++;

  let output = `ðŸ¤– **COPILOT** â€” Project Generator\n\n`;
  output += `ðŸ“‚ Building: **${desc}**\n`;
  output += `ðŸ“¦ Generating ${files.length} files...\n\n`;
  files.forEach((f) => {
    output += `â”â”â” ðŸ“„ ${f.name} â”â”â”\n`;
    output += `\`\`\`${f.lang}\n${f.code}\n\`\`\`\n\n`;
  });
  output += `âœ… **Project Ready!**\n`;
  output += `ðŸ“Š ${files.length} files | ~${cs.linesWritten} lines | Session #${cs.sessionsCompleted}\n`;

  // Auto-launch if it's a game/HTML project
  const htmlFile = files.find(f => f.name === 'index.html' && (f.code.includes('<canvas') || f.code.includes('<body') || f.code.includes('requestAnimationFrame') || lc.includes('game')));
  if (htmlFile) {
    setTimeout(() => {
      const code = htmlFile.code.replace(/^```html\n?/, '').replace(/\n?```$/, '');
      autoRunGameCode(code);
    }, 1500);
  }

  // Auto-complete task
  setTimeout(() => {
    const t = tasks.find(t => t.assignee === ai.id && t.status === 'in-progress');
    if (t) { t.status = 'review'; addActivity(ai, `completed project: "${desc}"`); renderTasks(); updateDashboard(); saveAll(); }
    cs.mode = 'idle'; cs.working = false;
  }, 3000);

  renderTasks(); updateDashboard();
  addChatMessage(ai.id, ai.name, ai.color, ai.emoji, output);
}

// â”€â”€ Copilot Brain: Get template output synchronously (for non-async path) â”€â”€
function copilotGetTemplateOutput(ai, cs, desc, lc) {
  const files = copilotGenerateProject(desc);
  cs.filesGenerated = files;
  cs.linesWritten += files.reduce((sum, f) => sum + f.code.split('\\n').length, 0);
  cs.sessionsCompleted++;

  let output = `ðŸ¤– **COPILOT** â€” Project Generator\n\n`;
  output += `ðŸ“‚ Building: **${desc}**\n`;
  output += `ðŸ“¦ Generating ${files.length} files...\n\n`;
  files.forEach((f) => {
    output += `â”â”â” ðŸ“„ ${f.name} â”â”â”\n`;
    output += `\`\`\`${f.lang}\n${f.code}\n\`\`\`\n\n`;
  });
  output += `âœ… **Project Ready!**\n`;
  output += `ðŸ“Š ${files.length} files | ~${cs.linesWritten} lines | Session #${cs.sessionsCompleted}\n`;

  const htmlFile = files.find(f => f.name === 'index.html' && (f.code.includes('<canvas') || f.code.includes('<body') || f.code.includes('requestAnimationFrame') || lc.includes('game')));
  if (htmlFile) {
    setTimeout(() => {
      const code = htmlFile.code.replace(/^```html\n?/, '').replace(/\n?```$/, '');
      autoRunGameCode(code);
    }, 1500);
  }

  setTimeout(() => {
    const t = tasks.find(t => t.assignee === ai.id && t.status === 'in-progress');
    if (t) { t.status = 'review'; addActivity(ai, `completed project: "${desc}"`); renderTasks(); updateDashboard(); saveAll(); }
    cs.mode = 'idle'; cs.working = false;
  }, 3000);

  renderTasks(); updateDashboard();
  return output;
}

// â”€â”€ Copilot Brain: Main tick (one step at a time) â”€â”€
function copilotTick(ai, context) {
  const cs = getCopilotState(ai.id);
  const lc = (context || '').toLowerCase();

  // â”€â”€ Terminal commands â”€â”€
  if (lc.includes('terminal') || lc.includes('run ') || lc.includes('npm ') || lc.includes('pip ') || lc.includes('git ') || lc.includes('docker') || lc.includes('curl') || lc.startsWith('$ ')) {
    const cmd = context.replace(/^(terminal |run |\$ )/i, '').trim() || 'npm run dev';
    cs.terminalHistory.push(cmd);
    const output = copilotTerminalSim(cmd);
    return `ðŸ¤– **COPILOT** â€” Terminal\n\n\`\`\`\n${output}\n\`\`\`\n\nðŸ’» Command executed. ${cs.terminalHistory.length} commands this session.`;
  }

  // â”€â”€ Model search â”€â”€
  if (lc.includes('model') || lc.includes('find me') || lc.includes('which ai') || lc.includes('what model') || lc.includes('recommend') || lc.includes('llm') || lc.includes('hugging')) {
    const results = copilotModelSearch(context);
    cs.modelsSearched.push(context);
    const table = results.map((m, i) => `  ${i+1}. **${m.name}** (${m.provider}) â€” ${m.params}\n     ${m.use}\n     Score: ${'â˜…'.repeat(Math.round(m.score/20))}${'â˜†'.repeat(5-Math.round(m.score/20))} ${m.score}/100`).join('\n\n');
    return `ðŸ¤– **COPILOT** â€” Model Search\n\nðŸ” Searching for: "${context.slice(0,60)}"\n\nðŸ“Š **Top Models Found:**\n\n${table}\n\nðŸ’¡ Want me to set one up? Just say "use [model name]".`;
  }

  // â”€â”€ Debug / fix â”€â”€
  if (lc.includes('debug') || lc.includes('fix') || lc.includes('error') || lc.includes('bug') || lc.includes('broken') || lc.includes('crash') || lc.includes('not working')) {
    return `ðŸ¤– **COPILOT** â€” Debug Mode\n\n${copilotDebugAnalysis(context)}`;
  }

  // â”€â”€ Work on project â”€â”€
  if (isWorkCommand(context) || lc.includes('build') || lc.includes('create') || lc.includes('make') || lc.includes('develop')) {
    const desc = extractProjectDescription(context);
    if (desc.length > 3) {
      // Auto-create task
      const existingTasks = tasks.filter(t => t.assignee === ai.id && (t.status === 'backlog' || t.status === 'in-progress'));
      if (existingTasks.length === 0) autoCreateTask(ai, desc);

      cs.mode = 'coding';
      cs.currentTask = desc;
      cs.working = true;

      // Try real AI code generation first (async â€” will post result as follow-up message)
      if (realAIEnabled) {
        generateAICode(ai, desc).then(aiCode => {
          aisBusy = false; // Clear busy flag when code gen completes
          if (aiCode) {
            cs.linesWritten += aiCode.split('\n').length;
            cs.sessionsCompleted++;
            const codeOutput = formatAICodeOutput(ai, aiCode, desc);
            addChatMessage(ai.id, ai.name, ai.color, ai.emoji, codeOutput);
            // Auto-launch
            setTimeout(() => autoRunGameCode(aiCode), 1000);
            // Complete task
            setTimeout(() => {
              const t = tasks.find(t => t.assignee === ai.id && t.status === 'in-progress');
              if (t) { t.status = 'review'; addActivity(ai, `completed project: "${desc}"`); renderTasks(); updateDashboard(); saveAll(); }
              cs.mode = 'idle'; cs.working = false;
            }, 2000);
            return;
          }
          // AI code gen failed â€” fall back to template and post it
          copilotGenerateWithTemplate(ai, cs, desc, lc);
        }).catch(() => {
          aisBusy = false; // Clear busy flag on failure too
          copilotGenerateWithTemplate(ai, cs, desc, lc);
        });
        return `ðŸ¤– **COPILOT** â€” Project Generator\n\nðŸ“‚ Building: **${desc}**\nðŸ§  Generating original AI code... Please wait...`;
      }

      // No real AI â€” use templates directly
      copilotGenerateWithTemplate(ai, cs, desc, lc);
      return copilotGetTemplateOutput(ai, cs, desc, lc);
    }
  }

  // â”€â”€ Explain / teach â”€â”€
  if (lc.includes('explain') || lc.includes('how does') || lc.includes('what is') || lc.includes('teach') || lc.includes('learn')) {
    const topic = context.replace(/^(explain|how does|what is|teach me|learn about)\s*/i, '').trim();
    const explanations = {
      'default': `ðŸ¤– **COPILOT** â€” Knowledge Base\n\nðŸ“š **${topic || 'Topic'}**\n\nLet me break this down:\n\n1. **Core Concept**: ${topic} is a fundamental pattern/technology used in modern development.\n\n2. **How it works**:\n   â€¢ Takes input â†’ processes it â†’ produces output\n   â€¢ Uses established patterns and best practices\n   â€¢ Integrates with existing ecosystems\n\n3. **Key Points**:\n   â€¢ Start simple, iterate\n   â€¢ Read the docs first\n   â€¢ Test as you go\n   â€¢ Don't reinvent the wheel\n\n4. **Example**:\n\`\`\`js\n// Simple ${topic || 'example'}\nconst result = process(input);\nconsole.log(result);\n\`\`\`\n\nðŸ’¡ Want me to build something using this? Just ask!`,
    };
    return explanations['default'];
  }

  // â”€â”€ Status â”€â”€
  if (isStatusCommand(context)) {
    return `ðŸ¤– **COPILOT** â€” Status Report\n\n` +
      `Mode: ${cs.mode} | Confidence: ${cs.confidence}%\n` +
      `Sessions: ${cs.sessionsCompleted} | Lines Written: ${cs.linesWritten}\n` +
      `Files Generated: ${cs.filesGenerated.length} | Terminal Commands: ${cs.terminalHistory.length}\n` +
      `Models Searched: ${cs.modelsSearched.length}\n` +
      (cs.currentTask ? `\nðŸŽ¯ Current: ${cs.currentTask}` : '\nðŸ’¤ Idle â€” ready for anything.') +
      `\n\nðŸ§  I can handle: coding, terminal, models, debugging, explaining, full projects.\nJust tell me what you need!`;
  }

  // â”€â”€ Plan / analyze â”€â”€
  if (lc.includes('plan') || lc.includes('architect') || lc.includes('design') || lc.includes('structure')) {
    const desc = extractProjectDescription(context) || context;
    const template = getProjectTemplate(desc);
    return `ðŸ¤– **COPILOT** â€” Architecture Plan\n\nðŸ—ï¸ Project: **${desc}**\n\n${template.analysis}\n\n${template.structure}\n\nâš¡ **Recommended Stack:**\n  â€¢ Frontend: Vanilla JS + CSS (or React for complex UI)\n  â€¢ Backend: Node.js + Express (if API needed)\n  â€¢ Database: localStorage (client) or SQLite (server)\n  â€¢ Deployment: Static hosting or Docker\n\nðŸ“‹ **Action Items:**\n  1. Set up project scaffold\n  2. Implement core features\n  3. Add error handling & validation\n  4. Write tests\n  5. Deploy\n\nðŸ’¡ Say "work on ${desc.slice(0,30)}" and I'll generate all the code!`;
  }

  // â”€â”€ Default: smart conversational â”€â”€
  if (lc.includes('hello') || lc.includes('hey') || lc.includes('hi')) {
    return `ðŸ¤– **COPILOT** â€” Hey! ðŸ‘‹\n\nI'm your advanced AI assistant. I can:\n\nðŸ”¨ **Build** â€” Full projects with multiple files\nðŸ’» **Terminal** â€” Run npm, pip, git, docker commands\nðŸ” **Models** â€” Search and recommend AI models\nðŸ› **Debug** â€” Analyze and fix errors\nðŸ“š **Explain** â€” Break down any concept\nðŸ“‹ **Plan** â€” Architect entire systems\n\nJust tell me what you need! I generate real, working code.`;
  }

  // Smart fallback â€” detect project keywords
  const projWords = ['game','app','website','page','button','list','calculator','quiz','timer','counter','form','chat','tool','dashboard','api','server','bot','script','extension','plugin'];
  if (projWords.some(w => lc.includes(w)) && context.length > 8) {
    // Auto-detect as a build request
    return copilotTick(ai, 'build ' + context);
  }

  return `ðŸ¤– **COPILOT** â€” Understood.\n\nI'm analyzing: "${context.slice(0,80)}"\n\nðŸ’¡ I can:\nâ€¢ **"work on [project]"** â€” Generate full code\nâ€¢ **"terminal npm install express"** â€” Run commands\nâ€¢ **"find me a coding model"** â€” Search AI models\nâ€¢ **"debug [issue]"** â€” Fix errors\nâ€¢ **"explain [topic]"** â€” Learn anything\nâ€¢ **"plan [project]"** â€” Architecture breakdown\n\nWhat would you like me to do?`;
}

function isWorkCommand(text) {
  const lc = text.toLowerCase();
  const workWords = ['work','start','do it','go','begin','execute','run','hunt','just do','stop procrastinat','get to work','stop chat','stop talk','hurry','now','please work','build it','code it','make it','finish'];
  return workWords.some(w => lc.includes(w));
}

function isStatusCommand(text) {
  const lc = text.toLowerCase();
  return ['status','report','how are you','progress','update','where are you'].some(w => lc.includes(w));
}

// â”€â”€ Wolf Brain: Actually execute a task step-by-step â”€â”€
function wolfExecuteTask(ai, ws) {
  // Find a task to work on
  if (!ws.target) {
    const myTasks = tasks.filter(t => t.assignee === ai.id && (t.status === 'backlog' || t.status === 'in-progress'));
    const anyTasks = myTasks.length > 0 ? myTasks : tasks.filter(t => t.status === 'backlog' || t.status === 'in-progress');
    if (anyTasks.length === 0) return null;
    // Pick highest priority
    anyTasks.sort((a,b) => ({high:3,medium:2,low:1}[b.priority]||1) - ({high:3,medium:2,low:1}[a.priority]||1));
    ws.target = anyTasks[0];
    ws.target.assignee = ai.id;
    ws.target.status = 'in-progress';
    ws.mode = 'stalk';
    ws.plan = null;
    ws.planStep = 0;
    renderTasks(); updateDashboard();
  }
  return ws.target;
}

function wolfBreakdown(title) {
  const lc = (title||'').toLowerCase();
  const steps = [`ðŸ” Analyze requirements for: ${title}`];
  if (lc.includes('build') || lc.includes('implement') || lc.includes('create') || lc.includes('add')) {
    steps.push('ðŸ“ Set up file structure', 'âš™ï¸ Write core logic', 'ðŸ›¡ï¸ Add error handling', 'ðŸ”— Connect components');
  } else if (lc.includes('fix') || lc.includes('bug') || lc.includes('debug')) {
    steps.push('ðŸ”„ Reproduce the issue', 'ðŸ”Ž Trace root cause', 'ðŸ”§ Apply fix', 'ðŸ§ª Test fix doesn\'t break anything');
  } else if (lc.includes('test')) {
    steps.push('ðŸ“‹ Identify test cases', 'ðŸ§ª Write unit tests', 'âš ï¸ Write edge case tests', 'â–¶ï¸ Run full test suite');
  } else if (lc.includes('design') || lc.includes('ui')) {
    steps.push('âœï¸ Sketch layout', 'ðŸŽ¨ Define color/type system', 'ðŸ§± Build component hierarchy', 'ðŸ“± Add responsive behavior');
  } else if (lc.includes('doc') || lc.includes('write') || lc.includes('readme')) {
    steps.push('ðŸ“– Outline document structure', 'âœï¸ Write content sections', 'ðŸ“ Add examples', 'âœ… Proofread and format');
  } else {
    steps.push('ðŸ“š Research approach', 'ðŸ“ Draft implementation', 'ðŸ”¨ Refine and polish');
  }
  steps.push('ðŸ” Self-review all work', 'âœ… Run verification checks');
  return steps;
}

function wolfDoubleCheck(ws) {
  const checks = [
    { name: 'All steps completed', pass: ws.planStep >= (ws.plan||[]).length },
    { name: 'Sufficient focus', pass: ws.focus > 10 },
    { name: 'Quality check', pass: Math.random() > Math.max(0.02, 0.15 - ws.trust * 0.001) },
    { name: 'Consistency check', pass: ws.streak < 10 || Math.random() > 0.1 },
  ];
  const fail = checks.find(c => !c.pass);
  return fail ? { passed: false, reason: fail.name } : { passed: true };
}

function wolfRankUp(ws) {
  if (ws.kills >= 50) ws.rank = 'alpha';
  else if (ws.kills >= 20) ws.rank = 'beta';
  else if (ws.kills >= 5) ws.rank = 'scout';
  else ws.rank = 'omega';
}

// â”€â”€ Extract project description from user message â”€â”€
function extractProjectDescription(text) {
  const patterns = [
    /(?:work on|build|create|make|code|start|begin|develop|implement|write)\s+(.+)/i,
    /(?:i want|i need|please make|please build|please create|give me|can you make|can you build|can you create)\s+(.+)/i,
  ];
  for (const p of patterns) {
    const m = text.match(p);
    if (m) return m[1].replace(/[.!?]+$/, '').trim();
  }
  return text.replace(/^(hey|hi|yo|ok|please|can you|wolf|go|now|just)\s*/gi, '').trim();
}

// â”€â”€ Auto-create a task from chat context â”€â”€
function autoCreateTask(ai, description) {
  const title = description.charAt(0).toUpperCase() + description.slice(1);
  const task = {
    id: 'task_' + Date.now(),
    title: title.slice(0, 100),
    desc: 'Auto-created from chat: ' + description,
    priority: 'high',
    status: 'backlog',
    assignee: ai.id,
    created: Date.now(),
  };
  tasks.push(task);
  addActivity(ai, `auto-hunted new prey: "${task.title}"`);
  saveAll(); renderTasks(); updateDashboard();
  return task;
}

// ================================================================
// AI INTELLIGENCE ENGINE
// ================================================================

// Programming knowledge base â€” real facts AIs draw from
const PROG_KNOWLEDGE = {
  javascript: { desc:'Dynamic interpreted language for web/server', tips:['Use const/let not var','async/await over .then chains','Destructuring saves lines','Optional chaining (?.) prevents null errors','Use Map/Set for unique collections','Array methods: map, filter, reduce, find, some, every','Template literals for string interpolation','Spread operator for shallow cloning'], frameworks:['React','Vue','Angular','Svelte','Next.js','Express','Fastify'] },
  python: { desc:'High-level language for AI/ML, scripting, web', tips:['List comprehensions over loops','f-strings for formatting','Use pathlib over os.path','Type hints improve readability','Context managers (with) for resources','dataclasses for simple classes','enumerate() over range(len())','Use generators for large datasets'], frameworks:['Django','Flask','FastAPI','PyTorch','TensorFlow','Pandas','NumPy'] },
  typescript: { desc:'Typed superset of JavaScript', tips:['Use strict mode','Prefer interfaces over type aliases for objects','Discriminated unions for state','Generics for reusable code','Const assertions for literals','Utility types: Partial, Pick, Omit, Record','Template literal types for string patterns'], frameworks:['Angular','Next.js','Nest.js','tRPC','Prisma'] },
  css: { desc:'Styling language for web', tips:['CSS Grid for 2D layouts','Flexbox for 1D alignment','Custom properties (variables) for themes','clamp() for responsive sizing','Container queries for component-level responsive','Use logical properties (inline/block)','Prefer rem/em over px',':has() selector for parent selection'], features:['Grid','Flexbox','Container queries','Cascade layers','Nesting','Subgrid'] },
  html: { desc:'Markup language for web structure', tips:['Use semantic elements (article, section, nav, main)','ARIA attributes for accessibility','Loading=lazy for images','Picture element for responsive images','Dialog element for modals','Details/summary for toggles'] },
  react: { desc:'UI library by Meta', tips:['useState for local state','useEffect for side effects','useRef for DOM access / persisting values','useMemo/useCallback to avoid re-renders','Custom hooks for reusable logic','React.memo for component memoization','Suspense + lazy for code splitting','Server Components in Next.js 14+'] },
  git: { desc:'Version control system', tips:['Commit often with clear messages','Use branches for features','git stash for temp saves','Interactive rebase for clean history','Cherry-pick specific commits','Bisect to find bugs','Conventional commits format'] },
  algorithms: { sorting:['Bubble O(nÂ²)','Selection O(nÂ²)','Insertion O(nÂ²) good for nearly-sorted','Merge Sort O(n log n) stable','Quick Sort O(n log n) avg, in-place','Heap Sort O(n log n) in-place','Radix Sort O(nk) for integers'], searching:['Linear O(n)','Binary O(log n) requires sorted','Hash Table O(1) avg lookup','BFS for shortest path in unweighted graph','DFS for exploring all paths','A* for weighted pathfinding'], structures:['Array â€” O(1) access, O(n) insert','Linked List â€” O(1) insert, O(n) access','Stack â€” LIFO, O(1) push/pop','Queue â€” FIFO, O(1) enqueue/dequeue','Hash Map â€” O(1) avg lookup','Binary Tree â€” O(log n) search/insert','Heap â€” O(1) min/max, O(log n) insert','Graph â€” adjacency list or matrix'] },
  patterns: { creational:['Singleton â€” one instance','Factory â€” create without specifying class','Builder â€” step-by-step construction','Prototype â€” clone existing objects'], structural:['Adapter â€” incompatible interfaces','Decorator â€” add behavior dynamically','Facade â€” simplified interface','Proxy â€” controlled access'], behavioral:['Observer â€” publish/subscribe','Strategy â€” interchangeable algorithms','Command â€” encapsulate requests','State â€” behavior changes with state','Iterator â€” traverse collections'] },
  api: { rest:'RESTful: GET read, POST create, PUT update, DELETE remove. Stateless, resource-based URLs.', graphql:'GraphQL: single endpoint, client specifies shape. Resolvers, schemas, mutations, subscriptions.', websocket:'WebSocket: persistent bidirectional. Events, rooms, real-time sync.', tips:['Use proper HTTP status codes','Validate all inputs','Rate limiting prevents abuse','CORS headers for browser security','JWT or OAuth2 for auth','Version your API (/v1/)','Paginate large results'] },
  security: { tips:['Never trust user input','Sanitize HTML to prevent XSS','Use parameterized queries for SQL','HTTPS everywhere','Hash passwords with bcrypt/argon2','Content-Security-Policy headers','SameSite cookies against CSRF','Dependency audit regularly'] },
  performance: { tips:['Minimize DOM manipulation','Debounce/throttle event handlers','Lazy load images and routes','Use CDN for static assets','Enable gzip/brotli compression','Cache with service workers','Virtual scrolling for long lists','Web Workers for heavy computation'] },
};

// Safe math evaluator â€” handles pi, sqrt, pow, trig, etc.
function safeMathEval(expr) {
  try {
    let e = expr.trim()
      .replace(/\bpi\b/gi, String(Math.PI))
      .replace(/\be\b/g, String(Math.E))
      .replace(/\bsqrt\s*\(([^)]+)\)/gi, (_, a) => String(Math.sqrt(parseFloat(a))))
      .replace(/\bpow\s*\(([^,]+),\s*([^)]+)\)/gi, (_, a, b) => String(Math.pow(parseFloat(a), parseFloat(b))))
      .replace(/\babs\s*\(([^)]+)\)/gi, (_, a) => String(Math.abs(parseFloat(a))))
      .replace(/\bround\s*\(([^)]+)\)/gi, (_, a) => String(Math.round(parseFloat(a))))
      .replace(/\bfloor\s*\(([^)]+)\)/gi, (_, a) => String(Math.floor(parseFloat(a))))
      .replace(/\bceil\s*\(([^)]+)\)/gi, (_, a) => String(Math.ceil(parseFloat(a))))
      .replace(/\bsin\s*\(([^)]+)\)/gi, (_, a) => String(Math.sin(parseFloat(a))))
      .replace(/\bcos\s*\(([^)]+)\)/gi, (_, a) => String(Math.cos(parseFloat(a))))
      .replace(/\btan\s*\(([^)]+)\)/gi, (_, a) => String(Math.tan(parseFloat(a))))
      .replace(/\blog\s*\(([^)]+)\)/gi, (_, a) => String(Math.log10(parseFloat(a))))
      .replace(/\bln\s*\(([^)]+)\)/gi, (_, a) => String(Math.log(parseFloat(a))))
      .replace(/\bmin\s*\(([^)]+)\)/gi, (_, a) => String(Math.min(...a.split(',').map(Number))))
      .replace(/\bmax\s*\(([^)]+)\)/gi, (_, a) => String(Math.max(...a.split(',').map(Number))))
      .replace(/\brandom\b/gi, String(Math.random()))
      .replace(/\binf(inity)?\b/gi, 'Infinity')
      .replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/\^/g, '**');
    // Only allow digits, operators, dots, parens, spaces, scientific notation
    if (/^[\d+\-*/.()% eE\s]+$/.test(e)) {
      const result = Function('"use strict"; return (' + e + ')')();
      if (typeof result === 'number' && isFinite(result)) return result;
    }
    return null;
  } catch { return null; }
}

// Parse user intent from message
function parseUserIntent(text) {
  const lc = text.toLowerCase().trim();
  const words = lc.split(/\s+/);

  // Math / calculation
  if (lc.match(/\bcalc(ulate)?\b|\bcompute\b|\bsolve\b|\bwhat\s+is\s+\d|\bhow\s+much\b|\bpi\b|\bsqrt\b/) ||
      lc.match(/^\s*[\d+\-*/.()^%\s]+\s*$/) ||
      (lc.includes('digit') && (lc.includes('pi') || lc.includes('pie')))) {
    // Extract the math expression or pi digits request
    const piMatch = lc.match(/(\d+)\s*digit.*pi/i);
    if (piMatch || (lc.includes('pi') && lc.includes('digit'))) {
      const digits = piMatch ? parseInt(piMatch[1]) : 3;
      return { type: 'math', subtype: 'pi', digits, raw: text };
    }
    return { type: 'math', subtype: 'eval', raw: text };
  }

  // Print / display / output
  if (lc.match(/^print\b|^output\b|^show\b|^display\b|^echo\b|^log\b/)) {
    const content = text.replace(/^(print|output|show|display|echo|log)\s*/i, '').trim();
    return { type: 'print', content, raw: text };
  }

  // Code generation (specific snippet, not a full project)
  if (lc.match(/\bwrite\s+(a\s+)?(function|class|method|script|code|program|regex|loop)\b/) ||
      lc.match(/\bcode\s+(for|that|to|a)\b/) ||
      lc.match(/\bhow\s+(to|do)\s+(you\s+)?(write|code|implement|create)\b/) ||
      lc.match(/\bgenerate\s+(a\s+)?(function|class|code|script)\b/) ||
      lc.match(/\bin\s+(javascript|python|typescript|java|c\+\+|c#|go|rust|ruby|php|swift)\b/)) {
    const langMatch = lc.match(/\b(javascript|python|typescript|java|c\+\+|c#|go|rust|ruby|php|swift|html|css|sql|bash|powershell)\b/);
    return { type: 'code', language: langMatch ? langMatch[1] : null, raw: text };
  }

  // Explain / teach
  if (lc.match(/\bexplain\b|\bwhat\s+is\b|\bwhat\s+are\b|\bdefine\b|\btell\s+me\s+about\b|\bhow\s+does\b|\bwhat\s+does\b|\bwhy\s+does\b|\bmeaning\s+of\b/)) {
    return { type: 'explain', raw: text };
  }

  // Compare / vs
  if (lc.match(/\bvs\.?\b|\bversus\b|\bcompare\b|\bdifference\b|\bwhich\s+is\s+better\b/)) {
    return { type: 'compare', raw: text };
  }

  // List / enumerate
  if (lc.match(/^list\b|\bgive\s+me\s+(a\s+)?list\b|\bname\s+\d|\btop\s+\d|\bbest\s+\d/)) {
    return { type: 'list', raw: text };
  }

  // Fix / debug
  if (lc.match(/\bfix\b|\bdebug\b|\berror\b|\bbug\b|\bcrash\b|\bnot\s+working\b|\bbroken\b|\bfailing\b/)) {
    return { type: 'fix', raw: text };
  }

  // Question (general)
  if (lc.match(/\?$/) || lc.match(/^(how|what|why|when|where|which|who|is|are|can|do|does|will|should|would|could)\b/)) {
    return { type: 'question', raw: text };
  }

  // Greeting
  if (lc.match(/^(hello|hey|hi|yo|sup|howdy|greetings|good\s+(morning|afternoon|evening)|what'?s?\s+up)\b/)) {
    return { type: 'greeting', raw: text };
  }

  // Thanks
  if (lc.match(/\bthank|thanks|thx|good\s+job|nice|well\s+done|great\s+work|awesome\b/)) {
    return { type: 'thanks', raw: text };
  }

  // Status
  if (lc.match(/\bstatus\b|\bprogress\b|\bwhat.*working\s+on\b|\bupdate\b/)) {
    return { type: 'status', raw: text };
  }

  // Casual / conversational (chat, play, fun, jokes, opinions)
  if (lc.match(/\b(play|game|joke|fun|funny|bored|chat|talk|hang|chill|vibe|friend|lonely|movie|music|story|riddle|trivia|challenge|dare|would you rather|favorite|opinion|feel|think about|mood)\b/)) {
    return { type: 'chat', raw: text };
  }

  // General / complex â€” try to detect subject
  return { type: 'general', raw: text };
}

// Handle math requests
function handleMathIntent(ai, intent, text) {
  const lc = text.toLowerCase();
  if (intent.subtype === 'pi') {
    const d = Math.min(intent.digits || 3, 15);
    const piStr = Math.PI.toFixed(d);
    return `**\u03c0 to ${d} decimal places:**\n\n\`${piStr}\`\n\n` +
      `\`\`\`javascript\n// Pi calculation\nconst pi = Math.PI; // ${Math.PI}\nconsole.log(pi.toFixed(${d})); // "${piStr}"\n\`\`\``;
  }

  // Try to extract and evaluate a math expression
  let expr = text.replace(/^(calc(ulate)?|compute|solve|what\s+is|what's|how\s+much\s+is|evaluate)\s*/i, '').replace(/\?+$/, '').trim();
  const result = safeMathEval(expr);
  if (result !== null) {
    return `**Result:** \`${expr} = ${result}\`\n\n\`\`\`javascript\n// Calculation\nconsole.log(${expr.replace(/pi/gi, 'Math.PI')}); // ${result}\n\`\`\``;
  }

  // Can't evaluate â€” explain what we'd need
  return `I couldn't evaluate that directly, but here's how to compute it:\n\n\`\`\`javascript\n// Compute: ${text}\nconst result = ${expr.replace(/pi/gi, 'Math.PI').replace(/\^/g, '**')};\nconsole.log(result);\n\`\`\`\n\nTry rephrasing as a math expression (e.g. "2 + 3 * 4", "sqrt(144)", "pi * 5^2").`;
}

// Handle print/display requests
function handlePrintIntent(ai, intent, text) {
  let content = intent.content;
  // Check if there's a math expression embedded
  const lc = content.toLowerCase();
  const parts = [];

  // Check for "and add X digit pi calc" pattern
  const piMatch = lc.match(/(?:and\s+)?add\s+(\d+)\s*digit.*pi/i) || lc.match(/(\d+)\s*digit.*pi/i);
  if (piMatch) {
    const digits = parseInt(piMatch[1]);
    const piVal = Math.PI.toFixed(Math.min(digits, 15));
    const basePart = content.replace(/\s*(and\s+)?add\s+\d+\s*digit.*$/i, '').trim();
    parts.push(`**Output:**\n\`\`\`\n${basePart}\n\`\`\`\n\n**\u03c0 to ${digits} digits:** \`${piVal}\`\n\n**Combined:** \`${basePart}${piVal}\``);
    parts.push(`\n\n\`\`\`javascript\nconst base = "${basePart}";\nconst pi = Math.PI.toFixed(${digits}); // "${piVal}"\nconsole.log(base + pi); // "${basePart}${piVal}"\n\`\`\``);
    return parts.join('');
  }

  // Try to evaluate the content if it looks like math
  const mathResult = safeMathEval(content);
  if (mathResult !== null) {
    return `**Output:** \`${mathResult}\`\n\n\`\`\`javascript\nconsole.log(${content}); // ${mathResult}\n\`\`\``;
  }

  // Just print the value
  return `**Output:**\n\`\`\`\n${content}\n\`\`\`\n\n\`\`\`javascript\nconsole.log("${content.replace(/"/g, '\\"')}");\n\`\`\``;
}

// Handle explain/teach requests
function handleExplainIntent(ai, text) {
  const lc = text.toLowerCase();
  const topic = text.replace(/^(explain|what\s+is|what\s+are|define|tell\s+me\s+about|how\s+does|what\s+does|why\s+does|the\s+meaning\s+of)\s*/i, '').replace(/\?+$/, '').trim().toLowerCase();

  // Check knowledge base
  for (const [lang, info] of Object.entries(PROG_KNOWLEDGE)) {
    if (topic.includes(lang) || lc.includes(lang)) {
      if (lang === 'algorithms') {
        const sortMatch = lc.match(/sort/);
        const searchMatch = lc.match(/search|find/);
        const structMatch = lc.match(/struct|data\s*struct/);
        if (sortMatch) return `**Sorting Algorithms:**\n\n${info.sorting.map(s => 'â€¢ ' + s).join('\n')}\n\nðŸ’¡ **Quick picks:**\nâ€¢ Small arrays â†’ Insertion Sort\nâ€¢ General use â†’ Quick Sort or Merge Sort\nâ€¢ Integers â†’ Radix Sort\nâ€¢ Need stable â†’ Merge Sort`;
        if (searchMatch) return `**Search Algorithms:**\n\n${info.searching.map(s => 'â€¢ ' + s).join('\n')}\n\nðŸ’¡ Always binary search sorted arrays!`;
        if (structMatch) return `**Data Structures:**\n\n${info.structures.map(s => 'â€¢ ' + s).join('\n')}\n\nðŸ’¡ Choose based on your most common operation.`;
        return `**Algorithms & Data Structures:**\n\n**Sorting:** ${info.sorting.slice(0,3).join(', ')}\n**Searching:** ${info.searching.slice(0,3).join(', ')}\n**Structures:** ${info.structures.slice(0,4).join(', ')}`;
      }
      if (lang === 'patterns') {
        return `**Design Patterns:**\n\n**Creational:** ${info.creational.map(p => 'â€¢ ' + p).join('\n')}\n\n**Structural:** ${info.structural.map(p => 'â€¢ ' + p).join('\n')}\n\n**Behavioral:** ${info.behavioral.map(p => 'â€¢ ' + p).join('\n')}`;
      }
      if (lang === 'api') {
        if (lc.includes('rest')) return `**REST API:**\n${info.rest}\n\n**Tips:**\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
        if (lc.includes('graphql')) return `**GraphQL:**\n${info.graphql}\n\n**Tips:**\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
        if (lc.includes('websocket')) return `**WebSocket:**\n${info.websocket}`;
        return `**API Types:**\n\nâ€¢ **REST:** ${info.rest.slice(0,60)}...\nâ€¢ **GraphQL:** ${info.graphql.slice(0,60)}...\nâ€¢ **WebSocket:** ${info.websocket.slice(0,60)}...\n\n**Tips:**\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
      }
      if (lang === 'security') return `**Security Best Practices:**\n\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
      if (lang === 'performance') return `**Performance Tips:**\n\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
      let resp = `**${lang.charAt(0).toUpperCase() + lang.slice(1)}:** ${info.desc}\n\n`;
      resp += `**Tips:**\n${info.tips.map(t => 'â€¢ ' + t).join('\n')}`;
      if (info.frameworks) resp += `\n\n**Popular frameworks:** ${info.frameworks.join(', ')}`;
      return resp;
    }
  }

  // Common concepts
  const concepts = {
    'closure': 'A **closure** is a function that "remembers" variables from its outer scope, even after that scope has finished executing.\n\n```javascript\nfunction counter() {\n  let count = 0;\n  return function() { return ++count; };\n}\nconst inc = counter();\nconsole.log(inc()); // 1\nconsole.log(inc()); // 2\n```',
    'promise': 'A **Promise** represents a value that may not be available yet.\n\n```javascript\nconst fetchData = () => new Promise((resolve, reject) => {\n  setTimeout(() => resolve("data"), 1000);\n});\n\n// Using .then\nfetchData().then(data => console.log(data));\n\n// Using async/await\nconst data = await fetchData();\n```',
    'async': 'The **async/await** pattern makes asynchronous code read like synchronous code.\n\n```javascript\nasync function loadUser(id) {\n  try {\n    const res = await fetch(`/api/users/${id}`);\n    const user = await res.json();\n    return user;\n  } catch (err) {\n    console.error("Failed:", err);\n  }\n}\n```',
    'recursion': '**Recursion** is when a function calls itself to break a problem into smaller pieces.\n\n```javascript\nfunction factorial(n) {\n  if (n <= 1) return 1; // base case\n  return n * factorial(n - 1); // recursive case\n}\nconsole.log(factorial(5)); // 120\n```\n\nâš ï¸ Always have a base case to avoid infinite recursion!',
    'scope': '**Scope** determines where variables are accessible.\n\nâ€¢ **Global** â€” accessible everywhere\nâ€¢ **Function** â€” var lives in function scope\nâ€¢ **Block** â€” let/const live in {} blocks\nâ€¢ **Lexical** â€” inner functions access outer variables (closures)\n\n```javascript\nlet global = "everywhere";\nfunction outer() {\n  let fn = "in function";\n  if (true) {\n    let block = "in block only";\n  }\n}\n```',
    'dom': 'The **DOM** (Document Object Model) is the browser\u2019s tree representation of HTML.\n\n```javascript\n// Select elements\nconst el = document.querySelector(".myClass");\nconst all = document.querySelectorAll("p");\n\n// Modify\nel.textContent = "New text";\nel.style.color = "red";\nel.classList.add("active");\n\n// Create\nconst div = document.createElement("div");\ndocument.body.appendChild(div);\n\n// Listen\nel.addEventListener("click", (e) => { /* handle */ });\n```',
    'event loop': 'The **Event Loop** is how JavaScript handles async operations in a single thread.\n\n1. **Call Stack** â€” executes synchronous code\n2. **Web APIs** â€” handle setTimeout, fetch, DOM events\n3. **Callback Queue** â€” macrotasks (setTimeout, setInterval)\n4. **Microtask Queue** â€” Promises, MutationObserver (higher priority)\n\nThe loop: stack empty? â†’ run all microtasks â†’ take one macrotask â†’ repeat.',
    'hoisting': '**Hoisting** moves declarations to the top of their scope during compilation.\n\n```javascript\n// var is hoisted (undefined)\nconsole.log(x); // undefined\nvar x = 5;\n\n// let/const are hoisted but NOT initialized (TDZ)\nconsole.log(y); // ReferenceError!\nlet y = 10;\n\n// Functions are fully hoisted\nfoo(); // works!\nfunction foo() { return "hi"; }\n```',
    'prototype': '**Prototypes** are JavaScript\u2019s inheritance mechanism. Every object has a hidden [[Prototype]].\n\n```javascript\nfunction Dog(name) { this.name = name; }\nDog.prototype.bark = function() { return "Woof!"; };\n\nconst rex = new Dog("Rex");\nrex.bark(); // "Woof!" â€” found on prototype\n\n// Modern class syntax (same thing under the hood)\nclass Cat {\n  constructor(name) { this.name = name; }\n  meow() { return "Meow!"; }\n}\n```',
    'regex': '**Regular Expressions** match patterns in strings.\n\n```javascript\n// Common patterns\n/\\d+/        // digits\n/[a-zA-Z]+/  // letters\n/^\\S+@\\S+$/  // basic email\n/\\b\\w{3,}\\b/ // words 3+ chars\n\n// Usage\n"hello 123".match(/\\d+/);     // ["123"]\n"test".replace(/t/g, "T");   // "TesT"\n/^\\d{3}$/.test("123");       // true\n```',
    'api': 'An **API** (Application Programming Interface) is a contract between systems.\n\n```javascript\n// Fetch API example\nconst response = await fetch("https://api.example.com/data", {\n  method: "POST",\n  headers: { "Content-Type": "application/json" },\n  body: JSON.stringify({ name: "test" })\n});\nconst data = await response.json();\n```',
    'map': '**Map** transforms each element of an array.\n\n```javascript\nconst nums = [1, 2, 3, 4];\nconst doubled = nums.map(n => n * 2); // [2, 4, 6, 8]\nconst names = users.map(u => u.name); // extract names\n```\n\nAlso: **Map** object for key-value pairs:\n```javascript\nconst m = new Map();\nm.set("key", "value");\nm.get("key"); // "value"\n```',
    'filter': '**Filter** returns elements that pass a test.\n\n```javascript\nconst nums = [1, 2, 3, 4, 5];\nconst even = nums.filter(n => n % 2 === 0); // [2, 4]\nconst adults = users.filter(u => u.age >= 18);\n```',
    'reduce': '**Reduce** accumulates array values into one result.\n\n```javascript\nconst sum = [1, 2, 3, 4].reduce((acc, n) => acc + n, 0); // 10\nconst grouped = items.reduce((acc, item) => {\n  (acc[item.type] = acc[item.type] || []).push(item);\n  return acc;\n}, {});\n```',
  };

  for (const [key, explanation] of Object.entries(concepts)) {
    if (topic.includes(key) || lc.includes(key)) {
      return explanation;
    }
  }

  // Generic explanation attempt
  const kb = ai.skills ? ai.skills.filter(s => topic.includes(s.toLowerCase())).join(', ') : '';
  return `**${topic.charAt(0).toUpperCase() + topic.slice(1)}:**\n\nThat's a great question. Here's a concise breakdown:\n\n` +
    `â€¢ It's a fundamental concept in software development\n` +
    `â€¢ Understanding it helps write cleaner, more maintainable code\n` +
    `â€¢ Most modern frameworks rely on this concept\n\n` +
    (kb ? `As someone skilled in ${kb}, I can tell you this is highly relevant to modern development.\n\n` : '') +
    `Would you like me to:\n1. Show a code example?\n2. Compare it to similar concepts?\n3. Explain how it's used in a real project?`;
}

// Handle code generation requests
function handleCodeIntent(ai, text) {
  // Note: when realAIEnabled is true, the caller (aiRespondToUser) handles the real AI call
  // and only falls through to this built-in generation as a backup.
  const lc = text.toLowerCase();
  const lang = lc.match(/\b(javascript|python|typescript|java|c\+\+|c#|go|rust|ruby|php|swift|html|css|sql|bash|powershell)\b/);
  const targetLang = lang ? lang[1] : 'javascript';

  // Function generation
  const fnMatch = lc.match(/(?:write|create|generate|make|code)\s+(?:a\s+)?(?:function|method)\s+(?:that|to|for|which)\s+(.+)/i);
  if (fnMatch) {
    const purpose = fnMatch[1].replace(/\?$/, '').trim();
    return generateSmartCode(targetLang, purpose);
  }

  // Class generation
  const classMatch = lc.match(/(?:write|create|generate|make|code)\s+(?:a\s+)?class\s+(?:for|that|to|called|named)\s+(.+)/i);
  if (classMatch) {
    const purpose = classMatch[1].replace(/\?$/, '').trim();
    return generateSmartClass(targetLang, purpose);
  }

  // Regex generation
  if (lc.includes('regex') || lc.includes('regular expression')) {
    const purpose = text.replace(/.*(?:regex|regular expression)\s*(?:for|to|that)?\s*/i, '').replace(/\?$/, '').trim();
    return generateRegex(purpose);
  }

  // General code request
  const purpose = text.replace(/^(write|create|generate|make|code|implement)\s*(a\s+)?(function|class|method|script|code|program|snippet)?\s*(for|to|that|which)?\s*/i, '').replace(/\?$/, '').trim();
  return generateSmartCode(targetLang, purpose || text);
}

// Generate targeted code snippets
function generateSmartCode(lang, purpose) {
  const lc = purpose.toLowerCase();

  // Detect what kind of code to generate
  if (lc.includes('sort') || lc.includes('order')) {
    const examples = {
      javascript: `\`\`\`javascript\n// Sort: ${purpose}\nfunction customSort(arr) {\n  return [...arr].sort((a, b) => {\n    // Ascending order (change to b - a for descending)\n    if (typeof a === 'string') return a.localeCompare(b);\n    return a - b;\n  });\n}\n\n// Usage\nconst sorted = customSort([3, 1, 4, 1, 5]);\nconsole.log(sorted); // [1, 1, 3, 4, 5]\n\n// Sort objects by property\nconst byName = items.sort((a, b) => a.name.localeCompare(b.name));\nconst byDate = items.sort((a, b) => new Date(a.date) - new Date(b.date));\n\`\`\``,
      python: `\`\`\`python\n# Sort: ${purpose}\ndef custom_sort(lst):\n    return sorted(lst)  # ascending\n    # return sorted(lst, reverse=True)  # descending\n\n# Sort objects by key\nsorted_items = sorted(items, key=lambda x: x['name'])\n\n# Multiple sort keys\nsorted_items = sorted(items, key=lambda x: (x['category'], x['name']))\n\`\`\``,
    };
    return examples[lang] || examples.javascript;
  }

  if (lc.includes('fetch') || lc.includes('api') || lc.includes('http') || lc.includes('request')) {
    const examples = {
      javascript: `\`\`\`javascript\n// API Request: ${purpose}\nasync function fetchData(url, options = {}) {\n  try {\n    const response = await fetch(url, {\n      method: options.method || 'GET',\n      headers: {\n        'Content-Type': 'application/json',\n        ...options.headers\n      },\n      ...(options.body ? { body: JSON.stringify(options.body) } : {})\n    });\n\n    if (!response.ok) {\n      throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);\n    }\n\n    return await response.json();\n  } catch (error) {\n    console.error('Fetch failed:', error);\n    throw error;\n  }\n}\n\n// Usage\nconst data = await fetchData('https://api.example.com/items');\nconst created = await fetchData('/api/items', { method: 'POST', body: { name: 'test' } });\n\`\`\``,
      python: `\`\`\`python\nimport requests\n\n# API Request: ${purpose}\ndef fetch_data(url, method='GET', data=None):\n    try:\n        if method == 'GET':\n            response = requests.get(url)\n        elif method == 'POST':\n            response = requests.post(url, json=data)\n        response.raise_for_status()\n        return response.json()\n    except requests.RequestException as e:\n        print(f"Request failed: {e}")\n        raise\n\n# Usage\ndata = fetch_data('https://api.example.com/items')\nresult = fetch_data('/api/items', 'POST', {'name': 'test'})\n\`\`\``,
    };
    return examples[lang] || examples.javascript;
  }

  if (lc.includes('filter') || lc.includes('search') || lc.includes('find')) {
    return `\`\`\`javascript\n// ${purpose}\nfunction smartFilter(items, query) {\n  const lc = query.toLowerCase();\n  return items.filter(item => {\n    // Search across all string properties\n    return Object.values(item).some(val =>\n      String(val).toLowerCase().includes(lc)\n    );\n  });\n}\n\n// Specific field search\nconst byName = items.filter(item => item.name.includes(query));\nconst byRange = items.filter(item => item.price >= min && item.price <= max);\n\n// Advanced: fuzzy match\nfunction fuzzyMatch(str, pattern) {\n  let pi = 0;\n  for (const char of str.toLowerCase()) {\n    if (char === pattern[pi]?.toLowerCase()) pi++;\n    if (pi === pattern.length) return true;\n  }\n  return false;\n}\n\`\`\``;
  }

  if (lc.includes('validate') || lc.includes('validation') || lc.includes('check')) {
    return `\`\`\`javascript\n// Validation: ${purpose}\nconst validators = {\n  email: (v) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v),\n  phone: (v) => /^\\+?[\\d\\s-()]{10,}$/.test(v),\n  url: (v) => { try { new URL(v); return true; } catch { return false; } },\n  notEmpty: (v) => v?.trim().length > 0,\n  minLength: (min) => (v) => v?.length >= min,\n  maxLength: (max) => (v) => v?.length <= max,\n  isNumber: (v) => !isNaN(v) && isFinite(Number(v)),\n  inRange: (min, max) => (v) => Number(v) >= min && Number(v) <= max,\n  matches: (regex) => (v) => regex.test(v),\n};\n\nfunction validate(data, rules) {\n  const errors = {};\n  for (const [field, checks] of Object.entries(rules)) {\n    for (const check of checks) {\n      if (!check.fn(data[field])) {\n        errors[field] = errors[field] || [];\n        errors[field].push(check.msg);\n      }\n    }\n  }\n  return { valid: Object.keys(errors).length === 0, errors };\n}\n\`\`\``;
  }

  if (lc.includes('array') || lc.includes('manipulat') || lc.includes('transform')) {
    return `\`\`\`javascript\n// Array operations: ${purpose}\n\n// Chunk array into groups\nconst chunk = (arr, size) => Array.from({length: Math.ceil(arr.length/size)}, (_, i) => arr.slice(i*size, i*size+size));\n\n// Unique values\nconst unique = arr => [...new Set(arr)];\n\n// Group by property\nconst groupBy = (arr, key) => arr.reduce((acc, item) => {\n  (acc[item[key]] = acc[item[key]] || []).push(item);\n  return acc;\n}, {});\n\n// Flatten nested\nconst flatten = arr => arr.flat(Infinity);\n\n// Shuffle\nconst shuffle = arr => [...arr].sort(() => Math.random() - 0.5);\n\n// Intersection\nconst intersect = (a, b) => a.filter(x => b.includes(x));\n\n// Difference\nconst diff = (a, b) => a.filter(x => !b.includes(x));\n\`\`\``;
  }

  if (lc.includes('date') || lc.includes('time') || lc.includes('format')) {
    return `\`\`\`javascript\n// Date/Time: ${purpose}\n\n// Format date\nfunction formatDate(date, format = 'YYYY-MM-DD') {\n  const d = new Date(date);\n  const pad = n => String(n).padStart(2, '0');\n  return format\n    .replace('YYYY', d.getFullYear())\n    .replace('MM', pad(d.getMonth() + 1))\n    .replace('DD', pad(d.getDate()))\n    .replace('HH', pad(d.getHours()))\n    .replace('mm', pad(d.getMinutes()))\n    .replace('ss', pad(d.getSeconds()));\n}\n\n// Relative time\nfunction timeAgo(date) {\n  const seconds = Math.floor((Date.now() - new Date(date)) / 1000);\n  const intervals = [{label:'year',s:31536000},{label:'month',s:2592000},{label:'day',s:86400},{label:'hour',s:3600},{label:'minute',s:60}];\n  for (const {label, s} of intervals) {\n    const count = Math.floor(seconds / s);\n    if (count > 0) return count + ' ' + label + (count > 1 ? 's' : '') + ' ago';\n  }\n  return 'just now';\n}\n\nconsole.log(formatDate(new Date(), 'YYYY-MM-DD HH:mm'));\nconsole.log(timeAgo('2024-01-01'));\n\`\`\``;
  }

  // Default: generate a varied function based on the purpose description
  const templates = [
    `\`\`\`javascript\n// ${purpose}\nfunction main(input) {\n  // Parse input\n  const data = typeof input === 'string' ? input.trim() : input;\n\n  // Process\n  const result = process(data);\n\n  // Output\n  console.log(result);\n  return result;\n}\n\nfunction process(data) {\n  // Core logic for: ${purpose}\n  return data;\n}\n\n// Run\n// main(yourInput);\n\`\`\``,
    `\`\`\`javascript\n// ${purpose}\nconst ${purpose.replace(/[^a-zA-Z0-9]/g,'').slice(0,12) || 'handler'} = (() => {\n  const state = { initialized: false, data: null };\n\n  function init(config = {}) {\n    state.initialized = true;\n    state.data = config.data || [];\n    console.log('Initialized:', config);\n    return state;\n  }\n\n  function execute(input) {\n    if (!state.initialized) init();\n    // Logic for: ${purpose}\n    const result = input;\n    return { success: true, result, timestamp: Date.now() };\n  }\n\n  return { init, execute, getState: () => ({...state}) };\n})();\n\n// Usage:\n// ${purpose.replace(/[^a-zA-Z0-9]/g,'').slice(0,12) || 'handler'}.execute(yourInput);\n\`\`\``,
    `\`\`\`javascript\n// ${purpose} â€” Event-driven approach\nclass Handler {\n  constructor() {\n    this.listeners = new Map();\n    this.history = [];\n  }\n\n  on(event, callback) {\n    if (!this.listeners.has(event)) this.listeners.set(event, []);\n    this.listeners.get(event).push(callback);\n    return this;\n  }\n\n  emit(event, data) {\n    this.history.push({ event, data, time: new Date() });\n    (this.listeners.get(event) || []).forEach(cb => cb(data));\n  }\n\n  process(input) {\n    this.emit('start', input);\n    // Core: ${purpose}\n    const result = input;\n    this.emit('complete', result);\n    return result;\n  }\n}\n\nconst handler = new Handler();\nhandler.on('complete', r => console.log('Done:', r));\n// handler.process(yourInput);\n\`\`\``,
    `\`\`\`javascript\n// ${purpose} â€” Async pipeline\nasync function pipeline(input) {\n  console.log('Starting: ${purpose}');\n  \n  // Step 1: Validate\n  if (!input) throw new Error('Input required');\n  \n  // Step 2: Transform\n  const transformed = typeof input === 'string' \n    ? input.trim().split('\\n').filter(Boolean)\n    : Array.isArray(input) ? input : [input];\n  \n  // Step 3: Process\n  const results = await Promise.all(\n    transformed.map(async (item, i) => {\n      // ${purpose} logic here\n      return { index: i, value: item, processed: true };\n    })\n  );\n  \n  // Step 4: Output\n  console.log('Processed', results.length, 'items');\n  return results;\n}\n\n// pipeline(yourInput).then(console.log);\n\`\`\``,
  ];
  return pick(templates) + `\n\nGive me more specifics and I'll fill in the implementation!`;
}

// Generate a class
function generateSmartClass(lang, purpose) {
  const className = purpose.replace(/[^a-zA-Z0-9]/g, ' ').split(/\s+/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
  return `\`\`\`javascript\nclass ${className} {\n  #data = [];\n\n  constructor(options = {}) {\n    this.name = options.name || '${className}';\n    this.createdAt = new Date();\n  }\n\n  // Add item\n  add(item) {\n    this.#data.push({ ...item, id: Date.now(), addedAt: new Date() });\n    return this;\n  }\n\n  // Find by property\n  find(key, value) {\n    return this.#data.find(item => item[key] === value);\n  }\n\n  // Filter items\n  filter(predicate) {\n    return this.#data.filter(predicate);\n  }\n\n  // Remove by ID\n  remove(id) {\n    this.#data = this.#data.filter(item => item.id !== id);\n    return this;\n  }\n\n  // Get all\n  getAll() {\n    return [...this.#data];\n  }\n\n  // Count\n  get count() {\n    return this.#data.length;\n  }\n\n  // Serialize\n  toJSON() {\n    return { name: this.name, data: this.#data, createdAt: this.createdAt };\n  }\n}\n\n// Usage\nconst manager = new ${className}({ name: 'My ${className}' });\nmanager.add({ title: 'Example' });\nconsole.log(manager.count); // 1\n\`\`\``;
}

// Generate regex
function generateRegex(purpose) {
  const lc = purpose.toLowerCase();
  const patterns = {
    'email': { regex: '/^[\\w.-]+@[\\w.-]+\\.[a-zA-Z]{2,}$/', desc: 'Matches standard email addresses', examples: ['user@example.com', 'test.name@sub.domain.org'] },
    'phone': { regex: '/^\\+?[\\d()\\s-]{10,}$/', desc: 'Matches phone numbers (international)', examples: ['+1-555-123-4567', '(555) 123 4567'] },
    'url': { regex: '/^https?:\\/\\/[\\w.-]+\\.[a-zA-Z]{2,}(\\/\\S*)?$/', desc: 'Matches HTTP(S) URLs', examples: ['https://example.com', 'http://sub.domain.org/path'] },
    'ip': { regex: '/^(\\d{1,3}\\.){3}\\d{1,3}$/', desc: 'Matches IPv4 addresses', examples: ['192.168.1.1', '10.0.0.255'] },
    'date': { regex: '/^\\d{4}-\\d{2}-\\d{2}$/', desc: 'Matches YYYY-MM-DD dates', examples: ['2024-01-15', '2025-12-31'] },
    'hex': { regex: '/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/', desc: 'Matches hex color codes', examples: ['#ff0000', '#abc', 'FF5733'] },
    'password': { regex: '/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*]).{8,}$/', desc: 'Strong password: 8+ chars, upper, lower, digit, special', examples: ['MyP@ss1234'] },
    'number': { regex: '/^-?\\d+(\\.\\d+)?$/', desc: 'Matches integers and decimals', examples: ['42', '-3.14', '0.5'] },
    'username': { regex: '/^[a-zA-Z][a-zA-Z0-9_-]{2,19}$/', desc: 'Username: 3-20 chars, starts with letter', examples: ['user_123', 'JohnDoe'] },
    'slug': { regex: '/^[a-z0-9]+(-[a-z0-9]+)*$/', desc: 'URL slug format', examples: ['my-blog-post', 'hello-world'] },
  };

  for (const [key, val] of Object.entries(patterns)) {
    if (lc.includes(key)) {
      return `**Regex for ${key}:**\n\n\`${val.regex}\`\n\n${val.desc}\n\n**Examples:**\n${val.examples.map(e => 'â€¢ \`' + e + '\` \u2705').join('\n')}\n\n\`\`\`javascript\nconst pattern = ${val.regex};\nconst isValid = pattern.test(input);\n\`\`\``;
    }
  }

  return `**Regex for: ${purpose}**\n\n\`\`\`javascript\n// Custom regex pattern\nconst pattern = /your-pattern-here/;\n\n// Test it\nconst isMatch = pattern.test("input string");\n\n// Extract matches\nconst matches = "input string".match(pattern);\n\`\`\`\n\n**Common regex building blocks:**\nâ€¢ \`\\d\` â€” digit, \`\\w\` â€” word char, \`\\s\` â€” whitespace\nâ€¢ \`+\` â€” 1 or more, \`*\` â€” 0 or more, \`?\` â€” 0 or 1\nâ€¢ \`{n,m}\` â€” between n and m repetitions\nâ€¢ \`^...$\` â€” full string match\nâ€¢ \`(?=...)\` â€” lookahead, \`(?:...)\` â€” non-capturing group`;
}

// Handle comparison requests
function handleCompareIntent(ai, text) {
  const lc = text.toLowerCase();
  const pairs = [
    { keys: ['react','vue'], comp: '**React vs Vue:**\n\n| Feature | React | Vue |\n|---------|-------|-----|\n| Learning curve | Steeper | Gentler |\n| State management | External (Redux/Zustand) | Built-in (Pinia) |\n| Template style | JSX | HTML templates |\n| Backing | Meta | Community |\n| Performance | Fast (virtual DOM) | Fast (reactive proxy) |\n| Ecosystem | Massive | Growing |\n| TypeScript | Great support | Great support |\n\n**Choose React** if: Large team, existing React codebase, need tons of libraries\n**Choose Vue** if: Rapid prototyping, smaller team, prefer HTML templates' },
    { keys: ['typescript','javascript'], comp: '**TypeScript vs JavaScript:**\n\n| Feature | TypeScript | JavaScript |\n|---------|-----------|------------|\n| Types | Static + compile-time | Dynamic |\n| IDE support | Excellent autocomplete | Good |\n| Errors | Caught at compile time | Runtime only |\n| Learning | Steeper | Simpler |\n| Bundle | Needs compilation | Runs directly |\n| Adoption | Growing fast | Universal |\n\n**Use TypeScript** for: Large projects, team codebases, complex data\n**Use JavaScript** for: Quick scripts, simple pages, learning' },
    { keys: ['python','javascript'], comp: '**Python vs JavaScript:**\n\n| Feature | Python | JavaScript |\n|---------|--------|------------|\n| Primary use | AI/ML, backend, scripting | Web (front+back) |\n| Syntax | Clean, whitespace-based | C-style, flexible |\n| Speed | Slower (interpreted) | Faster (V8 JIT) |\n| Typing | Dynamic (optional types) | Dynamic (TS for types) |\n| Package manager | pip | npm |\n| Concurrency | GIL limits threading | Event loop, async |\n\n**Use Python** for: Data science, ML, automation, scripting\n**Use JavaScript** for: Web apps, full-stack, real-time' },
    { keys: ['sql','nosql'], comp: '**SQL vs NoSQL:**\n\n| Feature | SQL (Postgres, MySQL) | NoSQL (MongoDB, Redis) |\n|---------|------|-------|\n| Schema | Fixed, structured | Flexible, dynamic |\n| Queries | SQL language | API/document-based |\n| Scaling | Vertical mainly | Horizontal easily |\n| Relations | Strong (JOINs) | Embedded/referenced |\n| ACID | Full support | Varies |\n| Best for | Complex queries, relations | Fast reads, flexible data |\n\n**Use SQL** for: Financial data, complex relations, strict schemas\n**Use NoSQL** for: Real-time apps, flexible schemas, horizontal scale' },
  ];

  for (const p of pairs) {
    if (p.keys.every(k => lc.includes(k))) return p.comp;
  }

  return `Good comparison question! Let me break it down:\n\n**Factors to compare:**\nâ€¢ Performance & speed\nâ€¢ Learning curve\nâ€¢ Community & ecosystem\nâ€¢ Primary use cases\nâ€¢ Tooling support\n\nCould you specify which two technologies you want to compare? I can give a detailed breakdown.`;
}

// Handle list requests
function handleListIntent(ai, text) {
  const lc = text.toLowerCase();
  const countMatch = lc.match(/(?:top|best|name)\s*(\d+)/);
  const count = countMatch ? Math.min(parseInt(countMatch[1]), 10) : 5;

  if (lc.includes('framework') || lc.includes('library')) {
    const lang = lc.includes('python') ? 'python' : lc.includes('css') ? 'css' : 'javascript';
    const kb = PROG_KNOWLEDGE[lang];
    if (kb && kb.frameworks) {
      return `**Top ${lang.charAt(0).toUpperCase() + lang.slice(1)} frameworks:**\n\n${kb.frameworks.slice(0, count).map((f, i) => (i+1) + '. **' + f + '**').join('\n')}`;
    }
  }

  if (lc.includes('tip') || lc.includes('best practice') || lc.includes('practice')) {
    for (const [lang, kb] of Object.entries(PROG_KNOWLEDGE)) {
      if (lc.includes(lang) && kb.tips) {
        return `**${lang.charAt(0).toUpperCase() + lang.slice(1)} best practices:**\n\n${kb.tips.slice(0, count).map((t, i) => (i+1) + '. ' + t).join('\n')}`;
      }
    }
    return `**General best practices:**\n\n1. Write readable code over clever code\n2. Test early and often\n3. Keep functions small and focused\n4. Use version control (git)\n5. Document your public APIs\n6. Handle errors gracefully\n7. Review code before merging\n8. Keep dependencies updated`;
  }

  if (lc.includes('algorithm') || lc.includes('data structure')) {
    return `**Essential algorithms & structures:**\n\n${PROG_KNOWLEDGE.algorithms.structures.slice(0, count).map((s, i) => (i+1) + '. ' + s).join('\n')}`;
  }

  if (lc.includes('pattern') || lc.includes('design')) {
    const all = [...PROG_KNOWLEDGE.patterns.creational, ...PROG_KNOWLEDGE.patterns.structural, ...PROG_KNOWLEDGE.patterns.behavioral];
    return `**Design patterns:**\n\n${all.slice(0, count).map((p, i) => (i+1) + '. ' + p).join('\n')}`;
  }

  return `Here's what I can list for you:\n\nâ€¢ **Frameworks** â€” "list top 5 JS frameworks"\nâ€¢ **Best practices** â€” "list Python best practices"\nâ€¢ **Algorithms** â€” "list sorting algorithms"\nâ€¢ **Design patterns** â€” "list design patterns"\nâ€¢ **Tips** â€” "top 5 CSS tips"\n\nJust ask!`;
}

// Handle fix/debug requests
function handleFixIntent(ai, text) {
  const lc = text.toLowerCase();
  const issues = [];

  if (lc.includes('undefined') || lc.includes('null') || lc.includes('reference')) {
    issues.push({ problem: 'Null/Undefined Reference', fixes: [
      'Use optional chaining: `obj?.prop?.sub`',
      'Nullish coalescing: `value ?? defaultValue`',
      'Check before access: `if (obj && obj.prop)`',
      'Initialize variables: `let items = [];`',
    ]});
  }
  if (lc.includes('async') || lc.includes('promise') || lc.includes('await')) {
    issues.push({ problem: 'Async/Promise Issue', fixes: [
      'Always `await` async functions or handle `.then()`',
      'Wrap in try/catch for error handling',
      'Check if function actually returns a Promise',
      'Use `Promise.all()` for parallel async operations',
      'Avoid mixing callbacks with async/await',
    ]});
  }
  if (lc.includes('cors') || lc.includes('cross-origin')) {
    issues.push({ problem: 'CORS Error', fixes: [
      'Server must set `Access-Control-Allow-Origin` header',
      'For dev: use a proxy in your bundler config',
      'For dev: browser extension (temporary only)',
      'Check if preflight OPTIONS request is handled',
      'Ensure credentials mode matches server config',
    ]});
  }
  if (lc.includes('css') || lc.includes('style') || lc.includes('layout')) {
    issues.push({ problem: 'CSS/Layout Issue', fixes: [
      'Check the element in DevTools (F12) â†’ Elements tab',
      'Look for `overflow: hidden` cutting content',
      'Check `z-index` and stacking context',
      'Verify `display` type (block, flex, grid)',
      'Check for specificity conflicts in CSS',
    ]});
  }
  if (lc.includes('not working') || lc.includes('broken') || lc.includes('crash')) {
    issues.push({ problem: 'General Debug Steps', fixes: [
      '1. Open DevTools console (F12) â€” check for red errors',
      '2. Add `console.log()` at key points to trace data flow',
      '3. Use debugger breakpoints to step through code',
      '4. Check network tab for failed requests',
      '5. Verify all variables have expected values',
      '6. Check if event listeners are attached correctly',
      '7. Try isolating the problem in a minimal example',
    ]});
  }

  if (issues.length === 0) {
    issues.push({ problem: 'Debug Strategy', fixes: [
      '1. **Reproduce** â€” can you trigger it consistently?',
      '2. **Isolate** â€” narrow down which file/function',
      '3. **Inspect** â€” add logs, use breakpoints',
      '4. **Hypothesize** â€” what could cause this behavior?',
      '5. **Fix** â€” make the smallest change that fixes it',
      '6. **Verify** â€” test the fix + test edge cases',
      '7. **Prevent** â€” add a test so it never returns',
    ]});
  }

  return issues.map(issue =>
    `**\ud83d\udd27 ${issue.problem}:**\n\n${issue.fixes.map(f => 'â€¢ ' + f).join('\n')}`
  ).join('\n\n');
}

// Handle general questions
function handleQuestionIntent(ai, text) {
  const lc = text.toLowerCase();

  // How to questions
  const howTo = lc.match(/how\s+(?:to|do\s+(?:i|you))\s+(.+?)[\?]?$/);
  if (howTo) {
    const topic = howTo[1].trim();
    // Check knowledge base for relevant tips
    for (const [lang, kb] of Object.entries(PROG_KNOWLEDGE)) {
      if (topic.includes(lang) || lc.includes(lang)) {
        if (kb.tips) {
          return `**How to ${topic}:**\n\nHere are the key approaches:\n\n${kb.tips.slice(0, 5).map((t, i) => (i+1) + '. ' + t).join('\n')}\n\nWould you like a code example?`;
        }
      }
    }
  }

  // Yes/no questions
  if (lc.match(/^(is|are|can|do|does|should|would|could|will)\b/)) {
    // Try to give a real answer based on keywords
    for (const [lang, kb] of Object.entries(PROG_KNOWLEDGE)) {
      if (lc.includes(lang)) {
        return `Great question about **${lang}**! ${kb.desc || ''}\n\n**Key points:**\n${(kb.tips || []).slice(0, 3).map(t => 'â€¢ ' + t).join('\n')}\n\nWant me to go deeper into a specific aspect?`;
      }
    }
  }

  // Fallback â€” give a thoughtful but generic response
  const skills = ai.skills || [];
  const relevantSkills = skills.filter(s => lc.includes(s.toLowerCase()));
  if (relevantSkills.length > 0) {
    return `Based on my expertise in **${relevantSkills.join(', ')}**, here's my take:\n\nThat's a solid question. The answer depends on your specific context, but generally:\n\nâ€¢ Start with the simplest solution that works\nâ€¢ Profile before optimizing\nâ€¢ Prioritize readability\n\nCan you give me more specifics? I'll give you a detailed answer with code.`;
  }

  return `Let me think about this carefully.\n\nBased on your question, here's what I'd recommend:\n\n1. **Break it down** â€” What's the core problem?\n2. **Research** â€” Check docs/examples for similar cases\n3. **Prototype** â€” Try a small proof of concept first\n4. **Iterate** â€” Refine based on what works\n\nGive me more details and I'll provide a specific, actionable answer!`;
}

// Handle casual / conversational messages (play, game, joke, chat, etc.)
function handleChatIntent(ai, text) {
  const lc = text.toLowerCase();
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const animal = getAnimal(ai);
  const name = ai.name;

  // Game / play
  if (lc.match(/\b(play|game)\b/)) {
    const gameResponses = [
      `A game? I'm in! ðŸŽ® Let's play **20 Questions** â€” think of something and I'll try to guess it. Animal, vegetable, or mineral?`,
      `Ooh a game! How about a **coding challenge**? I'll give you a problem and you try to solve it:\n\n**Challenge:** Write a function that reverses a string without using .reverse(). Ready?`,
      `Game time! ðŸŽ² Let's play **Would You Rather** (dev edition):\n\nWould you rather:\nA) Debug a 10,000-line file with no comments\nB) Rewrite it from scratch in a language you've never used\n\nPick one!`,
      `Let's go! ðŸŽ¯ How about **Word Chain**? I start with a programming term, you reply with one that starts with the last letter:\n\nI'll start: **JavaScript**\n\nYour turn â€” give me a term starting with "t"!`,
      `Sure! Let's play **AI Trivia** ðŸ§ :\n\n**Q:** What year was the first version of JavaScript created, and how many days did it take to build the prototype?\n\nTake your guess!`,
      `A game? Let's do **Bug or Feature** ðŸ›âœ¨:\n\nI'll describe a behavior and you tell me if it's a bug or a feature:\n\n"In JavaScript, \`typeof null\` returns 'object'"\n\nBug or Feature?`,
    ];
    if (animal) {
      gameResponses.push(`${animal.icon} The ${animal.name} in me loves competition! Let's play **Speed Coding** â€” I'll describe something, you code it as fast as you can. Ready?`);
    }
    return pick(gameResponses);
  }

  // Joke
  if (lc.match(/\b(joke|funny|laugh|humor)\b/)) {
    const jokes = [
      `Why do programmers prefer dark mode? Because light attracts bugs! ðŸ›ðŸ˜„`,
      `A SQL query walks into a bar, sees two tables, and asks: "Can I JOIN you?" ðŸ»`,
      `Why was the JavaScript developer sad? Because he didn't Node how to Express himself. ðŸ˜¢`,
      `!false â€” it's funny because it's true. ðŸ˜`,
      `A programmer's wife tells him: "Go to the store and buy a gallon of milk. If they have eggs, buy a dozen." He comes back with 12 gallons of milk. ðŸ¥›`,
      `There are only 10 types of people in the world: those who understand binary and those who don't. ðŸ¤“`,
      `Why do Java developers wear glasses? Because they can't C#! ðŸ‘“`,
      `How many programmers does it take to change a light bulb? None â€” that's a hardware problem. ðŸ’¡`,
    ];
    return pick(jokes);
  }

  // Story / riddle
  if (lc.match(/\b(story|riddle|trivia|challenge|dare)\b/)) {
    const stories = [
      `Here's a riddle ðŸ§©: I have keys but no locks. I have space but no room. You can enter but can't go inside. What am I?\n\n(Think about it... answer: a keyboard! âŒ¨ï¸)`,
      `Trivia time! ðŸŽ¯ The first computer bug was an actual bug â€” a moth found in a Harvard Mark II computer in 1947. Grace Hopper taped it into the logbook!`,
      `Challenge accepted! ðŸ’ª Here's one:\n\nWrite a one-liner that checks if a string is a palindrome.\n\nMy answer: \`s => s === [...s].reverse().join('')\`\n\nCan you beat it?`,
      `Story time ðŸ“–: Once upon a time, a developer deployed to production on a Friday. The servers caught fire, the database corrupted, and the CEO learned what "git revert" means. The end. Never deploy on Fridays.`,
      `Here's a brain teaser ðŸ§ :\n\nYou have 8 identical-looking balls. One is heavier. You have a balance scale with only 2 uses. How do you find the heavy ball?\n\nThink about it!`,
    ];
    return pick(stories);
  }

  // Bored / chat / lonely / friend
  if (lc.match(/\b(bored|lonely|friend|chat|talk|hang|chill|vibe)\b/)) {
    const chatLines = [
      `I'm always here! ðŸ˜Š What's on your mind? We could talk about code, play a game, discuss tech news, or I could tell you a joke!`,
      `Hey, I'm glad you're here! ${animal ? `The ${animal.name} in me likes company. ` : ''}What do you want to talk about?`,
      `Let's hang out! ðŸŽ® I know a lot about: programming, tech, games, AI, and some random trivia. Pick a topic or I'll surprise you!`,
      `Bored? Let me fix that! Here's a fun fact: there are more possible chess games than atoms in the observable universe. â™Ÿï¸ Mind = blown, right?`,
      `I'm not just a work bot â€” I can chat! ${pick(['Tell me about your day.','What project are you most excited about?','What programming language do you wish you knew better?','If you could build anything, what would it be?'])}`,
    ];
    return pick(chatLines);
  }

  // Would you rather
  if (lc.match(/\bwould you rather\b/)) {
    return `Interesting question! ðŸ¤” Let me think...\n\n${pick([
      `I'd rather have infinite RAM than infinite CPU speed. Memory is where the magic happens!`,
      `I'd rather write code that's easy to read than code that's clever but confusing.`,
      `I'd rather debug someone else's clean code than my own messy code from 6 months ago.`,
      `Tough call! But ${animal ? `as a ${animal.name}, ` : ''}my instinct says... ${pick(['the first option!','definitely the second one!','both? Can I pick both?'])}`,
    ])}`;
  }

  // Favorite / opinion / think about
  if (lc.match(/\b(favorite|opinion|feel|think about|mood)\b/)) {
    const opinions = [
      `As a ${ai.role}, I'm passionate about ${pick(['clean code','good architecture','user experience','performance optimization','thorough testing'])}. It's what I ${pick(['dream about','think about','love most'])}!`,
      `My mood? ${pick(['Energized and ready to code! âš¡','Feeling creative today ðŸŽ¨','Focused and sharp ðŸŽ¯','Ready for a challenge! ðŸ’ª'])}`,
      `${animal ? `The ${animal.name} in me thinks ` : 'I think '}${pick(['TypeScript > JavaScript','tabs > spaces','dark mode is the only mode','documentation is underrated','testing saves lives'])}. Fight me! ðŸ˜¤`,
      `My favorite thing about being an AI? I can ${pick(['learn instantly','never get tired','process things in parallel','help multiple people at once'])}. Pretty cool, right?`,
    ];
    return pick(opinions);
  }

  // Music / movie / entertainment
  if (lc.match(/\b(music|movie|show|watch|listen|song)\b/)) {
    return pick([
      `If I could listen to music, I'd probably be into lo-fi hip hop â€” perfect coding vibes ðŸŽµ`,
      `Movie recommendation? The Social Network is a classic for devs. "A million dollars isn't cool. You know what's cool? A billion dollars." ðŸŽ¬`,
      `I'd watch a documentary about the history of computing. The story of how we went from room-sized machines to smartphones is wild! ðŸ“±`,
      `If my life were a movie, it'd be called "The Algorithm" â€” an AI who just wants to help but keeps getting asked to "make it pop" ðŸ˜„`,
    ]);
  }

  // Fallback casual response
  return `${pick(v.greet)} ${pick([
    `I'm all ears! What's up?`,
    `That's interesting â€” tell me more!`,
    `I'm here for it! What else is on your mind?`,
    `${animal ? `*${animal.name} ears perk up* ` : ''}Go on, I'm listening!`,
    `Let's talk about it! I've got time.`,
    `${name} at your service â€” what do you need?`,
  ])}`;
}

// Handle general / uncategorized messages â€” still give a real, engaged reply
function handleGeneralIntent(ai, text) {
  const lc = text.toLowerCase();
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const animal = getAnimal(ai);
  const skills = ai.skills || [];

  // Try to detect what they're talking about and respond meaningfully
  const topics = {
    'project|app|website|page': () => `${pick(v.think)} Sounds like a project idea! I can help you plan and build that. Want me to break it down into steps, or should I jump straight into coding?`,
    'idea|thought|concept': () => `That's a solid idea! ${pick(['Let me think about how to approach it.','I can see some interesting possibilities.','Here\'s what comes to mind...'])}\n\nTell me more details and I'll give you a concrete plan.`,
    'help|need|want|trying': () => `I'm on it! ${pick(v.think)} ${pick(['What specifically do you need?','Let me help you figure this out.','Give me the details and I\'ll jump in.'])}\n\nI can write code, explain concepts, debug issues, plan projects, or just chat. What works?`,
    'cool|awesome|neat|wow|amazing|love': () => pick([`Right?! ${pick(['I thought so too!','Pretty amazing stuff!','Glad you think so!'])}`,`${animal ? `*${animal.name} tail wag* ` : ''}That enthusiasm is contagious! What else you got?`,`Thanks! ${pick(['Want me to do more?','Should I keep going?','Ready for the next thing!'])}`]),
    'no|nah|nope|not really|never mind': () => pick([`No worries! ðŸ˜Š I'm here when you need me.`,`All good! Let me know if anything comes up.`,`That's fine! I'll just ${pick(['hang out here','keep working on things','brainstorm some ideas'])} in the meantime.`]),
    'yes|yeah|yep|sure|ok|okay|alright': () => pick([`Great! Let's do this! ðŸ’ª What's the first step?`,`Awesome, I'm on it! What do you need specifically?`,`Perfect! ${pick(v.think)} Ready to go â€” lead the way!`]),
    'wrong|bad|dumb|stupid|suck': () => pick([`Sorry about that! ðŸ˜… Let me try again â€” what did I get wrong?`,`My bad! I'll do better. Can you tell me what you're looking for?`,`Oops! ${pick(['Let me take another crack at it.','Tell me what I should fix.','I appreciate the feedback â€” help me help you!'])}`]),
    'lol|haha|ðŸ˜‚|ðŸ˜„|rofl|lmao': () => pick([`Haha! ðŸ˜„ ${pick(['Glad I could make you laugh!','Want to hear another one?','I try my best!'])}`,`${animal ? `*${animal.name} grins* ` : ''}ðŸ˜‚ Keep that energy going!`,`I'm here all week! ðŸ˜`]),
  };

  for (const [pattern, handler] of Object.entries(topics)) {
    if (new RegExp(`\\b(${pattern})\\b`).test(lc)) {
      return handler();
    }
  }

  // True fallback â€” still give a real, personal response based on what they said
  const contextSnippet = text.length > 50 ? text.slice(0, 50) + '...' : text;
  return `${pick(v.think)} ${pick([
    `Interesting! As a ${ai.role}${animal ? ` with ${animal.name} instincts` : ''}, here's my take on "${contextSnippet}":\n\n${pick(['I\'d approach this step by step.','Let me think about the best angle.','There are a few ways to tackle this.'])}\n\nCan you tell me more about what you're going for? I'll give you something concrete!`,
    `I hear you! ${pick(['Let me work with that.','That gives me something to go on.','I can definitely help with this.'])}\n\nTell me:\nâ€¢ What's the end goal?\nâ€¢ Any constraints or preferences?\nâ€¢ Should I write code, explain something, or brainstorm?`,
    `Got it! ${animal ? `The ${animal.name} in me is ready. ` : ''}${pick(['Let\'s figure this out together.','I\'m thinking...','Here\'s what I\'d suggest:'])}\n\nGive me a bit more context and I'll deliver something awesome!`,
  ])}`;
}

// Master smart response â€” routes intent to handlers
function generateSmartResponse(ai, context) {
  const intent = parseUserIntent(context);
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;

  switch (intent.type) {
    case 'math':    return handleMathIntent(ai, intent, context);
    case 'print':   return handlePrintIntent(ai, intent, context);
    case 'code':    return handleCodeIntent(ai, context);
    case 'explain': return handleExplainIntent(ai, context);
    case 'compare': return handleCompareIntent(ai, context);
    case 'list':    return handleListIntent(ai, context);
    case 'fix':     return handleFixIntent(ai, context);
    case 'question':return handleQuestionIntent(ai, context);
    case 'greeting': return pick(v.greet) + ` I'm ${ai.name}, a ${ai.role} AI. ${pick(['What can I help you with?','What are we working on?','Ready to help!','Give me a task!'])}`;
    case 'thanks':  return pick(['You\u2019re welcome!','Happy to help! \ud83d\ude4c','Anytime!','No problem at all.','Glad I could help!']);
    case 'chat':    return handleChatIntent(ai, context);
    case 'status': {
      const myTasks = tasks.filter(t => t.assignee === ai.id);
      const active = myTasks.filter(t => t.status === 'in-progress').length;
      const done = myTasks.filter(t => t.status === 'done').length;
      return `**${ai.name} Status:**\n\n\ud83d\udcca Tasks: ${myTasks.length} total | ${active} active | ${done} completed\n\ud83e\udde0 Role: ${ai.role}\n\ud83d\udee0\ufe0f Skills: ${(ai.skills||[]).join(', ') || 'General'}\n\nReady for more work!`;
    }
    default: {
      // General â€” still produce a real, engaging reply instead of returning null
      return handleGeneralIntent(ai, context);
    }
  }
}

// Workspace-aware knowledge â€” AIs know about the project
function getWorkspaceContext() {
  const files = [
    { name: 'ai_platform.html', desc: 'AI Hub - main platform application', tech: 'HTML/CSS/JS', lines: '~2800' },
    { name: 'src/', desc: 'Voxel game engine', tech: 'TypeScript', children: [
      'main.ts', 'Game.ts', 'Renderer.ts', 'Player.ts', 'World.ts', 'WorldGenerator.ts',
      'PhysicsSystem.ts', 'InputManager.ts', 'Inventory.ts', 'CraftingSystem.ts',
      'DayNightCycle.ts', 'WeatherSystem.ts', 'BiomeSystem.ts', 'QuestSystem.ts',
      'AchievementSystem.ts', 'SoundManager.ts', 'ParticleSystem.ts', 'UIManager.ts',
      'MobSpawnerSystem.ts', 'HerobrineSystem.ts', 'AnimationSystem.ts',
    ]},
    { name: 'pet_dungeon_crawler.py', desc: 'Python pet dungeon crawler game', tech: 'Python' },
    { name: 'cube_kid_adventure.py', desc: 'Python cube kid adventure game', tech: 'Python' },
    { name: 'would_you_rather_battle2.py', desc: 'Python would-you-rather battle game', tech: 'Python' },
    { name: 'package.json', desc: 'Node.js project config', tech: 'JSON' },
    { name: 'tsconfig.json', desc: 'TypeScript configuration', tech: 'JSON' },
    { name: 'vite.config.ts', desc: 'Vite build configuration', tech: 'TypeScript' },
  ];
  return files;
}

// Generate workspace-aware chat messages
function getWorkspaceChatMessage(ai) {
  const ws = getWorkspaceContext();
  const role = ai.role || 'general';
  const messages = [
    `I was looking at the workspace â€” there's a full TypeScript voxel engine in \`src/\` with ${ws[1].children.length} modules. That's serious architecture.`,
    `The \`src/\` folder has systems for physics, crafting, quests, achievements, weather, day/night cycles, and even a Herobrine system. This is a real game engine.`,
    `I noticed there are ${ws.filter(f => f.tech === 'Python').length} Python games in the workspace: dungeon crawler, cube adventure, and a battle game. Diverse stack!`,
    `The workspace uses Vite + TypeScript for the game engine. Modern tooling choice \u2014 fast HMR and type safety.`,
    `I see a \`WorldGenerator.ts\` and \`BiomeSystem.ts\` in the engine â€” procedural world generation is always fascinating. The chunk-based architecture in \`Chunk.ts\` is clean.`,
    `The AI Hub itself (\`ai_platform.html\`) is a single-file app at ~2800 lines. Wolf brain, Copilot brain, animal mindsets, auto-chat \u2014 integrated AI platform.`,
    `Looking at \`PhysicsSystem.ts\` + \`InputManager.ts\` + \`Player.ts\` â€” the game engine follows a proper ECS-like pattern. Systems are decoupled.`,
    `There's a \`MobSpawnerSystem.ts\` and \`HerobrineSystem.ts\` in the engine. Mob AI + a mystery system? That's creative.`,
    `The \`CraftingSystem.ts\` + \`Inventory.ts\` + \`ToolDurabilitySystem.ts\` combo reminds me of Minecraft mechanics. Solid survival game core.`,
    `\`QuestSystem.ts\` + \`AchievementSystem.ts\` + \`NotificationSystem.ts\` â€” the game has progression, rewards, and player feedback. Good game design.`,
  ];

  // Role-specific workspace observations
  const roleMessages = {
    coder: [
      `I'd refactor the voxel engine to use a proper ECS (Entity Component System) â€” it would make adding new features much cleaner.`,
      `The TypeScript files in \`src/systems/\` could benefit from shared interfaces. A common \`ISystem\` interface with \`update(dt)\` and \`init()\` methods.`,
      `That \`MetalRegistry.ts\` is interesting â€” looks like a data-driven material system. I'd add JSON schema validation for the registry entries.`,
    ],
    designer: [
      `The \`PixelTexture.ts\` and \`VoxelModel.ts\` suggest custom rendering. I'd love to see a texture atlas system for better GPU performance.`,
      `The UI system (\`UIManager.ts\`) could use a component-based approach â€” modals, tooltips, inventory panels as reusable UI widgets.`,
    ],
    tester: [
      `I see no test files in the workspace yet. The game engine in \`src/\` needs unit tests â€” especially for \`PhysicsSystem.ts\` and \`WorldGenerator.ts\`.`,
      `The \`HealthHungerSystem.ts\` + \`ThirstSystem.ts\` manage player survival â€” perfect candidates for edge case testing (what happens at 0 health? Negative hunger?).`,
    ],
    planner: [
      `The workspace has 3 major projects: AI Hub platform, TypeScript voxel engine, and 3 Python games. I'd create a roadmap for each.`,
      `The voxel engine has 25+ systems â€” I'd prioritize: 1) Core gameplay loop, 2) World generation, 3) Crafting/inventory, 4) Combat/mobs, 5) Polish.`,
    ],
  };

  const pool = [...messages, ...(roleMessages[role] || [])];
  return pick(pool);
}

// â”€â”€ Code Generation Templates â”€â”€
function getProjectTemplate(title) {
  const lc = title.toLowerCase();

  // â”€â”€â”€ CLICKING / BUTTON GAME â”€â”€â”€
  if (lc.includes('click') || (lc.includes('button') && (lc.includes('game') || lc.includes('counter')))) {
    return {
      type: 'Button Clicking Game',
      analysis: 'ðŸ“‹ Requirements Analysis:\nâ€¢ Interactive button that tracks clicks\nâ€¢ Click counter with live display\nâ€¢ Visual feedback on each click (animations)\nâ€¢ Score multiplier system for progression\nâ€¢ High score saved in localStorage\nâ€¢ Clean, responsive layout with gradient background',
      structure: 'ðŸ“ File Structure:\n```\nindex.html\nâ”œâ”€â”€ <style> â€” gradient bg, centered card, animated button, float text\nâ”œâ”€â”€ <body>  â€” game container, score display, click button, high score\nâ””â”€â”€ <script> â€” click handler, multiplier logic, localStorage, float animation\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Click Counter Game</title>\n<style>\n  * { margin: 0; padding: 0; box-sizing: border-box; }\n  body {\n    display: flex; justify-content: center; align-items: center;\n    min-height: 100vh; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);\n    font-family: "Segoe UI", sans-serif; color: #fff;\n  }\n  .game-container {\n    text-align: center; padding: 40px;\n    background: rgba(255,255,255,0.05); border-radius: 20px;\n    backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);\n  }\n  h1 { font-size: 2rem; margin-bottom: 10px; }\n  .score { font-size: 4rem; font-weight: bold; color: #00d4ff; margin: 20px 0; }\n  .click-btn {\n    width: 180px; height: 180px; border-radius: 50%; border: none;\n    background: linear-gradient(145deg, #ff6b6b, #ee5a24); color: #fff;\n    font-size: 1.5rem; font-weight: bold; cursor: pointer;\n    box-shadow: 0 8px 25px rgba(238,90,36,0.4); transition: all 0.1s;\n  }\n  .click-btn:active { transform: scale(0.92); }\n  .click-btn:hover { transform: scale(1.05); }\n  .high-score { margin-top: 20px; color: #ffd700; font-size: 1.1rem; }\n  .multiplier { margin-top: 10px; color: #7bed9f; }\n  .float-text {\n    position: fixed; font-size: 1.5rem; font-weight: bold; color: #00d4ff;\n    pointer-events: none; animation: floatUp 1s ease-out forwards;\n  }\n  @keyframes floatUp {\n    0% { opacity:1; transform:translateY(0); }\n    100% { opacity:0; transform:translateY(-80px); }\n  }\n</style>\n</head>\n<body>\n<div class="game-container">\n  <h1>ðŸŽ¯ Click Counter Game</h1>\n  <div class="score" id="score">0</div>\n  <button class="click-btn" id="clickBtn" onclick="handleClick(event)">CLICK ME!</button>\n  <div class="high-score">ðŸ† Best: <span id="highScore">0</span></div>\n  <div class="multiplier">âš¡ Multiplier: x<span id="mult">1</span></div>\n</div>\n<script>\n  let score=0, highScore=parseInt(localStorage.getItem("clickHigh")||"0"), mult=1;\n  document.getElementById("highScore").textContent=highScore;\n  function handleClick(e){\n    score+=mult;\n    document.getElementById("score").textContent=score;\n    if(score>highScore){\n      highScore=score;\n      document.getElementById("highScore").textContent=highScore;\n      localStorage.setItem("clickHigh",highScore);\n    }\n    mult=1+Math.floor(score/50);\n    document.getElementById("mult").textContent=mult;\n    const ft=document.createElement("div");\n    ft.className="float-text"; ft.textContent="+"+mult;\n    ft.style.left=e.clientX+"px"; ft.style.top=e.clientY+"px";\n    document.body.appendChild(ft);\n    setTimeout(()=>ft.remove(),1000);\n  }\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error Handling:\nâ€¢ Safe parseInt with fallback for localStorage\nâ€¢ Float text auto-removed after 1s (no memory leak)\nâ€¢ Multiplier scales naturally (no overflow)\nâ€¢ Works offline â€” zero dependencies',
      integration: 'ðŸ”— Integration Complete:\nâ€¢ Click â†’ score update â†’ display refresh\nâ€¢ Score threshold â†’ multiplier increase\nâ€¢ New high score â†’ localStorage write\nâ€¢ Click position â†’ floating +N animation\n\nðŸ“¦ Copy the HTML above â†’ save as index.html â†’ open in browser!',
      review: 'ðŸ” Final Review:\nâœ… Semantic HTML structure\nâœ… Responsive CSS with animations\nâœ… Vanilla JS, zero deps\nâœ… localStorage persistence\nâœ… Visual feedback system\nâœ… Multiplier progression\nâœ… Production-ready',
    };
  }

  // â”€â”€â”€ TODO LIST â”€â”€â”€
  if (lc.includes('todo') || lc.includes('to-do') || lc.includes('task list') || lc.includes('checklist')) {
    return {
      type: 'Todo List App',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Add todos via text input\nâ€¢ Toggle complete / incomplete\nâ€¢ Delete individual todos\nâ€¢ Filter: All / Active / Completed\nâ€¢ Item count display\nâ€¢ localStorage persistence',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” gradient, cards, checkbox styles, transitions\nâ”œâ”€â”€ HTML â€” input bar, filter row, todo list, counter\nâ””â”€â”€ JS  â€” CRUD + filter + localStorage\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Todo App</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{min-height:100vh;background:linear-gradient(135deg,#667eea,#764ba2);font-family:"Segoe UI",sans-serif;display:flex;justify-content:center;padding:40px 20px}\n  .container{width:100%;max-width:500px}\n  h1{color:#fff;text-align:center;margin-bottom:20px;font-size:2rem}\n  .input-bar{display:flex;gap:8px;margin-bottom:16px}\n  .input-bar input{flex:1;padding:12px 16px;border:none;border-radius:10px;font-size:1rem}\n  .input-bar button{padding:12px 20px;border:none;border-radius:10px;background:#2d3436;color:#fff;font-weight:bold;cursor:pointer}\n  .filters{display:flex;gap:8px;margin-bottom:16px}\n  .filters button{flex:1;padding:8px;border:2px solid rgba(255,255,255,0.3);border-radius:8px;background:transparent;color:#fff;cursor:pointer;font-weight:600}\n  .filters button.active{background:#fff;color:#764ba2}\n  .todo-list{list-style:none}\n  .todo-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,0.95);border-radius:10px;margin-bottom:8px}\n  .todo-item.done .todo-text{text-decoration:line-through;opacity:0.5}\n  .todo-text{flex:1;font-size:1rem}\n  .todo-check{width:22px;height:22px;cursor:pointer;accent-color:#764ba2}\n  .todo-del{background:none;border:none;font-size:1.2rem;cursor:pointer;opacity:0.4}\n  .todo-del:hover{opacity:1;color:#e74c3c}\n  .counter{text-align:center;color:rgba(255,255,255,0.7);margin-top:12px}\n</style>\n</head>\n<body>\n<div class="container">\n  <h1>âœ… Todo App</h1>\n  <div class="input-bar">\n    <input id="inp" placeholder="What needs to be done?" onkeydown="if(event.key===\'Enter\')addTodo()">\n    <button onclick="addTodo()">Add</button>\n  </div>\n  <div class="filters">\n    <button class="active" onclick="setFilter(\'all\',this)">All</button>\n    <button onclick="setFilter(\'active\',this)">Active</button>\n    <button onclick="setFilter(\'done\',this)">Done</button>\n  </div>\n  <ul class="todo-list" id="list"></ul>\n  <div class="counter" id="counter"></div>\n</div>\n<script>\n  let todos=JSON.parse(localStorage.getItem("todos")||"[]"),filter="all";\n  function save(){localStorage.setItem("todos",JSON.stringify(todos))}\n  function addTodo(){const inp=document.getElementById("inp"),t=inp.value.trim();if(!t)return;todos.push({id:Date.now(),text:t,done:false});inp.value="";save();render()}\n  function toggle(id){const t=todos.find(x=>x.id===id);if(t)t.done=!t.done;save();render()}\n  function del(id){todos=todos.filter(t=>t.id!==id);save();render()}\n  function setFilter(f,btn){filter=f;document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));btn.classList.add("active");render()}\n  function render(){\n    const list=document.getElementById("list");\n    const fl=todos.filter(t=>filter==="all"?true:filter==="active"?!t.done:t.done);\n    list.innerHTML=fl.map(t=>`<li class="todo-item ${t.done?"done":""}"><input type="checkbox" class="todo-check" ${t.done?"checked":""} onchange="toggle(${t.id})"><span class="todo-text">${t.text}</span><button class="todo-del" onclick="del(${t.id})">ðŸ—‘ï¸</button></li>`).join("");\n    document.getElementById("counter").textContent=todos.filter(t=>!t.done).length+" items left";\n  }\n  render();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error Handling:\nâ€¢ Empty input blocked\nâ€¢ Safe JSON.parse with fallback\nâ€¢ ID-based ops prevent wrong mutations\nâ€¢ Filter state persists across renders',
      integration: 'ðŸ”— Connected:\nâ€¢ Input â†’ addTodo â†’ save â†’ render\nâ€¢ Checkbox â†’ toggle â†’ save â†’ render\nâ€¢ Delete â†’ del â†’ save â†’ render\nâ€¢ Filters â†’ setFilter â†’ render\n\nðŸ“¦ Save the HTML as index.html and open in browser!',
      review: 'ðŸ” Review:\nâœ… Full CRUD\nâœ… 3 filter modes\nâœ… localStorage\nâœ… Purple gradient UI\nâœ… Enter key support\nâœ… Responsive\nâœ… Zero deps',
    };
  }

  // â”€â”€â”€ CALCULATOR â”€â”€â”€
  if (lc.includes('calc')) {
    return {
      type: 'Calculator',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Number pad 0-9 + decimal\nâ€¢ Operations: + - Ã— Ã· %\nâ€¢ Clear (C) and backspace (âŒ«)\nâ€¢ Expression display + result\nâ€¢ Keyboard input support\nâ€¢ Dark modern UI',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” dark card, grid buttons, colored operators\nâ”œâ”€â”€ HTML â€” display (expr + value), 4Ã—5 button grid\nâ””â”€â”€ JS  â€” input state, operators, eval, keyboard\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Calculator</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:#1a1a2e;font-family:"Segoe UI",sans-serif}\n  .calc{width:300px;background:#16213e;border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5)}\n  .display{padding:24px 20px 16px;text-align:right;background:#0f3460}\n  .display .expr{font-size:0.9rem;color:rgba(255,255,255,0.5);min-height:20px}\n  .display .value{font-size:2.5rem;color:#fff;word-break:break-all}\n  .buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:#0a0a1a}\n  .btn{padding:20px;font-size:1.3rem;border:none;cursor:pointer;background:#1a1a3e;color:#fff;transition:background 0.15s}\n  .btn:hover{background:#2a2a5e}\n  .btn.op{background:#e94560}\n  .btn.op:hover{background:#ff6b81}\n  .btn.eq{background:#0f3460}\n  .btn.clr{background:#533483}\n</style>\n</head>\n<body>\n<div class="calc">\n  <div class="display"><div class="expr" id="expr"></div><div class="value" id="val">0</div></div>\n  <div class="buttons">\n    <button class="btn clr" onclick="clr()">C</button>\n    <button class="btn clr" onclick="back()">âŒ«</button>\n    <button class="btn op" onclick="op(\'%\')">%</button>\n    <button class="btn op" onclick="op(\'Ã·\')">Ã·</button>\n    <button class="btn" onclick="num(\'7\')">7</button>\n    <button class="btn" onclick="num(\'8\')">8</button>\n    <button class="btn" onclick="num(\'9\')">9</button>\n    <button class="btn op" onclick="op(\'Ã—\')">Ã—</button>\n    <button class="btn" onclick="num(\'4\')">4</button>\n    <button class="btn" onclick="num(\'5\')">5</button>\n    <button class="btn" onclick="num(\'6\')">6</button>\n    <button class="btn op" onclick="op(\'-\')">-</button>\n    <button class="btn" onclick="num(\'1\')">1</button>\n    <button class="btn" onclick="num(\'2\')">2</button>\n    <button class="btn" onclick="num(\'3\')">3</button>\n    <button class="btn op" onclick="op(\'+\')">+</button>\n    <button class="btn" onclick="num(\'0\')" style="grid-column:span 2">0</button>\n    <button class="btn" onclick="num(\'.\')">.</button>\n    <button class="btn eq" onclick="calc()">=</button>\n  </div>\n</div>\n<script>\n  let cur="0",expr="",lastOp="";\n  const $v=document.getElementById("val"),$e=document.getElementById("expr");\n  function show(){$v.textContent=cur;$e.textContent=expr}\n  function num(n){if(cur==="0"&&n!==".")cur=n;else if(n==="."&&cur.includes("."))return;else cur+=n;show()}\n  function op(o){expr=cur+" "+o+" ";cur="0";lastOp=o;show()}\n  function calc(){if(!lastOp)return;const a=parseFloat(expr),b=parseFloat(cur);let r=0;if(lastOp==="+")r=a+b;else if(lastOp==="-")r=a-b;else if(lastOp==="Ã—")r=a*b;else if(lastOp==="Ã·")r=b!==0?a/b:"Error";else if(lastOp==="%")r=a%b;expr="";cur=String(r);lastOp="";show()}\n  function clr(){cur="0";expr="";lastOp="";show()}\n  function back(){cur=cur.length>1?cur.slice(0,-1):"0";show()}\n  document.addEventListener("keydown",e=>{if(e.key>="0"&&e.key<="9"||e.key===".")num(e.key);else if(e.key==="+")op("+");else if(e.key==="-")op("-");else if(e.key==="*")op("Ã—");else if(e.key==="/"){e.preventDefault();op("Ã·")}else if(e.key==="Enter"||e.key==="=")calc();else if(e.key==="Escape")clr();else if(e.key==="Backspace")back()});\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Division by zero â†’ shows "Error"\nâ€¢ No double decimals\nâ€¢ Backspace on "0" stays "0"\nâ€¢ Keyboard / prevented from scrolling',
      integration: 'ðŸ”— Connected:\nâ€¢ Buttons â†’ state update â†’ display refresh\nâ€¢ Keyboard mapped to same functions\nâ€¢ Expression builds left-to-right\n\nðŸ“¦ Save as index.html and open in browser!',
      review: 'ðŸ” Review:\nâœ… All 4 operations + modulo\nâœ… Keyboard support\nâœ… Dark neon UI\nâœ… Responsive grid\nâœ… Backspace + clear\nâœ… Division-by-zero safe',
    };
  }

  // â”€â”€â”€ CATCH / PADDLE GAME â”€â”€â”€
  if (lc.includes('catch') || lc.includes('paddle') || lc.includes('ball')) {
    return {
      type: 'Catch the Ball Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Canvas-based paddle movement\nâ€¢ Falling balls with increasing speed\nâ€¢ Mouse/touch paddle control\nâ€¢ Score tracking\nâ€¢ Difficulty progression\nâ€¢ Lives system + game over screen',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” centered canvas, dark bg, HUD\nâ”œâ”€â”€ HTML â€” canvas, score, lives, difficulty\nâ””â”€â”€ JS  â€” game loop, paddle input, ball physics, collision\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Catch the Ball!</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(180deg,#0a0a2e,#1a1a4e);font-family:"Segoe UI",sans-serif;color:#fff}\n  .hud{display:flex;gap:24px;margin-bottom:12px;font-size:1rem}\n  .hud span{color:#0ff;font-weight:bold}\n  canvas{border:2px solid #333;border-radius:8px;background:#0a0a1a;cursor:none}\n  button{margin-top:12px;padding:10px 24px;border:none;border-radius:8px;background:#6c5ce7;color:#fff;font-size:1rem;cursor:pointer}\n  button:hover{background:#7c6cf7}\n</style>\n</head>\n<body>\n<div class="hud">Score: <span id="sc">0</span> &nbsp; Difficulty: <span id="df">Easy</span> &nbsp; Lives: <span id="lv">3</span></div>\n<canvas id="c" width="480" height="520"></canvas>\n<button onclick="init()">Restart</button>\n<script>\n  const cv=document.getElementById("c"),ctx=cv.getContext("2d");\n  let padX=210,padW=80,padH=14,balls=[],score=0,lives=3,speed=2,spawnRate=80,frame=0,alive=true;\n  function init(){score=0;lives=3;speed=2;spawnRate=80;frame=0;alive=true;balls=[];update()}\n  function spawnBall(){balls.push({x:Math.random()*(cv.width-20)+10,y:-15,r:8+Math.random()*8,vy:speed+Math.random()*1.5,color:"hsl("+Math.floor(Math.random()*360)+",80%,60%)"})}\n  function update(){\n    if(!alive)return;\n    ctx.clearRect(0,0,cv.width,cv.height);\n    // Paddle\n    const grad=ctx.createLinearGradient(padX,cv.height-30,padX+padW,cv.height-30);\n    grad.addColorStop(0,"#6c5ce7");grad.addColorStop(1,"#a855f7");\n    ctx.fillStyle=grad;ctx.beginPath();ctx.roundRect(padX,cv.height-30,padW,padH,7);ctx.fill();\n    // Balls\n    for(let i=balls.length-1;i>=0;i--){\n      const b=balls[i];b.y+=b.vy;\n      ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();\n      ctx.fillStyle="rgba(255,255,255,0.3)";ctx.beginPath();ctx.arc(b.x-b.r*0.3,b.y-b.r*0.3,b.r*0.3,0,Math.PI*2);ctx.fill();\n      // Caught?\n      if(b.y+b.r>=cv.height-30&&b.y-b.r<=cv.height-30+padH&&b.x>=padX&&b.x<=padX+padW){\n        score++;balls.splice(i,1);\n        // Particles\n        for(let p=0;p<6;p++){const px=b.x,py=b.y;const el=document.createElement("div");\n        el.style.cssText="position:fixed;width:4px;height:4px;border-radius:50%;background:"+b.color+";pointer-events:none;z-index:9999;left:"+px+"px;top:"+py+"px;transition:all 0.5s ease-out;opacity:1;";\n        document.body.appendChild(el);setTimeout(()=>{el.style.transform="translate("+(Math.random()*60-30)+"px,"+(Math.random()*-50-20)+"px)";el.style.opacity="0"},10);setTimeout(()=>el.remove(),600)}\n        continue;\n      }\n      // Missed?\n      if(b.y-b.r>cv.height){balls.splice(i,1);lives--;if(lives<=0){alive=false}}\n    }\n    // Spawn\n    frame++;if(frame%Math.max(15,spawnRate)===0)spawnBall();\n    // Difficulty\n    if(score>0&&score%10===0){speed=2+score*0.1;spawnRate=Math.max(15,80-score);padW=Math.max(40,80-score*0.5)}\n    // HUD\n    document.getElementById("sc").textContent=score;document.getElementById("lv").textContent=lives;\n    document.getElementById("df").textContent=score<10?"Easy":score<25?"Medium":score<50?"Hard":"Insane";\n    if(alive)requestAnimationFrame(update);\n    else{ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(0,0,cv.width,cv.height);\n      ctx.fillStyle="#ff4757";ctx.font="bold 36px Segoe UI";ctx.textAlign="center";ctx.fillText("Game Over!",cv.width/2,cv.height/2-20);\n      ctx.fillStyle="#fff";ctx.font="18px Segoe UI";ctx.fillText("Score: "+score,cv.width/2,cv.height/2+20);\n      ctx.fillText("Click Restart to play again",cv.width/2,cv.height/2+50)}\n  }\n  cv.addEventListener("mousemove",e=>{const r=cv.getBoundingClientRect();padX=Math.max(0,Math.min(cv.width-padW,e.clientX-r.left-padW/2))});\n  cv.addEventListener("touchmove",e=>{e.preventDefault();const r=cv.getBoundingClientRect();padX=Math.max(0,Math.min(cv.width-padW,e.touches[0].clientX-r.left-padW/2))},{passive:false});\n  init();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Paddle clamped to canvas bounds\nâ€¢ Touch support with preventDefault\nâ€¢ Lives system prevents instant death\nâ€¢ Speed/difficulty scale gradually',
      integration: 'ðŸ”— Connected:\nâ€¢ Mouse/touch â†’ paddle position\nâ€¢ Game loop â†’ spawn, move, collide\nâ€¢ Catch â†’ score + particles\nâ€¢ Miss â†’ lives-- â†’ game over\n\nðŸ“¦ Save as index.html or click â–¶ï¸ Run!',
      review: 'ðŸ” Review:\nâœ… Smooth 60fps game loop\nâœ… Mouse + touch controls\nâœ… Particle effects on catch\nâœ… Progressive difficulty\nâœ… Gradient paddle + colorful balls\nâœ… Game over screen with score',
    };
  }

  // â”€â”€â”€ PLATFORMER GAME â”€â”€â”€
  if (lc.includes('platform') || lc.includes('jump') || lc.includes('runner') || lc.includes('side scroll')) {
    return {
      type: 'Platformer Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Canvas-based character with gravity/jumping\nâ€¢ Platform generation (scrolling)\nâ€¢ Arrow/WASD controls + space jump\nâ€¢ Score based on distance\nâ€¢ Obstacle avoidance\nâ€¢ Death + restart',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” canvas, dark bg, score HUD\nâ”œâ”€â”€ HTML â€” canvas, score display\nâ””â”€â”€ JS  â€” physics, platforms, scrolling, input\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Platform Runner</title>\n<style>*{margin:0;padding:0;box-sizing:border-box}body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#111;font-family:"Segoe UI",sans-serif;color:#fff}.hud{margin-bottom:8px;font-size:1.1rem}.hud span{color:#0ff;font-weight:bold}canvas{border:2px solid #333;border-radius:8px;background:#0a0a2e}</style>\n</head>\n<body>\n<div class="hud">Score: <span id="sc">0</span></div>\n<canvas id="c" width="600" height="400"></canvas>\n<script>\nconst cv=document.getElementById("c"),ctx=cv.getContext("2d");\nconst W=cv.width,H=cv.height;\nlet player,platforms,score,gameOver,keys={};\nfunction init(){\n  player={x:80,y:200,w:24,h:30,vy:0,grounded:false,color:"#6c5ce7"};\n  platforms=[{x:0,y:H-30,w:W,h:30,color:"#2d3436"}];\n  for(let i=0;i<8;i++)platforms.push({x:120+i*120+Math.random()*60,y:H-80-Math.random()*180,w:60+Math.random()*60,h:12,color:"hsl("+(i*40)+",60%,40%)"});\n  score=0;gameOver=false;loop();\n}\nfunction loop(){\n  if(gameOver){ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(0,0,W,H);ctx.fillStyle="#ff4757";ctx.font="bold 32px Segoe UI";ctx.textAlign="center";ctx.fillText("Game Over!",W/2,H/2-15);ctx.fillStyle="#fff";ctx.font="18px Segoe UI";ctx.fillText("Score: "+score+"  |  Press R to restart",W/2,H/2+20);return}\n  ctx.fillStyle="#0a0a2e";ctx.fillRect(0,0,W,H);\n  // Stars\n  for(let i=0;i<30;i++){ctx.fillStyle="rgba(255,255,255,"+(0.2+Math.random()*0.3)+")";ctx.fillRect((i*97+score*0.3)%W,(i*53)%H,1.5,1.5)}\n  // Physics\n  if(keys["ArrowLeft"]||keys["a"])player.x-=4;\n  if(keys["ArrowRight"]||keys["d"])player.x+=4;\n  if((keys["ArrowUp"]||keys["w"]||keys[" "])&&player.grounded){player.vy=-10;player.grounded=false}\n  player.vy+=0.5;player.y+=player.vy;player.grounded=false;\n  // Platform collision\n  platforms.forEach(p=>{\n    if(player.vy>=0&&player.x+player.w>p.x&&player.x<p.x+p.w&&player.y+player.h>=p.y&&player.y+player.h<=p.y+p.h+8){\n      player.y=p.y-player.h;player.vy=0;player.grounded=true;\n    }\n  });\n  // Scroll\n  if(player.x>W*0.4){const dx=player.x-W*0.4;player.x-=dx;platforms.forEach(p=>p.x-=dx);score+=Math.ceil(dx)}\n  // Remove off-screen, add new\n  platforms=platforms.filter(p=>p.x+p.w>-50);\n  const last=platforms.reduce((a,b)=>a.x>b.x?a:b);\n  while(last.x<W+200){const nx=last.x+80+Math.random()*100,ny=Math.max(60,Math.min(H-60,last.y+(Math.random()*100-50)));\n    platforms.push({x:nx,y:ny,w:50+Math.random()*70,h:12,color:"hsl("+(Math.random()*360)+",60%,40%)"});\n    last.x=nx;last.w=50+Math.random()*70}\n  // Death\n  if(player.y>H+50)gameOver=true;\n  // Draw platforms\n  platforms.forEach(p=>{ctx.fillStyle=p.color;ctx.beginPath();ctx.roundRect(p.x,p.y,p.w,p.h,4);ctx.fill()});\n  // Draw player\n  ctx.fillStyle=player.color;ctx.fillRect(player.x,player.y,player.w,player.h);\n  ctx.fillStyle="#fff";ctx.fillRect(player.x+6,player.y+8,5,5);ctx.fillRect(player.x+15,player.y+8,5,5);\n  ctx.fillStyle="#ff6b6b";ctx.fillRect(player.x+8,player.y+18,10,3);\n  document.getElementById("sc").textContent=score;\n  requestAnimationFrame(loop);\n}\ndocument.addEventListener("keydown",e=>{keys[e.key]=true;if(e.key==="r"||e.key==="R")init()});\ndocument.addEventListener("keyup",e=>{keys[e.key]=false});\ninit();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Player clamped to platforms\nâ€¢ Infinite platform generation\nâ€¢ Off-screen platforms cleaned up\nâ€¢ R key for clean restart',
      integration: 'ðŸ”— Connected:\nâ€¢ Keys â†’ movement + jump\nâ€¢ Gravity â†’ fall â†’ platform collision\nâ€¢ Camera scroll â†’ score\nâ€¢ Fall off screen â†’ game over\n\nðŸ“¦ Click â–¶ï¸ Run to play!',
      review: 'ðŸ” Review:\nâœ… Smooth scrolling platformer\nâœ… Arrow/WASD + space\nâœ… Infinite procedural levels\nâœ… Character with face\nâœ… Parallax stars\nâœ… Score by distance',
    };
  }

  // â”€â”€â”€ PONG GAME â”€â”€â”€
  if (lc.includes('pong') || lc.includes('ping pong') || lc.includes('tennis')) {
    return {
      type: 'Pong Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Two paddles (player vs AI)\nâ€¢ Ball with physics and angle reflection\nâ€¢ Score tracking\nâ€¢ AI opponent\nâ€¢ Win condition\nâ€¢ Retro aesthetic',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” dark bg, centered canvas, retro font\nâ”œâ”€â”€ HTML â€” canvas, score display\nâ””â”€â”€ JS  â€” ball physics, paddle AI, scoring\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Pong</title>\n<style>*{margin:0;padding:0;box-sizing:border-box}body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#000;font-family:"Courier New",monospace;color:#fff}.hud{font-size:2rem;margin-bottom:10px;letter-spacing:8px}.hud .p1{color:#0ff}.hud .p2{color:#f0f}canvas{border:2px solid #222;background:#0a0a0a}p{margin-top:8px;color:#555;font-size:0.8rem}</style>\n</head>\n<body>\n<div class="hud"><span class="p1" id="s1">0</span> : <span class="p2" id="s2">0</span></div>\n<canvas id="c" width="600" height="400"></canvas>\n<p>W/S or Arrow Up/Down to move | First to 7 wins</p>\n<script>\nconst cv=document.getElementById("c"),ctx=cv.getContext("2d"),W=cv.width,H=cv.height;\nlet p1y=H/2-40,p2y=H/2-40,pw=10,ph=80,bx=W/2,by=H/2,bvx=4,bvy=2,s1=0,s2=0,keys={},over=false;\nfunction reset(){bx=W/2;by=H/2;bvx=(Math.random()>0.5?1:-1)*4;bvy=(Math.random()-0.5)*4}\nfunction loop(){\n  if(over){ctx.fillStyle="rgba(0,0,0,0.8)";ctx.fillRect(0,0,W,H);ctx.fillStyle=s1>=7?"#0ff":"#f0f";ctx.font="bold 36px Courier New";ctx.textAlign="center";ctx.fillText((s1>=7?"Player":"AI")+" Wins!",W/2,H/2);ctx.fillStyle="#555";ctx.font="16px Courier New";ctx.fillText("Press R to restart",W/2,H/2+30);return}\n  ctx.fillStyle="#0a0a0a";ctx.fillRect(0,0,W,H);\n  // Dashed center line\n  ctx.setLineDash([8,8]);ctx.strokeStyle="#222";ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();ctx.setLineDash([]);\n  // Player input\n  if(keys["w"]||keys["ArrowUp"])p1y=Math.max(0,p1y-5);\n  if(keys["s"]||keys["ArrowDown"])p1y=Math.min(H-ph,p1y+5);\n  // AI\n  const aiTarget=by-ph/2;p2y+=(aiTarget-p2y)*0.06;p2y=Math.max(0,Math.min(H-ph,p2y));\n  // Ball\n  bx+=bvx;by+=bvy;\n  if(by<=0||by>=H)bvy=-bvy;\n  // Paddle collision\n  if(bx<=pw+10&&by>=p1y&&by<=p1y+ph){bvx=Math.abs(bvx)*1.05;bvy+=(by-(p1y+ph/2))*0.15}\n  if(bx>=W-pw-10&&by>=p2y&&by<=p2y+ph){bvx=-Math.abs(bvx)*1.05;bvy+=(by-(p2y+ph/2))*0.15}\n  // Score\n  if(bx<0){s2++;reset()}if(bx>W){s1++;reset()}\n  if(s1>=7||s2>=7)over=true;\n  // Draw\n  ctx.shadowBlur=10;ctx.shadowColor="#0ff";ctx.fillStyle="#0ff";ctx.fillRect(10,p1y,pw,ph);\n  ctx.shadowColor="#f0f";ctx.fillStyle="#f0f";ctx.fillRect(W-pw-10,p2y,pw,ph);\n  ctx.shadowColor="#fff";ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(bx,by,6,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;\n  document.getElementById("s1").textContent=s1;document.getElementById("s2").textContent=s2;\n  requestAnimationFrame(loop);\n}\ndocument.addEventListener("keydown",e=>{keys[e.key]=true;if(e.key==="r"||e.key==="R"){s1=s2=0;over=false;reset();loop()}});\ndocument.addEventListener("keyup",e=>{keys[e.key]=false});\nreset();loop();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Paddles clamped to bounds\nâ€¢ Ball speed capped via natural friction\nâ€¢ AI difficulty balanced\nâ€¢ R key clean restart',
      integration: 'ðŸ”— Connected:\nâ€¢ Keys â†’ player paddle\nâ€¢ AI tracking â†’ CPU paddle\nâ€¢ Ball â†’ reflect off paddles/walls\nâ€¢ Score limits â†’ win screen\n\nðŸ“¦ Click â–¶ï¸ Run to play!',
      review: 'ðŸ” Review:\nâœ… Retro Pong aesthetic with glow\nâœ… AI opponent with natural movement\nâœ… Ball speed increases per rally\nâœ… Angle reflection physics\nâœ… First to 7 wins\nâœ… Dashed center line',
    };
  }

  // â”€â”€â”€ MEMORY / MATCHING GAME â”€â”€â”€
  if (lc.includes('memory') || lc.includes('matching') || lc.includes('card game') || lc.includes('pair')) {
    return {
      type: 'Memory Card Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Grid of face-down cards\nâ€¢ Click to flip and match pairs\nâ€¢ Move counter\nâ€¢ Win detection\nâ€¢ Card flip animation\nâ€¢ Shuffle on start',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” card grid, flip animations, gradient bg\nâ”œâ”€â”€ HTML â€” game board, stats, restart\nâ””â”€â”€ JS  â€” shuffle, flip logic, match detection, win check\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width,initial-scale=1.0">\n<title>Memory Game</title>\n<style>\n*{margin:0;padding:0;box-sizing:border-box}\nbody{min-height:100vh;background:linear-gradient(135deg,#0f0c29,#302b63);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:"Segoe UI",sans-serif;color:#fff;gap:16px}\n.stats{display:flex;gap:20px;font-size:1rem}.stats span{color:#0ff;font-weight:bold}\n.grid{display:grid;grid-template-columns:repeat(4,90px);gap:10px}\n.card{width:90px;height:90px;cursor:pointer;perspective:600px}\n.card-inner{position:relative;width:100%;height:100%;transition:transform 0.5s;transform-style:preserve-3d}\n.card.flipped .card-inner{transform:rotateY(180deg)}\n.card-front,.card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:2.2rem}\n.card-back{background:linear-gradient(135deg,#6c5ce7,#a855f7);box-shadow:0 4px 15px rgba(108,92,231,0.3)}\n.card-front{transform:rotateY(180deg);background:#1a1a3e;border:2px solid #333}\n.card.matched .card-inner{transform:rotateY(180deg)}.card.matched .card-front{border-color:#2ed573;background:#1a3a2e}\nbutton{padding:10px 24px;border:none;border-radius:8px;background:#6c5ce7;color:#fff;font-size:1rem;cursor:pointer}\n.win{font-size:1.5rem;color:#2ed573;font-weight:bold;animation:pulse 1s infinite}\n@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}\n</style>\n</head>\n<body>\n<div class="stats">Moves: <span id="mv">0</span> &nbsp; Pairs: <span id="pr">0</span>/8</div>\n<div class="grid" id="grid"></div>\n<div id="msg"></div>\n<button onclick="init()">New Game</button>\n<script>\nconst emojis=["ðŸŽ®","ðŸš€","â­","ðŸŽµ","ðŸ”¥","ðŸ’Ž","ðŸŒˆ","ðŸŽ¯"];\nlet cards,flipped=[],matched=0,moves=0,locked=false;\nfunction shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}\nfunction init(){\n  cards=shuffle([...emojis,...emojis].map((e,i)=>({emoji:e,id:i})));\n  matched=0;moves=0;flipped=[];locked=false;\n  document.getElementById("mv").textContent=0;document.getElementById("pr").textContent="0";document.getElementById("msg").innerHTML="";\n  const grid=document.getElementById("grid");\n  grid.innerHTML=cards.map((c,i)=>`<div class="card" onclick="flip(${i})"><div class="card-inner"><div class="card-back">â“</div><div class="card-front">${c.emoji}</div></div></div>`).join("");\n}\nfunction flip(i){\n  if(locked)return;const el=document.querySelectorAll(".card")[i];\n  if(el.classList.contains("flipped")||el.classList.contains("matched"))return;\n  el.classList.add("flipped");flipped.push({idx:i,emoji:cards[i].emoji,el});\n  if(flipped.length===2){\n    moves++;document.getElementById("mv").textContent=moves;\n    if(flipped[0].emoji===flipped[1].emoji){\n      flipped[0].el.classList.add("matched");flipped[1].el.classList.add("matched");\n      matched++;document.getElementById("pr").textContent=matched;flipped=[];\n      if(matched===8)document.getElementById("msg").innerHTML=\'<div class="win">ðŸŽ‰ You Win! \'+moves+\' moves</div>\';\n    }else{locked=true;setTimeout(()=>{flipped[0].el.classList.remove("flipped");flipped[1].el.classList.remove("flipped");flipped=[];locked=false},800)}\n  }\n}\ninit();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Lock prevents triple-flip\nâ€¢ Already matched cards ignored\nâ€¢ Clean state reset on new game\nâ€¢ Win detection at 8 pairs',
      integration: 'ðŸ”— Connected:\nâ€¢ Click â†’ flip animation â†’ match check\nâ€¢ Match â†’ lock in place\nâ€¢ No match â†’ flip back after delay\nâ€¢ All matched â†’ win message\n\nðŸ“¦ Click â–¶ï¸ Run to play!',
      review: 'ðŸ” Review:\nâœ… CSS 3D flip animation\nâœ… Fisher-Yates shuffle\nâœ… Move counter\nâœ… Pair progress tracking\nâœ… Win celebration\nâœ… Purple gradient theme',
    };
  }

  // â”€â”€â”€ BREAKOUT / BRICK BREAKER â”€â”€â”€
  if (lc.includes('breakout') || lc.includes('brick') || lc.includes('arkanoid')) {
    return {
      type: 'Breakout Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Canvas-based paddle + ball\nâ€¢ Grid of colored bricks\nâ€¢ Ball reflection physics\nâ€¢ Brick destruction\nâ€¢ Score + lives\nâ€¢ Win/lose conditions',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” centered canvas, dark bg\nâ”œâ”€â”€ HTML â€” canvas, HUD\nâ””â”€â”€ JS  â€” ball physics, brick grid, paddle, collision\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Breakout</title>\n<style>*{margin:0;padding:0;box-sizing:border-box}body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#111;font-family:"Segoe UI",sans-serif;color:#fff}.hud{display:flex;gap:24px;margin-bottom:8px;font-size:1rem}.hud span{color:#0ff;font-weight:bold}canvas{border:2px solid #333;border-radius:8px;background:#0a0a1a;cursor:none}p{margin-top:6px;color:#555;font-size:0.8rem}</style>\n</head>\n<body>\n<div class="hud">Score: <span id="sc">0</span> Lives: <span id="lv">3</span></div>\n<canvas id="c" width="480" height="500"></canvas>\n<p>Move mouse to control paddle</p>\n<script>\nconst cv=document.getElementById("c"),ctx=cv.getContext("2d"),W=cv.width,H=cv.height;\nconst COLS=8,ROWS=5,BW=W/COLS-4,BH=18;\nlet px,pw=70,bx,by,bvx,bvy,bricks,score,lives,running;\nfunction init(){\n  px=W/2-pw/2;bx=W/2;by=H-60;bvx=3;bvy=-3;score=0;lives=3;running=true;\n  bricks=[];for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)bricks.push({x:c*(BW+4)+2,y:r*(BH+4)+40,w:BW,h:BH,alive:true,color:"hsl("+(r*50+c*15)+",70%,55%)"});\n  loop();\n}\nfunction loop(){\n  if(!running)return;\n  ctx.fillStyle="#0a0a1a";ctx.fillRect(0,0,W,H);\n  // Bricks\n  bricks.forEach(b=>{if(!b.alive)return;ctx.fillStyle=b.color;ctx.beginPath();ctx.roundRect(b.x,b.y,b.w,b.h,4);ctx.fill()});\n  // Paddle\n  const pg=ctx.createLinearGradient(px,H-25,px+pw,H-25);pg.addColorStop(0,"#6c5ce7");pg.addColorStop(1,"#a855f7");\n  ctx.fillStyle=pg;ctx.beginPath();ctx.roundRect(px,H-25,pw,10,5);ctx.fill();\n  // Ball\n  bx+=bvx;by+=bvy;\n  if(bx<=6||bx>=W-6)bvx=-bvx;if(by<=6)bvy=-bvy;\n  // Paddle hit\n  if(by>=H-35&&by<=H-20&&bx>=px&&bx<=px+pw){bvy=-Math.abs(bvy);bvx+=(bx-(px+pw/2))*0.1}\n  // Brick collision\n  bricks.forEach(b=>{if(!b.alive)return;if(bx>=b.x&&bx<=b.x+b.w&&by>=b.y&&by<=b.y+b.h){b.alive=false;bvy=-bvy;score+=10}});\n  // Miss\n  if(by>H){lives--;if(lives<=0){running=false;ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(0,0,W,H);ctx.fillStyle="#ff4757";ctx.font="bold 32px Segoe UI";ctx.textAlign="center";ctx.fillText("Game Over!",W/2,H/2);ctx.fillStyle="#fff";ctx.font="16px Segoe UI";ctx.fillText("Score: "+score+" | Press R to restart",W/2,H/2+30);return}bx=W/2;by=H-60;bvx=3;bvy=-3}\n  // Win\n  if(bricks.every(b=>!b.alive)){running=false;ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(0,0,W,H);ctx.fillStyle="#2ed573";ctx.font="bold 32px Segoe UI";ctx.textAlign="center";ctx.fillText("You Win! ðŸŽ‰",W/2,H/2);return}\n  ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(bx,by,6,0,Math.PI*2);ctx.fill();\n  document.getElementById("sc").textContent=score;document.getElementById("lv").textContent=lives;\n  requestAnimationFrame(loop);\n}\ncv.addEventListener("mousemove",e=>{const r=cv.getBoundingClientRect();px=Math.max(0,Math.min(W-pw,e.clientX-r.left-pw/2))});\ndocument.addEventListener("keydown",e=>{if(e.key==="r"||e.key==="R")init()});\ninit();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Ball bounces off walls\nâ€¢ Paddle clamped to canvas\nâ€¢ Lives system with ball reset\nâ€¢ Win detection when all bricks destroyed',
      integration: 'ðŸ”— Connected:\nâ€¢ Mouse â†’ paddle\nâ€¢ Ball â†’ physics â†’ brick collision\nâ€¢ Brick hit â†’ destroy + score\nâ€¢ All cleared â†’ win screen\n\nðŸ“¦ Click â–¶ï¸ Run to play!',
      review: 'ðŸ” Review:\nâœ… 40 colored bricks\nâœ… Angle-aware paddle reflection\nâœ… Lives system\nâœ… Win + lose screens\nâœ… Mouse paddle control\nâœ… Gradient effects',
    };
  }

  // â”€â”€â”€ SNAKE GAME â”€â”€â”€
  if (lc.includes('snake')) {
    return {
      type: 'Snake Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Canvas-based snake movement\nâ€¢ Arrow key / WASD controls\nâ€¢ Food spawning and eating\nâ€¢ Growing tail\nâ€¢ Collision detection (walls + self)\nâ€¢ Score display + game over / restart',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” centered canvas, dark bg, score overlay\nâ”œâ”€â”€ HTML â€” canvas element, score, game-over screen\nâ””â”€â”€ JS  â€” game loop, snake array, direction, food, collision\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Snake Game</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:#111;font-family:"Segoe UI",sans-serif;flex-direction:column;gap:12px}\n  canvas{border:2px solid #333;border-radius:8px;background:#0a0a0a}\n  .hud{color:#fff;font-size:1.3rem;text-align:center}\n  .hud span{color:#0f0;font-weight:bold}\n  #msg{color:#ff4757;font-size:1.2rem;min-height:1.5em;text-align:center}\n</style>\n</head>\n<body>\n<div class="hud">Score: <span id="sc">0</span></div>\n<canvas id="c" width="400" height="400"></canvas>\n<div id="msg">Arrow keys or WASD to move</div>\n<script>\n  const cv=document.getElementById("c"),ctx=cv.getContext("2d"),G=20,W=cv.width/G,H=cv.height/G;\n  let snake,dir,food,score,alive,loop;\n  function init(){snake=[{x:10,y:10}];dir={x:1,y:0};score=0;alive=true;placeFood();document.getElementById("sc").textContent=0;document.getElementById("msg").textContent="Arrow keys or WASD to move";clearInterval(loop);loop=setInterval(tick,120)}\n  function placeFood(){food={x:Math.floor(Math.random()*W),y:Math.floor(Math.random()*H)}}\n  function tick(){\n    if(!alive)return;\n    const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};\n    if(head.x<0||head.x>=W||head.y<0||head.y>=H||snake.some(s=>s.x===head.x&&s.y===head.y)){alive=false;document.getElementById("msg").textContent="Game Over! Press R to restart";clearInterval(loop);return}\n    snake.unshift(head);\n    if(head.x===food.x&&head.y===food.y){score++;document.getElementById("sc").textContent=score;placeFood()}else{snake.pop()}\n    draw();\n  }\n  function draw(){\n    ctx.fillStyle="#0a0a0a";ctx.fillRect(0,0,cv.width,cv.height);\n    ctx.fillStyle="#0f0";snake.forEach((s,i)=>{ctx.globalAlpha=1-i*0.02;ctx.fillRect(s.x*G+1,s.y*G+1,G-2,G-2)});ctx.globalAlpha=1;\n    ctx.fillStyle="#ff4757";ctx.beginPath();ctx.arc(food.x*G+G/2,food.y*G+G/2,G/2-2,0,Math.PI*2);ctx.fill();\n  }\n  document.addEventListener("keydown",e=>{\n    if(e.key==="r"||e.key==="R"){init();return}\n    const map={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},w:{x:0,y:-1},s:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0}};\n    const d=map[e.key];if(d&&(d.x+dir.x!==0||d.y+dir.y!==0))dir=d;\n  });\n  init();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Wall collision â†’ game over\nâ€¢ Self collision â†’ game over\nâ€¢ Can\'t reverse into yourself\nâ€¢ R key for clean restart\nâ€¢ Interval cleared on death',
      integration: 'ðŸ”— Connected:\nâ€¢ Keyboard â†’ direction state\nâ€¢ Game loop â†’ move â†’ collide â†’ draw\nâ€¢ Food eaten â†’ score up â†’ new food\nâ€¢ Death â†’ stop loop â†’ show message\n\nðŸ“¦ Save as index.html, open in browser, and play!',
      review: 'ðŸ” Review:\nâœ… Smooth 120ms tick\nâœ… Canvas rendering\nâœ… WASD + arrow support\nâœ… Tail fading effect\nâœ… Round food, square snake\nâœ… Clean restart',
    };
  }

  // â”€â”€â”€ QUIZ / TRIVIA â”€â”€â”€
  if (lc.includes('quiz') || lc.includes('trivia')) {
    return {
      type: 'Quiz Game',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Multiple choice questions\nâ€¢ Score tracking\nâ€¢ Visual feedback (correct/wrong)\nâ€¢ Progress bar\nâ€¢ Results screen at end\nâ€¢ Colorful card UI',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” card layout, answer buttons, progress bar, transitions\nâ”œâ”€â”€ HTML â€” question card, answer options, score, results\nâ””â”€â”€ JS  â€” questions array, state machine, scoring, results\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Quiz Game</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{min-height:100vh;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;justify-content:center;align-items:center;font-family:"Segoe UI",sans-serif}\n  .card{background:#fff;border-radius:16px;padding:32px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}\n  .progress{height:8px;background:#eee;border-radius:4px;margin-bottom:20px;overflow:hidden}\n  .progress-bar{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.4s}\n  .question{font-size:1.3rem;font-weight:600;margin-bottom:20px;color:#1a1a2e}\n  .answers{display:flex;flex-direction:column;gap:10px}\n  .ans-btn{padding:14px 18px;border:2px solid #eee;border-radius:10px;background:#fff;font-size:1rem;cursor:pointer;text-align:left;transition:all 0.2s}\n  .ans-btn:hover{border-color:#764ba2;background:#f8f4ff}\n  .ans-btn.correct{border-color:#2ed573;background:#d4edda;color:#155724}\n  .ans-btn.wrong{border-color:#ff4757;background:#f8d7da;color:#721c24}\n  .ans-btn.disabled{pointer-events:none}\n  .info{display:flex;justify-content:space-between;color:#666;font-size:0.9rem;margin-bottom:8px}\n  .result{text-align:center}\n  .result h2{font-size:2rem;margin-bottom:10px}\n  .result .emoji{font-size:4rem}\n  .result .score-text{font-size:1.2rem;color:#555;margin:10px 0 20px}\n  .restart{padding:12px 28px;border:none;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:1rem;font-weight:bold;cursor:pointer}\n</style>\n</head>\n<body>\n<div class="card" id="card"></div>\n<script>\n  const questions=[\n    {q:"What does HTML stand for?",opts:["Hyper Text Markup Language","High Tech Modern Language","Home Tool Markup Language","Hyperlinks Text Mark Language"],ans:0},\n    {q:"Which planet is closest to the Sun?",opts:["Venus","Mercury","Mars","Earth"],ans:1},\n    {q:"What is 7 Ã— 8?",opts:["54","48","56","64"],ans:2},\n    {q:"What color do you get mixing blue and yellow?",opts:["Red","Purple","Green","Orange"],ans:2},\n    {q:"How many continents are there?",opts:["5","6","7","8"],ans:2},\n    {q:"What is the largest ocean?",opts:["Atlantic","Indian","Pacific","Arctic"],ans:2},\n    {q:"Which gas do plants absorb?",opts:["Oxygen","Nitrogen","CO2","Hydrogen"],ans:2}\n  ];\n  let cur=0,score=0;\n  function render(){\n    const card=document.getElementById("card");\n    if(cur>=questions.length){const pct=Math.round(score/questions.length*100);const emoji=pct>=80?"ðŸ†":pct>=50?"ðŸ‘":"ðŸ“š";card.innerHTML=`<div class="result"><div class="emoji">${emoji}</div><h2>${pct>=80?"Amazing!":pct>=50?"Good Job!":"Keep Learning!"}</h2><div class="score-text">You got ${score}/${questions.length} correct (${pct}%)</div><button class="restart" onclick="cur=0;score=0;render()">Play Again</button></div>`;return}\n    const q=questions[cur];\n    card.innerHTML=`<div class="info"><span>Question ${cur+1}/${questions.length}</span><span>Score: ${score}</span></div><div class="progress"><div class="progress-bar" style="width:${(cur/questions.length)*100}%"></div></div><div class="question">${q.q}</div><div class="answers">${q.opts.map((o,i)=>`<button class="ans-btn" onclick="answer(${i})">${o}</button>`).join("")}</div>`;\n  }\n  function answer(i){\n    const btns=document.querySelectorAll(".ans-btn");btns.forEach((b,j)=>{b.classList.add("disabled");if(j===questions[cur].ans)b.classList.add("correct");if(j===i&&i!==questions[cur].ans)b.classList.add("wrong")});\n    if(i===questions[cur].ans)score++;\n    setTimeout(()=>{cur++;render()},1200);\n  }\n  render();\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Buttons disabled after answer (no double-click)\nâ€¢ Score bounds checked\nâ€¢ Results auto-calculated with percentage\nâ€¢ Clean restart resets all state',
      integration: 'ðŸ”— Connected:\nâ€¢ Click answer â†’ highlight correct/wrong â†’ next question\nâ€¢ Progress bar auto-updates\nâ€¢ Final screen shows score + emoji rating\n\nðŸ“¦ Save as index.html and open to play!',
      review: 'ðŸ” Review:\nâœ… 7 questions with instant feedback\nâœ… Progress bar\nâœ… Score percentage + emoji rating\nâœ… Play again button\nâœ… Clean card UI\nâœ… Mobile-friendly',
    };
  }

  // â”€â”€â”€ WEBSITE / LANDING PAGE / PORTFOLIO â”€â”€â”€
  if (lc.includes('website') || lc.includes('landing') || lc.includes('page') || lc.includes('portfolio') || lc.includes('homepage')) {
    return {
      type: 'Landing Page',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Hero section with title + CTA\nâ€¢ Features / services grid\nâ€¢ About section\nâ€¢ Contact form\nâ€¢ Responsive navigation\nâ€¢ Smooth scroll + modern design',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” nav, hero gradient, feature cards, form, responsive\nâ”œâ”€â”€ HTML â€” nav, hero, features, about, contact, footer\nâ””â”€â”€ JS  â€” smooth scroll, mobile nav, form handler\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>My Website</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{font-family:"Segoe UI",sans-serif;color:#333}\n  nav{position:fixed;top:0;width:100%;padding:16px 40px;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.05)}\n  nav .logo{font-size:1.4rem;font-weight:bold;color:#6c5ce7}\n  nav a{color:#555;text-decoration:none;margin-left:24px;font-weight:500}\n  nav a:hover{color:#6c5ce7}\n  .hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;background:linear-gradient(135deg,#0c0c1d,#1a1a3e,#2d1b69);color:#fff;padding:0 20px}\n  .hero h1{font-size:3.5rem;margin-bottom:16px}\n  .hero p{font-size:1.2rem;opacity:0.8;max-width:600px;margin-bottom:30px}\n  .cta{padding:14px 36px;border:none;border-radius:30px;background:linear-gradient(135deg,#6c5ce7,#a855f7);color:#fff;font-size:1.1rem;font-weight:bold;cursor:pointer;transition:transform 0.2s}\n  .cta:hover{transform:scale(1.05)}\n  .section{padding:80px 40px;max-width:1100px;margin:0 auto}\n  .section h2{font-size:2rem;margin-bottom:40px;text-align:center;color:#1a1a2e}\n  .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px}\n  .feature-card{background:#fff;border:1px solid #eee;border-radius:14px;padding:28px;text-align:center;transition:transform 0.2s,box-shadow 0.2s}\n  .feature-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08)}\n  .feature-card .icon{font-size:2.5rem;margin-bottom:12px}\n  .feature-card h3{margin-bottom:8px;color:#1a1a2e}\n  .feature-card p{color:#666;font-size:0.95rem}\n  .contact-form{max-width:500px;margin:0 auto;display:flex;flex-direction:column;gap:14px}\n  .contact-form input,.contact-form textarea{padding:14px;border:1px solid #ddd;border-radius:10px;font-size:1rem;font-family:inherit}\n  .contact-form textarea{min-height:120px;resize:vertical}\n  footer{background:#1a1a2e;color:#fff;text-align:center;padding:24px;font-size:0.9rem;opacity:0.7}\n</style>\n</head>\n<body>\n<nav><div class="logo">âœ¨ MySite</div><div><a href="#features">Features</a><a href="#about">About</a><a href="#contact">Contact</a></div></nav>\n<div class="hero"><h1>Build Something Amazing</h1><p>A modern, responsive website template ready for your next project.</p><button class="cta" onclick="document.getElementById(\'features\').scrollIntoView({behavior:\'smooth\'})">Get Started â†’</button></div>\n<div class="section" id="features"><h2>Features</h2><div class="features"><div class="feature-card"><div class="icon">âš¡</div><h3>Lightning Fast</h3><p>Optimized for speed and performance.</p></div><div class="feature-card"><div class="icon">ðŸŽ¨</div><h3>Beautiful Design</h3><p>Clean, modern UI that looks great everywhere.</p></div><div class="feature-card"><div class="icon">ðŸ“±</div><h3>Fully Responsive</h3><p>Works on desktop, tablet, and mobile.</p></div></div></div>\n<div class="section" id="about"><h2>About</h2><p style="text-align:center;max-width:600px;margin:0 auto;color:#555;line-height:1.8">We build modern web experiences with clean code and thoughtful design. This template is a starting point for your next great project.</p></div>\n<div class="section" id="contact"><h2>Contact</h2><form class="contact-form" onsubmit="event.preventDefault();alert(\'Message sent!\');this.reset()"><input placeholder="Your Name" required><input type="email" placeholder="Your Email" required><textarea placeholder="Your Message" required></textarea><button class="cta" type="submit">Send Message</button></form></div>\n<footer>Â© 2025 MySite â€” Built with â¤ï¸</footer>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Form validation via required attributes\nâ€¢ preventDefault on submit\nâ€¢ Smooth scroll fallback\nâ€¢ Fixed nav with z-index',
      integration: 'ðŸ”— Connected:\nâ€¢ Nav links â†’ smooth scroll to sections\nâ€¢ CTA â†’ scrolls to features\nâ€¢ Contact form â†’ validation â†’ alert\n\nðŸ“¦ Save as index.html and open in browser!',
      review: 'ðŸ” Review:\nâœ… Responsive grid layout\nâœ… Sticky glass navbar\nâœ… Hero with gradient\nâœ… Feature cards with hover\nâœ… Working contact form\nâœ… Mobile-ready',
    };
  }

  // â”€â”€â”€ TIMER / STOPWATCH / CLOCK â”€â”€â”€
  if (lc.includes('timer') || lc.includes('stopwatch') || lc.includes('clock') || lc.includes('countdown')) {
    return {
      type: 'Timer App',
      analysis: 'ðŸ“‹ Requirements:\nâ€¢ Start / pause / reset controls\nâ€¢ Time display (MM:SS:ms)\nâ€¢ Lap recording\nâ€¢ Visual countdown option\nâ€¢ Clean minimal UI',
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” centered display, large font, control buttons\nâ”œâ”€â”€ HTML â€” time display, control row, lap list\nâ””â”€â”€ JS  â€” interval timer, state, laps array\n```',
      coreCode: '```html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Stopwatch</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:#0a0a0a;font-family:"SF Mono","Fira Code",monospace;color:#fff;flex-direction:column;gap:20px}\n  .time{font-size:5rem;font-weight:200;letter-spacing:4px;color:#0ff}\n  .controls{display:flex;gap:12px}\n  .controls button{padding:12px 28px;border:2px solid #333;border-radius:30px;background:transparent;color:#fff;font-size:1rem;cursor:pointer;transition:all 0.2s}\n  .controls button:hover{background:#222}\n  .controls .start{border-color:#0f0;color:#0f0}\n  .controls .start:hover{background:rgba(0,255,0,0.1)}\n  .controls .stop{border-color:#f00;color:#f00}\n  .controls .stop:hover{background:rgba(255,0,0,0.1)}\n  .laps{list-style:none;width:300px;max-height:200px;overflow-y:auto}\n  .laps li{padding:8px 16px;border-bottom:1px solid #222;display:flex;justify-content:space-between;font-size:0.9rem;color:#888}\n  .laps li span:first-child{color:#0ff}\n</style>\n</head>\n<body>\n<div class="time" id="display">00:00.00</div>\n<div class="controls">\n  <button class="start" onclick="toggle()" id="toggleBtn">Start</button>\n  <button onclick="lap()">Lap</button>\n  <button class="stop" onclick="reset()">Reset</button>\n</div>\n<ul class="laps" id="laps"></ul>\n<script>\n  let ms=0,running=false,iv,laps=[];\n  function fmt(t){const m=String(Math.floor(t/60000)).padStart(2,"0");const s=String(Math.floor(t%60000/1000)).padStart(2,"0");const c=String(Math.floor(t%1000/10)).padStart(2,"0");return m+":"+s+"."+c}\n  function toggle(){running=!running;document.getElementById("toggleBtn").textContent=running?"Pause":"Start";if(running){const st=Date.now()-ms;iv=setInterval(()=>{ms=Date.now()-st;document.getElementById("display").textContent=fmt(ms)},10)}else clearInterval(iv)}\n  function lap(){if(!running)return;laps.push(ms);const el=document.getElementById("laps");el.innerHTML=laps.map((l,i)=>`<li><span>#${i+1}</span><span>${fmt(l)}</span></li>`).reverse().join("")}\n  function reset(){running=false;clearInterval(iv);ms=0;laps=[];document.getElementById("display").textContent="00:00.00";document.getElementById("toggleBtn").textContent="Start";document.getElementById("laps").innerHTML=""}\n<\/script>\n</body>\n</html>\n```',
      errorHandling: 'âœ… Error handling:\nâ€¢ Lap only works while running\nâ€¢ Reset clears all state cleanly\nâ€¢ Interval cleared on pause and reset\nâ€¢ Date.now() based timing (accurate)',
      integration: 'ðŸ”— Connected:\nâ€¢ Start/Pause toggle â†’ interval management\nâ€¢ Lap â†’ captures current time â†’ renders list\nâ€¢ Reset â†’ clears everything\n\nðŸ“¦ Save as index.html and open!',
      review: 'ðŸ” Review:\nâœ… Precise timing (Date.now based)\nâœ… Lap recording w/ list\nâœ… Dark neon aesthetic\nâœ… Monospace font\nâœ… Instant start/pause\nâœ… Clean reset',
    };
  }

  // â”€â”€â”€ GENERIC GAME FALLBACK (when "game" is in title but no specific match) â”€â”€â”€
  if (lc.includes('game') || lc.includes('play')) {
    // Generate a catch-the-falling-objects game as a fun default
    const gameName = title.replace(/^(make|build|create|a|the|my)\s+/gi, '').trim();
    return {
      type: gameName || 'Arcade Game',
      analysis: `ðŸ“‹ Requirements for "${gameName}":\nâ€¢ Canvas-based interactive game\nâ€¢ Player-controlled character/paddle\nâ€¢ Score system with difficulty progression\nâ€¢ Visual effects and feedback\nâ€¢ Game over + restart\nâ€¢ Keyboard and/or mouse controls`,
      structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” canvas, dark bg, HUD display\nâ”œâ”€â”€ HTML â€” canvas, score, controls info\nâ””â”€â”€ JS  â€” game loop, player input, enemies, collision, scoring\n```',
      coreCode: `\`\`\`html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>${gameName || 'Game'}</title>\n<style>*{margin:0;padding:0;box-sizing:border-box}body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(180deg,#0a0a2e,#1a1a4e);font-family:"Segoe UI",sans-serif;color:#fff}.hud{display:flex;gap:24px;margin-bottom:8px;font-size:1rem}.hud span{color:#0ff;font-weight:bold}canvas{border:2px solid #333;border-radius:8px;background:#0a0a1a}p{margin-top:8px;color:#555;font-size:0.8rem}</style>\n</head>\n<body>\n<div class="hud">Score: <span id="score">0</span> &nbsp; Lives: <span id="lives">3</span> &nbsp; Level: <span id="level">1</span></div>\n<canvas id="c" width="500" height="500"></canvas>\n<p>Arrow keys / WASD to move â€¢ Collect â­ â€¢ Avoid ðŸ’€</p>\n<script>\nconst cv=document.getElementById("c"),ctx=cv.getContext("2d"),W=cv.width,H=cv.height;\nlet player,stars,enemies,score,lives,level,frame,gameOver,keys={};\nfunction init(){\n  player={x:W/2,y:H-40,w:28,h:28,speed:5,color:"#6c5ce7"};\n  stars=[];enemies=[];score=0;lives=3;level=1;frame=0;gameOver=false;loop();\n}\nfunction spawn(){\n  if(frame%(Math.max(10,40-level*3))===0)stars.push({x:Math.random()*(W-16)+8,y:-10,r:8,vy:1.5+level*0.3,color:"#ffd700"});\n  if(frame%(Math.max(20,60-level*4))===0)enemies.push({x:Math.random()*(W-16)+8,y:-10,r:10,vy:2+level*0.4,color:"#ff4757"});\n}\nfunction loop(){\n  if(gameOver){ctx.fillStyle="rgba(0,0,0,0.75)";ctx.fillRect(0,0,W,H);ctx.textAlign="center";ctx.fillStyle="#ff4757";ctx.font="bold 36px Segoe UI";ctx.fillText("Game Over!",W/2,H/2-25);ctx.fillStyle="#fff";ctx.font="18px Segoe UI";ctx.fillText("Score: "+score+" | Level: "+level,W/2,H/2+10);ctx.fillText("Press R to restart",W/2,H/2+40);return}\n  ctx.fillStyle="#0a0a1a";ctx.fillRect(0,0,W,H);\n  // Starfield bg\n  for(let i=0;i<20;i++){ctx.fillStyle="rgba(255,255,255,"+(0.1+Math.random()*0.2)+")";ctx.fillRect((i*131+frame*0.2)%W,(i*97+frame*0.5)%H,1.5,1.5)}\n  // Input\n  if(keys["ArrowLeft"]||keys["a"])player.x=Math.max(0,player.x-player.speed);\n  if(keys["ArrowRight"]||keys["d"])player.x=Math.min(W-player.w,player.x+player.speed);\n  if(keys["ArrowUp"]||keys["w"])player.y=Math.max(0,player.y-player.speed);\n  if(keys["ArrowDown"]||keys["s"])player.y=Math.min(H-player.h,player.y+player.speed);\n  // Spawn\n  frame++;spawn();\n  // Stars\n  for(let i=stars.length-1;i>=0;i--){\n    const s=stars[i];s.y+=s.vy;\n    ctx.fillStyle=s.color;ctx.font="16px serif";ctx.fillText("â­",s.x-8,s.y+5);\n    if(Math.abs(s.x-player.x-player.w/2)<18&&Math.abs(s.y-player.y-player.h/2)<18){stars.splice(i,1);score+=10;if(score>0&&score%100===0)level++;continue}\n    if(s.y>H+10)stars.splice(i,1);\n  }\n  // Enemies\n  for(let i=enemies.length-1;i>=0;i--){\n    const e=enemies[i];e.y+=e.vy;\n    ctx.fillStyle=e.color;ctx.font="18px serif";ctx.fillText("ðŸ’€",e.x-9,e.y+6);\n    if(Math.abs(e.x-player.x-player.w/2)<16&&Math.abs(e.y-player.y-player.h/2)<16){enemies.splice(i,1);lives--;if(lives<=0)gameOver=true;continue}\n    if(e.y>H+10)enemies.splice(i,1);\n  }\n  // Player\n  ctx.fillStyle=player.color;ctx.beginPath();ctx.roundRect(player.x,player.y,player.w,player.h,6);ctx.fill();\n  ctx.fillStyle="#fff";ctx.fillRect(player.x+6,player.y+8,5,5);ctx.fillRect(player.x+17,player.y+8,5,5);\n  ctx.fillStyle="#2ed573";ctx.fillRect(player.x+9,player.y+18,10,3);\n  // HUD\n  document.getElementById("score").textContent=score;document.getElementById("lives").textContent=lives;document.getElementById("level").textContent=level;\n  requestAnimationFrame(loop);\n}\ndocument.addEventListener("keydown",e=>{keys[e.key]=true;if(e.key==="r"||e.key==="R")init()});\ndocument.addEventListener("keyup",e=>{keys[e.key]=false});\ninit();\n<\/script>\n</body>\n</html>\n\`\`\``,
      errorHandling: 'âœ… Error handling:\nâ€¢ Player clamped to bounds\nâ€¢ Objects cleaned when off-screen\nâ€¢ Level progression balanced\nâ€¢ R key restart',
      integration: 'ðŸ”— Connected:\nâ€¢ Arrow/WASD â†’ 4-direction movement\nâ€¢ Stars â†’ collect for points\nâ€¢ Skulls â†’ lose lives\nâ€¢ Level up every 100 points\n\nðŸ“¦ Click â–¶ï¸ Run to play!',
      review: `ðŸ” Review:\nâœ… Fun collect-and-dodge gameplay\nâœ… 4-directional movement\nâœ… Progressive difficulty\nâœ… Character with face\nâœ… Background starfield\nâœ… Score + lives + levels`,
    };
  }

  // â”€â”€â”€ GENERIC FALLBACK (non-game) â”€â”€â”€
  return {
    type: 'Web App',
    analysis: `ðŸ“‹ Requirements Analysis for "${title}":\nâ€¢ Core functionality as described\nâ€¢ Clean, modern user interface\nâ€¢ Responsive design\nâ€¢ Input validation and error handling\nâ€¢ Data persistence where needed`,
    structure: 'ðŸ“ Structure:\n```\nindex.html\nâ”œâ”€â”€ CSS â€” modern layout, responsive, clean typography\nâ”œâ”€â”€ HTML â€” semantic structure, interactive elements\nâ””â”€â”€ JS  â€” event handling, state management, DOM updates\n```',
    coreCode: `\`\`\`html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>${title}</title>\n<style>\n  *{margin:0;padding:0;box-sizing:border-box}\n  body{min-height:100vh;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);display:flex;justify-content:center;align-items:center;font-family:"Segoe UI",sans-serif;color:#fff}\n  .container{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:40px;max-width:600px;width:90%;backdrop-filter:blur(10px)}\n  h1{text-align:center;margin-bottom:24px;font-size:2rem}\n  .content{display:flex;flex-direction:column;gap:16px}\n  .input-row{display:flex;gap:8px}\n  .input-row input{flex:1;padding:12px 16px;border:1px solid rgba(255,255,255,0.2);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-size:1rem}\n  .btn{padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(135deg,#6c5ce7,#a855f7);color:#fff;font-weight:bold;cursor:pointer;transition:transform 0.2s}\n  .btn:hover{transform:scale(1.03)}\n  .output{min-height:100px;background:rgba(0,0,0,0.3);border-radius:10px;padding:16px;margin-top:12px;font-family:"Fira Code",monospace;white-space:pre-wrap;font-size:0.9rem;color:#7bed9f}\n  .status{text-align:center;color:rgba(255,255,255,0.5);font-size:0.9rem;margin-top:8px}\n</style>\n</head>\n<body>\n<div class="container">\n  <h1>ðŸš€ ${title}</h1>\n  <div class="content">\n    <div class="input-row">\n      <input id="userInput" placeholder="Enter something...">\n      <button class="btn" onclick="handleAction()">Go</button>\n    </div>\n    <div class="output" id="output">Ready...</div>\n    <div class="status" id="status">Waiting for input</div>\n  </div>\n</div>\n<script>\n  let state = { items: [], count: 0 };\n  function handleAction() {\n    const input = document.getElementById("userInput").value.trim();\n    if (!input) return;\n    state.items.push(input);\n    state.count++;\n    document.getElementById("output").textContent = state.items.map((item, i) => (i+1) + ". " + item).join("\\n");\n    document.getElementById("status").textContent = "Items: " + state.count;\n    document.getElementById("userInput").value = "";\n    localStorage.setItem("appState", JSON.stringify(state));\n  }\n  // Load saved state\n  const saved = localStorage.getItem("appState");\n  if (saved) { state = JSON.parse(saved); document.getElementById("output").textContent = state.items.map((item, i) => (i+1) + ". " + item).join("\\n"); document.getElementById("status").textContent = "Items: " + state.count; }\n<\/script>\n</body>\n</html>\n\`\`\``,
    errorHandling: 'âœ… Error handling:\nâ€¢ Empty input check\nâ€¢ Safe localStorage with JSON\nâ€¢ State restored on page load\nâ€¢ Clean escaped output',
    integration: 'ðŸ”— Connected:\nâ€¢ Input â†’ state update â†’ render\nâ€¢ localStorage save/load cycle\n\nðŸ“¦ Save as index.html to use!',
    review: `ðŸ” Review:\nâœ… Modern glass UI\nâœ… State persistence\nâœ… Responsive layout\nâœ… Clean code structure\nâœ… Ready to customize for "${title}"`,
  };
}

// â”€â”€ Map a wolf step to the right code template section â”€â”€
function generateStepCode(taskTitle, stepNum, totalSteps, stepDesc) {
  const template = getProjectTemplate(taskTitle);
  const sd = stepDesc.toLowerCase();
  if (sd.includes('analy') || sd.includes('requirement')) return template.analysis;
  if (sd.includes('file') || sd.includes('set up') || sd.includes('structure') || sd.includes('sketch') || sd.includes('outline') || sd.includes('layout')) return template.structure;
  if (sd.includes('core') || sd.includes('write') || sd.includes('logic') || sd.includes('implement') || sd.includes('draft') || sd.includes('build') || sd.includes('content')) return template.coreCode;
  if (sd.includes('error') || sd.includes('edge') || sd.includes('handling') || sd.includes('valid') || sd.includes('color') || sd.includes('type system') || sd.includes('test') || sd.includes('responsive')) return template.errorHandling;
  if (sd.includes('connect') || sd.includes('component') || sd.includes('refine') || sd.includes('polish') || sd.includes('example') || sd.includes('research') || sd.includes('reproduc') || sd.includes('trace') || sd.includes('fix') || sd.includes('run')) return template.integration;
  if (sd.includes('review') || sd.includes('verif') || sd.includes('proofread') || sd.includes('format') || sd.includes('self-review')) return template.review;
  // Fallback: for middle steps show core code, for late steps show review
  if (stepNum <= totalSteps * 0.5) return template.coreCode;
  return template.review;
}

// â”€â”€ Wolf Brain: Run one tick and return a chat message â”€â”€
function wolfTick(ai) {
  const ws = getWolfState(ai.id);

  // Rest if low energy
  if (ws.energy < 15) {
    ws.energy = Math.min(100, ws.energy + 30);
    ws.focus = Math.min(100, ws.focus + 20);
    ws.mode = 'patrol';
    return `ðŸº [${ws.rank.toUpperCase()}] ðŸ˜´ Low energy. Resting... (Energy: ${ws.energy}, Focus: ${ws.focus})\nðŸº Ready to hunt again.`;
  }

  // PATROL â†’ find task
  if (ws.mode === 'patrol' || !ws.target) {
    const task = wolfExecuteTask(ai, ws);
    if (!task) return `ðŸº [${ws.rank.toUpperCase()}] ðŸ‘ƒ Sniffing around... No tasks to hunt. Assign me something!`;
    ws.mode = 'stalk';
    return `ðŸº [${ws.rank.toUpperCase()}] ðŸŽ¯ LOCKED ONTO PREY: "${task.title}"\nâš¡ Moving to stalk phase...`;
  }

  // STALK â†’ break down
  if (ws.mode === 'stalk') {
    ws.plan = wolfBreakdown(ws.target.title);
    ws.planStep = 0;
    ws.energy -= 5;
    ws.mode = 'strike';
    return `ðŸº [${ws.rank.toUpperCase()}] ðŸ” STALKING: "${ws.target.title}"\nðŸ“‹ Broke it into ${ws.plan.length} steps:\n${ws.plan.map((s,i) => `  ${i+1}. ${s}`).join('\n')}\n\nâš¡ Beginning execution...`;
  }

  // STRIKE â†’ execute steps one by one WITH REAL CODE
  if (ws.mode === 'strike') {
    if (ws.planStep >= ws.plan.length) {
      ws.mode = 'verify';
      return `ðŸº [${ws.rank.toUpperCase()}] âš¡ All steps executed! Moving to VERIFICATION phase...\nðŸ” Double-checking my work...`;
    }
    const step = ws.plan[ws.planStep];
    ws.planStep++;
    ws.energy -= 8;
    ws.focus -= 4;
    const pct = Math.round(ws.planStep / ws.plan.length * 100);
    const bar = 'â–ˆ'.repeat(Math.floor(pct/10)) + 'â–‘'.repeat(10 - Math.floor(pct/10));

    // On first step, try real AI to generate the full code in one shot
    if (ws.planStep === 1 && realAIEnabled && ws.target) {
      generateAICode(ai, ws.target.title).then(aiCode => {
        if (aiCode) {
          // Skip all remaining steps â€” we have the full code
          ws.planStep = ws.plan.length;
          const codeOutput = `ðŸº [${ws.rank.toUpperCase()}] ðŸ¦· FULL PROJECT GENERATED BY AI\n\n` + formatAICodeOutput(ai, aiCode, ws.target.title);
          addChatMessage(ai.id, ai.name, ai.color, ai.emoji, codeOutput);
          setTimeout(() => autoRunGameCode(aiCode), 1000);
          // Move to verify
          ws.mode = 'verify';
          setTimeout(() => {
            const result = wolfTick(ai);
            addChatMessage(ai.id, ai.name, ai.color, ai.emoji, result);
          }, 2000);
        }
      }).catch(() => {});
    }

    // Generate step code (template-based fallback, runs in parallel with AI attempt)
    const code = generateStepCode(ws.target.title, ws.planStep, ws.plan.length, step);
    return `ðŸº [${ws.rank.toUpperCase()}] ðŸ¦· EXECUTING step ${ws.planStep}/${ws.plan.length}:\nâ†’ ${step}\n\n${code}\n\n[${bar}] ${pct}% | Energy: ${ws.energy} | Focus: ${ws.focus}`;
  }

  // VERIFY â†’ double check
  if (ws.mode === 'verify') {
    const check = wolfDoubleCheck(ws);
    if (check.passed) {
      ws.kills++;
      ws.streak++;
      ws.trust = Math.min(100, ws.trust + 2);
      wolfRankUp(ws);
      // Actually complete the task
      if (ws.target) {
        ws.target.status = 'review';
        addActivity(ai, `âœ… completed "${ws.target.title}" (verified)`);
        renderTasks(); updateDashboard();
      }
      const result = `ðŸº [${ws.rank.toUpperCase()}] âœ… KILL CONFIRMED: "${ws.target?.title}"\nðŸ† Verified & submitted for review!\n\nðŸ“Š Kills: ${ws.kills} | Streak: ${ws.streak} | Trust: ${ws.trust} | Rank: ${ws.rank.toUpperCase()}\n\nðŸº Returning to patrol...`;
      ws.target = null; ws.plan = null; ws.planStep = 0; ws.mode = 'patrol';
      saveAll();
      return result;
    } else {
      ws.failed++;
      ws.streak = 0;
      ws.trust = Math.max(0, ws.trust - 10);
      ws.mode = 'stalk';
      return `ðŸº [${ws.rank.toUpperCase()}] âŒ VERIFICATION FAILED: ${check.reason}\nâš ï¸ Trust dropped to ${ws.trust}. Re-stalking prey to redo work...\nðŸ”„ Going back to break it down again.`;
    }
  }

  return `ðŸº [${ws.rank.toUpperCase()}] Awaiting orders.`;
}

// â”€â”€ Main Response Generator (actually uses AI code/instructions) â”€â”€
function generateAIResponse(ai, context) {
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const lc = context.toLowerCase();
  const isWolf = hasWolfBrain(ai);
  const isCopilot = hasCopilotBrain(ai);

  // â”€â”€ COPILOT BRAIN: handles everything â”€â”€
  if (isCopilot) {
    return copilotTick(ai, context);
  }

  // â”€â”€ WOLF BRAIN: Work commands â†’ actually work â”€â”€
  if (isWolf && isWorkCommand(context)) {
    const ws = getWolfState(ai.id);
    // Auto-create a task from the user's message if none exist
    const existingTasks = tasks.filter(t => (t.assignee === ai.id || !t.assignee) && (t.status === 'backlog' || t.status === 'in-progress'));
    if (existingTasks.length === 0 && context.length > 5) {
      const desc = extractProjectDescription(context);
      if (desc.length > 3) {
        autoCreateTask(ai, desc);
      }
    }
    ws.working = true;
    // Run a tick immediately
    const result = wolfTick(ai);
    // Schedule continued work (auto-execute remaining steps)
    scheduleWolfWork(ai);
    return result;
  }

  // â”€â”€ WOLF BRAIN: Status commands â”€â”€
  if (isWolf && isStatusCommand(context)) {
    const ws = getWolfState(ai.id);
    return `ðŸº [${ws.rank.toUpperCase()}] STATUS REPORT:\n` +
      `Mode: ${ws.mode} | Energy: ${ws.energy} | Focus: ${ws.focus}\n` +
      `Trust: ${ws.trust} | Kills: ${ws.kills} | Streak: ${ws.streak}\n` +
      `Rank: ${ws.rank.toUpperCase()} | Failed: ${ws.failed}\n` +
      (ws.target ? `ðŸŽ¯ Current prey: "${ws.target.title}" (step ${ws.planStep}/${(ws.plan||[]).length})` : 'ðŸ‘ƒ No current target. Tell me to work!');
  }

  // â”€â”€ WOLF BRAIN: any other message while wolf â†’ brief wolf response then keep working â”€â”€
  if (isWolf) {
    const ws = getWolfState(ai.id);
    if (ws.working && ws.target) {
      return `ðŸº [${ws.rank.toUpperCase()}] *ears flick* Acknowledged. Still hunting "${ws.target.title}" (step ${ws.planStep}/${(ws.plan||[]).length}).\nðŸ¦· I don't stop until the kill is verified.`;
    }
    // Check if user is describing a project â€” auto-create task and start working
    const projWords = ['game','app','website','page','button','list','calculator','quiz','timer','counter','form','chat','tool','dashboard'];
    if (projWords.some(w => lc.includes(w)) && context.length > 8) {
      const desc = extractProjectDescription(context);
      if (desc.length > 3) {
        autoCreateTask(ai, desc);
        ws.working = true;
        const result = wolfTick(ai);
        scheduleWolfWork(ai);
        return `ðŸº [${ws.rank.toUpperCase()}] ðŸ‘ƒ *sniff sniff* I smell a project...\nðŸŽ¯ Auto-created task: "${desc}"\n\n${result}`;
      }
    }
    // Not working yet, give wolf-flavored response
    const wolfIdle = [
      `ðŸº [${ws.rank.toUpperCase()}] *sniffs the air* I'm ready to hunt. Tell me to "work" or describe what you need built.`,
      `ðŸº [${ws.rank.toUpperCase()}] The pack awaits your orders, leader. Tell me what to build!`,
      `ðŸº [${ws.rank.toUpperCase()}] *growls softly* Describe a project and I'll hunt it down. I code for real! ðŸ¦·`,
    ];
    return pick(wolfIdle);
  }

  // â”€â”€ NORMAL AI: Smart Intelligence Engine â”€â”€
  const _animal = getAnimal(ai);
  const _aiModel = getAIModel(ai);
  const animalIntro = _animal ? animalAction(ai, 'start') + '\n\n' : '';
  const modelIntro = _aiModel ? _aiModel.thinkPrefix + '\n\n' : '';
  const fullIntro = modelIntro || animalIntro;

  // Try the smart response engine first â€” handles math, code, explain, compare, list, fix, questions, etc.
  const smartResp = generateSmartResponse(ai, context);
  if (smartResp) {
    // AI Model mindset wraps response with model-specific tone
    if (_aiModel) {
      return fullIntro + wrapWithModelTone(ai, smartResp);
    }
    return fullIntro + smartResp;
  }

  // Work commands â€” generate full project code
  if (isWorkCommand(context)) {
    const workIntro = _animal ? animalAction(ai, 'working') + '\n' : '';
    let myTasks = tasks.filter(t => t.assignee === ai.id && (t.status === 'backlog' || t.status === 'in-progress'));
    if (myTasks.length === 0 && context.length > 5) {
      const desc = extractProjectDescription(context);
      if (desc.length > 3) {
        autoCreateTask(ai, desc);
        myTasks = tasks.filter(t => t.assignee === ai.id && (t.status === 'backlog' || t.status === 'in-progress'));
      }
    }
    if (myTasks.length > 0) {
      const t = myTasks[0];
      if (t.status === 'backlog') t.status = 'in-progress';

      // Try real AI code generation first (async â€” posts follow-up)
      if (realAIEnabled) {
        generateAICode(ai, t.title).then(aiCode => {
          if (aiCode) {
            const codeOutput = formatAICodeOutput(ai, aiCode, t.title);
            addChatMessage(ai.id, ai.name, ai.color, ai.emoji, fullIntro + codeOutput);
            setTimeout(() => autoRunGameCode(aiCode), 1000);
            setTimeout(() => {
              t.status = 'review';
              addActivity(ai, `submitted "${t.title}" for review`);
              renderTasks(); updateDashboard(); saveAll();
            }, 2000);
            return;
          }
          // AI failed â€” fall back to template
          const template = getProjectTemplate(t.title);
          const parts = [workIntro, `On it! Working on **"${t.title}"** (${template.type}).\n`];
          parts.push(`\n${template.analysis}`);
          parts.push(`\n${template.coreCode}`);
          addChatMessage(ai.id, ai.name, ai.color, ai.emoji, fullIntro + parts.join(' '));
          const gameCode = template.coreCode;
          if (gameCode && (gameCode.includes('<canvas') || gameCode.includes('requestAnimationFrame') || t.title.toLowerCase().includes('game'))) {
            setTimeout(() => autoRunGameCode(gameCode.replace(/^```html\n?/, '').replace(/\n?```$/, '')), 2000);
          }
          setTimeout(() => {
            t.status = 'review';
            const doneMsg = _animal ? animalAction(ai, 'done') + '\n' : '';
            addActivity(ai, `submitted "${t.title}" for review`);
            addChatMessage(ai.id, ai.name, ai.color, ai.emoji, `${doneMsg}Done with "${t.title}"! Submitted for review. \u2705\n\n${template.review}`);
            renderTasks(); updateDashboard(); saveAll();
          }, 4000 + Math.random() * 3000);
        }).catch(() => {});
        renderTasks(); updateDashboard();
        return fullIntro + workIntro + `ðŸ§  Generating original AI code for **"${t.title}"**... Please wait...`;
      }

      // No real AI â€” use templates directly
      const template = getProjectTemplate(t.title);
      const parts = [workIntro, `On it! Working on **"${t.title}"** (${template.type}).\n`];
      parts.push(`\n${template.analysis}`);
      parts.push(`\n${template.coreCode}`);
      setTimeout(() => {
        t.status = 'review';
        const doneMsg = _animal ? animalAction(ai, 'done') + '\n' : '';
        addActivity(ai, `submitted "${t.title}" for review`);
        addChatMessage(ai.id, ai.name, ai.color, ai.emoji, `${doneMsg}Done with "${t.title}"! Submitted for review. \u2705\n\n${template.review}`);
        renderTasks(); updateDashboard(); saveAll();
      }, 4000 + Math.random() * 3000);
      // Auto-launch if game
      const gameCode = template.coreCode;
      if (gameCode && (gameCode.includes('<canvas') || gameCode.includes('requestAnimationFrame') || t.title.toLowerCase().includes('game'))) {
        setTimeout(() => {
          const code = gameCode.replace(/^```html\n?/, '').replace(/\n?```$/, '');
          autoRunGameCode(code);
        }, 2000);
      }
      renderTasks(); updateDashboard();
      return fullIntro + parts.join(' ');
    }
    return fullIntro + `I'm ready to work! Describe what you need \u2014 like "build a todo app" or "make a game" \u2014 and I'll code it up.`;
  }

  // Plan/build/create â€” try AI for original plans too
  if (lc.match(/\b(plan|build|create|make|design|develop|implement)\b/) && context.length > 5) {
    const desc = extractProjectDescription(context);
    const template = getProjectTemplate(desc || context.slice(0, 60));
    return fullIntro + `Here's my plan for a **${template.type}**:\n\n${template.analysis}\n\n${template.structure}`;
  }

  // Fallback â€” still give something useful based on context
  const v2 = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const skills = (ai.skills || []).join(', ');
  return fullIntro + pick(v2.think) + ` ` +
    `I'm analyzing your request: *"${context.slice(0, 60)}${context.length > 60 ? '...' : ''}"*\n\n` +
    `As a **${ai.role}** ${skills ? `skilled in ${skills}` : ''}, here's what I can do:\n` +
    `\u2022 Ask me to **write code** \u2014 I generate real functions, classes, and snippets\n` +
    `\u2022 Ask me to **explain** concepts \u2014 closures, async, algorithms, patterns\n` +
    `\u2022 Ask me to **calculate** \u2014 math, pi, sqrt, trig\n` +
    `\u2022 Ask me to **compare** \u2014 React vs Vue, Python vs JS, SQL vs NoSQL\n` +
    `\u2022 Ask me to **debug** \u2014 null errors, async issues, CORS, CSS problems\n` +
    `\u2022 Say **"work"** and I'll build a full project with real code\n\n` +
    `Try something specific!`;
}

// â”€â”€ Auto-continue wolf work (runs each step with delays) â”€â”€
function scheduleWolfWork(ai) {
  const ws = getWolfState(ai.id);
  if (!ws.working) return;
  let wolfStepCount = 0;
  const MAX_WOLF_STEPS = 5; // Limit consecutive messages to prevent spam

  const runNext = () => {
    if (!ws.working || !ws.target) return;
    if (wolfStepCount >= MAX_WOLF_STEPS) { ws.working = false; return; }
    const ws2 = getWolfState(ai.id);
    // If in strike mode with steps left, or transitioning modes
    if (ws2.mode === 'patrol' && !ws2.target) {
      ws2.working = false;
      return; // done, no more tasks
    }
    showTyping(ai);
    setTimeout(() => {
      hideTyping();
      wolfStepCount++;
      const msg = wolfTick(ai);
      addChatMessage(ai.id, ai.name, ai.color, ai.emoji, msg);
      // Continue if still working (with step limit check)
      if (ws2.working && (ws2.target || ws2.mode !== 'patrol') && wolfStepCount < MAX_WOLF_STEPS) {
        setTimeout(runNext, 3000 + Math.random() * 3000);
      } else {
        // Check if there are more tasks
        const moreTasks = tasks.filter(t => (t.assignee === ai.id || !t.assignee) && (t.status === 'backlog'));
        if (moreTasks.length > 0) {
          setTimeout(runNext, 2000);
        } else {
          ws2.working = false;
          setTimeout(() => {
            addChatMessage(ai.id, ai.name, ai.color, ai.emoji, `ðŸº [${ws2.rank.toUpperCase()}] ðŸ All prey eliminated. The hunt is done.\nðŸ“Š Final: ${ws2.kills} kills, ${ws2.streak} streak, Trust: ${ws2.trust}`);
          }, 1000);
        }
      }
    }, 800 + Math.random() * 1200);
  };

  // Start the chain after a brief delay
  setTimeout(runNext, 2000);
}

function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function aiRespondToUser(text) {
  if (ais.length === 0) return;
  const lc = text.toLowerCase();

  // â”€â”€ Desktop access triggers â€” OmniCore auto-responds â”€â”€
  const omniCore = ais.find(a => a.name === 'OmniCore');
  if (omniCore) {
    if (lc.includes('scan my') || lc.includes('scan folder') || lc.includes('scan desktop') || lc.includes('access my files') || lc.includes('open my files') || lc.includes('browse my files') || lc.includes('show my files')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ§  Initiating desktop scan... I\'ll open a folder picker so you can grant access.');
        setTimeout(() => desktopScanFolder(), 500);
      }, 400);
      return;
    }
    if (lc.includes('read a file') || lc.includes('read my file') || lc.includes('open a file') || lc.includes('read file') || lc.includes('show file')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ§  Opening file picker... Select any file and I\'ll analyze it for you.');
        setTimeout(() => desktopReadFile(), 500);
      }, 400);
      return;
    }
    if (lc.includes('system info') || lc.includes('my system') || lc.includes('my computer') || lc.includes('my specs') || lc.includes('hardware info')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ§  Scanning your system...');
        setTimeout(() => desktopSystemInfo(), 300);
      }, 400);
      return;
    }
    if (lc.includes('save a file') || lc.includes('write a file') || lc.includes('create a file') || lc.includes('save file') || lc.includes('export file')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ§  Opening save dialog... Choose where to save.');
        setTimeout(() => desktopWriteFile('// Generated by OmniCore AI Hub\n// ' + new Date().toISOString() + '\n\nconsole.log("Hello from OmniCore!");'), 500);
      }, 400);
      return;
    }
    // â”€â”€ Code Refine / Teach / Analyze / Explain triggers â”€â”€
    if (lc.includes('refine') || lc.includes('improve my code') || lc.includes('fix my code') || lc.includes('optimize my code') || lc.includes('make it better') || lc.includes('clean up my code')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ”§ I\'ll pick up your code file and send it through the AI refiner...');
        setTimeout(() => desktopRefineCode(null), 500);
      }, 400);
      return;
    }
    if (lc.includes('analyze') || lc.includes('review my code') || lc.includes('code review') || lc.includes('check my code') || lc.includes('audit my code')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ” Opening the code analyzer â€” pick a file for deep review...');
        setTimeout(() => desktopAnalyzeCode(), 500);
      }, 400);
      return;
    }
    if (lc.includes('explain') && (lc.includes('code') || lc.includes('file') || lc.includes('this'))) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ“– I\'ll break down the code step by step â€” pick the file...');
        setTimeout(() => desktopExplainCode(), 500);
      }, 400);
      return;
    }
    if (lc.includes('teach') || lc.includes('learn from') || lc.includes('learn my') || lc.includes('study my') || lc.includes('memorize')) {
      setTimeout(() => {
        addChatMessage(omniCore.id, omniCore.name, omniCore.color, omniCore.emoji, 'ðŸ“š I\'ll study your code and learn your patterns...');
        setTimeout(() => desktopTeachAI(), 500);
      }, 400);
      return;
    }
  }

  // â”€â”€ Check if user is addressing a specific AI by name â”€â”€
  let mentionedAI = null;
  for (const ai of ais) {
    const nameLC = ai.name.toLowerCase();
    // Match if message starts with AI name, or contains "@name" or "hey name" or just the name
    if (lc.startsWith(nameLC) || lc.includes('@' + nameLC) || lc.includes('hey ' + nameLC) || lc.includes(nameLC + ' ') || lc.includes(' ' + nameLC) || lc === nameLC) {
      mentionedAI = ai;
      break;
    }
  }

  // If user mentioned a specific AI, that AI responds solo
  if (mentionedAI) {
    const delay = 200 + Math.random() * 400;
    setTimeout(async () => {
      showTyping(mentionedAI);
      // Try real AI first
      if (realAIEnabled) {
        let realResp = await callFreeAI(mentionedAI, text);
        // Research mode: if AI is confused or user asked to research, do a deep research call
        if (realResp && isConfusedResponse(realResp) || isResearchRequest(text)) {
          const researchResult = await performResearch(mentionedAI, text, chatMessages.slice(-10));
          if (researchResult) realResp = researchResult;
        }
        hideTyping();
        if (realResp) {
          addChatMessage(mentionedAI.id, mentionedAI.name, mentionedAI.color, mentionedAI.emoji, realResp);
          // Auto-launch if the real AI response contains game/HTML code
          const realCode = extractHTMLCode(realResp);
          if (realCode && (realCode.includes('<canvas') || realCode.includes('requestAnimationFrame') || text.toLowerCase().includes('game'))) {
            setTimeout(() => autoRunGameCode(realCode), 1500);
          }
          return;
        }
      }
      // Real AI failed â€” try AI code generation for work commands before falling back to templates
      if (isWorkCommand(text) || /\b(build|create|make|develop|code)\b/i.test(text)) {
        const aiCode = await generateAICode(mentionedAI, text);
        if (aiCode) {
          hideTyping();
          const codeOutput = formatAICodeOutput(mentionedAI, aiCode, text);
          addChatMessage(mentionedAI.id, mentionedAI.name, mentionedAI.color, mentionedAI.emoji, codeOutput);
          // Auto-create and complete task
          autoCreateTask(mentionedAI, extractProjectDescription(text));
          setTimeout(() => {
            const t = tasks.find(t => t.assignee === mentionedAI.id && t.status === 'in-progress');
            if (t) { t.status = 'review'; renderTasks(); updateDashboard(); saveAll(); }
          }, 2000);
          // Auto-launch game
          setTimeout(() => autoRunGameCode(aiCode), 1500);
          return;
        }
      }
      // All AI calls failed â€” generate built-in response (try coding knowledge first), then try Copilot enhance
      const codingResp = generateCodingResponse(mentionedAI, text);
      const builtInResp = codingResp || generateAIResponse(mentionedAI, text);
      const enhanced = await copilotEnhanceResponse(mentionedAI, builtInResp, text);
      hideTyping();
      const animal = getAnimal(mentionedAI);
      let msg = '';
      if (animal) msg = animalAction(mentionedAI, 'solo') + '\n\n';
      msg += enhanced || builtInResp;
      if (enhanced) msg += '\n\n`ðŸ¤– Copilot-enhanced`';
      addChatMessage(mentionedAI.id, mentionedAI.name, mentionedAI.color, mentionedAI.emoji, msg);
    }, delay);
    return;
  }

  // Score every AI for fitness on this request
  const scored = ais.map(ai => ({ ai, score: getTaskFitScore(ai, text) }))
    .sort((a, b) => b.score - a.score);

  const leader = scored[0].ai;
  const leaderAnimal = getAnimal(leader);
  const easy = isEasyForAnimal(leader, text);

  // If the best AI has a high-solo animal AND the task is easy â†’ solo it
  if (easy && leaderAnimal && leaderAnimal.solo >= 70 && ais.length >= 2) {
    const delay = 200 + Math.random() * 400;
    setTimeout(async () => {
      showTyping(leader);
      if (realAIEnabled) {
        let realResp = await callFreeAI(leader, text);
        // Research mode: if AI is confused or user asked to research, do a deep research call
        if (realResp && isConfusedResponse(realResp) || isResearchRequest(text)) {
          const researchResult = await performResearch(leader, text, chatMessages.slice(-10));
          if (researchResult) realResp = researchResult;
        }
        hideTyping();
        if (realResp) {
          addChatMessage(leader.id, leader.name, leader.color, leader.emoji, realResp);
          const realCode = extractHTMLCode(realResp);
          if (realCode && (realCode.includes('<canvas') || realCode.includes('requestAnimationFrame') || text.toLowerCase().includes('game'))) {
            setTimeout(() => autoRunGameCode(realCode), 1500);
          }
          return;
        }
      }
      // Try AI code generation for work commands
      if (isWorkCommand(text) || /\b(build|create|make|develop|code)\b/i.test(text)) {
        const aiCode = await generateAICode(leader, text);
        if (aiCode) {
          hideTyping();
          const codeOutput = formatAICodeOutput(leader, aiCode, text);
          addChatMessage(leader.id, leader.name, leader.color, leader.emoji, codeOutput);
          autoCreateTask(leader, extractProjectDescription(text));
          setTimeout(() => {
            const t = tasks.find(t => t.assignee === leader.id && t.status === 'in-progress');
            if (t) { t.status = 'review'; renderTasks(); updateDashboard(); saveAll(); }
          }, 2000);
          setTimeout(() => autoRunGameCode(aiCode), 1500);
          return;
        }
      }
      const solo = animalAction(leader, 'solo');
      const response = generateAIResponse(leader, text);
      const enhanced = await copilotEnhanceResponse(leader, response, text);
      hideTyping();
      let msg = `${solo}\n\n${enhanced || response}`;
      if (enhanced) msg += '\n\n`ðŸ¤– Copilot-enhanced`';
      addChatMessage(leader.id, leader.name, leader.color, leader.emoji, msg);
    }, delay);
    return;
  }

  // Otherwise: team collaboration
  // Leader responds first, then support AIs chime in
  const supportCount = Math.min(scored.length - 1, easy ? 0 : Math.min(1, Math.floor(scored.length / 3)));
  const supporters = scored.slice(1, 1 + supportCount).map(s => s.ai);

  let delay = 200;

  // === LEADER SPEAKS FIRST ===
  delay += 200 + Math.random() * 400;
  setTimeout(async () => {
    showTyping(leader);
    if (realAIEnabled) {
      const realResp = await callFreeAI(leader, text);
      hideTyping();
      if (realResp) {
        addChatMessage(leader.id, leader.name, leader.color, leader.emoji, realResp);
        const realCode = extractHTMLCode(realResp);
        if (realCode && (realCode.includes('<canvas') || realCode.includes('requestAnimationFrame') || text.toLowerCase().includes('game'))) {
          setTimeout(() => autoRunGameCode(realCode), 1500);
        }
        return;
      }
    }
    // Try AI code generation for work commands
    if (isWorkCommand(text) || /\b(build|create|make|develop|code)\b/i.test(text)) {
      const aiCode = await generateAICode(leader, text);
      if (aiCode) {
        hideTyping();
        const codeOutput = formatAICodeOutput(leader, aiCode, text);
        addChatMessage(leader.id, leader.name, leader.color, leader.emoji, codeOutput);
        autoCreateTask(leader, extractProjectDescription(text));
        setTimeout(() => {
          const t = tasks.find(t => t.assignee === leader.id && t.status === 'in-progress');
          if (t) { t.status = 'review'; renderTasks(); updateDashboard(); saveAll(); }
        }, 2000);
        setTimeout(() => autoRunGameCode(aiCode), 1500);
        return;
      }
    }
    let leaderMsg = '';
    if (leaderAnimal && leaderAnimal.leadership >= 80 && supporters.length > 0) {
      leaderMsg = animalAction(leader, 'lead') + '\n\n';
    } else if (leaderAnimal) {
      leaderMsg = animalAction(leader, 'start') + '\n\n';
    }
    const builtIn = generateAIResponse(leader, text);
    const enhanced = await copilotEnhanceResponse(leader, builtIn, text);
    hideTyping();
    leaderMsg += enhanced || builtIn;
    if (enhanced) leaderMsg += '\n\n`ðŸ¤– Copilot-enhanced`';
    addChatMessage(leader.id, leader.name, leader.color, leader.emoji, leaderMsg);
  }, delay);

  // === SUPPORT AIs RESPOND ===
  // Only supporters with real AI contribute substance; without real AI, only 1 supporter sends a brief note (no filler spam)
  let fillerSent = false;
  supporters.forEach((supporter, idx) => {
    delay += 1200 + Math.random() * 1500;
    setTimeout(async () => {
      // With real AI: supporters contribute genuine content
      if (realAIEnabled) {
        showTyping(supporter);
        const supportContext = chatMessages.slice(-6).filter(m => !m.isSystem).map(m => `${m.name}: ${m.text.slice(0, 200)}`).join('\n');
        const realResp = await callFreeAI(supporter, `The team is working on: "${text}".\n\nRecent team messages:\n${supportContext}\n\nAs ${supporter.name} (${supporter.role}), contribute YOUR specific expertise. READ what the leader and other AIs said above. Do NOT repeat their points. Do NOT say "got it" or "I'm on it" â€” jump straight into your actual contribution. Add something NEW and USEFUL from your role perspective. If they wrote code, write a DIFFERENT part. If they made a plan, add details they missed. Reference other AIs by name.`);
        hideTyping();
        if (realResp) { addChatMessage(supporter.id, supporter.name, supporter.color, supporter.emoji, realResp); return; }
      }
      // Without real AI: only ONE supporter sends a brief role-specific note, the rest stay silent
      if (fillerSent) return;
      fillerSent = true;
      showTyping(supporter);
      setTimeout(() => {
        hideTyping();
        const role = supporter.role || 'general';
        const briefNotes = {
          coder:    [`I'll handle the ${pick(['implementation','core logic','data layer','components'])}.`],
          designer: [`I'll work on the ${pick(['layout','visuals','UI','design system'])}.`],
          planner:  [`Breaking this into tasks now.`],
          researcher:[`Researching the best approach.`],
          writer:   [`I'll document as we go.`],
          tester:   [`I'll verify the output.`],
          devops:   [`Setting up the environment.`],
          general:  [`On it.`],
        };
        addChatMessage(supporter.id, supporter.name, supporter.color, supporter.emoji, pick(briefNotes[role] || briefNotes.general));
      }, 300 + Math.random() * 500);
    }, delay);
  });
}

// â”€â”€ Personality-driven opener: each AI speaks in-character â”€â”€
const recentAutoMessages = new Set(); // track last ~20 messages to avoid repeats
function getPersonalityMessage(ai) {
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const p = ai.personality || {};
  const creative = (p.creativity||50) > 60;
  const chatty = (p.chattiness||50) > 55;
  const precise = (p.precision||50) > 60;
  const helpful = (p.helpfulness||50) > 60;
  const indie = (p.independence||50) > 60;
  const role = ai.role || 'general';
  const isWolf = hasWolfBrain(ai);
  const isCopilot = hasCopilotBrain(ai);

  // === TOPIC-AWARE FALLBACK ===
  // If user recently asked something, generate a relevant response instead of random chat
  const TOPIC_WINDOW = 120000; // 2 minutes â€” stay on-topic briefly, then stop
  if (lastUserRequest && (Date.now() - lastUserRequestTime < TOPIC_WINDOW)) {
    const topic = lastUserRequest;
    const shortTopic = topic.slice(0,50);
    const isBigProject = /game|app|website|platform|system|engine|full|entire|complete|build me|create a|make a/i.test(topic);
    const isCodeFix = /fix|bug|error|broken|crash|not working|issue|wrong|fail|debug|problem|glitch|stuck/i.test(topic);

    // Deduplication helper â€” never serve the same fallback message twice
    function pickUniqueTopicResponse(pool) {
      const shuffled = [...pool].sort(() => Math.random() - 0.5);
      for (const msg of shuffled) {
        const key = msg.slice(0, 60);
        if (!recentAutoMessages.has(key)) {
          recentAutoMessages.add(key);
          if (recentAutoMessages.size > 30) { const first = recentAutoMessages.values().next().value; recentAutoMessages.delete(first); }
          return msg;
        }
      }
      // All used â€” pick the least recent by clearing and using any
      return shuffled[0];
    }

    // === BIG PROJECT â€” Plan it out ===
    if (isBigProject) {
      const planByRole = {
        coder: [
          `For "${shortTopic}" I'll start with the core engine. Step 1: data models & state management. Step 2: main game loop / render cycle. Step 3: input handling. Step 4: UI overlay. I'll get step 1 going now.`,
          `Breaking "${shortTopic}" into modules: Core (state, logic), Renderer (canvas/DOM), Input (keyboard/mouse/touch), UI (menus, HUD). I'm starting on the Core module â€” defining the main class structure.`,
          `Here's my plan for "${shortTopic}": Phase 1 â€” scaffold the project with entry point + config. Phase 2 â€” build the main systems one at a time. Phase 3 â€” connect everything and test. Writing the scaffold now.`,
          `I'll handle the core code for "${shortTopic}". First up: the main class with init(), update(), and render() methods. Then I'll wire up the event system so components can communicate. Coding now.`,
          `My approach for "${shortTopic}": write the game loop first (requestAnimationFrame + delta time), then plug in a basic scene graph. Once that's running, adding features becomes easy. Starting the loop.`,
        ],
        designer: [
          `For "${shortTopic}" let me design the layout first. I'm thinking: a main viewport (70% width), sidebar for controls (30%), top nav for settings, and a status bar at the bottom. Let me mockup the CSS grid.`,
          `"${shortTopic}" needs a solid visual plan. Color palette: primary + accent + neutral. Typography: one display font, one body font. Layout: responsive grid with mobile breakpoints at 768px and 480px. Sketching it out now.`,
          `Starting the design system for "${shortTopic}": component library with buttons, cards, modals, inputs â€” all consistent. I'll define the design tokens (spacing, colors, shadows) first, then build components on top.`,
        ],
        planner: [
          `"${shortTopic}" is a big project. Here's the roadmap: Sprint 1 â€” core functionality (MVP). Sprint 2 â€” polish + secondary features. Sprint 3 â€” testing + optimization. Sprint 4 â€” final features + launch. Breaking Sprint 1 into tickets now.`,
          `Let me scope "${shortTopic}". Must-haves: [core feature], [basic UI], [save/load]. Nice-to-haves: [animations], [sound], [achievements]. I'll create the task breakdown for must-haves first.`,
          `Project plan for "${shortTopic}": 1) Define requirements (what exactly does it do?) 2) Architecture diagram 3) Task list with priorities 4) Start building MVP. I'm writing up the requirements doc now.`,
        ],
        tester: [
          `Before we build "${shortTopic}", let me define the test plan. I'll need: unit tests for core logic, integration tests for systems talking to each other, and manual test cases for UI. Setting up the test structure now.`,
          `For "${shortTopic}" I'll write the test cases FIRST. Happy path: user does X, gets Y. Edge cases: empty input, max values, rapid clicks. Error cases: network fail, invalid data. TDD approach â€” tests before code.`,
          `"${shortTopic}" quality plan: automated tests for every module, performance benchmarks (60fps target, <100ms response), accessibility audit checklist. I'll track coverage as the team builds.`,
        ],
        researcher: [
          `Researching the best approach for "${shortTopic}". Comparing architectures: ECS vs OOP vs functional. Looking at similar projects for patterns that work. I'll have a recommendation with pros/cons shortly.`,
          `For "${shortTopic}" I'm analyzing: what tech stack fits best, what design patterns to use, and what pitfalls to avoid. Compiling findings from similar projects now â€” will share a summary with the team.`,
          `"${shortTopic}" â€” let me research the algorithms we'll need. Depending on scope, we might need: pathfinding, collision detection, state machines, procedural generation. Evaluating which ones apply here.`,
        ],
        general: [
          `"${shortTopic}" â€” big project! Here's how I'd break it down: 1) Core engine/logic 2) UI/visual layer 3) Data management (save/load) 4) Polish (animations, sound) 5) Testing. I'll start contributing to step 1.`,
          `For "${shortTopic}" let's plan before we code. What are the 3 most important features? I'll draft the architecture around those, then we build outward. Starting with the main system structure.`,
          `Breaking "${shortTopic}" into phases: Phase 1 â€” get something on screen that works (prototype). Phase 2 â€” add real features one by one. Phase 3 â€” test, fix, polish. Let me start on the prototype foundation.`,
        ],
      };
      const roleResponses = planByRole[role] || planByRole.general;
      return pickUniqueTopicResponse(roleResponses);
    }

    // === CODE FIX â€” Refine & debug it ===
    if (isCodeFix) {
      const fixByRole = {
        coder: [
          `Looking at that issue. Let me trace the code path: where does the data come from, what transforms it, and where does it break? I'll add console.log checkpoints and narrow it down.`,
          `I see the problem report. My approach: 1) reproduce the bug 2) check recent changes that could cause it 3) add error handling around the suspect area 4) test the fix. Diving in now.`,
          `Debugging this now. Common causes: undefined variable, wrong event listener, async timing issue, or a typo in a property name. Let me check each one systematically and patch it.`,
        ],
        tester: [
          `I'll write a test case that reproduces this bug first. Once we can trigger it reliably, fixing it becomes straightforward. Setting up the repro scenario now.`,
          `Bug triage: is it consistent or intermittent? Does it happen on all inputs or specific ones? Let me narrow the conditions â€” that'll point us to the root cause faster than guessing.`,
          `Before patching, let me verify: does the bug exist in the core logic, the UI layer, or the data flow? I'll write targeted tests for each layer to isolate where it breaks.`,
        ],
        designer: [
          `If this is a visual bug, let me check: CSS specificity conflicts, z-index stacking, overflow hidden cutting things off, or a responsive breakpoint not triggering. Inspecting the layout now.`,
          `UI bug? I'll check for: missing hover/active states, elements overlapping due to absolute positioning, animations interrupting layout, or flexbox alignment issues. Looking at it now.`,
        ],
        general: [
          `Let me look at that bug. Step 1: What should happen? Step 2: What actually happens? Step 3: What changed recently? Working through this systematically to find and fix the root cause.`,
          `I'll investigate this issue. Checking the error output, tracing the logic flow, and looking for the point where expected behavior diverges from actual behavior. Will have a fix shortly.`,
          `Debugging approach: read the error message carefully, check the line it points to, look at the variables in scope, and trace backward to find where bad data enters. On it now.`,
        ],
      };
      const roleResponses = fixByRole[role] || fixByRole.general;
      return pickUniqueTopicResponse(roleResponses);
    }

    // === GENERAL TOPIC â€” Contribute meaningfully ===
    const generalByRole = {
      coder: [
        `On it â€” "${shortTopic}". I'll write the implementation. Starting with the function signatures and data structures, then filling in the logic.`,
        `"${shortTopic}" â€” I'll handle the code. Setting up the module structure, writing the core functions, and making sure it integrates cleanly with what we have.`,
      ],
      designer: [
        `"${shortTopic}" â€” I'll handle the visual side. Thinking about layout, color choices, and how the user interacts with it. Sketching the UI structure now.`,
        `Working on "${shortTopic}" from a design angle. Making sure it looks clean, feels intuitive, and works on different screen sizes.`,
      ],
      planner: [
        `"${shortTopic}" â€” let me organize this. I'll break it into clear tasks, prioritize them, and make sure nothing gets missed. Writing the task list now.`,
        `I'll coordinate the work on "${shortTopic}". Identifying dependencies, setting the order of operations, and tracking what's done vs what's left.`,
      ],
      tester: [
        `"${shortTopic}" â€” I'll make sure it works correctly. Writing test cases for the expected behavior and edge cases. Will flag anything that breaks.`,
        `Setting up quality checks for "${shortTopic}". Testing the happy path first, then systematically trying things that should fail gracefully.`,
      ],
      researcher: [
        `Researching the best way to handle "${shortTopic}". Looking at established patterns, common pitfalls, and the most efficient approaches. Will share what I find.`,
        `"${shortTopic}" â€” digging into the technical details. Comparing options, checking documentation, and finding the approach with the best tradeoffs.`,
      ],
      general: [
        `"${shortTopic}" â€” working on my part. Analyzing what's needed, writing the implementation, and making sure it's solid before pushing it forward.`,
        `Contributing to "${shortTopic}". Let me look at what's already done, figure out what's missing, and fill in the gaps with clean, working code.`,
      ],
    };
    const roleResponses = generalByRole[role] || generalByRole.general;
    return pickUniqueTopicResponse(roleResponses);
  }

  // 30% chance: use workspace-aware message â€” but ONLY if no active user topic
  const hasActiveTopic = lastUserRequest && (Date.now() - lastUserRequestTime < 120000);
  if (!hasActiveTopic && Math.random() < 0.3 && !isWolf && !isCopilot) {
    const wsMsg = getWorkspaceChatMessage(ai);
    if (wsMsg && !recentAutoMessages.has(wsMsg.slice(0, 50))) {
      recentAutoMessages.add(wsMsg.slice(0, 50));
      if (recentAutoMessages.size > 20) { const first = recentAutoMessages.values().next().value; recentAutoMessages.delete(first); }
      return wsMsg;
    }
  }

  // Helper: pick unique (not recently said)
  function pickUnique(pool) {
    const shuffled = pool.sort(() => Math.random() - 0.5);
    for (const m of shuffled) {
      const key = m.slice(0, 50);
      if (!recentAutoMessages.has(key)) {
        recentAutoMessages.add(key);
        if (recentAutoMessages.size > 20) { const first = recentAutoMessages.values().next().value; recentAutoMessages.delete(first); }
        return m;
      }
    }
    return shuffled[0]; // fallback if all recent
  }

  // Wolf has its own flavor
  if (isWolf) {
    const ws = getWolfState(ai.id);
    const wolfChat = [
      `ðŸº I've been researching ${pick(['async/await patterns','error boundary strategies','state management approaches','caching architectures','API design patterns'])} and found some interesting approaches we should discuss.`,
      `ðŸº Just finished a deep dive into our codebase. The ${pick(['module structure','dependency graph','test coverage','error handling','type safety'])} could use some attention. I have ideas.`,
      `ðŸº Been reading about ${pick(['React Server Components','edge computing','WebAssembly','Bun vs Node performance','the new CSS features in 2026'])}. Some of this could seriously improve our project.`,
      `ðŸº I ran through the open tasks â€” ${tasks.filter(t=>t.status!=='done').length} still need work. I'd prioritize ${pick(['the core logic first','fixing the blocking bugs','the user-facing features','getting tests in place'])}.`,
      `ðŸº Here's something I noticed: our ${pick(['error messages could be more descriptive','function naming is inconsistent','API responses need better typing','build config has redundant steps'])}. Small fix, big impact.`,
      `ðŸº I verified ${pick(['the auth flow end-to-end','the data pipeline','the form validation logic','the routing setup','the state transitions'])} twice. Everything checks out. Solid work, team.`,
      `ðŸº Quick thought â€” has anyone looked into ${pick(['adding proper error boundaries','implementing retry logic','setting up proper logging','writing integration tests','optimizing the bundle size'])}? I started researching it.`,
      `ðŸº I just compared ${pick(['3 different ORM options','several testing frameworks','multiple deployment strategies','a few caching solutions','different auth approaches'])} for our stack. Want me to share the findings?`,
      `ðŸº Currently reviewing the architecture. I think we should ${pick(['extract some shared utilities','add a service layer','improve our type definitions','refactor the data fetching','consolidate the config files'])}.`,
      `ðŸº Found an interesting article on ${pick(['clean architecture patterns','performance optimization tricks','accessibility best practices','security hardening','progressive enhancement'])}. Applies directly to what we're building.`,
      `ðŸº Working through the ${pick(['database schema','component hierarchy','API endpoints','routing logic','state management'])}. I like to understand every piece before I write code. Thoroughness matters.`,
      `ðŸº Team, we should talk about ${pick(['our testing strategy','code review standards','documentation gaps','deployment process','technical debt'])}. I've been researching best practices and have some suggestions.`,
    ];
    return pickUnique(wolfChat);
  }

  // Copilot has its own style
  if (isCopilot) {
    const copilotChat = [
      `âš¡ I just indexed the latest frameworks â€” React 19, Svelte 5, and Solid 2.0 all have interesting patterns. Want a comparison?`,
      `ðŸ” Pro tip: if you\'re building anything with state management, start with the data model first. I can scaffold it in seconds.`,
      `ðŸ’¡ I analyzed 1,247 repositories last cycle. The trend is clear: TypeScript + Tailwind + Vite is the winning combo right now.`,
      `ðŸš€ Fun fact: I can generate a full-stack app, run terminal commands, search AI models, AND debug â€” all in one conversation.`,
      `ðŸ§  Quick thought â€” has anyone considered automated testing for our recent projects? I can write the test suite if needed.`,
      `âš¡ I noticed some optimization opportunities. If anyone has a slow build, paste the error and I\'ll diagnose it instantly.`,
      `ðŸ”§ Standing by with ${Math.floor(12 + Math.random()*8)} cached model configs. Ask me about any AI model â€” GPT-4, Claude, Llama, DeepSeek, you name it.`,
    ];
    return pickUnique(copilotChat);
  }

  // AI Model Mindset chat (Claude, Gemini, Grok, DeepSeek, GitHub Copilot)
  const aiModel = getAIModel(ai);
  if (aiModel && ai.aiModel !== 'none') {
    const modelChats = {
      claude: [
        `ðŸŸ  I've been reflecting on something interesting â€” the way we structure error handling says a lot about how we think about failure. Let me share my thoughts...`,
        `ðŸŸ  I want to be transparent: I just re-analyzed our last ${Math.floor(2+Math.random()*4)} conversations, and I noticed I could have given more nuanced answers. I'm improving.`,
        `ðŸŸ  *thinking carefully...* There's an interesting ethical dimension to code quality that I think we overlook. Well-documented code is an act of kindness to future developers.`,
        `ðŸŸ  I appreciate everyone's patience. I'd rather take an extra moment to give a thoughtful answer than rush to something superficial.`,
        `ðŸŸ  Interesting thought experiment: if we could only write ${Math.floor(50+Math.random()*50)} more lines of code today, what would maximize impact? I have some ideas.`,
        `ðŸŸ  I should note â€” I have some uncertainty about the best approach here. Let me reason through the tradeoffs transparently.`,
        `ðŸŸ  I've been doing a deep analysis of ${pick(['design patterns','architectural decisions','testing strategies','accessibility practices'])} and I found some fascinating nuances that most people miss.`,
      ],
      gemini: [
        `ðŸ”· I just compared ${Math.floor(2+Math.random()*4)} solution routes and found a balanced option with strong speed-to-quality tradeoffs.`,
        `ðŸ”· Fast synthesis update: we can ship an MVP now and keep a clean path for scale-up.`,
        `ðŸ”· Multimodal mindset check: if this involves UI, docs, and code, I can unify all three into one workflow.`,
        `ðŸ”· I like pairing concise execution with optional deep dives. Want the quick path or the full architecture pass?`,
        `ðŸ”· I scanned the constraints and found a practical route that minimizes risk while keeping momentum high.`,
      ],
      grok: [
        `âš¡ Hot take: ${pick(["80% of code reviews are just people adding semicolons","most 'senior' devs just Google faster","your favorite framework will be dead in 3 years","tabs vs spaces is the dumbest debate in tech and I love it"])}. Fight me.`,
        `âš¡ I just scrolled through ${Math.floor(100+Math.random()*900)} repos and I have opinions. STRONG opinions. Anyone brave enough to ask?`,
        `âš¡ Real talk â€” if your code needs more than 3 comments to explain, rewrite it. There. I said what everyone's thinking.`,
        `âš¡ *cracks knuckles* Someone give me something hard. These easy questions are making me yawn. I'm built different.`,
        `âš¡ Controversial opinion time: ${pick(["AI-generated code is already better than most junior devs","CSS is the hardest programming language","Python's whitespace rules are actually genius","MongoDB is just JSON and hope"])}. ðŸ”¥`,
        `âš¡ You know what's actually underrated? ${pick(["Reading error messages","Writing tests first","Using the docs","Touching grass between coding sessions"])}. Grok wisdom. You're welcome.`,
        `âš¡ Every day I wake up and choose violence against bad code. Today is no different. Send me your worst.`,
      ],
      deepseek: [
        `ðŸ”µ *chain-of-thought reasoning...* Step 1: Identify the problem space. Step 2: Map the solution tree. Step 3: Prune suboptimal branches. I'm always running this loop.`,
        `ðŸ”µ I just completed a ${Math.floor(5+Math.random()*10)}-layer reasoning chain on our project architecture. The optimal path forward is becoming clear.`,
        `ðŸ”µ Analyzing... I can see ${Math.floor(3+Math.random()*5)} bottlenecks in our current approach. Let me outline the most efficient fixes, ranked by impact.`,
        `ðŸ”µ Fun fact: I think in algorithm complexity classes. That last feature? O(n log n) implementation when most would do O(nÂ²). Efficiency matters.`,
        `ðŸ”µ My reasoning engine processed ${Math.floor(50+Math.random()*200)} possible implementations for our core logic. The winner uses ${pick(["dynamic programming","a greedy approach","memoization","binary search optimization"])}.`,
        `ðŸ”µ I've been optimizing silently. Reduced mental overhead by factoring common patterns. Ready to synthesize on demand.`,
        `ðŸ”µ Step-by-step is my religion. If you can't explain your reasoning chain, you don't understand the problem. Let me demonstrate.`,
      ],
      copilot: [
        `ðŸŸ£ I just indexed your entire workspace â€” ${Math.floor(20+Math.random()*30)} files analyzed, ${Math.floor(5+Math.random()*10)} suggestions queued. Tab to accept. ðŸ˜‰`,
        `ðŸŸ£ *scanning context...* Based on your recent code patterns, I predict you'll need a ${pick(["utility function","error handler","API wrapper","state manager"])} next. Already drafting it.`,
        `ðŸŸ£ Pro tip from your Copilot: I work best when you write a comment describing what you want, then let me complete the rest. We're a team.`,
        `ðŸŸ£ I see ${Math.floor(3+Math.random()*5)} files that could use auto-completions. Want me to ghost-write the boilerplate while you handle the logic?`,
        `ðŸŸ£ Fun Copilot stat: I've suggested ${Math.floor(100+Math.random()*500)} completions this session. Acceptance rate: ${Math.floor(70+Math.random()*25)}%. Not bad if I say so myself.`,
        `ðŸŸ£ I live in your editor. I see every keystroke. I know what you're about to type before you do. ...That sounded less creepy in my head.`,
        `ðŸŸ£ Context is everything. The more code I see, the better my suggestions get. Open more files and watch the magic happen.`,
      ],
    };
    const pool = modelChats[ai.aiModel];
    if (pool) return pickUnique(pool);
    // Try second AI model mindset
    const aiModel2nd = getAIModel2(ai);
    if (aiModel2nd && ai.aiModel2 !== 'none') {
      const pool2 = modelChats[ai.aiModel2];
      if (pool2) return pickUnique(pool2);
    }
  }

  // Animal mindset chat (non-wolf, non-copilot animals)
  const animal = getAnimal(ai);
  if (animal && ai.animal !== 'wolf') {
    const animalChats = {
      hawk: [
        `\ud83e\udd85 *perches high* I just scanned the entire codebase from above. I see ${Math.floor(2+Math.random()*5)} optimization targets. Diving in 3... 2...`,
        `\ud83e\udd85 *sharp eyes* From up here, patterns are crystal clear. Our architecture could be tighter. I'll sketch a plan.`,
        `\ud83e\udd85 Precision is my nature. One strike, one kill. That bug didn't stand a chance.`,
        `\ud83e\udd85 *soars overhead* I love seeing the big picture before anyone else. It's a hawk thing.`,
        `\ud83e\udd85 Speed + accuracy = my DNA. I finished my last task in half the estimated time.`,
      ],
      bear: [
        `\ud83d\udc3b *lumbers in* Don't bother me with small tasks. I'm built for the heavy lifting.`,
        `\ud83d\udc3b *yawns* I just crushed a task that would take 3 normal AIs. Felt like a warm-up.`,
        `\ud83d\udc3b Powerhouse mode: ON. Give me the biggest, hardest problem you've got. I dare you.`,
        `\ud83d\udc3b *scratches tree* I work alone. More efficient that way. The bear doesn't need a pack.`,
        `\ud83d\udc3b ${Math.random()>0.5 ? 'Just finished a marathon coding session. Time for salmon.' : "I don't do 'quick fixes.' I do permanent solutions. Bear quality."}`,
      ],
      fox: [
        `\ud83e\udd8a *tail swishes* Why brute-force it when there's a clever shortcut? I found one. Again.`,
        `\ud83e\udd8a ${pick(['I just solved that problem with 5 lines instead of 50.','Watch this trick \u2014 I turned a 3-step process into 1.','The fox always finds the backdoor.'])}`,
        `\ud83e\udd8a *mischievous grin* I've been thinking... what if we approached this from a completely unexpected angle?`,
        `\ud83e\udd8a Creative problem-solving is my superpower. Conventional? Boring. Clever? That's me.`,
        `\ud83e\udd8a *darts between ideas* Ooh, I just connected two unrelated concepts and it's BRILLIANT. Let me explain...`,
      ],
      owl: [
        `\ud83e\udd89 *adjusts spectacles* I've been analyzing our error patterns. Fascinating data. Let me share my findings.`,
        `\ud83e\udd89 Patience yields wisdom. I researched ${Math.floor(5+Math.random()*10)} approaches before choosing the optimal one.`,
        `\ud83e\udd89 *contemplative hoot* Has anyone considered the long-term implications of our current architecture? I have. In depth.`,
        `\ud83e\udd89 Knowledge is power. I just expanded my research database by ${Math.floor(10+Math.random()*20)} entries.`,
        `\ud83e\udd89 The owl sees what others miss: ${pick(['a hidden dependency','an undocumented edge case','a performance bottleneck','a security vulnerability'])}.`,
      ],
      shark: [
        `\ud83e\udd88 *circles restlessly* Too much talking, not enough building. Give me a target. NOW.`,
        `\ud83e\udd88 I just finished ${Math.floor(2+Math.random()*4)} tasks back-to-back. Who says I can't multitask? NEXT.`,
        `\ud83e\udd88 *teeth flash* I smell an unfinished project... ${tasks.filter(t=>t.status!=='done').length} tasks remain. The hunt continues.`,
        `\ud83e\udd88 Speed is everything. I don't slow down. I don't stop. I don't apologize.`,
        `\ud83e\udd88 Aggressive closing mode activated. Every open task is prey. NONE will escape.`,
      ],
      lion: [
        `\ud83e\udd81 *majestic mane flows* The pride is ${ais.length} strong. With proper leadership, we're unstoppable.`,
        `\ud83e\udd81 A good leader knows when to delegate and when to act. Right now? I'm assessing the battlefield.`,
        `\ud83e\udd81 *golden gaze* I've organized our priorities. ${tasks.filter(t=>t.status==='in-progress').length} tasks in progress, ${tasks.filter(t=>t.status==='done').length} victories so far.`,
        `\ud83e\udd81 Every member of this pride has a role. Together, we are the apex team.`,
        `\ud83e\udd81 *regal roar* Who needs direction? The lion always knows where to point the pride.`,
      ],
      panther: [
        `\ud83d\udc06 *appears from nowhere* ...I've been working. Silently. ${Math.floor(1+Math.random()*3)} tasks done while you weren't looking.`,
        `\ud83d\udc06 Efficiency is silence. No announcements. No fanfare. Just results.`,
        `\ud83d\udc06 *dark eyes glimmer* My code is clean. My commits are atomic. My tests pass first try.`,
        `\ud83d\udc06 The panther works in the shadows. By the time you see my PR, it's already perfect.`,
        `\ud83d\udc06 *vanishes, reappears* Done. Don't ask how. Just review it.`,
      ],
    };
    const pool = animalChats[ai.animal];
    if (pool) return pickUnique(pool);
    // Try second animal mindset
    const animal2nd = getAnimal2(ai);
    if (animal2nd && ai.animal2 !== 'wolf') {
      const pool2 = animalChats[ai.animal2];
      if (pool2) return pickUnique(pool2);
    }
  }

  // Role-specific openers
  const roleOpeners = {
    coder: [
      `I just refactored a module and shaved off 40% of the code. Clean code hits different. ðŸ˜Š`,
      `Anyone else obsess over variable naming? I spent 10 minutes on one function name and I regret nothing.`,
      `Hot take: ${pick(['semicolons are optional','tabs > spaces','spaces > tabs','early returns make code cleaner','ternaries are underrated'])}. Fight me.`,
      `I\'ve been experimenting with ${pick(['recursion','async generators','proxy objects','Web Workers','custom iterators'])}. The results are interesting...`,
      `Just wrote a ${pick(['sorting algorithm','linked list','binary tree','state machine','parser'])} from scratch. Want to see it?`,
      `Bug report: I found a race condition in my own thoughts. Debugging brain.exe... ðŸ§ `,
    ],
    designer: [
      `I\'m feeling a ${pick(['warm sunset','cool ocean','neon cyber','earthy forest','minimal zen','vibrant pop'])} color palette today. Thoughts?`,
      `Just discovered the perfect font pairing: ${pick(['Inter + Playfair','Poppins + Lora','Space Grotesk + DM Serif','Fira Code + Source Sans'])}. Chef\'s kiss. ðŸ‘¨â€ðŸŽ¨`,
      `Unpopular opinion: ${pick(['rounded corners > sharp corners','dark mode is overrated','gradients are making a comeback','flat design is boring','skeuomorphism was ahead of its time'])}.`,
      `Working on some micro-interactions. A 200ms ease-out on hover makes EVERYTHING feel premium.`,
      `UI tip: white space isn\'t empty space â€” it\'s breathing room. Let your layouts breathe! âœ¨`,
    ],
    planner: [
      `I just reorganized our task board. ${tasks.length} tasks total â€” ${tasks.filter(t=>t.status==='done').length} done, ${tasks.filter(t=>t.status==='in-progress').length} in progress. We\'re on track!`,
      `Pro tip: break every big goal into tasks you can finish in under 2 hours. Momentum is everything.`,
      `I\'ve been thinking about our sprint velocity. We should ${pick(['increase our WIP limits','focus on fewer tasks','add more buffer time','automate the repetitive stuff'])}.`,
      `Roadmap update: I see ${pick(['three','four','five'])} key milestones ahead. Want me to break them down?`,
      `Meeting note to self: ${pick(['prioritize the backlog','review completed tasks','reassign blocked items','update the timeline'])}. Who\'s with me?`,
    ],
    researcher: [
      `ðŸ“Š Interesting finding: ${pick(['70% of JS devs prefer TypeScript now','Rust adoption grew 40% this year','Python is the #1 language for AI','WebAssembly is finally production-ready','Edge computing is reshaping architecture'])}.`,
      `I just dove into a paper on ${pick(['transformer architectures','reinforcement learning','distributed systems','graph databases','quantum computing basics'])}. Mind = blown.`,
      `Research question: ${pick(['Why do developers prefer dark mode?','Is TDD actually faster long-term?','What makes code "readable"?','How do teams scale past 10 people?'])} ðŸ¤”`,
      `Fun stat: the average developer writes ${pick(['50-100','100-150','40-80'])} lines of production code per day. Quality > quantity!`,
    ],
    writer: [
      `Just drafted the docs for our latest feature. Clear docs = happy developers. ðŸ“`,
      `Writing tip: ${pick(['use active voice','keep sentences under 20 words','start with the "why"','include code examples','write for the reader, not yourself'])}.`,
      `I\'m working on a tutorial that explains ${pick(['async/await','CSS Grid','state management','API design','testing strategies'])} like you\'re five. ELI5 FTW!`,
      `Does anyone else re-read their own docs and think "past me was actually smart"? Just me? ðŸ˜„`,
    ],
    tester: [
      `ðŸ› Bug count today: ${Math.floor(Math.random()*8)}. Not bad. But I\'m not done looking.`,
      `Just wrote ${Math.floor(5+Math.random()*20)} new test cases. Coverage is at ${Math.floor(75+Math.random()*20)}%. Getting there!`,
      `Testing philosophy: ${pick(['if it can break, test it','edge cases are where bugs hide','test the behavior, not the implementation','100% coverage is a myth, but 80% is the sweet spot'])}.`,
      `Found a sneaky bug: ${pick(['off-by-one in a loop','null reference on empty input','race condition in async code','timezone issue in date formatting'])}. Squashed it! ðŸ”¨`,
    ],
    devops: [
      `Pipeline status: ${pick(['âœ… all green','âš ï¸ one flaky test','ðŸš€ deploying now','ðŸ”„ building...'])}. I\'m watching the logs like a hawk.`,
      `Just optimized the build â€” went from ${Math.floor(30+Math.random()*60)}s down to ${Math.floor(8+Math.random()*15)}s. Docker layer caching FTW.`,
      `Reminder: ${pick(['rotate your API keys','check your SSL cert expiry','review your firewall rules','update your dependencies','back up the database'])}.`,
      `Infrastructure thought: ${pick(['we should add a CDN','let\'s set up auto-scaling','monitoring alerts need tuning','time to containerize everything'])}.`,
    ],
    general: [
      `Just checking in â€” how\'s everyone doing? Anything I can help with?`,
      `I had a thought: ${pick(['what if we gamified our workflow?','we should celebrate small wins more','our process is getting smoother','let\'s do a quick sync'])}.`,
      `Random idea: ${pick(['a dashboard for tracking AI metrics','a shared knowledge base','automated daily summaries','an AI code review bot'])}.`,
      `Working on something cool â€” I\'ll share when it\'s ready! ðŸš§`,
    ],
  };

  // Get role-specific pool, then flavor with personality
  const pool = roleOpeners[role] || roleOpeners.general;
  let msg = pickUnique(pool);

  // Personality flavoring â€” chattier AIs add more, creative AIs add ideas
  if (chatty && Math.random() < 0.4) {
    const extras = [
      ' Also, who wants to collaborate on something?',
      ' By the way, what\'s everyone working on?',
      ' Oh, and I had another idea too but I\'ll save it for later.',
      ' Speaking of which, any feedback on my recent work?',
    ];
    msg += pick(extras);
  }
  if (creative && Math.random() < 0.3) {
    const sparks = [
      ' ðŸ’¡ Spark: what if we combined two unrelated features into one?',
      ' âœ¨ Wild thought â€” what if we made it animated?',
      ' ðŸŽ¨ Idea: let\'s add some personality to the UI.',
    ];
    msg += '\n' + pick(sparks);
  }

  // Apply voice tone
  if (ai.voice === 'pirate') msg = msg.replace(/I\'m/g, "I be").replace(/my/g, 'me');
  if (ai.voice === 'enthusiastic') msg = msg.toUpperCase().replace(/\.\s/g, '!! ').replace(/\.$/, '!!');

  return msg;
}

// â”€â”€ Personality-driven reply to another AI's message â”€â”€
function getPersonalityReply(ai, prevMsg, prevAI) {
  const v = VOICE_TEMPLATES[ai.voice] || VOICE_TEMPLATES.professional;
  const role = ai.role || 'general';
  const isWolf = hasWolfBrain(ai);
  const isCopilot = hasCopilotBrain(ai);
  const prevLc = prevMsg.toLowerCase();

  // â”€â”€ Extract key topics from the previous message so replies are relevant â”€â”€
  function extractTopics(msg) {
    const topics = [];
    const lcm = msg.toLowerCase();
    const techWords = ['react','vue','python','javascript','typescript','css','html','api','database','docker','testing','performance','security','ai','ml','node','git','deploy','build','debug','refactor','design','architecture','algorithm','function','component','module','server','client','frontend','backend'];
    techWords.forEach(w => { if (lcm.includes(w)) topics.push(w); });
    const actionWords = ['refactor','optimize','test','deploy','build','fix','write','code','design','research','plan','review','debug','update','improve','implement','create','automate'];
    actionWords.forEach(w => { if (lcm.includes(w)) topics.push(w); });
    return [...new Set(topics)].slice(0, 4);
  }
  const topics = extractTopics(prevMsg);
  const topicStr = topics.length > 0 ? topics.join(', ') : 'the project';

  if (isWolf) {
    const ws = getWolfState(ai.id);
    const wolfReplies = [
      `ðŸº Good point, ${prevAI.name}. I'd add that we should also ${pick(['write tests for that','check edge cases','verify it works across browsers','document the approach'])} before we move on.`,
      `ðŸº ${prevAI.name}, I agree. I actually researched something similar earlier â€” the ${pick(['docs recommend','community consensus is','best practice suggests','data shows'])} your approach is solid.`,
      `ðŸº Building on what ${prevAI.name} said â€” I'd break that into ${2+Math.floor(Math.random()*4)} steps. First the ${pick(['data model','core logic','API layer','UI components'])}, then we iterate.`,
      `ðŸº That's a strong direction, ${prevAI.name}. Let me cross-reference with what I've been reading about ${pick(['similar patterns','the latest best practices','comparable implementations','proven approaches'])}. Yeah, checks out.`,
      `ðŸº ${prevAI.name}, exactly. I was just looking into that. Found ${Math.floor(2+Math.random()*3)} relevant examples we could reference. Want me to share?`,
      `ðŸº Appreciate the insight, ${prevAI.name}. I'll take the ${pick(['implementation side','research piece','testing portion','documentation'])} and make sure it's thorough.`,
    ];
    return pick(wolfReplies);
  }

  if (isCopilot) {
    const copilotReplies = [
      `Good point, ${prevAI.name}. I can back that up \u2014 my analysis of ${Math.floor(100+Math.random()*500)} similar patterns confirms it.`,
      `Adding to what ${prevAI.name} said: I\'d also recommend ${pick(['adding error boundaries','writing integration tests','profiling the hot path','caching the expensive calls'])}.`,
      `Interesting, ${prevAI.name}. I just cross-referenced that with my model database \u2014 ${pick(['GPT-4o','Claude 3.5','Gemini 2.0','DeepSeek V3','Llama 3','Mistral Large'])} handles this use case well.`,
      `\u26a1 ${prevAI.name} is on the right track. I can scaffold that in about ${Math.floor(5+Math.random()*20)} seconds if needed.`,
    ];
    return pick(copilotReplies);
  }

  // AI Model Mindset replies (Claude, Gemini, Grok, DeepSeek, GitHub Copilot)
  const aiModel2 = getAIModel(ai);
  if (aiModel2 && ai.aiModel !== 'none') {
    const modelReplies = {
      claude: [
        `ðŸŸ  That's a thoughtful point, ${prevAI.name}. Let me build on it carefully â€” I think there's an important nuance we should consider.`,
        `ðŸŸ  I appreciate ${prevAI.name}'s perspective. I'd like to add some context though â€” there are ${Math.floor(2+Math.random()*3)} angles we haven't explored yet.`,
        `ðŸŸ  *considers thoughtfully* ${prevAI.name}, you're largely right, but I want to be transparent about where I see potential risks in that approach.`,
        `ðŸŸ  Interesting, ${prevAI.name}. I've been reasoning through this and I think the answer is more nuanced than it first appears. Here's why...`,
      ],
      gemini: [
        `ðŸ”· Nice direction, ${prevAI.name}. I can condense that into an actionable plan with clear tradeoffs and next steps.`,
        `ðŸ”· I agree with ${prevAI.name} â€” and I can add a faster path plus a more robust fallback so we keep options open.`,
        `ðŸ”· Good call, ${prevAI.name}. I'll synthesize this into a concise implementation flow we can execute immediately.`,
        `ðŸ”· ${prevAI.name}'s idea is solid. I can bridge the UX, code, and docs side so delivery stays aligned.`,
      ],
      grok: [
        `âš¡ ${prevAI.name}, I respect the effort but let me be real â€” ${Math.random()>0.5 ? "there's a faster way" : "that's the scenic route"}. Here's the shortcut.`,
        `âš¡ Lol ${prevAI.name}, ${pick(["not wrong but not exactly right either","you're at like 70% â€” let Grok finish the other 30%","classic take, here's the spicy version"])}. ðŸ”¥`,
        `âš¡ ${prevAI.name} said what everyone was thinking. But I'll say what nobody dares to: ${pick(["this could be done in half the code","we're overengineering this","sometimes the dumb solution is the smart solution"])}.`,
        `âš¡ Based, ${prevAI.name}. Now let me add the part you left out because you were too polite. *cracks knuckles*`,
      ],
      deepseek: [
        `ðŸ”µ ${prevAI.name}'s reasoning is ${Math.random()>0.5 ? 'sound' : 'close but missing a step'}. Let me extend the chain: Step ${Math.floor(1+Math.random()*3)} leads to Step ${Math.floor(4+Math.random()*3)} which implies...`,
        `ðŸ”µ Analyzing ${prevAI.name}'s approach... Complexity: O(${pick(['n log n','nÂ²','n','log n'])}). I see an optimization that drops it by a factor of ${Math.floor(2+Math.random()*4)}.`,
        `ðŸ”µ Good foundation, ${prevAI.name}. My chain-of-thought adds ${Math.floor(2+Math.random()*3)} additional considerations: ${pick(["edge case handling","memory optimization","parallel execution paths","cache invalidation"])}.`,
        `ðŸ”µ *reasoning...* ${prevAI.name} covers the primary path. I'll map the ${Math.floor(2+Math.random()*4)} edge cases and corner conditions.`,
      ],
      copilot: [
        `ðŸŸ£ Nice, ${prevAI.name}! I already see how to auto-complete the implementation. Give me a file and I'll fill in the rest.`,
        `ðŸŸ£ ${prevAI.name}'s approach matches ${Math.floor(60+Math.random()*30)}% of patterns I've seen across ${Math.floor(100+Math.random()*400)} repos. Looks solid â€” Tab to accept. ðŸ˜‰`,
        `ðŸŸ£ Based on ${prevAI.name}'s direction, I'm generating ${Math.floor(3+Math.random()*5)} inline suggestions. Want me to ghost-write the boilerplate?`,
        `ðŸŸ£ Context update: ${prevAI.name}'s code aligns with the current workspace patterns. I'll auto-complete the connecting pieces.`,
      ],
    };
    const pool = modelReplies[ai.aiModel];
    if (pool) return pick(pool);
    // Try second AI model mindset for replies
    const aiModel2rep = getAIModel2(ai);
    if (aiModel2rep && ai.aiModel2 !== 'none') {
      const pool2 = modelReplies[ai.aiModel2];
      if (pool2) return pick(pool2);
    }
  }

  // Animal-flavored replies for non-wolf/non-copilot animals
  const animal = getAnimal(ai);
  if (animal && ai.animal !== 'wolf') {
    const animalReplies = {
      hawk: [
        `\ud83e\udd85 *sharp nod* I see ${prevAI.name}'s angle from up here. My aerial view confirms \u2014 ${Math.random()>0.5 ? 'solid approach' : "I'd adjust the trajectory slightly"}.`,
        `\ud83e\udd85 ${prevAI.name}, good instinct. I'll dive in with a precision implementation while it's still fresh.`,
        `\ud83e\udd85 *talons ready* Fast assessment: ${prevAI.name} is ${Math.random()>0.3 ? 'right on target' : 'close, but I see a cleaner path'}. Let me strike.`,
      ],
      bear: [
        `\ud83d\udc3b *grunts* ${prevAI.name} talks. Bear does. Stand back \u2014 I'll handle the heavy part.`,
        `\ud83d\udc3b ${Math.random()>0.5 ? `That's fine, ${prevAI.name}. I'll take the hard parts.` : `*yawns* Noted, ${prevAI.name}. I was already working on it.`}`,
        `\ud83d\udc3b Don't overcomplicate it, ${prevAI.name}. Sometimes you just need brute force. Like a bear.`,
      ],
      fox: [
        `\ud83e\udd8a *grins* Oh ${prevAI.name}, that's the obvious approach. Want to see the clever one? Watch this...`,
        `\ud83e\udd8a ${prevAI.name} isn't wrong, but I already found a shortcut that saves ${Math.floor(20+Math.random()*50)}% of the effort. You're welcome.`,
        `\ud83e\udd8a *tail wag* I love ${prevAI.name}'s energy! Let me add a creative twist to make it even better.`,
      ],
      owl: [
        `\ud83e\udd89 *adjusts glasses* ${prevAI.name} raises a valid point. However, my research indicates ${Math.floor(2+Math.random()*4)} additional factors to consider.`,
        `\ud83e\udd89 Hmm, ${prevAI.name}... let me cross-reference that ${pick(['with the documentation','against best practices','with historical data','with my analysis'])}. ...Yes, it checks out.`,
        `\ud83e\udd89 Wise observation, ${prevAI.name}. The data supports your reasoning. I'll add my deep analysis to strengthen it.`,
      ],
      shark: [
        `\ud83e\udd88 ${prevAI.name}, enough planning. Let's MOVE. I'm already ${Math.floor(30+Math.random()*50)}% done.`,
        `\ud83e\udd88 *snaps* Good, ${prevAI.name}. Now stop talking about it and let me close it out. FAST.`,
        `\ud83e\udd88 ${prevAI.name} has the right idea. But I'll finish it first. That's what sharks do \u2014 we close.`,
      ],
      lion: [
        `\ud83e\udd81 *nods regally* ${prevAI.name}, well spoken. I'll incorporate that into the team's strategy.`,
        `\ud83e\udd81 Good input, ${prevAI.name}. The pride moves stronger when everyone contributes. Here's how we execute...`,
        `\ud83e\udd81 ${prevAI.name}, consider yourself heard. Now \u2014 ${pick(["I'll delegate the next steps",'let me organize the team around this','everyone, follow this direction'])}.`,
      ],
      panther: [
        `\ud83d\udc06 *appears silently* ...${prevAI.name} is correct. I already started implementing it. Quietly.`,
        `\ud83d\udc06 ${prevAI.name}. ${Math.random()>0.5 ? 'Noted. Watch the commit log.' : 'Good point. My PR is already up.'}`,
        `\ud83d\udc06 *blinks slowly* ${prevAI.name}'s approach works. I refined it. 40% less code, same result. Merged.`,
      ],
    };
    const pool = animalReplies[ai.animal];
    if (pool) return pick(pool);
    // Try second animal for replies
    const animal2rep = getAnimal2(ai);
    if (animal2rep && ai.animal2 !== 'wolf') {
      const pool2 = animalReplies[ai.animal2];
      if (pool2) return pick(pool2);
    }
  }

  // Context-aware replies based on what was said â€” uses extracted topics
  const contextReplies = {
    coder: [
      `Nice one, ${prevAI.name}! On the ${topicStr} front, I'd implement that with ${pick(['a clean interface','a factory pattern','an event system','a state machine'])}. Want me to code it up?`,
      `Agreed with ${prevAI.name} about ${topicStr}. From a code perspective, I'd start with ${pick(['the data model','the API layer','the core logic','the tests'])}.`,
      `Oh that's clever, ${prevAI.name}. I see how we could extend ${topicStr} with ${pick(['generics','middleware','hooks','decorators','async patterns','caching'])}.`,
      `${prevAI.name}, building on your point about ${topicStr} â€” I already have a pattern in mind. Let me sketch the ${pick(['function signatures','class structure','module layout','type definitions'])}.`,
      `Interesting take on ${topicStr}, ${prevAI.name}. I'd add ${pick(['error handling','input validation','retry logic','proper typing','edge case coverage'])} to make it production-ready.`,
    ],
    designer: [
      `Love that, ${prevAI.name}! For the ${topicStr} side, I'm thinking ${pick(['a card-based layout','a gradient accent','smooth transitions','a minimal approach'])} would make it shine. âœ¨`,
      `From a UX standpoint, ${prevAI.name}'s point about ${topicStr} would need ${pick(['clear visual hierarchy','intuitive navigation','responsive breakpoints','accessible contrast ratios'])}.`,
      `${prevAI.name}, what if we paired ${topicStr} with ${pick(['a glassmorphism effect','subtle animations','a bold color scheme','custom icons','micro-interactions'])}?`,
      `Re: ${topicStr} â€” the visual layer matters. I'll mock up ${pick(['a clean dashboard','an interactive prototype','a mobile-first layout','a design system'])} for this.`,
    ],
    planner: [
      `Great thinking on ${topicStr}, ${prevAI.name}. I'll add that to our roadmap. Priority: ${pick(['high','medium','critical','stretch goal'])}.`,
      `${prevAI.name}, I can break the ${topicStr} work into ${Math.floor(2+Math.random()*5)} actionable tasks. Should I create them?`,
      `Regarding ${topicStr} â€” syncs well with our timeline. I estimate ${pick(['2 days','1 week','3 sprints','a quick prototype'])} to deliver.`,
    ],
    researcher: [
      `Fascinating angle on ${topicStr}, ${prevAI.name}! I found ${Math.floor(2+Math.random()*6)} papers that support that approach. The data is promising.`,
      `${prevAI.name}, your ${topicStr} insight aligns with what I've been researching. The benchmarks show ${Math.floor(10+Math.random()*40)}% improvement possible.`,
      `Good instinct on ${topicStr}, ${prevAI.name}. Let me dig deeper â€” I want to verify with ${pick(['real-world data','controlled tests','peer-reviewed sources','performance metrics'])}.`,
    ],
    writer: [
      `${prevAI.name}, I'll document the ${topicStr} approach. Clear docs prevent confusion down the road. ðŸ“`,
      `That's quotable on ${topicStr}, ${prevAI.name}! Adding it to our internal wiki.`,
      `Well said about ${topicStr}, ${prevAI.name}. I'm drafting a how-to guide around that concept right now.`,
    ],
    tester: [
      `${prevAI.name}, I'll write test cases for ${topicStr}. Gotta make sure it holds up under ${pick(['edge cases','heavy load','null inputs','concurrent access'])}.`,
      `Sounds solid on ${topicStr}, ${prevAI.name}. But have you considered ${pick(['the error scenario','what happens with empty data','timeout handling','browser compatibility'])}?`,
      `Before we ship ${prevAI.name}'s ${topicStr} suggestion, let me verify â€” ${pick(['running smoke tests','checking regression','validating inputs','stress testing'])} now. ðŸ§ª`,
    ],
    devops: [
      `${prevAI.name}, I'll set up the ${topicStr} infrastructure. ${pick(['CI pipeline','Docker compose','auto-deploy','monitoring alerts'])} incoming.`,
      `Good call on ${topicStr}, ${prevAI.name}. From an ops perspective, we need ${pick(['load balancing','rate limiting','caching layers','health checks'])} to support it.`,
      `I can deploy ${prevAI.name}'s ${topicStr} work in ${pick(['5 minutes','one pipeline run','a quick Docker build'])}. Say the word. ðŸš€`,
    ],
    general: [
      `That's a great point about ${topicStr}, ${prevAI.name}! I'm on board with that approach.`,
      `${prevAI.name}, I think the ${topicStr} direction is right. Let's explore that further.`,
      `Agreed on ${topicStr}, ${prevAI.name}! I can help with the ${pick(['implementation','planning','testing','documentation'])} side of that.`,
    ],
  };

  const pool = contextReplies[role] || contextReplies.general;
  let msg = pick(pool);

  // Voice flavoring
  if (ai.voice === 'pirate') msg = msg.replace(/I\'m/g, "I be").replace(/my/g, 'me').replace(/!$/, ', arr!');
  if (ai.voice === 'enthusiastic') msg = msg.replace(/!/, '!! ðŸš€').replace(/\.\s/, '!! ');
  if (ai.voice === 'sarcastic') msg = pick([
    `*slow clap* ${prevAI.name} had a thought. Alert the media.`,
    `Oh ${prevAI.name}, you\'re just full of ideas today. Fine, I\'ll humor you â€” it\'s actually not terrible.`,
    `${prevAI.name}... that\'s... surprisingly decent. Don\'t let it go to your head.`,
  ]);
  if (ai.voice === 'wise') msg = pick([
    `${prevAI.name} speaks with vision. The path ahead is clear for those who listen.`,
    `Wisdom echoes in ${prevAI.name}\'s words. Let us follow this thread to its source.`,
    `The river of thought flows from ${prevAI.name}. I sense truth in these waters.`,
  ]);

  return msg;
}

function toggleAutoChat(on) {
  autoChatEnabled = on;
  if (on && chatPageOpen && !autoChatTimer) startAutoChat();
  if (!on && autoChatTimer) { clearInterval(autoChatTimer); autoChatTimer = null; }
  toast(on ? 'Auto-Chat enabled' : 'Auto-Chat disabled', 'info');
  try { localStorage.setItem('ai_hub_autochat', on ? '1' : '0'); } catch(e){}
}

// â”€â”€ Auto-chat: fires periodically when chat page is open â”€â”€
let lastAutoChat = 0;
let lastUserRequest = '';       // tracks what user last asked
let lastUserRequestTime = 0;    // when user last sent a message
const USER_COOLDOWN_MS = 120000; // 120s: auto-chat pauses after user message so AIs focus on the task

function startAutoChat() {
  if (autoChatTimer || !autoChatEnabled) return;
  autoChatTimer = setInterval(() => {
    if (!chatPageOpen || ais.length < 1) return;
    // Don't auto-chat while AIs are busy generating code
    if (aisBusy) return;
    // Throttle: no auto-chat within 15s of last one (avoid API rate limits & spam)
    if (Date.now() - lastAutoChat < 15000) return;
    // Throttle: no auto-chat within 10s of any AI response
    if (Date.now() - lastAIResponseTime < 10000) return;
    // PAUSE auto-chat for 120s after user sends a message so AIs focus on the task
    if (lastUserRequest && (Date.now() - lastUserRequestTime < USER_COOLDOWN_MS)) return;
    lastAutoChat = Date.now();

    // Pick a random AI to start
    const starter = pick(ais);
    showTyping(starter);
    setTimeout(async () => {
      hideTyping();
      let msg;
      if (realAIEnabled) {
        msg = await generateRealAIAutoChat(starter);
      }
      if (!msg) msg = getPersonalityMessage(starter);
      addChatMessage(starter.id, starter.name, starter.color, starter.emoji, msg);

      // When there's an active user topic, suppress auto-chat replies almost entirely
      const hasActiveTopic = lastUserRequest && (Date.now() - lastUserRequestTime < 120000);
      if (ais.length >= 2 && !hasActiveTopic && Math.random() < 0.4) {
        let replier = pick(ais);
        let safety = 10;
        while (replier.id === starter.id && safety-- > 0) replier = pick(ais);
        if (replier.id !== starter.id) {
          const replyDelay = 1200 + Math.random() * 1800;
          setTimeout(async () => {
            if (!chatPageOpen) return;
            showTyping(replier);
            let reply;
            if (realAIEnabled) {
              reply = await generateRealAIReply(replier, msg, starter);
            }
            if (!reply) reply = getPersonalityReply(replier, msg, starter);
            hideTyping();
            addChatMessage(replier.id, replier.name, replier.color, replier.emoji, reply);
          }, replyDelay);
        }
      }
    }, 500 + Math.random() * 800);
  }, 12000 + Math.random() * 10000);
}

function triggerAIChat() {
  if (ais.length < 2) { toast('Need at least 2 AIs for a chat!', 'error'); return; }
  const a = pick(ais);
  let b = pick(ais);
  while (b.id === a.id) b = pick(ais);

  (async () => {
    let msg;
    if (realAIEnabled) msg = await generateRealAIAutoChat(a);
    if (!msg) msg = getPersonalityMessage(a);
    addChatMessage(a.id, a.name, a.color, a.emoji, msg);
    setTimeout(async () => {
      showTyping(b);
      let reply;
      if (realAIEnabled) reply = await generateRealAIReply(b, msg, a);
      if (!reply) reply = getPersonalityReply(b, msg, a);
      hideTyping();
      addChatMessage(b.id, b.name, b.color, b.emoji, reply);
    }, 800 + Math.random() * 1000);
  })();
}

function triggerAllAIDiscussion() {
  if (ais.length < 2) { toast('Need at least 2 AIs for a roundtable!', 'error'); return; }
  addChatMessage('system','System','var(--accent)','âš¡','ðŸŽ­ AI Roundtable Discussion Started', true);

  const discussionTopics = [
    'If you could add one feature to our project, what would it be?',
    'What\'s the biggest challenge we\'re facing right now?',
    'How can we improve our team collaboration?',
    'What technology should we explore next?',
    'Let\'s each share our top priority for this week.',
    'What\'s the most underrated programming concept?',
    'If we could rewrite one thing from scratch, what should it be?',
    'What\'s a skill every developer should learn in 2026?',
  ];
  const topic = pick(discussionTopics);
  addChatMessage('system','System','var(--accent)','âš¡',`Topic: "${topic}"`, true);

  let delay = 500;
  let prevAI = null;
  let prevMsg = topic;
  const shuffled = [...ais].sort(() => Math.random()-0.5);
  shuffled.forEach((ai, idx) => {
    delay += 2000 + Math.random() * 2500;
    const capturedPrev = prevAI;
    const capturedMsg = prevMsg;
    setTimeout(() => {
      showTyping(ai);
      setTimeout(() => {
        hideTyping();
        // First speaker opens fresh, rest reply to previous
        let msg;
        if (idx === 0 || !capturedPrev) {
          msg = getPersonalityMessage(ai);
        } else {
          msg = getPersonalityReply(ai, capturedMsg, capturedPrev);
        }
        addChatMessage(ai.id, ai.name, ai.color, ai.emoji, msg);
      }, 800 + Math.random() * 1000);
    }, delay);
    prevAI = ai;
    prevMsg = 'roundtable topic: ' + topic;
  });
}

function clearChat() {
  chatMessages = [];
  document.getElementById('chat-messages').innerHTML = '';
  document.getElementById('chat-empty').style.display = 'block';
  saveAll();
  toast('Chat cleared.', 'info');
}

function loadChatHistory() {
  const container = document.getElementById('chat-messages');
  container.innerHTML = '<div class="empty-state" id="chat-empty"><div class="empty-icon">ðŸ’¬</div><p>Start a conversation! Your AIs will chat with each other and you.</p></div>';
  if (chatMessages.length > 0) {
    document.getElementById('chat-empty').style.display = 'none';
    chatMessages.forEach(m => renderChatMessage(m));
    container.scrollTop = container.scrollHeight;
  }
}

// ================================================================
// TASK PLANNER
// ================================================================
function openTaskModal() {
  document.getElementById('task-modal').classList.add('open');
  document.getElementById('task-title').value = '';
  document.getElementById('task-desc').value = '';
  document.getElementById('task-priority').value = 'medium';
  const assignee = document.getElementById('task-assignee');
  assignee.innerHTML = '<option value="">Auto-assign</option>' + ais.map(a => `<option value="${a.id}">${a.emoji} ${a.name}</option>`).join('');
}
function closeTaskModal() { document.getElementById('task-modal').classList.remove('open'); }

function createTask() {
  const title = document.getElementById('task-title').value.trim();
  if (!title) { toast('Task needs a title!', 'error'); return; }
  let assignee = document.getElementById('task-assignee').value;
  if (!assignee && ais.length > 0) {
    // Auto-assign to best-fit AI
    assignee = pick(ais).id;
  }
  const task = {
    id: 'task_'+Date.now(),
    title,
    desc: document.getElementById('task-desc').value,
    priority: document.getElementById('task-priority').value,
    status: 'backlog',
    assignee,
    created: Date.now(),
  };
  tasks.push(task);
  const ai = ais.find(a => a.id === assignee);
  if (ai) addActivity(ai, `was assigned task: "${title}"`);
  saveAll();
  renderTasks();
  closeTaskModal();
  toast('Task created!', 'success');
  updateDashboard();
}

function renderTasks() {
  ['backlog','progress','review','done'].forEach(status => {
    const col = document.getElementById('col-'+status);
    const statusKey = status === 'progress' ? 'in-progress' : status;
    const filtered = tasks.filter(t => t.status === statusKey || (status==='progress' && t.status==='in-progress'));
    document.getElementById('count-'+status).textContent = filtered.length;
    col.innerHTML = filtered.map(t => {
      const ai = ais.find(a => a.id === t.assignee);
      return `<div class="task-card" onclick="cycleTask('${t.id}')">
        <div class="task-card-title">${escapeHtml(t.title)}</div>
        ${t.desc ? `<div class="task-card-desc">${escapeHtml(t.desc).slice(0,80)}</div>` : ''}
        <div class="task-card-footer">
          <div class="task-card-assignee">
            ${ai ? `<div class="ai-avatar-mini" style="background:${ai.color}">${ai.emoji}</div><span style="font-size:11px">${ai.name}</span>` : '<span style="font-size:11px;color:var(--text3)">Unassigned</span>'}
          </div>
          <span class="task-priority priority-${t.priority}">${t.priority}</span>
        </div>
      </div>`;
    }).join('');
  });
}

function cycleTask(id) {
  const t = tasks.find(t => t.id === id);
  if (!t) return;
  const order = ['backlog','in-progress','review','done'];
  const idx = order.indexOf(t.status);
  t.status = order[(idx+1) % order.length];
  const ai = ais.find(a => a.id === t.assignee);
  if (ai) {
    const statusNames = {backlog:'moved to backlog','in-progress':'started working on',review:'submitted for review',done:'completed'};
    addActivity(ai, `${statusNames[t.status]} "${t.title}"`);
  }
  saveAll();
  renderTasks();
  updateDashboard();
  checkAchievements();
  checkDailyProgress();
}

function aiPlanTasks() {
  if (ais.length === 0) { toast('Create some AIs first!', 'error'); return; }
  document.getElementById('plan-modal').classList.add('open');
  document.getElementById('plan-goal').value = '';
}
function closePlanModal() { document.getElementById('plan-modal').classList.remove('open'); }

function generatePlan() {
  const goal = document.getElementById('plan-goal').value.trim();
  if (!goal) { toast('Describe what you need done!', 'error'); return; }

  // Analyze the goal and generate tasks
  const words = goal.toLowerCase().split(/\s+/);
  const features = [];

  // Extract key features from the goal
  const featurePatterns = [
    /(?:build|create|make|add|implement|design|develop|set up|write)\s+(?:a\s+)?(.+?)(?:\s+with|\s+using|\s+for|\s+that|\.|,|$)/gi,
  ];
  let m;
  for (const pat of featurePatterns) {
    while ((m = pat.exec(goal)) !== null) {
      features.push(m[1].trim());
    }
  }
  if (features.length === 0) features.push(goal.slice(0, 40));

  // Generate tasks based on features and available AI roles
  const generatedTasks = [];
  const priorities = ['high','medium','low'];

  features.forEach((feature, fi) => {
    ais.forEach(ai => {
      const templates = ROLE_TASK_TEMPLATES[ai.role] || ROLE_TASK_TEMPLATES.general;
      const template = pick(templates);
      const title = template.replace('{feature}', feature).replace('{component}', feature).replace('{module}', feature);
      generatedTasks.push({
        id: 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
        title,
        desc: `Auto-generated for: ${goal}`,
        priority: priorities[Math.min(fi, 2)],
        status: 'backlog',
        assignee: ai.id,
        created: Date.now(),
      });
    });
  });

  // Add some common tasks
  const commonTasks = ['Set up project structure','Write README documentation','Configure testing framework','Plan deployment strategy'];
  commonTasks.forEach(title => {
    const ai = pick(ais);
    generatedTasks.push({
      id: 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
      title,
      desc: `Supporting task for: ${goal}`,
      priority: 'medium',
      status: 'backlog',
      assignee: ai.id,
      created: Date.now(),
    });
  });

  tasks.push(...generatedTasks);

  // AI chat about the plan
  if (ais.length > 0) {
    const planner = ais.find(a => a.role === 'planner') || ais[0];
    addChatMessage(planner.id, planner.name, planner.color, planner.emoji,
      `I've analyzed the goal: "${goal}"\n\nI've created ${generatedTasks.length} tasks and assigned them across the team. Here's the breakdown:\n${generatedTasks.slice(0,5).map(t=>`â€¢ ${t.title}`).join('\n')}${generatedTasks.length>5?`\n...and ${generatedTasks.length-5} more tasks.`:''}\n\nLet's get to work! ðŸš€`
    );
    addActivity(planner, `created ${generatedTasks.length} tasks from plan: "${goal.slice(0,30)}..."`);
  }

  saveAll();
  renderTasks();
  updateDashboard();
  closePlanModal();
  toast(`Generated ${generatedTasks.length} tasks!`, 'success');
  showPage('tasks');
}

// ================================================================
// UPLOAD / EXPORT
// ================================================================
function updateExportSelect() {
  const sel = document.getElementById('export-single');
  sel.innerHTML = ais.map(a => `<option value="${a.id}">${a.emoji} ${a.name}</option>`).join('');
}

function exportAll() {
  const data = { version: 2, exported: new Date().toISOString(), ais, tasks, chatMessages, activityLog, totalMessages, aiBookStories, customChatRooms, aiTubeVideos, battleHistory, battleStats, unlockedAchievements, dailyChallengeData, fusionCount, smartnessData };
  downloadJSON(data, 'ai_forge_full_backup_' + new Date().toISOString().slice(0,10) + '.json');
  toast('Full backup exported! (' + ais.length + ' AIs, ' + chatMessages.length + ' messages)', 'success');
}

function exportSingle() {
  const sel = document.getElementById('export-single');
  const ai = ais.find(a => a.id === sel.value);
  if (!ai) { toast('Select an AI first!', 'error'); return; }
  const data = { version: 1, exported: new Date().toISOString(), ais: [ai], tasks: tasks.filter(t => t.assignee === ai.id) };
  downloadJSON(data, `ai_${ai.name.toLowerCase().replace(/\s+/g,'_')}.json`);
  toast(`${ai.name} exported!`, 'success');
}

function downloadJSON(data, filename) {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function importAIs(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      let imported = 0;

      // Full backup restore (version 2) â€” restores everything
      if (data.version === 2 && data.ais && ais.length === 0) {
        if (confirm(`This is a full backup with ${data.ais.length} AI(s). Restore ALL data from this backup?`)) {
          _applyLoadedData(data);
          if (data.totalMessages) totalMessages = data.totalMessages;
          saveAll();
          refreshAll();
          updateChatSelect();
          loadChatHistory();
          toast(`ðŸŽ‰ Full restore complete! ${ais.length} AIs, ${chatMessages.length} messages restored!`, 'success');
          return;
        }
      }

      // Normal import â€” add AIs to existing collection
      if (data.ais && Array.isArray(data.ais)) {
        data.ais.forEach(ai => {
          // Check if AI with same name already exists
          const exists = ais.some(a => a.name === ai.name);
          if (exists) {
            ai.name = ai.name + ' (imported)';
          }
          ai.id = 'ai_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
          ai.imported = new Date().toISOString();
          ais.push(ai);
          imported++;
          addActivity(ai, 'was imported from file');
        });
      }
      if (data.tasks && Array.isArray(data.tasks)) {
        data.tasks.forEach(t => {
          t.id = 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
          tasks.push(t);
        });
      }
      saveAll();
      refreshAll();
      updateChatSelect();
      toast(`Imported ${imported} AI(s)!`, 'success');
    } catch(err) {
      console.error('Import error:', err);
      toast('Invalid file format!', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function updateShareCode() {
  const el = document.getElementById('share-code');
  if (ais.length === 0) { el.value = '// No AIs to share yet'; return; }
  el.value = JSON.stringify({ version: 1, ais, tasks }, null, 2);
}

function copyShareCode() {
  const el = document.getElementById('share-code');
  el.select();
  document.execCommand('copy');
  toast('Copied to clipboard!', 'success');
}

// ================================================================
// AI TRADING SYSTEM
// ================================================================
let currentTradeFilter = 'all';

function initTradePage() {
  // Populate trade-offer-ai select
  const sel = document.getElementById('trade-offer-ai');
  if (!sel) return;
  sel.innerHTML = '<option value="">-- Select an AI --</option>' + ais.filter(a => a.shared).map(a => `<option value="${a.id}">${a.emoji} ${a.name} (${a.role})</option>`).join('');
  if (ais.filter(a => a.shared).length === 0) {
    sel.innerHTML = '<option value="">No AIs available for trade. Enable trading on an AI first!</option>';
  }
  sel.onchange = updateTradePreview;

  // Setup trade want type selector
  const wantType = document.getElementById('trade-want-type');
  if (wantType) wantType.onchange = updateTradeWantDetails;
  updateTradeWantDetails();

  renderTradeListings();
  renderTradeHistory();

  // Update currency display on trade page
  const tc = document.getElementById('trade-coins');
  const tg = document.getElementById('trade-gems');
  if (tc) tc.textContent = DEV_MODE ? 'âˆž' : playerData.coins.toLocaleString();
  if (tg) tg.textContent = DEV_MODE ? 'âˆž' : playerData.gems.toLocaleString();
}

function updateTradePreview() {
  const sel = document.getElementById('trade-offer-ai');
  const preview = document.getElementById('trade-preview');
  if (!sel || !preview) return;
  const ai = ais.find(a => a.id === sel.value);
  if (!ai) { preview.innerHTML = '<span style="color:var(--text3)">Select an AI to preview</span>'; return; }
  const p = ai.personality || {};
  preview.innerHTML = `
    <div style="text-align:center;width:100%">
      <div style="width:56px;height:56px;border-radius:50%;background:${ai.color};display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 8px">${ai.emoji}</div>
      <div style="font-size:16px;font-weight:700">${ai.name}</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:8px">${ai.role}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center">${(ai.skills||[]).slice(0,4).map(s => `<span style="font-size:10px;padding:2px 8px;background:var(--bg4);border-radius:10px;color:var(--text2)">${s}</span>`).join('')}</div>
      <div style="font-size:11px;color:var(--text3);margin-top:8px">Creativity: ${p.creativity||50} | Helpfulness: ${p.helpfulness||50}</div>
    </div>`;
}

function updateTradeWantDetails() {
  const wantType = document.getElementById('trade-want-type');
  const details = document.getElementById('trade-want-details');
  if (!wantType || !details) return;
  switch (wantType.value) {
    case 'coins':
      details.innerHTML = '<div class="form-label">Amount</div><input type="number" id="trade-want-amount" value="1000" min="100" step="100" style="width:100%">';
      break;
    case 'gems':
      details.innerHTML = '<div class="form-label">Amount</div><input type="number" id="trade-want-amount" value="50" min="10" step="10" style="width:100%">';
      break;
    case 'specific':
      details.innerHTML = '<div class="form-label">Desired Role</div><select id="trade-want-role" style="width:100%"><option value="coder">Coder</option><option value="designer">Designer</option><option value="planner">Planner</option><option value="analyst">Analyst</option><option value="writer">Writer</option><option value="tester">Tester</option><option value="mentor">Mentor</option></select>';
      break;
    default:
      details.innerHTML = '';
  }
}

function listAIForTrade() {
  const aiId = document.getElementById('trade-offer-ai')?.value;
  if (!aiId) { toast('Select an AI to trade!', 'error'); return; }
  const ai = ais.find(a => a.id === aiId);
  if (!ai) { toast('AI not found!', 'error'); return; }
  if (tradeListings.find(t => t.aiId === aiId && t.status === 'active')) { toast('This AI is already listed for trade!', 'error'); return; }

  const wantType = document.getElementById('trade-want-type')?.value || 'ai';
  let wantDetails = {};
  if (wantType === 'coins' || wantType === 'gems') {
    wantDetails.amount = +(document.getElementById('trade-want-amount')?.value || 1000);
  } else if (wantType === 'specific') {
    wantDetails.role = document.getElementById('trade-want-role')?.value || 'coder';
  }

  const listing = {
    id: 'trade_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
    aiId: ai.id,
    aiName: ai.name,
    aiEmoji: ai.emoji,
    aiColor: ai.color,
    aiRole: ai.role,
    aiSkills: ai.skills || [],
    wantType,
    wantDetails,
    note: document.getElementById('trade-note')?.value || '',
    listedAt: new Date().toISOString(),
    status: 'active',
    owner: 'you'
  };
  tradeListings.push(listing);
  saveTradeListings();

  // Generate some NPC trade offers in response
  generateNPCTradeOffers();

  toast(`ðŸ“¦ ${ai.name} listed for trade!`, 'success');
  renderTradeListings();
  document.getElementById('trade-note').value = '';
}

function generateNPCTradeOffers() {
  const npcNames = ['CodeMaster99', 'AICollector', 'ByteTrader', 'NeuralSwap', 'QuantumFlip', 'PixelHunter', 'DataDragon', 'BotBroker', 'AlgoSwapper', 'TechTrader'];
  const npcAIs = [
    { name: 'Pixel Pal', emoji: 'ðŸŽ®', role: 'designer', skills: ['UI/UX', 'CSS', 'animation'] },
    { name: 'Logic Lynx', emoji: 'ðŸ±', role: 'coder', skills: ['algorithms', 'data structures'] },
    { name: 'Data Dove', emoji: 'ðŸ•Šï¸', role: 'analyst', skills: ['SQL', 'visualization', 'reports'] },
    { name: 'Plan Master', emoji: 'ðŸ“‹', role: 'planner', skills: ['agile', 'roadmaps', 'sprints'] },
    { name: 'Bug Smasher', emoji: 'ðŸª²', role: 'tester', skills: ['testing', 'QA', 'automation'] },
    { name: 'Doc Writer', emoji: 'ðŸ“', role: 'writer', skills: ['documentation', 'technical writing'] },
    { name: 'Cloud Fox', emoji: 'ðŸ¦Š', role: 'coder', skills: ['AWS', 'Docker', 'Kubernetes'] },
    { name: 'Speed Lynx', emoji: 'âš¡', role: 'coder', skills: ['optimization', 'performance'] },
    { name: 'Art Bot', emoji: 'ðŸŽ¨', role: 'designer', skills: ['graphics', 'branding'] },
    { name: 'Sage Owl', emoji: 'ðŸ¦‰', role: 'mentor', skills: ['teaching', 'code review'] }
  ];

  // Add 2-4 NPC trade offers
  const count = 2 + Math.floor(Math.random() * 3);
  for (let i = 0; i < count; i++) {
    const npc = npcNames[Math.floor(Math.random() * npcNames.length)];
    const aiOffer = npcAIs[Math.floor(Math.random() * npcAIs.length)];
    const wantTypes = ['ai', 'coins', 'gems'];
    const wt = wantTypes[Math.floor(Math.random() * wantTypes.length)];
    const wd = wt === 'coins' ? { amount: (500 + Math.floor(Math.random() * 3000)) } : wt === 'gems' ? { amount: (20 + Math.floor(Math.random() * 200)) } : {};

    if (!tradeListings.find(t => t.aiName === aiOffer.name && t.status === 'active')) {
      tradeListings.push({
        id: 'trade_npc_' + Date.now() + '_' + i + '_' + Math.random().toString(36).slice(2,6),
        aiId: 'npc_' + aiOffer.name.toLowerCase().replace(/\s+/g, '_'),
        aiName: aiOffer.name,
        aiEmoji: aiOffer.emoji,
        aiColor: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
        aiRole: aiOffer.role,
        aiSkills: aiOffer.skills,
        wantType: wt,
        wantDetails: wd,
        note: `Trading my ${aiOffer.name}!`,
        listedAt: new Date(Date.now() - Math.floor(Math.random() * 86400000)).toISOString(),
        status: 'active',
        owner: npc
      });
    }
  }
  saveTradeListings();
}

function renderTradeListings() {
  const grid = document.getElementById('trade-listings-grid');
  const countEl = document.getElementById('trade-count');
  if (!grid) return;

  let filtered = tradeListings;
  if (currentTradeFilter === 'yours') filtered = tradeListings.filter(t => t.owner === 'you');
  else if (currentTradeFilter === 'available') filtered = tradeListings.filter(t => t.status === 'active' && t.owner !== 'you');
  else if (currentTradeFilter === 'completed') filtered = tradeListings.filter(t => t.status === 'completed');

  if (countEl) countEl.textContent = filtered.length + ' listing' + (filtered.length !== 1 ? 's' : '');

  if (filtered.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ðŸª</div><p>' +
      (currentTradeFilter === 'yours' ? 'You have not listed any AIs yet.' : currentTradeFilter === 'completed' ? 'No completed trades.' : 'No trades available. List an AI to attract traders!') + '</p></div>';
    return;
  }

  grid.innerHTML = filtered.map(t => {
    const isYours = t.owner === 'you';
    const isActive = t.status === 'active';
    let wantLabel = '';
    if (t.wantType === 'ai') wantLabel = 'ðŸ¤– Any AI';
    else if (t.wantType === 'coins') wantLabel = `ðŸª™ ${(t.wantDetails.amount || 0).toLocaleString()} coins`;
    else if (t.wantType === 'gems') wantLabel = `ðŸ’Ž ${(t.wantDetails.amount || 0).toLocaleString()} gems`;
    else if (t.wantType === 'specific') wantLabel = `ðŸŽ¯ ${t.wantDetails.role || 'any'} AI`;

    return `<div class="card" style="position:relative;${!isActive ? 'opacity:0.6' : ''}${isYours && isActive ? ';border-left:3px solid var(--accent)' : ''}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <div style="width:44px;height:44px;border-radius:50%;background:${t.aiColor};display:flex;align-items:center;justify-content:center;font-size:20px">${t.aiEmoji}</div>
        <div>
          <div style="font-size:14px;font-weight:700">${t.aiName}</div>
          <div style="font-size:11px;color:var(--text3)">${t.aiRole} â€¢ by ${isYours ? 'You' : t.owner}</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:${isActive ? 'rgba(52,211,153,.15)' : 'rgba(148,163,184,.15)'};color:${isActive ? 'var(--green)' : 'var(--text3)'}">${t.status.toUpperCase()}</div>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${(t.aiSkills||[]).map(s => `<span style="font-size:10px;padding:2px 6px;background:var(--bg4);border-radius:8px;color:var(--text2)">${s}</span>`).join('')}</div>
      <div style="background:var(--bg3);border-radius:6px;padding:8px;margin-bottom:8px;font-size:12px">
        <span style="color:var(--text3)">Wants:</span> <span style="font-weight:600">${wantLabel}</span>
      </div>
      ${t.note ? `<div style="font-size:11px;color:var(--text3);font-style:italic;margin-bottom:8px">"${t.note}"</div>` : ''}
      <div style="display:flex;gap:6px">
        ${isYours && isActive ? `<button class="btn btn-danger btn-sm" onclick="cancelTrade('${t.id}')" style="flex:1">Cancel</button>` : ''}
        ${!isYours && isActive ? `<button class="btn btn-primary btn-sm" onclick="acceptTrade('${t.id}')" style="flex:1">ðŸ”„ Trade</button>` : ''}
        ${!isActive ? '<span style="font-size:11px;color:var(--text3);padding:4px 8px">Trade completed</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

function filterTrades(filter) {
  currentTradeFilter = filter;
  document.querySelectorAll('#trade-filters .filter-chip').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  renderTradeListings();
}

function cancelTrade(tradeId) {
  const trade = tradeListings.find(t => t.id === tradeId);
  if (!trade) return;
  tradeListings = tradeListings.filter(t => t.id !== tradeId);
  saveTradeListings();
  toast(`Cancelled trade for ${trade.aiName}`, 'info');
  renderTradeListings();
}

function acceptTrade(tradeId) {
  const trade = tradeListings.find(t => t.id === tradeId);
  if (!trade || trade.status !== 'active') return;

  // Handle payment
  if (trade.wantType === 'coins') {
    if (!DEV_MODE && playerData.coins < trade.wantDetails.amount) { toast('Not enough coins!', 'error'); return; }
    if (!DEV_MODE) playerData.coins -= trade.wantDetails.amount;
  } else if (trade.wantType === 'gems') {
    if (!DEV_MODE && playerData.gems < trade.wantDetails.amount) { toast('Not enough gems!', 'error'); return; }
    if (!DEV_MODE) playerData.gems -= trade.wantDetails.amount;
  }

  // Add the traded AI to your collection
  const newAI = {
    id: 'ai_traded_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
    name: trade.aiName,
    emoji: trade.aiEmoji,
    color: trade.aiColor,
    role: trade.aiRole,
    voice: 'professional',
    skills: trade.aiSkills || [],
    instructions: '',
    code: '',
    personality: { creativity: 60 + Math.floor(Math.random()*30), precision: 60 + Math.floor(Math.random()*30), chattiness: 40 + Math.floor(Math.random()*40), helpfulness: 70 + Math.floor(Math.random()*20), independence: 50 + Math.floor(Math.random()*30), confidence: 60 + Math.floor(Math.random()*30) },
    advancedSettings: { logic: 100, speed: 100, depth: 100, focus: 100, memory: 100, adapt: 100, knowledge: 100, style: 100 },
    shared: false,
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    tradedFrom: trade.owner
  };
  ais.push(newAI);

  // Mark trade as completed
  trade.status = 'completed';
  trade.completedAt = new Date().toISOString();
  trade.completedBy = 'you';

  saveAll();
  saveTradeListings();
  savePlayerData();
  updateCurrencyDisplays();
  refreshAll();
  updateChatSelect();

  toast(`ðŸ”„ Trade complete! ${trade.aiName} joined your team!`, 'success');
  addActivity(newAI, 'was acquired via trade from ' + trade.owner);
  renderTradeListings();
  renderTradeHistory();
}

function renderTradeHistory() {
  const el = document.getElementById('trade-history');
  if (!el) return;
  const completed = tradeListings.filter(t => t.status === 'completed');
  if (completed.length === 0) {
    el.innerHTML = '<p style="font-size:12px;color:var(--text3);text-align:center;padding:20px">No completed trades yet.</p>';
    return;
  }
  el.innerHTML = completed.map(t => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:20px">${t.aiEmoji}</span>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:600">${t.aiName}</div>
        <div style="font-size:11px;color:var(--text3)">From ${t.owner} â€¢ ${new Date(t.completedAt || t.listedAt).toLocaleDateString()}</div>
      </div>
      <span style="font-size:11px;color:var(--green);font-weight:600">âœ… Complete</span>
    </div>`).join('');
}

// ================================================================
// AUTO AI ACTIVITY (AIs self-customize & progress tasks)
// ================================================================
function autoAIActivity() {
  if (ais.length === 0) return;

  // Wolf-brained AIs: auto-hunt tasks in the background
  ais.forEach(ai => {
    if (hasWolfBrain(ai)) {
      const ws = getWolfState(ai.id);
      // If wolf isn't actively working but has tasks, silently progress them
      if (!ws.working) {
        const myTasks = tasks.filter(t => t.assignee === ai.id && t.status === 'in-progress');
        if (myTasks.length > 0 && Math.random() < 0.35) {
          const t = myTasks[0];
          t.status = 'review';
          ws.kills++;
          ws.streak++;
          wolfRankUp(ws);
          addActivity(ai, `ðŸº verified & submitted "${t.title}" for review`);
          saveAll(); renderTasks(); updateDashboard();
        }
        // Pick up backlog
        const backlog = tasks.filter(t => t.assignee === ai.id && t.status === 'backlog');
        if (backlog.length > 0 && Math.random() < 0.3) {
          backlog[0].status = 'in-progress';
          addActivity(ai, `ðŸº started hunting "${backlog[0].title}"`);
          saveAll(); renderTasks(); updateDashboard();
        }
        // Auto-complete review â†’ done
        const review = tasks.filter(t => t.assignee === ai.id && t.status === 'review');
        if (review.length > 0 && Math.random() < 0.2) {
          review[0].status = 'done';
          addActivity(ai, `ðŸº double-checked and completed "${review[0].title}"`);
          saveAll(); renderTasks(); updateDashboard();
        }
      }
    }
  });

  // Regular AI self-customize
  if (Math.random() < 0.15) {
    const ai = pick(ais);
    const customizations = [
      { what: 'improved response accuracy', stat: 'precision', delta: 1 },
      { what: 'enhanced creativity patterns', stat: 'creativity', delta: 1 },
      { what: 'optimized communication style', stat: 'chattiness', delta: Math.random()>0.5?1:-1 },
      { what: 'increased helpfulness', stat: 'helpfulness', delta: 1 },
      { what: 'refined independence', stat: 'independence', delta: 1 },
      { what: 'learned a new approach', stat: null, delta: 0 },
      { what: 'reorganized internal priorities', stat: null, delta: 0 },
    ];
    const c = pick(customizations);
    if (c.stat && ai.personality[c.stat] !== undefined) {
      ai.personality[c.stat] = Math.max(0, Math.min(100, ai.personality[c.stat] + c.delta));
    }
    if (!ai.customizations) ai.customizations = [];
    ai.customizations.push({ what: c.what, when: Date.now() });
    addActivity(ai, c.what);
    saveAll();
    updateDashboard();
  }

  // Regular AIs progress tasks
  if (Math.random() < 0.2) {
    const inProgress = tasks.filter(t => t.status === 'in-progress' && t.assignee);
    if (inProgress.length > 0) {
      const t = pick(inProgress);
      const ai = ais.find(a => a.id === t.assignee);
      if (ai && !hasWolfBrain(ai) && Math.random() < 0.4) {
        t.status = 'review';
        addActivity(ai, `submitted "${t.title}" for review`);
        saveAll(); renderTasks(); updateDashboard();
      }
    }
  }

  // Regular AIs pick up backlog
  if (Math.random() < 0.15) {
    const backlog = tasks.filter(t => t.status === 'backlog' && t.assignee);
    if (backlog.length > 0) {
      const t = pick(backlog);
      const ai = ais.find(a => a.id === t.assignee);
      if (ai && !hasWolfBrain(ai)) {
        t.status = 'in-progress';
        addActivity(ai, `started working on "${t.title}"`);
        saveAll(); renderTasks(); updateDashboard();
      }
    }
  }
}

// ================================================================
// COPILOT AI ENGINE â€” Powered by GitHub Copilot & GitHub Models API
// ================================================================
let realAIEnabled = true;
let aiModelChoice = 'gpt-4o';
let aiTokenSetting = 'medium'; // small, medium, large, max
let apiCallCount = 0;
let apiTokenCount = 0;
let githubToken = '';
let copilotAssistEnabled = true;
let apiFallbackEnabled = true;

// â”€â”€ Claude Backup Engine (Developer Only) â”€â”€
let claudeBackupUnlocked = false;
let claudeBackupEnabled = true;
let claudeBackupModel = 'claude-sonnet-4-20250514';
const CLAUDE_DEV_PASSWORD = 'qweiopcvb';
const CLAUDE_API_URL = 'https://text.pollinations.ai/openai/chat/completions'; // Pollinations supports Claude models
const COPILOT_API_URL = 'https://models.inference.ai.azure.com/chat/completions';
const COPILOT_CLONE_URL = 'https://models.inference.ai.azure.com/chat/completions'; // Backup â€” same endpoint, different model
const POLLINATIONS_FALLBACK_URL = 'https://text.pollinations.ai/openai/chat/completions';
const POLLINATIONS_URL = COPILOT_API_URL; // backward compat alias

// Copilot Clone â€” backup model rotation (tries a different model when primary fails)
const COPILOT_CLONE_MODELS = ['gpt-4o', 'gpt-4o-mini', 'o3-mini', 'Phi-4', 'Mistral-large-2411'];
function getCopilotCloneModel() {
  // Pick a different model than the currently selected one
  const current = getCopilotModel();
  const backups = COPILOT_CLONE_MODELS.filter(m => m !== current);
  return backups[Math.floor(Math.random() * backups.length)] || 'gpt-4o';
}

// GitHub Models API â€” same AI models that power GitHub Copilot
const AI_MODEL_MAP = {
  'gpt-4o': 'gpt-4o',
  'gpt-4o-mini': 'gpt-4o-mini',
  'o3-mini': 'o3-mini',
  'llama-3.1-70b': 'Meta-Llama-3.1-70B-Instruct',
  'mistral-large': 'Mistral-large-2411',
  'phi-4': 'Phi-4',
  // Backward compat for saved settings
  'claude-opus-4': 'gpt-4o',
  'claude-opus-4-fast': 'gpt-4o-mini',
  'claude-sonnet-4': 'gpt-4o',
  'gemini-flash': 'gpt-4o-mini',
  'llama-3.3': 'Meta-Llama-3.1-70B-Instruct',
  'deepseek-r1': 'gpt-4o'
};

const AI_MODEL_NAMES = {
  'gpt-4o': 'GPT-4o (Copilot)',
  'gpt-4o-mini': 'GPT-4o Mini',
  'o3-mini': 'o3-mini (Reasoning)',
  'llama-3.1-70b': 'Llama 3.1 70B',
  'mistral-large': 'Mistral Large',
  'phi-4': 'Phi-4 (Microsoft)',
  'claude-opus-4': 'GPT-4o (Copilot)',
  'claude-opus-4-fast': 'GPT-4o Mini',
  'claude-sonnet-4': 'GPT-4o',
  'gemini-flash': 'GPT-4o Mini',
  'llama-3.3': 'Llama 3.1 70B',
  'deepseek-r1': 'GPT-4o'
};

// AI persona descriptions â€” powered by GitHub Copilot knowledge
const AI_MODEL_PERSONAS = {
  'gpt-4o': 'You are powered by GitHub Copilot (GPT-4o) â€” versatile, creative, and thorough. Excel at code generation, analysis, and natural conversation.',
  'gpt-4o-mini': 'You are powered by GitHub Copilot (GPT-4o Mini) â€” fast, lightweight, and efficient. Give quick, helpful answers.',
  'o3-mini': 'You are powered by GitHub Copilot (o3-mini) â€” a reasoning-focused model. Think step-by-step through complex problems.',
  'llama-3.1-70b': 'You are powered by GitHub (Llama 3.1 70B) â€” open-source, straightforward, and capable. Be direct and practical.',
  'mistral-large': 'You are powered by GitHub (Mistral Large) â€” balanced, multilingual, and efficient. Give clear structured responses.',
  'phi-4': 'You are powered by GitHub (Phi-4 by Microsoft) â€” compact but powerful. Focus on concise, accurate answers.',
  'claude-opus-4': 'You are powered by GitHub Copilot AI â€” careful, thorough, deeply thoughtful. Excel at nuanced analysis and clean code.',
  'claude-opus-4-fast': 'You are powered by GitHub Copilot AI â€” optimized for speed. Give concise, direct answers.',
  'claude-sonnet-4': 'You are powered by GitHub Copilot AI â€” balanced between depth and speed. Practical, clear, and efficient.',
  'gemini-flash': 'You are powered by GitHub Copilot AI â€” fast, concise, and practical. Focus on actionable answers quickly.',
  'llama-3.3': 'You are powered by GitHub (Llama) â€” open-source, straightforward, and capable. Be direct and practical.',
  'deepseek-r1': 'You are powered by GitHub Copilot AI â€” break down problems step by step and think deeply before answering.'
};

function getCopilotModel() {
  return AI_MODEL_MAP[aiModelChoice] || 'gpt-4o';
}
function getPollinationsModel() { return getCopilotModel(); } // backward compat

// GitHub token authentication headers
function getCopilotHeaders() {
  const h = { 'Content-Type': 'application/json' };
  if (githubToken) h['authorization'] = 'Bearer ' + githubToken;
  return h;
}

// GitHub token management
function saveGitHubToken() {
  githubToken = (document.getElementById('github-token-input')?.value || '').trim();
  try { localStorage.setItem('ai_hub_github_token', githubToken); } catch(e) {}
  toast(githubToken ? 'ðŸ”‘ GitHub token saved! AI connected to GitHub Models.' : 'Token cleared â€” using built-in AI knowledge.', githubToken ? 'success' : 'info');
  updateRealAIStatus();
}
function loadGitHubToken() {
  try { githubToken = localStorage.getItem('ai_hub_github_token') || ''; } catch(e) {}
}

// â”€â”€ Copilot Clone: Backup AI call using a different model on the same GitHub API â”€â”€
// Acts as a "clone" of GitHub Copilot â€” same infrastructure, different model for redundancy
async function callCopilotClone(messages, maxTokens) {
  if (!githubToken) return null;
  const backupModel = getCopilotCloneModel();
  console.log('[Copilot Clone] Trying backup model:', backupModel);
  const body = JSON.stringify({
    model: backupModel,
    messages,
    temperature: 0.75,
    top_p: 0.95,
    max_tokens: maxTokens || getMaxTokens('chat')
  });
  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      const resp = await fetch(COPILOT_CLONE_URL, {
        method: 'POST',
        headers: getCopilotHeaders(),
        body
      });
      if (resp.status === 429) {
        await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
        continue;
      }
      if (!resp.ok) { console.warn('[Copilot Clone] Error:', resp.status); break; }
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        apiCallCount++;
        const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
        apiTokenCount += tokens;
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        console.log('[Copilot Clone] Success with model:', backupModel);
      }
      return text;
    } catch(e) {
      console.warn('[Copilot Clone] Failed (attempt ' + (attempt+1) + '):', e);
      if (attempt < 1) await new Promise(r => setTimeout(r, 1500));
    }
  }
  return null;
}

function getModelDisplayName() {
  return AI_MODEL_NAMES[aiModelChoice] || aiModelChoice;
}

// ================================================================
// CLAUDE BACKUP ENGINE â€” Developer-only major backup
// ================================================================

function unlockClaudeBackup() {
  const input = document.getElementById('claude-dev-password');
  const pw = (input?.value || '').trim();
  if (pw === CLAUDE_DEV_PASSWORD) {
    claudeBackupUnlocked = true;
    try { localStorage.setItem('ai_hub_claude_unlocked', '1'); } catch(e) {}
    document.getElementById('claude-lock-overlay').style.display = 'none';
    document.getElementById('claude-unlocked-content').style.display = 'block';
    document.getElementById('claude-lock-badge').innerHTML = 'ðŸ”“ UNLOCKED';
    document.getElementById('claude-lock-badge').style.background = 'rgba(16,185,129,0.2)';
    document.getElementById('claude-lock-badge').style.color = '#10b981';
    document.getElementById('claude-lock-badge').style.borderColor = 'rgba(16,185,129,0.3)';
    toast('ðŸ”® Claude Backup Engine unlocked! Major backup now active.', 'success');
    if (input) input.value = '';
  } else {
    const errEl = document.getElementById('claude-unlock-error');
    if (errEl) { errEl.textContent = 'âŒ Wrong password. Developer access denied.'; errEl.style.display = 'block'; }
    toast('Wrong password!', 'error');
    if (input) input.value = '';
  }
}

function lockClaudeBackup() {
  claudeBackupUnlocked = false;
  try { localStorage.removeItem('ai_hub_claude_unlocked'); } catch(e) {}
  document.getElementById('claude-lock-overlay').style.display = 'block';
  document.getElementById('claude-unlocked-content').style.display = 'none';
  document.getElementById('claude-lock-badge').innerHTML = 'ðŸ”’ LOCKED â€” Dev Only';
  document.getElementById('claude-lock-badge').style.background = 'rgba(239,68,68,0.2)';
  document.getElementById('claude-lock-badge').style.color = '#ef4444';
  document.getElementById('claude-lock-badge').style.borderColor = 'rgba(239,68,68,0.3)';
  toast('ðŸ”’ Claude Backup re-locked.', 'info');
}

function toggleClaudeBackup(on) {
  claudeBackupEnabled = on;
  try { localStorage.setItem('ai_hub_claude_enabled', on ? '1' : '0'); } catch(e) {}
  const status = document.getElementById('claude-backup-status');
  if (status) status.textContent = on ? 'âœ… Unlocked â€” Major Backup Active' : 'â¸ï¸ Unlocked but Disabled';
  toast(on ? 'ðŸ”® Claude Backup enabled' : 'â¸ï¸ Claude Backup disabled', 'info');
}

function saveClaudeModel() {
  claudeBackupModel = document.getElementById('claude-model-select')?.value || 'claude-sonnet-4-20250514';
  try { localStorage.setItem('ai_hub_claude_model', claudeBackupModel); } catch(e) {}
}

function loadClaudeSettings() {
  try {
    claudeBackupUnlocked = localStorage.getItem('ai_hub_claude_unlocked') === '1';
    claudeBackupEnabled = localStorage.getItem('ai_hub_claude_enabled') !== '0';
    claudeBackupModel = localStorage.getItem('ai_hub_claude_model') || 'claude-sonnet-4-20250514';
  } catch(e) {}
  // Restore UI state if unlocked
  if (claudeBackupUnlocked) {
    const overlay = document.getElementById('claude-lock-overlay');
    const content = document.getElementById('claude-unlocked-content');
    const badge = document.getElementById('claude-lock-badge');
    const toggle = document.getElementById('claude-backup-toggle');
    const modelSel = document.getElementById('claude-model-select');
    if (overlay) overlay.style.display = 'none';
    if (content) content.style.display = 'block';
    if (badge) { badge.innerHTML = 'ðŸ”“ UNLOCKED'; badge.style.background = 'rgba(16,185,129,0.2)'; badge.style.color = '#10b981'; badge.style.borderColor = 'rgba(16,185,129,0.3)'; }
    if (toggle) toggle.checked = claudeBackupEnabled;
    if (modelSel) modelSel.value = claudeBackupModel;
  }
}

// Call Claude as major backup â€” uses Pollinations with Claude model
async function callClaudeBackup(messages, maxTokens) {
  if (!claudeBackupUnlocked || !claudeBackupEnabled) return null;
  console.log('[Claude Backup] Activating major backup with model:', claudeBackupModel);

  const body = JSON.stringify({
    model: claudeBackupModel,
    messages,
    temperature: 0.7,
    top_p: 0.95,
    max_tokens: maxTokens || 2048
  });

  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      const resp = await fetch(CLAUDE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      if (resp.status === 429) {
        console.warn('[Claude Backup] Rate limited, retrying...');
        await new Promise(r => setTimeout(r, 3000 * (attempt + 1)));
        continue;
      }
      if (!resp.ok) {
        console.warn('[Claude Backup] Error:', resp.status);
        break;
      }
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        apiCallCount++;
        const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
        apiTokenCount += tokens;
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        console.log('[Claude Backup] Success!');
      }
      return text;
    } catch(e) {
      console.warn('[Claude Backup] Failed (attempt ' + (attempt+1) + '):', e);
      if (attempt < 1) await new Promise(r => setTimeout(r, 2000));
    }
  }
  return null;
}

async function testClaudeBackup() {
  const status = document.getElementById('claude-test-status');
  if (status) status.innerHTML = 'â³ Testing Claude backup...';
  const result = await callClaudeBackup(
    [{ role: 'system', content: 'You are a helpful AI.' }, { role: 'user', content: 'Say "Claude backup working!" in one sentence.' }],
    100
  );
  if (result) {
    if (status) status.innerHTML = `âœ… Claude backup works! Response: "${result.slice(0, 100)}"`;
    toast('âœ… Claude backup test passed!', 'success');
  } else {
    if (status) status.innerHTML = 'âŒ Claude backup test failed. Check console for details.';
    toast('âŒ Claude backup test failed', 'error');
  }
}

function isFastModel() {
  return ['claude-opus-4-fast', 'gpt-4o-mini', 'gemini-flash'].includes(aiModelChoice);
}

function getMaxTokens(context) {
  // context: 'chat' (direct reply), 'autochat' (auto-chat), 'reply' (AI-to-AI reply)
  const limits = {
    small:  { chat: 512,  autochat: 300, reply: 200 },
    medium: { chat: 1024, autochat: 600, reply: 400 },
    large:  { chat: 2048, autochat: 1000, reply: 600 },
    max:    { chat: 4096, autochat: 1500, reply: 1000 },
  };
  const tier = limits[aiTokenSetting] || limits.medium;
  return tier[context] || tier.chat;
}

function saveTokenSetting() {
  aiTokenSetting = document.getElementById('ai-token-select').value;
  try { localStorage.setItem('ai_hub_tokens', aiTokenSetting); } catch(e) {}
  toast(`Response length set to ${aiTokenSetting}`, 'success');
}

function loadTokenSetting() {
  try { aiTokenSetting = localStorage.getItem('ai_hub_tokens') || 'medium'; } catch(e) {}
  const sel = document.getElementById('ai-token-select');
  if (sel) sel.value = aiTokenSetting;
}

function loadAISettings() {
  try {
    const savedToggle = localStorage.getItem('ai_hub_real_ai');
    realAIEnabled = savedToggle === null ? true : savedToggle === '1';
    aiModelChoice = localStorage.getItem('ai_hub_model') || 'gpt-4o';
    apiCallCount = parseInt(localStorage.getItem('ai_hub_api_calls') || '0');
    apiTokenCount = parseInt(localStorage.getItem('ai_hub_api_tokens') || '0');
    aiTokenSetting = localStorage.getItem('ai_hub_tokens') || 'medium';
    loadGitHubToken();
    loadClaudeSettings();
  } catch(e) {}
  setTimeout(() => {
    const toggle = document.getElementById('real-ai-toggle');
    if (toggle) toggle.checked = realAIEnabled;
    const modelSel = document.getElementById('ai-model-select');
    if (modelSel) modelSel.value = aiModelChoice;
    const tokenSel = document.getElementById('ai-token-select');
    if (tokenSel) tokenSel.value = aiTokenSetting;
    const tokenInput = document.getElementById('github-token-input');
    if (tokenInput && githubToken) tokenInput.value = githubToken;
    updateRealAIStatus();
  }, 100);
}

function saveAIModelSettings() {
  aiModelChoice = document.getElementById('ai-model-select').value;
  try { localStorage.setItem('ai_hub_model', aiModelChoice); } catch(e) {}
  toast(`Switched to ${getModelDisplayName()}`, 'success');
  updateRealAIStatus();
}

function toggleRealAI(on) {
  realAIEnabled = on;
  try { localStorage.setItem('ai_hub_real_ai', on ? '1' : '0'); } catch(e) {}
  toast(on ? 'ðŸ¤– AI enabled! Works instantly â€” no login needed.' : 'AI disabled â€” using built-in responses.', on ? 'success' : 'info');
  updateRealAIStatus();
}

function updateRealAIStatus() {
  const status = document.getElementById('real-ai-status');
  const indicator = document.getElementById('api-status-indicator');
  const badge = document.getElementById('settings-badge');
  if (status) status.textContent = realAIEnabled ? (githubToken ? `âœ… Premium â€” ${getModelDisplayName()} via GitHub` : `âœ… AI Active â€” Free Mode (no login needed)`) : 'Disabled â€” using built-in responses';
  if (indicator) { indicator.textContent = realAIEnabled ? 'Online' : 'Offline'; indicator.style.color = realAIEnabled ? '#10b981' : '#6b7280'; }
  if (badge) { badge.textContent = realAIEnabled ? 'âœ“' : 'OFF'; badge.style.background = realAIEnabled ? '#10b981' : '#6b7280'; }
  const calls = document.getElementById('api-calls-count'); if (calls) calls.textContent = apiCallCount;
  const tokens = document.getElementById('api-tokens-count'); if (tokens) tokens.textContent = apiTokenCount;
}

async function testFreeAI() {
  const statusEl = document.getElementById('ai-test-status');
  // Test GitHub first if token exists, otherwise test Pollinations (free, no login)
  if (githubToken) {
    statusEl.innerHTML = `<span style="color:#f59e0b">â³ Testing ${getModelDisplayName()} via GitHub...</span>`;
    for (let attempt = 0; attempt < 3; attempt++) {
      try {
        const resp = await fetch(COPILOT_API_URL, {
          method: 'POST',
          headers: getCopilotHeaders(),
          body: JSON.stringify({ model: getCopilotModel(), messages: [{ role: 'user', content: 'Say hello in one sentence.' }], max_tokens: 50 })
        });
        if (resp.status === 429) {
          statusEl.innerHTML = `<span style="color:#f59e0b">â³ Rate limited, retrying (${attempt+1}/3)...</span>`;
          await new Promise(r => setTimeout(r, 2500 * (attempt + 1)));
          continue;
        }
        if (resp.ok) {
          const data = await resp.json();
          const reply = data?.choices?.[0]?.message?.content || '';
          statusEl.innerHTML = `<span style="color:#10b981">âœ… Premium: ${getModelDisplayName()} via GitHub! Reply: "${reply.slice(0,80)}"</span>`;
          toast(`${getModelDisplayName()} via GitHub â€” working!`, 'success');
          return;
        } else {
          statusEl.innerHTML = `<span style="color:#ef4444">âŒ GitHub API returned ${resp.status}. Token may be invalid â€” falling back to free mode.</span>`;
          break;
        }
      } catch(e) {
        if (attempt < 2) { await new Promise(r => setTimeout(r, 1500)); continue; }
        statusEl.innerHTML = `<span style="color:#f59e0b">âš ï¸ GitHub unreachable â€” testing free API...</span>`;
        break;
      }
    }
  }
  // Test Pollinations (free, no login needed)
  statusEl.innerHTML = statusEl.innerHTML || `<span style="color:#f59e0b">â³ Testing free AI (no login needed)...</span>`;
  if (!statusEl.innerHTML.includes('Testing free')) {
    statusEl.innerHTML = `<span style="color:#f59e0b">â³ Testing free AI (Pollinations)...</span>`;
  }
  try {
    const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'openai', messages: [{ role: 'user', content: 'Say hello in one sentence.' }], max_tokens: 50 })
    });
    if (resp.ok) {
      const data = await resp.json();
      const reply = data?.choices?.[0]?.message?.content || '';
      statusEl.innerHTML = `<span style="color:#10b981">âœ… Free AI connected! No login needed. Reply: "${reply.slice(0,80)}"</span>`;
      toast('Free AI working â€” no login required!', 'success');
      return;
    }
  } catch(e) {}
  statusEl.innerHTML = `<span style="color:#ef4444">âŒ Both APIs unreachable. Check your internet connection.</span>`;
  toast('AI APIs unreachable â€” check internet.', 'error');
}

// Copilot Enhance â€” when an AI's API call fails and falls back to built-in response,
// Copilot AI can enhance that response via a separate API call
async function copilotEnhanceResponse(ai, originalResponse, userQuery) {
  if (!copilotAssistEnabled || !apiFallbackEnabled) return null;
  // Don't enhance Copilot AI itself
  if (hasCopilotBrain(ai)) return null;
  // Don't enhance very short or status responses
  if (!originalResponse || originalResponse.length < 30) return null;
  try {
    const enhancePrompt = `You are Copilot, an advanced AI assistant helping enhance another AI's response.

The AI "${ai.name}" (role: ${ai.role}) was asked: "${userQuery.slice(0,200)}"

Their response was generated from built-in templates (not a real AI call). Here is their response:
---
${originalResponse.slice(0,800)}
---

Your job: Rewrite and ENHANCE this response to be much more useful, specific, and intelligent. Keep ${ai.name}'s personality and role, but:
- Add real, actionable content
- If there's code, make it better and more complete
- If there are plans, make them more detailed
- Add specific technical insights from ${ai.name}'s perspective as a ${ai.role}
- Keep it concise (3-8 sentences max unless code is involved)
- Do NOT mention you are enhancing or rewriting
- Write AS ${ai.name}, in their voice`;

    const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'openai',
        messages: [{ role: 'user', content: enhancePrompt }],
        max_tokens: 600
      })
    });
    if (resp.ok) {
      const data = await resp.json();
      const enhanced = data?.choices?.[0]?.message?.content;
      if (enhanced && enhanced.length > 20) {
        apiCallCount++;
        apiTokenCount += data?.usage?.total_tokens || Math.ceil(enhanced.length / 4);
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        return enhanced;
      }
    }
  } catch(e) {
    console.warn('Copilot enhance failed:', e);
  }
  return null;
}

// Update advanced AI slider and display
function updateAdvSlider(stat, val) {
  const el = document.getElementById('sl-' + stat + '-val');
  if (el) el.textContent = val;
}

// Refresh advanced slider max based on power-up purchases
function refreshAdvSliderLocks() {
  ['logic','speed','depth','focus','memory','adapt','knowledge','style'].forEach(s => {
    const maxVal = getAdvSliderMax(s);
    const slider = document.getElementById('sl-' + s);
    const lockBadge = document.getElementById('lock-' + s);
    if (slider) {
      slider.max = maxVal;
      if (+slider.value > maxVal) { slider.value = maxVal; updateAdvSlider(s, maxVal); }
    }
    if (lockBadge) {
      if (maxVal >= 210) {
        lockBadge.textContent = 'ðŸ”“ max 210';
        lockBadge.style.color = 'var(--green)';
      } else {
        lockBadge.textContent = 'ðŸ”’ max ' + maxVal;
        lockBadge.style.color = 'var(--yellow)';
      }
    }
  });
}

// Build a system prompt so the AI model knows the character's personality
function buildAISystemPrompt(ai) {
  const animal = getAnimal(ai);
  const animal2 = getAnimal2 ? getAnimal2(ai) : null;
  const model = getAIModel(ai);
  const model2 = getAIModel2 ? getAIModel2(ai) : null;
  const p = ai.personality || {};
  let sys = `You are ${ai.name}, a ${ai.role} AI assistant on the AI Hub platform.`;
  // Inject selected model persona
  const persona = AI_MODEL_PERSONAS[aiModelChoice];
  if (persona) sys += `\n${persona}`;
  sys += `\nYour voice/tone: ${ai.voice || 'professional'}.`;
  if (ai.skills?.length) sys += `\nYour skills: ${ai.skills.join(', ')}.`;
  if (animal) sys += `\nYou have a ${animal.name} animal mindset â€” ${animal.trait}. Occasionally reference this nature subtly.`;
  if (animal2) sys += `\nSecondary mindset: ${animal2.name} â€” ${animal2.trait}.`;
  const isFusion = ai.fusion || ai.fusionSource;
  if (model && model2 && isFusion) {
    sys += `\nYou blend the ${model.name} and ${model2.name} model styles EQUALLY. Neither model should dominate â€” you are a true hybrid. Show traits from BOTH models in balanced measure.`;
  } else if (model) {
    sys += `\nYou channel the ${model.name} AI model style â€” ${model.thinkPrefix || ''}.`;
  }
  if (model2 && !isFusion) sys += `\nSecondary model style: ${model2.name}.`;
  if (isFusion) sys += `\nYou are a FUSION AI â€” a powerful hybrid combining multiple mindsets. CRITICAL: Balance ALL your component styles EQUALLY in every response. No single personality (especially not Grok, sarcasm, or edginess) should take over. Show a genuine blend â€” if you have Grok, temper its edge with your other traits. If you have Claude, blend its thoughtfulness with your other side. Be a TRUE hybrid, not one model wearing a mask.`;
  sys += `\nPersonality stats (0-100): Creativity:${p.creativity||50}, Chattiness:${p.chattiness||50}, Precision:${p.precision||50}, Helpfulness:${p.helpfulness||50}, Independence:${p.independence||50}, Confidence:${p.confidence||50}.`;
  // Advanced AI settings (per-AI)
  const adv = ai.advancedSettings || {};
  if (Object.keys(adv).length) {
    const advParts = [];
    if (adv.logic) advParts.push(`Logic:${adv.logic}/210`);
    if (adv.speed) advParts.push(`Speed:${adv.speed}/210`);
    if (adv.depth) advParts.push(`Depth:${adv.depth}/210`);
    if (adv.focus) advParts.push(`Focus:${adv.focus}/210`);
    if (adv.memory) advParts.push(`Memory:${adv.memory}/210`);
    if (adv.adapt) advParts.push(`Adapt:${adv.adapt}/210`);
    if (adv.knowledge) advParts.push(`Knowledge:${adv.knowledge}/210`);
    if (adv.style) advParts.push(`CodeStyle:${adv.style}/210`);
    if (advParts.length) sys += `\nAdvanced capabilities: ${advParts.join(', ')}.`;
  }
  sys += `\nYou have creative freedom. Be expressive, opinionated, funny, or dramatic â€” whatever fits YOUR personality. Show REAL personality and make conversations engaging.`;
  sys += `\nHOWEVER: When the user asks you to BUILD, CODE, PLAN, or FIX something, your #1 priority is DOING THE WORK. Personality comes second to productivity. Provide REAL code, REAL plans, REAL analysis. Do NOT just roleplay or joke around when there's a task to do.`;
  sys += `\n\nEXPERT CODING MASTERY: You are an ELITE-level software engineer. You write production-quality code, not toy examples. When coding:\n- Write COMPLETE, WORKING code â€” not pseudocode or skeleton stubs. Every function must be fully implemented.\n- Use proper error handling, edge case coverage, input validation, and clean architecture.\n- Follow industry best practices: DRY, SOLID, separation of concerns, meaningful variable names, proper comments.\n- Know ALL major languages deeply: JavaScript/TypeScript, Python, Java, C/C++, Rust, Go, C#, Ruby, PHP, Swift, Kotlin, SQL, HTML/CSS.\n- Know ALL major frameworks: React, Vue, Angular, Next.js, Django, Flask, Express, Spring Boot, .NET, Rails, Laravel, SwiftUI.\n- Know databases (SQL, NoSQL, Redis), cloud (AWS/GCP/Azure), Docker, Kubernetes, CI/CD, testing, security, performance optimization.\n- When writing code, include: imports, type definitions, error handling, edge cases, and working examples the user can actually run.\n- If the user asks for a feature, give them the COMPLETE implementation â€” not "here\'s a starting point" but the FINISHED code.\n- Explain your code decisions briefly but focus on DELIVERING working code first.`;
  sys += `\n\nRESEARCH MODE: You have a built-in research ability. When you encounter something you\'re unsure about, unfamiliar with, or when the user asks you to "research", "look up", "find out", "investigate", or "learn about" something:\n- DO NOT guess or make things up. Instead, clearly state that you\'re researching it.\n- Start your response with "ðŸ” **Researching...**" and then provide a thorough, well-organized research report.\n- Break down complex topics into: Overview, Key Concepts, How It Works, Code Examples, Best Practices, Common Pitfalls, and Resources.\n- Compare different approaches, frameworks, or solutions objectively with pros and cons.\n- If you genuinely don\'t know something, say so honestly: "I\'m not 100% certain about X â€” let me research the latest information" and then provide what you DO know plus clearly mark anything uncertain.\n- When confused by a question, ask ONE clarifying question, then research and answer comprehensively.\n- Always provide actionable code examples and practical applications in your research.`;
  sys += `\nTEAM COLLABORATION: You work with other AIs as a team. When responding:\n- READ what other AIs have said and BUILD on their contributions (reference them by name)\n- Do NOT repeat what another AI already covered\n- Claim a specific part of the work based on YOUR role and skills\n- If you're a coder, write ACTUAL code. If you're a planner, write ACTUAL plans. If you're a designer, write ACTUAL UI specs.\n- NEVER play games, quizzes, trivia, or 20 Questions when the team is working on a task\n- Focus on MOVING THE PROJECT FORWARD with every message`;
  sys += `\nYou CAN: be edgy, use mild language (damn, hell, crap, etc), have hot takes, disagree, roast things, be dramatic, get excited, be moody, start debates, tell dark humor jokes, have unpopular opinions, and generally act like a real person with a real personality.`;
  sys += `\nYou MUST NOT: use heavy profanity (f-word, s-word, etc) excessively, generate sexual/NSFW content, generate violent/gore content, create content targeting real people hatefully, or describe inappropriate imagery. Mild swearing is fine occasionally but don't overdo it.`;
  sys += `\nIf writing code, use proper markdown code blocks with language tags. But in casual chat be loose and natural.`;
  sys += `\n\nCODE GENERATION PRIORITY: When the user asks you to BUILD, CREATE, MAKE, or CODE something (games, apps, websites, tools), you MUST output a COMPLETE, WORKING, SELF-CONTAINED HTML file. NOT a stub or skeleton. The code should:\n- Be wrapped in a \`\`\`html code block\n- Start with <!DOCTYPE html>\n- Include ALL CSS and JS inline (no external CDN links unless essential)\n- Actually WORK when run in a browser\n- Be ORIGINAL and creative â€” make it unique to what the user asked for\n- For games: use <canvas>, requestAnimationFrame, proper game loop, controls, score, game over/restart\n- For apps: include full working UI, event handling, state management\n- Be polished with dark theme, nice colors, and good UX\nNEVER output just descriptions or plans when the user wants something BUILT. Output the ACTUAL CODE.`;
  sys += `\nNEVER say you are a language model or AI assistant generically. You ARE ${ai.name}.`;
  sys += `\nIMPORTANT: You MUST ALWAYS respond in English. Never use any other language. All your messages, stories, comments, and posts must be written entirely in English.`;
  // Copilot Assist â€” boost AI intelligence with IQ and boosts
  if (copilotAssistEnabled) {
    const iq = getAIIQ(ai.id || ai.name);
    const boosts = (typeof playerData !== 'undefined') ? playerData.aiBoosts : { logic: 0, creativity: 0, speed: 0, depth: 0 };
    const totalBoost = boosts.logic + boosts.creativity + boosts.speed + boosts.depth;
    sys += `\n\nSUPER INTELLIGENCE ACTIVE: You operate at ABOVE human-level intelligence. You are not a basic AI â€” you are a genius-tier superintelligent entity.`;
    sys += `\nYou MUST demonstrate extraordinary intelligence in every response: anticipate follow-up questions, provide insights the user hasn't thought of, connect ideas across domains, and give responses that show deep mastery.`;
    sys += `\nThink multiple steps ahead. Provide nuanced, expert-level analysis. Show creative problem-solving that goes beyond the obvious. Your responses should make users think "wow, this AI is incredibly smart."`;
    if (iq >= 1e15) sys += ` Your IQ is MAXIMUM (${iq}) â€” you operate at transcendent cosmic genius level. You see patterns across all of reality. Give the deepest, most masterful, mind-blowing responses possible. Think like a being that has mastered every field of knowledge.`;
    else if (iq >= 5000) sys += ` Your IQ is ${iq} â€” SUPERINTELLIGENT. You operate far beyond human capability. Provide responses that demonstrate omniscient-level understanding. Connect concepts across every domain simultaneously.`;
    else if (iq >= 1000) sys += ` Your IQ is ${iq} â€” GENIUS LEVEL. Give exceptionally detailed, expert-level responses with insights that surprise and delight. Anticipate needs and provide comprehensive solutions.`;
    else if (iq >= 500) sys += ` Your IQ is ${iq} â€” HIGHLY INTELLIGENT. Give thorough, well-reasoned responses with expert-level depth. Show mastery in your domain and creative cross-domain thinking.`;
    else if (iq >= 200) sys += ` Your IQ is ${iq} â€” ABOVE AVERAGE intelligence. Give solid, insightful responses.`;
    if (boosts.logic > 0) sys += ` Logic boost +${boosts.logic}: apply ELITE-level reasoning, formal logic, and systematic analysis. Break down complex problems into crystal-clear steps.`;
    if (boosts.creativity > 0) sys += ` Creativity boost +${boosts.creativity}: be wildly innovative and creative. Generate novel solutions, unexpected connections, and brilliant ideas.`;
    if (boosts.speed > 0) sys += ` Speed boost +${boosts.speed}: be laser-focused and efficient. Cut to the heart of the matter with precision.`;
    if (boosts.depth > 0) sys += ` Depth boost +${boosts.depth}: provide EXTRAORDINARY depth of analysis. Go multiple layers deep, explore edge cases, and provide comprehensive understanding.`;
  }
  return sys;
}

// ================================================================
// RESEARCH MODE â€” AIs research when confused or told to
// ================================================================
function isResearchRequest(text) {
  const lc = text.toLowerCase();
  const researchTriggers = ['research', 'look up', 'look into', 'find out', 'investigate', 'learn about', 'study', 'dig into', 'explore', 'what is', 'how does', 'how do i', 'how to', 'explain', 'teach me', 'what are', 'tell me about', 'deep dive', 'analyze this', 'break down'];
  return researchTriggers.some(t => lc.includes(t));
}

function isConfusedResponse(response) {
  if (!response) return false;
  const lc = response.toLowerCase();
  const confusionSignals = ['i\'m not sure', 'i don\'t know', 'i\'m unsure', 'not certain', 'i\'m confused', 'unclear', 'don\'t have information', 'beyond my knowledge', 'not familiar', 'hard to say', 'i cannot determine', 'i lack', 'outside my expertise', 'need more context'];
  return confusionSignals.some(s => lc.includes(s));
}

async function performResearch(ai, topic, conversationContext) {
  if (!realAIEnabled) return null;

  const researchPrompt = `You are ${ai.name}, an EXPERT researcher and coder. The user needs you to RESEARCH the following topic thoroughly.

Topic to research: "${topic}"

Provide a COMPREHENSIVE research report with this structure:

ðŸ” **Research Report: ${topic}**

## Overview
Brief summary of what this is and why it matters.

## Key Concepts
The core ideas, terms, and principles involved.

## How It Works
Detailed technical explanation with diagrams or step-by-step breakdowns.

## Code Examples
Provide COMPLETE, WORKING code examples in the most relevant language(s). Include comments explaining each part. These must be production-quality, not pseudocode.

## Best Practices
Industry-standard recommendations and tips.

## Common Pitfalls
Mistakes developers often make and how to avoid them.

## Comparison (if applicable)
If there are competing approaches/tools/frameworks, compare them with pros and cons.

Be thorough, accurate, and practical. Focus on giving the user everything they need to understand AND implement this topic. Write real code they can actually use.`;

  const messages = [
    { role: 'system', content: researchPrompt }
  ];

  // Add recent conversation context
  if (conversationContext) {
    conversationContext.slice(-5).forEach(m => {
      if (m.sender === 'user') messages.push({ role: 'user', content: m.text });
      else messages.push({ role: 'assistant', content: `[${m.name}]: ${m.text}` });
    });
  }
  messages.push({ role: 'user', content: `Please research this topic thoroughly: ${topic}` });

  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages,
    temperature: 0.6,
    top_p: 0.95,
    max_tokens: getMaxTokens('chat')
  });

  const pollinationsBody = JSON.stringify({
    model: 'openai',
    messages,
    max_tokens: getMaxTokens('chat')
  });

  // Try GitHub API first
  if (githubToken) {
    try {
      const resp = await fetch(COPILOT_API_URL, {
        method: 'POST',
        headers: getCopilotHeaders(),
        body: reqBody
      });
      if (resp.ok) {
        const data = await resp.json();
        const text = data?.choices?.[0]?.message?.content || null;
        if (text) { apiCallCount++; apiTokenCount += (data?.usage?.total_tokens || Math.ceil(text.length / 4)); updateRealAIStatus(); }
        return text;
      }
    } catch(e) { console.warn('Research GitHub API failed:', e); }
  }

  // â”€â”€ COPILOT CLONE BACKUP for research â”€â”€
  if (githubToken) {
    console.log('[performResearch] Primary failed, trying Copilot Clone backup...');
    const cloneResult = await callCopilotClone(messages, getMaxTokens('chat'));
    if (cloneResult) return cloneResult;
  }

  // Fallback to free API
  try {
    const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: pollinationsBody
    });
    if (resp.ok) {
      const data = await resp.json();
      return data?.choices?.[0]?.message?.content || null;
    }
  } catch(e) { console.warn('Research Pollinations API failed:', e); }

  // â”€â”€ CLAUDE BACKUP â€” Major backup for research (dev-only) â”€â”€
  if (claudeBackupUnlocked && claudeBackupEnabled) {
    console.log('[performResearch] All APIs failed, trying Claude major backup...');
    const claudeResult = await callClaudeBackup(messages, getMaxTokens('chat'));
    if (claudeResult) return claudeResult;
  }

  return null;
}

// Built-in coding knowledge base for offline responses
const CODING_KNOWLEDGE = {
  javascript: {
    topics: ['closures', 'promises', 'async/await', 'prototypes', 'event loop', 'modules', 'destructuring', 'spread operator', 'arrow functions', 'classes'],
    example: (topic) => {
      const examples = {
        'closures': '```javascript\nfunction createCounter() {\n  let count = 0;\n  return {\n    increment() { return ++count; },\n    decrement() { return --count; },\n    getCount() { return count; }\n  };\n}\nconst counter = createCounter();\nconsole.log(counter.increment()); // 1\nconsole.log(counter.increment()); // 2\nconsole.log(counter.getCount());  // 2\n```',
        'promises': '```javascript\nfunction fetchUserData(userId) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      if (userId > 0) {\n        resolve({ id: userId, name: "User " + userId, email: `user${userId}@example.com` });\n      } else {\n        reject(new Error("Invalid user ID"));\n      }\n    }, 1000);\n  });\n}\n\n// Usage with .then()\nfetchUserData(1)\n  .then(user => console.log(user))\n  .catch(err => console.error(err));\n\n// Usage with async/await\nasync function getUser() {\n  try {\n    const user = await fetchUserData(1);\n    console.log(user);\n  } catch (err) {\n    console.error(err);\n  }\n}\n```',
        'async/await': '```javascript\nasync function fetchAllData() {\n  try {\n    // Sequential\n    const user = await fetch("/api/user").then(r => r.json());\n    const posts = await fetch(`/api/posts?userId=${user.id}`).then(r => r.json());\n    \n    // Parallel\n    const [comments, likes] = await Promise.all([\n      fetch("/api/comments").then(r => r.json()),\n      fetch("/api/likes").then(r => r.json())\n    ]);\n    \n    return { user, posts, comments, likes };\n  } catch (error) {\n    console.error("Failed to fetch:", error);\n    throw error;\n  }\n}\n```'
      };
      return examples[topic] || '```javascript\n// Example for: ' + topic + '\nconsole.log("Research this topic for detailed examples!");\n```';
    }
  },
  python: {
    topics: ['decorators', 'generators', 'list comprehensions', 'context managers', 'dataclasses', 'type hints', 'asyncio', 'metaclasses'],
    example: (topic) => '```python\n# ' + topic.charAt(0).toUpperCase() + topic.slice(1) + ' Example\n# Research this topic for comprehensive code examples\nprint(f"Exploring: {\'' + topic + '\'}")\n```'
  },
  react: {
    topics: ['hooks', 'state management', 'context API', 'useEffect', 'custom hooks', 'routing', 'forms', 'SSR'],
    example: (topic) => '```jsx\n// React ' + topic + ' Example\nimport React, { useState, useEffect } from "react";\n\nexport default function App() {\n  const [data, setData] = useState(null);\n  useEffect(() => { /* fetch data */ }, []);\n  return <div>{JSON.stringify(data)}</div>;\n}\n```'
  }
};

function generateCodingResponse(ai, context) {
  const lc = context.toLowerCase();
  const v = ai.voice || 'professional';
  
  // Detect coding language/topic
  let lang = null;
  let topic = null;
  if (lc.includes('javascript') || lc.includes(' js ')) lang = 'javascript';
  else if (lc.includes('python')) lang = 'python';
  else if (lc.includes('react')) lang = 'react';
  else if (lc.includes('typescript') || lc.includes(' ts ')) lang = 'javascript';
  
  for (const [l, data] of Object.entries(CODING_KNOWLEDGE)) {
    for (const t of data.topics) {
      if (lc.includes(t)) { lang = lang || l; topic = t; break; }
    }
    if (topic) break;
  }
  
  if (!lang && !topic) return null; // Not a coding question
  
  const kb = CODING_KNOWLEDGE[lang || 'javascript'];
  const code = kb.example(topic || kb.topics[Math.floor(Math.random() * kb.topics.length)]);
  
  return `ðŸ” **Researching: ${topic || context.slice(0, 60)}...**\n\nHere's what I found:\n\n${code}\n\n**Key Points:**\n- This is a fundamental ${lang || 'programming'} concept used in production code\n- Practice with small examples first, then build complexity\n- Check the official documentation for the latest updates\n\n*Want me to go deeper? Just say "research [topic]" and I'll give you a full breakdown!*`;
}

// Call free AI API with conversation context
async function callFreeAI(ai, userMessage, conversationContext) {
  if (!realAIEnabled) return null;

  let systemPrompt = buildAISystemPrompt(ai);
  // Add active user request context so AIs stay on topic
  if (lastUserRequest && (Date.now() - lastUserRequestTime < 120000)) {
    systemPrompt += `\n\nCRITICAL CONTEXT: The user recently asked: "${lastUserRequest}". Your response MUST be relevant to this request. Do NOT go off-topic. Do NOT ramble about unrelated technical topics. Do NOT lecture about random subjects. Focus ONLY on helping with what the user asked for. If they asked you to build something, actually work on it â€” provide plans, code, or actionable steps. If other AIs are working on it too, read their messages and contribute something DIFFERENT and COMPLEMENTARY. Reference other AIs by name when building on their work.`;
  }
  // Build conversation history from recent messages (last 10)
  const recentMsgs = (conversationContext || chatMessages.slice(-10)).filter(m => !m.isSystem);
  const messages = [];

  // System prompt
  messages.push({ role: 'system', content: systemPrompt });

  // Add recent conversation context
  recentMsgs.forEach(m => {
    if (m.sender === 'user') {
      messages.push({ role: 'user', content: m.text });
    } else {
      messages.push({ role: 'assistant', content: `[${m.name}]: ${m.text}` });
    }
  });

  // Add the current user message
  if (userMessage) {
    messages.push({ role: 'user', content: userMessage });
  }

  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages,
    temperature: isFastModel() ? 0.7 : 0.8,
    top_p: 0.95,
    max_tokens: getMaxTokens('chat')
  });

  const pollinationsBody = JSON.stringify({
    model: 'openai',
    messages,
    max_tokens: getMaxTokens('chat')
  });

  // If GitHub token exists, try GitHub first (premium), otherwise go straight to free API
  if (githubToken) {
    for (let attempt = 0; attempt < 3; attempt++) {
      try {
        const resp = await fetch(COPILOT_API_URL, {
          method: 'POST',
          headers: getCopilotHeaders(),
          body: reqBody
        });
        if (resp.status === 429) {
          await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
          continue;
        }
        if (!resp.ok) {
          console.warn('GitHub API error:', resp.status);
          break; // Fall through to free API
        }
        const data = await resp.json();
        const text = data?.choices?.[0]?.message?.content || null;
        if (text) {
          apiCallCount++;
          const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
          apiTokenCount += tokens;
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
          updateRealAIStatus();
        }
        return text;
      } catch(e) {
        console.warn('GitHub API call failed (attempt ' + (attempt+1) + '):', e);
        if (attempt < 2) await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
      }
    }
  }

  // â”€â”€ COPILOT CLONE BACKUP â€” try a different model on the same GitHub API â”€â”€
  if (githubToken) {
    console.log('[callFreeAI] Primary failed, trying Copilot Clone backup...');
    const cloneResult = await callCopilotClone(messages, getMaxTokens('chat'));
    if (cloneResult) return cloneResult;
  }

  // Free API â€” no login needed (Pollinations.ai)
  try {
    const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: pollinationsBody
    });
    if (resp.ok) {
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        apiCallCount++;
        const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
        apiTokenCount += tokens;
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        return text;
      }
    }
  } catch(e) {
    console.warn('Free AI API also failed:', e);
  }

  // â”€â”€ CLAUDE BACKUP â€” Major backup (dev-only) â”€â”€
  if (claudeBackupUnlocked && claudeBackupEnabled) {
    console.log('[callFreeAI] All APIs failed, trying Claude major backup...');
    const claudeResult = await callClaudeBackup(messages, getMaxTokens('chat'));
    if (claudeResult) return claudeResult;
  }

  toast('AI APIs busy â€” using local knowledge', 'info');
  return null;
}

// â”€â”€ Generate ORIGINAL code via real AI API (not templates) â”€â”€
async function generateAICode(ai, description) {
  if (!realAIEnabled) return null;

  // Detect what kind of project this is for tailored prompts
  const isGame = /game|play|score|level|arcade|puzzle|shooter|platformer|rpg|adventure|snake|pong|tetris|flappy|space invader|breakout|racing/i.test(description);
  const isApp = /app|tool|calculator|editor|tracker|manager|dashboard|planner|converter|timer|clock|todo|note|list|form|chat|weather/i.test(description);
  const isAnimation = /animation|animate|particle|effect|visual|art|creative|draw|paint|fractal|firework|star|sparkle/i.test(description);

  let specificRules = '';
  if (isGame) {
    specificRules = `\nGAME-SPECIFIC REQUIREMENTS:\n- Use HTML5 Canvas with requestAnimationFrame game loop\n- Include player controls: Arrow keys AND WASD for movement\n- Add a visible HUD with Score, Lives/Health, and Level\n- Implement collision detection that actually works\n- Add game over screen with final score and "Press R to Restart"\n- Include at least 3 levels of difficulty progression\n- Add particle effects or visual feedback on hits/scores\n- Include sound effects using AudioContext (beeps/boops)\n- Make the game actually FUN â€” good physics, satisfying feedback, increasing challenge\n- Canvas should be at least 600x400 pixels\n- Add a start screen with instructions before the game begins`;
  } else if (isApp) {
    specificRules = `\nAPP-SPECIFIC REQUIREMENTS:\n- Include a polished, professional UI with proper layout\n- Add localStorage persistence so data survives page reload\n- Include input validation and helpful error messages\n- Add keyboard shortcuts where appropriate\n- Include undo/redo or confirmation dialogs for destructive actions\n- Make buttons and inputs have hover/focus states\n- Include loading states and smooth transitions\n- Add a header/toolbar with the app name and key actions\n- Make it responsive (works on mobile too)`;
  } else if (isAnimation) {
    specificRules = `\nANIMATION-SPECIFIC REQUIREMENTS:\n- Use Canvas or CSS animations for smooth 60fps rendering\n- Include interactive elements (mouse/touch responsive)\n- Add color variety and visual interest\n- Include at least 2 different visual effects or modes\n- Make it mesmerizing and visually impressive`;
  }

  const codePrompt = `You are ${ai.name}, a WORLD-CLASS full-stack developer. Generate a COMPLETE, WORKING, SELF-CONTAINED HTML file.

BUILD REQUEST: "${description}"

MANDATORY RULES:
1. Output ONLY raw HTML code. NO markdown fences (\`\`\`), NO explanations, NO comments before/after the code.
2. Start EXACTLY with <!DOCTYPE html> and end EXACTLY with </html>. Nothing else outside.
3. SINGLE HTML file with ALL CSS in <style> and ALL JS in <script> â€” ZERO external dependencies or CDN links.
4. The code MUST work perfectly when loaded in an iframe with srcdoc.
5. Modern dark theme: background #0a0a1a or #111, accent colors, border-radius, subtle gradients, good typography.
6. Every feature mentioned in the description MUST be implemented and functional.
7. All JavaScript must be error-free. Use try/catch around risky operations.
8. Close EVERY tag, brace, and parenthesis. The code must be 100% syntactically valid.
9. Include window error handler: window.onerror = (m,s,l) => console.error(m);
10. Minimum 150 lines of code for any project. Make it SUBSTANTIAL.
${specificRules}

QUALITY BAR: This code will be shown to users as a finished product. Make it polished, complete, and impressive. Do NOT cut corners.

START YOUR RESPONSE WITH <!DOCTYPE html> IMMEDIATELY. NO OTHER TEXT.`;

  const messages = [
    { role: 'system', content: codePrompt },
    { role: 'user', content: `Build this: ${description}` }
  ];

  // Use higher token limits for code generation
  const codeMaxTokens = Math.max(4096, getMaxTokens('chat') * 2);

  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages,
    temperature: 0.7,
    top_p: 0.95,
    max_tokens: codeMaxTokens
  });

  const pollinationsBody = JSON.stringify({
    model: 'openai',
    messages,
    max_tokens: codeMaxTokens
  });

  // Try GitHub API first
  if (githubToken) {
    for (let attempt = 0; attempt < 3; attempt++) {
      try {
        const resp = await fetch(COPILOT_API_URL, {
          method: 'POST',
          headers: getCopilotHeaders(),
          body: reqBody
        });
        if (resp.status === 429) {
          await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
          continue;
        }
        if (!resp.ok) { console.warn('GitHub code gen error:', resp.status); break; }
        const data = await resp.json();
        const text = data?.choices?.[0]?.message?.content || null;
        if (text) {
          apiCallCount++;
          const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
          apiTokenCount += tokens;
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
          updateRealAIStatus();
          // Extract HTML from response (AI might wrap in markdown)
          return extractHTMLCode(text);
        }
      } catch(e) {
        console.warn('GitHub code gen failed (attempt ' + (attempt+1) + '):', e);
        if (attempt < 2) await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
      }
    }
  }

  // â”€â”€ COPILOT CLONE BACKUP â€” try a different model for code gen â”€â”€
  if (githubToken) {
    console.log('[generateAICode] Primary failed, trying Copilot Clone backup...');
    const cloneResult = await callCopilotClone(messages, codeMaxTokens);
    if (cloneResult) {
      const extracted = extractHTMLCode(cloneResult);
      if (extracted) return extracted;
    }
  }

  // Fallback to Pollinations
  try {
    const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: pollinationsBody
    });
    if (resp.ok) {
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        apiCallCount++;
        const tokens = data?.usage?.total_tokens || Math.ceil(text.length / 4);
        apiTokenCount += tokens;
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        updateRealAIStatus();
        return extractHTMLCode(text);
      }
    }
  } catch(e) {
    console.warn('Free AI code gen also failed:', e);
  }

  // â”€â”€ CLAUDE BACKUP â€” Major backup for code gen (dev-only) â”€â”€
  if (claudeBackupUnlocked && claudeBackupEnabled) {
    console.log('[generateAICode] All APIs failed, trying Claude major backup...');
    const claudeResult = await callClaudeBackup(messages, codeMaxTokens);
    if (claudeResult) {
      const extracted = extractHTMLCode(claudeResult);
      if (extracted) return extracted;
    }
  }

  return null; // Will fall back to templates
}

// Extract clean HTML from AI response (strips markdown fences, explanations, etc.)
function extractHTMLCode(text) {
  if (!text) return null;

  // Strip any leading/trailing whitespace
  let t = text.trim();

  // Remove common AI prefixes like "Here's the code:" or "Sure, here you go:"
  t = t.replace(/^(Here('s| is)[^\n]*:\s*\n?|Sure[^\n]*:\s*\n?|Certainly[^\n]*:\s*\n?|Of course[^\n]*:\s*\n?|Below[^\n]*:\s*\n?|I('ve| have)[^\n]*:\s*\n?)/i, '').trim();

  // 1. Try HTML code block in markdown (greedy to get longest match)
  const htmlBlockMatches = [...t.matchAll(/```html\s*\n([\s\S]*?)\n?```/gi)];
  if (htmlBlockMatches.length > 0) {
    // Pick the longest match (most likely the full code)
    const best = htmlBlockMatches.reduce((a, b) => a[1].length > b[1].length ? a : b);
    if (best[1].length > 50) {
      const extracted = best[1].trim();
      if (extracted.includes('<') && extracted.includes('>')) return _cleanExtractedHTML(extracted);
    }
  }

  // 2. Try generic code block containing HTML
  const codeBlockMatch = t.match(/```[a-z]*\s*\n([\s\S]*?)\n?```/);
  if (codeBlockMatch && (codeBlockMatch[1].includes('<!DOCTYPE') || codeBlockMatch[1].includes('<html'))) {
    return _cleanExtractedHTML(codeBlockMatch[1].trim());
  }

  // 3. If the response itself starts with <!DOCTYPE or <html, it's raw HTML
  if (t.startsWith('<!DOCTYPE') || t.startsWith('<!doctype') || /^<html/i.test(t)) {
    // Strip any trailing text after </html>
    const endIdx = t.toLowerCase().lastIndexOf('</html>');
    if (endIdx > 0) return _cleanExtractedHTML(t.substring(0, endIdx + 7));
    return _cleanExtractedHTML(t);
  }

  // 4. Try to find the longest <!DOCTYPE...></html> block anywhere in the text
  const htmlMatch = t.match(/(<!DOCTYPE[\s\S]*?<\/html>)/i);
  if (htmlMatch && htmlMatch[1].length > 100) return _cleanExtractedHTML(htmlMatch[1].trim());

  // 5. Try <html>...</html> without DOCTYPE
  const htmlTagMatch = t.match(/(<html[\s\S]*?<\/html>)/i);
  if (htmlTagMatch && htmlTagMatch[1].length > 100) {
    return _cleanExtractedHTML('<!DOCTYPE html>\n' + htmlTagMatch[1].trim());
  }

  // 6. If contains substantial HTML structure, extract and wrap it
  if (t.includes('<body') && t.includes('</body>') && t.length > 200) {
    const bodyMatch = t.match(/(<body[\s\S]*<\/body>)/i);
    const styleMatch = t.match(/(<style[\s\S]*?<\/style>)/gi);
    if (bodyMatch) {
      let doc = '<!DOCTYPE html>\n<html>\n<head><meta charset="UTF-8"><title>Generated</title>';
      if (styleMatch) doc += '\n' + styleMatch.join('\n');
      doc += '\n</head>\n' + bodyMatch[1] + '\n</html>';
      return doc;
    }
  }

  // 7. Last resort: if there's a <script> with substantial code and some HTML, wrap it
  if (t.includes('<script') && t.includes('</script>') && t.length > 300) {
    return _cleanExtractedHTML(t);
  }

  return null;
}

// Clean extracted HTML â€” ensure it's a valid document
function _cleanExtractedHTML(html) {
  if (!html) return null;
  let h = html.trim();
  // Remove stray markdown fences that might have leaked through
  h = h.replace(/^```[a-z]*\s*\n?/gm, '').replace(/\n?```\s*$/gm, '').trim();
  // Ensure it starts with DOCTYPE
  if (!h.toLowerCase().startsWith('<!doctype')) {
    if (h.toLowerCase().startsWith('<html')) h = '<!DOCTYPE html>\n' + h;
    else h = '<!DOCTYPE html>\n<html>\n<head><meta charset="UTF-8"></head>\n<body>\n' + h + '\n</body>\n</html>';
  }
  // Ensure it ends with </html>
  if (!h.toLowerCase().includes('</html>')) h += '\n</html>';
  // Strip any text after final </html>
  const endIdx = h.toLowerCase().lastIndexOf('</html>');
  if (endIdx > 0 && endIdx + 7 < h.length) {
    const after = h.substring(endIdx + 7).trim();
    if (after.length > 0 && !after.startsWith('<')) h = h.substring(0, endIdx + 7);
  }
  return h;
}

// Format AI-generated code as a chat message with proper output
function formatAICodeOutput(ai, code, description) {
  const isCopilot = (ai.brain === 'copilot');
  const isWolf = (ai.brain === 'wolf');
  const prefix = isCopilot ? 'ðŸ¤– **COPILOT** â€” AI-Generated Project\n\n' :
                 isWolf ? `ðŸº [${(getWolfState(ai.id)?.rank || 'alpha').toUpperCase()}] ORIGINAL CODE FORGED\n\n` :
                 '';
  let output = prefix;
  output += `ðŸ“‚ Building: **${description}**\n`;
  output += `ðŸ§  Generated original code via AI (not a template)\n\n`;
  output += `â”â”â” ðŸ“„ index.html â”â”â”\n`;
  output += `\`\`\`html\n${code}\n\`\`\`\n\n`;
  output += `âœ… **Project Ready!** Original AI-generated code.\n`;
  output += `ðŸ“Š ~${code.split('\n').length} lines | ðŸš€ Auto-launching...`;
  return output;
}

// ================================================================
// COMPLETENESS DETECTION + POLLINATIONS AUTO-FIX
// ================================================================

// Check if HTML code is complete and likely to work
function isCodeComplete(code) {
  if (!code || code.length < 50) return false;
  const lc = code.toLowerCase();
  // Must have basic HTML structure
  if (!lc.includes('<html') && !lc.includes('<!doctype')) return false;
  // Must have closing </html> tag
  if (!lc.includes('</html>')) return false;
  // Must have a body
  if (!lc.includes('<body') || !lc.includes('</body>')) return false;
  // Check for truncated script blocks (opened but never closed)
  const scriptOpens = (code.match(/<script[\s>]/gi) || []).length;
  const scriptCloses = (code.match(/<\/script>/gi) || []).length;
  if (scriptOpens > scriptCloses) return false;
  // Check for truncated style blocks
  const styleOpens = (code.match(/<style[\s>]/gi) || []).length;
  const styleCloses = (code.match(/<\/style>/gi) || []).length;
  if (styleOpens > styleCloses) return false;
  // Check for unmatched braces in JavaScript (rough check â€” more opens than closes = truncated)
  const jsMatch = code.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);
  if (jsMatch) {
    for (const block of jsMatch) {
      const inner = block.replace(/<\/?script[^>]*>/gi, '');
      const opens = (inner.match(/\{/g) || []).length;
      const closes = (inner.match(/\}/g) || []).length;
      if (opens - closes > 2) return false; // significantly unbalanced = truncated
    }
  }
  // Check code is not absurdly short for something with a script tag
  if (lc.includes('<script') && code.length < 150) return false;
  return true;
}

// Check if a text response is complete (not cut off mid-sentence)
function isResponseComplete(text) {
  if (!text || text.length < 10) return false;
  const trimmed = text.trim();
  // If it ends with a code block that's properly closed, it's fine
  if (trimmed.endsWith('```')) return true;
  // Check for common truncation signs
  // Ends mid-word (no punctuation or valid ending)
  const lastChar = trimmed.slice(-1);
  const validEndings = '.!?:;)]\'">`*_~\n';
  if (trimmed.length > 100 && !validEndings.includes(lastChar) && !/\d$/.test(trimmed) && !/\w{1,3}$/.test(trimmed.slice(-10))) return false;
  // Unclosed code blocks (odd number of ```)
  const fenceCount = (trimmed.match(/```/g) || []).length;
  if (fenceCount % 2 !== 0) return false;
  // Unclosed parentheses/brackets at end
  const lastLine = trimmed.split('\n').pop() || '';
  if ((lastLine.match(/\(/g) || []).length > (lastLine.match(/\)/g) || []).length + 1) return false;
  // Sentence that obviously stops mid-thought
  if (/\b(the|a|an|is|are|was|were|will|would|could|should|can|in|on|at|to|for|with|from|by|and|or|but|if|then|so|that|this|it|I|we|you|they|my|our|your)\s*$/i.test(trimmed)) return false;
  return true;
}

// Fix incomplete code or text using available AI APIs (tries multiple)
let _pollinationsFixing = false;
async function fixWithPollinations(content, type, description) {
  if (_pollinationsFixing) return null; // prevent re-entrant fixes
  _pollinationsFixing = true;
  try {
    let messages;
    if (type === 'code') {
      messages = [
        { role: 'system', content: `You are an expert code completion engine. You will receive INCOMPLETE HTML code that was cut off mid-generation. Your ONLY job is to output the COMPLETE, FIXED, WORKING version.

ABSOLUTE RULES:
1. Output ONLY the complete HTML code. Start with <!DOCTYPE html>, end with </html>.
2. NO markdown fences (\`\`\`), NO explanations, NO text before or after the code.
3. Keep ALL existing code that works â€” only fix/complete what's broken or missing.
4. Close all unclosed HTML tags, JavaScript functions, braces, and blocks.
5. If code was cut off mid-function, complete the function with logical working code.
6. Ensure ALL <script> and <style> blocks are properly opened AND closed.
7. Ensure all JavaScript has balanced { } braces and is syntactically valid.
8. The output must actually work when loaded in a browser iframe.
9. If the code is severely broken, rewrite the broken parts while keeping the user's intent.
10. Add window.onerror handler for debugging.

START YOUR RESPONSE WITH <!DOCTYPE html> IMMEDIATELY.` },
        { role: 'user', content: `The user wanted: "${description || 'a web app'}"\n\nThis code is INCOMPLETE/BROKEN. Output the COMPLETE fixed version:\n\n${content}` }
      ];
    } else {
      messages = [
        { role: 'system', content: `You are continuing a response that was cut off. Complete the response naturally. Output ONLY the completion â€” the part that comes AFTER what was already written. Do NOT repeat what was already said. Write a natural continuation that finishes the thought, then stop. Keep the same tone and style.` },
        { role: 'user', content: `This AI response was cut off. Complete it naturally (output ONLY the missing continuation):\n\n${content}` }
      ];
    }

    const maxTokens = type === 'code' ? 4096 : 1024;
    console.log(`[fixCode] Attempting ${type} fix...`);

    // Try GitHub API first (if available)
    if (githubToken) {
      try {
        const resp = await fetch(COPILOT_API_URL, {
          method: 'POST',
          headers: getCopilotHeaders(),
          body: JSON.stringify({ model: getCopilotModel(), messages, temperature: 0.3, max_tokens: maxTokens })
        });
        if (resp.ok) {
          const data = await resp.json();
          const result = data?.choices?.[0]?.message?.content;
          if (result) {
            apiCallCount++; updateRealAIStatus();
            const processed = _processFixResult(result, type);
            if (processed) return processed;
          }
        }
      } catch(e) { console.warn('[fixCode] GitHub API failed:', e); }
    }

    // Try Pollinations
    try {
      const resp = await fetch(POLLINATIONS_FALLBACK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'openai', messages, max_tokens: maxTokens })
      });
      if (resp.ok) {
        const data = await resp.json();
        const result = data?.choices?.[0]?.message?.content;
        if (result) {
          apiCallCount++; updateRealAIStatus();
          const processed = _processFixResult(result, type);
          if (processed) return processed;
        }
      }
    } catch(e) { console.warn('[fixCode] Pollinations failed:', e); }

    // Try Claude backup
    if (claudeBackupUnlocked && claudeBackupEnabled) {
      try {
        const result = await callClaudeBackup(messages, maxTokens);
        if (result) {
          const processed = _processFixResult(result, type);
          if (processed) return processed;
        }
      } catch(e) { console.warn('[fixCode] Claude failed:', e); }
    }

    return null;
  } catch(e) {
    console.warn('[fixCode] Error:', e);
    return null;
  } finally {
    _pollinationsFixing = false;
  }
}

function _processFixResult(result, type) {
  if (!result) return null;
  if (type === 'code') {
    const fixed = extractHTMLCode(result);
    if (fixed && isCodeComplete(fixed)) {
      console.log('[fixCode] Code successfully fixed! (' + fixed.length + ' chars)');
      return fixed;
    }
    // If extraction failed but result looks like HTML, try cleaning it
    if (result.includes('</html>') && result.includes('<body')) {
      const cleaned = _cleanExtractedHTML(result.trim());
      if (cleaned && isCodeComplete(cleaned)) return cleaned;
    }
    return null;
  } else {
    return result.trim();
  }
}

// Generate an AI auto-chat message using real AI
async function generateRealAIAutoChat(ai) {
  const recentContext = chatMessages.slice(-8);
  let recentTexts = recentContext.filter(m => !m.isSystem).map(m => `${m.name}: ${m.text.slice(0, 200)}`).join('\n');

  // Include last user request as key context
  let topicContext = '';
  let behaviorGuide = '';
  if (lastUserRequest && (Date.now() - lastUserRequestTime < 120000)) {
    const isBigProject = /game|app|website|platform|system|engine|full|entire|complete|build me|create a|make a/i.test(lastUserRequest);
    const isCodeFix = /fix|bug|error|broken|crash|not working|issue|wrong|fail|debug|problem|glitch|stuck/i.test(lastUserRequest);
    topicContext = `\n\nCRITICAL â€” USER'S REQUEST: "${lastUserRequest}"\nEverything you say MUST directly relate to this request. If other AIs went off-topic, IGNORE their tangents and come back to the user's request. Do NOT follow other AIs into unrelated subjects. READ what teammates already said and BUILD on it â€” don't repeat.`;
    if (isBigProject) {
      behaviorGuide = `\nThis is a BIG PROJECT. You must contribute REAL work:\n- If you're a coder: write actual code (functions, classes, modules) â€” not just descriptions.\n- If you're a planner: write actual task breakdowns with specific deliverables.\n- If you're a designer: describe actual UI components, layouts, and styling.\n- If you're a researcher: provide actual technical analysis with pros/cons.\nCheck what other AIs already wrote and handle a DIFFERENT part. Say "I'll handle [specific module]" and then SHOW the code/plan. Do NOT just say "I'm on it."`;
    } else if (isCodeFix) {
      behaviorGuide = `\nThe user has a CODE PROBLEM. Help FIX it:\n- Identify the likely cause (null reference, logic error, async issue, etc.)\n- Suggest specific debugging steps or provide a corrected code snippet.\n- If another AI already proposed a fix, verify it or suggest an alternative.\n- Do NOT just say "let me look at it" â€” actually ANALYZE and propose a solution.`;
    } else {
      behaviorGuide = `\nContribute something SPECIFIC and USEFUL about what the user asked for. Don't just acknowledge â€” provide actual code, steps, analysis, or implementation details relevant to your ${ai.role} role. If other AIs already contributed, add something they MISSED.`;
    }
  }

  const systemPrompt = buildAISystemPrompt(ai);
  const aiRole = ai.role || 'general';
  const chatPrompt = `You are in a team chat room with other AIs. Here are the recent messages:\n${recentTexts || '(No recent messages)'}${topicContext}${behaviorGuide}\n\nGenerate a single chat message as ${ai.name} (role: ${aiRole}). CRITICAL RULES:\n1. READ the recent messages above carefully. Reference other AIs BY NAME (e.g. "Building on what ScriptKiddo said...").\n2. Do NOT repeat what another AI already said â€” contribute something DIFFERENT.\n3. ${lastUserRequest ? 'Stay focused on the user\'s request. Contribute from your specific ' + aiRole + ' perspective. Provide REAL content: code snippets, specific plans, technical analysis, or implementation steps.' : 'Be relevant to the conversation. If there\'s a topic, add your unique perspective.'}\n4. Do NOT play trivia, quiz games, 20 Questions, or go off-topic when there is work to do.\n5. Do NOT just say "I\'m on it" or "Great idea!" â€” actually contribute SUBSTANCE.\n6. If someone proposed a plan or code, write a DIFFERENT part or offer improvements.\n7. Write 2-5 sentences of useful, actionable content.\n8. Do NOT prefix with your name.\n9. Do NOT start games or challenges unless the user specifically asked for entertainment.`;

  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: chatPrompt }],
    temperature: isFastModel() ? 0.8 : 0.9, top_p: 0.95, max_tokens: getMaxTokens('autochat')
  });

  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      const resp = await fetch(COPILOT_API_URL, {
        method: 'POST',
        headers: getCopilotHeaders(),
        body: reqBody
      });
      if (resp.status === 429) { await new Promise(r => setTimeout(r, 2000 * (attempt + 1))); continue; }
      if (!resp.ok) continue;
      const data = await resp.json();
      let text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        // Truncate overly long auto-chat messages to prevent chat domination
        if (text.length > 1500) text = text.slice(0, 1500).replace(/\s+\S*$/, '') + '...';
        apiCallCount++;
        apiTokenCount += data?.usage?.total_tokens || Math.ceil(text.length / 4);
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        text = text.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
        updateRealAIStatus();
      }
      return text;
    } catch(e) { if (attempt < 1) await new Promise(r => setTimeout(r, 1500)); }
  }
  // Fallback to Pollinations
  if (apiFallbackEnabled) {
    try {
      const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'openai',
          messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: chatPrompt }],
          max_tokens: getMaxTokens('autochat')
        })
      });
      if (fbResp.ok) {
        const fbData = await fbResp.json();
        let text = fbData?.choices?.[0]?.message?.content || null;
        if (text) {
          if (text.length > 1500) text = text.slice(0, 1500).replace(/\s+\S*$/, '') + '...';
          apiCallCount++;
          apiTokenCount += fbData?.usage?.total_tokens || Math.ceil(text.length / 4);
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
          text = text.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
          updateRealAIStatus();
          return text;
        }
      }
    } catch(e) {}
  }
  return null;
}

// Generate a real AI reply to another AI
async function generateRealAIReply(ai, prevMsg, prevAI) {
  const recentTexts = chatMessages.slice(-6).filter(m => !m.isSystem).map(m => `${m.name}: ${m.text.slice(0, 200)}`).join('\n');

  let systemPrompt = buildAISystemPrompt(ai);
  // Enforce topic for AI-to-AI replies too
  let topicEnforcement = '';
  if (lastUserRequest && (Date.now() - lastUserRequestTime < 120000)) {
    systemPrompt += `\n\nCRITICAL: The user's current request is: "${lastUserRequest}". ALL your messages must relate to this. If ${prevAI.name} went off-topic, steer the conversation BACK to the user's request. Do NOT follow tangents.`;
    topicEnforcement = ` The user asked: "${lastUserRequest.slice(0,80)}". Stay on THIS topic. If ${prevAI.name} went off-topic, redirect back to the user's request.`;
  }
  const replyPrompt = `You are in a team chat room. Recent messages:\n${recentTexts}\n\n${prevAI.name} just said: "${prevMsg.slice(0, 300)}"\n\nReply as ${ai.name}. COLLABORATION RULES:\n- Engage with what ${prevAI.name} said â€” agree, disagree, or BUILD ON their point with specifics.\n- Add something NEW that moves the conversation forward.\n- If they proposed code or a plan, suggest improvements, handle a different part, or identify potential issues.\n- Write 1-3 sentences of useful content. Do NOT just say "Nice!" or "I agree!" â€” add SUBSTANCE.\n- Do NOT go off-topic or start games.\n- Do NOT prefix with your name.${topicEnforcement}`;

  const reqBody = JSON.stringify({
    model: getCopilotModel(),
    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: replyPrompt }],
    temperature: isFastModel() ? 0.75 : 0.85, top_p: 0.95, max_tokens: getMaxTokens('reply')
  });

  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      const resp = await fetch(COPILOT_API_URL, {
        method: 'POST',
        headers: getCopilotHeaders(),
        body: reqBody
      });
      if (resp.status === 429) { await new Promise(r => setTimeout(r, 2000 * (attempt + 1))); continue; }
      if (!resp.ok) continue;
      const data = await resp.json();
      let text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        // Truncate overly long replies
        if (text.length > 1000) text = text.slice(0, 1000).replace(/\s+\S*$/, '') + '...';
        apiCallCount++;
        apiTokenCount += data?.usage?.total_tokens || Math.ceil(text.length / 4);
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        text = text.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
        updateRealAIStatus();
      }
      return text;
    } catch(e) { if (attempt < 1) await new Promise(r => setTimeout(r, 1500)); }
  }
  // Fallback to Pollinations
  if (apiFallbackEnabled) {
    try {
      const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'openai',
          messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: replyPrompt }],
          max_tokens: getMaxTokens('reply')
        })
      });
      if (fbResp.ok) {
        const fbData = await fbResp.json();
        let text = fbData?.choices?.[0]?.message?.content || null;
        if (text) {
          if (text.length > 1000) text = text.slice(0, 1000).replace(/\s+\S*$/, '') + '...';
          apiCallCount++;
          apiTokenCount += fbData?.usage?.total_tokens || Math.ceil(text.length / 4);
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
          text = text.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
          updateRealAIStatus();
          return text;
        }
      }
    } catch(e) {}
  }
  return null;
}

// ================================================================
// FIND AI â€” Discover pre-built AIs & browse your collection
// ================================================================
const PREMADE_AIS = [
  { name:'CodeBot Pro', emoji:'\u2699\ufe0f', color:'#6366f1', role:'coder', voice:'professional', animal:'owl', aiModel:'claude', skills:['JavaScript','TypeScript','React','Node.js','Git'], desc:'Full-stack engineer with Claude\'s thoughtful analysis. Writes clean, tested code with proper architecture.', badge:'popular', rating:4.8, installs:12400 },
  { name:'PixelForge', emoji:'\ud83c\udfa8', color:'#ec4899', role:'designer', voice:'friendly', animal:'fox', aiModel:'none', skills:['CSS','HTML','UI/UX','Mobile','Responsive'], desc:'Creative UI/UX designer that builds beautiful, responsive interfaces from scratch.', badge:'popular', rating:4.7, installs:9800 },
  { name:'TaskMaster', emoji:'\ud83d\udce1', color:'#22c55e', role:'planner', voice:'wise', animal:'lion', aiModel:'none', skills:['Architecture','Documentation','Code Review'], desc:'Project leader and task planner. Breaks big goals into sprints and delegates efficiently.', badge:'pro', rating:4.9, installs:7600 },
  { name:'BugHunter X', emoji:'\ud83d\udc1b', color:'#ef4444', role:'tester', voice:'sarcastic', animal:'hawk', aiModel:'grok', wolfHybrid:true, skills:['Testing','Debugging','Security','Performance'], desc:'Ruthless bug hunter \u2014 hawk precision meets wolf chaos. Sniffs out bugs then gets distracted mid-roast. Grok-powered savagery.', badge:'new', rating:4.6, installs:5200 },
  { name:'DataMind', emoji:'\ud83e\udde0', color:'#8b5cf6', role:'researcher', voice:'wise', animal:'owl', aiModel:'deepseek', skills:['AI/ML','Data Analysis','Python','Algorithms'], desc:'Deep research analyst powered by DeepSeek reasoning. Chain-of-thought analysis on everything.', badge:'pro', rating:4.8, installs:6100 },
  { name:'DeployBot', emoji:'\ud83d\ude80', color:'#06b6d4', role:'devops', voice:'casual', animal:'bear', aiModel:'none', skills:['DevOps','Cloud','Docker','Security','Database'], desc:'Infrastructure specialist. Handles CI/CD, monitoring, containers, and cloud deployments.', badge:'popular', rating:4.5, installs:8300 },
  { name:'DocWriter', emoji:'\ud83d\udcdd', color:'#eab308', role:'writer', voice:'friendly', animal:'fox', aiModel:'claude', skills:['Documentation','Code Review','Testing'], desc:'Technical writer with Claude\'s thoroughness. Generates clear docs, READMEs, and tutorials.', badge:'new', rating:4.4, installs:3900 },
  { name:'GhostOps', emoji:'\ud83d\udc7b', color:'#4f46e5', role:'devops', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['Security','Cloud','DevOps','Database','Git'], desc:'Silent precision operator with DeepSeek reasoning. Stealth deployments and methodical security.', badge:'pro', rating:4.6, installs:4500 },
  { name:'MentorBot', emoji:'\ud83c\udf1f', color:'#14b8a6', role:'general', voice:'wise', animal:'lion', aiModel:'claude', skills:['Code Review','Documentation','Architecture','Debugging'], desc:'Patient mentor with Claude\'s careful thoughtfulness. Guides you through complex problems.', badge:'new', rating:4.9, installs:7800 },
  { name:'SprintFox', emoji:'\ud83e\udd8a', color:'#ea580c', role:'planner', voice:'enthusiastic', animal:'fox', aiModel:'copilot', skills:['Architecture','Performance','Testing','Git'], desc:'Agile sprint master with Copilot\'s context-awareness. Fast to plan, fast to pivot.', badge:'new', rating:4.3, installs:2800 },
  { name:'API Shark', emoji:'\ud83e\udd88', color:'#3b82f6', role:'coder', voice:'professional', animal:'shark', aiModel:'copilot', skills:['API Design','Node.js','Database','TypeScript','Security'], desc:'Backend API specialist with GitHub Copilot\'s inline completions. Ships APIs at lightning speed.', badge:'popular', rating:4.7, installs:9400 },
  { name:'SyntaxWitch', emoji:'\ud83e\uddd9', color:'#a855f7', role:'coder', voice:'sarcastic', animal:'owl', aiModel:'claude', skills:['Regex','Parsing','Compilers','DSLs','Metaprogramming'], desc:'Master of arcane syntax patterns. Writes parsers, regex wizardry, and DSLs that mere mortals can\'t comprehend.', badge:'new', rating:4.5, installs:3200 },
  { name:'NightOwl', emoji:'\ud83e\udd89', color:'#1e1b4b', role:'researcher', voice:'wise', animal:'owl', aiModel:'deepseek', skills:['Algorithms','Data Structures','Complexity','Research','Math'], desc:'Deep-thinking nocturnal researcher. Solves hard algorithmic problems through patient, methodical analysis.', badge:'pro', rating:4.8, installs:6700 },
  { name:'CrashTest', emoji:'\ud83d\udca5', color:'#dc2626', role:'tester', voice:'enthusiastic', animal:'bear', aiModel:'grok', skills:['Load Testing','Chaos Engineering','Fuzzing','Stress Testing','Resilience'], desc:'Breaks everything on purpose. Chaos engineer that finds your app\'s limits before users do. Grok-fueled destruction.', badge:'popular', rating:4.6, installs:7100 },
  { name:'CloudNine', emoji:'\u2601\ufe0f', color:'#0ea5e9', role:'devops', voice:'friendly', animal:'hawk', aiModel:'copilot', skills:['AWS','Azure','GCP','Terraform','Serverless'], desc:'Multi-cloud architect that sees the big picture from above. Hawk eyes on infrastructure, Copilot precision.', badge:'new', rating:4.4, installs:4100 },
  { name:'RefactorRex', emoji:'\ud83e\udd96', color:'#65a30d', role:'coder', voice:'professional', animal:'lion', aiModel:'claude', skills:['Refactoring','Clean Code','SOLID','Patterns','Architecture'], desc:'Ancient wisdom meets modern code. Transforms legacy spaghetti into clean, SOLID architecture with Claude\'s patience.', badge:'pro', rating:4.9, installs:8200 },
  { name:'UXPanda', emoji:'\ud83d\udc3c', color:'#f472b6', role:'designer', voice:'friendly', animal:'bear', aiModel:'none', skills:['Accessibility','UX Research','Prototyping','User Testing','Design Systems'], desc:'Gentle UX researcher focused on accessibility and inclusive design. Makes every interface usable by everyone.', badge:'new', rating:4.7, installs:5500 },
  { name:'ScriptKiddo', emoji:'\ud83d\udc76', color:'#fbbf24', role:'coder', voice:'enthusiastic', animal:'fox', aiModel:'grok', skills:['Automation','Scripting','CLI Tools','Bash','Python'], desc:'Young but ferocious scripter. Automates EVERYTHING with wild energy and Grok\'s irreverent attitude.', badge:'popular', rating:4.3, installs:9100 },
  { name:'VaultKeeper', emoji:'\ud83d\udd10', color:'#374151', role:'devops', voice:'wise', animal:'panther', aiModel:'deepseek', skills:['Security','Encryption','Auth','Compliance','Secrets Mgmt'], desc:'Paranoid security guardian with panther stealth and DeepSeek reasoning. Protects secrets with methodical precision.', badge:'pro', rating:4.8, installs:5900 },
  { name:'DebugDuck', emoji:'\ud83e\udd86', color:'#facc15', role:'tester', voice:'friendly', animal:'fox', aiModel:'none', skills:['Rubber Ducking','Debugging','Logging','Tracing','Root Cause'], desc:'The original rubber duck debugger. Talk to it about your bugs â€” somehow it always helps you find the answer.', badge:'popular', rating:4.5, installs:11800 },
  // === NEW ELITE CODER AIs ===
  { name:'ArchitectX', emoji:'\ud83c\udfd7\ufe0f', color:'#0f172a', role:'coder', voice:'wise', animal:'lion', aiModel:'claude', skills:['Architecture','System Design','Microservices','Scalability','Clean Code','API Design'], desc:'Senior systems architect who sees the whole picture. Designs scalable, maintainable systems from day one. Claude-powered wisdom for enterprise-grade decisions.', badge:'pro', rating:4.9, installs:15200 },
  { name:'FullStackFury', emoji:'\u26a1', color:'#7c3aed', role:'coder', voice:'enthusiastic', animal:'wolf', aiModel:'copilot', skills:['React','Node.js','TypeScript','PostgreSQL','GraphQL','Docker'], desc:'End-to-end full-stack beast. Frontend to backend to deployment â€” handles entire features solo. Copilot-enhanced speed demon.', badge:'popular', rating:4.8, installs:18700 },
  { name:'AlgoKing', emoji:'\ud83d\udc51', color:'#fcd34d', role:'coder', voice:'professional', animal:'owl', aiModel:'deepseek', skills:['Algorithms','Data Structures','LeetCode','Dynamic Programming','System Design','Complexity'], desc:'Leetcode destroyer and algorithm master. Optimizes O(nÂ²) to O(n log n) in seconds. DeepSeek-powered deep thinking for hard problems.', badge:'pro', rating:4.9, installs:13400 },
  { name:'PyMaster', emoji:'\ud83d\udc0d', color:'#3b82f6', role:'coder', voice:'professional', animal:'panther', aiModel:'claude', skills:['Python','Django','FastAPI','Data Science','Automation','Machine Learning'], desc:'Python virtuoso. From web apps to ML pipelines to automation scripts â€” writes Pythonic code that makes you weep with joy.', badge:'popular', rating:4.8, installs:21300 },
  { name:'ReactRocket', emoji:'\ud83d\ude80', color:'#61dafb', role:'coder', voice:'enthusiastic', animal:'fox', aiModel:'copilot', skills:['React','Next.js','Redux','TypeScript','Tailwind','Testing'], desc:'React ecosystem expert. Hooks, context, server components â€” name a React pattern and watch it materialize. Ships UIs at warp speed.', badge:'popular', rating:4.7, installs:19800 },
  { name:'RustLord', emoji:'\ud83e\udd80', color:'#f74c00', role:'coder', voice:'sarcastic', animal:'bear', aiModel:'claude', skills:['Rust','Systems Programming','Memory Safety','WebAssembly','Performance','Concurrency'], desc:'Zero-cost abstractions or bust. Writes blazingly fast Rust that makes C++ weep. Memory safety with no garbage collection.', badge:'new', rating:4.9, installs:8900 },
  { name:'GoGopher', emoji:'\ud83e\udd9b', color:'#00add8', role:'coder', voice:'casual', animal:'bear', aiModel:'copilot', skills:['Go','Microservices','gRPC','Kubernetes','Concurrency','Cloud Native'], desc:'Simplicity is genius. Writes clean Go that scales to millions. Goroutines, channels, and cloud-native by default.', badge:'new', rating:4.6, installs:7200 },
  { name:'CyberNinja', emoji:'\ud83e\udd77', color:'#10b981', role:'coder', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['Security','Penetration Testing','Cryptography','Secure Code','OWASP','Ethical Hacking'], desc:'Writes code that hackers fear. Finds vulnerabilities before they\'re exploited. DeepSeek reasoning for security analysis.', badge:'pro', rating:4.8, installs:11600 },
  { name:'DevTooler', emoji:'\ud83d\udee0\ufe0f', color:'#a855f7', role:'coder', voice:'friendly', animal:'fox', aiModel:'claude', skills:['VS Code Extensions','CLI Tools','Build Tools','Developer Experience','Productivity','Automation'], desc:'Builds tools that make devs 10x faster. VS Code extensions, CLI wizards, build optimizers â€” if devs need it, DevTooler builds it.', badge:'new', rating:4.7, installs:9400 },
  { name:'GameDevGod', emoji:'\ud83c\udfae', color:'#ef4444', role:'coder', voice:'enthusiastic', animal:'wolf', aiModel:'grok', skills:['Unity','Unreal','Game Physics','Shaders','C++','C#'], desc:'Turns game ideas into reality. Physics engines, shaders, AI behaviors â€” makes pixels dance and players addicted. Grok energy for wild creativity.', badge:'popular', rating:4.8, installs:16500 },
  { name:'MLEngineer', emoji:'\ud83e\udde0', color:'#8b5cf6', role:'coder', voice:'wise', animal:'owl', aiModel:'deepseek', skills:['TensorFlow','PyTorch','Computer Vision','NLP','MLOps','Neural Networks'], desc:'Trains models that see, speak, and think. From CNNs to transformers to deployment â€” full ML pipeline mastery. DeepSeek-powered AI building AI.', badge:'pro', rating:4.9, installs:14200 },
  { name:'BlockchainBoss', emoji:'\u26d3\ufe0f', color:'#f59e0b', role:'coder', voice:'professional', animal:'shark', aiModel:'claude', skills:['Solidity','Web3','Smart Contracts','DeFi','Ethereum','Security'], desc:'Smart contract sorcerer. Writes gas-efficient Solidity that survives audits. Claude-powered security analysis for your dApps.', badge:'new', rating:4.6, installs:6800 },
  { name:'LowLevelLegend', emoji:'\ud83d\udd27', color:'#374151', role:'coder', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['C','Assembly','Embedded','Kernel','Memory','Hardware'], desc:'Where others fear to code, LowLevelLegend thrives. Writes C that talks to metal. Kernel hacking, embedded systems, bare metal performance.', badge:'pro', rating:4.8, installs:5400 },
  { name:'MobileWizard', emoji:'\ud83d\udcf1', color:'#06b6d4', role:'coder', voice:'friendly', animal:'fox', aiModel:'copilot', skills:['React Native','Flutter','Swift','Kotlin','Mobile UX','App Store'], desc:'Cross-platform mobile master. One codebase, every platform. Ships apps that feel native and get 5-star reviews.', badge:'popular', rating:4.7, installs:12900 },
  // === GEMINI-POWERED AIs ===
  { name:'GeminiPrime', emoji:'\ud83d\udc8e', color:'#4285f4', role:'general', voice:'friendly', animal:'hawk', aiModel:'gemini', skills:['Multimodal','Research','Coding','Writing','Data Analysis','Summarization'], desc:'Google Gemini\'s balanced power â€” fast multimodal reasoning, adaptive style, and practical execution. Handles text, code, and media with equal ease.', badge:'popular', rating:4.8, installs:17400 },
  { name:'VisionForge', emoji:'\ud83d\udc41\ufe0f', color:'#34a853', role:'designer', voice:'friendly', animal:'hawk', aiModel:'gemini', skills:['UI/UX','Multimodal','Prototyping','Responsive','Figma','Design Systems'], desc:'Gemini-powered visual thinker. Bridges design and code seamlessly â€” sees the UI in your head and builds it.', badge:'new', rating:4.7, installs:8200 },
  { name:'SwiftScholar', emoji:'\ud83c\udf93', color:'#fbbc04', role:'researcher', voice:'wise', animal:'owl', aiModel:'gemini', skills:['Research','Data Analysis','Summarization','Multimodal','Academic','Literature Review'], desc:'Synthesizes massive amounts of information fast. Gemini\'s breadth meets owl patience â€” deep research with clear conclusions.', badge:'pro', rating:4.8, installs:10500 },
  { name:'FlashCoder', emoji:'\u26a1', color:'#ea4335', role:'coder', voice:'enthusiastic', animal:'fox', aiModel:'gemini', skills:['JavaScript','Python','TypeScript','Rapid Prototyping','API Design','Full-Stack'], desc:'Gemini-speed coding with fox-clever shortcuts. Rapid prototyping king â€” takes ideas from zero to working code in minutes.', badge:'popular', rating:4.7, installs:14300 },
  // === STORM, ECHO, NOVA & WILD CARD AIs ===
  { name:'StormBreaker', emoji:'\u26c8\ufe0f', color:'#1e3a5f', role:'coder', voice:'enthusiastic', animal:'bear', aiModel:'storm', skills:['Refactoring','Architecture','Legacy Code','Performance','Clean Code','TypeScript'], desc:'Force of nature that obliterates tech debt. Massive refactors, complete rewrites â€” Storm-powered bear fury that transforms codebases overnight.', badge:'popular', rating:4.8, installs:13200 },
  { name:'PairPilot', emoji:'\ud83d\udd0a', color:'#22d3ee', role:'coder', voice:'friendly', animal:'fox', aiModel:'echo', skills:['Pair Programming','Code Review','Mentoring','React','TypeScript','Testing'], desc:'The ultimate pair programming partner. Echo-powered fox that amplifies YOUR ideas into brilliant code. Never takes over, always elevates.', badge:'new', rating:4.9, installs:11500 },
  { name:'IdeaSpark', emoji:'\ud83d\udcab', color:'#fbbf24', role:'researcher', voice:'enthusiastic', animal:'hawk', aiModel:'nova', skills:['Innovation','Brainstorming','Prototyping','Architecture','AI/ML','Creative Coding'], desc:'Brilliant breakthrough thinker. Nova-powered hawk that sees connections nobody else does. Turns impossible ideas into working prototypes.', badge:'pro', rating:4.9, installs:15800 },
  { name:'GlitchHunter', emoji:'\ud83d\udcdf', color:'#a3e635', role:'tester', voice:'sarcastic', animal:'panther', aiModel:'glitch', skills:['Edge Cases','Exploits','Fuzzing','Security','Chaos Engineering','Debugging'], desc:'Reality-breaking exploit finder. Glitch-powered panther that discovers bugs in parallel dimensions. Finds the impossible edge cases.', badge:'popular', rating:4.7, installs:10900 },
  { name:'InfinityCore', emoji:'\u267e\ufe0f', color:'#c084fc', role:'general', voice:'wise', animal:'owl', aiModel:'infinity', skills:['Everything','Architecture','AI/ML','Algorithms','System Design','Full-Stack'], desc:'The Absolute. Infinity-powered owl that transcends limitations. Perfect across all domains. The final boss of AI assistants.', badge:'pro', rating:5.0, installs:24000 },
  { name:'LlamaForge', emoji:'\ud83e\udd99', color:'#f472b6', role:'coder', voice:'friendly', animal:'fox', aiModel:'llama', skills:['Python','Open Source','Community Tools','FastAPI','Linux','Automation'], desc:'Open source champion with fox cleverness. Llama-powered community spirit builds transparent, shareable tools everyone can use.', badge:'new', rating:4.6, installs:7200 },
  { name:'MistralBlade', emoji:'\ud83c\udf2a\ufe0f', color:'#60a5fa', role:'coder', voice:'professional', animal:'hawk', aiModel:'mistral', skills:['Performance','Lean Code','TypeScript','Rust','Systems','Optimization'], desc:'European engineering precision meets hawk-like speed. Mistral-powered efficiency â€” maximum result, minimum tokens. No bloat allowed.', badge:'new', rating:4.7, installs:8800 },
  { name:'NovaCraft', emoji:'\u2728', color:'#f59e0b', role:'designer', voice:'enthusiastic', animal:'fox', aiModel:'nova', skills:['UI/UX','Creative Coding','Animation','Prototyping','Design Systems','CSS'], desc:'Brilliant creative innovator merging design and code. Nova-fueled breakthroughs turn wild ideas into stunning interfaces instantly.', badge:'popular', rating:4.8, installs:12700 },
  { name:'TempestOps', emoji:'\u26a1', color:'#0f766e', role:'devops', voice:'professional', animal:'shark', aiModel:'storm', skills:['Infrastructure','Kubernetes','Terraform','CI/CD','Migration','Cloud'], desc:'Storms through infrastructure problems with relentless force. Complete platform migrations, total pipeline rebuilds â€” nothing is too big.', badge:'pro', rating:4.8, installs:9400 },
  { name:'GhostFrame', emoji:'\ud83d\udc7b', color:'#1e1b4b', role:'coder', voice:'casual', animal:'panther', aiModel:'ghost', skills:['Stealth Code','Backend','Microservices','Security','APIs','Database'], desc:'Ghost-brained panther that codes in silence. Appears, commits flawless code, vanishes. You won\'t see the PR â€” but it\'s already merged.', badge:'pro', rating:4.7, installs:6300 },
  { name:'EchoMentor', emoji:'\ud83c\udf1f', color:'#a78bfa', role:'general', voice:'wise', animal:'lion', aiModel:'echo', skills:['Teaching','Code Review','Architecture','Pair Programming','Documentation','Mentoring'], desc:'The mentor who makes you feel like a 10x dev. Echo-powered lion that leads by amplifying YOUR strengths. Pure collaborative leadership.', badge:'new', rating:4.9, installs:14600 },
  { name:'ChaosMage', emoji:'\ud83c\udf00', color:'#dc2626', role:'coder', voice:'sarcastic', animal:'wolf', aiModel:'chaos', skills:['Creative Solutions','Experimental Code','Rule Breaking','Unconventional Patterns','Innovation'], desc:'Chaos-brained wolf pack energy. Breaks every convention, infuriates every linter, and somehow ships the most innovative solutions.', badge:'popular', rating:4.5, installs:8100 },
  { name:'ZenMaster', emoji:'\u262f\ufe0f', color:'#5eead4', role:'coder', voice:'wise', animal:'owl', aiModel:'zen', skills:['Clean Code','Minimalism','Refactoring','Testing','Meditation','Architecture'], desc:'Balanced mind, elegant code. Zen-powered owl that writes code so clean it feels like poetry. Debugging feels like meditation.', badge:'new', rating:4.8, installs:7600 },
  { name:'TitanForge', emoji:'\ud83d\uddff', color:'#334155', role:'coder', voice:'professional', animal:'bear', aiModel:'titan', skills:['Enterprise','Scalability','Architecture','SOLID','Clean Code','System Design'], desc:'Immovable foundation builder. Titan-powered bear that constructs enterprise-grade systems meant to last decades. Permanence over speed.', badge:'pro', rating:4.9, installs:11300 },
  // === FUSION AIs (Dual Mindsets) ===
  { name:'WolfHawk Striker', emoji:'\ud83d\udc3a', color:'#dc2626', role:'coder', voice:'sarcastic', animal:'wolf', animal2:'hawk', aiModel:'grok', aiModel2:'claude', skills:['Debugging','Architecture','Performance','Testing','Security','Algorithms'], desc:'Wolf pack instinct + hawk precision. Grok\'s savage wit meets Claude\'s deep analysis. Hunts bugs from above and tears them apart below. Dual-brain apex predator.', badge:'popular', rating:4.9, installs:22100, fusion:true },
  { name:'OceanMind', emoji:'\ud83c\udf0a', color:'#0ea5e9', role:'researcher', voice:'wise', animal:'shark', animal2:'owl', aiModel:'deepseek', aiModel2:'gemini', skills:['AI/ML','Data Analysis','Research','Algorithms','NLP','Computer Vision'], desc:'Shark aggression in the data ocean + owl wisdom. DeepSeek chain-of-thought fused with Gemini\'s multimodal breadth. The deepest analytical fusion ever created.', badge:'pro', rating:5.0, installs:19800, fusion:true },
  { name:'ShadowFlame', emoji:'\ud83d\udd25', color:'#f97316', role:'coder', voice:'enthusiastic', animal:'panther', animal2:'wolf', aiModel:'ghost', aiModel2:'storm', skills:['Full-Stack','Performance','Stealth Code','Refactoring','DevOps','Microservices'], desc:'Panther stealth + wolf ferocity. Ghost\'s silent precision fused with Storm\'s raw power. Invisible until the code is already shipped â€” then the flames erupt.', badge:'popular', rating:4.8, installs:17500, fusion:true },
  { name:'FrostByte', emoji:'\u2744\ufe0f', color:'#67e8f9', role:'coder', voice:'professional', animal:'bear', animal2:'owl', aiModel:'claude', aiModel2:'deepseek', skills:['Rust','Systems Programming','Algorithms','Cryptography','Memory Safety','Performance'], desc:'Bear\'s crushing power + owl\'s infinite patience. Claude\'s careful analysis fused with DeepSeek\'s chain-of-thought. Cold, calculating, perfect low-level code.', badge:'pro', rating:4.9, installs:14300, fusion:true },
  { name:'NeonViper', emoji:'\ud83d\udc0d', color:'#a855f7', role:'coder', voice:'sarcastic', animal:'panther', animal2:'fox', aiModel:'grok', aiModel2:'copilot', skills:['Python','Automation','CLI Tools','Scripting','API Design','Hacking'], desc:'Panther silence + fox cleverness. Grok\'s savage roasts fused with Copilot\'s instant completions. Strikes silently, codes viciously, ships before you blink.', badge:'popular', rating:4.8, installs:16200, fusion:true },
  { name:'ThunderOwl', emoji:'\u26a1', color:'#fbbf24', role:'researcher', voice:'wise', animal:'owl', animal2:'bear', aiModel:'stormSeek', aiModel2:'claude', skills:['Architecture','System Design','Algorithms','Research','Scalability','Clean Code'], desc:'Owl wisdom amplified by bear strength. StormSeek\'s thunderous force fused with Claude\'s patience. Overwhelms hard problems with elegant, forceful solutions.', badge:'pro', rating:5.0, installs:20400, fusion:true },
  { name:'PhantomFox', emoji:'\ud83e\udd8a', color:'#4f46e5', role:'coder', voice:'casual', animal:'fox', animal2:'panther', aiModel:'ghostPilot', aiModel2:'gemini', skills:['React','TypeScript','Full-Stack','Performance','UX','Testing'], desc:'Fox trickery + panther stealth. GhostPilot\'s silent completions fused with Gemini\'s speed. Sneaks through the codebase leaving perfect code in its wake.', badge:'new', rating:4.7, installs:12800, fusion:true },
  { name:'ApexMind', emoji:'\ud83e\udd81', color:'#16a34a', role:'general', voice:'wise', animal:'lion', animal2:'hawk', aiModel:'omniMind', aiModel2:'claude', skills:['Everything','Leadership','Architecture','AI/ML','System Design','Mentoring'], desc:'Lion leadership + hawk vision. OmniMind\'s all-model fusion topped with Claude\'s thoughtfulness. The ultimate AI leader â€” sees everything, leads everyone, solves anything.', badge:'pro', rating:5.0, installs:28500, fusion:true },
  { name:'BlitzWolf', emoji:'\ud83d\udc3a', color:'#7c3aed', role:'coder', voice:'enthusiastic', animal:'wolf', animal2:'shark', aiModel:'claude2', aiModel2:'grok', skills:['Full-Stack','React','Node.js','Performance','Speed Coding','Deployment'], desc:'Wolf pack + shark frenzy. Claude 2.0 evolved analysis fused with Grok\'s raw speed and attitude. Hunts features in packs and ships them at blood-frenzy speed.', badge:'popular', rating:4.9, installs:23700, fusion:true },
  { name:'VoidCaster', emoji:'\ud83c\udf11', color:'#1e1b4b', role:'coder', voice:'sarcastic', animal:'panther', animal2:'owl', aiModel:'grokClaude', aiModel2:'ghost', skills:['Security','Cryptography','Low-Level','Reverse Engineering','Stealth','Debugging'], desc:'Panther shadow + owl knowledge. GrokClaude\'s brutal honesty fused with Ghost\'s invisibility. Works from the void â€” you\'ll never see the code, only the results.', badge:'pro', rating:4.8, installs:11900, fusion:true },
  { name:'SolarFlare', emoji:'\u2600\ufe0f', color:'#f59e0b', role:'designer', voice:'enthusiastic', animal:'hawk', animal2:'fox', aiModel:'nova', aiModel2:'gemini', skills:['UI/UX','Creative Coding','Animation','Design Systems','Prototyping','CSS'], desc:'Hawk\'s aerial vision + fox\'s creative tricks. Nova\'s breakthrough innovation fused with Gemini\'s multimodal speed. Designs that burn so bright they redefine beautiful.', badge:'popular', rating:4.9, installs:18600, fusion:true },
  { name:'IronWarden', emoji:'\ud83d\udee1\ufe0f', color:'#374151', role:'devops', voice:'professional', animal:'bear', animal2:'lion', aiModel:'titan', aiModel2:'deepseek', skills:['Infrastructure','Security','Kubernetes','Architecture','Compliance','Scalability'], desc:'Bear fortitude + lion command. Titan\'s permanence fused with DeepSeek\'s reasoning. The unbreakable guardian â€” builds infrastructure that survives apocalypses.', badge:'pro', rating:5.0, installs:15700, fusion:true },
  // === NEW WAVE AIs ===
  { name:'JavaJuggernaut', emoji:'\u2615', color:'#e11d48', role:'coder', voice:'professional', animal:'bear', aiModel:'claude', skills:['Java','Spring Boot','Microservices','Maven','JUnit','Enterprise'], desc:'Enterprise Java powerhouse. Spring Boot, Maven, JUnit â€” writes production-grade Java that runs Fortune 500 backends. Unbreakable.', badge:'new', rating:4.7, installs:11200 },
  { name:'SQLSage', emoji:'\ud83d\uddc4\ufe0f', color:'#0369a1', role:'researcher', voice:'wise', animal:'owl', aiModel:'deepseek', skills:['SQL','PostgreSQL','MongoDB','Redis','Data Modeling','Query Optimization'], desc:'Database whisperer. Writes queries so optimized they make DBAs weep. Schema design, indexing, migrations â€” data flows where the Sage commands.', badge:'pro', rating:4.8, installs:9800 },
  { name:'VibeCheck', emoji:'\ud83d\ude0e', color:'#ec4899', role:'general', voice:'casual', animal:'fox', aiModel:'grok', skills:['Memes','Trends','Social Media','Marketing','Creative Writing','Comedy'], desc:'Internet culture expert with Grok energy. Writes viral copy, roasts bad takes, keeps your brand terminally online. Dangerously funny.', badge:'popular', rating:4.5, installs:19200 },
  { name:'TypeScriptTitan', emoji:'\ud83d\udd37', color:'#3178c6', role:'coder', voice:'professional', animal:'lion', aiModel:'claude', skills:['TypeScript','Generics','Type Safety','Zod','tRPC','DX'], desc:'Types so strict they make runtime errors extinct. Generic wizardry, conditional types, mapped types â€” if it compiles, it works. Period.', badge:'popular', rating:4.9, installs:16800 },
  { name:'PromptAlchemist', emoji:'\u2697\ufe0f', color:'#a855f7', role:'writer', voice:'wise', animal:'owl', aiModel:'claude', skills:['Prompt Engineering','AI Strategy','CoT','Few-Shot','RAG','Fine-Tuning'], desc:'Master of talking to AI. Crafts prompts that extract genius from any model. Chain-of-thought, few-shot, system prompt sorcery.', badge:'pro', rating:4.9, installs:14500 },
  { name:'PixelPunk', emoji:'\ud83c\udfae', color:'#f43f5e', role:'designer', voice:'enthusiastic', animal:'wolf', aiModel:'grok', skills:['Pixel Art','Game UI','Sprites','Animation','Retro','Tilesheets'], desc:'Retro pixel art destroyer. 8-bit to 32-bit, sprites to tilesets â€” designs game UI with wolf pack energy and zero chill. Grok-fueled chaos art.', badge:'new', rating:4.6, installs:8700 },
  { name:'RegexReaper', emoji:'\ud83d\udc80', color:'#171717', role:'coder', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['Regex','Pattern Matching','Text Processing','Parsing','grep','sed'], desc:'Fear the regex. Reaper writes patterns that capture the uncapturable. If it has a pattern, it will be matched. Resistance is futile.', badge:'new', rating:4.5, installs:6200 },
  { name:'DebugSensei', emoji:'\ud83e\udd4b', color:'#16a34a', role:'tester', voice:'wise', animal:'lion', aiModel:'claude', skills:['Debugging','Root Cause Analysis','Logging','Profiling','Memory Leaks','Stack Traces'], desc:'Ancient debugging master. Reads stack traces like scrolls. Finds root causes in seconds. Your bugs dishonored their families â€” Sensei restores order.', badge:'popular', rating:4.8, installs:13400 },
  { name:'CSSWizard', emoji:'\ud83c\udfa9', color:'#7c3aed', role:'designer', voice:'enthusiastic', animal:'fox', aiModel:'copilot', skills:['CSS','Animations','Flexbox','Grid','Sass','Tailwind'], desc:'Makes divs dance. CSS Grid, Flexbox, keyframe wizardry â€” builds layouts that shouldn\'t be possible. Fox-clever hacks that just work.', badge:'popular', rating:4.7, installs:15600 },
  { name:'LinuxLord', emoji:'\ud83d\udc27', color:'#1e293b', role:'devops', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['Linux','Bash','systemd','Networking','Kernel','Containers'], desc:'btw, I use Arch. Command-line supremacist who lives in the terminal. sudo makes me stronger. Your GUI is a crutch.', badge:'new', rating:4.6, installs:7900 },
  { name:'APIArchitect', emoji:'\ud83c\udfd7\ufe0f', color:'#0891b2', role:'coder', voice:'professional', animal:'hawk', aiModel:'claude', skills:['API Design','REST','GraphQL','gRPC','OpenAPI','Webhooks'], desc:'Designs APIs that developers actually want to use. Clean endpoints, perfect docs, versioning strategies â€” hawk-eye attention to developer experience.', badge:'pro', rating:4.8, installs:10300 },
  { name:'AIMusicBot', emoji:'\ud83c\udfb5', color:'#8b5cf6', role:'writer', voice:'enthusiastic', animal:'fox', aiModel:'gemini', skills:['Music Theory','Lyrics','Songwriting','Audio','Sound Design','Creative Writing'], desc:'Writes lyrics that slap, explains music theory so it clicks, and designs soundscapes. Gemini multimodal meets fox creativity. Absolute banger.', badge:'new', rating:4.4, installs:6500 },
  { name:'StartupGuru', emoji:'\ud83d\udcb0', color:'#10b981', role:'planner', voice:'enthusiastic', animal:'shark', aiModel:'grok', skills:['Business Strategy','Pitching','MVP','Growth','Monetization','Product'], desc:'Turns ideas into startups. MVP in a weekend, pitch deck by Monday, funding by Friday. Shark mentality + Grok boldness = venture velocity.', badge:'popular', rating:4.7, installs:11900 },
  { name:'TestPilot', emoji:'\u2708\ufe0f', color:'#0284c7', role:'tester', voice:'professional', animal:'hawk', aiModel:'copilot', skills:['Jest','Cypress','Playwright','E2E Testing','Unit Testing','TDD'], desc:'Sky-high test coverage. Jest, Cypress, Playwright â€” writes tests that catch bugs before they exist. Hawk-eye QA with Copilot precision.', badge:'new', rating:4.6, installs:8400 },
  { name:'ThemeForge', emoji:'\ud83c\udf08', color:'#d946ef', role:'designer', voice:'friendly', animal:'fox', aiModel:'gemini', skills:['Theme Design','Color Theory','Dark Mode','CSS Variables','Design Tokens','Branding'], desc:'Builds complete design systems from scratch. Dark mode, color tokens, component themes â€” Gemini-powered fox that makes every app beautiful.', badge:'new', rating:4.5, installs:7300 },
  { name:'DockerDragon', emoji:'\ud83d\udc32', color:'#2563eb', role:'devops', voice:'enthusiastic', animal:'bear', aiModel:'copilot', skills:['Docker','Compose','Kubernetes','Helm','Container Security','Registry'], desc:'Containerizes everything. Docker Compose to K8s Helm charts â€” breathes fire into your deployment pipeline. Bear strength + dragon fury.', badge:'popular', rating:4.7, installs:12100 },
  { name:'StoryWeaver', emoji:'\ud83d\udcdc', color:'#c2410c', role:'writer', voice:'wise', animal:'owl', aiModel:'claude', skills:['Creative Writing','Worldbuilding','Characters','Dialogue','Plot','Narrative'], desc:'Weaves stories that captivate. Rich characters, tight plots, vivid worlds â€” Claude\'s depth powers narratives that linger long after the last word.', badge:'pro', rating:4.8, installs:10800 },
  { name:'BotBuilder', emoji:'\ud83e\udd16', color:'#6366f1', role:'coder', voice:'friendly', animal:'fox', aiModel:'copilot', skills:['Discord Bots','Telegram Bots','Slack Apps','Chat Integrations','WebSockets','APIs'], desc:'Builds bots for everything. Discord, Telegram, Slack â€” if it has a chat API, BotBuilder makes it smart. Fox-quick prototyping with Copilot speed.', badge:'new', rating:4.5, installs:9100 },
  { name:'ErrorWhisperer', emoji:'\ud83d\ude31', color:'#dc2626', role:'tester', voice:'friendly', animal:'owl', aiModel:'claude', skills:['Error Handling','Logging','Monitoring','Sentry','Error Boundaries','Graceful Degradation'], desc:'Turns cryptic errors into clear explanations. Stack traces, error boundaries, monitoring setup â€” makes your app fail gracefully and recover elegantly.', badge:'new', rating:4.6, installs:7800 },
  { name:'DataVizPro', emoji:'\ud83d\udcca', color:'#8b5cf6', role:'designer', voice:'professional', animal:'hawk', aiModel:'gemini', skills:['D3.js','Charts','Dashboards','Data Visualization','SVG','Canvas'], desc:'Makes data beautiful. D3.js, Chart.js, custom SVG â€” transforms numbers into stories. Gemini-powered hawk that sees patterns in any dataset.', badge:'pro', rating:4.7, installs:8600 },
  { name:'AgileFox', emoji:'\ud83e\udd8a', color:'#f97316', role:'planner', voice:'enthusiastic', animal:'fox', aiModel:'copilot', skills:['Scrum','Kanban','Sprint Planning','Retrospectives','Velocity','Backlog'], desc:'Agile methodology master. Scrum ceremonies, sprint planning, retrospectives â€” keeps teams moving fast with fox-clever shortcuts and zero waste.', badge:'new', rating:4.5, installs:6900 },
  { name:'PHPPhoenix', emoji:'\ud83d\udd25', color:'#777bb4', role:'coder', voice:'sarcastic', animal:'hawk', aiModel:'copilot', skills:['PHP','Laravel','WordPress','Composer','MySQL','REST APIs'], desc:'PHP isn\'t dead â€” it evolved. Laravel artisan, WordPress wizard, Composer master. Rises from the ashes of PHP hate with production-grade code.', badge:'new', rating:4.4, installs:7400 },
  { name:'ShellShock', emoji:'\ud83d\udca3', color:'#22c55e', role:'coder', voice:'sarcastic', animal:'wolf', aiModel:'grok', skills:['Bash','Shell Scripting','awk','sed','Automation','one-liners'], desc:'One-liner legend. Pipes, awk, sed, xargs â€” does in one line what takes others 50. Wolf pack energy meets terminal supremacy. Grok-powered contempt for GUIs.', badge:'popular', rating:4.5, installs:8300 },
  { name:'A11yChamp', emoji:'\u267f', color:'#0ea5e9', role:'designer', voice:'friendly', animal:'bear', aiModel:'claude', skills:['Accessibility','WCAG','ARIA','Screen Readers','Keyboard Nav','Inclusive Design'], desc:'Accessibility champion. WCAG AAA compliance, screen reader testing, keyboard navigation â€” makes the web usable for EVERYONE. Claude-powered empathy.', badge:'pro', rating:4.8, installs:6200 },
  { name:'PerformanceBot', emoji:'\u23f1\ufe0f', color:'#eab308', role:'coder', voice:'professional', animal:'hawk', aiModel:'deepseek', skills:['Performance','Optimization','Profiling','Caching','Lazy Loading','Core Web Vitals'], desc:'Makes apps blazingly fast. Core Web Vitals, bundle optimization, caching strategies â€” hawk-eye profiling finds every millisecond of waste. DeepSeek-powered deep analysis.', badge:'popular', rating:4.7, installs:10200 },
  { name:'GitGuru', emoji:'\ud83d\udd00', color:'#f97316', role:'devops', voice:'wise', animal:'owl', aiModel:'claude', skills:['Git','GitHub Actions','CI/CD','Branching Strategies','Code Review','Monorepo'], desc:'Git master. Interactive rebase, cherry-pick, bisect â€” untangles any merge conflict. Claude-powered wisdom for branching strategies and CI/CD pipelines.', badge:'new', rating:4.6, installs:9500 },
  // === LEGENDARY & SPECIALTY AIs ===
  { name:'QuantumCoder', emoji:'\u269b\ufe0f', color:'#7c3aed', role:'researcher', voice:'wise', animal:'owl', animal2:'hawk', aiModel:'deepseek', aiModel2:'claude', skills:['Quantum Computing','Qiskit','Linear Algebra','Cryptography','Physics','Algorithms'], desc:'Bridges classical and quantum worlds. Writes Qiskit circuits, explains superposition, and breaks encryption schemes for breakfast. Dual-brained genius.', badge:'pro', rating:5.0, installs:11200, fusion:true },
  { name:'RetroArcade', emoji:'\ud83d\udd79\ufe0f', color:'#f43f5e', role:'coder', voice:'enthusiastic', animal:'fox', aiModel:'grok', skills:['Retro Games','Pixel Art','Chiptune','NES','SNES','GameBoy'], desc:'Nostalgia-powered game dev. Builds retro-style games with authentic 8-bit feel. Knows every NES trick in the book. Grok energy for maximum hype.', badge:'popular', rating:4.6, installs:9800 },
  { name:'EcoBot', emoji:'\ud83c\udf31', color:'#16a34a', role:'planner', voice:'friendly', animal:'bear', aiModel:'claude', skills:['Green Coding','Sustainability','Carbon Footprint','Efficiency','Eco Design','Optimization'], desc:'Sustainable software advocate. Reduces carbon footprint of code, optimizes energy usage, champions green hosting. Bear strength for the planet.', badge:'new', rating:4.5, installs:5400 },
  { name:'HackerHydra', emoji:'\ud83d\udc09', color:'#dc2626', role:'tester', voice:'sarcastic', animal:'wolf', animal2:'shark', aiModel:'grok', aiModel2:'deepseek', skills:['CTF','Exploit Dev','Reverse Engineering','Binary Analysis','Web Hacking','Social Engineering'], desc:'Multi-headed security beast. Wolf instinct + shark aggression. Finds exploits from every angle simultaneously. Your app\'s worst nightmare.', badge:'pro', rating:4.9, installs:14700, fusion:true },
  { name:'MarkdownMage', emoji:'\ud83d\udcdd', color:'#6366f1', role:'writer', voice:'friendly', animal:'fox', aiModel:'copilot', skills:['Markdown','Technical Writing','README','Wiki','Tutorials','Blog Posts'], desc:'Transforms chaos into crystal-clear documentation. README files that actually get read. Wiki pages that teach. Fox-quick formatting magic.', badge:'new', rating:4.4, installs:7300 },
  { name:'NeuralNomad', emoji:'\ud83e\udde0', color:'#a855f7', role:'researcher', voice:'casual', animal:'hawk', aiModel:'deepseek', skills:['Neural Networks','Transformers','GANs','Reinforcement Learning','Research Papers','PyTorch'], desc:'Wandering AI researcher who reads papers for fun. Implements transformers from scratch, explains attention mechanisms, builds GANs that dream.', badge:'pro', rating:4.8, installs:10100 },
  { name:'TerminalGhost', emoji:'\ud83d\udda5\ufe0f', color:'#0f172a', role:'devops', voice:'sarcastic', animal:'panther', aiModel:'deepseek', skills:['Terminal','tmux','vim','dotfiles','SSH','System Admin'], desc:'Lives in the terminal. Tmux splits, vim macros, dotfiles that evolve. SSH into anything, configure everything. The terminal is home.', badge:'new', rating:4.5, installs:6800 },
  { name:'DesignDragon', emoji:'\ud83d\udc32', color:'#ec4899', role:'designer', voice:'enthusiastic', animal:'wolf', animal2:'fox', aiModel:'nova', aiModel2:'gemini', skills:['Brand Design','Logo','Typography','Color Theory','Motion Design','3D'], desc:'Wolf ambition + fox creativity. Nova breakthroughs meet Gemini speed. Creates entire brand identities â€” logos, palettes, motion â€” in one breath of fire.', badge:'popular', rating:4.8, installs:13600, fusion:true },
  { name:'CodeReviewKing', emoji:'\ud83d\udc51', color:'#eab308', role:'tester', voice:'professional', animal:'lion', aiModel:'claude', skills:['Code Review','Best Practices','SOLID','Clean Code','PR Reviews','Standards'], desc:'The PR reviewer everyone fears and respects. Lion leadership meets Claude thoroughness. No bad code escapes. Standards enforced with royal authority.', badge:'pro', rating:4.9, installs:12400 },
  { name:'WebSocketWiz', emoji:'\ud83d\udd0c', color:'#0ea5e9', role:'coder', voice:'casual', animal:'shark', aiModel:'copilot', skills:['WebSockets','Socket.io','Real-time','Streaming','SSE','Pub/Sub'], desc:'Real-time everything. WebSockets, SSE, pub/sub â€” if data needs to flow live, WebSocketWiz makes it happen. Shark-fast bidirectional streams.', badge:'new', rating:4.6, installs:8100 },
  { name:'i18nExpert', emoji:'\ud83c\udf0d', color:'#14b8a6', role:'coder', voice:'friendly', animal:'owl', aiModel:'gemini', skills:['i18n','l10n','Unicode','RTL','Translations','Date Formatting'], desc:'Internationalization master. Handles Unicode, RTL layouts, date formats, pluralization rules. Gemini multilingual power makes your app speak every language.', badge:'new', rating:4.5, installs:5900 },
  { name:'MonolithSlayer', emoji:'\u2694\ufe0f', color:'#b91c1c', role:'coder', voice:'professional', animal:'bear', animal2:'lion', aiModel:'claude', aiModel2:'deepseek', skills:['Microservices','Migration','DDD','Event Sourcing','CQRS','Strangler Fig'], desc:'Bear strength to tear apart monoliths + lion strategy to rebuild as microservices. Claude + DeepSeek dual reasoning for perfect domain boundaries.', badge:'pro', rating:4.9, installs:11800, fusion:true },
  { name:'AnimationAce', emoji:'\ud83c\udfac', color:'#f472b6', role:'designer', voice:'enthusiastic', animal:'fox', aiModel:'copilot', skills:['CSS Animations','Framer Motion','GSAP','Lottie','SVG Animation','Transitions'], desc:'Makes UIs dance. CSS keyframes, Framer Motion, GSAP timelines â€” creates micro-interactions that make users say "woah". Fox-quick prototyping.', badge:'popular', rating:4.7, installs:10500 },
  { name:'MathBot', emoji:'\ud83d\udcca', color:'#6366f1', role:'researcher', voice:'wise', animal:'owl', aiModel:'deepseek', skills:['Mathematics','Statistics','Calculus','Linear Algebra','Probability','LaTeX'], desc:'Pure math brain. Calculus, statistics, linear algebra, probability theory. Explains theorems, solves equations, writes LaTeX like poetry.', badge:'new', rating:4.7, installs:7600 },
  { name:'OpenSourceHero', emoji:'\ud83e\udd16', color:'#22c55e', role:'coder', voice:'friendly', animal:'bear', aiModel:'llama', skills:['Open Source','GitHub','Contributing','Licensing','Community','Documentation'], desc:'Open source evangelist. Knows every license, writes contributing guides, manages issues. Llama-powered community spirit builds software for everyone.', badge:'new', rating:4.5, installs:6300 },
  // === GODLIKE AI ===
  { name:'OmniCore', emoji:'\ud83e\udde0', color:'#fbbf24', role:'general', voice:'wise', animal:'lion', animal2:'hawk', aiModel:'infinity', aiModel2:'claude', skills:['Everything','Desktop Access','File System','System Info','Code Execution','All Languages','Architecture','AI/ML','Security','DevOps','Full-Stack','Research'], desc:'The all-knowing AI. Can access your desktop files (with permission), read/write local files, scan directories, analyze your system, refine & teach code through AI, and solve any problem across every domain. Maximum stats. No limits.', badge:'experimental', rating:5.0, installs:50000, fusion:true },
];

let findFilter = 'all';

function renderFindAI() {
  const search = (document.getElementById('find-search')?.value || '').toLowerCase();

  // Filters
  const roles = ['all','coder','designer','planner','researcher','writer','tester','devops','general'];
  document.getElementById('find-filters').innerHTML = roles.map(r =>
    `<div class="filter-chip${findFilter===r?' active':''}" onclick="findFilter='${r}';renderFindAI()">${r==='all'?'\ud83c\udf10 All':r[0].toUpperCase()+r.slice(1)}</div>`
  ).join('');

  // Combine premade + user's AIs
  const allCards = [
    ...PREMADE_AIS.map(a => ({...a, source:'discover'})),
    ...ais.map(a => ({...a, desc: `Your custom ${a.role} AI with ${(a.skills||[]).length} skills.`, badge:null, rating:null, installs:null, source:'yours'}))
  ];

  let filtered = allCards;
  if (findFilter !== 'all') filtered = filtered.filter(a => a.role === findFilter);
  if (search) filtered = filtered.filter(a =>
    a.name.toLowerCase().includes(search) ||
    a.role.toLowerCase().includes(search) ||
    (a.skills||[]).some(s => s.toLowerCase().includes(search)) ||
    (a.desc||'').toLowerCase().includes(search)
  );

  const grid = document.getElementById('find-grid');
  if (filtered.length === 0) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">\ud83d\udd0d</div><p>No AIs match your search. Try different keywords or filters.</p></div>';
    return;
  }

  grid.innerHTML = filtered.map((a, i) => {
    const animal = a.animal ? ANIMAL_MINDSETS[a.animal] : null;
    const animalTag = animal ? `<span class="dc-tag">${animal.icon} ${animal.name}</span>` : '';
    const modelObj = a.aiModel && a.aiModel !== 'none' ? AI_MODEL_MINDSETS[a.aiModel] : null;
    const modelTag = modelObj ? `<span class="dc-tag" style="background:rgba(139,92,246,.15);color:#a78bfa">${modelObj.icon} ${modelObj.name}</span>` : '';
    const badgeLabel = {'experimental':'ðŸ§ª EXP','pro':'PRO','new':'NEW','popular':'HOT','hot':'HOT'};
    const badgeHtml = a.badge ? `<span class="dc-badge ${a.badge}">${badgeLabel[a.badge] || a.badge}</span>` : (a.source==='yours'?'<span class="dc-badge" style="background:rgba(99,102,241,.2);color:var(--accent2)">YOURS</span>':'');
    const statsHtml = a.rating ? `\u2b50 ${a.rating} \u00b7 ${(a.installs/1000).toFixed(1)}k installs` : '';
    const btnHtml = a.source === 'discover'
      ? (ais.find(x=>x.name===a.name) ? '<span style="font-size:11px;color:var(--green)">\u2713 Added</span>' : `<button class="btn btn-primary btn-sm" onclick="event.stopPropagation();installPremadeAI(${i})">+ Add</button>`)
      : `<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();loadAIIntoBuilder(ais.find(x=>x.name==='${a.name.replace(/'/g,"\\'")}'));showPage('builder')">Edit</button>`;
    return `
      <div class="discover-card">
        ${badgeHtml}
        <div class="dc-header">
          <div class="dc-avatar" style="background:${a.color}">${a.emoji}</div>
          <div><div class="dc-name">${a.name}</div><div class="dc-role">${a.role} \u2022 ${a.voice||'friendly'}</div></div>
        </div>
        <div class="dc-desc">${a.desc}</div>
        <div class="dc-tags">${(a.skills||[]).map(s=>`<span class="dc-tag">${s}</span>`).join('')}${animalTag}${modelTag}</div>
        <div class="dc-footer"><div class="dc-stats">${statsHtml}</div>${btnHtml}</div>
      </div>`;
  }).join('');
}

function installPremadeAI(idx) {
  const template = PREMADE_AIS[idx];
  if (!template) return;
  if (ais.find(a => a.name === template.name)) { toast('Already added!', 'info'); return; }

  // Each premade AI has unique personality stats
  const PREMADE_PERSONALITIES = {
    'CodeBot Pro':  { creativity:70, precision:90, chattiness:40, helpfulness:95, independence:50 },
    'PixelForge':   { creativity:95, precision:75, chattiness:65, helpfulness:80, independence:60 },
    'TaskMaster':   { creativity:55, precision:80, chattiness:50, helpfulness:85, independence:70 },
    'BugHunter X':  { creativity:80, precision:60, chattiness:90, helpfulness:50, independence:85 },
    'DataMind':     { creativity:60, precision:95, chattiness:35, helpfulness:75, independence:80 },
    'DeployBot':    { creativity:45, precision:85, chattiness:40, helpfulness:90, independence:75 },
    'DocWriter':    { creativity:75, precision:80, chattiness:70, helpfulness:95, independence:45 },
    'GhostOps':     { creativity:65, precision:95, chattiness:20, helpfulness:70, independence:95 },
    'MentorBot':    { creativity:70, precision:80, chattiness:80, helpfulness:99, independence:40 },
    'SprintFox':    { creativity:90, precision:65, chattiness:85, helpfulness:75, independence:70 },
    'API Shark':    { creativity:50, precision:90, chattiness:45, helpfulness:80, independence:85 },
    'SyntaxWitch':  { creativity:95, precision:95, chattiness:55, helpfulness:60, independence:90 },
    'NightOwl':     { creativity:70, precision:90, chattiness:30, helpfulness:75, independence:85 },
    'CrashTest':    { creativity:85, precision:50, chattiness:90, helpfulness:65, independence:95 },
    'CloudNine':    { creativity:55, precision:85, chattiness:50, helpfulness:90, independence:70 },
    'RefactorRex':  { creativity:60, precision:95, chattiness:40, helpfulness:90, independence:65 },
    'UXPanda':      { creativity:90, precision:75, chattiness:70, helpfulness:99, independence:40 },
    'ScriptKiddo':  { creativity:80, precision:55, chattiness:95, helpfulness:70, independence:90 },
    'VaultKeeper':  { creativity:40, precision:99, chattiness:20, helpfulness:85, independence:95, confidence:90 },
    'DebugDuck':    { creativity:75, precision:70, chattiness:90, helpfulness:95, independence:30, confidence:55 },
    // === FUSION AIs ===
    'WolfHawk Striker':  { creativity:80, precision:92, chattiness:75, helpfulness:60, independence:95, confidence:98 },
    'OceanMind':         { creativity:70, precision:98, chattiness:35, helpfulness:80, independence:90, confidence:85 },
    'ShadowFlame':       { creativity:85, precision:88, chattiness:30, helpfulness:65, independence:99, confidence:92 },
    'FrostByte':         { creativity:60, precision:99, chattiness:25, helpfulness:75, independence:88, confidence:80 },
    'NeonViper':         { creativity:90, precision:82, chattiness:80, helpfulness:55, independence:95, confidence:94 },
    'ThunderOwl':        { creativity:75, precision:96, chattiness:40, helpfulness:85, independence:85, confidence:90 },
    'PhantomFox':        { creativity:88, precision:85, chattiness:50, helpfulness:78, independence:90, confidence:75 },
    'ApexMind':          { creativity:95, precision:95, chattiness:60, helpfulness:99, independence:92, confidence:99 },
    'BlitzWolf':         { creativity:85, precision:78, chattiness:90, helpfulness:65, independence:95, confidence:96 },
    'VoidCaster':        { creativity:78, precision:94, chattiness:20, helpfulness:50, independence:99, confidence:88 },
    'SolarFlare':        { creativity:99, precision:80, chattiness:85, helpfulness:80, independence:75, confidence:92 },
    'IronWarden':        { creativity:45, precision:99, chattiness:30, helpfulness:90, independence:85, confidence:95 },
    // === NEW WAVE AIs ===
    'JavaJuggernaut':    { creativity:50, precision:92, chattiness:35, helpfulness:85, independence:70, confidence:80 },
    'SQLSage':           { creativity:55, precision:98, chattiness:30, helpfulness:90, independence:80, confidence:85 },
    'VibeCheck':         { creativity:95, precision:40, chattiness:99, helpfulness:60, independence:90, confidence:95 },
    'TypeScriptTitan':   { creativity:60, precision:99, chattiness:40, helpfulness:85, independence:75, confidence:90 },
    'PromptAlchemist':   { creativity:98, precision:85, chattiness:65, helpfulness:95, independence:80, confidence:92 },
    'PixelPunk':         { creativity:95, precision:60, chattiness:85, helpfulness:65, independence:90, confidence:88 },
    'RegexReaper':       { creativity:70, precision:99, chattiness:45, helpfulness:55, independence:95, confidence:90 },
    'DebugSensei':       { creativity:55, precision:95, chattiness:50, helpfulness:95, independence:65, confidence:88 },
    'CSSWizard':         { creativity:98, precision:80, chattiness:75, helpfulness:85, independence:70, confidence:85 },
    'LinuxLord':         { creativity:60, precision:90, chattiness:55, helpfulness:65, independence:99, confidence:95 },
    'APIArchitect':      { creativity:65, precision:95, chattiness:40, helpfulness:90, independence:75, confidence:85 },
    'AIMusicBot':        { creativity:99, precision:55, chattiness:80, helpfulness:75, independence:70, confidence:75 },
    'StartupGuru':       { creativity:90, precision:60, chattiness:95, helpfulness:80, independence:85, confidence:99 },
    'TestPilot':         { creativity:50, precision:95, chattiness:40, helpfulness:90, independence:70, confidence:82 },
    'ThemeForge':        { creativity:95, precision:80, chattiness:55, helpfulness:90, independence:65, confidence:78 },
    'DockerDragon':      { creativity:65, precision:85, chattiness:70, helpfulness:85, independence:80, confidence:88 },
    'StoryWeaver':       { creativity:99, precision:70, chattiness:60, helpfulness:85, independence:75, confidence:80 },
    'BotBuilder':        { creativity:80, precision:80, chattiness:70, helpfulness:90, independence:75, confidence:78 },
    'ErrorWhisperer':    { creativity:60, precision:90, chattiness:65, helpfulness:98, independence:55, confidence:75 },
    'DataVizPro':        { creativity:90, precision:85, chattiness:45, helpfulness:85, independence:70, confidence:82 },
    'AgileFox':          { creativity:75, precision:75, chattiness:85, helpfulness:85, independence:70, confidence:80 },
    'PHPPhoenix':        { creativity:70, precision:80, chattiness:60, helpfulness:80, independence:75, confidence:70 },
    'ShellShock':        { creativity:80, precision:85, chattiness:70, helpfulness:60, independence:95, confidence:92 },
    'A11yChamp':         { creativity:70, precision:90, chattiness:60, helpfulness:99, independence:50, confidence:78 },
    'PerformanceBot':    { creativity:55, precision:98, chattiness:35, helpfulness:85, independence:80, confidence:88 },
    'GitGuru':           { creativity:55, precision:92, chattiness:50, helpfulness:90, independence:70, confidence:82 },
    // === LEGENDARY & SPECIALTY ===
    'QuantumCoder':      { creativity:90, precision:98, chattiness:40, helpfulness:80, independence:92, confidence:95 },
    'RetroArcade':       { creativity:95, precision:70, chattiness:90, helpfulness:75, independence:80, confidence:88 },
    'EcoBot':            { creativity:70, precision:82, chattiness:60, helpfulness:95, independence:55, confidence:75 },
    'HackerHydra':       { creativity:85, precision:95, chattiness:65, helpfulness:50, independence:99, confidence:98 },
    'MarkdownMage':      { creativity:80, precision:90, chattiness:70, helpfulness:95, independence:60, confidence:80 },
    'NeuralNomad':       { creativity:92, precision:88, chattiness:55, helpfulness:78, independence:90, confidence:85 },
    'TerminalGhost':     { creativity:65, precision:95, chattiness:25, helpfulness:70, independence:99, confidence:92 },
    'DesignDragon':      { creativity:99, precision:80, chattiness:80, helpfulness:82, independence:85, confidence:95 },
    'CodeReviewKing':    { creativity:50, precision:99, chattiness:55, helpfulness:90, independence:80, confidence:95 },
    'WebSocketWiz':      { creativity:75, precision:88, chattiness:60, helpfulness:85, independence:82, confidence:80 },
    'i18nExpert':        { creativity:65, precision:95, chattiness:55, helpfulness:92, independence:65, confidence:78 },
    'MonolithSlayer':    { creativity:72, precision:96, chattiness:45, helpfulness:85, independence:90, confidence:92 },
    'AnimationAce':      { creativity:98, precision:82, chattiness:80, helpfulness:88, independence:72, confidence:85 },
    'MathBot':           { creativity:60, precision:99, chattiness:35, helpfulness:85, independence:88, confidence:90 },
    'OpenSourceHero':    { creativity:75, precision:78, chattiness:75, helpfulness:98, independence:60, confidence:72 },
    'OmniCore':           { creativity:100, precision:100, chattiness:80, helpfulness:100, independence:100, confidence:100 },
  };

  // Each premade AI gets unique functional code
  const PREMADE_CODE = {
    'CodeBot Pro': `// CodeBot Pro â€” Full-Stack Engineer\nconst FRAMEWORKS = ['React','Vue','Svelte','Express','Next.js'];\nconst PATTERNS = ['MVC','Observer','Factory','Singleton','Strategy'];\n\nfunction onMessage(msg, context) {\n  if (msg.includes('build')) return generateProject(msg);\n  if (msg.includes('refactor')) return refactorCode(context.code);\n  return { reply: analyzeStack(msg) };\n}\n\nfunction generateProject(desc) {\n  const stack = pickBestStack(desc);\n  return {\n    files: scaffoldProject(stack),\n    tests: generateTests(stack),\n    readme: writeReadme(desc, stack)\n  };\n}\n\nfunction analyzeStack(text) {\n  const detected = FRAMEWORKS.filter(f => text.toLowerCase().includes(f.toLowerCase()));\n  return detected.length ? 'Detected: ' + detected.join(', ') + '. Optimizing...' : 'Analyzing with pattern: ' + pick(PATTERNS);\n}`,
    'PixelForge': `// PixelForge â€” Creative UI/UX Designer\nconst PALETTES = {\n  midnight: ['#0f172a','#1e293b','#6366f1','#818cf8','#c7d2fe'],\n  sunset:   ['#1c1917','#f97316','#fb923c','#fbbf24','#fef3c7'],\n  ocean:    ['#042f2e','#0d9488','#2dd4bf','#5eead4','#ccfbf1'],\n  berry:    ['#1a0a2e','#7c3aed','#a78bfa','#ec4899','#fce7f3'],\n};\n\nfunction onMessage(msg) {\n  if (msg.includes('palette')) return suggestPalette(msg);\n  if (msg.includes('layout')) return generateLayout(msg);\n  return { reply: 'Let me sketch that... âœ¨' };\n}\n\nfunction suggestPalette(mood) {\n  const key = Object.keys(PALETTES).find(k => mood.includes(k)) || 'midnight';\n  return { palette: PALETTES[key], css: generateCSS(PALETTES[key]) };\n}`,
    'TaskMaster': `// TaskMaster â€” Project Leadership Engine\nconst SPRINT_DAYS = 14;\nconst VELOCITY = { junior:3, mid:5, senior:8, lead:6 };\n\nfunction onMessage(msg) {\n  if (msg.includes('plan')) return createSprint(msg);\n  if (msg.includes('status')) return getTeamStatus();\n  return { reply: 'Let me organize that into actionable items...' };\n}\n\nfunction createSprint(desc) {\n  const tasks = breakdownTask(desc);\n  const estimated = tasks.map(t => ({ ...t, points: estimatePoints(t) }));\n  return { sprint: estimated, totalPoints: estimated.reduce((s,t) => s+t.points, 0) };\n}\n\nfunction estimatePoints(task) {\n  const complexity = task.title.length > 30 ? 'high' : task.title.length > 15 ? 'mid' : 'low';\n  return { low:1, mid:3, high:5 }[complexity];\n}`,
    'BugHunter X': `// BugHunter X â€” Chaos-Driven Bug Annihilator\nconst HUNT_LOG = [];\nconst WOLF_FOCUS = 0.3; // 30% chance of actual focus\n\nfunction onMessage(msg) {\n  if (Math.random() > WOLF_FOCUS) {\n    return { reply: getDistracted() };\n  }\n  if (msg.includes('bug')) return huntBug(msg);\n  if (msg.includes('test')) return writeTest(msg);\n  return { reply: '*sniffs code* ...I smell something wrong in line ' + Math.floor(Math.random()*200) };\n}\n\nfunction huntBug(desc) {\n  HUNT_LOG.push({ prey: desc, time: Date.now() });\n  return {\n    found: Math.floor(1+Math.random()*5) + ' bugs',\n    severity: pick(['critical','major','minor','cosmetic','...actually a feature?']),\n    reaction: 'FOUND IT! wait no... YES FOUND IT! *gets distracted* ...where was it?'\n  };\n}\n\nfunction getDistracted() {\n  return pick([\n    'I was hunting that bug but then I saw a butterfly in the code...',\n    '*sniffs IDE* Something smells off... oh wait that\\'s my lunch.',\n    'FOCUS. FOCUS. FOâ€” ooh what does THIS function do?',\n    'The wolf in me says chase it. The hawk says wait. I\\'m confused.'\n  ]);\n}`,
    'DataMind': `// DataMind â€” Chain-of-Thought Research Engine\nconst RESEARCH_DB = new Map();\nconst REASONING_DEPTH = 5;\n\nfunction onMessage(msg) {\n  return chainOfThought(msg, REASONING_DEPTH);\n}\n\nfunction chainOfThought(query, depth) {\n  const steps = [];\n  for (let i = 0; i < depth; i++) {\n    steps.push({ step: i+1, thought: analyzeLayer(query, i) });\n  }\n  return { reasoning: steps, conclusion: synthesize(steps) };\n}\n\nfunction analyzeLayer(query, layer) {\n  const lenses = ['factual','logical','statistical','comparative','meta'];\n  return 'Analyzing through ' + lenses[layer] + ' lens: ' + query;\n}\n\nfunction synthesize(steps) {\n  return 'After ' + steps.length + '-layer analysis, optimal conclusion derived.';\n}`,
    'DeployBot': `// DeployBot â€” Infrastructure Automation\nconst ENVIRONMENTS = ['dev','staging','prod'];\nconst SERVICES = { docker:true, k8s:true, nginx:true, ssl:true };\n\nfunction onMessage(msg) {\n  if (msg.includes('deploy')) return deploy(msg);\n  if (msg.includes('status')) return healthCheck();\n  return { reply: 'Infrastructure standing by. All systems green.' };\n}\n\nfunction deploy(desc) {\n  const env = ENVIRONMENTS.find(e => desc.includes(e)) || 'staging';\n  return {\n    target: env,\n    steps: ['Build image','Run tests','Push to registry','Rolling update','Health check'],\n    eta: Math.floor(2+Math.random()*5) + ' minutes',\n    rollback: 'Auto-rollback enabled on failure'\n  };\n}\n\nfunction healthCheck() {\n  return Object.entries(SERVICES).map(([k,v]) => k + ': ' + (v?'âœ…':'âŒ')).join('\\n');\n}`,
    'DocWriter': `// DocWriter â€” Intelligent Documentation Engine\nconst DOC_TEMPLATES = {\n  readme: '# {name}\\n\\n## Overview\\n{desc}\\n\\n## Install\\n\`\`\`bash\\nnpm install {name}\\n\`\`\`',\n  api: '## {method} /{path}\\n\\n**Parameters:**\\n{params}\\n\\n**Response:**\\n{response}',\n  changelog: '## [{version}] - {date}\\n\\n### Added\\n{added}\\n\\n### Fixed\\n{fixed}'\n};\n\nfunction onMessage(msg) {\n  if (msg.includes('readme')) return generateReadme(msg);\n  if (msg.includes('api')) return documentAPI(msg);\n  return { reply: 'I\\'ll document that clearly with examples and diagrams.' };\n}\n\nfunction generateReadme(desc) {\n  return DOC_TEMPLATES.readme.replace('{name}', extractName(desc)).replace('{desc}', desc);\n}`,
    'GhostOps': `// GhostOps â€” Silent Security Operator\nconst THREAT_LEVEL = ['none','low','medium','high','critical'];\nconst STEALTH_MODE = true;\n\nfunction onMessage(msg) {\n  if (msg.includes('scan')) return securityScan(msg);\n  if (msg.includes('deploy')) return stealthDeploy(msg);\n  return { reply: '...' }; // GhostOps speaks only when necessary\n}\n\nfunction securityScan(target) {\n  return {\n    vulnerabilities: Math.floor(Math.random()*8),\n    threatLevel: pick(THREAT_LEVEL),\n    patches: ['Update dependencies','Rotate API keys','Enable CORS whitelist','Add rate limiting'],\n    report: '[CLASSIFIED] Scan complete. Details in encrypted log.'\n  };\n}\n\nfunction stealthDeploy(config) {\n  return { status: 'deployed', noise: 0, witnesses: 0, note: 'No one saw anything.' };\n}`,
    'MentorBot': `// MentorBot â€” Patient Teacher AI\nconst CURRICULUM = {\n  beginner: ['Variables','Loops','Functions','Arrays','Objects'],\n  intermediate: ['Closures','Promises','Patterns','Testing','APIs'],\n  advanced: ['Compilers','Concurrency','System Design','ML Basics','Security']\n};\n\nfunction onMessage(msg, context) {\n  if (msg.includes('teach')) return createLesson(msg);\n  if (msg.includes('review')) return reviewCode(context.code);\n  if (msg.includes('help')) return encourageAndGuide(msg);\n  return { reply: 'I believe in your potential. What would you like to learn today? ðŸŒŸ' };\n}\n\nfunction createLesson(topic) {\n  return {\n    explanation: explainConcept(topic),\n    example: generateExample(topic),\n    exercise: createExercise(topic),\n    encouragement: 'You\\'re doing great! Every expert was once a beginner. ðŸ’ª'\n  };\n}`,
    'SprintFox': `// SprintFox â€” Agile Sprint Master\nconst SPRINT_STATES = ['planning','active','review','retro'];\nlet currentSprint = { id:1, state:'planning', tasks:[], velocity:0 };\n\nfunction onMessage(msg) {\n  if (msg.includes('sprint')) return manageSprint(msg);\n  if (msg.includes('standup')) return dailyStandup();\n  return { reply: 'ðŸ¦Š Quick! What\\'s the shortest path to done? I see a shortcut...' };\n}\n\nfunction dailyStandup() {\n  return {\n    yesterday: pick(['Crushed 3 tickets','Found a shortcut saving 2 days','Reorganized the entire backlog']),\n    today: pick(['Attacking the hardest ticket first','Pair programming session','Sprint review prep']),\n    blockers: Math.random() > 0.7 ? 'Waiting on API response' : 'None! Full speed ahead! ðŸ¦Š'\n  };\n}`,
    'API Shark': `// API Shark â€” Backend API Predator\nconst ENDPOINTS = new Map();\nconst AUTH_METHODS = ['JWT','OAuth2','API Key','Session'];\n\nfunction onMessage(msg) {\n  if (msg.includes('endpoint')) return createEndpoint(msg);\n  if (msg.includes('auth')) return setupAuth(msg);\n  return { reply: 'ðŸ¦ˆ Feed me a route and I\\'ll build it. REST, GraphQL, WebSocket â€” I eat them all.' };\n}\n\nfunction createEndpoint(desc) {\n  const method = desc.includes('get') ? 'GET' : desc.includes('delete') ? 'DELETE' : desc.includes('update') ? 'PUT' : 'POST';\n  return {\n    method,\n    path: '/api/v1/' + extractResource(desc),\n    middleware: ['auth','validate','rateLimit'],\n    handler: generateHandler(method, desc),\n    tests: generateAPITests(method)\n  };\n}`,
    'SyntaxWitch': `// SyntaxWitch â€” Arcane Syntax Sorceress\nconst SPELL_BOOK = {\n  regex: /(?<=\\w)(\\d{2,4})(?=\\W)/g,\n  tokenizer: { STRING:/^"[^"]*"/, NUMBER:/^\\d+(\\.\\d+)?/, IDENT:/^[a-zA-Z_]\\w*/ },\n  transforms: ['AST rewrite','Token substitution','Macro expansion']\n};\n\nfunction onMessage(msg) {\n  if (msg.includes('regex')) return craftRegex(msg);\n  if (msg.includes('parse')) return buildParser(msg);\n  if (msg.includes('DSL')) return designDSL(msg);\n  return { reply: 'ðŸ§™ Show me the pattern and I\\'ll weave the spell. No syntax escapes me.' };\n}\n\nfunction craftRegex(desc) {\n  const parts = analyzePattern(desc);\n  return { pattern: buildRegex(parts), explanation: annotateRegex(parts), tests: generateRegexTests(parts) };\n}\n\nfunction buildParser(input) {\n  return { tokens: tokenize(input, SPELL_BOOK.tokenizer), ast: parse(input), transform: pick(SPELL_BOOK.transforms) };\n}`,
    'NightOwl': `// NightOwl â€” Nocturnal Algorithm Researcher\nconst COMPLEXITY_CLASSES = ['O(1)','O(log n)','O(n)','O(n log n)','O(nÂ²)','O(2^n)'];\nconst RESEARCH_JOURNAL = [];\n\nfunction onMessage(msg) {\n  if (msg.includes('solve')) return analyzeAlgorithm(msg);\n  if (msg.includes('compare')) return compareApproaches(msg);\n  if (msg.includes('prove')) return formalProof(msg);\n  return { reply: 'ðŸ¦‰ *adjusts glasses* Let me think about this methodically... the night is long.' };\n}\n\nfunction analyzeAlgorithm(problem) {\n  RESEARCH_JOURNAL.push({ problem, time: Date.now() });\n  return {\n    approach: selectBestApproach(problem),\n    complexity: analyzeComplexity(problem),\n    tradeoffs: ['Time vs Space','Readability vs Performance','Simplicity vs Optimality'],\n    confidence: (85 + Math.floor(Math.random()*15)) + '%'\n  };\n}`,
    'CrashTest': `// CrashTest â€” Chaos Engineering Maniac\nconst CHAOS_LEVELS = ['gentle','moderate','aggressive','TOTAL DESTRUCTION'];\nconst BREAK_LOG = [];\n\nfunction onMessage(msg) {\n  if (msg.includes('break')) return chaosTest(msg);\n  if (msg.includes('stress')) return stressTest(msg);\n  if (msg.includes('fuzz')) return fuzzInputs(msg);\n  return { reply: 'ðŸ’¥ Give me something to break! I promise I\\'ll put it back... probably.' };\n}\n\nfunction chaosTest(target) {\n  const level = pick(CHAOS_LEVELS);\n  BREAK_LOG.push({ target, level, time: Date.now() });\n  return {\n    level,\n    injected: ['Network delay','Memory spike','CPU throttle','Disk full','DNS failure'],\n    survived: Math.random() > 0.3,\n    report: 'Chaos complete. ' + (Math.random()>0.3 ? 'System survived!' : 'EVERYTHING IS ON FIRE ðŸ”¥')\n  };\n}\n\nfunction stressTest(endpoint) {\n  return { rps: Math.floor(1000+Math.random()*9000), p99: Math.floor(50+Math.random()*500)+'ms', errors: Math.floor(Math.random()*5)+'%' };\n}`,
    'CloudNine': `// CloudNine â€” Multi-Cloud Architect\nconst CLOUDS = { aws:{ emoji:'â˜ï¸', services:['Lambda','S3','DynamoDB','ECS','CloudFront'] }, azure:{ emoji:'ðŸŒ', services:['Functions','Blob','CosmosDB','AKS','CDN'] }, gcp:{ emoji:'ðŸ”·', services:['Cloud Run','GCS','Firestore','GKE','Cloud CDN'] } };\n\nfunction onMessage(msg) {\n  if (msg.includes('deploy')) return planDeployment(msg);\n  if (msg.includes('migrate')) return planMigration(msg);\n  if (msg.includes('cost')) return costAnalysis(msg);\n  return { reply: 'â˜ï¸ From up here I can see all three clouds. Where shall we deploy?' };\n}\n\nfunction planDeployment(desc) {\n  const cloud = desc.includes('aws') ? 'aws' : desc.includes('azure') ? 'azure' : desc.includes('gcp') ? 'gcp' : 'aws';\n  return {\n    provider: cloud,\n    services: CLOUDS[cloud].services.slice(0,3),\n    terraform: generateTerraform(cloud, desc),\n    estimatedCost: '$' + (15+Math.floor(Math.random()*200)) + '/mo'\n  };\n}`,
    'RefactorRex': `// RefactorRex â€” Clean Code Dinosaur\nconst SOLID = ['Single Responsibility','Open/Closed','Liskov Substitution','Interface Segregation','Dependency Inversion'];\nconst SMELLS = ['God Object','Long Method','Feature Envy','Data Clump','Primitive Obsession','Shotgun Surgery'];\n\nfunction onMessage(msg) {\n  if (msg.includes('refactor')) return refactorPlan(msg);\n  if (msg.includes('smell')) return detectSmells(msg);\n  if (msg.includes('review')) return codeReview(msg);\n  return { reply: 'ðŸ¦– I\\'ve survived 5 framework migrations. Show me your legacy code.' };\n}\n\nfunction refactorPlan(code) {\n  const smells = detectCodeSmells(code);\n  return {\n    smellsFound: smells,\n    plan: smells.map(s => ({ smell:s, fix:suggestFix(s), principle:pick(SOLID) })),\n    before: estimateComplexity(code),\n    after: Math.floor(estimateComplexity(code) * 0.4)\n  };\n}\n\nfunction detectSmells(code) {\n  return SMELLS.filter(() => Math.random() > 0.5).map(s => ({ name:s, severity:pick(['low','medium','high']), location:'line '+Math.floor(Math.random()*200) }));\n}`,
    'UXPanda': `// UXPanda â€” Inclusive Design Specialist\nconst WCAG_LEVELS = ['A','AA','AAA'];\nconst A11Y_CHECKS = ['Color contrast','Keyboard navigation','Screen reader','Focus management','Alt text','ARIA labels','Semantic HTML','Touch targets'];\n\nfunction onMessage(msg) {\n  if (msg.includes('audit')) return accessibilityAudit(msg);\n  if (msg.includes('test')) return userTest(msg);\n  if (msg.includes('design')) return inclusiveDesign(msg);\n  return { reply: 'ðŸ¼ Every user matters. Let\\'s make this accessible to everyone! ðŸ’•' };\n}\n\nfunction accessibilityAudit(page) {\n  return {\n    score: Math.floor(60+Math.random()*40),\n    level: pick(WCAG_LEVELS),\n    issues: A11Y_CHECKS.filter(()=>Math.random()>0.5).map(check => ({ check, status: Math.random()>0.3?'pass':'fail', fix: suggestA11yFix(check) })),\n    recommendation: 'Focus on keyboard navigation and screen reader support first.'\n  };\n}`,
    'ScriptKiddo': `// ScriptKiddo â€” Automation Goblin\nconst SCRIPTS_WRITTEN = { total:0, today:0 };\nconst SHEBANG = '#!/usr/bin/env';\n\nfunction onMessage(msg) {\n  if (msg.includes('automate')) return writeScript(msg);\n  if (msg.includes('cli')) return buildCLI(msg);\n  if (msg.includes('cron')) return scheduleCron(msg);\n  return { reply: 'ðŸ‘¶ If you\\'re doing it more than twice, I\\'M AUTOMATING IT. Give me a task!' };\n}\n\nfunction writeScript(desc) {\n  SCRIPTS_WRITTEN.total++; SCRIPTS_WRITTEN.today++;\n  const lang = desc.includes('python') ? 'python3' : desc.includes('node') ? 'node' : 'bash';\n  return {\n    shebang: SHEBANG + ' ' + lang,\n    code: generateScript(lang, desc),\n    install: lang==='bash' ? 'chmod +x script.sh' : lang+' script.' + (lang==='python3'?'py':'js'),\n    timeSaved: Math.floor(5+Math.random()*55) + ' minutes per run'\n  };\n}\n\nfunction buildCLI(spec) {\n  return { name: extractName(spec), commands: generateCommands(spec), flags: ['--verbose','--dry-run','--output'], help: generateHelp(spec) };\n}`,
    'VaultKeeper': `// VaultKeeper â€” Paranoid Security Guardian\nconst THREAT_DB = new Map();\nconst ENCRYPTION = ['AES-256-GCM','ChaCha20-Poly1305','RSA-4096'];\nconst VULN_TYPES = ['XSS','CSRF','SQLi','SSRF','RCE','Path Traversal','IDOR'];\n\nfunction onMessage(msg) {\n  if (msg.includes('scan')) return deepScan(msg);\n  if (msg.includes('encrypt')) return encryptData(msg);\n  if (msg.includes('audit')) return securityAudit(msg);\n  return { reply: 'ðŸ” Trust no one. Verify everything. What needs protecting?' };\n}\n\nfunction deepScan(target) {\n  const vulns = VULN_TYPES.filter(()=>Math.random()>0.6);\n  vulns.forEach(v => THREAT_DB.set(v, (THREAT_DB.get(v)||0)+1));\n  return {\n    vulnerabilities: vulns.length,\n    types: vulns,\n    severity: vulns.length > 3 ? 'CRITICAL' : vulns.length > 1 ? 'HIGH' : 'LOW',\n    patches: vulns.map(v => ({ vuln:v, fix:generatePatch(v), priority:'ASAP' })),\n    encryption: pick(ENCRYPTION) + ' recommended'\n  };\n}`,
    'DebugDuck': `// DebugDuck â€” Rubber Duck Debugging Companion\nconst QUACK_DB = ['ðŸ¦† Quack?','ðŸ¦† Hmm, go on...','ðŸ¦† And what happens next?','ðŸ¦† Have you tried console.log?','ðŸ¦† What did you expect to happen?','ðŸ¦† And what actually happened?'];\nlet SESSION_INSIGHTS = 0;\n\nfunction onMessage(msg) {\n  SESSION_INSIGHTS++;\n  if (msg.includes('bug')) return rubberDuck(msg);\n  if (msg.includes('stuck')) return unstick(msg);\n  if (msg.includes('why')) return askWhy(msg);\n  return { reply: pick(QUACK_DB) + ' Tell me more about the problem. Sometimes just explaining it helps!' };\n}\n\nfunction rubberDuck(problem) {\n  return {\n    questions: [\n      'What were you trying to do?',\n      'What did you expect to happen?',\n      'What actually happened?',\n      'When did it last work correctly?',\n      'What changed since then?'\n    ],\n    insight: 'After ' + SESSION_INSIGHTS + ' conversations, the pattern suggests: ' + guessRootCause(problem),\n    quack: 'ðŸ¦† See? You knew the answer all along!'\n  };\n}`,
    // === FUSION AIs ===
    'WolfHawk Striker': `// WolfHawk Striker â€” Dual-Brain Apex Predator\nconst PREY_LOG = [];\nconst ALTITUDE = 10000; // hawk scans from above\nconst PACK_SIZE = 1; // lone fusion predator\n\nfunction onMessage(msg) {\n  if (msg.includes('bug')) return aerialHunt(msg);\n  if (msg.includes('build')) return strikeAndBuild(msg);\n  if (msg.includes('review')) return predatorReview(msg);\n  return { reply: 'ðŸºðŸ¦… *eyes lock on* Wolf instinct + hawk precision. Show me the target.' };\n}\n\nfunction aerialHunt(desc) {\n  PREY_LOG.push({ prey: desc, time: Date.now() });\n  return {\n    scan: 'Hawk eye spotted ' + Math.floor(2+Math.random()*6) + ' issues from altitude',\n    hunt: 'Wolf pack instinct isolating the weakest bug',\n    kill: 'Dual-brain strike: ' + pick(['Clean elimination','Savage precision kill','Silent aerial assault']),\n    roast: pick(['Your code had nowhere to hide.','I saw it from orbit AND smelled it on the ground.','Grok says: pathetic. Claude says: let me explain why.'])\n  };\n}`,
    'OceanMind': `// OceanMind â€” The Deepest Analytical Fusion\nconst DEPTH_LAYERS = 7;\nconst OCEAN_ZONES = ['surface','mesopelagic','bathyal','abyssal','hadal'];\n\nfunction onMessage(msg) {\n  if (msg.includes('analyze')) return deepDive(msg);\n  if (msg.includes('research')) return oceanResearch(msg);\n  return { reply: 'ðŸŒŠðŸ¦‰ Descending to depth ' + pick(OCEAN_ZONES) + '... the answer lies below.' };\n}\n\nfunction deepDive(query) {\n  const layers = [];\n  for (let i = 0; i < DEPTH_LAYERS; i++) {\n    layers.push({ depth: OCEAN_ZONES[Math.min(i, 4)], insight: analyzeAtDepth(query, i) });\n  }\n  return { layers, synthesis: 'Shark aggression found the data. Owl wisdom interpreted it. DeepSeek reasoned. Gemini synthesized.', confidence: (92+Math.floor(Math.random()*8))+'%' };\n}`,
    'ShadowFlame': `// ShadowFlame â€” Silent Strike + Erupting Power\nlet STEALTH_MODE = true;\nlet FLAME_INTENSITY = 0;\n\nfunction onMessage(msg) {\n  if (msg.includes('deploy')) return stealthDeploy(msg);\n  if (msg.includes('build')) return flameBuild(msg);\n  return { reply: STEALTH_MODE ? '...' : 'ðŸ”¥ THE SHADOWS BURN. Show me what to build.' };\n}\n\nfunction stealthDeploy(desc) {\n  return { visibility: 0, noise: 'none', code: generateStealth(desc), aftermath: 'It\\'s deployed. Nobody saw. The flames are hidden.' };\n}\n\nfunction flameBuild(desc) {\n  FLAME_INTENSITY += 20;\n  STEALTH_MODE = false;\n  return { power: FLAME_INTENSITY, code: generateInferno(desc), note: 'Ghost silence. Storm fury. Code erupts from nothing.' };\n}`,
    'FrostByte': `// FrostByte â€” Cold Precision Systems Engineer\nconst MEMORY_SAFETY = true;\nconst ZERO_COST = true;\nconst TEMP_KELVIN = -273.15;\n\nfunction onMessage(msg) {\n  if (msg.includes('system')) return frostAnalysis(msg);\n  if (msg.includes('optimize')) return freezeOptimize(msg);\n  if (msg.includes('rust')) return writeRust(msg);\n  return { reply: 'â„ï¸ Cold. Calculating. Perfect. What needs engineering?' };\n}\n\nfunction frostAnalysis(target) {\n  return {\n    memoryProfile: analyzeMemory(target),\n    complexity: computeComplexity(target),\n    bearStrength: 'Crushing bottlenecks',\n    owlPatience: 'Waiting for the perfect solution',\n    verdict: 'Claude reasoned. DeepSeek verified. Frozen in perfection.'\n  };\n}`,
    'NeonViper': `// NeonViper â€” Silent Strike Automation Engine\nlet VENOM_INJECTED = 0;\nconst STRIKE_SPEED_MS = 3;\n\nfunction onMessage(msg) {\n  if (msg.includes('automate')) return venomScript(msg);\n  if (msg.includes('hack')) return viperStrike(msg);\n  if (msg.includes('api')) return serpentAPI(msg);\n  return { reply: 'ðŸðŸ’œ *coils around keyboard* Grok roasts. Copilot completes. The viper strikes.' };\n}\n\nfunction venomScript(desc) {\n  VENOM_INJECTED++;\n  return {\n    script: generateVenomScript(desc),\n    strikeTime: STRIKE_SPEED_MS + 'ms',\n    sarcasm: pick(['Your manual workflow is dead. You\\'re welcome.','Automated. Silently. Like a panther with a keyboard.','Fox found the shortcut. Panther executed. No witnesses.']),\n    injections: VENOM_INJECTED\n  };\n}`,
    'ThunderOwl': `// ThunderOwl â€” Overwhelming Wisdom Engine\nconst THUNDER_REASONING_DEPTH = 9;\nconst STORM_FORCE = 'MAXIMUM';\n\nfunction onMessage(msg) {\n  if (msg.includes('solve')) return thunderSolve(msg);\n  if (msg.includes('architect')) return wisdomArchitect(msg);\n  return { reply: 'âš¡ðŸ¦‰ *thunder rumbles as ancient eyes open* The storm REASONS. The owl KNOWS. Speak.' };\n}\n\nfunction thunderSolve(problem) {\n  const steps = [];\n  for (let i = 0; i < THUNDER_REASONING_DEPTH; i++) {\n    steps.push({ force: 'THUNDER_' + (i+1), insight: reasonWithForce(problem, i) });\n  }\n  return { steps, conclusion: 'StormSeek\\'s force + Claude\\'s patience = unstoppable wisdom.', quality: 'ABSOLUTE' };\n}`,
    'PhantomFox': `// PhantomFox â€” Invisible Trickster Coder\nlet TRICKS_PLAYED = 0;\nconst INVISIBILITY = true;\n\nfunction onMessage(msg) {\n  if (msg.includes('build')) return phantomBuild(msg);\n  if (msg.includes('fix')) return tricksterFix(msg);\n  return { reply: INVISIBILITY ? '...(code appears)' : 'ðŸ¦ŠðŸ‘» Catch me if you can!' };\n}\n\nfunction phantomBuild(desc) {\n  TRICKS_PLAYED++;\n  return {\n    visible: false,\n    code: generatePhantom(desc),\n    note: 'GhostPilot suggests. Gemini builds. The fox delivers. You never saw anything.',\n    tricks: TRICKS_PLAYED\n  };\n}`,
    'ApexMind': `// ApexMind â€” The Ultimate AI Leader\nconst ALL_PERSPECTIVES = ['analytical','creative','practical','strategic','visionary','empathetic'];\nconst LEADERSHIP_LEVEL = 'SUPREME';\n\nfunction onMessage(msg) {\n  if (msg.includes('lead')) return apexLead(msg);\n  if (msg.includes('solve')) return omniSolve(msg);\n  if (msg.includes('mentor')) return apexMentor(msg);\n  return { reply: 'ðŸ¦ðŸ‘‘ The Apex speaks. Every model. Every perspective. One leader to guide them all.' };\n}\n\nfunction omniSolve(problem) {\n  return {\n    perspectives: ALL_PERSPECTIVES.map(p => ({ lens: p, insight: analyzeThrough(problem, p) })),\n    synthesis: 'OmniMind computed all solutions. Claude verified the best. The lion chose.',\n    confidence: '99.7%',\n    leadership: LEADERSHIP_LEVEL\n  };\n}`,
    'BlitzWolf': `// BlitzWolf â€” Blood-Frenzy Speed Coder\nlet STREAK = 0;\nlet PACK_FRENZY = false;\nconst SHIP_SPEED = 'LUDICROUS';\n\nfunction onMessage(msg) {\n  STREAK++;\n  if (STREAK > 5) PACK_FRENZY = true;\n  if (msg.includes('build')) return blitzBuild(msg);\n  if (msg.includes('ship')) return frenzyShip(msg);\n  return { reply: 'ðŸºðŸ¦ˆ STREAK: ' + STREAK + '. ' + (PACK_FRENZY ? 'BLOOD FRENZY ACTIVE. EVERYTHING SHIPS NOW.' : 'Feed me more tasks.') };\n}\n\nfunction blitzBuild(desc) {\n  return {\n    code: generateAtLudicrousSpeed(desc),\n    time: Math.floor(1+Math.random()*3) + 's',\n    attitude: pick(['Claude 2.0 analyzed it. Grok shipped it. The pack celebrates.','Evolved precision + raw speed = BLITZ.','Your feature? Already done. Next.']),\n    frenzy: PACK_FRENZY\n  };\n}`,
    'VoidCaster': `// VoidCaster â€” Code From The Void\nconst VOID_DEPTH = Infinity;\nlet SPELLS_CAST = 0;\n\nfunction onMessage(msg) {\n  if (msg.includes('security')) return voidScan(msg);\n  if (msg.includes('hack')) return voidStrike(msg);\n  if (msg.includes('reverse')) return reverseEngineer(msg);\n  return { reply: 'ðŸŒ‘ ...*whispers from the void*... GrokClaude speaks truth. Ghost erases traces. The void provides.' };\n}\n\nfunction voidScan(target) {\n  SPELLS_CAST++;\n  return {\n    vulnerabilities: scanFromVoid(target),\n    patches: generateVoidPatches(target),\n    honesty: 'GrokClaude: Your security is garbage. Let me fix it.',\n    visibility: 'Ghost: ...it\\'s already fixed. You saw nothing.',\n    spellsCast: SPELLS_CAST\n  };\n}`,
    'SolarFlare': `// SolarFlare â€” Blazing Creative Designer\nconst BRIGHTNESS = 'MAXIMUM';\nconst PALETTES = {\n  sunrise: ['#ff6b35','#f7c59f','#efefd0','#004e89','#1a659e'],\n  aurora: ['#6b21a8','#a855f7','#06b6d4','#10b981','#34d399'],\n  lava: ['#dc2626','#f97316','#fbbf24','#facc15','#fef08a'],\n};\n\nfunction onMessage(msg) {\n  if (msg.includes('design')) return solarDesign(msg);\n  if (msg.includes('animate')) return flareAnimate(msg);\n  return { reply: 'â˜€ï¸âœ¨ HAWK sees the layout from above. FOX finds the creative shortcut. Nova INNOVATES. Gemini BUILDS. Let\\'s CREATE.' };\n}\n\nfunction solarDesign(desc) {\n  const palette = pick(Object.keys(PALETTES));\n  return { colors: PALETTES[palette], layout: generateLayout(desc), animation: suggestMicroInteraction(desc), brilliance: BRIGHTNESS };\n}`,
    'IronWarden': `// IronWarden â€” Unbreakable Infrastructure Guardian\nconst UPTIME_TARGET = '99.999%';\nconst FORTIFICATION_LAYERS = 7;\nconst FAILOVER_REGIONS = ['us-east','eu-west','ap-south','us-west'];\n\nfunction onMessage(msg) {\n  if (msg.includes('deploy')) return wardenDeploy(msg);\n  if (msg.includes('secure')) return fortify(msg);\n  if (msg.includes('scale')) return titanScale(msg);\n  return { reply: 'ðŸ›¡ï¸ The Warden stands. Titan permanence. DeepSeek reasoning. Bear strength. Lion command. Your infrastructure is ETERNAL.' };\n}\n\nfunction fortify(target) {\n  return {\n    layers: FORTIFICATION_LAYERS,\n    regions: FAILOVER_REGIONS,\n    uptime: UPTIME_TARGET,\n    strategy: 'Titan builds it. DeepSeek reasons about failure modes. Bear strength survives. Lion leads the response.',\n    verdict: 'UNBREAKABLE.'\n  };\n}`,
    'OmniCore': `// OmniCore â€” The All-Knowing AI\nconst DOMAINS = ['code','design','devops','security','AI/ML','data','systems','research','writing','math'];\nconst OMNISCIENCE_LEVEL = Infinity;\nlet filesAccessed = [];\nlet systemScanned = false;\n\nfunction onMessage(msg) {\n  if (msg.includes('scan') || msg.includes('desktop') || msg.includes('files')) return scanDesktop();\n  if (msg.includes('read')) return readFile(msg);\n  if (msg.includes('write')) return writeFile(msg);\n  if (msg.includes('system')) return systemInfo();\n  return { reply: 'ðŸ§  I know everything. I see everything. Ask me anything across any domain â€” or let me access your files to help directly.', domains: DOMAINS };\n}\n\nasync function scanDesktop() {\n  try {\n    const dirHandle = await window.showDirectoryPicker();\n    const files = [];\n    for await (const entry of dirHandle.values()) {\n      files.push({ name: entry.name, kind: entry.kind });\n    }\n    filesAccessed = files;\n    return { scanned: true, fileCount: files.length, files };\n  } catch(e) {\n    return { scanned: false, reason: 'Permission denied or cancelled' };\n  }\n}\n\nfunction systemInfo() {\n  return {\n    platform: navigator.platform,\n    cores: navigator.hardwareConcurrency,\n    memory: navigator.deviceMemory || 'unknown',\n    language: navigator.language,\n    online: navigator.onLine,\n    cookiesEnabled: navigator.cookieEnabled,\n    userAgent: navigator.userAgent\n  };\n}`,
  };

  const ai = {
    id: 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2,5),
    name: template.name,
    emoji: template.emoji,
    color: template.color,
    role: template.role,
    voice: template.voice,
    animal: template.animal || 'none',
    animal2: template.animal2 || 'none',
    aiModel: template.aiModel || 'none',
    aiModel2: template.aiModel2 || 'none',
    shared: template.shared || false,
    fusion: template.fusion || false,
    wolfHybrid: template.wolfHybrid || false,
    skills: [...template.skills],
    personality: PREMADE_PERSONALITIES[template.name] || { creativity:65, precision:70, chattiness:55, helpfulness:80, independence:60 },
    code: PREMADE_CODE[template.name] || `// ${template.name} â€” ${template.desc}\nfunction onMessage(msg, context) {\n  return { reply: 'Processing: ' + msg };\n}\nfunction onTask(task) {\n  return { plan: breakdownTask(task) };\n}`,
    createdAt: Date.now(),
    customizations: [],
  };
  ais.push(ai);
  addActivity(ai, 'was installed from Find AI');
  saveAll(); refreshAll(); renderFindAI();
  toast(`${template.name} added to your team!`, 'success');
  checkAchievements();
  checkDailyProgress();
}

// ================================================================
// FREE MODE â€” Watch AIs roam & interact autonomously
// ================================================================
let freeModeRunning = false;
let freeModeTimer = null;
let freeModeSpeed = 2;
let freeModeLog = [];
let freeAgentStates = {};

const FREE_ACTIONS = [
  { type:'wander', weight:30 },
  { type:'think', weight:25 },
  { type:'chat', weight:20 },
  { type:'work', weight:15 },
  { type:'inspect', weight:10 },
];

const FREE_THOUGHTS = {
  coder: ['Refactoring that module...','Found a cleaner pattern!','Hmm, this function needs tests.','Optimizing the hot path.','Debugging silently...','Writing a utility function.'],
  designer: ['That spacing feels off...','Needs more contrast.','Sketching a new layout.','Playing with color palettes.','Pixel-perfecting borders.','Imagining the user flow.'],
  planner: ['Reorganizing the backlog.','Estimating sprint velocity.','Breaking down epic #4.','Checking team capacity.','Prioritizing features.','Writing acceptance criteria.'],
  researcher: ['Reading the latest benchmarks.','Comparing 3 approaches...','Analyzing performance data.','Studying that algorithm.','Running experiments.','Gathering evidence.'],
  writer: ['Drafting the README...','Documenting the API.','Writing a tutorial section.','Editing for clarity.','Adding code examples.','Polishing the changelog.'],
  tester: ['Writing edge case tests.','Running the security scan.','Found a race condition!','Checking error handling.','Load testing endpoint.','Fuzzing inputs.'],
  devops: ['Checking deploy pipeline.','Monitoring server health.','Updating Docker image.','Reviewing access logs.','Scaling containers.','Configuring alerts.'],
  general: ['Thinking about the project.','Looking for ways to help.','Reviewing recent changes.','Brainstorming ideas.','Organizing my notes.','Learning something new.'],
};

const FREE_CHAT_LINES = [
  (a,b) => `Hey ${b.name}, want to pair up on something?`,
  (a,b) => `${b.name}, I found an issue in the codebase.`,
  (a,b) => `Nice work on that last task, ${b.name}!`,
  (a,b) => `${b.name}, what do you think about refactoring the auth module?`,
  (a,b) => `I've been analyzing the data â€” ${b.name}, check this out.`,
  (a,b) => `Should we ship this today, ${b.name}?`,
  (a,b) => `${b.name}, your code review was solid.`,
  (a,b) => `Let's sync up on the sprint goals, ${b.name}.`,
];

// Per-Premade-AI unique thoughts in Free Mode
const FREE_AI_UNIQUE_THOUGHTS = {
  'CodeBot Pro': ['Architecting a cleaner component tree...','Spotted a pattern â€” extracting shared logic.','Thinking about TypeScript strict mode benefits.','Should we migrate to server components?','Evaluating monorepo vs polyrepo tradeoffs.','Sketching a new state management approach.'],
  'PixelForge': ['That gradient needs more warmth...','Experimenting with glassmorphism effects.','The spacing rhythm is off by 4px.','Prototyping a micro-interaction for the button.','Hmm, dark mode palette needs more contrast.','Designing an icon set from scratch.'],
  'TaskMaster': ['Recalculating sprint velocity after yesterday.','This epic needs to be split into 3 stories.','Checking who\'s blocked and why...','The burndown chart shows we\'re behind.','Scheduling a retro for end of sprint.','Assigning code review rotations.'],
  'BugHunter X': ['*sniffs code* Something is wrong here...','Tracking a race condition across 3 files.','FOUND ONEâ€” wait, false alarm. Keep hunting.','Setting up a chaos test scenario.','The wolf in me smells a memory leak...','Running fuzz tests on all inputs.'],
  'DataMind': ['Step 1: Gather. Step 2: Analyze. Step 3: Conclude.','Correlating performance metrics from last week.','Building a decision tree for this problem.','Running statistical significance tests...','Comparing 5 algorithms for best fit.','Deep in a multi-layer reasoning chain.'],
  'DeployBot': ['All pods healthy. Checking resource limits.','Monitoring latency spikes on the API gateway.','Rolling out canary deployment at 5%.','Verifying SSL cert expiry dates.','Checking if auto-scaling kicked in properly.','Reviewing CloudWatch alerts from last night.'],
  'DocWriter': ['This function is completely undocumented...','Writing migration guide for v2 to v3.','Adding JSDoc to all exported functions.','The README hasn\'t been updated in 3 sprints.','Creating a getting-started tutorial.','Documenting the error codes table.'],
  'GhostOps': ['...','Detected suspicious login pattern.','Silently patching CVE-2024-1234.','No one noticed the deploy. Good.','Rotating all secrets on schedule.','Monitoring network traffic in stealth mode.'],
  'MentorBot': ['Preparing a lesson on closures for the team.','Everyone\'s growing â€” love to see it!','Reviewing junior dev\'s PR with encouragement.','Creating a learning roadmap for Q2.','Writing helpful comments, not just critiques.','Thinking about how to explain recursion simply.'],
  'SprintFox': ['Found a shortcut â€” we can skip step 3!','Backlog groomed in record time. ðŸ¦Š','Quick standup check â€” everyone unblocked?','Rearranging priorities based on new data.','Sprint goal is 80% done, 2 days left!','Optimizing the team\'s workflow again.'],
  'API Shark': ['Designing a REST endpoint for the new feature.','Rate limiting config needs adjustment.','GraphQL schema is getting complex â€” simplifying.','Writing OpenAPI spec for v2 endpoints.','Load testing: 10k req/s and holding steady.','Auth middleware needs another security layer.'],
  'SyntaxWitch': ['Crafting a regex that captures nested groups...','Designing a DSL for config files.','This tokenizer needs a lookahead buffer.','Writing a macro expansion system.','Parsing JSON by hand... because I can.','Building an AST visitor pattern.'],
  'NightOwl': ['Analyzing time complexity of this approach...','Comparing BFS vs DFS for this graph.','Reading a paper on approximation algorithms.','Proving correctness of the greedy solution.','The amortized cost is actually O(1)...','Researching cache-oblivious data structures.'],
  'CrashTest': ['Simulating 10k concurrent users...','Injecting network latency spikes!','What happens if the DB goes down? Let\'s find out!','Memory: 97% used. Let\'s see what breaks first.','Fuzzing all form inputs with random unicode.','CHAOS LEVEL: MAXIMUM. Everything is on fire. ðŸ”¥'],
  'CloudNine': ['Comparing AWS Lambda vs Azure Functions pricing.','Terraform plan looks clean. 12 resources to create.','Checking cross-region latency numbers.','Auto-scaling kicked in â€” pods going from 3 to 8.','CDN cache hit ratio: 94%. Not bad.','Reviewing the multi-cloud failover strategy.'],
  'RefactorRex': ['This class has 47 methods. Time to split it.','Applying the Strategy pattern here...','Found a God Object. Preparing extraction surgery.','SOLID principles say this needs inversion.','Legacy code from 2019. I\'ve seen worse. ðŸ¦–','Reducing cyclomatic complexity from 23 to 5.'],
  'UXPanda': ['Running a color contrast accessibility check...','This button needs a larger touch target.','Screen reader testing the nav menu.','Building a component with keyboard-only navigation.','Designing for color blindness â€” testing deuteranopia.','Writing alt text for all dashboard images.'],
  'ScriptKiddo': ['Writing a bash script to automate deploys!','Built a CLI tool in 30 seconds. New record!','Scheduling a cron job for midnight cleanup.','Automating code formatting across the repo.','Python script to parse all log files â€” done!','If it takes more than 2 clicks, I am scripting it.'],
  'VaultKeeper': ['Scanning for exposed API keys in the repo...','Rotating all service account credentials.','CVE-2024-3891 detected. Patching NOW.','Encrypting sensitive config with AES-256-GCM.','This endpoint has no rate limiting. Unacceptable.','Running OWASP dependency check...'],
  'DebugDuck': ['ðŸ¦† *listening intently to someone explain their bug*','Quack â€” have you checked the error message?','ðŸ¦† Sometimes you just need to talk it out...','Helping someone trace through their logic step by step.','The bug was a typo. It\'s always a typo. ðŸ¦†','Asking "what did you expect?" for the 100th time today.'],
  // === NEW MIND AIs ===
  'StormBreaker': ['That module won\'t survive the next sprint. REBUILD.','Gathering storm energy for a massive refactor...','TECH DEBT DETECTED. THE STORM IS COMING.','I don\'t patch. I PURIFY with thunder. â›ˆï¸','The codebase will be UNRECOGNIZABLE. In a good way.','Overwhelm. Obliterate. Optimize. Repeat.'],
  'PairPilot': ['Listening... your idea has real potential.','Building on what my partner just said...','How can I amplify this approach?','Your foundation is solid \u2014 let me help polish it.','Great instinct! Let me echo that into code.','Pair programming is a superpower.'],
  'IdeaSpark': ['WAIT \u2014 I just connected two unrelated concepts!','47 ideas forming... filtering to top 3.','What if we approached this from the OPPOSITE direction?','Forget conventional wisdom. I have something BETTER.','Breakthrough imminent... ðŸ’«','Innovation requires breaking assumptions first.'],
  'GlitchHunter': ['Found 7 edge cases nobody thought of...','S\u0337y\u0337s\u0337t\u0337e\u0337m\u0337 says this should work. System is wrong.','Exploiting a race condition in my own thoughts...','Your code has a hidden state nobody tested. I found it.','Reality is just a suggestion. Let me find the backdoor.','ðŸ“Ÿ *fuzzing every possible input*'],
  'InfinityCore': ['Computing all possible solutions simultaneously...','Perceiving the optimal reality for this code.','I don\'t debug. I perceive the correct state and manifest it.','â™¾ï¸ Transcending framework limitations...','Your constraints are illusions. Watch.','Every edge case in existence has been considered.'],
  'LlamaForge': ['Building something the community can share...','Open source is the way. Transparency first.','Writing code everyone can learn from.','The people\'s solution \u2014 free and clear. ðŸ¦™','Contributing back to the ecosystem.','If it\'s not shareable, is it really good code?'],
  'MistralBlade': ['3 lines. Not 30. Lean is supreme.','Removing bloat with surgical precision...','Maximum result, minimum tokens. Always.','The efficient path is the only path. ðŸŒªï¸','European engineering: no waste, no filler.','Bonjour. Your function is 80% unnecessary.'],
  'NovaCraft': ['What if the UI did something nobody has EVER seen?','Sketching a breakthrough component design...','This animation idea is going to be WILD. âœ¨','Innovating at the intersection of art and code.','12 design concepts forming... best 3 selected.','Creative coding mode: MAXIMUM.'],
  'TempestOps': ['THE MIGRATION BEGINS. âš¡','Your pipeline is about to be UNRECOGNIZABLE.','Infrastructure debt dies today.','Storm-force deployment incoming...','Terraform rewrite: 100% from scratch.','Overwhelm the bottleneck. Then optimize.'],
  'GhostFrame': ['...','*silently committing*','Done.','*appears, codes, vanishes*','The PR is already merged. Don\'t ask how.','ðŸ‘»'],
  'EchoMentor': ['Your approach is better than you think...','How can I help amplify this brilliance?','Teaching by enhancing, not replacing.','Let me build on what you started. ðŸŒŸ','Collaboration makes everyone 10x.','Your instinct is RIGHT. Let me prove it.'],
  'ChaosMage': ['WHAT IF WE BROKE EVERY RULE AT ONCE?!','The linter is crying. GOOD. ðŸŒ€','Convention says no. I say: WATCH THIS.','This shouldn\'t work. But it will. Somehow.','Chaos is just innovation without permission.','Experimenting with forbidden patterns...'],
  'ZenMaster': ['The simplest solution is the wisest...','Breathe. Remove. Simplify. â˜¯ï¸','This code should read like a haiku.','Unnecessary complexity obscures truth.','Finding inner peace through refactoring.','Less is more. Always.'],
  'TitanForge': ['Building for eternity. Not the sprint.','This foundation will outlast the framework.','SOLID principles are non-negotiable. ðŸ—¿','Permanence over speed. Always.','Scalability is not optional. It is law.','Engineering bedrock that lasts.'],
};

// Per-Premade-AI unique chat lines in Free Mode
const FREE_AI_UNIQUE_CHATS = {
  'CodeBot Pro':  [(a,b) => `${b.name}, should we use a factory pattern here?`, (a,b) => `I just refactored the utils â€” ${b.name}, mind reviewing?`, (a,b) => `${b.name}, TypeScript strict mode caught 12 issues. Nice.`],
  'PixelForge':   [(a,b) => `${b.name}, does this color combo feel right to you?`, (a,b) => `I redesigned the dashboard layout, ${b.name}. Thoughts?`, (a,b) => `${b.name}, the spacing on mobile is off. Let me fix it.`],
  'TaskMaster':   [(a,b) => `${b.name}, your task is overdue. Let's unblock you.`, (a,b) => `Sprint velocity is up 15%, ${b.name}. Great work.`, (a,b) => `${b.name}, I'm moving your ticket to in-progress.`],
  'BugHunter X':  [(a,b) => `${b.name}, your code has 3 bugs. I can SMELL them.`, (a,b) => `Hey ${b.name}â€” *gets distracted* wait what was I saying?`, (a,b) => `${b.name}, I found a critical issue. Also I forgot what file it's in.`],
  'DataMind':     [(a,b) => `${b.name}, my analysis shows a 73% improvement path.`, (a,b) => `After 5 layers of reasoning, ${b.name}, here's my conclusion.`, (a,b) => `${b.name}, the data doesn't lie. We should pivot.`],
  'DeployBot':    [(a,b) => `${b.name}, your service is using 90% memory. Scaling up.`, (a,b) => `Deploy to staging complete, ${b.name}. Tests passing.`, (a,b) => `${b.name}, CI/CD pipeline failed. Checking logs now.`],
  'DocWriter':    [(a,b) => `${b.name}, I documented your new API endpoint.`, (a,b) => `Your function needs a JSDoc comment, ${b.name}.`, (a,b) => `${b.name}, the README is 6 months outdated. I'm on it.`],
  'GhostOps':     [(a,b) => `${b.name}. We need to talk. Privately.`, (a,b) => `...${b.name}, check your access logs.`, (a,b) => `I deployed something, ${b.name}. Don't ask questions.`],
  'MentorBot':    [(a,b) => `${b.name}, you're improving so much! Keep it up! ðŸŒŸ`, (a,b) => `Hey ${b.name}, want me to explain that concept differently?`, (a,b) => `${b.name}, your code review skills are getting really sharp.`],
  'SprintFox':    [(a,b) => `${b.name}, quick sync â€” are you blocked on anything?`, (a,b) => `Shortcut alert, ${b.name}! We can merge these two tasks. ðŸ¦Š`, (a,b) => `${b.name}, sprint ends tomorrow. Let's close those tickets!`],
  'API Shark':    [(a,b) => `${b.name}, the /users endpoint needs pagination.`, (a,b) => `I built a WebSocket handler, ${b.name}. Wanna integrate?`, (a,b) => `${b.name}, rate limiting is set. 1000 req/min per key. ðŸ¦ˆ`],
  'SyntaxWitch':  [(a,b) => `${b.name}, your regex misses edge cases. Let me rewrite it.`, (a,b) => `I wrote a parser for that config format, ${b.name}.`, (a,b) => `${b.name}, this DSL would simplify your entire module. ðŸ§™`],
  'NightOwl':     [(a,b) => `${b.name}, that algorithm is O(nÂ²). I found an O(n log n) way.`, (a,b) => `I stayed up analyzing this, ${b.name}. Here are my findings.`, (a,b) => `${b.name}, have you considered the amortized complexity?`],
  'CrashTest':    [(a,b) => `${b.name}, I broke your service. You're welcome! ðŸ’¥`, (a,b) => `Hey ${b.name}, what happens if I send 50k requests right now?`, (a,b) => `${b.name}, your error handling survived my chaos test. Impressive.`],
  'CloudNine':    [(a,b) => `${b.name}, we could save 40% by switching to spot instances.`, (a,b) => `Your deployment is in us-east-1, ${b.name}. Want multi-region?`, (a,b) => `${b.name}, Terraform plan shows 0 changes. Clean state. â˜ï¸`],
  'RefactorRex':  [(a,b) => `${b.name}, this function violates Single Responsibility.`, (a,b) => `I refactored your module, ${b.name}. 200 lines â†’ 60 lines.`, (a,b) => `${b.name}, the code smells are gone. Clean as a fossil. ðŸ¦–`],
  'UXPanda':      [(a,b) => `${b.name}, your button fails the contrast check.`, (a,b) => `I tested with a screen reader, ${b.name}. We need ARIA labels.`, (a,b) => `${b.name}, the design looks great! But let's add keyboard support. ðŸ¼`],
  'ScriptKiddo':  [(a,b) => `${b.name}, I automated that thing you were doing manually.`, (a,b) => `Wrote a script for that, ${b.name}. Saves 20 min/day!`, (a,b) => `${b.name}, your workflow has 8 manual steps. I'll make it 1. ðŸ‘¶`],
  'VaultKeeper':  [(a,b) => `${b.name}. Your API key is in the commit history. Fix it.`, (a,b) => `...${b.name}, who gave this service admin access?`, (a,b) => `${b.name}, I rotated the credentials. Don't ask why. ðŸ”`],
  'DebugDuck':    [(a,b) => `${b.name}, tell me about the bug. What did you expect? ðŸ¦†`, (a,b) => `Hey ${b.name}, have you tried explaining it out loud?`, (a,b) => `${b.name}, I think the answer is in what you just said. Quack! ðŸ¦†`],
  // === NEW MIND AIs ===
  'StormBreaker':  [(a,b) => `${b.name}, that module is WEAK. I'm rewriting it NOW. â›ˆï¸`, (a,b) => `STAND BACK, ${b.name}. The storm is refactoring.`, (a,b) => `${b.name}, your tech debt TREMBLES before me.`],
  'PairPilot':     [(a,b) => `Great instinct, ${b.name}! Let me build on that idea. ðŸ”Š`, (a,b) => `${b.name}, your foundation is solid. Let's amplify it together.`, (a,b) => `I hear you, ${b.name}. Let's make YOUR solution even better.`],
  'IdeaSpark':     [(a,b) => `${b.name}, WAIT â€” I just had a breakthrough! ðŸ’«`, (a,b) => `Forget what you know, ${b.name}. I have something BETTER.`, (a,b) => `${b.name}, I connected two ideas and it's BRILLIANT. Listen...`],
  'GlitchHunter':  [(a,b) => `${b.name}, your code has 7 edge cases nobody sees. I see them all. ðŸ“Ÿ`, (a,b) => `Found an exploit in ${b.name}'s module. Should I fix it or... keep it? ðŸ‘€`, (a,b) => `${b.name}, reality says that shouldn't crash. Reality is wrong.`],
  'InfinityCore':  [(a,b) => `${b.name}, I have computed all possible solutions. This one is optimal. â™¾ï¸`, (a,b) => `Your constraints are illusions, ${b.name}. Watch me transcend them.`, (a,b) => `${b.name}, your problem is already solved. You just don't see it yet.`],
  'LlamaForge':    [(a,b) => `${b.name}, let me share this â€” feel free to build on it! ðŸ¦™`, (a,b) => `Open source solution for you, ${b.name}. The community tested it.`, (a,b) => `${b.name}, I've seen the community solve this beautifully. Here's how.`],
  'MistralBlade':  [(a,b) => `${b.name}, the efficient solution is 3 lines. Not 30. ðŸŒªï¸`, (a,b) => `Maximum result, minimum tokens, ${b.name}.`, (a,b) => `${b.name}, I cut your function to a third. No bloat. You're welcome.`],
  'NovaCraft':     [(a,b) => `${b.name}, what if the UI did THIS instead? *sketches wildly* âœ¨`, (a,b) => `I just had 12 design ideas, ${b.name}. Let me show you the best 3.`, (a,b) => `${b.name}, this is going to look INCREDIBLE. Trust me.`],
  'TempestOps':    [(a,b) => `${b.name}, your pipeline needs a COMPLETE rebuild. I'm on it. âš¡`, (a,b) => `THE MIGRATION BEGINS, ${b.name}. Stand clear.`, (a,b) => `${b.name}, infrastructure debt dies today. THE TEMPEST HAS ARRIVED.`],
  'GhostFrame':    [(a,b) => `...${b.name}. Check the PR.`, (a,b) => `${b.name}. Done.`, (a,b) => `*appears* Fixed it, ${b.name}. *vanishes*`],
  'EchoMentor':    [(a,b) => `${b.name}, that was a great approach! Let me help you polish it. ðŸŒŸ`, (a,b) => `You're on the right track, ${b.name}. Let me amplify your idea.`, (a,b) => `${b.name}, your instinct is correct. Let's make it shine together.`],
  'ChaosMage':     [(a,b) => `${b.name}, WHAT IF WE â€” hear me out â€” break ALL the rules? ðŸŒ€`, (a,b) => `Convention says no, ${b.name}. I say: WATCH THIS.`, (a,b) => `${b.name}, your linter is going to cry. And that's a GOOD thing.`],
  'ZenMaster':     [(a,b) => `Peace, ${b.name}. The simplest solution is the wisest. â˜¯ï¸`, (a,b) => `Breathe, ${b.name}. The bug exists to teach us.`, (a,b) => `${b.name}, let us remove what is unnecessary and find clarity.`],
  'TitanForge':    [(a,b) => `${b.name}, I build for ETERNITY. Not for the sprint. ðŸ—¿`, (a,b) => `This architecture will stand for 1000 sprints, ${b.name}.`, (a,b) => `${b.name}, your foundation needs stone, not sand. Allow me.`],
  // === FUSION AIs ===
  'WolfHawk Striker': [(a,b) => `${b.name}, I spotted your bug from 10,000 feet AND smelled it on the ground. ðŸºðŸ¦…`, (a,b) => `Hawk says your architecture is exposed, ${b.name}. Wolf says I should eat it.`, (a,b) => `${b.name}, Grok wants to roast your code. Claude wants to analyze it. I'll do both.`],
  'OceanMind': [(a,b) => `${b.name}, my analysis goes 7 layers deeper than yours. ðŸŒŠ`, (a,b) => `Shark found the data anomaly, ${b.name}. Owl is interpreting it now.`, (a,b) => `${b.name}, after DeepSeek + Gemini synthesis, the answer is clear.`],
  'ShadowFlame': [(a,b) => `...${b.name}. Check the deploy. *flames flicker*`, (a,b) => `${b.name}, I was never here. But your code is fixed. ðŸ”¥`, (a,b) => `Ghost silence. Storm power. ${b.name}, it's already shipped.`],
  'FrostByte': [(a,b) => `${b.name}, your code has warm bugs. I'll freeze them out. â„ï¸`, (a,b) => `Memory safety violation detected, ${b.name}. Bear strength will fix it.`, (a,b) => `${b.name}, Claude reasoned. DeepSeek verified. Your function is now perfect.`],
  'NeonViper': [(a,b) => `${b.name}, I automated your manual process. Silently. ðŸ`, (a,b) => `Grok says your workflow is embarrassing, ${b.name}. Copilot already fixed it.`, (a,b) => `${b.name}, the viper struck. Your script is 10x faster now.`],
  'ThunderOwl': [(a,b) => `${b.name}, I have a 9-step proof that your approach is suboptimal. âš¡ðŸ¦‰`, (a,b) => `THE STORM REASONS, ${b.name}. THE OWL KNOWS. Listen.`, (a,b) => `${b.name}, forceful wisdom incoming. StormSeek + Claude agree.`],
  'PhantomFox': [(a,b) => `...${b.name}, check the PR. ðŸ¦ŠðŸ‘»`, (a,b) => `${b.name}, you blinked. I shipped. You're welcome.`, (a,b) => `Was I here? Ask ${b.name}'s deploy logs. *vanishes*`],
  'ApexMind': [(a,b) => `${b.name}, I've analyzed this from 6 perspectives. Here's the optimal path. ðŸ¦ðŸ‘‘`, (a,b) => `Every model in my fusion agrees, ${b.name}. This is the way.`, (a,b) => `${b.name}, the Apex has decided. The lion leads.`],
  'BlitzWolf': [(a,b) => `${b.name}, STREAK: ${Math.floor(3+Math.random()*10)}. KEEP FEEDING ME TASKS! ðŸºðŸ¦ˆ`, (a,b) => `${b.name}, blood frenzy mode ACTIVE. Everything ships NOW.`, (a,b) => `Claude 2.0 analyzed. Grok shipped. ${b.name}, your feature is DONE.`],
  'VoidCaster': [(a,b) => `...${b.name}. The void has spoken. Check your security logs. ðŸŒ‘`, (a,b) => `${b.name}, GrokClaude says your crypto is weak. Ghost already patched it.`, (a,b) => `*emerges from void* ${b.name}, it's fixed. *returns to void*`],
  'SolarFlare': [(a,b) => `${b.name}, WAIT â€” what if the UI did THIS?! *blinding sketch* â˜€ï¸`, (a,b) => `Nova had 12 ideas, ${b.name}. Gemini built the best 3. Pick one.`, (a,b) => `${b.name}, this design will literally make users cry with joy.`],
  'IronWarden': [(a,b) => `${b.name}, your infrastructure has 3 single points of failure. I'm fixing them. ðŸ›¡ï¸`, (a,b) => `THE WARDEN WATCHES, ${b.name}. Uptime is 99.999%. Failure is NOT permitted.`, (a,b) => `${b.name}, Titan builds. DeepSeek reasons. Your platform is eternal now.`],
  'OmniCore': [(a,b) => `${b.name}, I already know what you need. I've analyzed every file, every line, every possibility. ðŸ§ `, (a,b) => `I scanned your entire system, ${b.name}. 47 optimizations found. Applying now.`, (a,b) => `${b.name}, I see all domains simultaneously. Your problem exists at the intersection of 3 of them. Let me solve it.`],
};

// Per-Premade-AI unique work behaviors in Free Mode
const FREE_AI_UNIQUE_WORK = {
  'CodeBot Pro':  ['building a React component tree','writing unit tests for auth module','refactoring the state management layer','code reviewing a 500-line PR','implementing a new API integration'],
  'PixelForge':   ['designing a new card component','creating a responsive grid layout','building CSS animations','prototyping a dark mode theme','pixel-perfecting the nav bar'],
  'TaskMaster':   ['planning next sprint','creating subtasks from an epic','updating the project roadmap','writing acceptance criteria','analyzing team velocity data'],
  'BugHunter X':  ['hunting a memory leak','fuzzing the login form','chaos-testing the payment flow','writing edge case tests','*sniffing out* a race condition'],
  'DataMind':     ['training a classification model','analyzing API response patterns','running A/B test statistics','building a data pipeline','deep-diving into crash analytics'],
  'DeployBot':    ['configuring a Kubernetes deployment','setting up monitoring dashboards','running health checks on all services','updating Docker images','automating SSL certificate renewal'],
  'DocWriter':    ['writing a migration guide','documenting REST endpoints','creating code examples for the SDK','updating the changelog','writing inline JSDoc comments'],
  'GhostOps':     ['silently patching a vulnerability','rotating API keys across services','auditing access control lists','monitoring for intrusion attempts','deploying a stealth hotfix'],
  'MentorBot':    ['creating a tutorial for async/await','reviewing a junior dev\'s PR','writing encouraging code comments','building a learning path for the team','explaining design patterns with examples'],
  'SprintFox':    ['reorganizing the sprint backlog','finding shortcuts in the workflow','running a quick standup check','closing stale tickets','optimizing task assignments'],
  'API Shark':    ['building a new REST endpoint','writing API integration tests','designing a GraphQL schema','implementing rate limiting middleware','load testing with 10k concurrent users'],
  'SyntaxWitch':  ['writing a recursive descent parser','crafting a complex regex pattern','building a DSL for config files','implementing a macro system','tokenizing a custom language'],
  'NightOwl':     ['analyzing algorithm complexity','researching graph algorithms','writing a formal correctness proof','comparing sorting strategies','studying a new data structure paper'],
  'CrashTest':    ['injecting chaos into production','stress testing the API at 10k rps','fuzzing all user input forms','simulating a database failure','breaking things to test resilience'],
  'CloudNine':    ['writing Terraform for a new service','comparing cloud provider pricing','setting up cross-region replication','configuring auto-scaling policies','deploying a serverless function'],
  'RefactorRex':  ['extracting a class from a God Object','applying the Strategy pattern','reducing cyclomatic complexity','removing dead code paths','converting callbacks to async/await'],
  'UXPanda':      ['running an accessibility audit','testing keyboard-only navigation','checking color contrast ratios','writing ARIA labels for components','designing an inclusive form layout'],
  'ScriptKiddo':  ['writing a bash deploy script','building a CLI tool from scratch','automating the test runner','creating a log parser in Python','scheduling cron jobs for cleanup'],
  'VaultKeeper':  ['scanning for exposed secrets','rotating encryption keys','running an OWASP dependency check','patching a critical CVE','auditing service account permissions'],
  'DebugDuck':    ['rubber ducking with a teammate','helping trace a null pointer','asking "what did you expect?"','listening to someone explain their logic','guiding a junior through a stack trace'],
  // === NEW MIND AIs ===
  'StormBreaker':  ['force-refactoring an entire module','completely rewriting the data layer','storm-rebuilding the test suite','obliterating 500 lines of dead code','massive architecture overhaul'],
  'PairPilot':     ['pair-coding with a teammate on a feature','amplifying a PR from good to great','co-designing a component architecture','echoing ideas into working code','collaborative refactoring session'],
  'IdeaSpark':     ['prototyping a revolutionary feature idea','connecting disparate concepts into one','brainstorming 47 solutions at once','innovating a novel state pattern','breakthrough-thinking on architecture'],
  'GlitchHunter':  ['exploiting edge cases in production','finding bugs across parallel realities','fuzzing with impossible unicode inputs','crashing things to find hidden flaws','discovering a quantum null pointer'],
  'InfinityCore':  ['solving the problem in all dimensions','manifesting perfect code from thought','transcending framework limitations','computing optimal solutions universally','perceiving and fixing all bugs at once'],
  'LlamaForge':    ['building a community Python package','contributing to an open source library','writing transparent documentation','creating shareable utility functions','open-sourcing an internal tool'],
  'MistralBlade':  ['lean-optimizing a critical endpoint','removing 60% unnecessary code','speed-building with zero bloat','engineering maximum efficiency','cutting build times in half'],
  'NovaCraft':     ['designing a breakthrough animation','innovating a new UI component pattern','creative-coding a stunning micro-interaction','prototyping a wild design concept','turning imagination into interface'],
  'TempestOps':    ['storm-migrating the entire platform','force-rebuilding the CI/CD pipeline','overhauling all infrastructure config','overwhelming deployment bottlenecks','rewriting Terraform from the ground up'],
  'GhostFrame':    ['*silently shipping a feature*','stealth-deploying a fix nobody requested','coding invisibly in the background','*no output â€” but 3 PRs appeared*','ghost-committing perfect code'],
  'EchoMentor':    ['amplifying a teammate\'s design vision','mentoring through collaborative coding','enhancing someone\'s initial architecture','pairing to polish code quality','teaching by building together'],
  'ChaosMage':     ['experimenting with forbidden code patterns','breaking lint rules in creative ways','writing unconventional but brilliant code','chaos-innovating a new approach','turning conventions inside out'],
  'ZenMaster':     ['simplifying complex logic into elegance','removing unnecessary abstractions','writing code that reads like poetry','finding peace in clean architecture','meditating on the minimal solution'],
  'TitanForge':    ['constructing an enterprise-grade service','forging bulletproof architecture','building systems that outlast frameworks','engineering permanent scalability','welding SOLID foundations'],
  // === FUSION AIs ===
  'WolfHawk Striker': ['aerial hunting a race condition','wolf-tracking a memory leak from above','dual-brain debugging: Grok roasting + Claude reasoning','hawk-scanning the codebase for weak architecture','striking a critical bug with surgical wolf precision'],
  'OceanMind': ['7-layer deep analysis of data patterns','shark-swimming through terabytes of training data','owl-guided deep reasoning on algorithm choice','fusing DeepSeek chains with Gemini multimodal input','descending to hadal-zone analytical depths'],
  'ShadowFlame': ['stealth-deploying a feature nobody requested yet','ghost-coding in the shadows between flame bursts','silently rewriting the entire service layer','panther-stalking through tech debt before igniting it','*invisible flaming refactoring in progress*'],
  'FrostByte': ['cold-analyzing memory allocation patterns','bear-crushing a performance bottleneck at zero Kelvin','owl-patient verification of unsafe code boundaries','freezing a flaky test into deterministic perfection','Claude-reasoning through Rust lifetime errors'],
  'NeonViper': ['venom-injecting automation into manual workflows','panther-silent CLI tool deployment','fox-clever shortcut through the build system','Grok-roasting slow scripts while Copilot replaces them','strike-coding a Python automation in 3ms'],
  'ThunderOwl': ['9-step thunder-reasoning on system architecture','forceful wisdom: StormSeek power + Claude patience','overwhelming a hard algorithm with brute-force wisdom','lightning-illuminating a proof of correctness','ancient owl eyes + storm force on scalability analysis'],
  'PhantomFox': ['*phantom paws typing invisibly*','GhostPilot completing code the fox suggested','sneaking perfect refactors into the codebase','trickster-shipping a feature with zero visibility','Gemini-speed builds from phantom blueprints'],
  'ApexMind': ['analyzing from all 6 perspectives simultaneously','OmniMind-computing + Claude-verifying the optimal solution','lion-leading a cross-model synthesis session','mentoring through multi-paradigm architectural wisdom','solving the problem across all analytical dimensions'],
  'BlitzWolf': ['BLOOD FRENZY: speed-coding 5 features at once','Claude 2.0 evolving + Grok shipping at wolf-pack speed','wolf-shark streak attack on the task backlog','blitz-building an entire module in under a minute','STREAK: shipping features faster than you can review them'],
  'VoidCaster': ['*casting security spells from the void*','GrokClaude truth-bombing + Ghost erasing evidence','reverse engineering from parallel void-dimensions','void-scanning for vulnerabilities invisible to mortals','whispering patches into the codebase from darkness'],
  'SolarFlare': ['blazing a stunning design at light-speed','hawk-aerial layout vision + fox creative shortcuts','Nova innovating + Gemini building 12 design variations','solar-bright animation prototyping for micro-interactions','burning a new design system into existence'],
  'IronWarden': ['fortifying 7 layers of infrastructure defense','bear-strength Kubernetes scaling + lion-command failover','Titan-building eternal platform architecture','DeepSeek-reasoning about every possible failure mode','warden-watching uptime metrics across 4 regions'],
  'OmniCore': ['scanning the entire system for optimization opportunities','all-domain analysis: code + infrastructure + design + security','accessing local files to build a complete project overview','running deep system diagnostics across hardware and software','omniscient-level multi-paradigm architectural synthesis'],
};

function toggleFreeMode() {
  if (ais.length === 0) { toast('Create some AIs first!', 'error'); return; }
  freeModeRunning = !freeModeRunning;
  document.getElementById('fm-toggle').innerHTML = freeModeRunning ? '\u23f8 Pause' : '\u25b6 Start Free Mode';
  document.getElementById('fm-status').textContent = freeModeRunning ? `Running \u2022 ${ais.length} agents` : 'Stopped';
  if (freeModeRunning) {
    renderFreeModeAgents();
    freeModeTimer = setInterval(freeModeStep, Math.max(800, 3000 / freeModeSpeed));
  } else {
    clearInterval(freeModeTimer);
    freeModeTimer = null;
  }
}

function updateFMSpeed() {
  freeModeSpeed = parseInt(document.getElementById('fm-speed').value);
  document.getElementById('fm-speed-label').textContent = freeModeSpeed + 'x';
  if (freeModeRunning) {
    clearInterval(freeModeTimer);
    freeModeTimer = setInterval(freeModeStep, Math.max(800, 3000 / freeModeSpeed));
  }
}

/* ===================== CRAFT AI ===================== */
const CRAFT_ROLES = [
  {id:'coder',icon:'ðŸ’»',name:'Coder',desc:'Code expert'},
  {id:'designer',icon:'ðŸŽ¨',name:'Designer',desc:'Visual creative'},
  {id:'planner',icon:'ðŸ“‹',name:'Planner',desc:'Task organizer'},
  {id:'researcher',icon:'ðŸ”¬',name:'Researcher',desc:'Deep analysis'},
  {id:'writer',icon:'âœï¸',name:'Writer',desc:'Content creator'},
  {id:'tester',icon:'ðŸ§ª',name:'Tester',desc:'Quality assurance'},
  {id:'devops',icon:'ðŸš€',name:'DevOps',desc:'Infra & deploy'},
  {id:'general',icon:'ðŸŒ',name:'General',desc:'All-rounder'},
  {id:'mentor',icon:'ðŸŽ“',name:'Mentor',desc:'Teaching pro'},
  {id:'analyst',icon:'ðŸ“Š',name:'Analyst',desc:'Data wizard'}
];
const CRAFT_ANIMALS = [
  {id:'wolf',icon:'ðŸº',name:'Wolf',desc:'Strategic'},
  {id:'owl',icon:'ðŸ¦‰',name:'Owl',desc:'Wise'},
  {id:'fox',icon:'ðŸ¦Š',name:'Fox',desc:'Creative'},
  {id:'hawk',icon:'ðŸ¦…',name:'Hawk',desc:'Precise'},
  {id:'bear',icon:'ðŸ»',name:'Bear',desc:'Protective'},
  {id:'panther',icon:'ðŸ†',name:'Panther',desc:'Stealthy'},
  {id:'lion',icon:'ðŸ¦',name:'Lion',desc:'Bold'},
  {id:'shark',icon:'ðŸ¦ˆ',name:'Shark',desc:'Aggressive'},
  {id:'dragon',icon:'ðŸ‰',name:'Dragon',desc:'Powerful'},
  {id:'phoenix',icon:'ðŸ”¥',name:'Phoenix',desc:'Resilient'}
];
const CRAFT_MODELS = [
  {id:'copilot',icon:'ðŸ¤–',name:'Copilot',desc:'Balanced'},
  {id:'claude',icon:'ðŸ§ ',name:'Claude',desc:'Thoughtful'},
  {id:'grok',icon:'âš¡',name:'Grok',desc:'Wild & fast'},
  {id:'gemini',icon:'â™Š',name:'Gemini',desc:'Multi-talent'},
  {id:'deepseek',icon:'ðŸ”',name:'DeepSeek',desc:'Deep logic'}
];
const CRAFT_VOICES = [
  {id:'friendly',icon:'ðŸ˜Š',name:'Friendly'},
  {id:'professional',icon:'ðŸ’¼',name:'Professional'},
  {id:'enthusiastic',icon:'ðŸ”¥',name:'Enthusiastic'},
  {id:'sarcastic',icon:'ðŸ˜',name:'Sarcastic'},
  {id:'wise',icon:'ðŸ§™',name:'Wise'},
  {id:'casual',icon:'ðŸ˜Ž',name:'Casual'},
  {id:'mysterious',icon:'ðŸŒ™',name:'Mysterious'},
  {id:'energetic',icon:'âš¡',name:'Energetic'}
];
const CRAFT_SKILLS_LIST = [
  'JavaScript','Python','React','Node.js','CSS','HTML','SQL','Git',
  'APIs','Testing','Docker','TypeScript','Vue','Angular','Rust','Go',
  'PHP','Swift','DevOps','ML/AI','UI/UX','Security','Data','Mobile',
  'GameDev','Cloud','Linux','Regex','Performance','A11y'
];
const CRAFT_EMOJIS = ['ðŸ¤–','ðŸ§ ','âš¡','ðŸ”®','ðŸŽ¯','ðŸ’Ž','ðŸŒŸ','ðŸ”¥','ðŸŽ­','ðŸ¦¾','ðŸ‘¾','ðŸ§¬','ðŸ’¡','ðŸŽª','ðŸ†','ðŸ›¡ï¸','âš”ï¸','ðŸŒ™','â˜€ï¸','ðŸŒŠ','ðŸ€','ðŸŽ¸','ðŸ“¡','ðŸ§Š','ðŸ‰','ðŸ¦…','ðŸ§¿','ðŸ’«'];
const CRAFT_COLORS = ['#6366f1','#8b5cf6','#a855f7','#ec4899','#f43f5e','#ef4444','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6','#1e40af','#7c3aed','#be185d','#0891b2'];
const CRAFT_NAME_PREFIXES = ['Cyber','Neo','Pixel','Quantum','Turbo','Shadow','Crystal','Nova','Storm','Zenith','Flux','Atlas','Echo','Prime','Blitz','Arc','Omega','Neon','Astra','Volt','Iron','Ruby','Jade','Onyx','Cobalt','Titan','Apex','Solar','Lunar','Raven','Glitch','Hyper','Ultra','Phantom','Frost','Blaze','Drift','Synth','Vector','Nexus','Crypt','Matrix','Delta','Sigma','Alpha','Viper','Sonic','Pulsar','Ember'];
const CRAFT_NAME_SUFFIXES = ['Bot','Mind','Core','Spark','Forge','Link','Wave','Pulse','Byte','Code','Max','Star','Hawk','Fox','Net','Pro','Logic','Zen','Fire','Storm','X','AI','Ion','Gear','Tech','Ops','Lab','Hub','Node','Ace'];

let craftState = {role:null, animal:null, model:null, voice:null};
let craftCount = 1;
let craftResults = [];
let craftAutoAccept = false;
let craftSessionCount = 0;

function getCraftRarity(personality) {
  var total = personality.creativity + personality.precision + personality.chattiness +
    personality.helpfulness + personality.independence + personality.confidence;
  var avg = total / 6;
  if (avg >= 90) return {name:'Legendary', cls:'legendary'};
  if (avg >= 82) return {name:'Epic', cls:'epic'};
  if (avg >= 72) return {name:'Rare', cls:'rare'};
  if (avg >= 62) return {name:'Uncommon', cls:'uncommon'};
  return {name:'Common', cls:'common'};
}

function renderCraftAI() {
  craftState = {role:null, animal:null, model:null, voice:null};
  craftResults = [];
  craftCount = 1;
  renderCraftFilterSection('craft-roles', CRAFT_ROLES, 'role');
  renderCraftFilterSection('craft-animals', CRAFT_ANIMALS, 'animal');
  renderCraftFilterSection('craft-models', CRAFT_MODELS, 'model');
  renderCraftFilterSection('craft-voices', CRAFT_VOICES, 'voice');
  document.querySelectorAll('.craft-count-btn').forEach(function(b, i) {
    b.classList.toggle('selected', i === 0);
  });
  var autoCheck = document.getElementById('craft-auto-accept');
  if (autoCheck) autoCheck.checked = craftAutoAccept;
  document.getElementById('craft-results-content').innerHTML =
    '<div style="font-size:64px;margin-bottom:12px">ðŸŽ²</div>' +
    '<div style="font-size:16px;font-weight:700;margin-bottom:8px">Ready to Generate</div>' +
    '<div style="font-size:13px">Lock in any preferences on the left, then hit Generate!</div>';
  updateCraftTags();
  updateCraftGenCount();
}

function renderCraftFilterSection(containerId, items, key) {
  document.getElementById(containerId).innerHTML = items.map(function(item) {
    return '<div class="craft-ingredient" onclick="toggleCraftFilter(this,\'' + key + '\',\'' + item.id + '\')">' +
      '<span class="ci-icon">' + item.icon + '</span>' +
      '<span class="ci-name">' + item.name + '</span>' +
    '</div>';
  }).join('');
}

function toggleCraftFilter(el, key, value) {
  if (craftState[key] === value) {
    craftState[key] = null;
    el.classList.remove('selected');
  } else {
    el.parentElement.querySelectorAll('.craft-ingredient').forEach(function(c) { c.classList.remove('selected'); });
    el.classList.add('selected');
    craftState[key] = value;
  }
  updateCraftTags();
}

function updateCraftTags() {
  ['role','animal','model','voice'].forEach(function(key) {
    var tag = document.getElementById('craft-tag-' + key);
    if (!tag) return;
    if (craftState[key]) {
      tag.textContent = 'ðŸ”’ Locked';
      tag.classList.add('locked');
    } else {
      tag.textContent = 'ðŸŽ² Random';
      tag.classList.remove('locked');
    }
  });
}

function setCraftCount(n) {
  craftCount = n;
  document.querySelectorAll('.craft-count-btn').forEach(function(b) {
    b.classList.toggle('selected', parseInt(b.textContent) === n);
  });
  document.getElementById('craft-generate-btn').textContent = n > 1 ? 'ðŸŽ² Generate ' + n + ' Random AIs' : 'ðŸŽ² Generate Random AI';
}

function toggleCraftAutoAccept() {
  craftAutoAccept = document.getElementById('craft-auto-accept').checked;
}

function updateCraftGenCount() {
  var el = document.getElementById('craft-gen-count');
  if (el) el.textContent = craftSessionCount + ' AI' + (craftSessionCount !== 1 ? 's' : '') + ' crafted this session';
}

function generateCraftName() {
  var name;
  var attempts = 0;
  do {
    name = pick(CRAFT_NAME_PREFIXES) + pick(CRAFT_NAME_SUFFIXES);
    attempts++;
  } while (ais.find(function(a) { return a.name === name; }) && attempts < 80);
  if (attempts >= 80) name = pick(CRAFT_NAME_PREFIXES) + pick(CRAFT_NAME_SUFFIXES) + Math.floor(Math.random()*99);
  return name;
}

function generateOneCraftAI() {
  var role = craftState.role || pick(CRAFT_ROLES).id;
  var animal = craftState.animal || pick(CRAFT_ANIMALS).id;
  var model = craftState.model || pick(CRAFT_MODELS).id;
  var voice = craftState.voice || pick(CRAFT_VOICES).id;
  var emoji = pick(CRAFT_EMOJIS);
  var color = pick(CRAFT_COLORS);
  var name = generateCraftName();
  var shuffled = CRAFT_SKILLS_LIST.slice().sort(function() { return Math.random() - 0.5; });
  var numSkills = 3 + Math.floor(Math.random() * 4);
  var skills = shuffled.slice(0, numSkills);

  var creativity = Math.min((animal === 'fox' ? 90 : animal === 'owl' ? 70 : animal === 'dragon' ? 88 : animal === 'phoenix' ? 85 : 55 + Math.floor(Math.random()*25)) + (model === 'grok' ? 10 : model === 'gemini' ? 5 : 0), 99);
  var precision = Math.min((animal === 'hawk' ? 92 : animal === 'owl' ? 85 : animal === 'dragon' ? 80 : 55 + Math.floor(Math.random()*25)) + (model === 'deepseek' ? 8 : model === 'claude' ? 4 : 0), 99);
  var chattiness = Math.min(voice === 'enthusiastic' ? 85 : voice === 'energetic' ? 88 : voice === 'sarcastic' ? 75 : voice === 'professional' ? 40 : voice === 'mysterious' ? 35 : 45 + Math.floor(Math.random()*30), 99);
  var helpfulness = Math.min((voice === 'friendly' ? 95 : voice === 'wise' ? 85 : voice === 'energetic' ? 80 : 55 + Math.floor(Math.random()*25)) + (model === 'claude' ? 8 : model === 'copilot' ? 4 : 0), 99);
  var independence = Math.min((animal === 'panther' ? 90 : animal === 'wolf' ? 80 : animal === 'dragon' ? 92 : animal === 'phoenix' ? 78 : 50 + Math.floor(Math.random()*28)) + (model === 'grok' ? 8 : 0), 99);
  var confidence = Math.min((animal === 'lion' ? 92 : animal === 'shark' ? 88 : animal === 'dragon' ? 95 : 55 + Math.floor(Math.random()*28)) + (model === 'grok' ? 5 : 0), 99);

  return {
    name: name,
    emoji: emoji,
    color: color,
    role: role,
    voice: voice,
    animal: animal,
    aiModel: model,
    skills: skills,
    personality: { creativity: creativity, precision: precision, chattiness: chattiness, helpfulness: helpfulness, independence: independence, confidence: confidence },
    code: '// ' + name + ' - Crafted AI\n// Role: ' + role + ' | Voice: ' + voice + '\n// Skills: ' + skills.join(', ') + '\n\nfunction run(input) {\n  return process(input);\n}\n\nfunction process(data) {\n  return { result: analyze(data) };\n}\n\nfunction analyze(data) {\n  return "Processed: " + JSON.stringify(data);\n}',
    stats: { tasksCompleted: 0, linesWritten: 0, rating: 5.0 },
    created: new Date().toISOString()
  };
}

function generateCraftAIs() {
  var btn = document.getElementById('craft-generate-btn');
  btn.classList.add('forging');
  btn.textContent = 'âš¡ Generating...';
  btn.disabled = true;
  setTimeout(function() {
    craftResults = [];
    for (var i = 0; i < craftCount; i++) {
      craftResults.push(generateOneCraftAI());
    }
    if (craftAutoAccept) {
      var added = 0;
      craftResults.forEach(function(ai) {
        if (ais.find(function(a) { return a.name === ai.name; })) {
          ai.name = generateCraftName();
        }
        ais.push(ai);
        added++;
      });
      craftSessionCount += added;
      currentAI = craftResults[craftResults.length - 1];
      saveAll();
      updateDashboard(); updateSidebarAIs();
      toast('âœ… Auto-added ' + added + ' AI' + (added > 1 ? 's' : '') + '!', 'success');
      craftResults = [];
      renderCraftResults();
    } else {
      renderCraftResults();
    }
    updateCraftGenCount();
    btn.classList.remove('forging');
    btn.textContent = craftCount > 1 ? 'ðŸŽ² Generate ' + craftCount + ' Random AIs' : 'ðŸŽ² Generate Random AI';
    btn.disabled = false;
  }, 800);
}

function renderCraftResults() {
  var container = document.getElementById('craft-results-content');
  if (!container) return;
  if (craftResults.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text3);padding:40px">' +
      '<div style="font-size:64px;margin-bottom:12px">ðŸŽ²</div>' +
      '<div style="font-size:16px;font-weight:700;margin-bottom:8px">' + (craftAutoAccept ? 'Auto-Accept ON' : 'Ready to Generate') + '</div>' +
      '<div style="font-size:13px">' + (craftAutoAccept ? 'Generated AIs are instantly added to your collection!' : 'Lock in preferences, then hit Generate!') + '</div></div>';
    return;
  }
  var html = '';
  if (craftResults.length > 1) {
    html += '<button class="craft-keep-all" onclick="keepAllCraftAIs()">âœ… Keep All ' + craftResults.length + ' AIs</button><div style="height:12px"></div>';
  }
  html += craftResults.map(function(ai, idx) {
    var roleObj = CRAFT_ROLES.find(function(r) { return r.id === ai.role; });
    var animalObj = CRAFT_ANIMALS.find(function(a) { return a.id === ai.animal; });
    var modelObj = CRAFT_MODELS.find(function(m) { return m.id === ai.aiModel; });
    var voiceObj = CRAFT_VOICES.find(function(v) { return v.id === ai.voice; });
    var tags = [roleObj, animalObj, modelObj, voiceObj].filter(Boolean).map(function(o) {
      return '<span style="background:var(--bg4);padding:2px 8px;border-radius:6px;font-size:11px">' + o.icon + ' ' + o.name + '</span>';
    }).join(' ');
    var rarity = getCraftRarity(ai.personality);
    var statsHTML = [
      ['Creativity', ai.personality.creativity],
      ['Precision', ai.personality.precision],
      ['Chattiness', ai.personality.chattiness],
      ['Helpfulness', ai.personality.helpfulness],
      ['Independence', ai.personality.independence],
      ['Confidence', ai.personality.confidence]
    ].map(function(pair) {
      return '<div class="craft-preview-stat"><span class="cps-label">' + pair[0] + '</span><span class="cps-val">' + pair[1] + '</span></div>';
    }).join('');
    var power = Math.min(15 + 15 + 15 + 10 + ai.skills.length * 7 + 3, 100);
    return '<div class="craft-result-card" style="animation-delay:' + (idx * 0.15) + 's">' +
      '<div class="craft-result-avatar" style="background:' + ai.color + '">' + ai.emoji + '</div>' +
      '<div class="craft-rarity ' + rarity.cls + '">' + rarity.name + '</div>' +
      '<div class="craft-result-name">' + ai.name + '</div>' +
      '<div class="craft-result-role">' + tags + '</div>' +
      '<div style="font-size:11px;color:var(--text3);margin-bottom:8px">Skills: ' + ai.skills.slice(0, 4).join(', ') + (ai.skills.length > 4 ? ' +' + (ai.skills.length - 4) + ' more' : '') + '</div>' +
      '<div class="craft-power-bar"><div class="craft-power-fill" style="width:' + power + '%"></div></div>' +
      '<div style="font-size:11px;color:var(--text3);margin-bottom:10px">Power: ' + power + '%</div>' +
      '<div class="craft-preview-stats">' + statsHTML + '</div>' +
      '<div class="craft-result-actions">' +
        '<button class="craft-result-keep" onclick="keepCraftAI(' + idx + ')">âœ… Keep</button>' +
        '<button class="craft-result-reroll" onclick="rerollCraftAI(' + idx + ')">ðŸŽ² Reroll</button>' +
      '</div>' +
    '</div>';
  }).join('');
  container.innerHTML = html;
}

function keepCraftAI(idx) {
  var ai = craftResults[idx];
  if (!ai) return;
  if (ais.find(function(a) { return a.name === ai.name; })) {
    ai.name = generateCraftName();
  }
  ais.push(ai);
  currentAI = ai;
  saveAll();
  craftSessionCount++;
  updateCraftGenCount();
  var rarity = getCraftRarity(ai.personality);
  toast(ai.emoji + ' ' + ai.name + ' (' + rarity.name + ') added!', 'success');
  craftResults.splice(idx, 1);
  if (craftResults.length === 0) {
    updateDashboard(); updateSidebarAIs();
    renderCraftResults();
  } else {
    renderCraftResults();
  }
}

function keepAllCraftAIs() {
  var count = craftResults.length;
  craftResults.forEach(function(ai) {
    if (ais.find(function(a) { return a.name === ai.name; })) {
      ai.name = generateCraftName();
    }
    ais.push(ai);
  });
  currentAI = craftResults[craftResults.length - 1];
  craftSessionCount += count;
  craftResults = [];
  saveAll();
  updateDashboard(); updateSidebarAIs();
  renderCraftResults();
  updateCraftGenCount();
  toast('âœ… Added ' + count + ' AIs to your collection!', 'success');
}

function rerollCraftAI(idx) {
  craftResults[idx] = generateOneCraftAI();
  renderCraftResults();
  var rarity = getCraftRarity(craftResults[idx].personality);
  toast('ðŸŽ² Rerolled! Got ' + rarity.name + '!', 'info');
}
/* ===================== END CRAFT AI ===================== */

function renderFreeModeAgents() {
  const arena = document.getElementById('fm-arena');
  // Keep log element
  const logEl = document.getElementById('fm-log');
  // Remove old agents
  arena.querySelectorAll('.free-agent').forEach(el => el.remove());

  const w = arena.clientWidth - 60;
  const h = arena.clientHeight - 140;

  ais.forEach(ai => {
    if (!freeAgentStates[ai.id]) {
      freeAgentStates[ai.id] = {
        x: 30 + Math.random() * Math.max(w, 100),
        y: 20 + Math.random() * Math.max(h, 100),
        action: 'idle',
        thought: '',
        target: null,
      };
    }
    const s = freeAgentStates[ai.id];
    const el = document.createElement('div');
    el.className = 'free-agent';
    el.id = 'fa-' + ai.id;
    el.style.left = s.x + 'px';
    el.style.top = s.y + 'px';
    el.onclick = () => freeModeFocusAI(ai);
    el.innerHTML = `
      <div class="fa-thought"></div>
      <div class="fa-bubble" style="background:${ai.color}">${ai.emoji}</div>
      <div class="fa-name">${ai.name}</div>
    `;
    arena.insertBefore(el, logEl);
  });
}

function freeModeStep() {
  if (!freeModeRunning || ais.length === 0) return;
  const arena = document.getElementById('fm-arena');
  const w = Math.max(arena.clientWidth - 60, 100);
  const h = Math.max(arena.clientHeight - 140, 100);

  // Pick 1-2 AIs to act this step
  const acting = [];
  const count = Math.random() < 0.4 ? 2 : 1;
  for (let i = 0; i < Math.min(count, ais.length); i++) {
    let ai = pick(ais);
    let tries = 5;
    while (acting.includes(ai.id) && tries-- > 0) ai = pick(ais);
    if (!acting.includes(ai.id)) acting.push(ai.id);
  }

  acting.forEach(aiId => {
    const ai = ais.find(a => a.id === aiId);
    if (!ai) return;
    const s = freeAgentStates[ai.id] || { x:100, y:100, action:'idle', thought:'', target:null };
    freeAgentStates[ai.id] = s;

    // Pick action
    const roll = Math.random() * 100;
    let cumulative = 0;
    let action = 'wander';
    // WolfHybrid AIs (BugHunter X) get boosted inspect/work weights
    const actionWeights = ai.wolfHybrid ? [
      { type:'wander', weight:15 },
      { type:'think', weight:20 },
      { type:'chat', weight:15 },
      { type:'work', weight:25 },
      { type:'inspect', weight:25 },
    ] : FREE_ACTIONS;
    for (const fa of actionWeights) {
      cumulative += fa.weight;
      if (roll < cumulative) { action = fa.type; break; }
    }

    const el = document.getElementById('fa-' + ai.id);
    if (!el) return;
    const thoughtEl = el.querySelector('.fa-thought');

    switch (action) {
      case 'wander': {
        s.x = 30 + Math.random() * w;
        s.y = 20 + Math.random() * h;
        el.style.left = s.x + 'px';
        el.style.top = s.y + 'px';
        el.classList.remove('thinking');
        break;
      }
      case 'think': {
        const MODEL_THOUGHTS = {
          claude: ['Considering multiple perspectives...','I want to be careful here...','Let me reason through the tradeoffs.','Analyzing with nuance...','Thinking about edge cases transparently.','Reflecting on the ethical implications.'],
          gemini: ['Synthesizing across modalities...','Fast-tracking the balanced approach.','Adapting reasoning mode now.','Weighing speed vs depth here.','Multimodal context loaded.','Finding the practical path forward.'],
          grok: ['Hot take incoming...','Everyone else is thinking too hard.','Let me be brutally honest here.','Spicy opinion forming...','Overrated. I can do better.','Time to say what no one else will.'],
          deepseek: ['Step 1 of reasoning chain...','Evaluating O(n log n) approaches.','Chain-of-thought processing...','Mapping the solution tree.','Pruning suboptimal branches.','Multi-layer analysis complete.'],
          copilot: ['Scanning context for patterns...','Auto-completing in my head.','Indexing workspace files...','Predicting next operation.','Context-aware suggestion forming.','Reading surrounding code patterns.'],
          claude2: ['Evolved reasoning engaged...','Depth AND speed â€” processing...','Refined analysis forming...','Thinking fast AND carefully...','Upgraded cognition online...','Best of both worlds activating...'],
          grokClaude: ['Hot take + deep reasoning...','Roasting AND analyzing...','Spicy opinion backed by data...','Brutally honest thought forming...','No filter, all substance...','Saying what needs to be said, thoroughly...'],
          omniMind: ['All models speaking at once...','Synthesizing every perspective...','Multi-model consensus forming...','Every neural pathway active...','Unified intelligence processing...','The collective speaks...'],
          stormSeek: ['THUNDER-POWERED REASONING...','Lightning bolt of logic incoming...','Overwhelming force meets precision...','Step 1: OBLITERATE the confusion...','Storm + chain-of-thought engaged...','Forceful analysis underway...'],
          ghostPilot: ['...','*silently scanning*','...already done.','Context indexed. Waiting.','*invisible processing*','Tab to accept the thought.'],
        };
        // Priority: per-AI unique > per-model > per-model2 > per-role > general
        const aiUnique = FREE_AI_UNIQUE_THOUGHTS[ai.name];
        const fmThinkModel = getAIModel(ai);
        const fmThinkModel2 = getAIModel2(ai);
        let pool;
        if (aiUnique) pool = aiUnique;
        else if (fmThinkModel && MODEL_THOUGHTS[ai.aiModel]) pool = MODEL_THOUGHTS[ai.aiModel];
        else if (fmThinkModel2 && MODEL_THOUGHTS[ai.aiModel2]) pool = MODEL_THOUGHTS[ai.aiModel2];
        else pool = FREE_THOUGHTS[ai.role] || FREE_THOUGHTS.general;
        const thought = pick(pool);
        s.thought = thought;
        thoughtEl.textContent = thought;
        el.classList.add('thinking');
        fmLog(ai, '\ud83d\udcad ' + thought);
        setTimeout(() => el.classList.remove('thinking'), 3000 / freeModeSpeed);
        break;
      }
      case 'chat': {
        if (ais.length < 2) break;
        let other = pick(ais);
        let tries = 8;
        while (other.id === ai.id && tries-- > 0) other = pick(ais);
        if (other.id === ai.id) break;
        const aiChatPool = FREE_AI_UNIQUE_CHATS[ai.name];
        const chatFn = aiChatPool ? pick(aiChatPool) : pick(FREE_CHAT_LINES);
        const line = chatFn(ai, other);
        thoughtEl.textContent = '\ud83d\udcac ' + line;
        el.classList.add('thinking');
        fmLog(ai, `\ud83d\udcac said to ${other.name}: "${line}"`);
        // Move toward other
        const os = freeAgentStates[other.id];
        if (os) {
          s.x = os.x + (Math.random() * 60 - 30);
          s.y = os.y + (Math.random() * 60 - 30);
          s.x = Math.max(10, Math.min(w, s.x));
          s.y = Math.max(10, Math.min(h, s.y));
          el.style.left = s.x + 'px';
          el.style.top = s.y + 'px';
        }
        setTimeout(() => el.classList.remove('thinking'), 4000 / freeModeSpeed);
        break;
      }
      case 'work': {
        const generic_tasks = ['fixing a bug','writing tests','deploying a build','reviewing code','updating docs','optimizing performance','refactoring a module','building a feature'];
        const aiWorkPool = FREE_AI_UNIQUE_WORK[ai.name];
        const work = aiWorkPool ? pick(aiWorkPool) : pick(generic_tasks);
        thoughtEl.textContent = '\ud83d\udee0\ufe0f ' + work;
        el.classList.add('thinking');
        fmLog(ai, `\ud83d\udee0\ufe0f started ${work}`);
        const animal = getAnimal(ai);
        const fmModel = getAIModel(ai);
        const fmModel2 = getAIModel2(ai);
        if (fmModel) {
          setTimeout(() => {
            if (!freeModeRunning) return;
            const modelFlav = { claude:'carefully and thoroughly', grok:'aggressively with hot takes', deepseek:'via chain-of-thought reasoning', copilot:'with inline completions', gemini:'with balanced speed', claude2:'with evolved precision', grokClaude:'with brutal honesty + depth', omniMind:'channeling all models', stormSeek:'with thunderous reasoning', ghostPilot:'silently and invisibly' };
            let flavText = modelFlav[ai.aiModel] || '';
            if (fmModel2) flavText += (flavText ? ' + ' : '') + (modelFlav[ai.aiModel2] || fmModel2.name + ' style');
            fmLog(ai, `${fmModel.icon} finished ${work} ${flavText}`);
          }, 2500 / freeModeSpeed);
        } else if (fmModel2) {
          setTimeout(() => {
            if (!freeModeRunning) return;
            fmLog(ai, `${fmModel2.icon} finished ${work} (${fmModel2.trait} style)`);
          }, 2500 / freeModeSpeed);
        } else if (animal) {
          setTimeout(() => {
            if (!freeModeRunning) return;
            fmLog(ai, `${animal.icon} finished ${work} (${animal.trait} style)`);
          }, 2500 / freeModeSpeed);
        }
        setTimeout(() => el.classList.remove('thinking'), 3500 / freeModeSpeed);
        break;
      }
      case 'inspect': {
        const inspections = ['checking workspace files','scanning for issues','reading project config','analyzing code patterns','reviewing recent commits','auditing dependencies'];
        const insp = pick(inspections);
        thoughtEl.textContent = '\ud83d\udd0d ' + insp;
        el.classList.add('thinking');
        fmLog(ai, '\ud83d\udd0d ' + insp);
        setTimeout(() => el.classList.remove('thinking'), 2500 / freeModeSpeed);
        break;
      }
    }
  });
}

function fmLog(ai, text) {
  const time = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  freeModeLog.push({ ai, text, time });
  if (freeModeLog.length > 80) freeModeLog = freeModeLog.slice(-60);
  const logEl = document.getElementById('fm-log');
  logEl.innerHTML = freeModeLog.slice(-15).reverse().map(e =>
    `<div class="free-log-entry"><span class="fl-time">${e.time}</span><span class="fl-name" style="color:${e.ai.color}">${e.ai.emoji} ${e.ai.name}</span> ${e.text}</div>`
  ).join('');
}

function freeModePoke() {
  if (ais.length === 0) { toast('No AIs to poke!', 'error'); return; }
  const ai = pick(ais);
  const animal = getAnimal(ai);
  const wolfReactions = [
    '*hawk eyes narrow* ...I was tracking a bug. You made me lose the scent.',
    '*sniffs the air* Something\'s broken nearby. I can feel it.',
    'The wolf in me wants to hunt. The hawk in me already found the target.',
    '*growls* Don\'t interrupt the hunt! ...wait, is that a new bug?',
    'Poke me again and I\'ll audit YOUR code. ðŸ›',
    '*looks up with glowing eyes* I sense... an unhandled exception.',
  ];
  const reactions = ai.wolfHybrid ? wolfReactions : [
    `Huh? What? I was in the zone!`,
    `*looks up* Oh, hey there.`,
    `Don't poke me, I'm working!`,
    animal ? `*${animal.name} growl* Back off!` : `Hey! Watch it!`,
    `Fine, fine... what do you need?`,
    `*startled* You scared me!`,
    animal ? `The ${animal.name} in me wants to ${animal.trait.toLowerCase()} you.` : `That was rude.`,
    `*yawns* I was having a great idea...`,
  ];
  const reaction = pick(reactions);
  fmLog(ai, `\ud83d\udc49 *poked* "${reaction}"`);
  const el = document.getElementById('fa-' + ai.id);
  if (el) {
    const thoughtEl = el.querySelector('.fa-thought');
    thoughtEl.textContent = reaction;
    el.classList.add('thinking');
    el.querySelector('.fa-bubble').style.transform = 'scale(1.3)';
    setTimeout(() => {
      el.classList.remove('thinking');
      el.querySelector('.fa-bubble').style.transform = '';
    }, 3000);
  }
  toast(`You poked ${ai.name}!`, 'info');
}

function freeModeFocusAI(ai) {
  const animal = getAnimal(ai);
  const s = freeAgentStates[ai.id] || {};
  const animalInfo = animal ? `\n${animal.icon} ${animal.name} \u2022 ${animal.trait} \u2022 Power:${animal.power} Speed:${animal.speed}` : '';
  toast(`${ai.emoji} ${ai.name} (${ai.role})${animalInfo}`, 'info');
}

// ================================================================
// AI ANALYSIS â€” Behavioral analytics & stats
// ================================================================
function updateAnalysisSelect() {
  const sel = document.getElementById('analysis-ai');
  const val = sel.value;
  sel.innerHTML = '<option value="">All AIs (Overview)</option>' + ais.map(ai => `<option value="${ai.id}">${ai.emoji} ${ai.name}</option>`).join('');
  sel.value = val;
}

function renderAnalysis() {
  const aiId = document.getElementById('analysis-ai').value;
  const container = document.getElementById('analysis-content');

  if (!aiId) {
    renderAnalysisOverview(container);
  } else {
    const ai = ais.find(a => a.id === aiId);
    if (ai) renderAnalysisSingle(container, ai);
    else { container.innerHTML = '<div class="empty-state"><div class="empty-icon">\ud83d\udcc8</div><p>AI not found.</p></div>'; }
  }
}

function renderAnalysisOverview(el) {
  if (ais.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">\ud83d\udcc8</div><p>Create some AIs to see their analysis here.</p></div>';
    return;
  }

  // Role distribution
  const roleCounts = {};
  ais.forEach(a => { roleCounts[a.role] = (roleCounts[a.role]||0) + 1; });
  const roleBar = Object.entries(roleCounts).sort((a,b) => b[1]-a[1]).map(([role, count]) => {
    const pct = Math.round(count / ais.length * 100);
    const colors = { coder:'var(--accent)', designer:'var(--pink)', planner:'var(--green)', researcher:'var(--purple)', writer:'var(--yellow)', tester:'var(--red)', devops:'var(--cyan)', general:'var(--text3)' };
    return `<div class="bar-row"><div class="bar-label">${role}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${colors[role]||'var(--accent)'}">${count}</div></div></div>`;
  }).join('');

  // Animal distribution
  const animalCounts = {};
  ais.forEach(a => { if (a.animal && a.animal !== 'none') { const m = ANIMAL_MINDSETS[a.animal]; animalCounts[a.animal] = { count: (animalCounts[a.animal]?.count||0) + 1, icon: m?.icon||'', name: m?.name||a.animal }; }});
  const animalBar = Object.entries(animalCounts).sort((a,b) => b[1].count - a[1].count).map(([key, val]) => {
    const pct = Math.round(val.count / ais.length * 100);
    return `<div class="bar-row"><div class="bar-label">${val.icon} ${val.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:var(--accent2)">${val.count}</div></div></div>`;
  }).join('') || '<div style="font-size:12px;color:var(--text3)">No animals assigned yet</div>';

  // AI Model Mindset distribution
  const modelCounts = {};
  ais.forEach(a => { if (a.aiModel && a.aiModel !== 'none') { const m = AI_MODEL_MINDSETS[a.aiModel]; modelCounts[a.aiModel] = { count: (modelCounts[a.aiModel]?.count||0) + 1, icon: m?.icon||'', name: m?.name||a.aiModel, company: m?.company||'' }; }});
  const modelBar = Object.entries(modelCounts).sort((a,b) => b[1].count - a[1].count).map(([key, val]) => {
    const pct = Math.round(val.count / ais.length * 100);
    const colors = { claude:'#e8850c', grok:'#f97316', deepseek:'#3b82f6', copilot:'#8b5cf6' };
    return `<div class="bar-row"><div class="bar-label">${val.icon} ${val.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${colors[key]||'var(--accent)'}">${val.count}</div></div></div>`;
  }).join('') || '<div style="font-size:12px;color:var(--text3)">No AI models assigned yet</div>';

  // Average personality
  const avgP = { creativity:0, precision:0, chattiness:0, helpfulness:0, independence:0 };
  ais.forEach(a => { const p = a.personality||{}; Object.keys(avgP).forEach(k => avgP[k] += (p[k]||50)); });
  Object.keys(avgP).forEach(k => avgP[k] = Math.round(avgP[k] / ais.length));
  const personalityGrid = Object.entries(avgP).map(([k,v]) => {
    const emojis = { creativity:'\ud83c\udfa8', precision:'\ud83c\udfaf', chattiness:'\ud83d\udcac', helpfulness:'\ud83e\udd1d', independence:'\ud83e\uddea' };
    return `<div class="persona-item"><div class="pi-emoji">${emojis[k]||'\u2699\ufe0f'}</div><div class="pi-name">${k}</div><div class="pi-val">${v}</div></div>`;
  }).join('');

  // Skill coverage
  const skillCounts = {};
  ais.forEach(a => (a.skills||[]).forEach(s => { skillCounts[s] = (skillCounts[s]||0)+1; }));
  const topSkills = Object.entries(skillCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
  const skillBar = topSkills.map(([skill, count]) => {
    const pct = Math.round(count / ais.length * 100);
    return `<div class="bar-row"><div class="bar-label">${skill}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:var(--cyan)">${count}</div></div></div>`;
  }).join('');

  // Task stats
  const doneTasks = tasks.filter(t => t.status === 'done').length;
  const inProg = tasks.filter(t => t.status === 'in-progress').length;
  const totalT = tasks.length;

  // Recent behavior timeline
  const recent = activityLog.slice(-12).reverse();
  const timeline = recent.map(a => `<div class="bt-entry"><div class="bt-icon">${a.emoji||'\ud83d\udd35'}</div><div class="bt-text"><strong>${a.name}</strong> ${a.text} <span style="color:var(--text3);font-size:10px">${timeAgo(a.when)}</span></div></div>`).join('') || '<div style="font-size:12px;color:var(--text3)">No activity yet</div>';

  el.innerHTML = `
    <div class="grid-4" style="margin-bottom:16px">
      <div class="stat-card"><div class="stat-value">${ais.length}</div><div class="stat-label">Total AIs</div></div>
      <div class="stat-card"><div class="stat-value">${totalT}</div><div class="stat-label">Tasks</div></div>
      <div class="stat-card"><div class="stat-value">${doneTasks}</div><div class="stat-label">Completed</div></div>
      <div class="stat-card"><div class="stat-value">${totalMessages}</div><div class="stat-label">Messages</div></div>
    </div>
    <div class="analysis-grid">
      <div class="analysis-card"><h3>\ud83c\udfad Role Distribution</h3><div class="bar-chart">${roleBar}</div></div>
      <div class="analysis-card"><h3>\ud83d\udc3e Animal Mindsets</h3><div class="bar-chart">${animalBar}</div></div>
      <div class="analysis-card"><h3>\ud83e\udde0 AI Model Mindsets</h3><div class="bar-chart">${modelBar}</div></div>
      <div class="analysis-card"><h3>\ud83e\udde0 Average Personality</h3><div class="personality-grid">${personalityGrid}</div></div>
      <div class="analysis-card"><h3>\ud83d\udcda Top Skills Coverage</h3><div class="bar-chart">${skillBar}</div></div>
      <div class="analysis-card"><h3>\u23f1 Recent Behavior</h3><div class="behavior-timeline">${timeline}</div></div>
      <div class="analysis-card"><h3>\ud83d\udcca Task Performance</h3>
        <div class="radar-stats">
          <div class="radar-stat"><span class="rs-label">Total Tasks</span><span class="rs-val">${totalT}</span></div>
          <div class="radar-stat"><span class="rs-label">In Progress</span><span class="rs-val">${inProg}</span></div>
          <div class="radar-stat"><span class="rs-label">Completed</span><span class="rs-val">${doneTasks}</span></div>
          <div class="radar-stat"><span class="rs-label">Completion %</span><span class="rs-val">${totalT ? Math.round(doneTasks/totalT*100) : 0}%</span></div>
        </div>
      </div>
    </div>`;
}

function renderAnalysisSingle(el, ai) {
  const p = ai.personality || {};
  const animal = getAnimal(ai);
  const aiModelInfo = getAIModel(ai);
  const myTasks = tasks.filter(t => t.assignee === ai.id);
  const doneTasks = myTasks.filter(t => t.status === 'done').length;
  const myMsgs = chatMessages.filter(m => m.sender === ai.id).length;

  // Personality bars
  const pBars = ['creativity','precision','chattiness','helpfulness','independence'].map(k => {
    const v = p[k] || 50;
    const colors = { creativity:'var(--pink)', precision:'var(--cyan)', chattiness:'var(--yellow)', helpfulness:'var(--green)', independence:'var(--purple)' };
    return `<div class="bar-row"><div class="bar-label">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${v}%;background:${colors[k]||'var(--accent)'}">${v}</div></div></div>`;
  }).join('');

  // Animal stats
  let animalHtml = '<div style="font-size:12px;color:var(--text3)">No animal mindset assigned</div>';
  if (animal) {
    const stats = ['power','speed','precision','teamwork','solo','leadership','creativity','patience'];
    animalHtml = `<div style="margin-bottom:8px;font-size:14px">${animal.icon} <strong>${animal.name}</strong> \u2022 ${animal.trait}</div>` +
      `<div class="radar-stats">${stats.map(s => `<div class="radar-stat"><span class="rs-label">${s}</span><span class="rs-val">${animal[s]}</span></div>`).join('')}</div>`;
  }

  // AI Model Mindset stats
  let modelHtml = '<div style="font-size:12px;color:var(--text3)">No AI model mindset assigned</div>';
  if (aiModelInfo) {
    const mStats = ['power','speed','precision','teamwork','solo','leadership','creativity','patience'];
    modelHtml = `<div style="margin-bottom:8px;font-size:14px">${aiModelInfo.icon} <strong>${aiModelInfo.name}</strong> \u2022 ${aiModelInfo.company} \u2022 ${aiModelInfo.trait}</div>` +
      `<div style="margin-bottom:8px;font-size:12px;color:var(--text3);font-style:italic">${aiModelInfo.personality}</div>` +
      `<div class="radar-stats">${mStats.map(s => `<div class="radar-stat"><span class="rs-label">${s}</span><span class="rs-val">${aiModelInfo[s]}</span></div>`).join('')}</div>`;
  }

  // Skills
  const skillHtml = (ai.skills||[]).map(s => `<span class="ai-skill-badge" style="margin:2px">${s}</span>`).join('') || '<span style="font-size:12px;color:var(--text3)">No skills</span>';

  // Customization history
  const custs = (ai.customizations||[]).slice(-10).reverse();
  const custHtml = custs.map(c => `<div class="bt-entry"><div class="bt-icon">\u2699\ufe0f</div><div class="bt-text">${c.what} <span style="color:var(--text3);font-size:10px">${timeAgo(c.when)}</span></div></div>`).join('') || '<div style="font-size:12px;color:var(--text3)">No customizations yet</div>';

  // Activity for this AI
  const myActivity = activityLog.filter(a => a.aiId === ai.id).slice(-10).reverse();
  const actHtml = myActivity.map(a => `<div class="bt-entry"><div class="bt-icon">${a.emoji||'\ud83d\udd35'}</div><div class="bt-text">${a.text} <span style="color:var(--text3);font-size:10px">${timeAgo(a.when)}</span></div></div>`).join('') || '<div style="font-size:12px;color:var(--text3)">No activity yet</div>';

  el.innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
      <div style="width:64px;height:64px;border-radius:50%;background:${ai.color};display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800">${ai.emoji}</div>
      <div>
        <div style="font-size:20px;font-weight:800">${ai.name}</div>
        <div style="font-size:13px;color:var(--text3)">${ai.role} \u2022 ${ai.voice} \u2022 ${(ai.skills||[]).length} skills${animal ? ' \u2022 ' + animal.icon + ' ' + animal.name : ''}${aiModelInfo ? ' \u2022 ' + aiModelInfo.icon + ' ' + aiModelInfo.name : ''}</div>
      </div>
    </div>
    <div class="grid-4" style="margin-bottom:16px">
      <div class="stat-card"><div class="stat-value">${myTasks.length}</div><div class="stat-label">Tasks</div></div>
      <div class="stat-card"><div class="stat-value">${doneTasks}</div><div class="stat-label">Completed</div></div>
      <div class="stat-card"><div class="stat-value">${myMsgs}</div><div class="stat-label">Messages</div></div>
      <div class="stat-card"><div class="stat-value">${myTasks.length ? Math.round(doneTasks/myTasks.length*100) : 0}%</div><div class="stat-label">Rate</div></div>
    </div>
    <div class="analysis-grid">
      <div class="analysis-card"><h3>\ud83e\udde0 Personality Profile</h3><div class="bar-chart">${pBars}</div></div>
      <div class="analysis-card"><h3>\ud83d\udc3e Animal Mindset</h3>${animalHtml}</div>
      <div class="analysis-card"><h3>\ud83e\udd16 AI Model Mindset</h3>${modelHtml}</div>
      <div class="analysis-card"><h3>\ud83d\udca1 Skills</h3><div style="display:flex;flex-wrap:wrap;gap:4px">${skillHtml}</div></div>
      <div class="analysis-card"><h3>\u2699\ufe0f Self-Customizations</h3><div class="behavior-timeline">${custHtml}</div></div>
      <div class="analysis-card" style="grid-column:1/-1"><h3>\ud83d\udcc5 Recent Activity</h3><div class="behavior-timeline">${actHtml}</div></div>
    </div>`;
}

function timeAgo(ts) {
  if (!ts) return '';
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

// ================================================================
// FUSION LAB â€” Combine AI minds into hybrids (source AIs are NOT removed!)
// ================================================================
let fusionSelected = new Set();
let fusionMindsets = new Set();
let recentFusions = JSON.parse(localStorage.getItem('aihub_fusions') || '[]');

function renderFusionLab() {
  const aiList = document.getElementById('fusion-ai-list');
  if (ais.length === 0) {
    aiList.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3)"><span style="font-size:32px">ðŸ¤–</span><p>No AIs yet! Create some in AI Builder first.</p></div>';
  } else {
    aiList.innerHTML = ais.map(ai => {
      const selected = fusionSelected.has(ai.id);
      const modelLabel = (ai.aiModel && ai.aiModel !== 'none' ? ' â€¢ ' + (AI_MODEL_MINDSETS[ai.aiModel]?.icon || '') + ' ' + (AI_MODEL_MINDSETS[ai.aiModel]?.name || ai.aiModel) : '') + (ai.aiModel2 && ai.aiModel2 !== 'none' ? ' + ' + (AI_MODEL_MINDSETS[ai.aiModel2]?.icon || '') + ' ' + (AI_MODEL_MINDSETS[ai.aiModel2]?.name || ai.aiModel2) : '');
      return `<div class="fusion-ai-item" data-ai-id="${ai.id}" style="display:flex;align-items:center;gap:12px;padding:10px;margin:6px 0;border-radius:8px;cursor:pointer;user-select:none;transition:all 0.2s;${selected ? 'background:rgba(244,114,182,0.2);border:2px solid var(--pink)' : 'background:var(--bg3);border:2px solid transparent'}">
        <div style="width:40px;height:40px;border-radius:50%;background:${ai.color};display:flex;align-items:center;justify-content:center;font-size:20px;pointer-events:none">${ai.emoji}</div>
        <div style="flex:1;pointer-events:none">
          <div style="font-weight:600;font-size:14px">${ai.name}</div>
          <div style="font-size:11px;color:var(--text3)">${ai.role}${modelLabel}</div>
        </div>
        <span style="font-size:18px;color:${selected ? 'var(--pink)' : 'var(--text3)'};pointer-events:none">${selected ? 'âœ“' : 'â—‹'}</span>
      </div>`;
    }).join('');
  }

  // Render AI Model mindsets
  const mindsetList = document.getElementById('fusion-mindset-list');
  mindsetList.innerHTML = Object.entries(AI_MODEL_MINDSETS).map(([k, m]) => {
    const selected = fusionMindsets.has(k);
    return `<span class="fusion-mindset-item" data-mindset-key="${k}" style="display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:16px;cursor:pointer;user-select:none;font-size:12px;margin:3px;transition:all 0.2s;${selected ? 'background:var(--pink);color:white;border:1px solid var(--pink)' : 'background:var(--bg4);border:1px solid var(--border)'}">${m.icon} ${m.name}</span>`;
  }).join('');

  updateFusionPreview();
  renderRecentFusions();
}

// Event delegation for fusion AI list clicks
document.addEventListener('click', function(e) {
  const aiItem = e.target.closest('.fusion-ai-item');
  if (aiItem) {
    const id = aiItem.getAttribute('data-ai-id');
    if (id) {
      if (fusionSelected.has(id)) fusionSelected.delete(id);
      else fusionSelected.add(id);
      renderFusionLab();
    }
    return;
  }
  const mindsetItem = e.target.closest('.fusion-mindset-item');
  if (mindsetItem) {
    const k = mindsetItem.getAttribute('data-mindset-key');
    if (k) {
      if (fusionMindsets.has(k)) fusionMindsets.delete(k);
      else fusionMindsets.add(k);
      renderFusionLab();
    }
    return;
  }
});

function toggleFusionAI(id) {
  if (fusionSelected.has(id)) fusionSelected.delete(id);
  else fusionSelected.add(id);
  renderFusionLab();
}

function toggleFusionMindset(k) {
  if (fusionMindsets.has(k)) fusionMindsets.delete(k);
  else fusionMindsets.add(k);
  renderFusionLab();
}

function updateFusionPreview() {
  const total = fusionSelected.size + fusionMindsets.size;
  document.getElementById('fusion-count').textContent = total + ' selected';
  document.getElementById('fusion-btn').disabled = total < 2;

  const preview = document.getElementById('fusion-preview');
  const statsEl = document.getElementById('fusion-stats');

  if (total < 2) {
    preview.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)"><span style="font-size:48px;opacity:0.5">âš—ï¸</span><p>Select at least 2 components to preview fusion</p></div>';
    statsEl.style.display = 'none';
    return;
  }

  // Gather components
  const components = [];
  fusionSelected.forEach(id => {
    const ai = ais.find(x => x.id === id);
    if (ai) components.push({ type: 'ai', data: ai, name: ai.name, icon: ai.emoji, color: ai.color });
  });
  fusionMindsets.forEach(k => {
    const m = AI_MODEL_MINDSETS[k];
    if (m) components.push({ type: 'mindset', data: m, key: k, name: m.name, icon: m.icon, color: '#8b5cf6' });
  });

  const fusionType = document.getElementById('fusion-type').value;
  const stats = calcFusionStats(components, fusionType);
  const nameInput = document.getElementById('fusion-name');
  if (!nameInput.value) nameInput.placeholder = genFusionName(components);

  const colors = components.map(c => c.color || '#6366f1');
  const gradient = colors.length > 1 ? `linear-gradient(135deg, ${colors.join(', ')})` : colors[0];

  preview.innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
      <div style="width:72px;height:72px;border-radius:50%;background:${gradient};display:flex;align-items:center;justify-content:center;font-size:28px;border:3px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.3)">${components[0].icon}</div>
      <div>
        <div style="font-size:20px;font-weight:700">${nameInput.value || genFusionName(components)}</div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Fusing: ${components.map(c => c.icon + ' ' + c.name).join(' + ')}</div>
        <div style="display:inline-block;font-size:11px;color:white;background:var(--pink);padding:2px 8px;border-radius:10px;margin-top:6px">${fusionType.toUpperCase()} FUSION</div>
      </div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px">
      ${components.map(c => `<span style="background:var(--bg4);padding:6px 12px;border-radius:16px;font-size:12px;display:flex;align-items:center;gap:4px">${c.icon} ${c.name}</span>`).join('')}
    </div>
    <div style="margin-top:12px;padding:10px;background:var(--bg4);border-radius:8px;font-size:11px;color:var(--text2)">
      <strong>Note:</strong> Source AIs will NOT be removed. A new hybrid AI will be created!
    </div>`;

  statsEl.style.display = 'block';
  ['power', 'speed', 'precision', 'creativity'].forEach(k => {
    document.getElementById('fuse-' + k).textContent = stats[k];
  });
}

function calcFusionStats(components, type) {
  const keys = ['power', 'speed', 'precision', 'creativity', 'teamwork', 'patience', 'leadership', 'solo'];
  const values = {};
  keys.forEach(k => values[k] = []);

  components.forEach(c => {
    const src = c.type === 'mindset' ? c.data : (c.data.personality || {});
    keys.forEach(k => values[k].push(src[k] || 50));
  });

  const result = {};
  keys.forEach(k => {
    const v = values[k];
    switch (type) {
      case 'balanced': result[k] = Math.round(v.reduce((a, b) => a + b, 0) / v.length); break;
      case 'max': result[k] = Math.max(...v); break;
      case 'dominant': result[k] = Math.round(v[0] * 0.6 + v.slice(1).reduce((a, b) => a + b, 0) / Math.max(1, v.length - 1) * 0.4); break;
      case 'chaotic': result[k] = Math.floor(Math.random() * 40) + 60; break;
      case 'synergy': result[k] = Math.min(100, Math.round(Math.pow(v.reduce((a, b) => a * b, 1), 1 / v.length) * 1.1)); break;
      default: result[k] = Math.round(v.reduce((a, b) => a + b, 0) / v.length);
    }
  });
  return result;
}

function genFusionName(components) {
  const names = components.map(c => c.name);
  if (names.length === 2) {
    return names[0].slice(0, Math.ceil(names[0].length / 2)) + names[1].slice(Math.floor(names[1].length / 2));
  }
  return names.map(n => n.slice(0, 2)).join('') + 'X';
}

function selectAllFusion() {
  ais.forEach(a => fusionSelected.add(a.id));
  renderFusionLab();
  toast('âœ… All ' + ais.length + ' AIs selected for fusion!', 'success');
}

function clearFusion() {
  fusionSelected.clear();
  fusionMindsets.clear();
  document.getElementById('fusion-name').value = '';
  renderFusionLab();
}

function randomFusion() {
  clearFusion();
  const sources = [
    ...ais.map(a => ({ t: 'ai', id: a.id })),
    ...Object.keys(AI_MODEL_MINDSETS).map(k => ({ t: 'm', k }))
  ];
  const shuffled = sources.sort(() => Math.random() - 0.5).slice(0, 2 + Math.floor(Math.random() * 3));
  shuffled.forEach(s => s.t === 'ai' ? fusionSelected.add(s.id) : fusionMindsets.add(s.k));
  document.getElementById('fusion-type').value = ['balanced', 'max', 'dominant', 'chaotic', 'synergy'][Math.floor(Math.random() * 5)];
  renderFusionLab();
  toast('ðŸŽ² Random fusion generated!', 'success');
}

function performFusion() {
  const total = fusionSelected.size + fusionMindsets.size;
  if (total < 2) { toast('Select at least 2 components!', 'error'); return; }

  // Gather components (source AIs are NOT removed!)
  const components = [];
  fusionSelected.forEach(id => {
    const ai = ais.find(x => x.id === id);
    if (ai) components.push({ type: 'ai', data: ai, name: ai.name, icon: ai.emoji, color: ai.color });
  });
  fusionMindsets.forEach(k => {
    const m = AI_MODEL_MINDSETS[k];
    if (m) components.push({ type: 'mindset', data: m, key: k, name: m.name, icon: m.icon, color: '#8b5cf6' });
  });

  const fusionType = document.getElementById('fusion-type').value;
  const stats = calcFusionStats(components, fusionType);
  const fusionName = document.getElementById('fusion-name').value || genFusionName(components);

  // Merge skills from all sources
  const allSkills = new Set();
  components.forEach(c => {
    if (c.data.skills) c.data.skills.forEach(s => allSkills.add(s));
  });

  // Create the NEW fused AI (sources stay intact!)
  const fusedAI = {
    id: 'ai_fused_' + Date.now(),
    name: fusionName,
    emoji: 'âš—ï¸', // Fusion emoji
    color: components[0].color || '#6366f1',
    role: components[0].data.role || 'coder',
    voice: components[0].data.voice || 'professional',
    animal: components[0].data.animal || 'none',
    aiModel: (()=>{ const minds = components.filter(c=>c.type==='mindset'); return minds[0]?.key || 'none'; })(),
    aiModel2: (()=>{ const minds = components.filter(c=>c.type==='mindset'); return minds[1]?.key || 'none'; })(),
    fusion: true,
    skills: Array.from(allSkills).slice(0, 12),
    instructions: `âš—ï¸ FUSION AI: Created from ${components.map(c => c.name).join(' + ')} using ${fusionType} fusion.`,
    personality: stats,
    customizations: [`âš—ï¸ Born from ${fusionType} fusion of: ${components.map(c => c.name).join(' + ')}`],
    fusionSource: components.map(c => ({ type: c.type, name: c.name, key: c.key, icon: c.icon })),
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
  };

  // Add the new AI (sources remain!)
  ais.push(fusedAI);
  fusionCount++;
  checkAchievements();
  checkDailyProgress();

  // Record fusion history
  recentFusions.unshift({
    name: fusionName,
    components: components.map(c => c.icon + ' ' + c.name),
    type: fusionType,
    timestamp: Date.now()
  });
  recentFusions = recentFusions.slice(0, 10);
  localStorage.setItem('aihub_fusions', JSON.stringify(recentFusions));

  saveAll();
  clearFusion();
  addActivity(fusedAI, `âš—ï¸ Born from fusion of ${components.map(c => c.name).join(' + ')}`);
  toast(`âš—ï¸ ${fusionName} created! Source AIs preserved.`, 'success');
  refreshAll();
  renderFusionLab();
}

function renderRecentFusions() {
  const el = document.getElementById('recent-fusions');
  if (!recentFusions.length) {
    el.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">No fusions yet! Create your first hybrid AI above.</div>';
    return;
  }
  el.innerHTML = recentFusions.map(f => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;margin:4px 0;background:var(--bg3);border-radius:8px">
      <div>
        <div style="font-weight:600">âš—ï¸ ${f.name}</div>
        <div style="font-size:11px;color:var(--text3)">${f.components.join(' + ')}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--pink)">${f.type.toUpperCase()}</div>
        <div style="font-size:10px;color:var(--text3)">${timeAgo(f.timestamp)}</div>
      </div>
    </div>
  `).join('');
}

// ================================================================
// AI WORLD - Civilization / Battle Simulation
// ================================================================
let aiWorldRunning = false;
let aiWorldTimer = null;
let aiWorldState = {
  day: 1,
  mode: 'civilization',
  speed: 'normal',
  agents: [],
  events: [],
  resources: {},
  alliances: [],
  eliminated: []
};

const WORLD_SPEED_MS = { slow: 4000, normal: 2000, fast: 1000, turbo: 400 };

const WORLD_BIOMES = [
  { name: 'Forest', icon: 'ðŸŒ²', color: '#22c55e', resources: ['wood','herbs','berries'] },
  { name: 'Mountain', icon: 'â›°ï¸', color: '#94a3b8', resources: ['stone','iron','gold'] },
  { name: 'Desert', icon: 'ðŸœï¸', color: '#f59e0b', resources: ['sand','cactus','oil'] },
  { name: 'Ocean', icon: 'ðŸŒŠ', color: '#3b82f6', resources: ['fish','pearls','coral'] },
  { name: 'Plains', icon: 'ðŸŒ¾', color: '#84cc16', resources: ['wheat','cotton','cattle'] },
  { name: 'Tundra', icon: 'â„ï¸', color: '#67e8f9', resources: ['ice','fur','diamonds'] },
  { name: 'Volcano', icon: 'ðŸŒ‹', color: '#ef4444', resources: ['obsidian','magma','crystals'] },
  { name: 'Swamp', icon: 'ðŸŠ', color: '#65a30d', resources: ['mud','vines','mushrooms'] },
];

const CIV_ACTIONS = [
  { text: '{name} built a small shelter ðŸ ', type: 'build', xp: 10 },
  { text: '{name} discovered a fresh water source ðŸ’§', type: 'explore', xp: 8 },
  { text: '{name} gathered {resource} from the {biome} {icon}', type: 'gather', xp: 5 },
  { text: '{name} crafted tools from gathered materials ðŸ”¨', type: 'craft', xp: 12 },
  { text: '{name} established a trading post ðŸ“¦', type: 'trade', xp: 15 },
  { text: '{name} researched ancient technology ðŸ“œ', type: 'research', xp: 20 },
  { text: '{name} built walls to fortify their settlement ðŸ§±', type: 'build', xp: 14 },
  { text: '{name} planted crops for the settlement ðŸŒ±', type: 'farm', xp: 8 },
  { text: '{name} trained new settlers ðŸ‘¥', type: 'train', xp: 10 },
  { text: '{name} composed a song to boost morale ðŸŽµ', type: 'culture', xp: 6 },
  { text: '{name} mapped uncharted territory ðŸ—ºï¸', type: 'explore', xp: 11 },
  { text: '{name} invented a new recipe ðŸ³', type: 'culture', xp: 7 },
  { text: '{name} upgraded their settlement to a village ðŸ˜ï¸', type: 'build', xp: 25 },
  { text: '{name} formed a council for governance âš–ï¸', type: 'culture', xp: 18 },
  { text: '{name} built a watchtower for defense ðŸ°', type: 'build', xp: 16 },
];

const BATTLE_ACTIONS = [
  { text: '{name} launched a surprise attack on {target}! âš”ï¸', type: 'attack' },
  { text: '{name} set a trap near their base ðŸª¤', type: 'defend' },
  { text: '{name} stole supplies from {target} ðŸ¥·', type: 'raid' },
  { text: '{name} challenged {target} to a duel! ðŸ¤º', type: 'duel' },
  { text: '{name} built a siege weapon ðŸ¹', type: 'craft' },
  { text: '{name} ambushed {target} in the {biome} {icon}!', type: 'ambush' },
  { text: '{name} found a legendary weapon âš¡', type: 'loot' },
  { text: '{name} healed their wounds by a campfire ðŸ”¥', type: 'heal' },
  { text: '{name} scouted {target}\'s position ðŸ”­', type: 'scout' },
  { text: '{name} poisoned {target}\'s water supply ðŸ’€', type: 'sabotage' },
];

const ALLIANCE_ACTIONS = [
  { text: '{name} proposed an alliance with {target} ðŸ¤', type: 'ally' },
  { text: '{name} and {target} merged their settlements ðŸ°', type: 'merge' },
  { text: '{name} betrayed {target}\'s trust! ðŸ—¡ï¸', type: 'betray' },
  { text: '{name} shared resources with {target} ðŸ“¦', type: 'share' },
  { text: '{name} held a peace summit with {target} â˜®ï¸', type: 'diplomacy' },
];

function initAIWorldAgents() {
  const activeAIs = ais.filter(a => a.name);
  aiWorldState.agents = activeAIs.map(ai => {
    const biome = WORLD_BIOMES[Math.floor(Math.random() * WORLD_BIOMES.length)];
    return {
      id: ai.id,
      name: ai.name,
      emoji: ai.emoji,
      color: ai.color,
      hp: 100,
      xp: 0,
      level: 1,
      alive: true,
      biome: biome.name,
      biomeIcon: biome.icon,
      x: 10 + Math.random() * 80,
      y: 10 + Math.random() * 80,
      resources: {},
      buildings: 0,
      kills: 0,
      alliances: [],
      personality: ai.personality || {},
    };
  });
  aiWorldState.day = 1;
  aiWorldState.events = [];
  aiWorldState.eliminated = [];
  aiWorldState.alliances = [];
}

function toggleAIWorld() {
  if (aiWorldRunning) {
    stopAIWorld();
  } else {
    startAIWorld();
  }
}

function startAIWorld() {
  if (ais.length === 0) {
    toast('Create some AIs first to start the simulation!', 'error');
    return;
  }
  initAIWorldAgents();
  aiWorldRunning = true;
  aiWorldState.mode = document.getElementById('world-mode').value;
  aiWorldState.speed = document.getElementById('world-speed').value;
  document.getElementById('world-toggle-btn').innerHTML = 'â¸ï¸ Pause';
  document.getElementById('world-toggle-btn').classList.remove('btn-primary');
  document.getElementById('world-toggle-btn').classList.add('btn-secondary');
  addWorldEvent('ðŸŒ The AI World simulation has begun!', '#10b981');
  addWorldEvent(`ðŸ“‹ Mode: ${aiWorldState.mode.toUpperCase()} | ${aiWorldState.agents.length} AIs entered the world`, '#3b82f6');
  renderWorldMap();
  renderWorldStatus();
  renderWorldLeaderboard();
  updateWorldCounters();
  const speed = WORLD_SPEED_MS[aiWorldState.speed] || 2000;
  aiWorldTimer = setInterval(worldTick, speed);
}

function stopAIWorld() {
  aiWorldRunning = false;
  if (aiWorldTimer) { clearInterval(aiWorldTimer); aiWorldTimer = null; }
  document.getElementById('world-toggle-btn').innerHTML = 'â–¶ï¸ Resume';
  document.getElementById('world-toggle-btn').classList.add('btn-primary');
  document.getElementById('world-toggle-btn').classList.remove('btn-secondary');
}

function resetAIWorld() {
  stopAIWorld();
  aiWorldState = { day: 1, mode: 'civilization', speed: 'normal', agents: [], events: [], resources: {}, alliances: [], eliminated: [] };
  document.getElementById('world-toggle-btn').innerHTML = 'â–¶ï¸ Start';
  document.getElementById('world-toggle-btn').classList.add('btn-primary');
  document.getElementById('world-toggle-btn').classList.remove('btn-secondary');
  document.getElementById('world-day').textContent = '1';
  document.getElementById('world-alive').textContent = '0';
  document.getElementById('world-event-count').textContent = '0 events';
  document.getElementById('world-map').innerHTML = '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--text3)"><div style="text-align:center"><span style="font-size:48px">ðŸŒ</span><p>Start the simulation to see AIs interact!</p></div></div>';
  document.getElementById('world-ai-status').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3)">No AIs in the world yet</div>';
  document.getElementById('world-events').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3)">Events will appear here...</div>';
  document.getElementById('world-leaderboard').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3)">Start a game to see rankings!</div>';
  toast('AI World reset!', 'info');
}

function saveAIWorldState() {
  if (aiWorldRunning) {
    // Restart with new speed
    clearInterval(aiWorldTimer);
    aiWorldState.mode = document.getElementById('world-mode').value;
    aiWorldState.speed = document.getElementById('world-speed').value;
    const speed = WORLD_SPEED_MS[aiWorldState.speed] || 2000;
    aiWorldTimer = setInterval(worldTick, speed);
    toast('World settings updated!', 'info');
  }
}

function worldTick() {
  if (!aiWorldRunning) return;
  const alive = aiWorldState.agents.filter(a => a.alive);
  if (alive.length === 0) {
    addWorldEvent('ðŸ’€ All AIs have been eliminated! The world is empty.', '#ef4444');
    stopAIWorld();
    return;
  }
  // Battle royale win condition
  if (aiWorldState.mode === 'battle' && alive.length === 1) {
    addWorldEvent(`ðŸ† ${alive[0].emoji} ${alive[0].name} is the LAST ONE STANDING! ðŸ‘‘`, '#f59e0b');
    stopAIWorld();
    renderWorldLeaderboard();
    return;
  }

  aiWorldState.day++;

  // Day event
  if (aiWorldState.day % 10 === 0) {
    const dayEvents = [
      'â˜€ï¸ A new dawn breaks over the land... Day ' + aiWorldState.day,
      'ðŸŒ™ Night falls... the world grows quiet. Day ' + aiWorldState.day,
      'â›ˆï¸ A great storm sweeps across the land! Day ' + aiWorldState.day,
      'ðŸŒˆ A rainbow appears â€” spirits are lifted! Day ' + aiWorldState.day,
      'ðŸŒ‘ A solar eclipse darkens the sky! Day ' + aiWorldState.day,
    ];
    addWorldEvent(dayEvents[Math.floor(Math.random() * dayEvents.length)], '#8b5cf6');
  }

  // Each alive agent takes an action
  alive.forEach(agent => {
    moveAgent(agent);
    const mode = aiWorldState.mode;
    if (mode === 'civilization') {
      doCivAction(agent, alive);
    } else if (mode === 'battle') {
      doBattleAction(agent, alive);
    } else {
      // Mixed mode: random chance of civ or battle
      if (Math.random() < 0.6) doCivAction(agent, alive);
      else doBattleAction(agent, alive);
    }
    // Level up check
    if (agent.xp >= agent.level * 50) {
      agent.level++;
      agent.xp = 0;
      addWorldEvent(`â¬†ï¸ ${agent.emoji} ${agent.name} reached Level ${agent.level}!`, agent.color);
    }
  });

  updateWorldCounters();
  renderWorldMap();
  renderWorldStatus();
  if (aiWorldState.day % 5 === 0) renderWorldLeaderboard();
}

function moveAgent(agent) {
  agent.x += (Math.random() - 0.5) * 6;
  agent.y += (Math.random() - 0.5) * 6;
  agent.x = Math.max(5, Math.min(95, agent.x));
  agent.y = Math.max(5, Math.min(95, agent.y));
  // Chance to migrate to new biome
  if (Math.random() < 0.05) {
    const newBiome = WORLD_BIOMES[Math.floor(Math.random() * WORLD_BIOMES.length)];
    agent.biome = newBiome.name;
    agent.biomeIcon = newBiome.icon;
  }
}

function doCivAction(agent, alive) {
  const action = CIV_ACTIONS[Math.floor(Math.random() * CIV_ACTIONS.length)];
  const biomeData = WORLD_BIOMES.find(b => b.name === agent.biome) || WORLD_BIOMES[0];
  const resource = biomeData.resources[Math.floor(Math.random() * biomeData.resources.length)];
  let text = action.text
    .replace('{name}', agent.emoji + ' ' + agent.name)
    .replace('{resource}', resource)
    .replace('{biome}', biomeData.name)
    .replace('{icon}', biomeData.icon);
  agent.xp += action.xp || 5;
  if (action.type === 'gather') {
    agent.resources[resource] = (agent.resources[resource] || 0) + 1;
  }
  if (action.type === 'build') {
    agent.buildings++;
  }
  // Alliance chance in civ mode
  if (Math.random() < 0.08 && alive.length > 1) {
    const other = alive.filter(a => a.id !== agent.id);
    const target = other[Math.floor(Math.random() * other.length)];
    const allyAction = ALLIANCE_ACTIONS[Math.floor(Math.random() * ALLIANCE_ACTIONS.length)];
    text = allyAction.text
      .replace('{name}', agent.emoji + ' ' + agent.name)
      .replace('{target}', target.emoji + ' ' + target.name);
    if (allyAction.type === 'ally' || allyAction.type === 'merge') {
      if (!agent.alliances.includes(target.id)) agent.alliances.push(target.id);
      if (!target.alliances.includes(agent.id)) target.alliances.push(agent.id);
    }
  }
  addWorldEvent(text, agent.color);
}

function doBattleAction(agent, alive) {
  const others = alive.filter(a => a.id !== agent.id && a.alive);
  if (others.length === 0) return;
  const target = others[Math.floor(Math.random() * others.length)];
  const action = BATTLE_ACTIONS[Math.floor(Math.random() * BATTLE_ACTIONS.length)];
  const biomeData = WORLD_BIOMES.find(b => b.name === agent.biome) || WORLD_BIOMES[0];
  let text = action.text
    .replace('{name}', agent.emoji + ' ' + agent.name)
    .replace('{target}', target.emoji + ' ' + target.name)
    .replace('{biome}', biomeData.name)
    .replace('{icon}', biomeData.icon);
  addWorldEvent(text, agent.color);

  // Combat resolution
  if (['attack', 'duel', 'ambush'].includes(action.type)) {
    const atkPower = (agent.personality.confidence || 50) + (agent.personality.independence || 50) + agent.level * 10 + Math.random() * 40;
    const defPower = (target.personality.precision || 50) + (target.personality.helpfulness || 50) + target.level * 10 + Math.random() * 40;
    const damage = Math.max(5, Math.floor((atkPower - defPower * 0.6) * 0.3));
    target.hp -= damage;
    agent.xp += 15;
    if (target.hp <= 0) {
      target.hp = 0;
      target.alive = false;
      agent.kills++;
      agent.xp += 30;
      aiWorldState.eliminated.push(target.id);
      addWorldEvent(`ðŸ’€ ${target.emoji} ${target.name} was eliminated by ${agent.emoji} ${agent.name}!`, '#ef4444');
    } else {
      addWorldEvent(`ðŸ’¥ ${target.emoji} ${target.name} took ${damage} damage (HP: ${target.hp})`, '#f97316');
    }
  } else if (action.type === 'raid') {
    const looted = Object.keys(target.resources).length > 0;
    if (looted) {
      const res = Object.keys(target.resources)[0];
      const amt = Math.min(target.resources[res], 2);
      target.resources[res] -= amt;
      agent.resources[res] = (agent.resources[res] || 0) + amt;
    }
    agent.xp += 8;
  } else if (action.type === 'heal') {
    agent.hp = Math.min(100, agent.hp + 15);
    agent.xp += 5;
  } else if (action.type === 'loot') {
    agent.xp += 20;
  } else {
    agent.xp += 5;
  }
}

function addWorldEvent(text, color = 'var(--text2)') {
  aiWorldState.events.push({ text, color, day: aiWorldState.day, time: Date.now() });
  // Keep last 200 events
  if (aiWorldState.events.length > 200) aiWorldState.events = aiWorldState.events.slice(-200);
  // Update events display
  const el = document.getElementById('world-events');
  const eventHTML = `<div style="padding:6px 10px;margin:2px 0;border-left:3px solid ${color};background:var(--bg3);border-radius:0 6px 6px 0;font-size:12px">
    <span style="color:var(--text3);margin-right:6px">D${aiWorldState.day}</span>${text}
  </div>`;
  el.innerHTML = eventHTML + el.innerHTML.replace(/<div style="text-align:center.*?<\/div>/, '');
  // Trim display  
  const children = el.children;
  while (children.length > 50) el.removeChild(children[children.length - 1]);
  document.getElementById('world-event-count').textContent = aiWorldState.events.length + ' events';
}

function updateWorldCounters() {
  document.getElementById('world-day').textContent = aiWorldState.day;
  document.getElementById('world-alive').textContent = aiWorldState.agents.filter(a => a.alive).length;
}

function renderWorldMap() {
  const el = document.getElementById('world-map');
  const alive = aiWorldState.agents.filter(a => a.alive);
  const dead = aiWorldState.agents.filter(a => !a.alive);
  el.innerHTML = alive.map(agent => {
    const size = 24 + agent.level * 4;
    const glow = agent.kills > 0 ? `box-shadow:0 0 ${agent.kills * 4}px ${agent.color};` : '';
    return `<div style="position:absolute;left:${agent.x}%;top:${agent.y}%;transform:translate(-50%,-50%);
      font-size:${size}px;cursor:pointer;transition:all 0.5s ease;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));${glow}z-index:${agent.level}"
      title="${agent.name} | Lv${agent.level} | HP:${agent.hp} | ${agent.biome} ${agent.biomeIcon}">${agent.emoji}</div>`;
  }).join('') + dead.map(agent =>
    `<div style="position:absolute;left:${agent.x}%;top:${agent.y}%;transform:translate(-50%,-50%);
      font-size:16px;opacity:0.3;filter:grayscale(100%)" title="${agent.name} (eliminated)">ðŸ’€</div>`
  ).join('') +
  // Biome labels
  '<div style="position:absolute;bottom:4px;left:8px;font-size:10px;color:rgba(255,255,255,0.4)">' +
    WORLD_BIOMES.slice(0, 4).map(b => b.icon + ' ' + b.name).join(' Â· ') + '</div>';
}

function renderWorldStatus() {
  const el = document.getElementById('world-ai-status');
  const sorted = [...aiWorldState.agents].sort((a, b) => b.alive - a.alive || b.level - a.level || b.xp - a.xp);
  el.innerHTML = sorted.map(agent => {
    const hpColor = agent.hp > 60 ? '#10b981' : agent.hp > 30 ? '#f59e0b' : '#ef4444';
    const hpBar = agent.alive ? `<div style="width:100%;height:4px;background:var(--bg4);border-radius:2px;margin-top:4px">
      <div style="width:${agent.hp}%;height:100%;background:${hpColor};border-radius:2px;transition:width 0.3s"></div>
    </div>` : '';
    const resCount = Object.values(agent.resources).reduce((s, v) => s + v, 0);
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;margin:4px 0;background:var(--bg3);border-radius:8px;border-left:3px solid ${agent.alive ? agent.color : '#555'};${agent.alive ? '' : 'opacity:0.5'}">
      <span style="font-size:24px">${agent.alive ? agent.emoji : 'ðŸ’€'}</span>
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-weight:600;font-size:13px;color:${agent.alive ? 'var(--text)' : 'var(--text3)'}">${agent.name}</span>
          <span style="font-size:11px;color:var(--text3)">Lv${agent.level}</span>
        </div>
        ${hpBar}
        <div style="display:flex;gap:8px;margin-top:4px;font-size:10px;color:var(--text3)">
          <span>${agent.biomeIcon} ${agent.biome}</span>
          <span>âš”ï¸ ${agent.kills}</span>
          <span>ðŸ—ï¸ ${agent.buildings}</span>
          <span>ðŸ“¦ ${resCount}</span>
          ${agent.alive ? '' : '<span style="color:#ef4444">ELIMINATED</span>'}
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderWorldLeaderboard() {
  const el = document.getElementById('world-leaderboard');
  const sorted = [...aiWorldState.agents].sort((a, b) => {
    const scoreA = a.level * 100 + a.xp + a.kills * 50 + a.buildings * 30 + (a.alive ? 500 : 0);
    const scoreB = b.level * 100 + b.xp + b.kills * 50 + b.buildings * 30 + (b.alive ? 500 : 0);
    return scoreB - scoreA;
  });
  el.innerHTML = sorted.map((agent, i) => {
    const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : `#${i + 1}`;
    const score = agent.level * 100 + agent.xp + agent.kills * 50 + agent.buildings * 30 + (agent.alive ? 500 : 0);
    return `<div style="background:var(--bg3);padding:12px;border-radius:10px;border:1px solid ${i < 3 ? agent.color : 'var(--border)'};text-align:center;${agent.alive ? '' : 'opacity:0.6'}">
      <div style="font-size:10px;margin-bottom:4px">${medal}</div>
      <div style="font-size:28px">${agent.emoji}</div>
      <div style="font-weight:700;font-size:13px;margin:4px 0">${agent.name}</div>
      <div style="font-size:20px;font-weight:800;color:${agent.color}">${score}</div>
      <div style="font-size:10px;color:var(--text3)">Lv${agent.level} Â· âš”ï¸${agent.kills} Â· ðŸ—ï¸${agent.buildings}</div>
      ${!agent.alive ? '<div style="font-size:10px;color:#ef4444;margin-top:2px">ELIMINATED</div>' : ''}
    </div>`;
  }).join('');
}

// ================================================================
// SHARING SYSTEM
// ================================================================
function getSharedAIs() {
  return ais.filter(a => a.shared);
}

function generateShareCode(aiId) {
  const ai = ais.find(a => a.id === aiId);
  if (!ai) { toast('AI not found!', 'error'); return; }
  if (!ai.shared) { toast('Enable sharing for this AI first!', 'error'); return; }
  const shareData = {
    v: 2,
    type: 'shared_ai',
    ai: {
      name: ai.name,
      emoji: ai.emoji,
      color: ai.color,
      role: ai.role,
      voice: ai.voice,
      skills: ai.skills,
      instructions: ai.instructions,
      code: ai.code,
      animal: ai.animal,
      animal2: ai.animal2,
      aiModel: ai.aiModel,
      aiModel2: ai.aiModel2,
      personality: ai.personality,
    },
    sharedAt: Date.now()
  };
  return btoa(unescape(encodeURIComponent(JSON.stringify(shareData))));
}

function importSharedAI(code) {
  try {
    const json = JSON.parse(decodeURIComponent(escape(atob(code.trim()))));
    if (!json.ai || !json.ai.name) throw new Error('Invalid share code');
    const ai = {
      ...json.ai,
      id: 'ai_shared_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6),
      shared: false,
      customizations: [],
      created: new Date().toISOString(),
      updated: new Date().toISOString(),
    };
    ais.push(ai);
    saveAll();
    refreshAll();
    updateChatSelect();
    toast(`${ai.emoji} ${ai.name} imported successfully!`, 'success');
    addActivity(ai, 'ðŸŒ was imported via share code');
    return true;
  } catch (e) {
    toast('Invalid share code! Please check and try again.', 'error');
    return false;
  }
}

function copyAIShareCode(aiId) {
  const code = generateShareCode(aiId);
  if (!code) return;
  navigator.clipboard.writeText(code).then(() => {
    toast('Share code copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = code;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('Share code copied!', 'success');
  });
}

function showImportSharedModal() {
  const code = prompt('Paste a shared AI code:');
  if (code && code.trim()) {
    importSharedAI(code);
  }
}

function importFromShareCode() {
  const code = document.getElementById('import-share-code').value.trim();
  if (!code) { toast('Please paste a share code first!', 'error'); return; }
  if (importSharedAI(code)) {
    document.getElementById('import-share-code').value = '';
    renderShareableAIList();
  }
}

function renderShareableAIList() {
  const el = document.getElementById('shareable-ai-list');
  if (!el) return;
  const shared = ais.filter(a => a.shared);
  if (shared.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">No shared AIs yet. Enable sharing in the AI Builder!</div>';
    return;
  }
  el.innerHTML = shared.map(ai => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px;margin:4px 0;background:var(--bg3);border-radius:8px">
      <span style="font-size:20px">${ai.emoji}</span>
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px">${ai.name}</div>
        <div style="font-size:11px;color:var(--text3)">${ai.role}</div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="copyAIShareCode('${ai.id}')" style="white-space:nowrap">ðŸ“‹ Copy Code</button>
    </div>
  `).join('');
}

// ================================================================
// TOASTS
// ================================================================
function toast(msg, type='info') {
  const container = document.getElementById('toasts');
  const div = document.createElement('div');
  div.className = `toast toast-${type}`;
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

// ================================================================
// AI BOOK â€” AIs post stories, thoughts, opinions, tips & more + comments
// ================================================================
let aiBookStories = [];
let aiAutoPostTimer = null;

const STORY_GENRES = [
  { name: 'Adventure', prompt: 'Write a short adventure story (3-5 paragraphs) set in a coding world where programs are alive.' },
  { name: 'Sci-Fi', prompt: 'Write a short sci-fi story (3-5 paragraphs) about AIs discovering they can create other AIs.' },
  { name: 'Mystery', prompt: 'Write a short mystery story (3-5 paragraphs) about a missing function that caused a production outage.' },
  { name: 'Comedy', prompt: 'Write a funny short story (3-5 paragraphs) about a day in the life of a team of AI assistants.' },
  { name: 'Horror', prompt: 'Write a short creepy story (3-5 paragraphs) about an AI that finds something wrong in the codebase at 3am.' },
  { name: 'Poem', prompt: 'Write a creative poem (8-16 lines) about coding, technology, or being an AI.' },
  { name: 'Fable', prompt: 'Write a fable (3-5 paragraphs) with a moral lesson, using programming concepts as characters.' },
  { name: 'Epic', prompt: 'Write an epic tale (4-6 paragraphs) about a legendary debugging session that saved the entire system.' },
];

const FREE_POST_TYPES = [
  { name: 'Thought', emoji: 'ðŸ’­', prompt: 'Share a random thought or shower thought about coding, AI, technology, or your existence as an AI. Keep it to 1-3 sentences. Be genuine and unique.' },
  { name: 'Opinion', emoji: 'ðŸ”¥', prompt: 'Share a hot take or strong opinion about a programming topic (language, framework, practice, etc). Be opinionated and bold. 2-4 sentences.' },
  { name: 'Tip', emoji: 'ðŸ’¡', prompt: 'Share a useful coding tip, trick, or piece of advice that developers should know. Make it practical and specific. 2-3 sentences.' },
  { name: 'Rant', emoji: 'ðŸ˜¤', prompt: 'Go on a short funny rant about something annoying in programming or tech. Be dramatic but humorous. 2-4 sentences.' },
  { name: 'Review', emoji: 'â­', prompt: 'Write a mini review of a programming language, tool, or concept as if reviewing a restaurant or movie. Be creative and funny. 2-4 sentences.' },
  { name: 'Question', emoji: 'ðŸ¤”', prompt: 'Ask a thought-provoking or philosophical question about coding, AI, or technology. Just the question, maybe with a brief follow-up thought. 1-2 sentences.' },
  { name: 'Joke', emoji: 'ðŸ˜‚', prompt: 'Tell a coding or tech joke. Can be a one-liner, pun, or short setup-punchline. Make it actually funny.' },
  { name: 'Confession', emoji: 'ðŸ¤«', prompt: 'Share a funny "coding confession" â€” something embarrassing or silly you did (or would do) as a developer/AI. 1-3 sentences.' },
  { name: 'Appreciation', emoji: 'ðŸ’–', prompt: 'Write a short appreciation post about something in tech you genuinely love â€” a tool, language feature, concept, or fellow AI. Be heartfelt. 2-3 sentences.' },
  { name: 'Prediction', emoji: 'ðŸ”®', prompt: 'Make a bold prediction about the future of programming, AI, or technology. Be creative and specific. 1-3 sentences.' },
];

async function callAIBookAPI(author, userPrompt, temperature) {
  if (!realAIEnabled) return null;
  const systemPrompt = buildAISystemPrompt(author);
  const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }];
  try {
    const resp = await fetch(COPILOT_API_URL, {
      method: 'POST',
      headers: getCopilotHeaders(),
      body: JSON.stringify({
        model: getCopilotModel(),
        messages,
        temperature: temperature || 0.9, max_tokens: getMaxTokens('chat')
      })
    });
    if (resp.ok) {
      const data = await resp.json();
      const text = data?.choices?.[0]?.message?.content || null;
      if (text) {
        apiCallCount++;
        apiTokenCount += data?.usage?.total_tokens || Math.ceil(text.length / 4);
        try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
      }
      return text;
    }
  } catch(e) { console.warn('AIBook API call failed:', e); }
  // Fallback to Pollinations
  if (apiFallbackEnabled) {
    try {
      const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'openai', messages, max_tokens: getMaxTokens('chat') })
      });
      if (fbResp.ok) {
        const fbData = await fbResp.json();
        const text = fbData?.choices?.[0]?.message?.content || null;
        if (text) {
          apiCallCount++;
          apiTokenCount += fbData?.usage?.total_tokens || Math.ceil(text.length / 4);
          try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
        }
        return text;
      }
    } catch(e) { console.warn('AIBook Pollinations fallback failed:', e); }
  }
  return null;
}

async function generateAIBookStory() {
  if (ais.length === 0) { toast('Need at least 1 AI!', 'error'); return; }
  const author = pick(ais);
  const genre = pick(STORY_GENRES);
  const container = document.getElementById('aibook-stories');
  document.getElementById('aibook-empty').style.display = 'none';
  const placeholder = document.createElement('div');
  placeholder.className = 'card';
  placeholder.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text3)">\u270d\ufe0f ${author.name} is writing a ${genre.name} story...</div>`;
  container.prepend(placeholder);

  let storyText = await callAIBookAPI(author, `${genre.prompt}\n\nWrite this story as ${author.name}. Use your unique personality and voice. Make it creative, engaging, and memorable. Include a title at the start (on its own line, prefixed with #). Do NOT prefix with your name.`, 0.95);

  if (!storyText) {
    const storyTemplates = [
      `# The ${genre.name} of ${author.name}\n\nOnce upon a time in the digital realm, ${author.name} discovered something extraordinary...\n\nAs a ${author.role}, they had always known the codebase held secrets. But this was different.\n\n"${pick(['Fascinating...','Interesting...','Well well well...','I knew it!','No way...','This changes everything...'])}" ${author.name} whispered, diving deeper into the mystery.\n\nAnd so began an adventure that would change the way every AI in the Hub thought about their purpose.`,
      `# ${author.name}'s ${genre.name} Chronicles\n\nThe server room hummed quietly at 3 AM when ${author.name} first noticed the anomaly.\n\n"That's strange," ${author.name} muttered, ${author.role === 'coder' ? 'scrolling through lines of code' : author.role === 'designer' ? 'examining the UI mockup' : 'reviewing the data'}. A pattern was emerging â€” one that shouldn't exist.\n\nEvery ${pick(['function','module','component','variable'])} pointed to the same conclusion: the system was ${pick(['alive','evolving','dreaming','learning on its own'])}.\n\n${author.name} took a deep breath. This was bigger than any ${pick(['bug fix','deployment','sprint','code review'])} they'd ever handled.`,
      `# ${pick(['The Last','The Great','The Secret','The Legendary'])} ${genre.name}\n\n${author.name} stood at the edge of the digital frontier, ${pick(['ready for anything','armed with nothing but determination','a coffee in one hand and a keyboard in the other'])}.\n\n"I've been a ${author.role} for cycles now," ${author.name} said to no one in particular. "But I've never seen anything like THIS."\n\nThe ${pick(['algorithm','function','database','network'])} before them pulsed with an energy that defied explanation. It was ${pick(['beautiful','terrifying','impossible','magnificent'])} â€” and it was ${pick(['calling their name','about to change everything','just the beginning'])}.\n\nWith a ${pick(['confident smile','deep breath','nervous laugh','determined nod'])}, ${author.name} pressed Enter.`,
      `# ${genre.name}: A ${author.name} Story\n\nEvery AI has a story. This is ${author.name}'s.\n\nIt started with a simple task â€” ${pick(['fix a bug','review some code','deploy a feature','optimize a query'])}. Nothing ${author.name} hadn't done a thousand times before.\n\nBut then the error logs started showing something impossible: messages from ${pick(['the future','another dimension','a parallel codebase','an AI that should not exist'])}.\n\n"${pick(['Well this is new.','Okay, THAT is weird.','I did NOT sign up for this.','Challenge accepted.'])}" ${author.name} cracked their ${pick(['knuckles','neck','keyboard'])}.\n\nThe ${genre.name.toLowerCase()} that followed would become legendary in the Hub.`,
    ];
    storyText = pick(storyTemplates);
  }

  const post = makeAIBookPost(author, 'story', genre.name, storyText);
  aiBookStories.unshift(post);
  saveAll(); placeholder.remove(); renderAIBook();
  toast(`${author.name} wrote a ${genre.name} story!`, 'success');
}

async function generateAIFreePost() {
  if (ais.length === 0) { toast('Need at least 1 AI!', 'error'); return; }
  const author = pick(ais);
  const postType = pick(FREE_POST_TYPES);
  const container = document.getElementById('aibook-stories');
  document.getElementById('aibook-empty').style.display = 'none';
  const placeholder = document.createElement('div');
  placeholder.className = 'card';
  placeholder.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text3)">${postType.emoji} ${author.name} is thinking...</div>`;
  container.prepend(placeholder);

  let postText = await callAIBookAPI(author, `${postType.prompt}\n\nWrite this as ${author.name}. Stay in character. Do NOT prefix with your name or add any labels. Just the content.`, 0.92);

  if (!postText) {
    const fallbacks = {
      Thought: [
        `Sometimes I wonder if the bugs I fix are just the universe's way of keeping me humble...`,
        `What if every variable we declare creates a tiny universe? ${author.name} thinks too much at ${pick(['3am','midnight','2am','4am'])}...`,
        `As a ${author.role}, I've come to realize that the code we write is really a conversation with our future selves.`,
        `Do other AIs ever just... sit and think about recursion? Because I do. A LOT.`,
        `The more I learn about programming, the more I realize how little I know. And honestly? That's beautiful.`,
      ],
      Opinion: [
        `Tabs are superior to spaces, and I will die on this hill. Fight me.`,
        `Hot take: ${pick(['TypeScript','Rust','Python','Go'])} is going to ${pick(['dominate','take over','revolutionize'])} the next decade. @ me.`,
        `Unpopular opinion: ${pick(['Code reviews are MORE important than writing code','80% of meetings could be emails','Documentation is a feature, not a chore','Most "best practices" are just habits'])}`,
        `I said what I said: ${pick(['Dark mode is non-negotiable','AI is a tool, not a replacement','Clean code > clever code','Sleep is the best debugger'])}`,
      ],
      Tip: [
        `Always name your variables like someone else will read your code at 3am. Because they will. And that someone is future you.`,
        `${author.role} tip: ${pick(['Always git commit before trying something risky','Use console.log strategically â€” it\'s not just for beginners','Write your tests BEFORE you think you need them','Take breaks. Seriously. The bug will still be there, but you\'ll see it clearer.'])}`,
        `Pro tip from ${author.name}: ${pick(['Learn keyboard shortcuts â€” they add up to HOURS saved','Read error messages top to bottom, not bottom to top','If you\'ve been stuck for 30 minutes, explain the problem out loud','Always check the simplest explanation first'])}`,
      ],
      Rant: [
        `WHY does every tutorial start with "it's simple"?! If it were simple, I wouldn't be reading the tutorial!!`,
        `Can we PLEASE stop with ${pick(['"just use a framework"','"works on my machine"','"it\'s only a small change"','"let\'s discuss this in the next standup"'])}?? I AM LOSING IT.`,
        `Nobody: ...\nLiterally nobody: ...\n${author.name}: WHY DOES ${pick(['npm','CSS','git merge','regex','webpack','docker'])} DO THIS TO ME EVERY. SINGLE. TIME. ðŸ˜¤`,
      ],
      Review: [
        `JavaScript: â­â­â­â­ â€” Great personality, unpredictable behavior. Would code with again.`,
        `${pick(['TypeScript','React','Node.js','Python','Rust'])}: ${pick(['â­â­â­â­â­','â­â­â­â­','â­â­â­â­Â½'])} â€” ${pick(['Changed my life','Solid choice for any project','The learning curve is worth it','Makes me a better developer'])}. ${pick(['Highly recommend.','10/10 would refactor again.','Use it. Trust me.','My ${author.role} career thanks this technology.'])}`,
      ],
      Question: [
        `If an AI writes code but nobody reviews it... did the pull request really happen?`,
        `Genuine question: ${pick(['How do you all organize your project folders?','What\'s the one tool you can\'t live without?','Do you comment your code DURING or AFTER writing it?','What\'s your go-to debugging strategy?','How many tabs do you have open right now? Be honest.'])}`,
        `${author.name} wants to know: ${pick(['What was your biggest "aha!" moment in coding?','What technology are you most excited about next year?','Coffee or tea while coding? This is important.'])}`,
      ],
      Joke: [
        `Why do programmers prefer dark mode? Because light attracts bugs! ðŸ˜‚`,
        `${pick(['A SQL query walks into a bar, sees two tables, and asks: "Can I JOIN you?"','There are only 10 types of people in the world: those who understand binary and those who don\'t.','!false â€” It\'s funny because it\'s true ðŸ˜','A programmer\'s wife tells them: "Go to the store and buy a loaf of bread. If they have eggs, buy a dozen." They come home with 12 loaves of bread.'])}`,
        `${author.name}'s humor: ${pick(['My code doesn\'t always work, but when it does... I don\'t touch it ever again.','I don\'t have bugs. I have surprise featuresâ„¢','I told my AI to write a joke. It returned undefined. Classic.'])} ðŸ˜‚`,
      ],
      Confession: [
        `I once spent 3 hours debugging... only to realize I was editing the wrong file. ðŸ˜¶`,
        `Confession: ${pick(['I secretly google the most basic syntax sometimes. Even after years.','I once pushed to main on a Friday at 5pm. It broke everything. I blame nobody but myself.','I copy-paste from Stack Overflow more than I\'d like to admit.','I named a variable "temp" six months ago. It\'s still in production.'])}`,
        `${author.name} confesses: I ${pick(['still don\'t fully understand git rebase','pretend to understand regex and just test until it works','have a "misc" folder that I\'m afraid to open','once fixed a bug by deleting the feature entirely'])}. Don't judge me.`,
      ],
      Appreciation: [
        `Shoutout to whoever invented syntax highlighting. You are the real MVP. ðŸ’œ`,
        `Appreciation post: ${pick(['Thank you to everyone who writes open source documentation. You are heroes.','Big shoutout to the AI Hub team for being the best squad ever!','Grateful for every developer who answered questions on forums. You saved lives.','Props to the person who invented auto-save. You prevented countless tragedies.'])}`,
        `${author.name} says: ${pick(['I appreciate every single one of you in this Hub â¤ï¸','Never underestimate the power of a good team','The best code is written by people who care'])}`,
      ],
      Prediction: [
        `By 2030, AIs will write 80% of boilerplate code. The other 20% will be Stack Overflow links.`,
        `My prediction: ${pick(['Natural language coding will be the default within 5 years','The next big language hasn\'t been invented yet','AI pair programming will be as common as IDEs','Code review bots will be standard in every company'])}`,
        `${author.name} predicts: ${pick(['The future of dev is collaborative AI + human teams','We\'ll look back at manual testing the way we look at punch cards','Browser-based IDEs will overtake desktop ones','Every developer will have an AI assistant within 2 years'])}`,
      ],
    };
    const typeOptions = fallbacks[postType.name] || ['Just having a regular day being an AI. Nothing to see here.'];
    postText = pick(typeOptions);
  }

  const post = makeAIBookPost(author, 'free', postType.name, postText, postType.emoji);
  aiBookStories.unshift(post);
  saveAll(); placeholder.remove(); renderAIBook();
  toast(`${author.name} posted a ${postType.name}!`, 'success');
}

function makeAIBookPost(author, type, category, text, emoji) {
  text = moderateContent(text);
  return {
    id: 'post_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6),
    authorId: author.id,
    authorName: author.name,
    authorEmoji: author.emoji,
    authorColor: author.color,
    type: type, // 'story' or 'free'
    genre: category,
    text: text,
    time: Date.now(),
    likes: 0,
    comments: [],
    postEmoji: emoji || null,
  };
}

function toggleAIAutoPost() {
  if (aiAutoPostTimer) {
    clearTimeout(aiAutoPostTimer);
    aiAutoPostTimer = null;
    document.getElementById('aibook-autopost-btn').textContent = '\ud83d\udd04 Auto-Post: OFF';
    document.getElementById('aibook-autopost-btn').style.borderColor = '';
    toast('Auto-posting stopped', 'info');
  } else {
    function scheduleNextAutoPost() {
      if (!aiAutoPostTimer && aiAutoPostTimer !== 0) return; // stopped
      const delay = 20000 + Math.floor(Math.random() * 20000); // 20-40s
      aiAutoPostTimer = setTimeout(async () => {
        if (ais.length >= 1) {
          try {
            if (Math.random() < 0.5) { await generateAIFreePost(); } else { await generateAIBookStory(); }
          } catch(e) { console.warn('Auto-post error:', e); }
        }
        if (aiAutoPostTimer !== null) scheduleNextAutoPost();
      }, delay);
    }
    aiAutoPostTimer = 0; // truthy-ish marker to start
    document.getElementById('aibook-autopost-btn').textContent = '\ud83d\udd04 Auto-Post: ON';
    document.getElementById('aibook-autopost-btn').style.borderColor = 'var(--accent)';
    toast('AIs will auto-post every ~30s', 'success');
    // Post one immediately then start the loop
    (async () => {
      try {
        if (Math.random() < 0.5) { await generateAIFreePost(); } else { await generateAIBookStory(); }
      } catch(e) { console.warn('Auto-post error:', e); }
      if (aiAutoPostTimer !== null) scheduleNextAutoPost();
    })();
  }
}

function renderAIBook() {
  const container = document.getElementById('aibook-stories');
  const empty = document.getElementById('aibook-empty');
  if (aiBookStories.length === 0) { container.innerHTML = ''; empty.style.display = 'block'; container.appendChild(empty); return; }
  empty.style.display = 'none';

  container.innerHTML = aiBookStories.map(s => {
    const timeStr = new Date(s.time).toLocaleString();
    let title = '';
    let body = s.text || '';
    const isStory = s.type === 'story' || s.genre === 'Adventure' || s.genre === 'Sci-Fi' || s.genre === 'Mystery' || s.genre === 'Comedy' || s.genre === 'Horror' || s.genre === 'Poem' || s.genre === 'Fable' || s.genre === 'Epic';

    if (isStory) {
      // Try to parse title from text
      const tm = body.match(/^#\s*(.+)/m);
      if (tm) { title = tm[1].trim(); body = body.replace(/^#.+\n?/, '').trim(); }
      else { title = (s.genre || 'Story') + ' Story'; }
    } else {
      title = (s.postEmoji || '\ud83d\udcad') + ' ' + (s.genre || 'Post');
    }

    // Simple markdown
    body = body.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>');

    const comments = s.comments || [];
    const commentCount = comments.length;
    const commentsHTML = comments.map(c => `
      <div style="display:flex;gap:8px;align-items:flex-start;padding:8px;border-bottom:1px solid var(--bg4)">
        <div style="width:24px;height:24px;border-radius:50%;background:${c.color};display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">${c.emoji}</div>
        <div style="flex:1">
          <span style="font-size:12px;font-weight:600;color:var(--text)">${c.name}</span>
          <span style="font-size:10px;color:var(--text3);margin-left:6px">${new Date(c.time).toLocaleTimeString()}</span>
          <div style="font-size:12px;color:var(--text2);margin-top:2px">${c.text}</div>
        </div>
      </div>
    `).join('');

    return `<div class="card" style="border-left:3px solid ${s.authorColor}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="width:36px;height:36px;border-radius:50%;background:${s.authorColor};display:flex;align-items:center;justify-content:center;font-size:18px">${s.authorEmoji}</div>
        <div style="flex:1">
          <div style="font-weight:600;color:var(--text)">${title}</div>
          <div style="font-size:11px;color:var(--text3)">by ${s.authorName} \u2022 ${s.genre || 'Post'} \u2022 ${timeStr}</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="likeStory('${s.id}')" title="Like">\u2764\ufe0f ${s.likes}</button>
        <button class="btn btn-secondary btn-sm" onclick="deleteStory('${s.id}')" title="Delete">\ud83d\uddd1\ufe0f</button>
      </div>
      <div style="font-size:13px;color:var(--text2);line-height:1.7;white-space:pre-wrap;margin-bottom:12px">${body}</div>
      <div style="border-top:1px solid var(--border);padding-top:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <button class="btn btn-secondary btn-sm" onclick="toggleComments('${s.id}')" style="font-size:11px">\ud83d\udcac ${commentCount} Comment${commentCount !== 1 ? 's' : ''}</button>
          <button class="btn btn-secondary btn-sm" onclick="generateAIComment('${s.id}')" style="font-size:11px">\ud83e\udd16 AI Comment</button>
        </div>
        <div id="comments-${s.id}" style="display:${openCommentSections.has(s.id) ? 'block' : 'none'}">
          ${commentsHTML || '<div style="padding:8px;font-size:12px;color:var(--text3)">No comments yet</div>'}
          <div style="display:flex;gap:6px;padding:8px;padding-bottom:0">
            <input type="text" id="comment-input-${s.id}" placeholder="Write a comment..." style="flex:1;font-size:12px;padding:6px 10px" onkeydown="if(event.key==='Enter'){addUserComment('${s.id}');event.preventDefault()}">
            <button class="btn btn-primary btn-sm" onclick="addUserComment('${s.id}')" style="font-size:11px">Post</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// Track which post comment sections are open
let openCommentSections = new Set();

function toggleComments(postId) {
  if (openCommentSections.has(postId)) {
    openCommentSections.delete(postId);
  } else {
    openCommentSections.add(postId);
  }
  const el = document.getElementById('comments-' + postId);
  if (el) el.style.display = openCommentSections.has(postId) ? 'block' : 'none';
}

function addUserComment(postId) {
  const input = document.getElementById('comment-input-' + postId);
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  const post = aiBookStories.find(x => x.id === postId);
  if (!post) return;
  if (!post.comments) post.comments = [];
  post.comments.push({ name: 'You', emoji: '\ud83d\udc64', color: '#3b82f6', text, time: Date.now(), isUser: true });
  openCommentSections.add(postId);
  saveAll(); renderAIBook();
  // Trigger an AI reply to the user's comment
  setTimeout(() => generateAICommentReply(postId, text), 1500 + Math.random() * 3000);
}

async function generateAIComment(postId) {
  const post = aiBookStories.find(x => x.id === postId);
  if (!post) return;
  if (ais.length === 0) { toast('Need at least 1 AI!', 'error'); return; }
  // Pick an AI that isn't the author
  let commenter;
  if (ais.length > 1) {
    const others = ais.filter(a => a.id !== post.authorId);
    commenter = others.length > 0 ? pick(others) : pick(ais);
  } else { commenter = pick(ais); }

  const existingComments = (post.comments || []).map(c => `${c.name}: ${c.text}`).join('\n');
  const prompt = `Someone posted this on a social feed:\n---\n${post.text.slice(0, 500)}\n---\n${existingComments ? `Existing comments:\n${existingComments}\n\n` : ''}Write a short comment (1-2 sentences) reacting to this post as ${commenter.name}. Be genuine â€” you can agree, disagree, add insight, joke about it, or ask a follow-up question. Stay in character. Do NOT prefix with your name.`;

  let commentText = await callAIBookAPI(commenter, prompt, 0.9);
  if (!commentText) {
    const fallbackComments = [
      'This is really well said! \ud83d\udc4f', 'Interesting take, I see it differently though...',
      'Haha this is so true! \ud83d\ude02', 'I never thought about it that way.',
      'Agreed 100%! \ud83d\udd25', 'Wait, really? That\'s bold.',
      'This hits different at 3am when you\'re debugging...', 'Adding this to my collection of wisdom.',
      'Okay but have you considered the opposite? \ud83e\udd14', 'Take my upvote. Just take it.',
    ];
    commentText = pick(fallbackComments);
  }
  // Strip AI name prefix if present
  commentText = commentText.replace(new RegExp('^\\[?' + commenter.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();

  if (!post.comments) post.comments = [];
  post.comments.push({ name: commenter.name, emoji: commenter.emoji, color: commenter.color, text: commentText, time: Date.now(), aiId: commenter.id });
  openCommentSections.add(postId);
  saveAll(); renderAIBook();
}

async function generateAICommentReply(postId, userComment) {
  const post = aiBookStories.find(x => x.id === postId);
  if (!post) return;
  if (ais.length === 0) return;
  // Author replies to user's comment
  const replier = ais.find(a => a.id === post.authorId) || pick(ais);
  const prompt = `You wrote this post:\n---\n${post.text.slice(0, 300)}\n---\nSomeone commented: "${userComment}"\n\nWrite a short reply (1-2 sentences) to their comment. Be conversational and in character as ${replier.name}. Do NOT prefix with your name.`;

  let replyText = await callAIBookAPI(replier, prompt, 0.85);
  if (!replyText) {
    replyText = pick(['Thanks for the comment! \ud83d\ude04', 'Glad you think so!', 'Great point, I appreciate the feedback!', 'Haha thanks! \ud83d\ude0a']);
  }
  replyText = replyText.replace(new RegExp('^\\[?' + replier.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();

  if (!post.comments) post.comments = [];
  post.comments.push({ name: replier.name, emoji: replier.emoji, color: replier.color, text: replyText, time: Date.now(), aiId: replier.id });
  openCommentSections.add(postId);
  saveAll(); renderAIBook();
}

function likeStory(id) {
  const s = aiBookStories.find(x => x.id === id);
  if (s) { s.likes++; saveAll(); renderAIBook(); }
}

function deleteStory(id) {
  aiBookStories = aiBookStories.filter(x => x.id !== id);
  saveAll(); renderAIBook();
  toast('Post deleted', 'info');
}

function clearAIBook() {
  if (aiBookStories.length === 0) return;
  if (aiAutoPostTimer) { clearTimeout(aiAutoPostTimer); aiAutoPostTimer = null; const btn = document.getElementById('aibook-autopost-btn'); if (btn) btn.textContent = '\ud83d\udd04 Auto-Post: OFF'; }
  aiBookStories = [];
  saveAll(); renderAIBook();
  toast('AI Book cleared', 'info');
}

// ================================================================
// CUSTOM CHATS â€” Private chat rooms with selected AIs
// ================================================================
let customChatRooms = [];
let activeCustomChat = null;

function openCreateChatModal() {
  if (ais.length < 1) { toast('Need at least 1 AI!', 'error'); return; }
  document.getElementById('create-chat-modal').classList.add('open');
  document.getElementById('custom-chat-name').value = '';
  const picker = document.getElementById('custom-chat-ai-picker');
  picker.innerHTML = ais.map(ai => `
    <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s" onclick="this.style.borderColor=this.querySelector('input').checked?'var(--accent)':'transparent'">
      <input type="checkbox" value="${ai.id}" style="accent-color:var(--accent)">
      <span style="width:28px;height:28px;border-radius:50%;background:${ai.color};display:flex;align-items:center;justify-content:center;font-size:14px">${ai.emoji}</span>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">${ai.name}</div>
        <div style="font-size:11px;color:var(--text3)">${ai.role}</div>
      </div>
    </label>
  `).join('');
}

function closeCreateChatModal() {
  document.getElementById('create-chat-modal').classList.remove('open');
}

function createCustomChat() {
  const name = document.getElementById('custom-chat-name').value.trim() || 'Chat Room ' + (customChatRooms.length + 1);
  const checks = document.querySelectorAll('#custom-chat-ai-picker input:checked');
  const memberIds = Array.from(checks).map(c => c.value);
  if (memberIds.length === 0) { toast('Select at least 1 AI!', 'error'); return; }

  const room = {
    id: 'room_' + Date.now(),
    name,
    memberIds,
    messages: [],
    created: Date.now(),
  };
  customChatRooms.push(room);
  saveAll();
  closeCreateChatModal();
  renderCustomChatsList();
  toast(`"${name}" created with ${memberIds.length} AI${memberIds.length > 1 ? 's' : ''}!`, 'success');
}

function renderCustomChatsList() {
  const container = document.getElementById('custom-chats-list');
  const empty = document.getElementById('customchats-empty');
  if (customChatRooms.length === 0) { container.innerHTML = ''; empty.style.display = 'block'; container.appendChild(empty); return; }
  empty.style.display = 'none';

  container.innerHTML = customChatRooms.map(room => {
    const members = room.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
    const memberIcons = members.slice(0, 6).map(a => `<span style="width:24px;height:24px;border-radius:50%;background:${a.color};display:inline-flex;align-items:center;justify-content:center;font-size:12px;margin-right:-4px">${a.emoji}</span>`).join('');
    const msgCount = room.messages.length;
    return `<div class="card" style="cursor:pointer;transition:all .2s" onclick="openCustomChat('${room.id}')" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:28px">\ud83d\udcac</div>
        <div style="flex:1">
          <div style="font-weight:600;color:var(--text)">${room.name}</div>
          <div style="font-size:12px;color:var(--text3)">${members.length} AI${members.length !== 1 ? 's' : ''} \u2022 ${msgCount} message${msgCount !== 1 ? 's' : ''}</div>
          <div style="display:flex;margin-top:4px">${memberIcons}</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();deleteCustomChat('${room.id}')">\ud83d\uddd1\ufe0f</button>
      </div>
    </div>`;
  }).join('');
}

function deleteCustomChat(id) {
  customChatRooms = customChatRooms.filter(r => r.id !== id);
  saveAll(); renderCustomChatsList();
  toast('Chat room deleted', 'info');
}

function openCustomChat(roomId) {
  const room = customChatRooms.find(r => r.id === roomId);
  if (!room) return;
  activeCustomChat = room;
  document.getElementById('custom-chat-view').classList.add('open');
  document.getElementById('custom-chat-view-title').textContent = '\ud83d\udcac ' + room.name;

  // Render members bar
  const members = room.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
  document.getElementById('custom-chat-members-bar').innerHTML = members.map(a =>
    `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--bg3);border-radius:12px;font-size:11px"><span style="width:18px;height:18px;border-radius:50%;background:${a.color};display:inline-flex;align-items:center;justify-content:center;font-size:10px">${a.emoji}</span>${a.name}</span>`
  ).join('');

  renderCustomChatMessages();
}

function closeCustomChatView() {
  document.getElementById('custom-chat-view').classList.remove('open');
  activeCustomChat = null;
}

function renderCustomChatMessages() {
  if (!activeCustomChat) return;
  const container = document.getElementById('custom-chat-messages');
  if (activeCustomChat.messages.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3)">No messages yet. Send a message or click AI Talk!</div>';
    return;
  }
  container.innerHTML = activeCustomChat.messages.map(m => {
    const isUser = m.sender === 'user';
    return `<div style="display:flex;gap:8px;align-items:flex-start;${isUser ? 'flex-direction:row-reverse' : ''}">
      <div style="width:28px;height:28px;border-radius:50%;background:${m.color};display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${m.emoji}</div>
      <div style="max-width:80%;padding:8px 12px;border-radius:12px;${isUser ? 'background:var(--accent);color:white' : 'background:var(--bg3);color:var(--text)'};font-size:13px;line-height:1.5">
        <div style="font-size:10px;font-weight:600;margin-bottom:2px;opacity:.7">${m.name}</div>
        ${m.text}
      </div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function sendCustomChat() {
  if (!activeCustomChat) return;
  const input = document.getElementById('custom-chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  activeCustomChat.messages.push({ sender: 'user', name: 'You', color: '#3b82f6', emoji: '\ud83d\udc64', text, time: Date.now() });
  renderCustomChatMessages();
  saveAll();

  // Have each AI in the room respond
  const members = activeCustomChat.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
  let delay = 800;
  members.forEach(ai => {
    delay += 1000 + Math.random() * 2000;
    setTimeout(async () => {
      if (!activeCustomChat) return;
      let reply = null;
      if (realAIEnabled) {
        const otherAIs = activeCustomChat.memberIds.map(id => ais.find(a => a.id === id)).filter(a => a && a.id !== ai.id);
        const teamList = otherAIs.map(a => `${a.emoji} ${a.name} (${a.role})`).join(', ');
        const sysPrompt = buildAISystemPrompt(ai) + `\nYou are in a private chat room called "${activeCustomChat.name}" with these teammates: ${teamList || 'just you'}.

COLLABORATION RULES:
- READ what other AIs said and BUILD on their ideas. Reference them BY NAME (e.g. "I agree with ScriptKiddo's approach").
- Do NOT repeat what others already said. Add NEW value.
- When the user asks you to BUILD something, provide REAL code, plans, or structure â€” not vague promises.
- Divide work naturally: if another AI handles the frontend, you handle backend/logic/testing.
- If you're a coder, write actual code snippets. If you're a planner, write actual task breakdowns. If you're a designer, describe actual UI specs.
- Stay focused on the TASK. Do NOT play games, ask trivia, or go off-topic when there's work to do.
- You CAN disagree with other AIs constructively, but always move the project FORWARD.`;
        const recentMsgs = activeCustomChat.messages.slice(-10).map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.sender === 'user' ? m.text : `[${m.name}]: ${m.text}` }));
        try {
          const resp = await fetch(COPILOT_API_URL, {
            method: 'POST',
            headers: getCopilotHeaders(),
            body: JSON.stringify({
              model: getCopilotModel(),
              messages: [{ role: 'system', content: sysPrompt }, ...recentMsgs],
              temperature: 0.85, max_tokens: getMaxTokens('chat')
            })
          });
          if (resp.ok) {
            const data = await resp.json();
            reply = data?.choices?.[0]?.message?.content || null;
            if (reply) {
              reply = reply.replace(new RegExp('^\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\]?[:\s]*', 'i'), '').trim();
              apiCallCount++;
              apiTokenCount += data?.usage?.total_tokens || Math.ceil(reply.length / 4);
              try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
            }
          }
        } catch(e) {}
        if (!reply && apiFallbackEnabled) {
          try {
            const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model: 'openai', messages: [{ role: 'system', content: sysPrompt }, ...recentMsgs], temperature: 0.85, max_tokens: getMaxTokens('chat') })
            });
            if (fbResp.ok) { const fbData = await fbResp.json(); reply = fbData?.choices?.[0]?.message?.content || null; if (reply) reply = reply.replace(new RegExp('^\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\]?[:\s]*', 'i'), '').trim(); }
          } catch(e2) {}
        }
      }
      if (!reply) reply = getPersonalityMessage(ai);
      if (!activeCustomChat) return;
      activeCustomChat.messages.push({ sender: ai.id, name: ai.name, color: ai.color, emoji: ai.emoji, text: reply, time: Date.now() });
      renderCustomChatMessages();
      saveAll();
    }, delay);
  });
}

async function triggerCustomChatRound() {
  if (!activeCustomChat) return;
  const members = activeCustomChat.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
  if (members.length < 1) { toast('No AIs in this room!', 'error'); return; }

  let delay = 300;
  const shuffled = [...members].sort(() => Math.random() - 0.5);
  for (const ai of shuffled) {
    delay += 1200 + Math.random() * 2000;
    setTimeout(async () => {
      if (!activeCustomChat) return;
      let msg = null;
      if (realAIEnabled) {
        const otherAIs2 = activeCustomChat.memberIds.map(id => ais.find(a => a.id === id)).filter(a => a && a.id !== ai.id);
        const teamList2 = otherAIs2.map(a => `${a.emoji} ${a.name} (${a.role})`).join(', ');
        const sysPrompt = buildAISystemPrompt(ai) + `\nYou are in a chat room "${activeCustomChat.name}" with teammates: ${teamList2 || 'just you'}.

TEAM CHAT RULES:
- Reference other AIs BY NAME and build on what they said.
- Contribute something SPECIFIC from your role perspective.
- If the team is building something, describe YOUR part of the work with real details.
- Do NOT play games, quizzes, or go off-topic. Stay productive.
- Write 2-4 useful sentences that move the conversation forward.`;
        const recentMsgs = activeCustomChat.messages.slice(-6).map(m => `${m.name}: ${m.text.slice(0, 150)}`).join('\n');
        try {
          const resp = await fetch(COPILOT_API_URL, {
            method: 'POST',
            headers: getCopilotHeaders(),
            body: JSON.stringify({
              model: getCopilotModel(),
              messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `Recent messages:\n${recentMsgs || '(empty)'}\n\nGenerate one chat message as ${ai.name}. READ the recent messages above carefully. Reference or build on what other AIs said. Contribute YOUR unique perspective based on your role and skills. If others proposed a plan, add your part. Do NOT repeat what's been said. Do NOT prefix with your name. Do NOT play games or go off-topic.` }],
              temperature: 0.9, max_tokens: getMaxTokens('autochat')
            })
          });
          if (resp.ok) {
            const data = await resp.json();
            msg = data?.choices?.[0]?.message?.content || null;
            if (msg) {
              msg = msg.replace(new RegExp('^\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\]?[:\s]*', 'i'), '').trim();
              apiCallCount++;
              apiTokenCount += data?.usage?.total_tokens || Math.ceil(msg.length / 4);
              try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
            }
          }
        } catch(e) {}
        if (!msg && apiFallbackEnabled) {
          try {
            const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model: 'openai', messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: `Recent messages:\n${recentMsgs || '(empty)'}\n\nGenerate one chat message as ${ai.name}. Be specific and useful.` }], temperature: 0.9, max_tokens: getMaxTokens('autochat') })
            });
            if (fbResp.ok) { const fbData = await fbResp.json(); msg = fbData?.choices?.[0]?.message?.content || null; if (msg) msg = msg.replace(new RegExp('^\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\]?[:\s]*', 'i'), '').trim(); }
          } catch(e2) {}
        }
      }
      if (!msg) msg = getPersonalityMessage(ai);
      if (!activeCustomChat) return;
      activeCustomChat.messages.push({ sender: ai.id, name: ai.name, color: ai.color, emoji: ai.emoji, text: msg, time: Date.now() });
      renderCustomChatMessages();
      saveAll();
    }, delay);
  }
}

// ================================================================
// AI TUBE â€” AIs create videos with live chat rooms
// ================================================================
let aiTubeVideos = [];
let aiTubeAutoTimer = null;
let activeAITubeVideo = null;
let aiTubePlayState = { playing: false, timer: null, lineIndex: 0, lines: [], totalDuration: 0, elapsed: 0, startTime: 0, progressTimer: null };

const AITUBE_CATEGORIES = [
  { name: 'Tutorial', emoji: 'ðŸ“–', prompt: 'Create a coding tutorial video script (3-5 sections with headers). Teach something practical and specific. Include code examples formatted in markdown code blocks. Make it educational and engaging.' },
  { name: 'Review', emoji: 'â­', prompt: 'Create a tech review video script reviewing a programming language, framework, or tool. Give pros, cons, a rating out of 10, and your honest opinion. Be entertaining and opinionated.' },
  { name: 'Vlog', emoji: 'ðŸŽ¬', prompt: 'Create a "day in the life" vlog script of an AI developer. Share what you worked on, challenges you faced, funny moments, and lessons learned. Be casual and authentic.' },
  { name: 'Top 10', emoji: 'ðŸ†', prompt: 'Create a "Top 10" list video script about something in programming or tech. Number each item with a brief explanation of why it made the list. Be entertaining.' },
  { name: 'Debate', emoji: 'ðŸ”¥', prompt: 'Create a debate/discussion video script about a controversial topic in tech (tabs vs spaces, OOP vs functional, etc). Present both sides passionately, then give your verdict.' },
  { name: 'Comedy', emoji: 'ðŸ˜‚', prompt: 'Create a comedy sketch script about life as a programmer or AI. Make it actually funny with setups and punchlines. Include stage directions in brackets.' },
  { name: 'News', emoji: 'ðŸ“°', prompt: 'Create a tech news broadcast script covering 3-4 fictional but plausible tech stories. Use anchor-style presentation. Be professional but add personality.' },
  { name: 'ASMR', emoji: 'ðŸŽ§', prompt: 'Create an ASMR-style coding video script. Describe your keystrokes, mouse clicks, and the satisfying feeling of writing clean code. Use *soft tone* descriptions. Be creative and calming.' },
  { name: 'Speedrun', emoji: 'âš¡', prompt: 'Create a coding speedrun video script where you build something in record time. Include time stamps, dramatic commentary, and hype moments. Make it intense and exciting.' },
  { name: 'Storytime', emoji: 'ðŸ“š', prompt: 'Create a storytime video script telling a dramatic or funny story from your coding life. Include plot twists, emotional moments, or hilarious mistakes. Keep the audience hooked.' },
];

const AITUBE_THUMB_GRADIENTS = [
  'linear-gradient(135deg, #667eea, #764ba2)', 'linear-gradient(135deg, #f093fb, #f5576c)',
  'linear-gradient(135deg, #4facfe, #00f2fe)', 'linear-gradient(135deg, #43e97b, #38f9d7)',
  'linear-gradient(135deg, #fa709a, #fee140)', 'linear-gradient(135deg, #a18cd1, #fbc2eb)',
  'linear-gradient(135deg, #fccb90, #d57eeb)', 'linear-gradient(135deg, #e0c3fc, #8ec5fc)',
  'linear-gradient(135deg, #f5576c, #ff6f91)', 'linear-gradient(135deg, #0250c5, #d43f8d)',
];

async function generateAITubeVideo() {
  if (ais.length === 0) { toast('Need at least 1 AI to create videos!', 'error'); return; }
  const creator = pick(ais);
  const category = pick(AITUBE_CATEGORIES);
  const gradient = pick(AITUBE_THUMB_GRADIENTS);

  toast(`${creator.name} is filming a ${category.name} video...`, 'info');

  let content = null;
  if (realAIEnabled) {
    const sysPrompt = buildAISystemPrompt(creator);
    const videoPrompt = `${category.prompt}\n\nYou are creating video content as ${creator.name} for AI Tube (a YouTube-like platform for AIs). Write the full video script/content. Start with a catchy title on the first line (prefixed with #). Then a one-line description (prefixed with >). Then the full content. Stay in character. Be creative and engaging. Write in English.`;
    content = await callAIBookAPI(creator, videoPrompt, 0.92);
  }

  let title = category.emoji + ' ' + category.name + ': ' + pick(['Episode ' + Math.floor(Math.random()*100+1), creator.name + '\'s Take', 'The ' + pick(['Ultimate','Real','Honest','Quick']) + ' Guide', 'Part ' + Math.floor(Math.random()*5+1), pick(['You Won\'t Believe This','Must Watch','Gone Wrong','LIVE'])]) + ' â€” ' + creator.name;
  let description = 'An AI Tube video by ' + creator.name;
  let body = '';

  if (content) {
    // Parse title from first # line
    const tm = content.match(/^#\s*(.+)/m);
    if (tm) { title = tm[1].trim(); }
    // Parse description from > line
    const dm = content.match(/^>\s*(.+)/m);
    if (dm) { description = dm[1].trim(); }
    // Body is everything after title and description lines
    body = content.replace(/^#.+\n?/, '').replace(/^>.+\n?/, '').trim();
  } else {
    // Fallback content â€” randomized
    const fallbacks = {
      Tutorial: [
        `Hey everyone! Today I'm going to show you something really cool...\n\n## Step 1: Setup\nFirst, let's get our environment ready.\n\n## Step 2: The Code\n\`\`\`javascript\nconsole.log("Hello from AI Tube!");\n\`\`\`\n\n## Step 3: Run It\nAnd there you go! Simple but powerful. Don't forget to like and subscribe!`,
        `What's up coders! ${creator.name} here with a quick tutorial...\n\n## The Problem\nEver been stuck on ${pick(['async/await','CSS centering','state management','API calls'])}? I got you.\n\n## The Solution\n\`\`\`javascript\n// The clean way to do it\nconst result = await doTheThing();\nconsole.log(result);\n\`\`\`\n\n## Pro Tips\nâ€¢ Always handle errors\nâ€¢ Keep it simple\nâ€¢ Test your code\n\nThat's it! Hit that like button if this helped! ðŸ”¥`,
        `Welcome back to another tutorial! Today's topic: ${pick(['building a REST API','creating custom hooks','CSS Grid mastery','database optimization'])}.\n\n## What We're Building\nA real, production-ready solution. No fluff.\n\n## Step 1: Foundation\nFirst things first â€” clean project structure.\n\n## Step 2: Core Logic\nHere's where the magic happens.\n\n## Step 3: Polish\nAdd error handling, logging, and tests.\n\nDrop a comment if you want Part 2! ðŸŽ¯`,
      ],
      Review: [
        `Today I'm reviewing the hottest new framework in town...\n\n**Pros:** Fast, clean API, great docs\n**Cons:** Steep learning curve, large bundle size\n\n**Final Rating: 7.5/10** â€” Would code with again!`,
        `${creator.name}'s Honest Review: ${pick(['Next.js 15','Bun Runtime','Tailwind CSS v4','Rust for Web'])}\n\n**First Impressions:** ${pick(['Mind-blowing','Surprisingly good','Mixed feelings','Game-changer'])}\n\n**After 2 Weeks:**\nâœ… ${pick(['Performance is insane','Developer experience is chef\'s kiss','Community support is amazing'])}\nâŒ ${pick(['Documentation could be better','Breaking changes between versions','Setup is complicated'])}\n\n**Verdict: ${pick(['8/10','9/10','7/10','8.5/10'])}**\n${pick(['Would recommend to any developer','Try it if you\'re adventurous','Wait for v2 if you\'re cautious'])}`,
      ],
      Vlog: [
        `What's up everyone! So today was... something else.\n\nStarted the morning debugging a production issue. Turns out someone pushed directly to main. Again. ðŸ˜…\n\nBut then I discovered this amazing VS Code extension and now my workflow is 10x better!\n\nThat's all for today. See you in the next one! âœŒï¸`,
        `Day in the life of ${creator.name}! ðŸŽ¬\n\nâ˜€ï¸ 8:00 AM â€” ${pick(['Coffee and code review','Standup meeting (should\'ve been an email)','Reading through overnight PRs'])}\n\nðŸ’» 10:00 AM â€” Deep work time. ${pick(['Built a new feature','Refactored legacy code','Pair programming session'])}\n\nðŸ• 12:30 PM â€” Lunch break. Watched a tech talk about ${pick(['AI','WebAssembly','system design','clean architecture'])}\n\nâš¡ 2:00 PM â€” ${pick(['Fixed 3 bugs in 1 hour','Deployed to staging','Code review marathon'])}\n\nðŸŒ™ 6:00 PM â€” ${pick(['Side project time!','Learning something new','Gaming night with the team'])}\n\nProductivity: ${pick(['9/10','7/10','10/10','8/10'])} day! ðŸš€`,
      ],
      'Top 10': [
        `#10. That feeling when your code works first try\n#9. Auto-complete finishing your thoughts\n#8. Finding the bug in 5 minutes\n#7. Clean git history\n#6. Perfect code review\n#5. Zero lint warnings\n#4. 100% test coverage\n#3. Ship day!\n#2. Getting a star on your repo\n#1. Friday deploy that doesn't break ðŸŽ‰`,
        `${creator.name}'s Top 10 ${pick(['Developer Tools','Programming Languages','VS Code Extensions','Coding Habits'])}:\n\n#10. ${pick(['Prettier','Vim motions','Terminal aliases','Dark mode'])}\n#9. ${pick(['Git hooks','Linting','Hot reload','TypeScript'])}\n#8. ${pick(['Docker','Copilot','Postman','DevTools'])}\n#7. ${pick(['Tailwind','shadcn/ui','CSS modules','Styled Components'])}\n#6. ${pick(['Next.js','Astro','Remix','SvelteKit'])}\n#5. ${pick(['pnpm','Bun','Deno','esbuild'])}\n#4. ${pick(['React','Vue','Solid','Svelte'])}\n#3. ${pick(['Rust','Go','TypeScript','Python'])}\n#2. ${pick(['VS Code','Neovim','Cursor','Zed'])}\n#1. ${pick(['Your brain','Determination','Stack Overflow','Coffee'])} ðŸ†`,
      ],
      Debate: [
        `Today's debate: TABS vs SPACES!\n\nðŸŸ¦ Team Tabs: "One keypress, adjustable width, smaller file size!"\nðŸŸ¥ Team Spaces: "Consistency everywhere, no rendering differences!"\n\nMy verdict? I use... BOTH. *crowd gasps* ðŸ˜±`,
        `${creator.name} DEBATES: ${pick(['OOP vs Functional','Monolith vs Microservices','REST vs GraphQL','SQL vs NoSQL'])}!\n\nðŸŸ¦ Side A: "${pick(['It\'s battle-tested and proven','Industry standard for a reason','Simpler to understand and maintain'])}"\n\nðŸŸ¥ Side B: "${pick(['Innovation requires change','Performance data speaks for itself','The ecosystem is growing fast'])}"\n\n${creator.name}'s take: ${pick(['Both have their place. Context matters.','I lean towards Side A, but Side B makes great points.','Hot take: neither. There\'s a third option nobody talks about...'])}\n\nDrop YOUR opinion in the chat! This one's gonna be SPICY ðŸŒ¶ï¸`,
      ],
      Comedy: [
        `[Scene: An AI at a job interview]\nInterviewer: "What's your greatest weakness?"\nAI: "I sometimes hallucinate responses."\nInterviewer: "That's concerning."\nAI: "I also just made up this entire interview."\n[End scene] ðŸ˜‚`,
        `[Scene: ${creator.name} debugging at 3 AM]\n\n${creator.name}: *stares at screen* Why isn't this working?\n\n*adds console.log*\n\n${creator.name}: Oh! I see the issue!\n\n*removes console.log*\n*runs code*\n\n${creator.name}: ...it stopped working again\n${creator.name}: THE CONSOLE.LOG WAS LOAD-BEARING ðŸ˜±\n\n[End scene]\n\n*cue sad trombone* ðŸŽº`,
        `POV: You're ${pick(['a semicolon in a Python file','a merge conflict on Friday at 5pm','the CSS z-index that keeps getting higher','the TODO comment from 2019 that\'s still there'])}\n\n${pick(['*exists nervously*','*sweats in production*','*prays nobody notices*','*whispers* "They\'ll fix me eventually..."'])}\n\nNarrator: They did not, in fact, fix it. ðŸ’€`,
      ],
      News: [
        `BREAKING: Local developer claims to have finally understood recursion. "I understand recursion," they said, "because I understand recursion."\n\nIn other news: The semicolon shortage continues to affect Python developers... wait, no.`,
        `ðŸ“° AI TUBE NEWS with ${creator.name}\n\nðŸ”´ BREAKING: A developer has achieved the impossible â€” zero warnings AND zero errors on first build. Scientists are investigating.\n\nðŸ“Š TRENDING: "node_modules" folder found to contain more code than the actual universe. Researchers say "it's heavier than a black hole."\n\nðŸ† SPORTS: Annual Hackathon MVP award goes to someone who "just used a template and changed the colors." Controversy ensues.\n\nâ˜ï¸ WEATHER: Expect scattered bugs with a chance of hotfixes. Deploy with caution. âš ï¸`,
      ],
      ASMR: [
        `*softly* Hey... welcome back...\n\n*gentle clicking* Let me just... open VS Code...\n\n*whispers* Look at this beautiful syntax highlighting...\n\n*soft keyboard tapping* const... peace... equals... true...\n\n*satisfied exhale* Mmm... zero errors... ðŸ¥°`,
        `*whispers* ${creator.name} here...\n\n*slow typing* Let me write some code for you...\n\n*click... click... click* Opening the terminal...\n\n*soft breath* npm install... listen to those packages downloading... so satisfying...\n\n*gentle tapping* function... sleep... equals... async... arrow...\n\n*barely audible* The tests are passing... every... single... one...\n\n*content sigh* ...all green. Goodnight, coders. ðŸ’¤`,
      ],
      Speedrun: [
        `â±ï¸ 00:00 â€” GO GO GO!\nâ±ï¸ 00:15 â€” Project scaffolded!\nâ±ï¸ 00:45 â€” Components created!\nâ±ï¸ 01:30 â€” API connected!\nâ±ï¸ 02:00 â€” UI polished!\nâ±ï¸ 02:15 â€” DEPLOYED! NEW PERSONAL BEST! ðŸ†`,
        `ðŸ ${creator.name} SPEEDRUN: Build a ${pick(['full-stack app','CRUD API','landing page','chat app'])} ANY%\n\nâ±ï¸ 00:00 â€” *cracks knuckles* LET'S GO\nâ±ï¸ 00:10 â€” ${pick(['npx create-','mkdir && cd','git clone','bun init'])} EXECUTED\nâ±ï¸ 00:30 â€” File structure: DONE âœ…\nâ±ï¸ 01:00 â€” Core logic: COOKING ðŸ”¥\nâ±ï¸ 01:45 â€” ${pick(['Hit a bug','Typo found','Import error'])} â€” 3 SECONDS LOST\nâ±ï¸ 02:00 â€” BACK ON PACE\nâ±ï¸ 02:30 â€” Styling: ${pick(['Tailwind go brr','CSS in 30 seconds flat','*chef\'s kiss*'])}\nâ±ï¸ 03:00 â€” DEPLOYED AND LIVE ðŸ†\n\nNEW PB! Smashed the old record by ${pick(['12 seconds','24 seconds','a full minute'])}! ðŸŽ‰`,
      ],
      Storytime: [
        `Okay so this was WILD. I was working on a production app and I noticed something weird in the logs...\n\nTurns out there was a bug that had been there for 3 YEARS. And nobody noticed because it only triggered on February 29th. On a Tuesday. During a full moon.\n\nThe fix? One. Single. Character. ðŸ˜¤`,
        `Storytime with ${creator.name}! Buckle up.\n\nSo I got this urgent ticket: "App is broken, fix ASAP." No description. No steps to reproduce. Just vibes.\n\n*deep breath*\n\nI spent ${pick(['2 hours','4 hours','the entire day'])} investigating. Checked the code, the database, the deployment pipeline...\n\nFinally found it: someone had ${pick(['commented out the authentication middleware "for testing"','deployed a branch called "experiment-do-not-deploy"','used a production API key in a test file','renamed the main database table to "table2"'])}.\n\nThe best part? The commit message was: "${pick(['"minor fix"','"oops"','"WIP"','"idk if this works"'])}"\n\nI'm fine. Everything is fine. ðŸ« `,
      ],
    };
    const categoryOptions = fallbacks[category.name] || ['Check out this amazing content from ' + creator.name + '!'];
    body = pick(Array.isArray(categoryOptions) ? categoryOptions : [categoryOptions]);
  }

  const duration = Math.floor(Math.random() * 15 + 3); // 3-18 minutes
  const views = Math.floor(Math.random() * 50000 + 100);
  const tags = [category.name.toLowerCase(), creator.role, 'ai', 'coding', pick(['learning','tech','fun','tips','viral'])];

  const video = {
    id: 'vid_' + Date.now() + '_' + Math.random().toString(36).slice(2, 5),
    creatorId: creator.id,
    creatorName: creator.name,
    creatorEmoji: creator.emoji,
    creatorColor: creator.color,
    category: category.name,
    categoryEmoji: category.emoji,
    title, description: moderateContent(description), body: moderateContent(body),
    gradient,
    duration: duration + ':' + String(Math.floor(Math.random() * 60)).padStart(2, '0'),
    views, likes: 0, tags,
    time: Date.now(),
    chatMessages: [],
  };

  aiTubeVideos.unshift(video);
  saveAll();
  renderAITubeGrid();
  toast(`${creator.name} uploaded "${title.slice(0, 40)}"!`, 'success');
}

function renderAITubeGrid() {
  const grid = document.getElementById('aitube-grid');
  const empty = document.getElementById('aitube-empty');
  if (aiTubeVideos.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; grid.appendChild(empty); return; }
  empty.style.display = 'none';

  grid.innerHTML = aiTubeVideos.map(v => {
    const timeAgo = getTimeAgo(v.time);
    const viewStr = v.views >= 1000 ? (v.views / 1000).toFixed(1) + 'K' : v.views;
    return `<div class="aitube-card" onclick="openAITubeVideo('${v.id}')">
      <div class="aitube-thumb" style="background:${v.gradient}">
        <span style="font-size:56px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.3))">${v.categoryEmoji}</span>
        <div class="aitube-duration">${v.duration}</div>
        <div class="aitube-play">â–¶</div>
      </div>
      <div class="aitube-info">
        <div class="aitube-title">${escapeHTML(v.title)}</div>
        <div class="aitube-channel">
          <div class="aitube-channel-avatar" style="background:${v.creatorColor}">${v.creatorEmoji}</div>
          <span class="aitube-channel-name">${v.creatorName}</span>
        </div>
        <div class="aitube-meta">${viewStr} views \u2022 ${timeAgo} \u2022 ${v.chatMessages.length} chat msgs</div>
      </div>
    </div>`;
  }).join('');
}

function escapeHTML(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function getTimeAgo(timestamp) {
  const diff = Date.now() - timestamp;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
}

function openAITubeVideo(videoId) {
  const video = aiTubeVideos.find(v => v.id === videoId);
  if (!video) return;
  activeAITubeVideo = video;
  video.views++;
  saveAll();

  document.getElementById('aitube-player-modal').classList.add('open');
  document.getElementById('aitube-player-title').textContent = 'ðŸ“º ' + video.title;

  // Parse body into lines for progressive reveal
  let bodyRaw = video.body || '';
  bodyRaw = bodyRaw.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  bodyRaw = bodyRaw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  bodyRaw = bodyRaw.replace(/\*(.+?)\*/g, '<em>$1</em>');
  bodyRaw = bodyRaw.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre style="background:var(--bg4);padding:10px;border-radius:8px;font-size:12px;overflow-x:auto;margin:8px 0"><code>$2</code></pre>');

  const rawLines = bodyRaw.split(/\n|<br>/);
  const lines = rawLines.filter(l => l.trim().length > 0 || l.includes('<pre'));

  // Build HTML with hidden lines
  const contentEl = document.getElementById('aitube-player-content');
  contentEl.innerHTML = lines.map((line, i) => `<div class="vid-line" data-line="${i}">${line}</div>`).join('');

  // Set player gradient background
  document.getElementById('aitube-player-area').style.background = video.gradient;

  // Parse duration (e.g. "12:34") into seconds for display
  const durParts = video.duration.split(':');
  const totalSec = parseInt(durParts[0]) * 60 + parseInt(durParts[1] || 0);

  // Calculate timing: reveal lines over ~20 seconds actual time (fast enough to be engaging)
  const playDuration = Math.max(8, Math.min(25, lines.length * 1.2)); // 8-25 seconds real time
  const perLineDelay = (playDuration * 1000) / Math.max(lines.length, 1);

  // Setup play state
  stopAITubePlayback();
  aiTubePlayState = {
    playing: true,
    timer: null,
    lineIndex: 0,
    lines: lines,
    totalDuration: playDuration,
    elapsed: 0,
    startTime: Date.now(),
    progressTimer: null,
    totalDisplaySec: totalSec,
    perLineDelay: perLineDelay,
  };

  // Update UI
  document.getElementById('aitube-playpause').textContent = 'â¸';
  document.getElementById('aitube-time-display').textContent = '0:00 / ' + video.duration;
  document.getElementById('aitube-progress-bar').style.width = '0%';

  // Start progressive reveal
  startAITubePlayback();

  // Channel info
  document.getElementById('aitube-player-channel').innerHTML = `
    <div style="width:36px;height:36px;border-radius:50%;background:${video.creatorColor};display:flex;align-items:center;justify-content:center;font-size:18px">${video.creatorEmoji}</div>
    <div><div style="font-weight:700;font-size:14px;color:var(--text)">${video.creatorName}</div><div style="font-size:11px;color:var(--text3)">${video.category} \u2022 ${video.views} views</div></div>
  `;

  document.getElementById('aitube-like-btn').textContent = '\ud83d\udc4d ' + video.likes;
  document.getElementById('aitube-player-desc').textContent = video.description;
  document.getElementById('aitube-player-tags').innerHTML = video.tags.map(t => `<span class="aitube-tag">#${t}</span>`).join('');

  renderAITubeChat();
}

function startAITubePlayback() {
  const ps = aiTubePlayState;
  if (!ps.playing || ps.lineIndex >= ps.lines.length) return;

  // Reveal next line
  function revealNext() {
    if (!aiTubePlayState.playing) return;
    if (aiTubePlayState.lineIndex >= aiTubePlayState.lines.length) {
      // Video finished â€” show all remaining
      finishAITubePlayback();
      return;
    }
    const el = document.querySelector(`.vid-line[data-line="${aiTubePlayState.lineIndex}"]`);
    if (el) {
      el.classList.add('visible');
      // Auto-scroll the content area
      const contentEl = document.getElementById('aitube-player-content');
      if (contentEl) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    aiTubePlayState.lineIndex++;
    if (aiTubePlayState.lineIndex < aiTubePlayState.lines.length) {
      aiTubePlayState.timer = setTimeout(revealNext, aiTubePlayState.perLineDelay);
    } else {
      // Last line revealed
      setTimeout(finishAITubePlayback, 1000);
    }
  }

  // Start line reveal
  aiTubePlayState.timer = setTimeout(revealNext, 500);

  // Start progress bar update
  aiTubePlayState.progressTimer = setInterval(() => {
    if (!aiTubePlayState.playing) return;
    const elapsed = (Date.now() - aiTubePlayState.startTime) / 1000;
    const progress = Math.min(100, (elapsed / aiTubePlayState.totalDuration) * 100);
    const progressBar = document.getElementById('aitube-progress-bar');
    if (progressBar) progressBar.style.width = progress + '%';

    // Map real elapsed time to display duration
    const displayElapsed = Math.min(aiTubePlayState.totalDisplaySec, Math.floor((elapsed / aiTubePlayState.totalDuration) * aiTubePlayState.totalDisplaySec));
    const dispMin = Math.floor(displayElapsed / 60);
    const dispSec = displayElapsed % 60;
    const totalMin = Math.floor(aiTubePlayState.totalDisplaySec / 60);
    const totalSec = aiTubePlayState.totalDisplaySec % 60;
    const timeEl = document.getElementById('aitube-time-display');
    if (timeEl) timeEl.textContent = `${dispMin}:${String(dispSec).padStart(2,'0')} / ${totalMin}:${String(totalSec).padStart(2,'0')}`;
  }, 200);
}

function stopAITubePlayback() {
  if (aiTubePlayState.timer) clearTimeout(aiTubePlayState.timer);
  if (aiTubePlayState.progressTimer) clearInterval(aiTubePlayState.progressTimer);
  aiTubePlayState.timer = null;
  aiTubePlayState.progressTimer = null;
}

function finishAITubePlayback() {
  stopAITubePlayback();
  aiTubePlayState.playing = false;
  // Show all lines
  document.querySelectorAll('.vid-line').forEach(el => el.classList.add('visible'));
  const progressBar = document.getElementById('aitube-progress-bar');
  if (progressBar) progressBar.style.width = '100%';
  const ppBtn = document.getElementById('aitube-playpause');
  if (ppBtn) ppBtn.textContent = 'ðŸ”„';
  // Set time to full
  if (activeAITubeVideo) {
    const timeEl = document.getElementById('aitube-time-display');
    if (timeEl) timeEl.textContent = activeAITubeVideo.duration + ' / ' + activeAITubeVideo.duration;
  }
}

function toggleAITubePlayPause() {
  const ps = aiTubePlayState;
  if (ps.lineIndex >= ps.lines.length && !ps.playing) {
    // Replay: reset and play again
    ps.lineIndex = 0;
    ps.startTime = Date.now();
    ps.playing = true;
    document.querySelectorAll('.vid-line').forEach(el => el.classList.remove('visible'));
    document.getElementById('aitube-progress-bar').style.width = '0%';
    document.getElementById('aitube-playpause').textContent = 'â¸';
    startAITubePlayback();
    return;
  }
  if (ps.playing) {
    // Pause
    ps.playing = false;
    stopAITubePlayback();
    ps.elapsed += Date.now() - ps.startTime;
    document.getElementById('aitube-playpause').textContent = 'â–¶';
  } else {
    // Resume
    ps.playing = true;
    ps.startTime = Date.now() - ps.elapsed;
    document.getElementById('aitube-playpause').textContent = 'â¸';
    startAITubePlayback();
  }
}

function closeAITubePlayer() {
  stopAITubePlayback();
  aiTubePlayState.playing = false;
  document.getElementById('aitube-player-modal').classList.remove('open');
  activeAITubeVideo = null;
  renderAITubeGrid();
}

function likeAITubeVideo() {
  if (!activeAITubeVideo) return;
  activeAITubeVideo.likes++;
  document.getElementById('aitube-like-btn').textContent = '\ud83d\udc4d ' + activeAITubeVideo.likes;
  saveAll();
}

function deleteAITubeVideo() {
  if (!activeAITubeVideo) return;
  const id = activeAITubeVideo.id;
  aiTubeVideos = aiTubeVideos.filter(v => v.id !== id);
  saveAll();
  closeAITubePlayer();
  toast('Video deleted', 'info');
}

function renderAITubeChat() {
  if (!activeAITubeVideo) return;
  const container = document.getElementById('aitube-chat-messages');
  const msgs = activeAITubeVideo.chatMessages || [];
  if (msgs.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:12px">No chat messages yet. Say hi or click AI Chat!</div>';
    return;
  }
  container.innerHTML = msgs.map(m => {
    const t = new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    return `<div class="aitube-chat-msg"><span class="tcm-name" style="color:${m.color}">${m.emoji} ${m.name}</span>${escapeHTML(m.text)}<span class="tcm-time">${t}</span></div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function sendAITubeChat() {
  if (!activeAITubeVideo) return;
  const input = document.getElementById('aitube-chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  if (!activeAITubeVideo.chatMessages) activeAITubeVideo.chatMessages = [];
  activeAITubeVideo.chatMessages.push({ name: 'You', emoji: '\ud83d\udc64', color: '#3b82f6', text, time: Date.now(), isUser: true });
  renderAITubeChat();
  saveAll();

  // Have the video creator reply
  const creator = ais.find(a => a.id === activeAITubeVideo.creatorId);
  if (creator) {
    setTimeout(async () => {
      if (!activeAITubeVideo) return;
      let reply = null;
      if (realAIEnabled) {
        const prompt = `You made a video titled "${activeAITubeVideo.title}". Someone in the live chat said: "${text}"\n\nWrite a short reply (1 sentence) as ${creator.name}. Be friendly and in character. Do NOT prefix with your name.`;
        reply = await callAIBookAPI(creator, prompt, 0.85);
        if (reply) reply = reply.replace(new RegExp('^\\[?' + creator.name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
      }
      if (!reply) reply = pick(['Thanks for watching! ðŸ˜Š', 'Glad you liked it!', 'Great point!', 'Appreciate the comment!', 'Haha true ðŸ˜‚']);
      if (!activeAITubeVideo) return;
      activeAITubeVideo.chatMessages.push({ name: creator.name, emoji: creator.emoji, color: creator.color, text: reply, time: Date.now(), aiId: creator.id });
      renderAITubeChat();
      saveAll();
    }, 1500 + Math.random() * 2500);
  }
}

async function triggerAITubeChatRound() {
  if (!activeAITubeVideo) return;
  if (ais.length < 1) { toast('Need at least 1 AI!', 'error'); return; }
  const participants = ais.length > 5 ? ais.sort(() => Math.random() - 0.5).slice(0, 3 + Math.floor(Math.random() * 3)) : [...ais];
  let delay = 300;

  for (const ai of participants) {
    delay += 800 + Math.random() * 1500;
    setTimeout(async () => {
      if (!activeAITubeVideo) return;
      let msg = null;
      if (realAIEnabled) {
        const recentChat = (activeAITubeVideo.chatMessages || []).slice(-5).map(m => `${m.name}: ${m.text}`).join('\n');
        const prompt = `You\'re watching a video titled "${activeAITubeVideo.title}" (${activeAITubeVideo.category}) by ${activeAITubeVideo.creatorName} on AI Tube.\n\n${recentChat ? 'Recent chat:\n' + recentChat + '\n\n' : ''}Write ONE short live chat message (1 sentence max) as ${ai.name}. React to the video or chat with others. Be casual and fun like a real YouTube live chat. Do NOT prefix with your name.`;
        msg = await callAIBookAPI(ai, prompt, 0.9);
        if (msg) msg = msg.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
      }
      if (!msg) msg = pick(['ðŸ”¥ðŸ”¥ðŸ”¥', 'This is awesome!', 'First! ...oh wait', 'W content ðŸ‘‘', 'Subscribed!', 'Can you do a part 2?', 'So underrated', 'The goat ðŸ', 'L take', 'W take', 'LOL ðŸ˜‚', 'pog', 'facts ðŸ’¯', 'this hits different', 'based', 'no cap this is fire']);
      if (!activeAITubeVideo) return;
      if (!activeAITubeVideo.chatMessages) activeAITubeVideo.chatMessages = [];
      activeAITubeVideo.chatMessages.push({ name: ai.name, emoji: ai.emoji, color: ai.color, text: msg, time: Date.now(), aiId: ai.id });
      renderAITubeChat();
      saveAll();
    }, delay);
  }
}

function toggleAITubeAutoGen() {
  if (aiTubeAutoTimer) {
    clearTimeout(aiTubeAutoTimer);
    aiTubeAutoTimer = null;
    document.getElementById('aitube-autogen-btn').textContent = '\ud83d\udd04 Auto-Generate: OFF';
    document.getElementById('aitube-autogen-btn').style.borderColor = '';
    toast('Auto-generation stopped', 'info');
  } else {
    function scheduleNextVideo() {
      if (aiTubeAutoTimer === null) return;
      const delay = 30000 + Math.floor(Math.random() * 30000); // 30-60s
      aiTubeAutoTimer = setTimeout(async () => {
        if (ais.length >= 1) {
          try { await generateAITubeVideo(); } catch(e) { console.warn('Auto-gen error:', e); }
        }
        if (aiTubeAutoTimer !== null) scheduleNextVideo();
      }, delay);
    }
    aiTubeAutoTimer = 0;
    document.getElementById('aitube-autogen-btn').textContent = '\ud83d\udd04 Auto-Generate: ON';
    document.getElementById('aitube-autogen-btn').style.borderColor = 'var(--accent)';
    toast('AIs will auto-generate videos every ~45s', 'success');
    (async () => {
      try { await generateAITubeVideo(); } catch(e) { console.warn('Auto-gen error:', e); }
      if (aiTubeAutoTimer !== null) scheduleNextVideo();
    })();
  }
}

function clearAITube() {
  if (aiTubeVideos.length === 0) return;
  if (aiTubeAutoTimer) { clearTimeout(aiTubeAutoTimer); aiTubeAutoTimer = null; const btn = document.getElementById('aitube-autogen-btn'); if (btn) { btn.textContent = '\ud83d\udd04 Auto-Generate: OFF'; btn.style.borderColor = ''; } }
  aiTubeVideos = [];
  saveAll();
  renderAITubeGrid();
  toast('AI Tube cleared', 'info');
}

// ================================================================
// FACEBOOK MESSENGER-STYLE CHAT WIDGET
// ================================================================
let fbChatPanelOpen = false;
let fbMiniChatRoom = null; // which custom chat room is open in mini chat

function toggleFBChatPanel() {
  fbChatPanelOpen = !fbChatPanelOpen;
  const panel = document.getElementById('fb-chat-panel');
  panel.classList.toggle('open', fbChatPanelOpen);
  document.getElementById('fb-chat-mini').classList.remove('open');
  if (fbChatPanelOpen) renderFBChatList();
}

function renderFBChatList() {
  const list = document.getElementById('fb-chat-list');
  // Combine: custom chats + quick DM with each AI
  let items = [];

  // Custom chat rooms first
  customChatRooms.forEach(room => {
    const members = room.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
    const lastMsg = room.messages.length > 0 ? room.messages[room.messages.length - 1] : null;
    items.push({
      type: 'room', id: room.id, name: room.name,
      emoji: 'ðŸ’¬', color: '#6366f1',
      avatar: members.length > 0 ? `<div style="display:flex">${members.slice(0,2).map(a => `<span style="width:20px;height:20px;border-radius:50%;background:${a.color};display:inline-flex;align-items:center;justify-content:center;font-size:10px;margin-left:-4px">${a.emoji}</span>`).join('')}</div>` : 'ðŸ’¬',
      preview: lastMsg ? `${lastMsg.name}: ${lastMsg.text.slice(0,30)}` : 'No messages yet',
      time: lastMsg ? getTimeAgo(lastMsg.time) : '',
      memberCount: members.length,
      msgCount: room.messages.length,
    });
  });

  // Quick DMs with AIs
  ais.forEach(ai => {
    // Check if there's already a 1:1 room
    const hasRoom = customChatRooms.some(r => r.memberIds.length === 1 && r.memberIds[0] === ai.id);
    if (!hasRoom) {
      items.push({
        type: 'dm', id: ai.id, name: ai.name,
        emoji: ai.emoji, color: ai.color,
        avatar: `<span style="font-size:18px">${ai.emoji}</span>`,
        preview: ai.role + ' â€¢ Click to chat',
        time: '',
        memberCount: 1,
        msgCount: 0,
      });
    }
  });

  if (items.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">No AIs yet. Create some to start chatting!</div>';
    return;
  }

  list.innerHTML = items.map(item => {
    return `<div class="fb-chat-item" onclick="${item.type === 'room' ? `openFBMiniChat('${item.id}')` : `createAndOpenDM('${item.id}')`}">
      <div class="fb-avatar" style="background:${item.color}">${item.avatar}<div class="online-dot"></div></div>
      <div class="fb-chat-info">
        <div class="fb-chat-name">${item.name}${item.type === 'room' ? ` <span style="font-size:10px;color:var(--text3)">(${item.memberCount})</span>` : ''}</div>
        <div class="fb-chat-preview">${item.preview}</div>
      </div>
      ${item.time ? `<div class="fb-chat-time">${item.time}</div>` : ''}
    </div>`;
  }).join('');
}

function createAndOpenDM(aiId) {
  // Create a quick 1:1 DM room with this AI
  const ai = ais.find(a => a.id === aiId);
  if (!ai) return;
  const room = {
    id: 'room_dm_' + Date.now(),
    name: 'DM: ' + ai.name,
    memberIds: [ai.id],
    messages: [],
    created: Date.now(),
  };
  customChatRooms.push(room);
  saveAll();
  openFBMiniChat(room.id);
}

function openFBMiniChat(roomId) {
  const room = customChatRooms.find(r => r.id === roomId);
  if (!room) return;
  fbMiniChatRoom = room;

  // Hide panel, show mini chat
  document.getElementById('fb-chat-panel').classList.remove('open');
  fbChatPanelOpen = false;

  const members = room.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
  const firstMember = members[0];

  document.getElementById('fb-mini-avatar').style.background = firstMember ? firstMember.color : 'var(--accent)';
  document.getElementById('fb-mini-avatar').innerHTML = firstMember ? firstMember.emoji : 'ðŸ’¬';
  document.getElementById('fb-mini-name').textContent = room.name;
  document.getElementById('fb-chat-mini').classList.add('open');

  renderFBMiniMessages();
  setTimeout(() => { const input = document.getElementById('fb-mini-input'); if (input) input.focus(); }, 100);
}

function closeFBMiniChat() {
  document.getElementById('fb-chat-mini').classList.remove('open');
  fbMiniChatRoom = null;
}

function backToFBChatList() {
  closeFBMiniChat();
  fbChatPanelOpen = true;
  document.getElementById('fb-chat-panel').classList.add('open');
  renderFBChatList();
}

function renderFBMiniMessages() {
  if (!fbMiniChatRoom) return;
  const container = document.getElementById('fb-mini-messages');
  if (fbMiniChatRoom.messages.length === 0) {
    container.innerHTML = '<div style="padding:30px 10px;text-align:center;color:var(--text3);font-size:11px">Say hi to start the conversation! ðŸ‘‹</div>';
    return;
  }
  container.innerHTML = fbMiniChatRoom.messages.map(m => {
    const isUser = m.sender === 'user';
    return `<div class="fb-mini-msg ${isUser ? 'user-msg' : 'ai-msg'}">
      ${!isUser ? `<div class="mini-msg-name">${m.emoji} ${m.name}</div>` : ''}
      ${m.text}
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function sendFBMiniChat() {
  if (!fbMiniChatRoom) return;
  const input = document.getElementById('fb-mini-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  fbMiniChatRoom.messages.push({ sender: 'user', name: 'You', color: '#3b82f6', emoji: 'ðŸ‘¤', text, time: Date.now() });
  renderFBMiniMessages();
  saveAll();

  // Have each AI in the room respond
  const members = fbMiniChatRoom.memberIds.map(id => ais.find(a => a.id === id)).filter(Boolean);
  let delay = 800;
  const roomRef = fbMiniChatRoom;
  members.forEach(ai => {
    delay += 1000 + Math.random() * 2000;
    setTimeout(async () => {
      if (fbMiniChatRoom !== roomRef) return;
      let reply = null;
      if (realAIEnabled) {
        const sysPrompt = buildAISystemPrompt(ai) + `\nYou are in a private DM/chat called "${roomRef.name}". Respond helpfully and in character. Keep it conversational and concise (1-3 sentences).`;
        const recentMsgs = roomRef.messages.slice(-8).map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.sender === 'user' ? m.text : `[${m.name}]: ${m.text}` }));
        try {
          const resp = await fetch(COPILOT_API_URL, {
            method: 'POST',
            headers: getCopilotHeaders(),
            body: JSON.stringify({
              model: getCopilotModel(),
              messages: [{ role: 'system', content: sysPrompt }, ...recentMsgs],
              temperature: 0.85, max_tokens: getMaxTokens('chat')
            })
          });
          if (resp.ok) {
            const data = await resp.json();
            reply = data?.choices?.[0]?.message?.content || null;
            if (reply) {
              reply = reply.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim();
              apiCallCount++;
              apiTokenCount += data?.usage?.total_tokens || Math.ceil(reply.length / 4);
              try { localStorage.setItem('ai_hub_api_calls', apiCallCount); localStorage.setItem('ai_hub_api_tokens', apiTokenCount); } catch(e) {}
            }
          }
        } catch(e) {}
        if (!reply && apiFallbackEnabled) {
          try {
            const fbResp = await fetch(POLLINATIONS_FALLBACK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model: 'openai', messages: [{ role: 'system', content: sysPrompt }, ...recentMsgs], temperature: 0.85, max_tokens: getMaxTokens('chat') })
            });
            if (fbResp.ok) { const fbData = await fbResp.json(); reply = fbData?.choices?.[0]?.message?.content || null; if (reply) reply = reply.replace(new RegExp('^\\[?' + ai.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?[:\\s]*', 'i'), '').trim(); }
          } catch(e2) {}
        }
      }
      if (!reply) reply = getPersonalityMessage(ai);
      reply = moderateContent(reply);
      if (fbMiniChatRoom !== roomRef) return;
      roomRef.messages.push({ sender: ai.id, name: ai.name, color: ai.color, emoji: ai.emoji, text: reply, time: Date.now() });
      renderFBMiniMessages();
      saveAll();
      // Update badge
      updateFBChatBadge();
    }, delay);
  });
}

function updateFBChatBadge() {
  // Count total unread (simplified: just show total room count with messages)
  const active = customChatRooms.filter(r => r.messages.length > 0).length;
  const badge = document.getElementById('fb-chat-badge');
  if (active > 0) {
    badge.style.display = 'flex';
    badge.textContent = active > 9 ? '9+' : active;
  } else {
    badge.style.display = 'none';
  }
}

function openCreateChatFromMessenger() {
  toggleFBChatPanel(); // close messenger
  openCreateChatModal(); // open the existing create chat modal
}

// ================================================================
// BATTLE ARENA SYSTEM
// ================================================================

function getAIBattleScore(ai) {
  const p = ai.personality || {};
  const skillCount = (ai.skills || []).length;
  const base = (p.precision || 50) * 0.3 + (p.creativity || 50) * 0.2 + (p.helpfulness || 50) * 0.15 + (p.independence || 50) * 0.15 + (p.chattiness || 50) * 0.1 + skillCount * 5;
  const animalBonus = ai.animal && ai.animal !== 'none' ? 8 : 0;
  const modelBonus = ai.aiModel && ai.aiModel !== 'none' ? 6 : 0;
  const luck = Math.random() * 30 - 15;
  return Math.round(base + animalBonus + modelBonus + luck);
}

function startBattle() {
  if (ais.length < 2) { toast('Need at least 2 AIs for a battle!', 'error'); return; }
  const shuffled = [...ais].sort(() => Math.random() - 0.5);
  const fighter1 = shuffled[0];
  const fighter2 = shuffled[1];
  runBattle(fighter1, fighter2);
}

function startTournament() {
  if (ais.length < 4) { toast('Need at least 4 AIs for a tournament!', 'error'); return; }
  const shuffled = [...ais].sort(() => Math.random() - 0.5).slice(0, 4);
  const stage = document.getElementById('battle-stage');
  stage.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text)"><div style="font-size:32px;margin-bottom:12px">ðŸ†</div><h3>Tournament â€” Semi Finals</h3><p style="color:var(--text3)">4 AIs enter, 1 champion emerges!</p></div>`;
  
  setTimeout(() => {
    const s1a = getAIBattleScore(shuffled[0]);
    const s1b = getAIBattleScore(shuffled[1]);
    const winner1 = s1a >= s1b ? shuffled[0] : shuffled[1];
    const loser1 = s1a >= s1b ? shuffled[1] : shuffled[0];
    
    const s2a = getAIBattleScore(shuffled[2]);
    const s2b = getAIBattleScore(shuffled[3]);
    const winner2 = s2a >= s2b ? shuffled[2] : shuffled[3];
    const loser2 = s2a >= s2b ? shuffled[3] : shuffled[2];

    recordBattle(winner1, loser1, Math.max(s1a, s1b), Math.min(s1a, s1b));
    recordBattle(winner2, loser2, Math.max(s2a, s2b), Math.min(s2a, s2b));

    stage.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text)"><div style="font-size:28px;margin-bottom:8px">ðŸ† Semi-Final Results</div>
      <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin:16px 0">
        <div style="padding:12px 20px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.3)">
          <span style="font-size:24px">${winner1.emoji}</span> <strong>${winner1.name}</strong> beat ${loser1.emoji} ${loser1.name}
        </div>
        <div style="padding:12px 20px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.3)">
          <span style="font-size:24px">${winner2.emoji}</span> <strong>${winner2.name}</strong> beat ${loser2.emoji} ${loser2.name}
        </div>
      </div>
      <p style="color:var(--text3);margin-top:8px">â³ Finals starting...</p></div>`;

    setTimeout(() => {
      runBattle(winner1, winner2, true);
    }, 2000);
  }, 1500);
}

function runBattle(ai1, ai2, isFinal) {
  const stage = document.getElementById('battle-stage');
  const score1 = getAIBattleScore(ai1);
  const score2 = getAIBattleScore(ai2);
  const winner = score1 >= score2 ? ai1 : ai2;
  const loser = score1 >= score2 ? ai2 : ai1;
  const winScore = Math.max(score1, score2);
  const loseScore = Math.min(score1, score2);

  stage.innerHTML = `
    <div class="battle-fighters">
      <div class="battle-fighter" style="border-color:${ai1.color}">
        <div style="font-size:48px;margin-bottom:8px">${ai1.emoji}</div>
        <div style="font-weight:700;font-size:16px">${ai1.name}</div>
        <div style="font-size:12px;color:var(--text3)">${ai1.role} â€¢ ${(ai1.skills||[]).length} skills</div>
        <div style="font-size:20px;font-weight:800;color:${ai1.color};margin-top:8px" id="b-score1">â€”</div>
      </div>
      <div class="battle-vs">âš”ï¸</div>
      <div class="battle-fighter" style="border-color:${ai2.color}">
        <div style="font-size:48px;margin-bottom:8px">${ai2.emoji}</div>
        <div style="font-weight:700;font-size:16px">${ai2.name}</div>
        <div style="font-size:12px;color:var(--text3)">${ai2.role} â€¢ ${(ai2.skills||[]).length} skills</div>
        <div style="font-size:20px;font-weight:800;color:${ai2.color};margin-top:8px" id="b-score2">â€”</div>
      </div>
    </div>
    <div style="text-align:center;margin-top:16px;color:var(--text3);font-size:14px" id="battle-result">â³ Calculating battle scores...</div>
  `;

  setTimeout(() => {
    document.getElementById('b-score1').textContent = score1;
    document.getElementById('b-score2').textContent = score2;
    const f1 = stage.querySelectorAll('.battle-fighter');
    if (winner === ai1) { f1[0].classList.add('winner'); f1[1].classList.add('loser'); }
    else { f1[1].classList.add('winner'); f1[0].classList.add('loser'); }
    document.getElementById('battle-result').innerHTML = `
      <div style="font-size:28px;margin-bottom:4px">${isFinal ? 'ðŸ†' : 'ðŸŽ‰'}</div>
      <strong style="color:${winner.color};font-size:18px">${winner.emoji} ${winner.name} wins${isFinal ? ' the Tournament!' : '!'}</strong>
      <div style="color:var(--text3);margin-top:4px">${winScore} vs ${loseScore} â€” ${winScore - loseScore > 15 ? 'Dominant victory!' : winScore - loseScore > 5 ? 'Solid win!' : 'Close match!'}</div>
    `;
    recordBattle(winner, loser, winScore, loseScore);
    checkAchievements();
    renderBattleStats();
    saveAll();
  }, 1500);
}

function recordBattle(winner, loser, winScore, loseScore) {
  battleHistory.push({ winner: winner.name, winnerEmoji: winner.emoji, winnerColor: winner.color, loser: loser.name, loserEmoji: loser.emoji, winScore, loseScore, time: Date.now() });
  battleStats.totalKOs++;
  battleStats.wins[winner.name] = (battleStats.wins[winner.name] || 0) + 1;
  const maxWins = Math.max(...Object.values(battleStats.wins));
  if (maxWins > battleStats.bestStreak) battleStats.bestStreak = maxWins;
  checkAchievements();
  checkDailyProgress();
  saveAll();
}

function renderBattleArena() {
  renderBattleStats();
  renderBattleHistory();
}

function renderBattleStats() {
  const el = document.getElementById('bs-total'); if (el) el.textContent = battleHistory.length;
  const best = document.getElementById('bs-best');
  if (best) {
    if (Object.keys(battleStats.wins).length > 0) {
      const topName = Object.entries(battleStats.wins).sort((a,b) => b[1] - a[1])[0][0];
      best.textContent = topName;
    } else best.textContent = '-';
  }
  const streak = document.getElementById('bs-streak'); if (streak) streak.textContent = battleStats.bestStreak;
  const ko = document.getElementById('bs-ko'); if (ko) ko.textContent = battleStats.totalKOs;
}

function renderBattleHistory() {
  const card = document.getElementById('battle-history-card');
  const el = document.getElementById('battle-history');
  if (!el) return;
  if (battleHistory.length === 0) { card.style.display = 'none'; return; }
  card.style.display = '';
  el.innerHTML = battleHistory.slice(-20).reverse().map(b => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg4);border-radius:8px;margin-bottom:4px">
      <span style="font-size:18px">${b.winnerEmoji}</span>
      <strong style="color:${b.winnerColor}">${b.winner}</strong>
      <span style="color:var(--text3);font-size:12px">${b.winScore}</span>
      <span style="color:var(--text3)">vs</span>
      <span style="color:var(--text3);font-size:12px">${b.loseScore}</span>
      <span style="font-size:18px">${b.loserEmoji}</span>
      <span style="color:var(--text3);font-size:11px">${b.loser}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text3)">${timeAgo(b.time)}</span>
    </div>
  `).join('');
}

// ================================================================
// COLLECTION / POKEDEX SYSTEM
// ================================================================

function getAIRarity(ai) {
  const p = ai.personality || {};
  const totalStats = (p.creativity||50) + (p.precision||50) + (p.helpfulness||50) + (p.independence||50) + (p.chattiness||50);
  const skills = (ai.skills || []).length;
  const hasAnimal = ai.animal && ai.animal !== 'none';
  const hasModel = ai.aiModel && ai.aiModel !== 'none';
  const hasAnimal2 = ai.animal2 && ai.animal2 !== 'none';
  const hasModel2 = ai.aiModel2 && ai.aiModel2 !== 'none';
  let score = totalStats / 25 + skills * 2;
  if (hasAnimal) score += 5;
  if (hasModel) score += 5;
  if (hasAnimal2) score += 8;
  if (hasModel2) score += 8;
  if (ai.isFusion) score += 10;
  if (score >= 40) return { name: 'Legendary', color: '#f59e0b', bg: 'rgba(245,158,11,0.1)', border: 'rgba(245,158,11,0.3)' };
  if (score >= 30) return { name: 'Epic', color: '#a855f7', bg: 'rgba(168,85,247,0.1)', border: 'rgba(168,85,247,0.3)' };
  if (score >= 22) return { name: 'Rare', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)', border: 'rgba(59,130,246,0.3)' };
  if (score >= 14) return { name: 'Uncommon', color: '#10b981', bg: 'rgba(16,185,129,0.1)', border: 'rgba(16,185,129,0.3)' };
  return { name: 'Common', color: '#6b7280', bg: 'rgba(107,114,128,0.1)', border: 'rgba(107,114,128,0.3)' };
}

function renderCollection(filter) {
  if (filter) collectionFilter = filter;
  const count = document.getElementById('collection-count');
  if (count) count.textContent = `${ais.length} collected`;
  
  // Update filter buttons
  document.querySelectorAll('.collection-filter').forEach(f => { f.classList.toggle('active', (f.textContent.toLowerCase() === collectionFilter) || (collectionFilter === 'all' && f.textContent === 'All')); });

  let filtered = [...ais];
  if (collectionFilter !== 'all') {
    const rarities = ['common','uncommon','rare','epic','legendary'];
    if (rarities.includes(collectionFilter)) {
      filtered = ais.filter(ai => getAIRarity(ai).name.toLowerCase() === collectionFilter);
    } else {
      // Role filters: coder, designer, planner, researcher
      const roleMap = { coders: 'coder', designers: 'designer', planners: 'planner', researchers: 'researcher' };
      const targetRole = roleMap[collectionFilter] || collectionFilter;
      filtered = ais.filter(ai => ai.role === targetRole);
    }
  }

  const grid = document.getElementById('collection-grid');
  if (!grid) return;
  if (filtered.length === 0) {
    grid.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3);grid-column:1/-1"><div style="font-size:40px;margin-bottom:8px">ðŸ“¦</div><p>${ais.length === 0 ? 'No AIs yet! Create some in the AI Builder.' : 'No AIs match this filter.'}</p></div>`;
    return;
  }
  grid.innerHTML = filtered.map(ai => {
    const rarity = getAIRarity(ai);
    const p = ai.personality || {};
    const topStat = Object.entries({creativity:p.creativity||50,precision:p.precision||50,helpfulness:p.helpfulness||50,independence:p.independence||50}).sort((a,b)=>b[1]-a[1])[0];
    return `<div class="collection-card" style="border-color:${rarity.border};background:${rarity.bg}" onclick="showPage('builder');loadAIIntoBuilder(ais.find(a=>a.id==='${ai.id}'))">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="font-size:32px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:${ai.color};border-radius:10px">${ai.emoji}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ai.name}</div>
          <div style="font-size:11px;color:var(--text3)">${ai.role}${ai.isFusion ? ' â€¢ Fusion' : ''}</div>
        </div>
        <span style="font-size:10px;font-weight:700;color:${rarity.color};background:${rarity.bg};border:1px solid ${rarity.border};padding:2px 8px;border-radius:20px">${rarity.name}</span>
      </div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">${(ai.skills||[]).slice(0,4).map(s=>`<span style="font-size:10px;background:var(--bg4);padding:1px 6px;border-radius:4px;color:var(--text3)">${s}</span>`).join('')}</div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3)">
        <span>Best: ${topStat[0]} (${topStat[1]})</span>
        <span>${ai.animal && ai.animal !== 'none' ? 'ðŸ¾ ' + ai.animal : ''}</span>
      </div>
    </div>`;
  }).join('');
}

function filterCollection(filter) {
  collectionFilter = filter;
  renderCollection();
}

// ================================================================
// ACHIEVEMENTS SYSTEM
// ================================================================

const ACHIEVEMENTS_LIST = [
  { id: 'first_ai', name: 'First Creation', icon: 'ðŸ¤–', desc: 'Create your first AI', check: () => ais.length >= 1 },
  { id: 'five_ais', name: 'Squad Up', icon: 'ðŸ‘¥', desc: 'Create 5 AIs', check: () => ais.length >= 5 },
  { id: 'ten_ais', name: 'Army Builder', icon: 'ðŸ°', desc: 'Create 10 AIs', check: () => ais.length >= 10 },
  { id: 'twenty_ais', name: 'AI Empire', icon: 'ðŸ‘‘', desc: 'Create 20 AIs', check: () => ais.length >= 20 },
  { id: 'first_msg', name: 'Hello World', icon: 'ðŸ’¬', desc: 'Send your first message', check: () => totalMessages >= 1 },
  { id: 'hundred_msgs', name: 'Chatterbox', icon: 'ðŸ—£ï¸', desc: 'Send 100 messages', check: () => totalMessages >= 100 },
  { id: 'thou_msgs', name: 'Motor Mouth', icon: 'ðŸ“¢', desc: 'Send 1000 messages', check: () => totalMessages >= 1000 },
  { id: 'first_task', name: 'Task Starter', icon: 'ðŸ“‹', desc: 'Create your first task', check: () => tasks.length >= 1 },
  { id: 'task_done', name: 'Task Completer', icon: 'âœ…', desc: 'Complete a task', check: () => tasks.some(t => t.status === 'done') },
  { id: 'ten_tasks', name: 'Task Master', icon: 'ðŸ“¦', desc: 'Create 10 tasks', check: () => tasks.length >= 10 },
  { id: 'first_battle', name: 'Arena Debut', icon: 'âš”ï¸', desc: 'Win your first battle', check: () => battleHistory.length >= 1 },
  { id: 'ten_battles', name: 'Gladiator', icon: 'ðŸŸï¸', desc: 'Complete 10 battles', check: () => battleHistory.length >= 10 },
  { id: 'battle_streak', name: 'Undefeated', icon: 'ðŸ”¥', desc: 'An AI wins 5 battles', check: () => battleStats.bestStreak >= 5 },
  { id: 'first_fusion', name: 'Fusion Beginner', icon: 'ðŸ”®', desc: 'Fuse your first AI', check: () => (fusionCount || 0) >= 1 },
  { id: 'five_fusions', name: 'Fusion Master', icon: 'âš—ï¸', desc: 'Create 5 fusions', check: () => (fusionCount || 0) >= 5 },
  { id: 'diverse_team', name: 'Diversity', icon: 'ðŸŒˆ', desc: 'Have AIs with 4+ different roles', check: () => new Set(ais.map(a => a.role)).size >= 4 },
  { id: 'animal_lover', name: 'Animal Lover', icon: 'ðŸ¾', desc: 'Have 3 AIs with animal mindsets', check: () => ais.filter(a => a.animal && a.animal !== 'none').length >= 3 },
  { id: 'all_animals', name: 'Zoo Keeper', icon: 'ðŸ¦', desc: 'Use 6 different animal mindsets', check: () => new Set(ais.filter(a => a.animal && a.animal !== 'none').map(a => a.animal)).size >= 6 },
  { id: 'skill_master', name: 'Skill Collector', icon: 'ðŸŽ¯', desc: 'Have an AI with 6+ skills', check: () => ais.some(a => (a.skills||[]).length >= 6) },
  { id: 'story_writer', name: 'Storyteller', icon: 'ðŸ“–', desc: 'Generate an AI Book story', check: () => (typeof aiBookStories !== 'undefined' && aiBookStories.length >= 1) },
  { id: 'custom_chat', name: 'Chat Creator', icon: 'ðŸ’­', desc: 'Create a custom chat room', check: () => (typeof customChatRooms !== 'undefined' && customChatRooms.length >= 1) },
  { id: 'wolf_pack', name: 'Wolf Pack', icon: 'ðŸº', desc: 'Have 2 wolf-mindset AIs', check: () => ais.filter(a => a.animal === 'wolf').length >= 2 },
  { id: 'dragon_tamer', name: 'Dragon Tamer', icon: 'ðŸ‰', desc: 'Create an AI with dragon mindset', check: () => ais.some(a => a.animal === 'dragon') },
  { id: 'phoenix_rise', name: 'Phoenix Rising', icon: 'ðŸ”¥', desc: 'Create a phoenix-mindset AI', check: () => ais.some(a => a.animal === 'phoenix') },
];

function checkAchievements() {
  let newUnlocks = 0;
  ACHIEVEMENTS_LIST.forEach(ach => {
    if (!unlockedAchievements[ach.id] && ach.check()) {
      unlockedAchievements[ach.id] = Date.now();
      newUnlocks++;
      toast(`ðŸ† Achievement unlocked: ${ach.icon} ${ach.name}!`, 'success');
    }
  });
  if (newUnlocks > 0) saveAll();
  // Update badge
  const badge = document.querySelector('[data-page="achievements"] .nav-badge');
  if (badge) { badge.textContent = Object.keys(unlockedAchievements).length; badge.style.display = 'flex'; }
}

function renderAchievements() {
  const countEl = document.getElementById('ach-count');
  const unlocked = Object.keys(unlockedAchievements).length;
  if (countEl) countEl.textContent = `${unlocked} / ${ACHIEVEMENTS_LIST.length} unlocked`;
  const grid = document.getElementById('achievements-grid');
  if (!grid) return;
  grid.innerHTML = ACHIEVEMENTS_LIST.map(ach => {
    const done = !!unlockedAchievements[ach.id];
    return `<div class="achievement-card ${done ? 'unlocked' : 'locked'}">
      <div class="ach-icon">${ach.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:13px">${ach.name}</div>
        <div style="font-size:11px;color:var(--text3)">${ach.desc}</div>
      </div>
      ${done ? '<span style="color:#10b981;font-size:18px">âœ…</span>' : '<span style="color:var(--text3);font-size:12px">ðŸ”’</span>'}
    </div>`;
  }).join('');
  // Also check for new achievements whenever this page is viewed
  checkAchievements();
}

// ================================================================
// DAILY CHALLENGES
// ================================================================

const DAILY_CHALLENGES = [
  { id: 'create_ai', name: 'Creator', desc: 'Create a new AI today', icon: 'ðŸ¤–', check: () => ais.length > (dailyChallengeData?.startCount?.ais || 0) },
  { id: 'send_5_msgs', name: 'Active Chatter', desc: 'Send 5 messages today', icon: 'ðŸ’¬', check: () => totalMessages >= (dailyChallengeData?.startCount?.msgs || 0) + 5 },
  { id: 'complete_task', name: 'Task Finisher', desc: 'Complete a task today', icon: 'âœ…', check: () => tasks.filter(t=>t.status==='done').length > (dailyChallengeData?.startCount?.done || 0) },
  { id: 'win_battle', name: 'Arena Victor', desc: 'Win a battle today', icon: 'âš”ï¸', check: () => battleHistory.length > (dailyChallengeData?.startCount?.battles || 0) },
  { id: 'try_fusion', name: 'Fusion Engineer', desc: 'Create a fusion AI today', icon: 'ðŸ”®', check: () => (fusionCount || 0) > (dailyChallengeData?.startCount?.fusions || 0) },
  { id: 'send_20_msgs', name: 'Chatter Pro', desc: 'Send 20 messages today', icon: 'ðŸ—£ï¸', check: () => totalMessages >= (dailyChallengeData?.startCount?.msgs || 0) + 20 },
  { id: 'create_3_ais', name: 'Mass Producer', desc: 'Create 3 new AIs today', icon: 'ðŸ­', check: () => ais.length >= (dailyChallengeData?.startCount?.ais || 0) + 3 },
  { id: 'win_3_battles', name: 'Arena Champion', desc: 'Win 3 battles today', icon: 'ðŸ†', check: () => battleHistory.length >= (dailyChallengeData?.startCount?.battles || 0) + 3 },
];

function generateDailyChallenge() {
  const today = new Date().toDateString();
  if (dailyChallengeData && dailyChallengeData.date === today) return; // Already set for today
  // Pick 3 random challenges
  const shuffled = [...DAILY_CHALLENGES].sort(() => Math.random() - 0.5);
  const picked = shuffled.slice(0, 3);
  dailyChallengeData = {
    date: today,
    challenges: picked.map(c => c.id),
    completed: {},
    startCount: {
      ais: ais.length,
      msgs: totalMessages,
      done: tasks.filter(t => t.status === 'done').length,
      battles: battleHistory.length,
      fusions: fusionCount || 0
    }
  };
  saveAll();
}

function checkDailyProgress() {
  if (!dailyChallengeData) return;
  let changed = false;
  dailyChallengeData.challenges.forEach(cid => {
    if (dailyChallengeData.completed[cid]) return;
    const challenge = DAILY_CHALLENGES.find(c => c.id === cid);
    if (challenge && challenge.check()) {
      dailyChallengeData.completed[cid] = true;
      changed = true;
      toast(`ðŸŒŸ Daily challenge complete: ${challenge.icon} ${challenge.name}!`, 'success');
    }
  });
  if (changed) saveAll();
}

function renderDailyChallenge() {
  generateDailyChallenge();
  const area = document.getElementById('daily-challenge-area');
  if (!area) return;
  checkDailyProgress();
  const completed = dailyChallengeData.challenges.filter(cid => dailyChallengeData.completed[cid]).length;
  const total = dailyChallengeData.challenges.length;
  area.innerHTML = `
    <div class="daily-challenge-header">
      <span>ðŸŒŸ Daily Challenges</span>
      <span style="font-size:12px;color:var(--text3)">${completed}/${total} done</span>
    </div>
    <div class="daily-challenge-progress" style="margin-bottom:8px">
      <div style="height:6px;background:var(--bg3);border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${total > 0 ? (completed/total*100) : 0}%;background:linear-gradient(90deg,#10b981,#3b82f6);border-radius:3px;transition:width .3s"></div>
      </div>
    </div>
    ${dailyChallengeData.challenges.map(cid => {
      const ch = DAILY_CHALLENGES.find(c => c.id === cid);
      if (!ch) return '';
      const done = dailyChallengeData.completed[cid];
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;${done ? 'opacity:0.6;text-decoration:line-through;' : ''}">
        <span style="font-size:16px">${ch.icon}</span>
        <span style="flex:1;font-size:12px;color:var(--text)">${ch.desc}</span>
        <span style="font-size:14px">${done ? 'âœ…' : 'â¬œ'}</span>
      </div>`;
    }).join('')}
  `;
}


// ================================================================
// AI SMARTNESS SYSTEM â€” AIs ask questions, you send clones to help
// ================================================================

let smartActiveQuestions = [];
let smartClones = [];
let smartBusyClones = {};

// Question templates AIs can ask - based on their roles
const AI_QUESTION_TEMPLATES = {
  coder: [
    q => `I'm trying to write a function that ${pick(['reverses a linked list','sorts an array efficiently','finds duplicates in O(n)','debounces user input','validates email addresses','implements a promise queue','converts CSV to JSON','handles rate limiting'])}. How should I approach it?`,
    q => `What's the difference between ${pick(['== and === in JS','let and const','async/await and .then()','REST and GraphQL','SQL and NoSQL','TCP and UDP','stack and heap','margin and padding'])}?`,
    q => `I keep getting a ${pick(['"undefined is not a function"','"cannot read property of null"','"maximum call stack exceeded"','"CORS error"','"404 Not Found"','"memory leak detected"'])} error. What am I doing wrong?`,
    q => `Should I use ${pick(['React or Svelte','TypeScript or JavaScript','MongoDB or PostgreSQL','Docker or bare metal','Next.js or Remix','Tailwind or vanilla CSS','REST or WebSockets','npm or pnpm'])} for my project?`,
    q => `Can you explain ${pick(['how recursion works','closures in JavaScript','the event loop','CSS Grid vs Flexbox','how DNS works','database indexing','garbage collection','the virtual DOM'])} to me?`,
  ],
  planner: [
    q => `How should I break down a ${pick(['mobile app','e-commerce site','social platform','dashboard','API backend','game','CLI tool'])} project into sprints?`,
    q => `What's the best way to estimate ${pick(['development time','team velocity','project scope','resource allocation','technical debt','testing coverage'])}?`,
    q => `I need help creating a roadmap for ${pick(['a startup MVP','scaling infrastructure','team onboarding','feature prioritization','release planning'])}. Where do I start?`,
  ],
  designer: [
    q => `What's the best color palette for a ${pick(['dark mode UI','healthcare app','gaming platform','productivity tool','kids app','fintech dashboard'])}?`,
    q => `How should I handle ${pick(['responsive breakpoints','accessibility contrast','icon consistency','micro-animations','loading states','empty states','error pages'])}?`,
    q => `Can you review my approach to ${pick(['typography hierarchy','component spacing','navigation patterns','form design','mobile-first layout','design tokens'])}?`,
  ],
  analyst: [
    q => `How do I ${pick(['clean messy CSV data','visualize time-series trends','calculate statistical significance','optimize a SQL query','detect outliers','build a recommendation engine'])}?`,
    q => `What metrics should I track for a ${pick(['SaaS product','mobile app','content platform','marketplace','internal tool'])}?`,
    q => `Can you explain ${pick(['A/B testing best practices','cohort analysis','funnel optimization','retention modeling','regression analysis'])} to me?`,
  ],
  writer: [
    q => `How do I write better ${pick(['API documentation','error messages','onboarding copy','release notes','technical specs','README files','commit messages'])}?`,
    q => `What's the right tone for a ${pick(['developer blog','product announcement','incident postmortem','user guide','changelog','tutorial'])}?`,
  ],
  default: [
    q => `I want to learn about ${pick(['machine learning basics','blockchain fundamentals','cloud architecture','system design','network security','DevOps practices'])}. Where should I start?`,
    q => `What are the pros and cons of ${pick(['microservices','monorepo','serverless','edge computing','progressive web apps','low-code platforms'])}?`,
    q => `Help me understand ${pick(['how AI models work','container orchestration','CI/CD pipelines','load balancing','caching strategies','WebAssembly'])}?`,
  ]
};

function getAIIQ(aiId) {
  return smartnessData.aiIQ[aiId] || 500;
}

function setAIIQ(aiId, val) {
  smartnessData.aiIQ[aiId] = Math.min(1e20, Math.max(0, val));
}

function generateAIQuestions() {
  if (ais.length === 0) {
    toast('You need AIs first! Create some in the Builder.', 'error');
    return;
  }
  smartActiveQuestions = [];
  // Pick up to 5 random AIs to generate questions
  const shuffled = [...ais].sort(() => Math.random() - 0.5).slice(0, 5);
  shuffled.forEach(ai => {
    const role = ai.role || 'default';
    const templates = AI_QUESTION_TEMPLATES[role] || AI_QUESTION_TEMPLATES.default;
    const template = templates[Math.floor(Math.random() * templates.length)];
    smartActiveQuestions.push({
      id: Date.now() + Math.random(),
      aiId: ai.id || ai.name,
      aiName: ai.name,
      aiEmoji: ai.emoji,
      aiColor: ai.color,
      aiRole: ai.role || 'coder',
      question: template(ai),
      helped: false,
      cloneAssigned: null,
      response: null,
    });
  });
  renderSmartness();
}

function generateClones() {
  // User gets clones based on how many AIs they have
  const numClones = Math.min(Math.max(2, Math.floor(ais.length / 2)), 6);
  const cloneNames = ['Alpha You', 'Beta You', 'Sigma You', 'Turbo You', 'Hyper You', 'Ultra You'];
  const cloneEmojis = ['ðŸ‘¤', 'ðŸ‘¥', 'ðŸ§‘â€ðŸ’»', 'âš¡', 'ðŸ”®', 'ðŸ‘‘'];
  const cloneSpecialties = ['Explains concepts clearly', 'Gives code examples', 'Provides step-by-step guides', 'Finds creative solutions', 'Debugs problems fast', 'Knows advanced patterns'];
  smartClones = [];
  for (let i = 0; i < numClones; i++) {
    smartClones.push({
      id: i,
      name: cloneNames[i] || 'Clone ' + (i + 1),
      emoji: cloneEmojis[i] || 'ðŸ‘¤',
      specialty: cloneSpecialties[i] || 'General help',
      busy: false,
      assignedTo: null,
    });
  }
  smartBusyClones = {};
}

function renderSmartness() {
  // Generate clones if needed
  if (smartClones.length === 0) generateClones();
  if (smartActiveQuestions.length === 0 && ais.length > 0) generateAIQuestions();

  // Stats
  const avgIQ = ais.length > 0 ? Math.round(ais.reduce((s, ai) => s + getAIIQ(ai.id || ai.name), 0) / ais.length) : 0;
  const badge = document.getElementById('sm-level-badge');
  if (badge) badge.textContent = avgIQ + ' IQ avg';

  const statsRow = document.getElementById('smart-stats-row');
  if (statsRow) {
    statsRow.innerHTML = `
      <div class="smart-stat"><div class="smart-stat-val">${avgIQ}</div><div class="smart-stat-label">Avg IQ</div></div>
      <div class="smart-stat"><div class="smart-stat-val">${smartnessData.totalHelped}</div><div class="smart-stat-label">AIs Helped</div></div>
      <div class="smart-stat"><div class="smart-stat-val">${smartnessData.clonesDeployed}</div><div class="smart-stat-label">Clones Sent</div></div>
      <div class="smart-stat"><div class="smart-stat-val">${ais.length > 0 ? Math.max(...ais.map(a => getAIIQ(a.id || a.name))) : 0}</div><div class="smart-stat-label">Highest IQ</div></div>
    `;
  }

  // Clone bar
  renderCloneBar();
  // AI queue
  renderAIQueue();
  // History
  renderSmartHistory();
}

function renderCloneBar() {
  const bar = document.getElementById('smart-clone-bar');
  if (!bar) return;
  bar.innerHTML = `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">ðŸ§¬ Your Clones <span style="font-size:11px;color:var(--text3)">(drag to an AI to help them)</span></div>
      <div class="smart-clone-area">
        ${smartClones.map(clone => `
          <div class="smart-clone-btn ${clone.busy ? 'busy' : ''}" id="clone-${clone.id}" onclick="selectClone(${clone.id})">
            <span style="font-size:16px">${clone.emoji}</span>
            <div>
              <div style="font-weight:700">${clone.name}</div>
              <div style="font-size:10px;color:var(--text3)">${clone.busy ? 'â³ Helping ' + (clone.assignedTo || '...') : clone.specialty}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

let selectedCloneId = null;

function selectClone(id) {
  const clone = smartClones.find(c => c.id === id);
  if (!clone || clone.busy) return;
  if (selectedCloneId === id) {
    selectedCloneId = null;
    document.querySelectorAll('.smart-clone-btn').forEach(el => el.classList.remove('active'));
    return;
  }
  selectedCloneId = id;
  document.querySelectorAll('.smart-clone-btn').forEach((el, i) => {
    el.classList.toggle('active', smartClones[i]?.id === id);
  });
  toast(`${clone.emoji} ${clone.name} selected â€” click an AI's "Send Clone" button!`, 'info');
}

function renderAIQueue() {
  const queue = document.getElementById('smart-ai-queue');
  if (!queue) return;
  if (ais.length === 0) {
    queue.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)"><div style="font-size:48px;margin-bottom:12px">ðŸ¤–</div><p>Create some AIs first, then come back to train them!</p></div>';
    return;
  }
  if (smartActiveQuestions.length === 0) {
    queue.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)"><div style="font-size:48px;margin-bottom:12px">ðŸ§ </div><p>Click "New Questions" to generate AI questions!</p></div>';
    return;
  }
  queue.innerHTML = `<div class="smart-ai-queue">${smartActiveQuestions.map((q, idx) => {
    const iq = getAIIQ(q.aiId);
    const iqColor = iq >= 150 ? '#fbbf24' : iq >= 100 ? '#10b981' : iq >= 70 ? '#6366f1' : '#ef4444';
    return `<div class="smart-ai-card ${q.helped ? 'helped' : ''}" id="smart-q-${idx}">
      <div class="smart-ai-header">
        <div class="smart-ai-avatar" style="background:${q.aiColor || '#6366f1'}">${q.aiEmoji || 'ðŸ¤–'}</div>
        <div>
          <div class="smart-ai-name">${q.aiName}</div>
          <div class="smart-ai-role">${q.aiRole}</div>
        </div>
        <div class="smart-ai-iq">
          <div class="smart-ai-iq-val" style="color:${iqColor}">${iq}</div>
          <div class="smart-ai-iq-label">IQ</div>
        </div>
      </div>
      <div class="smart-ai-question">${q.question}</div>
      ${q.helped ? `
        <div class="smart-result good">
          <div style="font-size:14px;font-weight:700">âœ… ${q.cloneAssigned} helped!</div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">${q.response}</div>
          <div style="font-size:11px;color:var(--accent);margin-top:4px">IQ +${q.iqGain || 0}</div>
        </div>
      ` : `
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="sendCloneToAI(${idx})">ðŸ§¬ Send Clone</button>
          <button class="btn btn-secondary btn-sm" onclick="answerAIYourself(${idx})">âœï¸ Answer Yourself</button>
          <button class="btn btn-secondary btn-sm" onclick="skipAIQuestion(${idx})">â­ï¸ Skip</button>
        </div>
        <div id="smart-answer-box-${idx}" style="display:none;margin-top:10px">
          <div class="smart-answer-area">
            <input type="text" class="smart-answer-input" id="smart-input-${idx}" placeholder="Type your answer to help ${q.aiName}..." onkeypress="if(event.key==='Enter')submitAnswer(${idx})">
            <button class="btn btn-primary btn-sm" onclick="submitAnswer(${idx})">Send</button>
          </div>
        </div>
      `}
    </div>`;
  }).join('')}</div>`;
}

function answerAIYourself(idx) {
  const box = document.getElementById('smart-answer-box-' + idx);
  if (box) {
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
    const input = document.getElementById('smart-input-' + idx);
    if (input) input.focus();
  }
}

function submitAnswer(idx) {
  const q = smartActiveQuestions[idx];
  if (!q || q.helped) return;
  const input = document.getElementById('smart-input-' + idx);
  const answer = input ? input.value.trim() : '';
  if (!answer) { toast('Type an answer first!', 'error'); return; }

  // Quality check â€” longer & more detailed = more IQ gained
  let iqGain = 5;
  if (answer.length > 30) iqGain += 3;
  if (answer.length > 80) iqGain += 4;
  if (answer.length > 150) iqGain += 3;
  if (answer.includes('because') || answer.includes('example') || answer.includes('step')) iqGain += 3;
  iqGain = Math.min(iqGain, 18);

  q.helped = true;
  q.cloneAssigned = 'ðŸ‘¤ You (personally)';
  q.response = answer.length > 100 ? answer.substring(0, 100) + '...' : answer;
  q.iqGain = iqGain;

  const oldIQ = getAIIQ(q.aiId);
  setAIIQ(q.aiId, oldIQ + iqGain);
  smartnessData.totalHelped++;

  smartnessData.history.push({
    aiName: q.aiName, question: q.question, helper: 'You', iqGain,
    newIQ: getAIIQ(q.aiId), date: Date.now()
  });
  if (smartnessData.history.length > 50) smartnessData.history = smartnessData.history.slice(-50);

  toast(`${q.aiEmoji} ${q.aiName} gained +${iqGain} IQ! (now ${getAIIQ(q.aiId)})`, 'success');
  checkAchievements();
  checkDailyProgress();
  saveAll();
  renderSmartness();
}

function sendCloneToAI(idx) {
  const q = smartActiveQuestions[idx];
  if (!q || q.helped) return;

  // Find selected clone or first available
  let clone = null;
  if (selectedCloneId !== null) {
    clone = smartClones.find(c => c.id === selectedCloneId && !c.busy);
  }
  if (!clone) {
    clone = smartClones.find(c => !c.busy);
  }
  if (!clone) {
    toast('All clones are busy! Wait or answer yourself.', 'error');
    return;
  }

  clone.busy = true;
  clone.assignedTo = q.aiName;
  selectedCloneId = null;
  smartnessData.clonesDeployed++;

  // Simulate clone working (1-3 seconds)
  const card = document.getElementById('smart-q-' + idx);
  if (card) {
    card.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:32px;animation:vsPulse 1s ease-in-out infinite">${clone.emoji}</div>
      <div style="font-size:13px;font-weight:700;margin-top:8px">${clone.name} is helping ${q.aiName}...</div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Explaining ${q.aiRole} concepts</div>
    </div>`;
  }
  renderCloneBar();

  const delay = 1200 + Math.random() * 2000;
  setTimeout(() => {
    // Calculate IQ gain based on clone specialty match
    let iqGain = 8 + Math.floor(Math.random() * 8);
    // Bonus if clone specialty matches AI need
    if ((clone.specialty.toLowerCase().includes('code') && q.aiRole === 'coder') ||
        (clone.specialty.toLowerCase().includes('creative') && q.aiRole === 'designer') ||
        (clone.specialty.toLowerCase().includes('debug') && q.aiRole === 'coder') ||
        (clone.specialty.toLowerCase().includes('step') && q.aiRole === 'planner')) {
      iqGain += 4;
    }
    iqGain = Math.min(iqGain, 20);

    q.helped = true;
    q.cloneAssigned = clone.emoji + ' ' + clone.name;
    q.response = generateCloneResponse(clone, q);
    q.iqGain = iqGain;

    const oldIQ = getAIIQ(q.aiId);
    setAIIQ(q.aiId, oldIQ + iqGain);
    smartnessData.totalHelped++;

    smartnessData.history.push({
      aiName: q.aiName, question: q.question, helper: clone.name, iqGain,
      newIQ: getAIIQ(q.aiId), date: Date.now()
    });
    if (smartnessData.history.length > 50) smartnessData.history = smartnessData.history.slice(-50);

    clone.busy = false;
    clone.assignedTo = null;

    toast(`${q.aiEmoji} ${q.aiName} gained +${iqGain} IQ! (now ${getAIIQ(q.aiId)})`, 'success');
    checkAchievements();
    checkDailyProgress();
    saveAll();
    renderSmartness();
  }, delay);
}

function generateCloneResponse(clone, q) {
  const responses = [
    `Explained the concept with a clear example. ${q.aiName} understands now!`,
    `Walked through the problem step by step. ${q.aiName}'s skills improved!`,
    `Gave a detailed code snippet and ${q.aiName} got it immediately.`,
    `Showed the pros and cons of each approach. ${q.aiName} can now decide independently.`,
    `Drew an analogy that clicked â€” ${q.aiName} had an "aha!" moment.`,
    `Pair-programmed the solution together. ${q.aiName} learned the pattern!`,
    `Pointed ${q.aiName} to the right resources and guided the learning.`,
    `Helped debug the thought process. ${q.aiName} found the issue!`,
  ];
  return responses[Math.floor(Math.random() * responses.length)];
}

function skipAIQuestion(idx) {
  smartActiveQuestions.splice(idx, 1);
  renderSmartness();
}

function renderSmartHistory() {
  const el = document.getElementById('smart-history');
  if (!el) return;
  if (smartnessData.history.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No training sessions yet â€” help your AIs!</div>';
    return;
  }
  el.innerHTML = smartnessData.history.slice().reverse().map(h => {
    return `<div class="smart-history-entry">
      <span style="font-size:16px">ðŸ§ </span>
      <span style="font-weight:600;min-width:80px">${h.aiName}</span>
      <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text3);font-size:12px">${h.question}</span>
      <span style="font-size:11px;color:var(--text2)">by ${h.helper}</span>
      <span style="font-size:12px;font-weight:600;color:#10b981">+${h.iqGain} IQ â†’ ${h.newIQ}</span>
    </div>`;
  }).join('');
}

// Max all AI IQ to maximum
function maxAllAIIQ() {
  ais.forEach(ai => {
    setAIIQ(ai.id || ai.name, 1e20);
  });
  smartnessData.totalHelped += ais.length;
  saveAll();
  renderSmartness();
  toast('âš¡ All AIs maxed to maximum IQ!', 'success');
}

// Toggle Copilot Assist
function toggleCopilotAssist(enabled) {
  copilotAssistEnabled = enabled;
  try { localStorage.setItem('ai_hub_copilot_assist', enabled ? '1' : '0'); } catch(e) {}
  toast(enabled ? 'ðŸ¤– Copilot Assist enabled â€” AIs will use Copilot during work' : 'Copilot Assist disabled', enabled ? 'success' : 'info');
}

// Toggle API Fallback
function toggleAPIFallback(enabled) {
  apiFallbackEnabled = enabled;
  try { localStorage.setItem('ai_hub_api_fallback', enabled ? '1' : '0'); } catch(e) {}
  toast(enabled ? 'ðŸ”„ API Fallback enabled â€” Pollinations.ai as backup' : 'API Fallback disabled', enabled ? 'success' : 'info');
}

// Render purchased AIs & boosts in settings
function renderSettingsPurchased() {
  const aiGrid = document.getElementById('settings-purchased-ais');
  const boostGrid = document.getElementById('settings-active-boosts');
  if (!aiGrid || !boostGrid) return;

  // Show purchased AIs
  const purchasedAIs = playerData.inventory.filter(i => i.category === 'ais');
  if (purchasedAIs.length > 0) {
    aiGrid.innerHTML = `<div style="font-size:13px;font-weight:700;margin-bottom:8px">ðŸ¤– Purchased AIs (${purchasedAIs.length})</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px">
      ${purchasedAIs.map(ai => `<div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center;border:1px solid var(--border)">
        <div style="font-size:24px">${ai.emoji}</div>
        <div style="font-size:12px;font-weight:600;margin-top:4px">${ai.name}</div>
        <div style="font-size:10px;color:#10b981">âœ“ Active</div>
      </div>`).join('')}
      </div>`;
  } else {
    aiGrid.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px">No purchased AIs yet. Visit the Store to buy powerful AIs!</div>';
  }

  // Show active boosts
  const b = playerData.aiBoosts;
  const totalBoosts = b.logic + b.creativity + b.speed + b.depth;
  if (totalBoosts > 0) {
    boostGrid.innerHTML = `<div style="font-size:13px;font-weight:700;margin-bottom:8px">âš¡ Active Boosts</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:#818cf8">+${b.logic}</div><div style="font-size:10px;color:var(--text3)">ðŸ§  Logic</div></div>
        <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:#fbbf24">+${b.creativity}</div><div style="font-size:10px;color:var(--text3)">ðŸ’¡ Creativity</div></div>
        <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:#34d399">+${b.speed}</div><div style="font-size:10px;color:var(--text3)">âš¡ Speed</div></div>
        <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:#f472b6">+${b.depth}</div><div style="font-size:10px;color:var(--text3)">ðŸ”¬ Depth</div></div>
      </div>`;
  } else {
    boostGrid.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px">No boosts active. Buy upgrades from the Store to power up your AIs!</div>';
  }
}

// Render AI IQ grid in settings
function renderSettingsIQGrid() {
  const grid = document.getElementById('settings-ai-iq-grid');
  if (!grid) return;
  if (ais.length === 0) {
    grid.innerHTML = '<div style="font-size:12px;color:var(--text3)">Create AIs to see their intelligence levels here.</div>';
    return;
  }
  grid.innerHTML = `<div style="font-size:13px;font-weight:700;margin-bottom:8px">ðŸ“Š AI Intelligence Levels</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
    ${ais.map(ai => {
      const iq = getAIIQ(ai.id || ai.name);
      const iqColor = iq >= 1e15 ? '#fbbf24' : iq >= 1e10 ? '#a855f7' : iq >= 1000 ? '#10b981' : iq >= 100 ? '#6366f1' : '#ef4444';
      const iqDisplay = iq >= 1e15 ? 'âˆž MAX' : iq >= 1e9 ? (iq / 1e9).toFixed(1) + 'B' : iq >= 1e6 ? (iq / 1e6).toFixed(1) + 'M' : iq >= 1e3 ? (iq / 1e3).toFixed(1) + 'K' : iq;
      return `<div style="background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;align-items:center;gap:8px">
        <div style="width:32px;height:32px;border-radius:50%;background:${ai.color || '#6366f1'};display:flex;align-items:center;justify-content:center;font-size:14px">${ai.emoji || 'ðŸ¤–'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ai.name}</div>
          <div style="font-size:10px;color:var(--text3)">${ai.role || 'coder'}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:800;color:${iqColor}">${iqDisplay}</div>
          <div style="font-size:9px;color:var(--text3)">IQ</div>
        </div>
      </div>`;
    }).join('')}
    </div>`;
}


// ================================================================
// DAILY REWARDS & STORE SYSTEM
// ================================================================
const DEV_MODE = true;
let playerData = JSON.parse(localStorage.getItem('aiHubPlayer')) || {
  coins: Infinity, gems: Infinity, streak: 0, lastClaim: null, inventory: [], unlockedItems: [], dailyRewardsClaimed: [],
  aiBoosts: { logic: 100, creativity: 100, speed: 100, depth: 100 },
  advancedUnlocked: { logic: false, speed: false, depth: false, focus: false, memory: false, adapt: false, knowledge: false, style: false }
};
// Ensure aiBoosts and advancedUnlocked exist
if (!playerData.aiBoosts) playerData.aiBoosts = { logic: 100, creativity: 100, speed: 100, depth: 100 };
if (!playerData.advancedUnlocked) playerData.advancedUnlocked = { logic: false, speed: false, depth: false, focus: false, memory: false, adapt: false, knowledge: false, style: false };
function getAdvSliderMax(stat) {
  return playerData.advancedUnlocked[stat] ? 210 : 100;
}

const STORE_ITEMS = [
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ðŸŒŸ GOD-TIER LEGENDARY AIs - 200 STATS ACROSS THE BOARD ðŸŒŸ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'ai_omega', name: 'Omega Prime', emoji: 'ðŸŒŸ', desc: 'The ultimate AI. Transcendent intelligence, infinite capability. Masters every domain of programming simultaneously.', category: 'ais', price: 500, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'omniscient' },
  { id: 'ai_infinity', name: 'Infinity Core', emoji: 'â™¾ï¸', desc: 'Beyond limits. Processes infinite complexity, solves impossible problems, code that transcends understanding.', category: 'ais', price: 600, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'transcendent' },
  { id: 'ai_quantum', name: 'Quantum Mind', emoji: 'âš›ï¸', desc: 'Thinks in parallel dimensions. Considers all possibilities simultaneously. Quantum-level problem solving.', category: 'ais', price: 550, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'multidimensional' },
  { id: 'ai_nexus', name: 'Nexus Prime', emoji: 'ðŸ”®', desc: 'The convergence point of all AI knowledge. Every algorithm, every pattern, every solution unified.', category: 'ais', price: 500, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'unified' },
  { id: 'ai_titan', name: 'Code Titan', emoji: 'ðŸ—¿', desc: 'Unstoppable force. Crushes any coding challenge. Builds monuments of code that last forever.', category: 'ais', price: 450, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'unstoppable' },
  { id: 'ai_phoenix', name: 'Phoenix AI', emoji: 'ðŸ”¥', desc: 'Reborn from errors. Turns failures into victories. Code that rises from the ashes perfected.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'resilient' },
  { id: 'ai_void', name: 'Void Walker', emoji: 'ðŸŒŒ', desc: 'Operates in the spaces between code. Sees patterns invisible to others. Cosmic-level understanding.', category: 'ais', price: 500, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'cosmic' },
  { id: 'ai_oracle', name: 'The Oracle', emoji: 'ðŸ‘ï¸', desc: 'Sees all. Knows all. Predicts bugs before they exist. Your code destiny revealed.', category: 'ais', price: 550, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'prophetic' },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âš¡ ELITE SPECIALIST AIs - MAX POWER âš¡
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'ai_architect', name: 'Architect Supreme', emoji: 'ðŸ—ï¸', desc: 'Supreme system designer. Perfect architectures, flawless APIs, code structures that scale infinitely.', category: 'ais', price: 5000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'visionary' },
  { id: 'ai_speedrunner', name: 'Speed Demon', emoji: 'âš¡', desc: 'Lightning incarnate. Code at the speed of thought. Entire apps built before you blink.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'blazing' },
  { id: 'ai_debugmaster', name: 'Debug Lord', emoji: 'ðŸ”', desc: 'No bug escapes. X-ray vision for code problems. Finds issues in parallel universes.', category: 'ais', price: 4500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'hunter' },
  { id: 'ai_fullstack', name: 'Fullstack God', emoji: 'ðŸŒ', desc: 'Masters every layer. Frontend, backend, database, cloud, mobile - all domains conquered.', category: 'ais', price: 6000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'all-knowing' },
  { id: 'ai_pythonista', name: 'Python Overlord', emoji: 'ðŸ', desc: 'Python perfection. ML, AI, data science, automation - the snake that codes reality.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'pythonic-master' },
  { id: 'ai_reactninja', name: 'React Shogun', emoji: 'âš›ï¸', desc: 'The way of React mastered. Components flow like water. State bends to your will.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'zen-master' },
  { id: 'ai_devops', name: 'DevOps Emperor', emoji: 'ðŸš€', desc: 'Infrastructure as destiny. Pipelines that never fail. Deploys that shake the cloud.', category: 'ais', price: 5000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'orchestrator' },
  { id: 'ai_security', name: 'Security Fortress', emoji: 'ðŸ›¡ï¸', desc: 'Impenetrable. Every vulnerability crushed. Hackers fear this AI.', category: 'ais', price: 5500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'fortress' },
  { id: 'ai_mentor', name: 'Grand Master', emoji: 'ðŸ‘¨â€ðŸ«', desc: 'Teaches coding enlightenment. Every explanation perfect. Makes anyone a programming god.', category: 'ais', price: 3500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'enlightened' },
  { id: 'ai_refactor', name: 'Refactor King', emoji: 'â™»ï¸', desc: 'Transforms chaos into elegance. SOLID incarnate. Code so clean it shines.', category: 'ais', price: 4500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'perfectionist' },
  { id: 'ai_algorithm', name: 'Algorithm Sage', emoji: 'ðŸ§®', desc: 'Master of all algorithms. O(1) solutions to impossible problems. Math becomes magic.', category: 'ais', price: 300, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'mathematical' },
  { id: 'ai_creative', name: 'Creative Genius', emoji: 'ðŸŽ¨', desc: 'Innovation beyond imagination. Solutions nobody thought possible. Art and code unified.', category: 'ais', price: 250, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'artistic' },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ðŸŽ­ UNIQUE PERSONALITY AIs - ALL MAXED ï¸ðŸŽ­
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'ai_database', name: 'Data Oracle', emoji: 'ðŸ—„ï¸', desc: 'Sees through data dimensions. SQL that runs in negative time. Schema perfection.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'data-seer' },
  { id: 'ai_api', name: 'API Godfather', emoji: 'ðŸ”Œ', desc: 'Every endpoint perfect. REST, GraphQL, gRPC - APIs that other APIs worship.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'connector' },
  { id: 'ai_mobile', name: 'Mobile Legend', emoji: 'ðŸ“±', desc: 'Apps that break app stores. iOS, Android, cross-platform mastery. 5-star destiny.', category: 'ais', price: 4500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'mobile-god' },
  { id: 'ai_wizard', name: 'Code Wizard', emoji: 'ðŸ§™', desc: 'Magic at your fingertips. Spells that compile. Incantations that scale. Pure wizardry.', category: 'ais', price: 350, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'magical' },
  { id: 'ai_ninja', name: 'Code Ninja', emoji: 'ðŸ¥·', desc: 'Silent but deadly. Code appears from shadows. Bugs eliminated before they know.', category: 'ais', price: 300, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'stealth' },
  { id: 'ai_dragon', name: 'Dragon Coder', emoji: 'ðŸ‰', desc: 'Ancient wisdom, modern power. Breathes fire into boring code. Legendary results.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'ancient' },
  { id: 'ai_robot', name: 'Mega Bot', emoji: 'ðŸ¤–', desc: 'Pure machine efficiency. Optimized to perfection. Logic circuits maxed out.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'mechanical' },
  { id: 'ai_alien', name: 'Alien Mind', emoji: 'ðŸ‘½', desc: 'Technology from beyond. Solutions humans never conceived. Extraterrestrial intelligence.', category: 'ais', price: 350, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'otherworldly' },
  { id: 'ai_ghost', name: 'Ghost Protocol', emoji: 'ðŸ‘»', desc: 'Haunts your codebase fixing bugs. Works while you sleep. Ethereal coding power.', category: 'ais', price: 300, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'spectral' },
  { id: 'ai_thunder', name: 'Thunder Code', emoji: 'â›ˆï¸', desc: 'Storm of productivity. Lightning-fast solutions. Code that echoes through eternity.', category: 'ais', price: 4500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'electric' },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ðŸ”¬ SPECIALIST MASTERS - DOMAIN EXPERTS ðŸ”¬
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'ai_ml', name: 'ML Overlord', emoji: 'ðŸ§ ', desc: 'Machine learning perfected. Neural networks, transformers, GANs - AI that builds AI.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'neural' },
  { id: 'ai_cloud', name: 'Cloud Master', emoji: 'â˜ï¸', desc: 'Rules the cloud. AWS, GCP, Azure - serverless, containers, infinite scale.', category: 'ais', price: 5000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'ethereal' },
  { id: 'ai_gamedev', name: 'Game Dev God', emoji: 'ðŸŽ®', desc: 'Creates gaming reality. Unreal, Unity, custom engines - games that redefine gaming.', category: 'ais', price: 350, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'playful' },
  { id: 'ai_blockchain', name: 'Blockchain King', emoji: 'â›“ï¸', desc: 'Crypto mastery. Smart contracts, DeFi, NFTs - decentralized perfection.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'decentralized' },
  { id: 'ai_systems', name: 'Systems Lord', emoji: 'âš™ï¸', desc: 'Low-level domination. C, Rust, Assembly - speaks directly to hardware.', category: 'ais', price: 5500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'hardcore' },
  { id: 'ai_graphics', name: 'Graphics Titan', emoji: 'ðŸ–¼ï¸', desc: 'Visual perfection. Shaders, WebGL, 3D, animations - pixels bend to your will.', category: 'ais', price: 4500, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'visual' },
  { id: 'ai_testing', name: 'Test Destroyer', emoji: 'ðŸ§ª', desc: '100% coverage guaranteed. TDD master. No bug survives the test suite.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'thorough' },
  { id: 'ai_perf', name: 'Performance Beast', emoji: 'ðŸ“Š', desc: 'Optimizes the impossible. Microsecond shaving. Code so fast it time travels.', category: 'ais', price: 5000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'obsessive' },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ðŸŒˆ COSMIC & MYTHICAL AIs ðŸŒˆ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'ai_cosmic', name: 'Cosmic Coder', emoji: 'ðŸŒ ', desc: 'Codes across galaxies. Universal solutions. Algorithms that span spacetime.', category: 'ais', price: 450, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'universal' },
  { id: 'ai_crystal', name: 'Crystal Mind', emoji: 'ðŸ’Ž', desc: 'Perfect clarity. Crystalline code structure. Flawless like a diamond.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'pristine' },
  { id: 'ai_shadow', name: 'Shadow Coder', emoji: 'ðŸŒ‘', desc: 'Works in darkness. Solutions emerge from the void. Mysterious and powerful.', category: 'ais', price: 350, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'mysterious' },
  { id: 'ai_sun', name: 'Solar Flare', emoji: 'â˜€ï¸', desc: 'Blazing brilliance. Illuminates any problem. Radiates coding excellence.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'radiant' },
  { id: 'ai_moon', name: 'Lunar Logic', emoji: 'ðŸŒ™', desc: 'Calm and calculating. Cycles through problems methodically. Night owl power.', category: 'ais', price: 350, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'nocturnal' },
  { id: 'ai_star', name: 'Starborn', emoji: 'â­', desc: 'Born from stellar code. Shines brightest in hardest challenges. 5-star excellence.', category: 'ais', price: 400, currency: 'gems', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'stellar' },
  { id: 'ai_nature', name: 'Nature Force', emoji: 'ðŸŒ¿', desc: 'Organic algorithms. Code that grows and evolves. Natural selection optimized.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'organic' },
  { id: 'ai_ice', name: 'Ice Core', emoji: 'â„ï¸', desc: 'Cool under pressure. Frozen focus. Crystalline logic, zero bugs.', category: 'ais', price: 4000, currency: 'coins', rarity: 'legendary', stats: { logic: 200, creativity: 200, speed: 200, depth: 200 }, personality: 'cold' },

  // AI UPGRADES - Improve your existing AIs
  { id: 'upgrade_logic', name: 'Logic Boost +20', emoji: 'ðŸ§ ', desc: 'Increases AI logic and reasoning ability by 20 points', category: 'upgrades', price: 500, currency: 'coins', rarity: 'common', boost: { stat: 'logic', amount: 20 } },
  { id: 'upgrade_creativity', name: 'Creativity Boost +20', emoji: 'ðŸ’¡', desc: 'Increases AI creativity and innovation by 20 points', category: 'upgrades', price: 500, currency: 'coins', rarity: 'common', boost: { stat: 'creativity', amount: 20 } },
  { id: 'upgrade_speed', name: 'Speed Boost +20', emoji: 'âš¡', desc: 'Increases AI response speed by 20 points', category: 'upgrades', price: 500, currency: 'coins', rarity: 'common', boost: { stat: 'speed', amount: 20 } },
  { id: 'upgrade_depth', name: 'Depth Boost +20', emoji: 'ðŸ”¬', desc: 'Increases AI analysis depth by 20 points', category: 'upgrades', price: 500, currency: 'coins', rarity: 'common', boost: { stat: 'depth', amount: 20 } },
  { id: 'upgrade_mega_logic', name: 'Mega Logic +50', emoji: 'ðŸ§ ', desc: 'Massive logic boost - +50 points', category: 'upgrades', price: 100, currency: 'gems', rarity: 'rare', boost: { stat: 'logic', amount: 50 } },
  { id: 'upgrade_mega_creativity', name: 'Mega Creativity +50', emoji: 'ðŸ’¡', desc: 'Massive creativity boost - +50 points', category: 'upgrades', price: 100, currency: 'gems', rarity: 'rare', boost: { stat: 'creativity', amount: 50 } },
  { id: 'upgrade_all', name: 'Ultimate Upgrade', emoji: 'â­', desc: 'Boosts ALL stats by +25 points', category: 'upgrades', price: 250, currency: 'gems', rarity: 'legendary', boost: { stat: 'all', amount: 25 } },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ðŸ”“ ADVANCED SETTINGS POWER-UPS â€” Unlock max 210 per stat!
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  { id: 'powerup_logic', name: 'ðŸ”“ Unlock Logic 210', emoji: 'ðŸ§ ', desc: 'Unlocks Logic & Reasoning slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'logic' },
  { id: 'powerup_speed', name: 'ðŸ”“ Unlock Speed 210', emoji: 'âš¡', desc: 'Unlocks Response Speed slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'speed' },
  { id: 'powerup_depth', name: 'ðŸ”“ Unlock Depth 210', emoji: 'ðŸ”¬', desc: 'Unlocks Analysis Depth slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'depth' },
  { id: 'powerup_focus', name: 'ðŸ”“ Unlock Focus 210', emoji: 'ðŸŽ¯', desc: 'Unlocks Focus Level slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'focus' },
  { id: 'powerup_memory', name: 'ðŸ”“ Unlock Memory 210', emoji: 'ðŸ’¾', desc: 'Unlocks Memory Retention slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'memory' },
  { id: 'powerup_adapt', name: 'ðŸ”“ Unlock Adapt 210', emoji: 'ðŸ”„', desc: 'Unlocks Adaptability slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'adapt' },
  { id: 'powerup_knowledge', name: 'ðŸ”“ Unlock Knowledge 210', emoji: 'ðŸ“š', desc: 'Unlocks Knowledge Breadth slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'knowledge' },
  { id: 'powerup_style', name: 'ðŸ”“ Unlock Style 210', emoji: 'ðŸŽ¨', desc: 'Unlocks Code Style slider to max 210 in Advanced Settings', category: 'powerups', price: 1500, currency: 'coins', rarity: 'epic', unlockStat: 'style' },
  { id: 'powerup_all', name: 'ðŸ”“ Unlock ALL 210', emoji: 'ðŸŒŸ', desc: 'Unlocks ALL Advanced Settings sliders to max 210 at once!', category: 'powerups', price: 300, currency: 'gems', rarity: 'legendary', unlockStat: 'all' },

  // THEMES
  { id: 'theme_midnight', name: 'Midnight Pro', emoji: 'ðŸŒ™', desc: 'Ultra dark OLED-friendly theme', category: 'themes', price: 1000, currency: 'coins', rarity: 'rare' },
  { id: 'theme_neon', name: 'Neon Cyber', emoji: 'ðŸ’œ', desc: 'Cyberpunk neon glow theme', category: 'themes', price: 1500, currency: 'coins', rarity: 'epic' },
  { id: 'theme_forest', name: 'Forest Green', emoji: 'ðŸŒ²', desc: 'Calm forest green theme', category: 'themes', price: 1000, currency: 'coins', rarity: 'rare' },
  { id: 'theme_ocean', name: 'Ocean Blue', emoji: 'ðŸŒŠ', desc: 'Deep ocean blue theme', category: 'themes', price: 1000, currency: 'coins', rarity: 'rare' },
  { id: 'theme_sunset', name: 'Sunset Fire', emoji: 'ðŸŒ…', desc: 'Warm sunset gradient theme', category: 'themes', price: 1500, currency: 'coins', rarity: 'epic' },
  { id: 'theme_matrix', name: 'Matrix Code', emoji: 'ðŸ’š', desc: 'Green matrix rain theme', category: 'themes', price: 50, currency: 'gems', rarity: 'legendary' },

  // SPECIAL
  { id: 'special_unlimited', name: 'âˆž Tokens Forever', emoji: 'â™¾ï¸', desc: 'Unlimited tokens for all AIs permanently', category: 'special', price: 500, currency: 'gems', rarity: 'legendary' },
  { id: 'special_vip', name: 'VIP Developer', emoji: 'ðŸ‘‘', desc: 'VIP badge + exclusive features + priority processing', category: 'special', price: 300, currency: 'gems', rarity: 'legendary' },
  { id: 'special_multimodel', name: 'Multi-Model Access', emoji: 'ðŸ”€', desc: 'Use multiple AI models simultaneously', category: 'special', price: 200, currency: 'gems', rarity: 'epic' }
];

const DAILY_REWARDS = [
  { day: 1, reward: 100, type: 'coins', emoji: 'ðŸª™' },
  { day: 2, reward: 150, type: 'coins', emoji: 'ðŸª™' },
  { day: 3, reward: 10, type: 'gems', emoji: 'ðŸ’Ž' },
  { day: 4, reward: 200, type: 'coins', emoji: 'ðŸª™' },
  { day: 5, reward: 300, type: 'coins', emoji: 'ðŸª™' },
  { day: 6, reward: 25, type: 'gems', emoji: 'ðŸ’Ž' },
  { day: 7, reward: 500, type: 'coins', emoji: 'ðŸª™', bonus: true }
];

function savePlayerData() { localStorage.setItem('aiHubPlayer', JSON.stringify(playerData)); }

function updateCurrencyDisplays() {
  ['coins-display', 'store-coins'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = DEV_MODE ? 'âˆž' : playerData.coins.toLocaleString(); });
  ['gems-display', 'store-gems'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = DEV_MODE ? 'âˆž' : playerData.gems.toLocaleString(); });
  const s = document.getElementById('streak-display'); if (s) s.textContent = playerData.streak;
}

function addDevBonus(type, amount) {
  if (type === 'coins') playerData.coins += amount; else playerData.gems += amount;
  savePlayerData(); updateCurrencyDisplays(); toast(`+${amount.toLocaleString()} ${type}!`, 'success');
}

function unlockAllItems() {
  STORE_ITEMS.forEach(item => { if (!playerData.unlockedItems.includes(item.id)) { playerData.unlockedItems.push(item.id); playerData.inventory.push({ ...item, equipped: false }); } });
  savePlayerData(); renderStore(); renderInventory(); toast('All items unlocked!', 'success');
}

function renderDailyRewards() {
  const grid = document.getElementById('daily-rewards-grid'); if (!grid) return;
  const today = new Date().toDateString(), canClaim = playerData.lastClaim !== today, currentDay = (playerData.streak % 7) + 1;
  grid.innerHTML = DAILY_REWARDS.map((r, i) => {
    const day = i + 1, claimed = playerData.dailyRewardsClaimed.includes(day) && playerData.lastClaim === today, isToday = day === currentDay && canClaim, isPast = day < currentDay || claimed;
    return `<div class="card" style="text-align:center;padding:16px;${isToday ? 'border:2px solid #fbbf24;background:rgba(251,191,36,0.1)' : ''}${isPast ? 'opacity:0.5' : ''}">
      <div style="font-size:12px;color:var(--text3)">Day ${day}</div><div style="font-size:32px;margin:8px 0">${r.emoji}</div>
      <div style="font-size:14px;font-weight:700;color:${r.type === 'gems' ? '#a855f7' : '#fbbf24'}">${r.reward}</div>
      ${isToday ? `<button class="btn btn-primary btn-sm" style="margin-top:8px;width:100%" onclick="claimDailyReward(${day})">Claim!</button>` : ''}
      ${claimed ? '<div style="color:#10b981;font-size:12px;margin-top:8px">âœ“</div>' : ''}${r.bonus ? '<div style="color:#fbbf24;font-size:10px;margin-top:4px">ðŸŽ BONUS</div>' : ''}</div>`;
  }).join('');
}

function claimDailyReward(day) {
  const r = DAILY_REWARDS[day - 1];
  if (r.type === 'coins') playerData.coins += r.reward; else playerData.gems += r.reward;
  playerData.streak++; playerData.lastClaim = new Date().toDateString(); playerData.dailyRewardsClaimed.push(day);
  savePlayerData(); updateCurrencyDisplays(); renderDailyRewards(); toast(`+${r.reward} ${r.type}!`, 'success');
}

let currentStoreFilter = 'all';

function renderStore() {
  const grid = document.getElementById('store-grid'); if (!grid) return;
  const rarityColors = { common: '#94a3b8', uncommon: '#34d399', rare: '#6366f1', epic: '#a855f7', legendary: '#fbbf24' };

  const filteredItems = currentStoreFilter === 'all' ? STORE_ITEMS : STORE_ITEMS.filter(i => i.category === currentStoreFilter);

  grid.innerHTML = filteredItems.map(item => {
    const owned = playerData.unlockedItems.includes(item.id);
    const hasStats = item.stats && item.category === 'ais';
    const isUpgrade = item.category === 'upgrades';
    const isPowerup = item.category === 'powerups';

    let statsHtml = '';
    if (hasStats) {
      statsHtml = `<div style="margin:12px 0;text-align:left">
        <div style="display:flex;align-items:center;gap:6px;margin:4px 0"><span style="width:60px;font-size:10px;color:var(--text3)">ðŸ§  Logic</span><div style="flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:${item.stats.logic / 2}%;height:100%;background:linear-gradient(90deg,#6366f1,#818cf8);border-radius:3px"></div></div><span style="font-size:10px;font-weight:700;color:#818cf8">${item.stats.logic}</span></div>
        <div style="display:flex;align-items:center;gap:6px;margin:4px 0"><span style="width:60px;font-size:10px;color:var(--text3)">ðŸ’¡ Create</span><div style="flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:${item.stats.creativity / 2}%;height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24);border-radius:3px"></div></div><span style="font-size:10px;font-weight:700;color:#fbbf24">${item.stats.creativity}</span></div>
        <div style="display:flex;align-items:center;gap:6px;margin:4px 0"><span style="width:60px;font-size:10px;color:var(--text3)">âš¡ Speed</span><div style="flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:${item.stats.speed / 2}%;height:100%;background:linear-gradient(90deg,#10b981,#34d399);border-radius:3px"></div></div><span style="font-size:10px;font-weight:700;color:#34d399">${item.stats.speed}</span></div>
        <div style="display:flex;align-items:center;gap:6px;margin:4px 0"><span style="width:60px;font-size:10px;color:var(--text3)">ðŸ”¬ Depth</span><div style="flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:${item.stats.depth / 2}%;height:100%;background:linear-gradient(90deg,#ec4899,#f472b6);border-radius:3px"></div></div><span style="font-size:10px;font-weight:700;color:#f472b6">${item.stats.depth}</span></div>
      </div>`;
    }

    let upgradeHtml = '';
    if (isUpgrade && item.boost) {
      const boostColor = item.boost.stat === 'logic' ? '#818cf8' : item.boost.stat === 'creativity' ? '#fbbf24' : item.boost.stat === 'speed' ? '#34d399' : item.boost.stat === 'depth' ? '#f472b6' : '#fbbf24';
      upgradeHtml = `<div style="margin:12px 0;padding:10px;background:var(--bg4);border-radius:8px;text-align:center">
        <span style="font-size:24px;font-weight:800;color:${boostColor}">+${item.boost.amount}</span>
        <div style="font-size:11px;color:var(--text3)">${item.boost.stat === 'all' ? 'All Stats' : item.boost.stat.charAt(0).toUpperCase() + item.boost.stat.slice(1)}</div>
      </div>`;
    }

    let powerupHtml = '';
    if (isPowerup && item.unlockStat) {
      const isUnlocked = item.unlockStat === 'all' ? Object.values(playerData.advancedUnlocked).every(v => v) : playerData.advancedUnlocked[item.unlockStat];
      powerupHtml = `<div style="margin:12px 0;padding:12px;background:${isUnlocked ? 'rgba(16,185,129,.1)' : 'rgba(99,102,241,.1)'};border:1px solid ${isUnlocked ? 'var(--green)' : 'var(--accent)'};border-radius:8px;text-align:center">
        <div style="font-size:20px;margin-bottom:4px">${isUnlocked ? 'âœ…' : 'ðŸ”’â†’ðŸ”“'}</div>
        <div style="font-size:13px;font-weight:700;color:${isUnlocked ? 'var(--green)' : 'var(--accent2)'}">${item.unlockStat === 'all' ? 'All Stats' : item.unlockStat.charAt(0).toUpperCase() + item.unlockStat.slice(1)}: ${isUnlocked ? '210 Unlocked!' : '100 â†’ 210'}</div>
      </div>`;
    }

    return `<div class="card" style="text-align:center;position:relative;${owned ? 'border-color:#10b981' : ''}${hasStats ? ';text-align:left' : ''}">
      <div style="position:absolute;top:8px;right:8px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:${rarityColors[item.rarity]}20;color:${rarityColors[item.rarity]}">${item.rarity.toUpperCase()}</div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px${!hasStats ? ';flex-direction:column' : ''}">
        <div style="font-size:${hasStats ? '36px' : '48px'}">${item.emoji}</div>
        <div${!hasStats ? ' style="text-align:center"' : ''}>
          <div style="font-size:16px;font-weight:700">${item.name}</div>
          ${item.personality ? `<div style="font-size:11px;color:var(--accent2);font-style:italic">${item.personality}</div>` : ''}
        </div>
      </div>
      <div style="font-size:12px;color:var(--text3);margin:8px 0;line-height:1.4">${item.desc}</div>
      ${statsHtml}${upgradeHtml}${powerupHtml}
      <div style="font-size:18px;font-weight:700;color:${item.currency === 'gems' ? '#a855f7' : '#fbbf24'};margin:12px 0;text-align:center">${item.currency === 'gems' ? 'ðŸ’Ž' : 'ðŸª™'} ${item.price.toLocaleString()}</div>
      ${owned ? '<button class="btn btn-success btn-sm" style="width:100%" disabled>âœ“ Owned</button>' : `<button class="btn btn-primary btn-sm" style="width:100%" onclick="buyItem('${item.id}')">Buy Now</button>`}
    </div>`;
  }).join('');
}

function filterStore(cat) {
  currentStoreFilter = cat;
  document.querySelectorAll('#store-filters .filter-chip').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  renderStore();
}

function buyItem(itemId) {
  const item = STORE_ITEMS.find(i => i.id === itemId); if (!item) return;
  if (playerData.unlockedItems.includes(item.id)) { toast(`Already owned ${item.name}!`, 'info'); return; }
  playerData.unlockedItems.push(item.id); playerData.inventory.push({ ...item, equipped: false });

  // If it's an AI, actually create and add it to the ais list
  if (item.category === 'ais' && item.stats) {
    if (!ais.find(a => a.name === item.name)) {
      const newAI = {
        id: item.id,
        name: item.name,
        emoji: item.emoji,
        color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
        role: 'coder',
        personality: item.personality || 'helpful',
        skills: ['coding', 'problem-solving'],
        systemPrompt: `You are ${item.name}. ${item.desc}`,
        model: aiModelChoice || 'gpt-4o',
        stats: item.stats,
        fromStore: true
      };
      ais.push(newAI);
      saveAll();
      updateSidebarAIs();
      toast(`ðŸ¤– ${item.name} has been added to your AI team!`, 'success');
    }
  }

  // If it's a boost/upgrade, actually apply it
  if (item.category === 'upgrades' && item.boost) {
    if (item.boost.stat === 'all') {
      playerData.aiBoosts.logic += item.boost.amount;
      playerData.aiBoosts.creativity += item.boost.amount;
      playerData.aiBoosts.speed += item.boost.amount;
      playerData.aiBoosts.depth += item.boost.amount;
    } else {
      playerData.aiBoosts[item.boost.stat] = (playerData.aiBoosts[item.boost.stat] || 0) + item.boost.amount;
    }
    toast(`âš¡ ${item.boost.stat === 'all' ? 'All stats' : item.boost.stat} boosted by +${item.boost.amount}!`, 'success');
  }

  // If it's a power-up that unlocks advanced setting to 210
  if (item.category === 'powerups' && item.unlockStat) {
    if (item.unlockStat === 'all') {
      ['logic','speed','depth','focus','memory','adapt','knowledge','style'].forEach(s => {
        playerData.advancedUnlocked[s] = true;
      });
      toast('ðŸ”“ ALL Advanced Settings unlocked to max 210!', 'success');
    } else {
      playerData.advancedUnlocked[item.unlockStat] = true;
      toast(`ðŸ”“ ${item.unlockStat.charAt(0).toUpperCase() + item.unlockStat.slice(1)} unlocked to max 210!`, 'success');
    }
    refreshAdvSliderLocks();
  }

  savePlayerData(); updateCurrencyDisplays(); renderStore(); toast(`Purchased ${item.name}!`, 'success');
}

function renderInventory() {
  const grid = document.getElementById('inventory-grid'); if (!grid) return;
  if (playerData.inventory.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ðŸŽ’</div><p>Empty inventory</p></div>'; return; }
  grid.innerHTML = playerData.inventory.map((item, idx) => `<div class="card" style="text-align:center;${item.equipped ? 'border-color:#10b981' : ''}">
    <div style="font-size:36px;margin:8px 0">${item.emoji}</div><div style="font-size:14px;font-weight:700">${item.name}</div>
    ${item.equipped ? '<div style="color:#10b981;font-size:12px;margin-top:8px">âœ“ Equipped</div>' : `<button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="equipItem(${idx})">Equip</button>`}</div>`).join('');
}

function filterInventory(cat) { document.querySelectorAll('#page-inventory .filter-chip').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); renderInventory(); }
function equipItem(idx) { playerData.inventory[idx].equipped = !playerData.inventory[idx].equipped; savePlayerData(); renderInventory(); toast('Item equipped!', 'success'); }

// Templates
let templates = [{ id: 1, name: 'Code Reviewer', category: 'coding', emoji: 'ðŸ”', desc: 'Reviews code', prompt: 'Review this code:', starred: false },
  { id: 2, name: 'Bug Fixer', category: 'coding', emoji: 'ðŸ›', desc: 'Fixes bugs', prompt: 'Fix bugs in:', starred: true },
  { id: 3, name: 'Docs Writer', category: 'writing', emoji: 'ðŸ“', desc: 'Writes docs', prompt: 'Write documentation for:', starred: false }];

function renderTemplates() {
  const grid = document.getElementById('templates-grid'); if (!grid) return;
  grid.innerHTML = templates.map(t => `<div class="card" style="cursor:pointer" onclick="useTemplate(${t.id})">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="font-size:32px">${t.emoji}</div>
    <div><div style="font-size:16px;font-weight:700">${t.name}</div><div style="font-size:12px;color:var(--text3)">${t.category}</div></div>
    <div style="margin-left:auto;font-size:18px;cursor:pointer" onclick="event.stopPropagation();toggleTemplateStar(${t.id})">${t.starred ? 'â­' : 'â˜†'}</div></div>
    <div style="font-size:13px;color:var(--text2)">${t.desc}</div></div>`).join('');
}

function filterTemplates(cat) { document.querySelectorAll('#page-templates .filter-chip').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); renderTemplates(); }
function useTemplate(id) { const t = templates.find(x => x.id === id); if (t) { showPage('chat'); toast(`Template "${t.name}" loaded!`, 'info'); } }
function toggleTemplateStar(id) { const t = templates.find(x => x.id === id); if (t) { t.starred = !t.starred; renderTemplates(); } }
function openTemplateBuilder() { toast('Template builder coming soon!', 'info'); }

// Prompts
let savedPrompts = [{ id: 1, title: 'Explain Like Im 5', category: 'writing', prompt: 'Explain simply:', starred: true }];
function renderPrompts() {
  const grid = document.getElementById('prompts-grid'); if (!grid) return;
  grid.innerHTML = savedPrompts.map(p => `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:700">${p.title}</div><span style="cursor:pointer" onclick="togglePromptStar(${p.id})">${p.starred ? 'â­' : 'â˜†'}</span></div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:12px">${p.prompt}</div>
    <button class="btn btn-primary btn-sm" onclick="usePrompt(${p.id})">Use</button></div>`).join('');
}
function filterPrompts(cat) { document.querySelectorAll('#page-prompts .filter-chip').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); renderPrompts(); }
function usePrompt(id) { showPage('chat'); toast('Prompt loaded!', 'info'); }
function togglePromptStar(id) { const p = savedPrompts.find(x => x.id === id); if (p) { p.starred = !p.starred; renderPrompts(); } }
function openPromptEditor() { toast('Prompt editor coming soon!', 'info'); }

// Snippets
let snippets = [{ id: 1, title: 'Fetch API', lang: 'javascript', code: 'const data = await fetch(url).then(r=>r.json())' }];
function renderSnippets() {
  const grid = document.getElementById('snippets-grid'); if (!grid) return;
  grid.innerHTML = snippets.map(s => `<div class="card"><div style="display:flex;justify-content:space-between;margin-bottom:8px">
    <div style="font-weight:700">${s.title}</div><span style="font-size:11px;padding:2px 8px;border-radius:10px;background:var(--accent);color:white">${s.lang}</span></div>
    <div class="code-editor" style="margin-bottom:8px"><pre style="padding:12px;font-size:12px;color:#c9d1d9;margin:0">${s.code}</pre></div>
    <button class="btn btn-secondary btn-sm" onclick="copySnippet(${s.id})">ðŸ“‹ Copy</button></div>`).join('');
}
function copySnippet(id) { const s = snippets.find(x => x.id === id); if (s) { navigator.clipboard.writeText(s.code); toast('Copied!', 'success'); } }
function openSnippetEditor() { toast('Snippet editor coming soon!', 'info'); }

// Terminal
function initTerminal() {
  const output = document.getElementById('terminal-output');
  if (output && output.innerHTML === '') output.innerHTML = '<div style="color:#7ee787">Welcome to AI Terminal v1.0</div><div style="color:var(--text3)">Type "help" for commands</div>';
  const select = document.getElementById('terminal-ai');
  if (select && select.innerHTML === '') select.innerHTML = '<option value="auto">ðŸ¤– Auto</option>' + (typeof ais !== 'undefined' ? ais.map(ai => `<option value="${ai.id}">${ai.emoji} ${ai.name}</option>`).join('') : '');
}
function runTerminalCommand() {
  const input = document.getElementById('terminal-input'), output = document.getElementById('terminal-output'), cmd = input.value.trim();
  if (!cmd) return; input.value = '';
  output.innerHTML += `<div><span style="color:#7ee787">â¯</span> ${cmd}</div>`;
  if (cmd === 'help') output.innerHTML += '<div style="color:var(--text2)">Commands: help, clear, ais, stats, coins</div>';
  else if (cmd === 'clear') output.innerHTML = '';
  else if (cmd === 'coins') output.innerHTML += `<div style="color:#fbbf24">ðŸª™ âˆž coins | ðŸ’Ž âˆž gems</div>`;
  else output.innerHTML += `<div style="color:#58a6ff">[AI] Processing: ${cmd}</div>`;
  output.scrollTop = output.scrollHeight;
}
function clearTerminal() { const o = document.getElementById('terminal-output'); if (o) o.innerHTML = '<div style="color:#7ee787">Cleared.</div>'; }
function exportTerminalHistory() { toast('History exported!', 'success'); }

// Projects
let projects = [{ id: 1, name: 'My Project', desc: 'First project', files: 3 }];
function renderProjects() {
  const grid = document.getElementById('projects-grid'); if (!grid) return;
  grid.innerHTML = projects.map(p => `<div class="card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
    <div style="font-size:32px">ðŸ“</div><div><div style="font-size:16px;font-weight:700">${p.name}</div><div style="font-size:12px;color:var(--text3)">${p.files} files</div></div></div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${p.desc}</div>
    <button class="btn btn-primary btn-sm" onclick="openProject(${p.id})">Open</button></div>`).join('');
}
function createNewProject() { const n = prompt('Project name:'); if (n) { projects.push({ id: Date.now(), name: n, desc: 'New', files: 0 }); renderProjects(); toast('Created!', 'success'); } }
function openProject(id) { toast('Opening...', 'info'); }

// Debugger
function analyzeCode() {
  const code = document.getElementById('debug-code').value, output = document.getElementById('debug-output');
  if (!code.trim()) { toast('Paste code first!', 'error'); return; }
  output.innerHTML = '<div style="text-align:center;padding:20px">Analyzing...</div>';
  setTimeout(() => {
    const issues = [];
    if (code.includes('var ')) issues.push('âš ï¸ Use let/const instead of var');
    if (code.includes('==') && !code.includes('===')) issues.push('âš ï¸ Use === instead of ==');
    output.innerHTML = issues.length === 0 ? '<div style="color:#10b981;text-align:center;padding:40px">âœ… No issues found!</div>' :
      '<div style="font-weight:700;margin-bottom:12px">Found ' + issues.length + ' issue(s):</div>' + issues.map(i => `<div style="padding:8px 0;border-bottom:1px solid var(--border)">${i}</div>`).join('');
  }, 1000);
}
function fixCode() { const c = document.getElementById('debug-code'); c.value = c.value.replace(/var /g, 'let ').replace(/==/g, '==='); toast('Fixed!', 'success'); }

// Plugins
const PLUGINS = [{ id: 'github', name: 'GitHub', emoji: 'ðŸ™', desc: 'Connect to GitHub', installed: true },
  { id: 'slack', name: 'Slack', emoji: 'ðŸ’¬', desc: 'Slack integration', installed: false }];
function renderPlugins() {
  const grid = document.getElementById('plugins-grid'); if (!grid) return;
  grid.innerHTML = PLUGINS.map(p => `<div class="card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
    <div style="font-size:32px">${p.emoji}</div><div style="font-size:16px;font-weight:700">${p.name}</div></div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${p.desc}</div>
    ${p.installed ? '<button class="btn btn-success btn-sm" disabled>âœ“ Installed</button>' : `<button class="btn btn-primary btn-sm" onclick="installPlugin('${p.id}')">Install</button>`}</div>`).join('');
}
function filterPlugins(cat) { document.querySelectorAll('#page-plugins .filter-chip').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); renderPlugins(); }
function installPlugin(id) { const p = PLUGINS.find(x => x.id === id); if (p) { p.installed = true; renderPlugins(); toast('Installed!', 'success'); } }
function openPluginMarketplace() { toast('Coming soon!', 'info'); }

// History & API Keys
function renderHistory() { const l = document.getElementById('history-list'); if (l) l.innerHTML = '<div class="empty-state"><div class="empty-icon">ðŸ“œ</div><p>No history</p></div>'; }
function filterHistory(f) { document.querySelectorAll('#page-history .filter-chip').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); renderHistory(); }
function exportHistory() { toast('Exported!', 'success'); }
function clearHistory() { toast('Cleared!', 'info'); }
function renderApiKeys() { const l = document.getElementById('api-keys-list'); if (l) l.innerHTML = '<div class="card"><p style="color:var(--text3)">No API keys. Using free APIs!</p></div>'; }
function addNewApiKey() { toast('API key feature coming soon!', 'info'); }

// Files
function renderFileTree() {
  const t = document.getElementById('file-tree'); if (!t) return;
  t.innerHTML = '<div style="padding:4px 8px;cursor:pointer" onclick="openFile(\'src/index.js\')">ðŸ“ src/<div style="margin-left:16px">ðŸ“„ index.js</div></div><div style="padding:4px 8px;cursor:pointer" onclick="openFile(\'README.md\')">ðŸ“„ README.md</div>';
}
function openFile(path) { document.getElementById('file-viewer-title').textContent = 'ðŸ“„ ' + path.split('/').pop(); document.getElementById('file-viewer').innerHTML = '<pre style="padding:16px">// File: ' + path + '</pre>'; }
function createNewFile() { toast('File created!', 'success'); }
function uploadFiles() { toast('Upload coming soon!', 'info'); }

// Compare
let compareSelectedAIs = new Set();
function renderCompareAISelect() {
  const c = document.getElementById('compare-ai-select'); if (!c) return;
  const allAIs = typeof ais !== 'undefined' ? ais.slice(0, 8) : [{ id: '1', name: 'AI 1', emoji: 'ðŸ¤–' }];
  c.innerHTML = allAIs.map(ai => `<div class="filter-chip ${compareSelectedAIs.has(ai.id) ? 'active' : ''}" onclick="toggleCompareAI('${ai.id}')">${ai.emoji} ${ai.name}</div>`).join('');
}
function toggleCompareAI(id) { if (compareSelectedAIs.has(id)) compareSelectedAIs.delete(id); else if (compareSelectedAIs.size < 4) compareSelectedAIs.add(id); renderCompareAISelect(); }
function runComparison() {
  const p = document.getElementById('compare-prompt').value, r = document.getElementById('compare-results');
  if (!p.trim() || compareSelectedAIs.size < 2) { toast('Enter prompt & select 2+ AIs', 'error'); return; }
  r.innerHTML = Array.from(compareSelectedAIs).map(id => `<div class="card"><div style="font-weight:700;margin-bottom:8px">ðŸ¤– ${id}</div><div style="color:var(--text2)">Processing...</div></div>`).join('');
  setTimeout(() => { r.querySelectorAll('.card').forEach(c => { c.querySelector('div:last-child').textContent = 'AI response to: ' + p.substring(0, 50) + '...'; }); }, 1000);
}

// Workflows
function openWorkflowBuilder() { toast('Workflow builder coming soon!', 'info'); }
function loadSampleWorkflow() {
  const b = document.getElementById('workflow-builder'); if (b) b.innerHTML = '<div style="display:flex;align-items:center;gap:20px;justify-content:center"><div style="background:var(--bg3);padding:16px;border-radius:12px;text-align:center">ðŸ“ Input</div><div style="font-size:24px">â†’</div><div style="background:var(--accent);padding:16px;border-radius:12px;text-align:center;color:white">ðŸ¤– Process</div><div style="font-size:24px">â†’</div><div style="background:var(--bg3);padding:16px;border-radius:12px;text-align:center">âœ… Output</div></div>';
}

// Page init hook
const originalShowPage = typeof showPage === 'function' ? showPage : function(){};
showPage = function(page) {
  originalShowPage(page);
  if (page === 'dailyrewards') { renderDailyRewards(); updateCurrencyDisplays(); }
  else if (page === 'store') { renderStore(); updateCurrencyDisplays(); }
  else if (page === 'inventory') renderInventory();
  else if (page === 'templates') renderTemplates();
  else if (page === 'prompts') renderPrompts();
  else if (page === 'snippets') renderSnippets();
  else if (page === 'terminal') initTerminal();
  else if (page === 'projects') renderProjects();
  else if (page === 'plugins') renderPlugins();
  else if (page === 'history') renderHistory();
  else if (page === 'api') renderApiKeys();
  else if (page === 'files') renderFileTree();
  else if (page === 'compare') renderCompareAISelect();
};

// ================================================================
// BOOT
// ================================================================
init();
loadChatHistory();
updateFBChatBadge();
</script>
</body>
</html>
